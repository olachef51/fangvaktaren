<!-- start DEL 1/3: F√•ngvaktaren v16.6 (HTML+CSS+Body utan script) -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>F√•ngvaktaren ‚Äì Progression & Delm√•l (v16.6)</title>

  <!-- JSZip f√∂r att kunna skapa ZIP-filer vid "Ladda ner spelfil" -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>








  
    <!-- start SEKTION CSS (ers√§tter tidigare CSS helt) -->
  <style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#374151; --text:#e5e7eb;
    --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --accent:#3b82f6;
  }
  *{box-sizing:border-box;}
  html,body{height:100%;}
  body{
    margin:0; line-height:1.5;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:linear-gradient(180deg,#0b1024,#0f172a); color:var(--text);
  }

  /* ===== Baslayout ===== */
  .wrap{max-width:1000px;margin:16px auto;padding:12px 16px;}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px;}
  button,
  input[type="text"],input[type="number"],input[type="email"],input[type="password"],
  select,textarea{
    font-size:16px;padding:8px 10px;border-radius:8px;
    border:1px solid var(--muted); background:#1f2937; color:var(--text);
  }
  button{cursor:pointer;background:var(--accent);border:none;color:#fff;transition:background .2s;}
  button:hover{background:#2563eb;}
  button.secondary{background:#374151;} button.secondary:hover{background:#4b5563;}
  button.ghost{background:#1f2937;border:1px solid var(--muted);}

  .card{
    background:rgba(17,24,39,.75);
    border:1px solid #1f2937; border-radius:16px;
    -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px);
    padding:16px; margin-bottom:20px;
  }
  .lock{opacity:.5;pointer-events:none;}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
  .row{display:grid;grid-template-columns:1fr 2fr;gap:8px;margin:8px 0;}
  .badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:13px;font-weight:700;margin-left:8px;}
  .ok{background:var(--ok);color:#fff;} .warn{background:var(--warn);color:#000;} .err{background:var(--err);color:#fff;}
  .section.hidden,.hidden{display:none !important;}

  /* ===== Modaler ===== */
  #gate,#modal{
    position:fixed; inset:0; display:none !important;
    align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:1000;
  }
  #gate.show,#modal.show{display:flex !important;}
  #gate .panel,#modal .panel{
    width:min(96vw,1100px); max-height:90vh; overflow:auto;
    background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px;
  }

  /* ===== Flikar i l√§rarl√§get ===== */
  .tab-nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;}
  .tab-btn{background:#1f2937;border:1px solid var(--muted);padding:10px 14px;border-radius:8px;color:var(--text);cursor:pointer;}
  .tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}

  /* =================================================================
     SPELVYN ‚Äì FR√ÖGOR I VANLIGA KORT I WRAPEN
     ================================================================= */
  #play{
    margin-top:16px;
  }
  #play #questions{
    width:100%;
    margin:0;
    padding:0;
  }
  #play .question{
    width:100%;
    margin:8px 0;
    background:var(--card);
    border:1px solid #1f2937;
    border-radius:16px;
    padding:12px 14px;
  }
  #play .options-list .option{display:block;padding:6px 8px;}
  #play .imgq .media{margin:8px 0 10px;background:#0c142a;border:1px solid #1f2937;border-radius:12px;padding:8px;}
  #play .imgq .media img{display:block;width:100%;max-height:64vh;object-fit:contain;border-radius:10px;background:#0b1226;}
  .drag-area{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .bucket{background:#1e293b;border:1px solid var(--muted);border-radius:10px;padding:10px;}
  .bucket h4{margin:0 0 6px 0;font-size:14px;color:#cbd5e1;}
  .dropzone{min-height:66px;display:flex;flex-wrap:wrap;gap:6px;}
  .chip{background:var(--accent);color:#fff;padding:6px 10px;border-radius:6px;cursor:grab;}
  .chip:active{cursor:grabbing;}
  .bucket.hover{outline:2px solid var(--accent);}

  /* =================================================================
     L√ÑRARL√ÑGE ‚Äì LISTOR = INDIVIDUELLA RUTOR
     ================================================================= */
  #mcqListE,#mcqListC,#mcqListA{display:flex;flex-direction:column;gap:12px;}
  #mcqListE .listItem,#mcqListC .listItem,#mcqListA .listItem{
    grid-template-columns:1fr auto;
    background:rgba(17,24,39,.6);
    border:1px solid #1f2937;border-radius:12px;padding:12px;
  }
  #mcqListE .listItem > div:first-child,#mcqListC .listItem > div:first-child,#mcqListA .listItem > div:first-child{display:none;}

  #imgList{display:flex;flex-direction:column;gap:12px;}
  #imgList .listItem{
    grid-template-columns:140px 1fr auto; gap:12px; align-items:start;
    background:rgba(17,24,39,.6); border:1px solid #1f2937;border-radius:12px;padding:12px;
  }
  #imgList img{width:140px;height:140px;object-fit:cover;border-radius:12px;}

  #dragList{display:flex;flex-direction:column;gap:12px;}
  #dragList .listItem{
    grid-template-columns:1fr auto;
    background:rgba(17,24,39,.6); border:1px solid #1f2937;border-radius:12px;padding:12px;
  }
  #dragList .pairs .pair{display:block;padding:2px 0;}

  /* =================================================================
     L√ÑRARL√ÑGE ‚Äì FLERVALSIMPORT FULLBREDD
     ================================================================= */
  #tab-mcq{margin:0; padding:0;}
  #tab-mcq .row{grid-template-columns:1fr;gap:8px;margin:10px 0;}
  #tab-mcq .row > label{margin-bottom:4px;}
  #tab-mcq .row > div{width:100%;}
  #tab-mcq textarea.input{width:100%;min-height:280px;resize:vertical;}
  .import-objective-link{
    background:#0f172a;border:1px dashed var(--muted);
    border-radius:10px;padding:10px;margin-bottom:8px;
  }
  .objective-dropdown-link{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px;}
  .objective-dropdown-link select,.objective-dropdown-link button{width:100%;}

  /* =================================================================
     L√ÑRARL√ÑGE ‚Äì INST√ÑLLNINGAR SOM EGNA RUTOR (CARDS)
     ================================================================= */
  #tab-settings .hr{display:none !important;} /* vi ers√§tter "hr" med kort */
  #tab-settings .settings-card{
    background:rgba(17,24,39,.65);
    border:1px solid #1f2937; border-radius:14px;
    padding:14px; margin-bottom:14px;
  }
  #tab-settings .settings-card h3{margin:0 0 10px 0;}
  #tab-settings .settings-card .row{grid-template-columns:1fr 2fr;}
  #tab-settings .settings-card .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;}
  #tab-settings .threshold-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
  #tab-settings #objectivesListContainer{margin-top:10px;}
  #tab-settings .import-wrap textarea{width:100%;min-height:220px;}

  /* D√∂lja l√§rar-UI i elevl√§ge */
  .teacher-only,[data-teacher-ui]{display:none !important;visibility:hidden !important;pointer-events:none !important;}
  body.teacher .teacher-only,body.teacher [data-teacher-ui]{display:block !important;visibility:visible !important;pointer-events:auto !important;}

  /* Google-sektionen: helt dold i elevl√§ge, synlig i l√§rarl√§ge */
  #teacher-google-section{
    display:none !important;
  }
  body.teacher #teacher-google-section{
    display:block !important;
  }

  /* Specifikt: Google/Firebase-knappar bara i l√§rarl√§ge */
  #googleLoginBtn,
  #googleLogoutBtn,
  #googleStatus,
  #saveBankBtn,
  #loadBankBtn {
    display: none !important;
  }
  body.teacher #googleLoginBtn,
  body.teacher #googleLogoutBtn,
  body.teacher #googleStatus,
  body.teacher #saveBankBtn,
  body.teacher #loadBankBtn {
    display: inline-block !important;
  }

  /* ===== Responsivt ===== */
  @media (max-width:900px){
    .wrap{padding:12px;margin:12px auto;}
    .grid{grid-template-columns:1fr;gap:12px;}
    .row{grid-template-columns:1fr;margin:10px 0;}
    .row label{margin-bottom:4px;display:block;}
    .panel{padding:12px;}
    .tab-btn{padding:8px 10px;font-size:13px;}

    #play .question{margin:8px 0;}
    .drag-area{grid-template-columns:1fr;}

    .listItem{grid-template-columns:1fr;}
    #imgList .listItem{grid-template-columns:1fr;}
    #imgList img{width:100%;height:auto;object-fit:contain;margin-bottom:8px;}

    #tab-settings .settings-card .row{grid-template-columns:1fr;}
    #tab-settings .threshold-grid{grid-template-columns:1fr;}
  }

  /* === Inst√§llningar: separata rutor per Delm√•l === */
  #tab-settings .objective-group{
    background: rgba(17,24,39,.65);
    border: 1px solid #1f2937;
    border-radius: 14px;
    padding: 12px;
    margin: 12px 0;
  }

  /* Header-raden (Delm√•l X) lite tydligare */
  #tab-settings .objective-group .row.main-objective {
    grid-template-columns: 1fr 2fr; /* label | input */
    align-items: center;
    margin-bottom: 8px;
  }
  #tab-settings .objective-group .row.main-objective label{
    font-weight: 700;
  }

  /* Delbitsraderna inuti varje ruta */
  #tab-settings .objective-group .row.sub-row{
    grid-template-columns: 1fr 2fr; /* label | input */
    margin: 6px 0;
    padding-left: 10px;
    border-left: 3px solid var(--muted);
  }

  /* Ta bort-fknappen i √∂vre h√∂gra h√∂rnet av varje delm√•lsruta */
  #tab-settings .objective-group .remove-objective-btn{
    float: right;
    margin: -4px -4px 6px 6px;
  }

  /* Responsivt: stapla snyggt p√• mobil */
  @media (max-width: 900px){
    #tab-settings .objective-group .row.main-objective,
    #tab-settings .objective-group .row.sub-row{
      grid-template-columns: 1fr; /* label √∂ver input */
    }
  }

  /* === KOMPAKT LAYOUT F√ñR ELEVFR√ÖGOR (OVERRIDE) === */

  /* Gemensam kort-layout */
  .quiz-question-card {
    margin: 8px 0;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid rgba(148, 163, 184, 0.4);
  }

  .quiz-question-card h4 {
    margin: 0 0 6px 0;
    font-size: 0.95rem;
  }

  /* === Bildfr√•gor === */
  .quiz-question-card.image-question .image-wrap {
    max-height: 190px;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .quiz-question-card.image-question img {
    max-height: 180px;
    width: auto;
    height: auto;
    object-fit: contain;
  }

  /* === Drag & drop-fr√•gor === */
  .quiz-question-card.drag-question .drag-layout {
    display: grid;
    grid-template-columns: 1.1fr 1.1fr;
    gap: 8px;
    align-items: flex-start;
  }

  .quiz-question-card.drag-question .drag-source-list,
  .quiz-question-card.drag-question .drag-target-list {
    max-height: 180px;
    overflow-y: auto;
    padding: 4px;
    border-radius: 6px;
    border: 1px dashed rgba(148, 163, 184, 0.5);
  }

  .quiz-question-card.drag-question .drag-item {
    padding: 4px 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    font-size: 0.85rem;
  }

  .quiz-question-card.drag-question .drag-target {
    min-height: 28px;
    padding: 4px 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    font-size: 0.85rem;
  }

  </style>
  <!-- slut SEKTION CSS -->







</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">üîí F√•ngvaktaren</div>
        <div class="mini">Slutf√∂r niv√•erna i ordning f√∂r att l√•sa upp n√§sta.</div>
      </div>
      <div class="actions">
        <button id="btnDownloadGame" class="btn ghost">Ladda ner spelfil</button>
        <button id="btnTeacher" class="btn ghost">L√§rarl√§ge</button>
      </div>
    </div>

    <div class="card" id="studentCard">
      <h3>üë§ Elevuppgifter</h3>
      <div class="row"><label for="studentName">Namn</label><input id="studentName" class="input" placeholder="F√∂r- och efternamn"/></div>
      <div class="row"><label for="studentClass">Klass</label><input id="studentClass" class="input" placeholder="t.ex. HRHOT25"/></div>
      <div class="actions" style="margin-top:8px">
        <button id="saveStudent" class="btn">Spara elev</button>
        <span class="mini" id="studentSaved">‚Äî</span>
      </div>
    </div>




<!-- start SEKTION 4: SPELOMR√ÖDE & RESULTAT -->

<!-- Niv√•√∂versikt ‚Äì grid med niv√•-kort -->
<section id="level-overview" class="card">
  <h2>üîí F√•ngvaktaren ‚Äì niv√•er</h2>
  <p>V√§lj niv√• f√∂r att spela. Forts√§tt i ordning E ‚Üí C ‚Üí A.</p>

  <div class="grid" id="level-grid">
    <!-- Niv√• E -->
    <article id="card-levelE" class="level-card">
      <header>
        <h3>Niv√• E</h3>
        <p id="badge-levelE" class="badge">Ingen badge √§n</p>
      </header>
      <div class="level-body">
        <p id="start-levelE" class="level-start">Start: 0 fr√•gor</p>
        <p id="best-levelE" class="level-best">B√§sta resultat: ‚Äì</p>
        <p id="thres-levelE" class="level-threshold">Gr√§ns f√∂r godk√§nt: ‚Äì</p>
      </div>
      <footer>
        <button type="button" class="btn primary" data-level="E">Starta niv√• E</button>
      </footer>
    </article>

    <!-- Niv√• C -->
    <article id="card-levelC" class="level-card">
      <header>
        <h3>Niv√• C</h3>
        <p id="badge-levelC" class="badge">L√•st</p>
      </header>
      <div class="level-body">
        <p id="start-levelC" class="level-start">Start: 0 fr√•gor</p>
        <p id="best-levelC" class="level-best">B√§sta resultat: ‚Äì</p>
        <p id="thres-levelC" class="level-threshold">Gr√§ns f√∂r godk√§nt: ‚Äì</p>
      </div>
      <footer>
        <button type="button" class="btn primary" data-level="C">Starta niv√• C</button>
      </footer>
    </article>

    <!-- Niv√• A -->
    <article id="card-levelA" class="level-card">
      <header>
        <h3>Niv√• A</h3>
        <p id="badge-levelA" class="badge">L√•st</p>
      </header>
      <div class="level-body">
        <p id="start-levelA" class="level-start">Start: 0 fr√•gor</p>
        <p id="best-levelA" class="level-best">B√§sta resultat: ‚Äì</p>
        <p id="thres-levelA" class="level-threshold">Gr√§ns f√∂r godk√§nt: ‚Äì</p>
      </div>
      <footer>
        <button type="button" class="btn primary" data-level="A">Starta niv√• A</button>
      </footer>
    </article>
  </div>
</section>

<!-- Spelvyn -->
<section id="play" class="card" style="display:none;">
  <header>
    <h2 id="play-title">Spela niv√•</h2>
    <p id="whoPlays" class="hint">Elev & klass visas h√§r.</p>
  </header>

  <div id="questions" class="questions-area">
    <!-- Fr√•gorna fylls i via JavaScript -->
  </div>

  <div class="button-row top-row">
    <button id="btnSubmit" type="button" class="btn primary">L√§mna in svar</button>
    <button id="btnCancel" type="button" class="btn secondary">Avbryt</button>
  </div>

  <div class="button-row bottom-row">
    <button id="btnSubmitBottom" type="button" class="btn primary">L√§mna in svar</button>
    <button id="btnCancelBottom" type="button" class="btn secondary">Avbryt</button>
  </div>
</section>

<!-- Resultatvyn -->
<section id="result" class="card" style="display:none;">
  <header>
    <h2>Resultat</h2>
    <p id="scoreText" class="score-main">Po√§ng visas h√§r.</p>
    <p id="scoreDetail" class="score-detail">Detaljerat resultat.</p>
  </header>

  <div class="result-meta">
    <p><strong>Namn:</strong> <span id="resName">‚Äì</span></p>
    <p><strong>Klass:</strong> <span id="resClass">‚Äì</span></p>
  </div>

  <div class="result-status">
    <p id="passBadge" class="badge">Status visas h√§r.</p>
    <p id="unlockText" class="hint">Information om uppl√•st niv√•.</p>
  </div>

  <div id="criteriaResults" class="criteria-list">
    <!-- Visar uppfyllda kriterier / delbitar -->
  </div>

  <div class="button-row">
    <button id="prepareSubmitBtn" type="button" class="btn primary">F√∂rbered inl√§mning</button>
    <button id="btnBack" type="button" class="btn secondary">Tillbaka till niv√•er</button>
  </div>

  <!-- Export / resultat-hantering -->
  <section id="exportSection" class="card" style="display:none; margin-top:1rem;">
    <h3>Exportera resultat</h3>

    <div id="resultActionsNormal" class="button-row">
      <button id="copyJsonBtn" type="button" class="btn">Kopiera JSON</button>
      <button id="emailJsonBtn" type="button" class="btn">Skicka via e-post</button>
      <button id="backToOverviewBtnExport" type="button" class="btn secondary">Tillbaka</button>
    </div>

    <label for="resultJson" class="label">Resultat-JSON</label>
    <textarea id="resultJson" rows="6" class="mono-field" readonly></textarea>
  </section>
</section>

<!-- slut SEKTION 4: SPELOMR√ÖDE & RESULTAT -->




<!-- start SEKTION 5: GOOGLE-INLOGGNING & UPPLADDNING (L√ÑRARE) -->
<section id="teacher-google-section" class="teacher-only">
  <div id="teacher-google-block" class="card settings-block" style="display:none;">
    <h2>Google-inloggning &amp; uppladdning (l√§rare)</h2>

    <div class="row auth-row">
      <div class="col">
        <div class="label">Status</div>
        <p id="googleStatus" class="hint">‚òÅÔ∏è Inte inloggad</p>
        <p class="hint">
          Sparar och h√§mtar nuvarande fr√•gebank kopplat till ditt Google-konto.
        </p>
        <p class="hint">
          Logga in med Google f√∂r att kunna ladda upp och h√§mta fr√•gebanken.
        </p>
      </div>

      <div class="col">
        <div class="label">√Ötg√§rder</div>
        <div class="button-row">
          <button id="googleSignInBtn" class="btn primary">
            Logga in med Google
          </button>
          <button id="googleSignOutBtn" class="btn ghost hidden">
            Logga ut
          </button>
        </div>
        <div class="button-row">
          <button id="uploadQuestionsBtn" class="btn" disabled>
            Ladda upp fr√•gebank
          </button>
          <button id="downloadQuestionsBtn" class="btn" disabled>
            H√§mta fr√•gebank
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- slut SEKTION 5: GOOGLE-INLOGGNING & UPPLADDNING (L√ÑRARE) -->












    <!-- Gate (l√∂senord) -->
    <div class="modal" id="gate">
      <div class="panel" style="max-width:480px">
        <h2>üîê L√§rarl√§ge</h2>
        <div class="mini">Ange l√§rarl√∂senord.</div>
        <div class="row" style="grid-template-columns:1fr auto">
          <input id="gatePw" class="input" type="password" autocomplete="new-password" placeholder="********">
          <button id="gateOk" class="btn">√ñppna</button>
        </div>
        <div class="actions" style="justify-content:flex-end;margin-top:8px">
          <button id="gateCancel" class="btn secondary">Avbryt</button>
        </div>
      </div>
    </div>

    <!-- L√§rarpanel -->
    <div class="modal" id="modal">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
          <h2>üõ†Ô∏è L√§rarl√§ge</h2>
          <button class="btn secondary" id="closeModal">St√§ng</button>
        </div>

        <div class="tab-nav">
          <button class="tab-btn active" data-tab="settings">Inst√§llningar</button>
          <button class="tab-btn" data-tab="mcq">Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="image">Bildfr√•gor</button>
          <button class="tab-btn" data-tab="drag">Drag & Drop</button>
        </div>

        <div id="tab-content-wrapper">
          <!-- Inst√§llningar -->
          <div class="tab-content" id="tab-settings">
            <h3>‚öôÔ∏è Generella inst√§llningar</h3>
            <div class="mini">L√∂senord: <span id="currPass">‚Äî</span></div>
            <div class="row"><label for="newPass">Nytt l√∂senord</label><input id="newPass" class="input" type="password" placeholder="Minst 4 tecken"/></div>
            <div class="actions"><button id="savePass" class="btn">Spara l√∂senord</button></div>
            <div class="hr"></div>
            <h3>üìß E-post f√∂r resultat</h3>
            <div class="row"><label for="teacherEmail">L√§rarens E-post</label><input id="teacherEmail" class="input" type="email" placeholder="din.epost@skola.se"/></div>
            <div class="actions"><button id="saveEmail" class="btn">Spara E-post</button></div>
            <div class="hr"></div>
            <h3>Gr√§nser f√∂r godk√§nt (%)</h3>
            <div class="threshold-grid">
              <div class="row"><label for="thr-levelE">Niv√• 1 (%)</label><input id="thr-levelE" class="input" type="number" min="0" max="100" /></div>
              <div class="row"><label for="thr-levelC">Niv√• 2 (%)</label><input id="thr-levelC" class="input" type="number" min="0" max="100" /></div>
              <div class="row"><label for="thr-levelA">Niv√• 3 (%)</label><input id="thr-levelA" class="input" type="number" min="0" max="100" /></div>
            </div>
            <div class="actions"><button id="saveThresholds" class="btn">Spara gr√§nser</button></div>
            <div class="hr"></div>
            <h3>üéØ Delm√•l & Bed√∂mning</h3>
            <div class="mini">Definiera delm√•l och upp till 5 delbitar per delm√•l.</div>
            <div id="objectivesListContainer" style="margin-top: 10px;"></div>
            <div class="actions" style="border-top: 1px dashed var(--muted); padding-top: 10px;">
              <button id="addObjectiveBtn" class="btn ghost" type="button">+ L√§gg till delm√•l</button>
              <button id="saveObjectives" class="btn">Spara Delm√•l</button>
            </div>
            <div class="hr"></div>
            <h3>üì• Importera Elevresultat</h3>
            <div class="row" style="align-items: start;">
              <label for="importData">Klistra in resultat</label>
              <div style="width: 100%;">
                <textarea id="importData" class="input monospace" rows="6" placeholder='JSON...'></textarea>
                <div class="actions">
                  <button id="btnImportResult" class="btn">Importera</button>
                  <span class="mini" id="importStatus">‚Äî</span>
                </div>
              </div>
            </div>
            <div class="hr"></div>
            <h3>üíæ Lagring & Distribution</h3>
            <div class="mini" id="storageInfo">‚Äî</div>
            <div class="mini" id="cloudStatus">Moln: ej inloggad</div>
            <div class="actions" style="flex-wrap: wrap;">
              <button id="btnShrinkAll" class="btn ghost miniBtn">Komprimera bilder</button>
              <button id="btnResetTeacher" class="btn secondary miniBtn">Nollst√§ll Elevdata</button>
              <button id="btnFullReset" class="btn danger miniBtn" title="Rensar ALLT utom l√∂senord/epost.">Nollst√§ll Hela Spelet</button>

              <button id="btnCloudLogin"  class="btn ghost miniBtn"     type="button">Logga in (Google)</button>
              <button id="btnCloudLogout" class="btn secondary miniBtn" type="button">Logga ut</button>
              <button id="btnCloudSave"   class="btn ghost miniBtn"     type="button">Spara till moln</button>
              <button id="btnCloudLoad"   class="btn ghost miniBtn"     type="button">H√§mta fr√•n moln</button>
            </div>
          </div>

          <!-- Flervalsfr√•gor -->
          <div class="tab-content hidden" id="tab-mcq">
            <h3>üß† Flervals ‚Äì Importera Text</h3>
            <div class="mini">Format: Fr√•ga (slutar med ?), alternativ under, r√§tt med *. Koppla delbitar f√∂rst, klistra in text, sen importera.</div>

            <!-- E -->
            <div class="row import-row" style="align-items:start">
              <div style="width:100%">
                <div class="objective-linking-area import-objective-link">
                  <h4 class="import-title">E-niv√•</h4>
                  <div class="mini import-hint">V√§lj delbitar att koppla till fr√•gorna nedan.</div>

                  <div class="objective-dropdown-link">
                    <select id="mcqImportObjectiveSelectE" class="input" aria-label="V√§lj delm√•l f√∂r import E"></select>
                    <select id="mcqImportCriteriaSelectE" class="input" aria-label="V√§lj delbit f√∂r import E" disabled></select>
                    <button id="mcqImportAddLinkBtnE" type="button" class="btn ghost miniBtn">+ L√§gg till</button>
                  </div>

                  <ul id="mcqImportAddedLinksE" class="added-links-list"></ul>

                  <div class="mini import-format">
                    <strong>Format:</strong> En fr√•ga per rad (slutar med <code>?</code>). Alternativ p√• separata rader under, r√§tt markeras med <code>*</code>.
                    <br>Ex: Vad heter Sveriges huvudstad?
                    <br>Helsinki<br><strong>*Stockholm</strong><br>K√∂penhamn<br>Oslo
                  </div>

                  <textarea id="mcqTextE" class="input" rows="6" placeholder="Klistra in fr√•gor och alternativ h√§r..."></textarea>
                  <div class="actions"><button id="btnImportMCQE" class="btn">Importera E</button><span class="mini" id="statusMCQE">‚Äî</span></div>
                </div>
              </div>
            </div>

            <!-- C -->
            <div class="row import-row" style="align-items:start; margin-top:15px;">
              <div style="width:100%">
                <div class="objective-linking-area import-objective-link">
                  <h4 class="import-title">C-niv√•</h4>
                  <div class="mini import-hint">V√§lj delbitar att koppla till fr√•gorna nedan.</div>

                  <div class="objective-dropdown-link">
                    <select id="mcqImportObjectiveSelectC" class="input" aria-label="V√§lj delm√•l f√∂r import C"></select>
                    <select id="mcqImportCriteriaSelectC" class="input" aria-label="V√§lj delbit f√∂r import C" disabled></select>
                    <button id="mcqImportAddLinkBtnC" type="button" class="btn ghost miniBtn">+ L√§gg till</button>
                  </div>

                  <ul id="mcqImportAddedLinksC" class="added-links-list"></ul>

                  <div class="mini import-format">
                    <strong>Format:</strong> Fr√•ga + alternativ; <code>*</code> markerar r√§tt.
                  </div>

                  <textarea id="mcqTextC" class="input" rows="6" placeholder="Klistra in C-niv√•-fr√•gor h√§r..."></textarea>
                  <div class="actions"><button id="btnImportMCQC" class="btn">Importera C</button><span class="mini" id="statusMCQC">‚Äî</span></div>
                </div>
              </div>
            </div>

            <!-- A -->
            <div class="row import-row" style="align-items:start; margin-top:15px;">
              <div style="width:100%">
                <div class="objective-linking-area import-objective-link">
                  <h4 class="import-title">A-niv√•</h4>
                  <div class="mini import-hint">V√§lj delbitar att koppla till fr√•gorna nedan.</div>

                  <div class="objective-dropdown-link">
                    <select id="mcqImportObjectiveSelectA" class="input" aria-label="V√§lj delm√•l f√∂r import A"></select>
                    <select id="mcqImportCriteriaSelectA" class="input" aria-label="V√§lj delbit f√∂r import A" disabled></select>
                    <button id="mcqImportAddLinkBtnA" type="button" class="btn ghost miniBtn">+ L√§gg till</button>
                  </div>

                  <ul id="mcqImportAddedLinksA" class="added-links-list"></ul>

                  <div class="mini import-format">
                    <strong>Format:</strong> Fr√•ga + alternativ; <code>*</code> markerar r√§tt.
                  </div>

                  <textarea id="mcqTextA" class="input" rows="6" placeholder="Klistra in A-niv√•-fr√•gor h√§r..."></textarea>
                  <div class="actions"><button id="btnImportMCQA" class="btn">Importera A</button><span class="mini" id="statusMCQA">‚Äî</span></div>
                </div>
              </div>
            </div>

            <div class="hr"></div>
            <h3>‚ûï Skapa flervalsfr√•ga (manuell)</h3>
            <div class="row"><label for="mcqLevel">Niv√•</label><select id="mcqLevel" class="input" style="max-width:200px" aria-label="V√§lj niv√•"><option value="E" selected>E</option><option value="C">C</option><option value="A">A</option></select></div>
            <div class="row"><label for="mcqPrompt">Fr√•ga</label><input id="mcqPrompt" class="input"/></div>
            <div class="row" style="align-items:flex-start"><label>Alternativ</label><div style="width:100%"><div id="mcqOptList"></div><div class="actions"><button id="btnAddMcqOpt" class="btn ghost miniBtn" type="button">+ Alternativ</button></div><div class="mini">Bocka i r√§tt svar.</div></div></div>
            <div class="objective-linking-area">
                <h4>Koppla till Delbitar</h4>
                <div class="objective-dropdown-link">
                    <select id="mcqObjectiveSelect" class="input" aria-label="V√§lj delm√•l"></select>
                    <select id="mcqCriteriaSelect" class="input" aria-label="V√§lj delbit" disabled></select>
                    <button id="mcqAddLinkBtn" type="button" class="btn ghost miniBtn">+ L√§gg till</button>
                </div>
                <ul id="mcqAddedLinks" class="added-links-list"></ul>
            </div>
            <div class="actions"><button id="btnAddMCQ" class="btn">L√§gg till flervalsfr√•ga</button><span class="mini" id="addStatusMCQ">‚Äî</span></div>
            <div class="hr"></div>
            <h3>üìã Befintliga flervalsfr√•gor</h3>
            <div id="mcqListE" class="list"></div>
            <div class="hr-mini"></div>
            <div id="mcqListC" class="list"></div>
            <div class="hr-mini"></div>
            <div id="mcqListA" class="list"></div>
          </div>

          <!-- Bildfr√•gor -->
          <div class="tab-content hidden" id="tab-image">
            <h3>‚ûï Skapa bildfr√•ga</h3>
            <div class="mini">1) V√§lj fil ‚Üí 2) Info & alt ‚Üí 3) Koppla ‚Üí 4) L√§gg till.</div>
            <div class="row" style="align-items:flex-start"><label for="qImgFile">Bild</label><div><input id="qImgFile" class="input" type="file" accept="image/*"/><div class="mini">Komp:<select id="imgQuality" class="input" style="width:auto;display:inline-block" aria-label="V√§lj komp"><option value="900|0.7" selected>Liten</option><option value="1200|0.75">Normal</option><option value="1600|0.8">Stor</option></select></div><div id="thumbPreview" class="thumb"><em class="mini">Ingen bild</em></div></div></div>
            <div class="row"><label for="imgLevel">Niv√•</label><select id="imgLevel" class="input" style="max-width:200px" aria-label="V√§lj niv√•"><option value="E" selected>E</option><option value="C">C</option><option value="A">A</option></select></div>
            <div class="row"><label for="qPrompt">Fr√•ga</label><input id="qPrompt" class="input" value="Vad visar bilden?"/></div>
            <div class="row" style="align-items:flex-start"><label>Alternativ</label><div style="width:100%"><div id="optList"></div><div class="actions"><button id="btnAddOpt" class="btn ghost miniBtn" type="button">+ Alternativ</button></div><div class="mini">Bocka i r√§tt svar.</div></div></div>
            <div class="objective-linking-area">
                <h4>Koppla till Delbitar</h4>
                <div class="objective-dropdown-link">
                  <select id="imageObjectiveSelect" class="input" aria-label="V√§lj delm√•l"></select>
                  <select id="imageCriteriaSelect" class="input" aria-label="V√§lj delbit" disabled></select>
                  <button id="imageAddLinkBtn" type="button" class="btn ghost miniBtn">+ L√§gg till</button>
                </div>
                <ul id="imageAddedLinks" class="added-links-list"></ul>
            </div>
            <div class="actions"><button id="btnAddImageMCQ" class="btn">L√§gg till bildfr√•ga</button><span class="mini" id="addStatus">‚Äî</span></div>
            <div class="hr"></div>
            <h3>üìã Befintliga bildfr√•gor</h3>
            <div id="imgList" class="list"></div>
          </div>

          <!-- Drag & Drop -->
          <div class="tab-content hidden" id="tab-drag">
            <h3>‚ûï Skapa Drag & Drop</h3>
            <div class="row"><label for="dragLevel">Niv√•</label><select id="dragLevel" class="input" style="max-width:200px" aria-label="V√§lj niv√•"><option value="E">E</option><option value="C" selected>C</option><option value="A">A</option></select></div>
            <div class="row"><label for="dragTitle">Titel</label><input id="dragTitle" class="input" placeholder="T.ex. Para ihop land och huvudstad"/></div>
            <div class="row" style="align-items:flex-start"><label>Matchningspar</label><div style="width:100%"><div id="dragPairList"></div><div class="actions"><button id="btnAddDragPair" class="btn ghost miniBtn" type="button">+ L√§gg till par</button></div></div></div>
            <div class="objective-linking-area">
                <h4>Koppla till Delbitar</h4>
                <div class="objective-dropdown-link">
                  <select id="dragObjectiveSelect" class="input" aria-label="V√§lj delm√•l"></select>
                  <select id="dragCriteriaSelect" class="input" aria-label="V√§lj delbit" disabled></select>
                  <button id="dragAddLinkBtn" type="button" class="btn ghost miniBtn">+ L√§gg till</button>
                </div>
                <ul id="dragAddedLinks" class="added-links-list"></ul>
            </div>
            <div class="actions"><button id="btnAddDragDrop" class="btn">L√§gg till Drag & Drop</button><span class="mini" id="addStatusDrag">‚Äî</span></div>
            <div class="hr"></div>
            <h3>üìã Befintliga Drag & Drop</h3>
            <div id="dragList" class="list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
<!-- slut DEL 1/3 -->

<!-- start DEL 2/3: iOS-lagringspatch + Script (del 1) -->
  <!-- PATCH: iOS-lagringsdiagnostik + safe wrappers -->
  <script>
  (function(){
    function storageProbe(){
      try{
        const k="__probe_"+Math.random().toString(36).slice(2);
        localStorage.setItem(k,"1");
        localStorage.removeItem(k);
        return true;
      }catch(e){ return e && e.name ? e.name : "StorageError"; }
    }
    const probe = storageProbe();

    const mem = {};
    window.safeGet = (k)=> {
      try { return probe===true ? localStorage.getItem(k) : (mem[k] ?? null); }
      catch(e){ return mem[k] ?? null; }
    };
    window.safeSet = (k,v)=> {
      try { if(probe===true){ localStorage.setItem(k,v); return true; } }
      catch(e){}
      mem[k]=v; return false;
    };
    window.safeRemove = (k)=> {
      try { if(probe===true) localStorage.removeItem(k); } catch(e){}
      delete mem[k];
    };

    if(probe!==true){
      const div=document.createElement('div');
      div.style.cssText="position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:#111827;color:#fff;padding:12px;border:1px solid #ef4444;border-radius:12px;font:14px system-ui";
      div.innerHTML = `
        <b>‚ö†Ô∏è Sparning avst√§ngd i denna vy</b><br>
        Orsak: <code>${String(probe)}</code> (vanligt om filen √∂ppnas i Mail/Gmail/Teams).<br>
        <b>G√∂r s√• h√§r:</b> Dela ‚Üí <i>√ñppna i Safari</i> & st√§ng Privat surfning. Alternativt: <i>L√§gg till p√• hemsk√§rmen</i> eller √∂ppna via http(s).
      `;
      document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(div), {once:true});
    }
  })();
  </script>

  <!-- Huvudscript -->
  <script>
  /* =========================
     F√ÖNGVAKTAREN ‚Äì SCRIPT (full ers√§ttning)
     ========================= */

  /* === Konfiguration === */
  const KEY = "FGAME_v16_ECA_Progression_DM";
  const DEFAULT = {
    teacherPassword: "password",
    teacherEmail: "",
    thresholds: { levelE: 70, levelC: 70, levelA: 70 },
    best: {},
    unlocked: {},
    objectives: [],
    flags: {},
    student: { name:"", klass:"" },
    bank: { mcqE: [], mcqC: [], mcqA: [], images: [], dragdrop: [] }
  };

  /* === Laddning & Sparning === */
  function load(){
    try{
      const d = safeGet(KEY);
      if(d){
        const lS = JSON.parse(d);
        const mS = JSON.parse(JSON.stringify(DEFAULT));
        for(const k in lS) if(Object.hasOwnProperty.call(lS,k)) mS[k]=lS[k];
        mS.thresholds = { ...DEFAULT.thresholds, ...(lS.thresholds||{}) };
        mS.best       = { ...DEFAULT.best,       ...(lS.best||{}) };
        mS.unlocked   = { ...DEFAULT.unlocked,   ...(lS.unlocked||{}) };
        mS.student    = { ...DEFAULT.student,    ...(lS.student||{}) };
        mS.bank       = { ...DEFAULT.bank,       ...(lS.bank||{}) };

        mS.bank.mcqE   = mS.bank.mcqE   || [];
        mS.bank.mcqC   = mS.bank.mcqC   || [];
        mS.bank.mcqA   = mS.bank.mcqA   || [];
        mS.bank.images = mS.bank.images || [];
        mS.bank.dragdrop = mS.bank.dragdrop || [];
        mS.objectives  = Array.isArray(lS.objectives) ? lS.objectives : DEFAULT.objectives;

        ['mcqE','mcqC','mcqA','images','dragdrop'].forEach(k=>{
          (mS.bank[k]||[]).forEach(q=>{ if(!q.linkedCriteria) q.linkedCriteria=[]; });
        });

        return mS;
      }
    }catch(e){ console.error("Load fail:", e); }
    console.warn("Using default state.");
    return JSON.parse(JSON.stringify(DEFAULT));
  }
  function save(s){
    try{
      if(!s||typeof s!=='object') throw new Error("Invalid state.");
      const ok = safeSet(KEY, JSON.stringify(s));
      if(!ok) throw new Error("Local saving blocked (fallback).");
      return true;
    }catch(e){
      console.error("Save fail:", e);
      notify(e.name==='QuotaExceededError'?"Minnet fullt.":"Kunde ej spara.");
      return false;
    }
  }

  /* === IndexedDB (bilder) === */
  const DB_NAME="FGAME_MEDIA_DB_v2", DB_VER=1, STORE="images";
  function idbOpen(){
    return new Promise((res,rej)=>{
      try{
        const r = indexedDB.open(DB_NAME, DB_VER);
        r.onupgradeneeded = e=>{
          try{
            const d=e.target.result;
            if(!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE);
          }catch(err){ console.error("IDB upgrade err:", err); rej(err); }
        };
        r.onsuccess = e=>res(e.target.result);
        r.onerror   = ()=>{ console.error("IDB open err:", r.error); rej(r.error||new Error("IDB fail")); };
        r.onblocked = ()=>rej(new Error("IDB blocked"));
      }catch(err){ console.error("IDB init err:", err); rej(err); }
    });
  }
  function idbGet(ref){
    let db;
    return idbOpen().then(d=>{
      db=d;
      return new Promise((res,rej)=>{
        try{
          const t=db.transaction(STORE,"readonly"), s=t.objectStore(STORE), r=s.get(ref);
          r.onsuccess=()=>res(r.result??null);
          r.onerror  =()=>rej(r.error||"Get fail");
          t.onerror  =()=>rej(t.error||"Tx fail");
          t.onabort  =()=>rej("Tx abort");
        }catch(e){ rej(e); }
      });
    }).finally(()=>db?.close());
  }
  function idbPut(ref,blob){
    let db;
    return idbOpen().then(d=>{
      db=d;
      return new Promise((res,rej)=>{
        try{
          const t=db.transaction(STORE,"readwrite"), s=t.objectStore(STORE);
          s.put(blob,ref);
          t.oncomplete=()=>res(true);
          t.onerror   =()=>rej(t.error||"Put fail");
          t.onabort   =()=>rej("Tx abort");
        }catch(e){ rej(e); }
      });
    }).finally(()=>db?.close());
  }
  function idbDel(ref){
    let db;
    return idbOpen().then(d=>{
      db=d;
      return new Promise((res,rej)=>{
        try{
          const t=db.transaction(STORE,"readwrite"), s=t.objectStore(STORE);
          s.delete(ref);
          t.oncomplete=()=>res(true);
          t.onerror   =()=>rej(t.error||"Del fail");
          t.onabort   =()=>rej("Tx abort");
        }catch(e){ rej(e); }
      });
    }).finally(()=>db?.close());
  }
  function idbClearStore(){
    let db;
    return idbOpen().then(d=>{
      db=d;
      return new Promise((res,rej)=>{
        try{
          const t=db.transaction(STORE,"readwrite"), s=t.objectStore(STORE);
          s.clear();
          t.oncomplete=()=>res(true);
          t.onerror   =()=>rej(t.error||"Clear fail");
          t.onabort   =()=>rej("Tx abort");
        }catch(e){ rej(e); }
      });
    }).finally(()=>db?.close());
  }
  async function dataURLtoBlob(url){
    try{
      const r=await fetch(url);
      if(!r.ok) throw new Error(`Fetch fail: ${r.status}`);
      return r.blob();
    }catch(e){ console.error("toBlob fail", e); throw e; }
  }
  async function storeImageRefFromDataURL(url){
    const ref="img_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);
    const blob=await dataURLtoBlob(url);
    await idbPut(ref,blob);
    return ref;
  }
  async function resolveImgURL(q){
    const ref=q?.imgRef;
    if(!ref) return "";
    try{
      const blob=await idbGet(ref);
      return (blob instanceof Blob)?URL.createObjectURL(blob):"";
    }catch(e){ console.error(`Resolve fail ref ${ref}`, e); return ""; }
  }
  async function blobToDataURL(b){
    return new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.onerror=()=>rej(r.error);
      r.readAsDataURL(b);
    });
  }

  /* === Paketering / Uppackning === */
  async function packageGameToFile() {
    notify("F√∂rbereder spelfil...");
    const state = load();
    if (!state) throw new Error("Kunde inte ladda data.");

    // Nollst√§ll elevspecifik data i paketet
    state.best = { ...DEFAULT.best };
    state.unlocked = { ...DEFAULT.unlocked };
    state.student = { ...DEFAULT.student };

    // B√§dda in bilder
    const embeddedImages = {};
    const imageRefs = (state.bank?.images || []).map(q => q.imgRef).filter(Boolean);
    for (const ref of imageRefs) {
      const blob = await idbGet(ref);
      if (blob instanceof Blob) embeddedImages[ref] = await blobToDataURL(blob);
    }

    const gameDataPackage = { state, images: embeddedImages, packagedAt: new Date().toISOString() };

    // Skapa ny HTML med inb√§ddad JSON
    const currentHtml = document.documentElement.outerHTML;
    const tempDoc = new DOMParser().parseFromString(currentHtml, 'text/html');
    const oldScript = tempDoc.getElementById('embeddedGameData'); if (oldScript) oldScript.remove();

    const scriptTag = tempDoc.createElement('script');
    scriptTag.id = 'embeddedGameData';
    scriptTag.type = 'application/json';
    scriptTag.textContent = JSON.stringify(gameDataPackage);
    tempDoc.head.appendChild(scriptTag);

    const newHtml = tempDoc.documentElement.outerHTML;

    // Skapa ZIP i st√§llet f√∂r ren HTML
    try {
      if (typeof JSZip === 'undefined') {
        // Fallback om JSZip mot f√∂rmodan inte laddas: ladda ned som .html
        const blobHtml = new Blob([newHtml], { type: 'text/html' });
        const urlHtml = URL.createObjectURL(blobHtml);
        const aHtml = document.createElement('a');
        aHtml.href = urlHtml;
        aHtml.download = 'Fangvaktaren_Spel.html';
        document.body.appendChild(aHtml);
        aHtml.click();
        document.body.removeChild(aHtml);
        URL.revokeObjectURL(urlHtml);
        notify("Spelfil (HTML) skapad. OBS: JSZip saknades, s√• ingen ZIP kunde skapas.");
        return;
      }

      const zip = new JSZip();
      zip.file("Fangvaktaren_Spel.html", newHtml);
      const content = await zip.generateAsync({ type: "blob" });

      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Fangvaktaren_Spel.zip';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      notify("ZIP-spelfil skapad och nedladdad!");
    } catch (e) {
      console.error("ZIP-paketering misslyckades:", e);
      notify("Kunde inte skapa ZIP-fil. F√∂rs√∂k igen eller kontrollera uppkoppling (JSZip).");
    }
  }

  async function unpackEmbeddedData() {
    const embeddedScript = document.getElementById('embeddedGameData');
    if (!embeddedScript) return false;
    if (safeGet(KEY)) return true;

    try{
      const gameDataPackage = JSON.parse(embeddedScript.textContent);
      if (!gameDataPackage || !gameDataPackage.state || !gameDataPackage.images) {
        throw new Error("Inb√§ddad data √§r korrupt.");
      }
      save(gameDataPackage.state);

      const imageRefs = Object.keys(gameDataPackage.images);
      for (const ref of imageRefs) {
        try {
          const dataUrl = gameDataPackage.images[ref];
          const blob = await dataURLtoBlob(dataUrl);
          await idbPut(ref, blob);
        } catch (e) { console.error(`Kunde inte spara bild ${ref}`, e); }
      }
      notify("Spelet har laddats fr√•n filen! Sidan laddas om.");
      setTimeout(()=>window.location.reload(), 1500);
      return true;
    }catch(e){
      console.error("Kunde inte packa upp:", e);
      notify("Fel vid uppackning: " + e.message);
      return false;
    }
  }

  /* === Hj√§lpare === */
  const $  = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);
  function notify(msg){ alert(msg); }
  function clampNum(v,min,max,def){ const n=Number(v); return (isNaN(n))?def:Math.max(min,Math.min(max,n)); }
  function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]) ); }
  function pickRandom(arr,k){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a.slice(0,k); }

  /* === Bildkomprimering === */
  async function bitmapToDataURL(bm, types=["image/webp","image/jpeg"], side=900, q=0.7){
    try{
      const sc=Math.min(1, side/Math.max(bm.width,bm.height));
      const w=Math.round(bm.width*sc), h=Math.round(bm.height*sc);
      const cv=document.createElement("canvas"); cv.width=w; cv.height=h;
      const ctx=cv.getContext("2d"); if(!ctx) throw new Error("No ctx");
      ctx.drawImage(bm,0,0,w,h);
      for(const t of types){
        const u=cv.toDataURL(t,q);
        if(u?.startsWith("data:")) return u;
      }
      return cv.toDataURL("image/jpeg",q);
    }catch(e){ console.error("bitmapToDataURL fail", e); throw e; }
  }
  async function fileToAdaptiveDataURL(f, p={maxSide:900, quality:0.7}, kb=250){
    try{
      if(!f) throw new Error("No file");
      const bm=await createImageBitmap(f);
      let side=p.maxSide, q=p.quality;
      let url=await bitmapToDataURL(bm,["image/webp","image/jpeg"],side,q);
      let tries=0;
      const bytes=u=>Math.floor(((u.split(",")[1]||"").length*3)/4);
      while(bytes(url)>kb*1024&&tries<6){
        tries++;
        if(q>0.6) q=Math.max(0.6, q-0.1);
        else if(side>700){ side=Math.max(700, side-150); q=Math.min(q+0.05, 0.7); }
        else q=Math.max(0.5, q-0.05);
        url=await bitmapToDataURL(bm,["image/webp","image/jpeg"],side,q);
      }
      return url;
    }catch(e){ console.error("fileToAdaptive fail", e); throw e; }
  }
  async function recompressBlob(b, side=900, q=0.7){
    try{
      if(!(b instanceof Blob)) throw new Error("Not Blob");
      const bm=await createImageBitmap(b);
      const url=await bitmapToDataURL(bm,["image/webp","image/jpeg"],side,q);
      return dataURLtoBlob(url);
    }catch(e){ console.error("recompress fail", e); throw e; }
  }

  /* === Fr√•geutils === */
  function getOptionTexts(o){ return (o?.options||[]).map(opt=>String(opt??"").trim()); }
  function getQText(o){ return o?.q||""; }
  function resolveCorrectIndex(item){ return item?.answer??-1; }

  /* === Niv√•styrning === */
  let answers = [], currentQuestions = [], submissionData = null;
  let postLoginAction = null;

  function imagesByLevel(all, level){ return (all||[]).filter(q=>q&&(q.level||"E").toUpperCase()===level.toUpperCase()); }
  function dragByLevel(all, level){ return (all||[]).filter(q=>q&&(q.level||"C").toUpperCase()===level.toUpperCase()); }
  function mcqByLevel(all, level){ return (all||[]).filter(q=>q&&(q.level||"E").toUpperCase()===level.toUpperCase()); }

  /* === Rendering spel === */
  async function renderSingleImage(q, idx, host){
    const el=document.createElement("div");
    el.className="question imgq";
    el.innerHTML = `
      <div><strong>${idx+1}. Bildfr√•ga:</strong> ${escapeHTML(getQText(q))}</div>
      <div class="media"><img alt="Laddar..." id="imgq-${q.id||idx}" /></div>
      <div class="options-list"></div>`;
    host.appendChild(el);

    const imgEl=el.querySelector(`#imgq-${q.id||idx}`);
    const optsContainer=el.querySelector('.options-list');
    getOptionTexts(q).forEach((opt,oi)=>{
      const optEl=document.createElement("label");
      optEl.className="option";
      optEl.innerHTML=`<input type="radio" name="q${idx}" value="${oi}"/> ${escapeHTML(opt)}`;
      optEl.addEventListener("change",e=>answers[idx]=Number(e.target.value));
      optsContainer.appendChild(optEl);
    });
    try{
      const url=await resolveImgURL(q);
      if(url){
        imgEl.src=url; imgEl.alt=`Bild ${idx+1}`;
        imgEl.onload=imgEl.onerror=()=>{ if(url.startsWith('blob:')) URL.revokeObjectURL(url); };
      }else{
        imgEl.alt="Bild saknas";
        imgEl.style.cssText="height:80px;width:120px;background:var(--muted);display:flex;align-items:center;justify-content:center;color:var(--text);font-size:12px;";
      }
    }catch(err){ imgEl.alt="Bildfel"; imgEl.style.height="80px"; }
  }
  function renderSingleMCQ(q, idx, host){
    const el=document.createElement("div");
    el.className="question";
    el.innerHTML = `
      <div><strong>${idx+1}. Flervalsfr√•ga:</strong> ${escapeHTML(getQText(q))}</div>
      <div class="options-list"></div>`;
    host.appendChild(el);
    const optsContainer=el.querySelector(".options-list");
    getOptionTexts(q).forEach((opt,oi)=>{
      const optEl=document.createElement("label");
      optEl.className="option";
      optEl.innerHTML=`<input type="radio" name="q${idx}" value="${oi}"/> ${escapeHTML(opt)}`;
      optEl.addEventListener("change",e=>answers[idx]=Number(e.target.value));
      optsContainer.appendChild(optEl);
    });
  }
  function renderSingleDrag(q, idx, host){
    const el=document.createElement("div");
    el.className="question";
    const lefts=q.pairs.map(p=>p[0]);
    const rights=[...new Set(q.pairs.map(p=>p[1]))];
    const leftHTML=pickRandom(lefts,lefts.length)
      .map(l=>`<span class="chip" draggable="true" tabindex="0" data-left="${escapeHTML(l)}">${escapeHTML(l)}</span>`).join("");
    const rightHTML=rights
      .map(r=>`<div class="bucket target-bucket" data-right="${escapeHTML(r)}" tabindex="0"><h4>${escapeHTML(r)}</h4><div class="dropzone"></div></div>`).join("");

    el.innerHTML = `
      <div style="font-weight:700;"><strong>${idx+1}. Drag & Drop:</strong> ${escapeHTML(q.title||"Matchning")}</div>
      <div class="drag-area">
        <div class="bucket pool-bucket" data-right="__POOL__" tabindex="0">
          <h4>Ej placerade</h4><div class="dropzone">${leftHTML}</div>
        </div>
        <div class="target-buckets">${rightHTML}</div>
      </div>
      <div class="mini">Dra brickor till r√§tt ruta, eller tryck bricka->ruta.</div>`;
    host.appendChild(el);

    let selectedChip=null; const POOL="__POOL__"; answers[idx]={};
    const updateMap=(chip,bucket)=>{
      const l=chip.dataset.left, r=bucket.dataset.right||POOL, map=answers[idx]||{};
      if(r===POOL) delete map[l]; else map[l]=r; answers[idx]=map;
    };
    const moveChip=(chip,target)=>{
      target.querySelector('.dropzone')?.appendChild(chip);
      updateMap(chip,target);
      selectedChip?.classList.remove('selected'); selectedChip=null;
    };
    el.querySelectorAll(".chip").forEach(c=>{
      c.addEventListener("dragstart",e=>{
        try{ e.dataTransfer.setData("text/plain",c.dataset.left); e.dataTransfer.effectAllowed="move"; }catch(err){}
      });
      c.addEventListener("click",()=>{
        if(selectedChip===c){ c.classList.remove("selected"); selectedChip=null; }
        else { el.querySelectorAll(".chip.selected").forEach(x=>x.classList.remove("selected")); c.classList.add("selected"); selectedChip=c; }
      });
    });
    el.querySelectorAll(".bucket").forEach(b=>{
      b.addEventListener("dragover",e=>{ e.preventDefault(); b.classList.add("hover"); e.dataTransfer.dropEffect="move"; });
      b.addEventListener("dragleave",()=>b.classList.remove("hover"));
      b.addEventListener("drop",e=>{
        e.preventDefault(); b.classList.remove("hover");
        const l=e.dataTransfer.getData("text/plain");
        const c=el.querySelector(`.chip[data-left="${l}"]`);
        if(c) moveChip(c,b);
      });
      b.addEventListener("click",()=>{ if(selectedChip) moveChip(selectedChip,b); });
    });
  }
  async function renderCombinedLevel(questions){
    const host=$("#questions");
    host.innerHTML="";
    currentQuestions=pickRandom(questions,questions.length);
    answers=new Array(currentQuestions.length).fill(null);
    if(currentQuestions.length===0){
      host.innerHTML=`<div class="question mini">Inga fr√•gor hittades.</div>`;
      return;
    }
    for(let i=0;i<currentQuestions.length;i++){
      const q=currentQuestions[i], idx=i;
      try{
        if(q.type==="image_mcq") await renderSingleImage(q,idx,host);
        else if(q.type==="mcq")  renderSingleMCQ(q,idx,host);
        else if(q.type==="dragdrop") renderSingleDrag(q,idx,host);
        else console.warn("Ok√§nd typ:", q);
      }catch(e){
        console.error("Render fail:", q, e);
        host.innerHTML+=`<div class="question err-text">Fel fr√•ga ${idx+1}.</div>`;
      }
    }
  }
  </script>
<!-- slut DEL 2/3 -->












<!-- start DEL 3A: Script ‚Äì UI Sync & Spelfl√∂de -->
<script>
"use strict";

/* === UI Sync & Spelfl√∂de === */
function uiSync() {
  const s = load();

  // Gr√§nser
  const thrE = $('#thres-levelE');
  const thrC = $('#thres-levelC');
  const thrA = $('#thres-levelA');
  if (thrE) thrE.textContent = s.thresholds.levelE;
  if (thrC) thrC.textContent = s.thresholds.levelC;
  if (thrA) thrA.textContent = s.thresholds.levelA;

  // B√§sta resultat
  const bestE = $('#best-levelE');
  const bestC = $('#best-levelC');
  const bestA = $('#best-levelA');
  if (bestE) bestE.textContent = s.best.levelE || 0;
  if (bestC) bestC.textContent = s.best.levelC || 0;
  if (bestA) bestA.textContent = s.best.levelA || 0;

  // Elevkort
  const nameInput  = $('#studentName');
  const classInput = $('#studentClass');
  const savedLabel = $('#studentSaved');
  if (nameInput)  nameInput.value  = s.student.name || '';
  if (classInput) classInput.value = s.student.klass || '';
  if (savedLabel) {
    savedLabel.textContent = s.student.name
      ? `Sparad: ${s.student.name} (${s.student.klass || '‚Äî'})`
      : 'Ej sparad elev';
  }

  // Kolla om niv√•bankar √§r tomma
  const bank = s.bank || {};
  const imgs = bank.images   || [];
  const drgs = bank.dragdrop || [];
  const mcqE = bank.mcqE     || [];
  const mcqC = bank.mcqC     || [];
  const mcqA = bank.mcqA     || [];

  const noE = imagesByLevel(imgs, 'E').length +
              dragByLevel(drgs, 'E').length +
              mcqE.length === 0;

  const noC = imagesByLevel(imgs, 'C').length +
              dragByLevel(drgs, 'C').length +
              mcqC.length === 0;

  // Uppl√•sning
  const ePassedOrEmpty    = (s.best.levelE >= s.thresholds.levelE) || noE;
  const levelCUnlocked    = s.unlocked.levelC || ePassedOrEmpty;
  const cPassed           = levelCUnlocked && (s.best.levelC >= s.thresholds.levelC);
  const cEmptyAndUnlocked = noC && levelCUnlocked;
  const levelAUnlocked    = s.unlocked.levelA || cPassed || cEmptyAndUnlocked;

  // Spara uppl√•sning om den √§ndrats
  if ((levelCUnlocked && !s.unlocked.levelC) ||
      (levelAUnlocked && !s.unlocked.levelA)) {
    s.unlocked.levelC = levelCUnlocked;
    s.unlocked.levelA = levelAUnlocked;
    save(s);
  }

  // L√•sta / uppl√•sta kort
  const cardC = $('#card-levelC');
  const cardA = $('#card-levelA');
  const btnC  = $('#start-levelC');
  const btnA  = $('#start-levelA');

  if (cardC) cardC.classList.toggle('lock', !levelCUnlocked);
  if (btnC)  btnC.disabled = !levelCUnlocked;
  if (cardA) cardA.classList.toggle('lock', !levelAUnlocked);
  if (btnA)  btnA.disabled = !levelAUnlocked;

  // Badges
  const badgeE = $('#badge-levelE');
  const badgeC = $('#badge-levelC');
  const badgeA = $('#badge-levelA');

  if (badgeE) {
    const ok = noE || s.best.levelE >= s.thresholds.levelE;
    badgeE.className = 'badge ' + (ok ? 'ok' : 'warn');
    badgeE.textContent = noE
      ? 'Tom'
      : ok ? 'Godk√§nd' : `Beh√∂ver ${s.thresholds.levelE}%`;
  }

  if (badgeC) {
    if (!levelCUnlocked) {
      badgeC.className = 'badge warn';
      badgeC.textContent = 'L√•st';
    } else {
      const ok = noC || s.best.levelC >= s.thresholds.levelC;
      badgeC.className = 'badge ' + (ok ? 'ok' : 'warn');
      badgeC.textContent = noC
        ? 'Tom'
        : ok ? 'Godk√§nd' : 'Uppl√•st';
    }
  }

  if (badgeA) {
    if (!levelAUnlocked) {
      badgeA.className = 'badge warn';
      badgeA.textContent = 'L√•st';
    } else {
      const ok = s.best.levelA >= s.thresholds.levelA;
      badgeA.className = 'badge ' + (ok ? 'ok' : 'warn');
      badgeA.textContent = ok ? 'Godk√§nd' : 'Uppl√•st';
    }
  }
}

let currentMode = null;

function ensureStudent() {
  const d = load().student;
  const has = d.name && d.name.trim() && d.klass && d.klass.trim();
  if (!has) notify('Fyll i Namn & Klass (klicka Spara).');
  return !!has;
}

async function startMode(mode) {
  if (!ensureStudent()) return;
  currentMode = mode;
  const s = load();

  const play    = $('#play');
  const student = $('#studentCard');
  const result  = $('#result');
  const grid    = $('.grid');
  const qHost   = $('#questions');
  const whoText = $('#whoPlays');
  const title   = $('#play-title');

  if (!play || !student || !grid || !qHost || !whoText || !title) return;

  play.classList.remove('hidden');
  student.classList.add('hidden');
  if (result) result.classList.add('hidden');
  grid.style.opacity = '0.2';
  qHost.innerHTML = '<div class="mini">Laddar...</div>';
  whoText.textContent = `${s.student.name} (${s.student.klass})`;

  let questions = [];
  let levelName = '';

  try {
    const b  = s.bank || {};
    const i  = b.images   || [];
    const d  = b.dragdrop || [];
    const mE = b.mcqE     || [];
    const mC = b.mcqC     || [];
    const mA = b.mcqA     || [];

    if (mode === 'levelE') {
      levelName = 'Niv√• 1';
      questions.push(...imagesByLevel(i, 'E'), ...dragByLevel(d, 'E'), ...mE);
    } else if (mode === 'levelC') {
      levelName = 'Niv√• 2';
      questions.push(...imagesByLevel(i, 'C'), ...dragByLevel(d, 'C'), ...mC);
    } else if (mode === 'levelA') {
      levelName = 'Niv√• 3';
      questions.push(...imagesByLevel(i, 'A'), ...dragByLevel(d, 'A'), ...mA);
    } else {
      throw new Error('Ok√§nt l√§ge');
    }

    title.textContent = levelName;
    await renderCombinedLevel(questions);
  } catch (e) {
    console.error('Start fail:', e);
    qHost.innerHTML = "<div class='question err-text'>Laddningsfel.</div>";
  }
}

function isPass(mode, score, thresholds) {
  if (mode === 'levelE') return score >= thresholds.levelE;
  if (mode === 'levelC') return score >= thresholds.levelC;
  if (mode === 'levelA') return score >= thresholds.levelA;
  return false;
}

function finish() {
  const s = load();
  let total = 0;
  let correct = 0;
  const critStats = {};
  const objStats  = {};

  s.objectives.forEach((o, oi) => {
    objStats[oi] = { name: o.name || `Delm√•l ${oi + 1}`, t: 0, c: 0 };
    o.criteria.forEach((c, ci) => {
      if (c?.trim()) {
        const id = `${oi}-${ci}`;
        critStats[id] = { name: c, objIdx: oi, t: 0, c: 0 };
      }
    });
  });

  currentQuestions.forEach((q, idx) => {
    let qCorrect = false;
    let qWeight  = 1;

    if (q.type === 'image_mcq' || q.type === 'mcq') {
      total++;
      if (answers[idx] === resolveCorrectIndex(q)) {
        correct++;
        qCorrect = true;
      }
    } else if (q.type === 'dragdrop') {
      const map = answers[idx] || {};
      let cPairs = 0;
      qWeight = q.pairs.length;
      total += qWeight;
      q.pairs.forEach(p => {
        if ((map[p[0]] || '') === p[1]) cPairs++;
      });
      correct += cPairs;
      if (cPairs === qWeight) qCorrect = true;
      qWeight = 1;
    }

    (q.linkedCriteria || []).forEach(id => {
      if (critStats[id]) {
        critStats[id].t += qWeight;
        if (qCorrect) critStats[id].c += qWeight;
      }
    });
  });

  for (const id in critStats) {
    const st = critStats[id];
    if (objStats[st.objIdx]) {
      objStats[st.objIdx].t += st.t;
      objStats[st.objIdx].c += st.c;
    }
  }

  const score  = total > 0 ? Math.round((correct / total) * 100) : 0;
  const passed = isPass(currentMode, score, s.thresholds);

  if (currentMode === 'levelE') s.best.levelE = Math.max(s.best.levelE || 0, score);
  if (currentMode === 'levelC') s.best.levelC = Math.max(s.best.levelC || 0, score);
  if (currentMode === 'levelA') s.best.levelA = Math.max(s.best.levelA || 0, score);

  if (currentMode === 'levelE' && passed) s.unlocked.levelC = true;
  if (currentMode === 'levelC' && passed) s.unlocked.levelA = true;

  submissionData = {
    studentName:    s.student?.name  || '?',
    studentClass:   s.student?.klass || '?',
    levelCompleted: currentMode,
    scorePercent:   score,
    correctAnswers: correct,
    totalQuestions: total,
    passed,
    criteriaStats:  critStats,
    objectiveStats: objStats,
    timestamp:      new Date().toISOString()
  };
  save(s);

  const canC = !$('#start-levelC')?.disabled;
  const canA = !$('#start-levelA')?.disabled;

  if (passed && currentMode === 'levelE' && canC) {
    notify('Niv√• 1 klar! -> Niv√• 2');
    startMode('levelC');
    return;
  }
  if (passed && currentMode === 'levelC' && canA) {
    notify('Niv√• 2 klar! -> Niv√• 3');
    startMode('levelA');
    return;
  }

  const play   = $('#play');
  const grid   = $('.grid');
  const result = $('#result');

  if (play)  play.classList.add('hidden');
  if (grid)  grid.style.opacity = '1';
  if (result) result.classList.remove('hidden');

  const scoreText   = $('#scoreText');
  const scoreDetail = $('#scoreDetail');
  const resName     = $('#resName');
  const resClass    = $('#resClass');
  const passBadge   = $('#passBadge');

  if (scoreText)   scoreText.textContent   = `${score}%`;
  if (scoreDetail) scoreDetail.textContent = `${correct}/${total} po√§ng`;
  if (resName)     resName.textContent     = s.student.name  || '?';
  if (resClass)    resClass.textContent    = s.student.klass || '?';

  if (passBadge) {
    passBadge.textContent = passed
      ? (currentMode === 'levelA' ? 'üèÅ Alla niv√•er klara!' : '‚úÖ Godk√§nd niv√•!')
      : '‚ùå Ej godk√§nd niv√•.';
  }

  let msg = '';
  if (currentMode === 'levelE') {
    msg = passed ? 'Niv√• 2 uppl√•st.' : `Beh√∂ver ${s.thresholds.levelE}%.`;
  } else if (currentMode === 'levelC') {
    msg = passed ? 'Niv√• 3 uppl√•st.' : `Beh√∂ver ${s.thresholds.levelC}%.`;
  } else {
    msg = passed ? 'Alla niv√•er klara!' : `Beh√∂ver ${s.thresholds.levelA}%.`;
  }

  const unlockText = $('#unlockText');
  if (unlockText) unlockText.textContent = msg;

  const critContainer = $('#criteriaResults');
  if (critContainer) {
    critContainer.innerHTML = '<h4>Resultat per Delm√•l:</h4>';
    let hasCritRes = false;

    for (const idx in objStats) {
      const st = objStats[idx];
      if (st.t > 0) {
        hasCritRes = true;
        const perc = Math.round((st.c / st.t) * 100);
        const cls  = perc >= 70 ? 'res-ok' : (perc >= 40 ? 'res-warn' : 'res-err');
        const div  = document.createElement('div');
        div.className = 'criterion-result';
        div.innerHTML = `<strong>${escapeHTML(st.name)}:</strong> <span class="${cls}">${perc}%</span> (${st.c}/${st.t} p)`;
        critContainer.appendChild(div);
      }
    }
    critContainer.classList.toggle('hidden', !hasCritRes);
  }

  const isFinal = (currentMode === 'levelA');
  const btnPrep = $('#prepareSubmitBtn');
  const btnBack = $('#btnBack');
  const exportSection     = $('#exportSection');
  const resultActionsNorm = $('#resultActionsNormal');

  if (btnPrep) btnPrep.classList.toggle('hidden', !isFinal);
  if (btnBack) btnBack.classList.remove('hidden');
  if (exportSection)     exportSection.classList.add('hidden');
  if (resultActionsNorm) resultActionsNorm.classList.remove('hidden');

  uiSync();
}

function hidePlayUI() {
  const play    = $('#play');
  const student = $('#studentCard');
  const grid    = $('.grid');

  if (play)    play.classList.add('hidden');
  if (student) student.classList.remove('hidden');
  if (grid)    grid.style.opacity = '1';

  uiSync();
}
</script>
<!-- slut DEL 3A -->













<!-- start DEL 3B: Adminpanel, delm√•l, listor -->
<script>
/* === Adminpanel (omskriven) === */
function openAdmin() {
  const s = load();
  const el = (sel) => document.querySelector(sel);

  if (el('#currPass'))     el('#currPass').textContent = s.teacherPassword || '';
  if (el('#teacherEmail')) el('#teacherEmail').value   = s.teacherEmail   || '';
  if (el('#thr-levelE'))   el('#thr-levelE').value     = s.thresholds?.levelE ?? 70;
  if (el('#thr-levelC'))   el('#thr-levelC').value     = s.thresholds?.levelC ?? 70;
  if (el('#thr-levelA'))   el('#thr-levelA').value     = s.thresholds?.levelA ?? 70;
  if (el('#newPass'))      el('#newPass').value        = '';

  try { renderObjectives(); }        catch(e){ console.error('renderObjectives fail', e); }
  try { updateObjectiveSelects(); }  catch(e){ console.error('updateObjectiveSelects fail', e); }
  try { renderMCQAdminLists(); }     catch(e){ console.error('renderMCQAdminLists fail', e); }
  try { renderImageAdminList(); }    catch(e){ console.error('renderImageAdminList fail', e); }
  try { renderDragAdminList(); }     catch(e){ console.error('renderDragAdminList fail', e); }
  try { updateStorageInfo(); }       catch(e){ console.error('updateStorageInfo fail', e); }

  const modal = el('#modal');
  if (modal) {
    modal.classList.add('show');
    setupModalTabs();
    switchTabByName('settings');
    setTimeout(() => {
      (el('#newPass') ||
       el('#teacherEmail') ||
       modal.querySelector('input,select,button'))?.focus();
    }, 50);
  }
}

function checkGate() {
  const pwInput = document.querySelector('#gatePw');
  const pw = (pwInput?.value || '').trim();
  const s  = load();

  if (pwInput) pwInput.value = '';

  if (pw === (s.teacherPassword || '')) {
    document.querySelector('#gate')?.classList.remove('show');
    const action = postLoginAction;
    postLoginAction = null;

    if (action === 'openAdmin') {
      openAdmin();
    } else if (action === 'downloadGame') {
      packageGameToFile().catch(e => {
        console.error('Package fail:', e);
        notify('Kunde inte skapa spelfil: ' + (e?.message || e));
      });
    } else {
      openAdmin();
    }
  } else {
    notify('Fel l√∂senord.');
    postLoginAction = null;
  }
}

/* === Adminlistor === */
function getCriteriaName(s, id) {
  const [oi, ci] = id.split('-').map(Number);
  return s.objectives?.[oi]?.criteria?.[ci] || `Ok√§nd(${id})`;
}

function renderMCQAdminListFor(level, cId) {
  const host = $(cId);
  const s = load();
  const arr = (level === 'E' ? s.bank.mcqE
              : level === 'C' ? s.bank.mcqC
                               : s.bank.mcqA) || [];

  host.innerHTML = arr.length > 0
    ? `<div class="mini">Niv√• ${level} (${arr.length} st)</div>`
    : '';

  arr.forEach((q, i) => {
    const opts   = getOptionTexts(q);
    const linked = (q.linkedCriteria || []);
    let linkHTML = '';

    if (linked.length > 0) {
      linkHTML = '<ul class="linked-criteria-list">';
      linked.forEach(id => {
        linkHTML += `<li>üîó ${escapeHTML(getCriteriaName(s, id))}</li>`;
      });
      linkHTML += '</ul>';
    }

    const div = document.createElement('div');
    div.className = 'listItem';
    div.innerHTML = `
      <div class="mini">MCQ</div>
      <div>
        <div style="font-weight:700">${escapeHTML(getQText(q))} <span class="tag level">${level}</span></div>
        <div class="mini">${opts.map((o, oi) =>
          `${escapeHTML(o)}${(resolveCorrectIndex(q) === oi ? '<span class="tag ok">‚úì</span>' : '')}`
        ).join(' ‚Ä¢ ')}</div>
        ${linkHTML}
      </div>
      <div class="actions">
        <button class="btn secondary miniBtn" data-list="mcq" data-level="${level}" data-idx="${i}">Ta bort</button>
      </div>`;
    host.appendChild(div);
  });
}

function renderMCQAdminLists() {
  ['E', 'C', 'A'].forEach(l => renderMCQAdminListFor(l, `#mcqList${l}`));
}

async function renderImageAdminList() {
  const host = $('#imgList');
  const s = load();
  const images = s.bank.images || [];
  const frag = document.createDocumentFragment();

  host.innerHTML = '';
  if (images.length === 0) {
    host.innerHTML = `<div class="mini">Inga bildfr√•gor.</div>`;
    return;
  }

  for (let i = 0; i < images.length; i++) {
    const q = images[i];
    if (!q) continue;
    const opts   = getOptionTexts(q);
    const linked = (q.linkedCriteria || []);
    let linkHTML = '';

    if (linked.length > 0) {
      linkHTML = '<ul class="linked-criteria-list">';
      linked.forEach(id => {
        linkHTML += `<li>üîó ${escapeHTML(getCriteriaName(s, id))}</li>`;
      });
      linkHTML += '</ul>';
    }

    const li = document.createElement('div');
    li.className = 'listItem';
    li.innerHTML = `
      <img alt="Laddar..." id="athumb-${i}"/>
      <div>
        <div style="font-weight:700">${escapeHTML(getQText(q))} <span class="tag level">${(q.level || 'E')}</span></div>
        <div class="mini">${opts.map((o, oi) =>
          `${escapeHTML(o)}${(resolveCorrectIndex(q) === oi ? '<span class="tag ok">‚úì</span>' : '')}`
        ).join(' ‚Ä¢ ')}</div>
        ${linkHTML}
      </div>
      <div class="actions">
        <button class="btn secondary miniBtn" data-list="image" data-idx="${i}">Ta bort</button>
      </div>`;
    frag.appendChild(li);
  }
  host.appendChild(frag);

  for (let i = 0; i < images.length; i++) {
    const q = images[i];
    if (!q) continue;
    const imgEl = host.querySelector(`#athumb-${i}`);
    if (!imgEl) continue;
    try {
      const url = await resolveImgURL(q);
      if (url) {
        imgEl.src = url;
        imgEl.alt = `Mini ${i + 1}`;
        imgEl.onload = imgEl.onerror = () => {
          if (url.startsWith('blob:')) URL.revokeObjectURL(url);
        };
      } else imgEl.alt = 'Bild saknas';
    } catch (e) {
      imgEl.alt = 'Laddfel';
    }
  }
}

function renderDragAdminList() {
  const host = $('#dragList');
  const s = load();
  const items = s.bank.dragdrop || [];

  host.innerHTML = '';
  if (items.length === 0) {
    host.innerHTML = `<div class="mini">Inga D&D.</div>`;
    return;
  }

  items.forEach((it, i) => {
    const pairs  = it.pairs || [];
    const level  = it.level || 'C';
    const linked = (it.linkedCriteria || []);
    let linkHTML = '';

    if (linked.length > 0) {
      linkHTML = '<ul class="linked-criteria-list">';
      linked.forEach(id => {
        linkHTML += `<li>üîó ${escapeHTML(getCriteriaName(s, id))}</li>`;
      });
      linkHTML += '</ul>';
    }

    const div = document.createElement('div');
    div.className = 'listItem';
    div.innerHTML = `
      <div class="mini">DRAG</div>
      <div>
        <div style="font-weight:700">${escapeHTML(it.title || 'Matchning')} <span class="tag level">${level}</span></div>
        <div class="mini">${pairs.map(p => `${escapeHTML(p[0])}‚Üî${escapeHTML(p[1])}`).join(' ‚Ä¢ ')}</div>
        ${linkHTML}
      </div>
      <div class="actions">
        <button class="btn secondary miniBtn" data-list="drag" data-idx="${i}">Ta bort</button>
      </div>`;
    host.appendChild(div);
  });
}

/* === Delm√•l === */
function renderObjectives() {
  const s = load();
  const c = $('#objectivesListContainer');
  if (!c) return;

  c.innerHTML = '';
  if (!s.objectives || s.objectives.length === 0) {
    c.innerHTML = `<div class="mini">Inga delm√•l.</div>`;
  } else {
    s.objectives.forEach((o, i) => {
      const g = document.createElement('div');
      g.className = 'objective-group';
      g.dataset.idx = i;
      g.innerHTML = `
        <button type="button" class="btn danger miniBtn remove-objective-btn" data-idx="${i}" title="Ta bort">X</button>
        <div class="row main-objective">
          <label for="obj${i}-name">Delm√•l ${i + 1}</label>
          <input id="obj${i}-name" class="input obj-name" value="${escapeHTML(o.name || '')}" placeholder="Namn"/>
        </div>
        <div class="row sub-row"><label for="obj${i}-crit0">Delbit .1</label><input id="obj${i}-crit0" class="input obj-crit0" value="${escapeHTML(o.criteria?.[0] || '')}" placeholder="Delbit 1"/></div>
        <div class="row sub-row"><label for="obj${i}-crit1">Delbit .2</label><input id="obj${i}-crit1" class="input obj-crit1" value="${escapeHTML(o.criteria?.[1] || '')}" placeholder="Delbit 2"/></div>
        <div class="row sub-row"><label for="obj${i}-crit2">Delbit .3</label><input id="obj${i}-crit2" class="input obj-crit2" value="${escapeHTML(o.criteria?.[2] || '')}" placeholder="Delbit 3"/></div>
        <div class="row sub-row"><label for="obj${i}-crit3">Delbit .4</label><input id="obj${i}-crit3" class="input obj-crit3" value="${escapeHTML(o.criteria?.[3] || '')}" placeholder="Delbit 4"/></div>
        <div class="row sub-row"><label for="obj${i}-crit4">Delbit .5</label><input id="obj${i}-crit4" class="input obj-crit4" value="${escapeHTML(o.criteria?.[4] || '')}" placeholder="Delbit 5"/></div>`;
      c.appendChild(g);
    });
  }
}

function populateCriteriaDropdown(objSelectId, critSelectId) {
  const s = load();
  const objSelect  = $(objSelectId);
  const critSelect = $(critSelectId);
  if (!objSelect || !critSelect) return;

  const selIdx = parseInt(objSelect.value, 10);
  critSelect.innerHTML = '<option value="">-- V√§lj Delbit --</option>';
  critSelect.disabled = true;

  if (!isNaN(selIdx) && s.objectives[selIdx]) {
    s.objectives[selIdx].criteria.forEach((crit, critIdx) => {
      if (crit?.trim()) {
        const id = `${selIdx}-${critIdx}`;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = crit;
        critSelect.appendChild(opt);
      }
    });
    if (critSelect.options.length > 1) critSelect.disabled = false;
  }
}

function setupObjectiveDropdowns(objSelectId, critSelectId, addBtnId, listId, currentLinksRef) {
  const objSelect = $(objSelectId);
  const critSelect = $(critSelectId);
  const addBtn = $(addBtnId);
  const list = $(listId);
  if (!objSelect || !critSelect || !addBtn || !list) return;

  const s = load();
  objSelect.innerHTML = '<option value="">-- V√§lj Delm√•l --</option>';
  s.objectives.forEach((obj, idx) => {
    if (obj.name?.trim()) {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = obj.name;
      objSelect.appendChild(opt);
    }
  });

  const populateHandler = () => populateCriteriaDropdown(objSelectId, critSelectId);
  objSelect.addEventListener('change', populateHandler);

  const renderAddedLinks = () => {
    list.innerHTML = '';
    (currentLinksRef.links || []).forEach((linkId, index) => {
      const [objIdx, critIdx] = linkId.split('-').map(Number);
      const objName  = s.objectives?.[objIdx]?.name || '?';
      const critName = s.objectives?.[objIdx]?.criteria?.[critIdx] || '?';
      const li = document.createElement('li');
      li.innerHTML = `${escapeHTML(critName)} <small>(${escapeHTML(objName)})</small> <button type="button" data-index="${index}" title="Ta bort koppling">√ó</button>`;
      li.querySelector('button').addEventListener('click', (e) => {
        const idxToRemove = parseInt(e.target.dataset.index, 10);
        currentLinksRef.links.splice(idxToRemove, 1);
        renderAddedLinks();
      });
      list.appendChild(li);
    });
  };

  addBtn.addEventListener('click', () => {
    const selectedCritId = critSelect.value;
    if (selectedCritId && !(currentLinksRef.links || []).includes(selectedCritId)) {
      if (!currentLinksRef.links) currentLinksRef.links = [];
      currentLinksRef.links.push(selectedCritId);
      renderAddedLinks();
      critSelect.value = '';
      objSelect.value = '';
      critSelect.disabled = true;
    }
  });

  renderAddedLinks();
}

function updateObjectiveSelects() {
  const selects = [
    { obj: '#mcqObjectiveSelect',         crit: '#mcqCriteriaSelect' },
    { obj: '#imageObjectiveSelect',       crit: '#imageCriteriaSelect' },
    { obj: '#dragObjectiveSelect',        crit: '#dragCriteriaSelect' },
    { obj: '#mcqImportObjectiveSelectE',  crit: '#mcqImportCriteriaSelectE' },
    { obj: '#mcqImportObjectiveSelectC',  crit: '#mcqImportCriteriaSelectC' },
    { obj: '#mcqImportObjectiveSelectA',  crit: '#mcqImportCriteriaSelectA' }
  ];

  const s = load();
  selects.forEach(pair => {
    const objSelect = $(pair.obj);
    if (objSelect) {
      const currentVal = objSelect.value;
      objSelect.innerHTML = '<option value="">-- V√§lj Delm√•l --</option>';
      s.objectives.forEach((obj, idx) => {
        if (obj.name?.trim()) {
          const opt = document.createElement('option');
          opt.value = idx;
          opt.textContent = obj.name;
          objSelect.appendChild(opt);
        }
      });
      objSelect.value = currentVal;
      populateCriteriaDropdown(pair.obj, pair.crit);
    }
  });
}
</script>
<!-- slut DEL 3B -->


















<!-- start DEL 3C: Tabs, byggare & fr√•geaddering -->
<script>
/* === Tabs i l√§rarl√§ge === */
function switchTabByName(name) {
  const targetId = `tab-${name}`;

  document.querySelectorAll('#modal .tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === name);
  });

  document.querySelectorAll('#modal .tab-content').forEach(panel => {
    panel.classList.toggle('hidden', panel.id !== targetId);
  });

  if (name === 'image') renderImageAdminList();
  if (name === 'mcq')   renderMCQAdminLists();
  if (name === 'drag')  renderDragAdminList();
}

function setupModalTabs() {
  const nav = document.querySelector('#modal .tab-nav');
  if (!nav) return;
  nav.addEventListener('click', (e) => {
    const btn = e.target.closest('.tab-btn');
    if (!btn) return;
    e.preventDefault();
    const name = btn.dataset.tab;
    if (!name) return;
    switchTabByName(name);
  }, { passive: true });
}

/* === Byggare/addera === */
function addOptionRow(listSelector, isCorrect = false, value = '') {
  const list = $(listSelector);
  const div = document.createElement('div');
  div.className = 'builder-row';
  div.innerHTML = `
    <input type="checkbox" ${isCorrect ? 'checked' : ''} aria-label="R√§tt svar">
    <label>Alt:</label>
    <input type="text" class="input option-text" value="${escapeHTML(value)}" placeholder="Alternativtext...">
    <button type="button" class="remove-option-btn" title="Ta bort alternativ">X</button>`;
  list.appendChild(div);
}

function handleRemoveOption(event) {
  if (event.target.classList.contains('remove-option-btn')) {
    event.target.closest('.builder-row')?.remove();
  }
}

function addDragPairRow(leftVal = '', rightVal = '') {
  const list = $('#dragPairList');
  const div = document.createElement('div');
  div.className = 'drag-pair-row';
  div.innerHTML = `
    <input type="text" class="input drag-left" value="${escapeHTML(leftVal)}" placeholder="V√§nster bricka...">
    <span>‚ÜîÔ∏è</span>
    <input type="text" class="input drag-right" value="${escapeHTML(rightVal)}" placeholder="H√∂ger ruta...">
    <button type="button" class="remove-pair-btn" title="Ta bort par">X</button>`;
  list.appendChild(div);
}

function handleRemoveDragPair(event) {
  if (event.target.classList.contains('remove-pair-btn')) {
    event.target.closest('.drag-pair-row')?.remove();
  }
}

function collectOptions(listSelector) {
  const options = [];
  let correctIndex = -1;
  $$(listSelector + ' .builder-row').forEach((row) => {
    const text = row.querySelector('.option-text')?.value.trim() || '';
    const isChecked = row.querySelector('input[type=checkbox]')?.checked || false;
    if (text) {
      options.push(text);
      if (isChecked && correctIndex === -1) correctIndex = options.length - 1;
    }
  });
  if (correctIndex === -1 && options.length > 0) correctIndex = 0;
  return { options, answer: correctIndex };
}

function addManualMCQ() {
  const level = $('#mcqLevel').value || 'E';
  const prompt = $('#mcqPrompt').value.trim();
  const { options, answer } = collectOptions('#mcqOptList');
  const linkedCriteria = window.tempBuilderLinks?.mcq?.links || [];

  if (!prompt || options.length < 2) {
    $('#addStatusMCQ').textContent = 'Fyll i fr√•ga och minst 2 alternativ.';
    return;
  }

  const newQ = {
    id: 'mcq_' + Date.now(),
    type: 'mcq',
    level,
    q: prompt,
    options,
    answer,
    linkedCriteria: [...linkedCriteria]
  };

  const s = load();
  const bankKey = `mcq${level}`;
  if (!s.bank[bankKey]) s.bank[bankKey] = [];
  s.bank[bankKey].push(newQ);

  if (save(s)) {
    $('#addStatusMCQ').textContent = `Fr√•ga tillagd (${level}).`;
    $('#mcqPrompt').value = '';
    $('#mcqOptList').innerHTML = '';
    addOptionRow('#mcqOptList');
    addOptionRow('#mcqOptList');
    window.tempBuilderLinks.mcq.links = [];
    $('#mcqAddedLinks').innerHTML = '';
    $('#mcqObjectiveSelect').value = '';
    $('#mcqCriteriaSelect').value = '';
    $('#mcqCriteriaSelect').disabled = true;
    renderMCQAdminLists();
  } else {
    $('#addStatusMCQ').textContent = 'Kunde inte spara.';
  }
}

let currentImageDataUrl = null;

async function previewImage() {
  const fileInput = $('#qImgFile');
  const preview = $('#thumbPreview');
  currentImageDataUrl = null;
  preview.innerHTML = '<em class="mini">Laddar...</em>';

  if (fileInput.files && fileInput.files[0]) {
    const file = fileInput.files[0];
    const qualitySettings = ($('#imgQuality').value || '900|0.7')
      .split('|')
      .map(Number);
    const options = {
      maxSide: qualitySettings[0] || 900,
      quality: qualitySettings[1] || 0.7
    };
    try {
      currentImageDataUrl = await fileToAdaptiveDataURL(file, options);
      preview.innerHTML = `<img src="${currentImageDataUrl}" alt="F√∂rhandsgranskning">`;
      $('#addStatus').textContent =
        `Bild klar (${Math.round((currentImageDataUrl.split(',')[1]?.length * 3 / 4) / 1024)} kB).`;
    } catch (e) {
      console.error('Preview/Compress fail:', e);
      preview.innerHTML = '<em class="mini err-text">Bildfel</em>';
      $('#addStatus').textContent = 'Fel vid bildhantering.';
    }
  } else {
    preview.innerHTML = '<em class="mini">Ingen bild</em>';
  }
}

async function addManualImageMCQ() {
  const level = $('#imgLevel').value || 'E';
  const prompt = $('#qPrompt').value.trim();
  const { options, answer } = collectOptions('#optList');
  const linkedCriteria = window.tempBuilderLinks?.image?.links || [];

  if (!currentImageDataUrl) {
    $('#addStatus').textContent = 'V√§lj en bild f√∂rst.';
    return;
  }
  if (!prompt || options.length < 2) {
    $('#addStatus').textContent = 'Fyll i fr√•ga och minst 2 alternativ.';
    return;
  }

  $('#addStatus').textContent = 'Sparar bild...';
  let imgRef = null;

  try {
    imgRef = await storeImageRefFromDataURL(currentImageDataUrl);
    const newQ = {
      id: 'img_' + Date.now(),
      type: 'image_mcq',
      level,
      imgRef,
      q: prompt,
      options,
      answer,
      linkedCriteria: [...linkedCriteria]
    };
    const s = load();
    if (!s.bank.images) s.bank.images = [];
    s.bank.images.push(newQ);

    if (save(s)) {
      $('#addStatus').textContent = `Bildfr√•ga tillagd (${level}).`;
      $('#qPrompt').value = 'Vad visar bilden?';
      $('#optList').innerHTML = '';
      addOptionRow('#optList');
      addOptionRow('#optList');
      $('#qImgFile').value = '';
      $('#thumbPreview').innerHTML = '<em class="mini">Ingen bild</em>';
      currentImageDataUrl = null;
      window.tempBuilderLinks.image.links = [];
      $('#imageAddedLinks').innerHTML = '';
      $('#imageObjectiveSelect').value = '';
      $('#imageCriteriaSelect').value = '';
      $('#imageCriteriaSelect').disabled = true;
      renderImageAdminList();
      updateStorageInfo();
    } else {
      $('#addStatus').textContent = 'Kunde inte spara fr√•gan.';
      if (imgRef) idbDel(imgRef).catch(() => {});
    }
  } catch (e) {
    console.error('Add image fail:', e);
    $('#addStatus').textContent = 'Fel vid sparande av bild.';
  }
}

function addManualDragDrop() {
  const level = $('#dragLevel').value || 'C';
  const title = $('#dragTitle').value.trim();
  const linkedCriteria = window.tempBuilderLinks?.drag?.links || [];
  const pairs = [];

  $$('#dragPairList .drag-pair-row').forEach(row => {
    const left  = row.querySelector('.drag-left')?.value.trim();
    const right = row.querySelector('.drag-right')?.value.trim();
    if (left && right) pairs.push([left, right]);
  });

  if (!title || pairs.length < 2) {
    $('#addStatusDrag').textContent = 'Fyll i titel och minst 2 giltiga par.';
    return;
  }

  const newQ = {
    id: 'dd_' + Date.now(),
    type: 'dragdrop',
    level,
    title,
    pairs,
    linkedCriteria: [...linkedCriteria]
  };

  const s = load();
  if (!s.bank.dragdrop) s.bank.dragdrop = [];
  s.bank.dragdrop.push(newQ);

  if (save(s)) {
    $('#addStatusDrag').textContent = `Drag & Drop tillagd (${level}).`;
    $('#dragTitle').value = '';
    $('#dragPairList').innerHTML = '';
    addDragPairRow();
    addDragPairRow();
    window.tempBuilderLinks.drag.links = [];
    $('#dragAddedLinks').innerHTML = '';
    $('#dragObjectiveSelect').value = '';
    $('#dragCriteriaSelect').value = '';
    $('#dragCriteriaSelect').disabled = true;
    renderDragAdminList();
  } else {
    $('#addStatusDrag').textContent = 'Kunde inte spara.';
  }
}

async function handleRemoveItem(event) {
  const button = event.target.closest('button[data-list][data-idx]');
  if (!button) return;

  const listType = button.dataset.list;
  const index = parseInt(button.dataset.idx, 10);
  const level = button.dataset.level;

  if (isNaN(index)) return;
  if (!confirm('√Ñr du s√§ker p√• att du vill ta bort denna fr√•ga?')) return;

  const s = load();
  let itemToRemove = null;

  try {
    if (listType === 'mcq' && level) {
      const bankKey = `mcq${level}`;
      if (s.bank[bankKey]?.[index]) {
        itemToRemove = s.bank[bankKey].splice(index, 1)[0];
      }
    } else if (listType === 'image') {
      if (s.bank.images?.[index]) {
        itemToRemove = s.bank.images.splice(index, 1)[0];
        if (itemToRemove?.imgRef) await idbDel(itemToRemove.imgRef);
      }
    } else if (listType === 'drag') {
      if (s.bank.dragdrop?.[index]) {
        itemToRemove = s.bank.dragdrop.splice(index, 1)[0];
      }
    }

    if (itemToRemove && save(s)) {
      notify('Fr√•ga borttagen.');
      if (listType === 'mcq')        renderMCQAdminLists();
      else if (listType === 'image') renderImageAdminList();
      else if (listType === 'drag')  renderDragAdminList();
      updateStorageInfo();
    } else {
      notify('Kunde inte ta bort fr√•gan.');
    }
  } catch (e) {
    console.error('Remove item fail:', e);
    notify('Fel vid borttagning.');
  }
}
</script>
<!-- slut DEL 3C -->















<!-- start DEL 3D: Import-MCQ, lagring & import av elevresultat -->
<script>
/* === Importera text-MCQ === */
function importMCQ(level) {
  const textareaId = `#mcqText${level}`;
  const statusId   = `#statusMCQ${level}`;
  const text = $(textareaId).value.trim();
  const linkedCriteria = window.tempImportLinks?.[level]?.links || [];
  const statusEl = $(statusId);

  if (!text) {
    statusEl.textContent = 'Textf√§ltet √§r tomt.';
    return;
  }

  const lines = text
    .split('\n')
    .map(l => l.trim())
    .filter(l => l && !l.startsWith('#'));

  const questions = [];
  let currentQ = null;

  lines.forEach(line => {
    if (line.endsWith('?')) {
      if (currentQ && currentQ.options.length > 0) questions.push(currentQ);
      currentQ = {
        id: `mcq_${level}_${Date.now()}_${questions.length}`,
        type: 'mcq',
        level,
        q: line,
        options: [],
        answer: -1,
        linkedCriteria: [...linkedCriteria]
      };
    } else if (currentQ) {
      let optionText = line;
      let isCorrect = false;
      if (line.startsWith('*')) {
        isCorrect = true;
        optionText = line.substring(1).trim();
      }
      if (optionText) {
        currentQ.options.push(optionText);
        if (isCorrect) currentQ.answer = currentQ.options.length - 1;
      }
    }
  });

  if (currentQ && currentQ.options.length > 0) questions.push(currentQ);

  const validQuestions = questions.filter(q =>
    q.q && q.options.length >= 2 && q.answer !== -1
  );
  const invalidCount = questions.length - validQuestions.length;

  if (validQuestions.length === 0) {
    statusEl.textContent = 'Inga giltiga fr√•gor hittades i texten.';
    return;
  }

  const s = load();
  const bankKey = `mcq${level}`;
  if (!s.bank[bankKey]) s.bank[bankKey] = [];
  s.bank[bankKey].push(...validQuestions);

  if (save(s)) {
    let msg = `${validQuestions.length} fr√•gor importerade (${level}).`;
    if (invalidCount > 0) msg += ` ${invalidCount} ogiltiga ignorerades.`;
    statusEl.textContent = msg;

    $(textareaId).value = '';
    window.tempImportLinks[level].links = [];
    $(`#mcqImportAddedLinks${level}`).innerHTML = '';
    $(`#mcqImportObjectiveSelect${level}`).value = '';
    $(`#mcqImportCriteriaSelect${level}`).value = '';
    $(`#mcqImportCriteriaSelect${level}`).disabled = true;
    renderMCQAdminLists();
  } else {
    statusEl.textContent = 'Kunde inte spara fr√•gorna.';
  }
}

/* === Diverse Admin-funktioner === */
function updateStorageInfo() {
  const s = load();
  const mcqE = s.bank.mcqE?.length     || 0;
  const mcqC = s.bank.mcqC?.length     || 0;
  const mcqA = s.bank.mcqA?.length     || 0;
  const img  = s.bank.images?.length   || 0;
  const drag = s.bank.dragdrop?.length || 0;
  const obj  = s.objectives?.length    || 0;
  $('#storageInfo').textContent =
    `Status: ${mcqE} MCQ(E), ${mcqC} MCQ(C), ${mcqA} MCQ(A), ${img} Bild, ${drag} D&D, ${obj} Delm√•l.`;
}

async function shrinkAllImages() {
  if (!confirm("Vill du komprimera om alla bilder till 'Liten' storlek?")) return;
  notify('Komprimerar...');
  const s = load();
  let changed = 0;

  try {
    for (const q of s.bank.images || []) {
      if (q?.imgRef) {
        const blob = await idbGet(q.imgRef);
        if (blob instanceof Blob) {
          const newBlob = await recompressBlob(blob, 900, 0.7);
          await idbPut(q.imgRef, newBlob);
          changed++;
        }
      }
    }
    notify(`Komprimering klar. ${changed} bilder uppdaterade.`);
    renderImageAdminList();
  } catch (e) {
    console.error('Shrink fail:', e);
    notify('Fel vid komprimering.');
  }
}

async function purgeImages() {
  if (!confirm('VARNING: Detta tar bort ALLA bildfr√•gor och bilder permanent. S√§ker?')) return;
  notify('Tar bort bilder...');
  const s = load();

  try {
    await idbClearStore();
    s.bank.images = [];
    if (save(s)) {
      notify('Alla bildfr√•gor och bilder borttagna.');
      renderImageAdminList();
      updateStorageInfo();
    }
  } catch (e) {
    console.error('Purge fail:', e);
    notify('Kunde inte ta bort bilder.');
  }
}

function resetStudentData() {
  if (!confirm('Nollst√§ll ALL elevdata (namn, klass, resultat, uppl√•sningar)?')) return;
  const s = load();
  s.student = { ...DEFAULT.student };
  s.best    = { ...DEFAULT.best };
  s.unlocked= { ...DEFAULT.unlocked };
  if (save(s)) {
    notify('Elevdata nollst√§lld.');
    uiSync();
  }
}

async function fullReset() {
  if (!confirm('VARNING: Detta nollst√§ller HELA spelet (alla fr√•gor, bilder, inst√§llningar, elevdata) utom l√∂senord och e-post. √ÑR DU HELT S√ÑKER?')) return;

  try {
    await idbClearStore();
    const currentPw    = load().teacherPassword;
    const currentEmail = load().teacherEmail;
    safeRemove(KEY);
    const newState = load();
    newState.teacherPassword = currentPw;
    newState.teacherEmail    = currentEmail;
    save(newState);
    notify('Hela spelet har nollst√§llts (utom l√∂senord/epost). Sidan laddas om.');
    setTimeout(() => window.location.reload(), 1500);
  } catch (e) {
    console.error('Full reset fail:', e);
    notify('Kunde inte nollst√§lla helt.');
  }
}

function importStudentResult() {
  const dataEl = $('#importData');
  const statusEl = $('#importStatus');

  try {
    const data = JSON.parse(dataEl.value);
    if (!data || typeof data !== 'object' || !data.studentName ||
        !data.levelCompleted || typeof data.scorePercent !== 'number') {
      throw new Error('Ogiltigt format.');
    }

    const s = load();
    s.student.name  = data.studentName;
    s.student.klass = data.studentClass || '';

    if (data.levelCompleted === 'levelE') {
      s.best.levelE = Math.max(s.best.levelE || 0, data.scorePercent);
    }
    if (data.levelCompleted === 'levelC') {
      s.best.levelC = Math.max(s.best.levelC || 0, data.scorePercent);
    }
    if (data.levelCompleted === 'levelA') {
      s.best.levelA = Math.max(s.best.levelA || 0, data.scorePercent);
    }
    if (data.passed) {
      if (data.levelCompleted === 'levelE') s.unlocked.levelC = true;
      if (data.levelCompleted === 'levelC') s.unlocked.levelA = true;
    }

    if (save(s)) {
      statusEl.textContent =
        `Importerat: ${data.studentName} (${data.levelCompleted}, ${data.scorePercent}%)`;
      dataEl.value = '';
      uiSync();
    } else {
      statusEl.textContent = 'Kunde inte spara importerad data.';
    }
  } catch (e) {
    console.error('Import error:', e);
    statusEl.textContent = `Fel: ${e.message}`;
  }
}
</script>
<!-- slut DEL 3D -->













<!-- start DEL 3E: Firebase/moln + init & events -->
<script>
/* === Firebase moln-spara / ladda === */
function getFirebaseHandles() {
  const fv = window.fvFirebase;
  if (!fv || !fv.auth || !fv.db) return null;
  return fv;
}

function updateCloudUI(user, note) {
  const el        = document.getElementById('cloudStatus');
  const btnLogin  = document.getElementById('btnCloudLogin');
  const btnLogout = document.getElementById('btnCloudLogout');
  const btnSave   = document.getElementById('btnCloudSave');
  const btnLoad   = document.getElementById('btnCloudLoad');

  const hasFirebase = !!getFirebaseHandles();
  if (!el) return;

  if (!hasFirebase) {
    el.textContent = 'Moln: inte aktiverat i denna version.';
    [btnLogin, btnLogout, btnSave, btnLoad].forEach(b => { if (b) b.disabled = true; });
    return;
  }

  if (user) {
    const who = user.email || user.displayName || user.uid;
    el.textContent = 'Moln: inloggad som ' + who + (note ? ' ‚Äì ' + note : '');
    if (btnLogin)  btnLogin.disabled  = true;
    if (btnLogout) btnLogout.disabled = false;
    if (btnSave)   btnSave.disabled   = false;
    if (btnLoad)   btnLoad.disabled   = false;
  } else {
    el.textContent = 'Moln: ej inloggad.' + (note ? ' ' + note : '');
    if (btnLogin)  btnLogin.disabled  = false;
    if (btnLogout) btnLogout.disabled = true;
    if (btnSave)   btnSave.disabled   = true;
    if (btnLoad)   btnLoad.disabled   = true;
  }
}

async function ensureTeacherLogin() {
  const fv = getFirebaseHandles();
  if (!fv) {
    notify('Molnlagring √§r inte aktiverad i denna version.');
    return null;
  }
  const { auth, provider, signInWithPopup } = fv;

  let user = auth.currentUser;
  if (user) return user;

  try {
    const res = await signInWithPopup(auth, provider);
    user = res.user;
    updateCloudUI(user);
    return user;
  } catch (e) {
    console.error('Login fail:', e);
    notify('Kunde inte logga in.');
    updateCloudUI(null);
    return null;
  }
}

async function cloudSaveGame() {
  const fv = getFirebaseHandles();
  if (!fv) {
    notify('Molnlagring √§r inte aktiverad.');
    return;
  }

  const user = await ensureTeacherLogin();
  if (!user) return;

  const { db, doc, setDoc } = fv;
  const s = load();
  const payload = {
    bank:       s.bank       || {},
    objectives: s.objectives || [],
    thresholds: s.thresholds || DEFAULT.thresholds,
    updatedAt:  new Date().toISOString()
  };

  try {
    await setDoc(doc(db, 'fangvaktarenGames', user.uid), payload, { merge: true });
    updateCloudUI(user, 'senast sparad nu.');
    notify('Fr√•gebank och delm√•l sparade i molnet.');
  } catch (e) {
    console.error('Cloud save fail:', e);
    notify('Kunde inte spara till molnet.');
    updateCloudUI(user, 'fel vid sparande.');
  }
}

async function cloudLoadGame() {
  const fv = getFirebaseHandles();
  if (!fv) {
    notify('Molnlagring √§r inte aktiverad.');
    return;
  }

  const user = await ensureTeacherLogin();
  if (!user) return;

  const { db, doc, getDoc } = fv;

  try {
    const snap = await getDoc(doc(db, 'fangvaktarenGames', user.uid));
    if (!snap.exists()) {
      notify('Ingen sparad data hittades i molnet.');
      updateCloudUI(user, 'ingen sparad data.');
      return;
    }

    const data = snap.data() || {};
    const s = load();

    if (data.bank)       s.bank       = data.bank;
    if (data.objectives) s.objectives = data.objectives;
    if (data.thresholds) s.thresholds = data.thresholds;

    save(s);
    renderObjectives();
    updateObjectiveSelects();
    renderMCQAdminLists();
    renderImageAdminList();
    renderDragAdminList();
    uiSync();
    updateStorageInfo();
    updateCloudUI(user, 'data h√§mtad.');
    notify('Fr√•gebank och delm√•l h√§mtade fr√•n molnet.');
  } catch (e) {
    console.error('Cloud load fail:', e);
    notify('Kunde inte h√§mta fr√•n molnet.');
    updateCloudUI(user, 'fel vid h√§mtning.');
  }
}

async function cloudLogout() {
  const fv = getFirebaseHandles();
  if (!fv) {
    updateCloudUI(null);
    return;
  }
  try {
    await fv.signOut(fv.auth);
  } catch (e) {
    console.error('Logout fail:', e);
  }
  updateCloudUI(null);
}

/* === Initiering === */
document.addEventListener('DOMContentLoaded', async () => {
  // F√∂rs√∂k packa upp inb√§ddad data (men krascha inte sidan om det blir fel)
  try {
    if (typeof unpackEmbeddedData === 'function') {
      await unpackEmbeddedData();
    }
  } catch (e) {
    console.error('unpackEmbeddedData fail:', e);
  }

  try {
    uiSync();
  } catch (e) {
    console.error('uiSync fail:', e);
  }

  const on = (sel, evt, handler) => {
    const el = $(sel);
    if (el) el.addEventListener(evt, handler);
  };

  // Elevkort & spelstart
  on('#saveStudent', 'click', () => {
    const s = load();
    const nameEl  = $('#studentName');
    const classEl = $('#studentClass');
    s.student.name  = (nameEl?.value  || '').trim();
    s.student.klass = (classEl?.value || '').trim();
    if (save(s)) uiSync(); else notify('Kunde inte spara elev.');
  });

  on('#start-levelE', 'click', () => startMode('levelE'));
  on('#start-levelC', 'click', () => startMode('levelC'));
  on('#start-levelA', 'click', () => startMode('levelA'));

  on('#btnSubmit',       'click', finish);
  on('#btnCancel',       'click', hidePlayUI);
  on('#btnSubmitBottom', 'click', finish);
  on('#btnCancelBottom', 'click', hidePlayUI);

  on('#btnBack', 'click', () => {
    const res = $('#result');
    const stu = $('#studentCard');
    if (res) res.classList.add('hidden');
    if (stu) stu.classList.remove('hidden');
    uiSync();
  });

  // Resultatexport
  on('#prepareSubmitBtn', 'click', () => {
    if (!submissionData) return;
    const txt  = $('#resultJson');
    const exp  = $('#exportSection');
    const norm = $('#resultActionsNormal');
    if (txt)  txt.value = JSON.stringify(submissionData, null, 2);
    if (exp)  exp.classList.remove('hidden');
    if (norm) norm.classList.add('hidden');
  });

  on('#copyJsonBtn', 'click', () => {
    const txt = $('#resultJson');
    if (!txt) return;
    navigator.clipboard.writeText(txt.value)
      .then(() => notify('Resultat kopierat!'))
      .catch(() => notify('Kunde inte kopiera.'));
  });

  on('#emailJsonBtn', 'click', () => {
    const teacherEmail = load().teacherEmail;
    if (!teacherEmail) {
      notify('L√§rarens e-post √§r inte inst√§lld.');
      return;
    }
    const subject = `Resultat F√•ngvaktaren: ${submissionData?.studentName || '?'} (${submissionData?.levelCompleted || '?'})`;
    const body    = `Resultatdata:\n\n${$('#resultJson')?.value || ''}\n\n---\nKlistra in detta i l√§rarens F√•ngvaktaren-verktyg under Inst√§llningar -> Importera Elevresultat.`;
    window.location.href =
      `mailto:${teacherEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  });

  on('#backToOverviewBtnExport', 'click', () => {
    const exp  = $('#exportSection');
    const norm = $('#resultActionsNormal');
    if (exp)  exp.classList.add('hidden');
    if (norm) norm.classList.remove('hidden');
  });

  // L√§rarl√§ge
  on('#btnTeacher', 'click', () => {
    postLoginAction = 'openAdmin';
    const gate = $('#gate');
    if (gate) gate.classList.add('show');
  });

  on('#btnDownloadGame', 'click', () => {
    postLoginAction = 'downloadGame';
    const gate = $('#gate');
    if (gate) gate.classList.add('show');
  });

  on('#gateOk', 'click', checkGate);
  on('#gateCancel', 'click', () => {
    postLoginAction = null;
    const gate = $('#gate');
    if (gate) gate.classList.remove('show');
  });

  on('#closeModal', 'click', () => {
    const modal = $('#modal');
    if (modal) modal.classList.remove('show');
  });

  // Admin-knappar
  on('#savePass', 'click', () => {
    const npEl = $('#newPass');
    const np = (npEl?.value || '');
    if (np.length >= 4) {
      const s = load();
      s.teacherPassword = np;
      if (save(s)) {
        notify('L√∂senord sparat.');
        openAdmin();
      }
    } else {
      notify('L√∂senordet m√•ste vara minst 4 tecken.');
    }
  });

  on('#saveEmail', 'click', () => {
    const emEl = $('#teacherEmail');
    const em = (emEl?.value || '').trim();
    const s = load();
    s.teacherEmail = em;
    if (save(s)) notify('E-post sparad.');
  });

  on('#saveThresholds', 'click', () => {
    const s = load();
    s.thresholds.levelE = clampNum($('#thr-levelE')?.value, 0, 100, DEFAULT.thresholds.levelE);
    s.thresholds.levelC = clampNum($('#thr-levelC')?.value, 0, 100, DEFAULT.thresholds.levelC);
    s.thresholds.levelA = clampNum($('#thr-levelA')?.value, 0, 100, DEFAULT.thresholds.levelA);
    if (save(s)) {
      notify('Gr√§nser sparade.');
      openAdmin();
      uiSync();
    }
  });

  on('#addObjectiveBtn', 'click', () => {
    const s = load();
    s.objectives.push({ name: '', criteria: ['', '', '', '', ''] });
    renderObjectives();
  });

  const objContainer = $('#objectivesListContainer');
  if (objContainer) {
    objContainer.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-objective-btn')) {
        const idx = parseInt(e.target.dataset.idx, 10);
        if (!isNaN(idx) && confirm(`Ta bort Delm√•l ${idx + 1}?`)) {
          const s = load();
          s.objectives.splice(idx, 1);
          renderObjectives();
        }
      }
    });
  }

  on('#saveObjectives', 'click', () => {
    const s = load();
    const newObjectives = [];
    $$('#objectivesListContainer .objective-group').forEach((group) => {
      const name = group.querySelector('.obj-name')?.value.trim() || '';
      const criteria = [
        group.querySelector('.obj-crit0')?.value.trim() || '',
        group.querySelector('.obj-crit1')?.value.trim() || '',
        group.querySelector('.obj-crit2')?.value.trim() || '',
        group.querySelector('.obj-crit3')?.value.trim() || '',
        group.querySelector('.obj-crit4')?.value.trim() || ''
      ];
      newObjectives.push({ name, criteria });
    });
    s.objectives = newObjectives;
    if (save(s)) {
      notify('Delm√•l sparade.');
      renderObjectives();
      updateObjectiveSelects();
    }
  });

  on('#btnImportResult', 'click', importStudentResult);
  on('#btnShrinkAll',   'click', shrinkAllImages);
  on('#btnPurgeImg',    'click', purgeImages);
  on('#btnResetTeacher','click', resetStudentData);
  on('#btnFullReset',   'click', fullReset);

  on('#btnImportMCQE', 'click', () => importMCQ('E'));
  on('#btnImportMCQC', 'click', () => importMCQ('C'));
  on('#btnImportMCQA', 'click', () => importMCQ('A'));

  on('#btnAddMcqOpt', 'click', () => addOptionRow('#mcqOptList'));
  const mcqOptList = $('#mcqOptList');
  if (mcqOptList) mcqOptList.addEventListener('click', handleRemoveOption);
  on('#btnAddMCQ', 'click', addManualMCQ);

  on('#btnAddOpt', 'click', () => addOptionRow('#optList'));
  const optList = $('#optList');
  if (optList) optList.addEventListener('click', handleRemoveOption);

  const qImgFile = $('#qImgFile');
  if (qImgFile) qImgFile.addEventListener('change', previewImage);
  on('#btnAddImageMCQ', 'click', addManualImageMCQ);

  on('#btnAddDragPair', 'click', addDragPairRow);
  const dragPairList = $('#dragPairList');
  if (dragPairList) dragPairList.addEventListener('click', handleRemoveDragPair);
  on('#btnAddDragDrop', 'click', addManualDragDrop);

  ['#mcqListE', '#mcqListC', '#mcqListA', '#imgList', '#dragList'].forEach(sel => {
    const list = $(sel);
    if (list) list.addEventListener('click', handleRemoveItem);
  });

  try {
    let mcqLinks   = { links: [] };
    let imageLinks = { links: [] };
    let dragLinks  = { links: [] };

    setupObjectiveDropdowns('#mcqObjectiveSelect',   '#mcqCriteriaSelect',   '#mcqAddLinkBtn',   '#mcqAddedLinks',   mcqLinks);
    setupObjectiveDropdowns('#imageObjectiveSelect', '#imageCriteriaSelect', '#imageAddLinkBtn', '#imageAddedLinks', imageLinks);
    setupObjectiveDropdowns('#dragObjectiveSelect',  '#dragCriteriaSelect',  '#dragAddLinkBtn',  '#dragAddedLinks',  dragLinks);
    window.tempBuilderLinks = { mcq: mcqLinks, image: imageLinks, drag: dragLinks };

    let mcqImportLinksE = { links: [] };
    let mcqImportLinksC = { links: [] };
    let mcqImportLinksA = { links: [] };

    setupObjectiveDropdowns('#mcqImportObjectiveSelectE', '#mcqImportCriteriaSelectE', '#mcqImportAddLinkBtnE', '#mcqImportAddedLinksE', mcqImportLinksE);
    setupObjectiveDropdowns('#mcqImportObjectiveSelectC', '#mcqImportCriteriaSelectC', '#mcqImportAddLinkBtnC', '#mcqImportAddedLinksC', mcqImportLinksC);
    setupObjectiveDropdowns('#mcqImportObjectiveSelectA', '#mcqImportCriteriaSelectA', '#mcqImportAddLinkBtnA', '#mcqImportAddedLinksA', mcqImportLinksA);
    window.tempImportLinks = { E: mcqImportLinksE, C: mcqImportLinksC, A: mcqImportLinksA };
  } catch (e) {
    console.error('setupObjectiveDropdowns fail:', e);
  }

  try {
    updateStorageInfo();
  } catch (e) {
    console.error('updateStorageInfo fail:', e);
  }
});

// === G√∂r rutor i Inst√§llningar (password, e-post, gr√§nser, delm√•l, import, lagring) ===
(function groupSettingsSections() {
  const root = document.getElementById('tab-settings');
  if (!root) return;

  const parts = [];
  let current = [];

  [...root.children].forEach(node => {
    if (node.classList && node.classList.contains('hr')) {
      if (current.length) {
        parts.push(current);
        current = [];
      }
    } else {
      current.push(node);
    }
  });
  if (current.length) parts.push(current);

  parts.forEach(nodes => {
    const card = document.createElement('div');
    card.className = 'settings-card';
    nodes[0].before(card);
    nodes.forEach(n => card.appendChild(n));
  });

  const importLabel = root.querySelector('label[for="importData"]');
  if (importLabel) importLabel.closest('.row')?.classList.add('import-wrap');
})();
</script>
<!-- slut DEL 3E -->














<!-- start DEL 3F: Firebase init f√∂r F√•ngvaktaren -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // Din Firebase-konfiguration
  const firebaseConfig = {
    apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
    authDomain: "fangvaktaren-904db.firebaseapp.com",
    projectId: "fangvaktaren-904db",
    storageBucket: "fangvaktaren-904db.firebasestorage.app",
    messagingSenderId: "105301219768",
    appId: "1:105301219768:web:66b131fba86a541b78174d",
    measurementId: "G-NXL9GSFZ77"
  };

  // Initiera Firebase
  const app      = initializeApp(firebaseConfig);
  const auth     = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db       = getFirestore(app);

  // G√∂r Firebase tillg√§ngligt f√∂r spelets vanliga script (icke-module)
  window.fvFirebase = {
    auth,
    provider,
    signInWithPopup,
    onAuthStateChanged,
    signOut,
    db,
    doc,
    getDoc,
    setDoc
  };

  // Koppla knapparna till moln-funktionerna
  const btnCloudLogin  = document.getElementById('btnCloudLogin');
  const btnCloudLogout = document.getElementById('btnCloudLogout');
  const btnCloudSave   = document.getElementById('btnCloudSave');
  const btnCloudLoad   = document.getElementById('btnCloudLoad');

  if (btnCloudLogin) {
    btnCloudLogin.addEventListener('click', () => {
      ensureTeacherLogin();
    });
  }
  if (btnCloudLogout) {
    btnCloudLogout.addEventListener('click', () => {
      cloudLogout();
    });
  }
  if (btnCloudSave) {
    btnCloudSave.addEventListener('click', () => {
      cloudSaveGame();
    });
  }
  if (btnCloudLoad) {
    btnCloudLoad.addEventListener('click', () => {
      cloudLoadGame();
    });
  }

  // H√•ll molnstatus uppdaterad
  if (typeof updateCloudUI === 'function') {
    onAuthStateChanged(auth, (user) => {
      updateCloudUI(user);
    });
    updateCloudUI(auth.currentUser || null);
  }
</script>
<!-- slut DEL 3F -->











<!-- start SEKTION 4: Firebase & moln-banker (borttagen) -->
<!-- 
  OBS:
  Den h√§r sektionen √§r medvetet tom.
  All Firebase- och molnlogik hanteras nu i DEL 3F: Firebase init f√∂r F√•ngvaktaren.
  H√§r ska INGA <script>-taggar eller Firebase-variabler finnas, f√∂r att undvika dubletter.
-->
<!-- slut SEKTION 4: Firebase & moln-banker (borttagen) -->





<!-- start SEKTION 5: GOOGLE-INLOGGNING & UPPLADDNING (L√ÑRARE) -->
<div id="teacher-google-block" class="card settings-block" style="display:none;">
  <h2>Google-inloggning & uppladdning (l√§rare)</h2>

  <div class="row auth-row">
    <div class="col">
      <div class="label">Status</div>
      <p id="googleStatus" class="hint">‚òÅÔ∏è Inte inloggad</p>
      <p class="hint">
        Sparar och h√§mtar nuvarande fr√•gebank kopplat till ditt Google-konto.
      </p>
    </div>
    <div class="col actions">
      <button id="googleLoginBtn" class="btn">Logga in med Google</button>
      <button id="googleLogoutBtn" class="btn secondary" style="display:none;">Logga ut</button>
    </div>
  </div>

  <div class="hr"></div>

  <div class="row">
    <div class="col actions">
      <button id="saveBankBtn" class="btn">Ladda upp fr√•gebank</button>
      <button id="loadBankBtn" class="btn secondary">H√§mta fr√•gebank</button>
    </div>
  </div>

  <p class="hint">
    Logga in med Google f√∂r att kunna ladda upp fr√•gebanken.
  </p>
</div>
<!-- slut SEKTION 5: GOOGLE-INLOGGNING & UPPLADDNING (L√ÑRARE) -->

<!-- start SEKTION 6: Google-inloggning & fr√•gebank i molnet (l√§rare) -->
<script type="module">
  import {
    initializeApp,
    getApps
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // üîê Egen, namngiven Firebase-app f√∂r fr√•gebanken (krockar inte med annan kod)
  const FANG_FIREBASE_CONFIG = {
    apiKey: "DIN_API_KEY_H√ÑR",
    authDomain: "DITT_PROJEKT.firebaseapp.com",
    projectId: "DITT_PROJEKT",
    storageBucket: "DITT_PROJEKT.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef123456"
  };

  function getOrCreateFangApp() {
    const existing = getApps().find(a => a.name === "fangvaktaren-google");
    if (existing) return existing;
    return initializeApp(FANG_FIREBASE_CONFIG, "fangvaktaren-google");
  }

  const FANG_APP = getOrCreateFangApp();
  const FANG_AUTH = getAuth(FANG_APP);
  const FANG_DB = getFirestore(FANG_APP);
  const FANG_PROVIDER = new GoogleAuthProvider();

  // Element fr√•n kortet
  const loginBtn = document.getElementById("googleLoginBtn");
  const logoutBtn = document.getElementById("googleLogoutBtn");
  const uploadBtn = document.getElementById("saveBankBtn");
  const downloadBtn = document.getElementById("loadBankBtn");
  const statusText = document.getElementById("googleStatus");

  function setLoggedOutUI() {
    if (statusText) statusText.textContent = "‚òÅÔ∏è Inte inloggad";
    if (loginBtn) loginBtn.disabled = false;
    if (logoutBtn) {
      logoutBtn.disabled = true;
      logoutBtn.style.display = "none";
    }
    if (uploadBtn) uploadBtn.disabled = true;
    if (downloadBtn) downloadBtn.disabled = true;
  }

  function setLoggedInUI(user) {
    if (statusText) statusText.textContent = `‚òÅÔ∏è Inloggad som ${user.email}`;
    if (loginBtn) loginBtn.disabled = true;
    if (logoutBtn) {
      logoutBtn.disabled = false;
      logoutBtn.style.display = "inline-flex";
    }
    if (uploadBtn) uploadBtn.disabled = false;
    if (downloadBtn) downloadBtn.disabled = false;
  }

  // L√§s aktuell fr√•gebank fr√•n spelet
  function getCurrentQuestionBank() {
    try {
      if (typeof window.getCurrentQuestionBank === "function") {
        return window.getCurrentQuestionBank();
      }
      if (window.currentQuestionBank) {
        return window.currentQuestionBank;
      }
    } catch (e) {
      console.warn("Kunde inte l√§sa fr√•gebanken:", e);
    }
    return null;
  }

  // Applicera h√§mtad bank i spelet
  function applyDownloadedBank(bank) {
    try {
      if (typeof window.applyDownloadedBank === "function") {
        window.applyDownloadedBank(bank);
        return;
      }
      window.currentQuestionBank = bank;
      console.log("H√§mtad fr√•gebank (window.currentQuestionBank):", bank);
    } catch (e) {
      console.warn("Kunde inte applicera h√§mtad fr√•gebank:", e);
    }
  }

  async function uploadQuestionBank(user) {
    const bank = getCurrentQuestionBank();
    if (!bank) {
      alert("Ingen fr√•gebank att ladda upp.");
      return;
    }
    const ref = doc(FANG_DB, "fangvaktaren_banker", user.uid);
    await setDoc(ref, { bank, updatedAt: Date.now() });
    alert("Fr√•gebank sparad i molnet.");
  }

  async function downloadQuestionBank(user) {
    const ref = doc(FANG_DB, "fangvaktaren_banker", user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      alert("Ingen sparad fr√•gebank hittades i molnet.");
      return;
    }
    const data = snap.data();
    if (data && data.bank) {
      applyDownloadedBank(data.bank);
      alert("Fr√•gebank h√§mtad fr√•n molnet.");
    } else {
      alert("Det fanns ingen giltig fr√•gebank sparad.");
    }
  }

  if (loginBtn) {
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(FANG_AUTH, FANG_PROVIDER);
      } catch (err) {
        console.error("Google login failed:", err);
        alert("Det gick inte att logga in med Google just nu.");
      }
    });
  }

  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(FANG_AUTH);
      } catch (err) {
        console.error("Logout failed:", err);
      }
    });
  }

  if (uploadBtn) {
    uploadBtn.addEventListener("click", async () => {
      const user = FANG_AUTH.currentUser;
      if (!user) return;
      try {
        await uploadQuestionBank(user);
      } catch (err) {
        console.error("Kunde inte ladda upp fr√•gebanken:", err);
        alert("Det gick inte att ladda upp fr√•gebanken.");
      }
    });
  }

  if (downloadBtn) {
    downloadBtn.addEventListener("click", async () => {
      const user = FANG_AUTH.currentUser;
      if (!user) return;
      try {
        await downloadQuestionBank(user);
      } catch (err) {
        console.error("Kunde inte h√§mta fr√•gebanken:", err);
        alert("Det gick inte att h√§mta fr√•gebanken.");
      }
    });
  }

  onAuthStateChanged(FANG_AUTH, (user) => {
    if (user) {
      console.log("Login OK", user.email);
      setLoggedInUI(user);
    } else {
      setLoggedOutUI();
    }
  });

  // Init-l√§ge
  setLoggedOutUI();
</script>
<!-- slut SEKTION 6: Google-inloggning & fr√•gebank i molnet (l√§rare) -->

<!-- start SEKTION 7: AVSLUTNING -->
</body>
</html>
<!-- slut SEKTION 7: AVSLUTNING -->
