<!-- start SEKTION 1: HEAD & STIL -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>F√•ngvaktaren ‚Äì Progressionsspel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --accent-e:#b45309;
      --accent-c:#2563eb;
      --accent-a:#7c3aed;
      --accent-danger:#ef4444;
      --accent-info:#38bdf8;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --chip:#020617;
    }

    *{box-sizing:border-box;}

    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#020617 0,#020617 40%,#000 100%);
      color:var(--text);
    }

    body{
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:960px;
      margin:0 auto;
      min-height:100vh;
      padding:12px 12px 32px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(15,23,42,.85));
      border:1px solid #1f2937;
      box-shadow:0 0 40px rgba(15,23,42,.9);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(10px);
    }

    .header-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .title-block h1{
      margin:0;
      font-size:1.2rem;
      letter-spacing:.03em;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:999px;
      background:radial-gradient(circle,var(--accent-e),#111827);
      color:#fff;
      font-weight:700;
      font-size:.9rem;
      box-shadow:0 0 12px rgba(180,83,9,.8);
    }

    /* ---------- Buttons ---------- */

    .btn{
      --btn-bg:#111827;
      --btn-border:rgba(75,85,99,.9);
      border-radius:999px;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      padding:6px 12px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
      transition:
        background-color .15s ease,
        border-color .15s ease,
        box-shadow .18s ease,
        transform .12s ease,
        opacity .15s ease;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 0 0 rgba(59,130,246,0);
    }

    .btn-sm{
      padding:5px 10px;
      font-size:.8rem;
    }

    .btn-primary{
      --btn-bg:linear-gradient(135deg,var(--accent-e),var(--accent-c));
      --btn-border:rgba(96,165,250,.9);
      color:#f9fafb;
      box-shadow:
        0 0 0 1px rgba(148,163,184,.4),
        0 0 18px rgba(56,189,248,.45);
    }

    .btn-danger{
      --btn-bg:rgba(127,29,29,.95);
      --btn-border:rgba(239,68,68,.9);
      box-shadow:
        0 0 0 1px rgba(248,113,113,.5),
        0 0 14px rgba(248,113,113,.4);
    }

    .btn-secondary{
      --btn-bg:#020617;
      --btn-border:rgba(75,85,99,.8);
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(148,163,184,.6),
        0 0 24px rgba(59,130,246,.55);
      opacity:.97;
    }

    .btn:active{
      transform:translateY(0);
      box-shadow:
        0 0 0 1px rgba(107,114,128,.8),
        0 0 12px rgba(37,99,235,.45);
      opacity:.92;
    }

    .btn:disabled,
    .btn[disabled]{
      opacity:.45;
      cursor:default;
      box-shadow:
        0 0 0 1px rgba(31,41,55,1),
        0 0 0 rgba(0,0,0,0);
      transform:none;
    }

    /* --------- NYTT: Mejlad-l√§nk i roster (g√∂r knappen gr√∂n n√§r JS s√§tter class "sent") --------- */
    .btn.sent,
    .sent.btn,
    .sent{
      background:linear-gradient(135deg,#16a34a,#22c55e) !important;
      border-color:rgba(34,197,94,1) !important;
      color:#ecfdf5 !important;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 18px rgba(22,163,74,.7) !important;
    }

    .btn.sent:hover,
    .sent.btn:hover,
    .sent:hover{
      background:linear-gradient(135deg,#16a34a,#22c55e) !important;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 26px rgba(34,197,94,.9) !important;
      transform:translateY(-1px);
      opacity:1 !important;
    }

    .btn.sent:active,
    .sent.btn:active,
    .sent:active{
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 14px rgba(34,197,94,.8) !important;
      transform:translateY(0);
    }
    /* --------- SLUT NYTT --------- */

    /* Spara elev ‚Äì tydlig gr√∂n, fyllig knapp */
    #btnSaveStudent{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      border-color:rgba(34,197,94,1);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 20px rgba(34,197,94,.75);
    }

    #btnSaveStudent:hover{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 26px rgba(34,197,94,.9);
      transform:translateY(-1px);
    }

    #btnSaveStudent:active{
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 14px rgba(34,197,94,.8);
      transform:translateY(0);
    }

    #btnSaveStudent:disabled{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      opacity:.45;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 0 rgba(0,0,0,0);
    }

    /* L√§rarl√§ge ‚Äì m√∂rk bakgrund, gr√∂n kontur (outline-knapp) */
    #btnTeacherMode{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherMode:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherMode:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* L√∂senords-popup: ‚ÄúForts√§tt‚Äù ‚Äì samma gr√∂na kontur som l√§rarl√§ge */
    #btnTeacherConfirm{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherConfirm:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherConfirm:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* Spara niv√•gr√§nser ‚Äì gr√∂n kontur, samma stil */
    #btnSaveThresholds{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnSaveThresholds:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnSaveThresholds:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* ---------- Layout helpers ---------- */

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1 1 120px;
      min-width:0;
    }

    label{
      font-size:.7rem;
      color:var(--muted);
    }

    .small-label{
      font-size:.7rem;
      color:var(--muted);
    }

    .input,
    .input-number{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:.8rem;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }

    .input-number{
      appearance:textfield;
      -moz-appearance:textfield;
    }

    .input-number::-webkit-outer-spin-button,
    .input-number::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    .input:focus,
    .input-number:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
      background:#020617;
    }

    .mini{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.4;
    }

    .hidden{
      display:none !important;
    }

    /* ---------- Elevkort ---------- */

    .student-card{
      background:radial-gradient(circle at top left,#020617,#020617 55%,#000 100%);
      border-radius:16px;
      padding:12px 12px 14px;
      border:1px solid rgba(31,41,55,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .student-main-row{
      align-items:flex-end;
    }

    .student-save-field{
      max-width:180px;
    }

    .student-status-row{
      margin-top:2px;
    }

    .student-saved-label{
      font-size:.75rem;
      color:var(--muted);
    }

    .student-stats-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
    }

    .score-box{
      flex:1 1 160px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 55%,#000 100%);
      display:flex;
      flex-direction:column;
      gap:2px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 20px rgba(56,189,248,.4),
        0 12px 28px rgba(15,23,42,.9);
    }

    .score-label{
      font-size:.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .score-value{
      font-size:1rem;
      font-weight:600;
    }

    /* ---------- Niv√•-kort ---------- */

    .levels-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }

    .level-card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.9);
    }

    .level-card.locked{
      opacity:.7;
      filter:saturate(.7);
    }

    .level-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .level-title span:first-child{
      font-weight:600;
      font-size:.9rem;
    }

    .level-title small{
      display:block;
      font-size:.7rem;
      color:var(--muted);
    }

    .level-body{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:.78rem;
    }

    .level-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-top:4px;
    }

    .badge{
      border-radius:999px;
      padding:2px 8px;
      font-size:.7rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
    }

    .badge-lock{
      color:#fbbf24;
      border-color:rgba(245,158,11,.7);
      box-shadow:0 0 12px rgba(245,158,11,.35);
    }

    .badge-ok{
      color:#4ade80;
      border-color:rgba(74,222,128,.9);
      box-shadow:0 0 16px rgba(22,163,74,.65);
    }

    .badge-pass{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 18px rgba(22,163,74,.7);
    }

    .badge-fail{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#991b1b,#ef4444);
      color:#fee2e2;
      box-shadow:
        0 0 0 1px rgba(127,29,29,1),
        0 0 18px rgba(248,113,113,.7);
    }

    /* ---------- Spelpanel / Resultat ---------- */

    .play-panel,
    .result-panel{
      margin-top:8px;
      padding:10px 10px 12px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
    }

    .play-header,
    .result-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .questions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:4px;
    }

    .question{
      padding:8px 9px;
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top left,#020617,#020617 60%,#020617 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 26px rgba(15,23,42,.9);
      font-size:.85rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .q-text{
      font-size:.85rem;
      margin-top:2px;
    }

    .options-list{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:2px;
    }

    .option-label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
      padding:4px 6px;
      border-radius:999px;
      background:#020617;
      border:1px solid rgba(31,41,55,1);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,transform .1s ease;
    }

    .option-label input{
      accent-color:var(--accent-c);
    }

    .option-label:hover{
      background:#020617;
      border-color:rgba(59,130,246,.7);
      box-shadow:
        0 0 0 1px rgba(59,130,246,.9),
        0 0 16px rgba(37,99,235,.6);
      transform:translateY(-1px);
    }

    .play-footer{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:.75rem;
    }

    .play-actions{
      display:flex;
      gap:6px;
    }

    .score{
      font-size:1.6rem;
      font-weight:700;
    }

    .score span{
      font-size:.8rem;
      font-weight:400;
      margin-left:4px;
      color:var(--muted);
    }

    .result-meta{
      font-size:.78rem;
      color:var(--muted);
      margin-top:2px;
    }

    .result-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ---------- Modal & gate ---------- */

    .gate-backdrop,
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
      backdrop-filter:blur(10px);
    }

    .gate-box{
      width:100%;
      max-width:320px;
      padding:14px 14px 16px;
      border-radius:16px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:.85rem;
    }

    .gate-actions{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }

    .modal{
      width:100%;
      max-width:980px;
      max-height:90vh;
      padding:12px 12px 14px;
      border-radius:18px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:4px;
    }

    .modal-body{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding-right:2px;
    }

    /* ---------- Flikar ---------- */

    .tab-nav{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
    }

    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(55,65,81,1);
      padding:4px 9px;
      font-size:.75rem;
      background:#020617;
      color:var(--muted);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,color .15s ease;
    }

    .tab-btn.active{
      color:#e5e7eb;
      border-color:rgba(96,165,250,1);
      background:linear-gradient(135deg,#0369a1,#4f46e5);
      box-shadow:
        0 0 0 1px rgba(37,99,235,1),
        0 0 20px rgba(56,189,248,.7);
    }

    .tab-panel{
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 16px 34px rgba(15,23,42,.95);
    }

    /* ---------- Cards & grids ---------- */

    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px 10px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.95);
      font-size:.82rem;
    }

    .card-full-width{
      grid-column:1/-1;
    }

    .card-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }

    .questions-editor{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .goals-list,
    .question-list{
      list-style:none;
      padding:0;
      margin:4px 0 0;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.8rem;
    }

    .question-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      flex-direction:column;
      gap:4px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    /* St√∂d f√∂r "list-item" (anv√§nds i SEKTION 3 f√∂r listor) */
    .list-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    .list-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1 1 auto;
    }

    .q-meta{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.35;
    }

    .question-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:2px;
    }

    .img-preview-box{
      border-radius:10px;
      border:1px dashed rgba(55,65,81,1);
      padding:6px;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .img-preview-box img{
      max-width:100%;
      border-radius:8px;
    }

    .img-thumb{
      width:64px;
      height:44px;
      border-radius:8px;
      border:1px solid rgba(31,41,55,1);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#020617;
      margin-right:6px;
    }

    .img-thumb img{
      max-width:100%;
      max-height:100%;
      object-fit:cover;
    }

    .question-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .chip{
      border-radius:999px;
      padding:3px 8px;
      font-size:.75rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 6px 14px rgba(15,23,42,.85);
    }

    /* Elevprogression ‚Äì rutorna staplas p√• h√∂jden (en kolumn) */
    .progress-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }

    .progress-box{
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 24px rgba(15,23,42,.9);
      font-size:.8rem;
    }

    .mini-card{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      padding:6px 7px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .mini-title{
      font-size:.82rem;
      font-weight:600;
    }

    /* ---------- GDPR: Modal f√∂r elevlista/tokens (endast id-bundet) ---------- */

    #bankRosterModal,
    #rosterViewerModal{
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(15,23,42,.78);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      backdrop-filter:blur(10px);
    }

    #bankRosterModal.hidden,
    #rosterViewerModal.hidden{
      display:none !important;
    }

    #bankRosterModal .card,
    #rosterViewerModal .card{
      width:min(980px,100%);
      max-height:88vh;
      overflow:auto;
      padding:12px 12px 14px;
      border-radius:18px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
    }

    #bankRosterModal .card h3,
    #rosterViewerModal .card h3{
      margin:0;
      font-size:.95rem;
      letter-spacing:.01em;
    }

    #bankRosterModal .input,
    #bankRosterModal .textarea,
    #rosterViewerModal .input,
    #rosterViewerModal .textarea{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      color:var(--text);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1);
    }

    #bankRosterModal .textarea,
    #rosterViewerModal .textarea{
      width:100%;
      padding:8px 10px;
      min-height:90px;
      resize:vertical;
      font-size:.8rem;
      outline:none;
    }

    #bankRosterModal .textarea:focus,
    #rosterViewerModal .textarea:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
    }

    /* Roster-lista: b√§ttre radlayout p√• sm√• sk√§rmar */
    #bankRosterModal #rosterRows .card-row{
      align-items:center;
      padding:6px 0;
      border-top:1px solid rgba(31,41,55,.7);
    }

    #bankRosterModal #rosterRows .card-row:first-child{
      border-top:none;
    }

    #bankRosterModal #rosterRows .btn.btn-danger{
      border-radius:12px;
    }

    @media (max-width:640px){
      #bankRosterModal .card,
      #rosterViewerModal .card{
        max-height:92vh;
        padding:10px;
      }
      #bankRosterModal #rosterRows .card-row > *{
        flex:1 1 100% !important;
      }
      #bankRosterModal #rosterRows .card-row div[style*="flex:0 0 160px"]{
        flex:1 1 100% !important;
        justify-content:flex-start !important;
      }
    }

    /* ---------- Responsivitet ---------- */

    @media (max-width:640px){
      .app{
        padding:8px 8px 24px;
      }
      .app-header{
        padding:8px 9px;
      }
      .levels-grid{
        grid-template-columns:1fr;
      }
      .play-header,
      .result-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .play-footer{
        flex-direction:column;
        align-items:flex-start;
      }
      .modal{
        padding:10px;
      }
    }

    /* ---------- F√§rger f√∂r niv√•kort (E / C / A) ---------- */

    #card-levelE{
      background:radial-gradient(circle at top,#ea580c,#b45309 55%,#020617 100%);
      border-color:rgba(234,88,12,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(234,88,12,.9);
    }

    #card-levelC{
      background:radial-gradient(circle at top,#1d4ed8,#1e40af 55%,#020617 100%);
      border-color:rgba(37,99,235,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(37,99,235,.9);
    }

    #card-levelA{
      background:radial-gradient(circle at top,#7c3aed,#6d28d9 55%,#020617 100%);
      border-color:rgba(124,58,237,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(124,58,237,.9);
    }
  </style>

  <!-- Firebase CDN (v8 - namespaced) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

</head>
<!-- slut SEKTION 1: HEAD & STIL -->










<!-- start SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->
<!-- √ÑNDRING: Lade till ett stabilt host-element med id="rosterTabs" i Elevprogression (Elever aktiv bank) s√• SEKTION 3 alltid kan rendera elevknappar d√§r. (ca 18 rader) -->
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <h1><span class="logo">F</span>F√•ngvaktaren</h1>
      </div>
      <button id="btnTeacherMode" class="btn btn-sm btn-primary">üîë L√§rarl√§ge</button>
    </header>

    <!-- Elevkort / namn, klass, po√§ng, highscore -->
    <section id="studentCard" class="student-card">
      <div class="row student-main-row">
        <div class="field">
          <label for="studentName">Namn</label>
          <input id="studentName" class="input" placeholder="Elevens namn..." autocomplete="off" />
        </div>
        <div class="field">
          <label for="studentClass">Klass</label>
          <input id="studentClass" class="input" placeholder="Klass..." autocomplete="off" />
        </div>
        <div class="field student-save-field">
          <label>&nbsp;</label>
          <button id="btnSaveStudent" class="btn btn-sm btn-primary" style="width:100%;">üíæ Spara elev</button>
        </div>
      </div>

      <div class="student-status-row">
        <span id="studentSaved" class="student-saved-label">Ej sparad elev</span>
      </div>

      <div class="student-stats-row">
        <div class="score-box glow-box">
          <div class="score-label">Po√§ng</div>
          <div class="score-value" id="studentPointsValue">0 p</div>
        </div>
        <div class="score-box glow-box">
          <div class="score-label">Highscore</div>
          <div class="score-value" id="highscoreSummary">
            Ingen highscore √§nnu.
          </div>
        </div>
      </div>
    </section>

    <!-- Niv√•kort -->
    <section class="levels-grid">
      <article id="card-levelE" class="level-card level-e locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 1</span>
            <small>Grundniv√• ‚Äì E</small>
          </div>
          <span id="badge-levelE" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelE">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelE">70</span>%</span>
          <span class="mini">L√•ses upp n√§r eleven sparat namn & klass.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• E-niv√•.</div>
          <button id="start-levelE" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 1</button>
        </div>
      </article>

      <article id="card-levelC" class="level-card level-c locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 2</span>
            <small>Mellanniv√• ‚Äì C</small>
          </div>
          <span id="badge-levelC" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelC">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelC">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 1 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• C-niv√•.</div>
          <button id="start-levelC" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 2</button>
        </div>
      </article>

      <article id="card-levelA" class="level-card level-a locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 3</span>
            <small>Avancerad ‚Äì A</small>
          </div>
          <span id="badge-levelA" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelA">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelA">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 2 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• A-niv√•.</div>
          <button id="start-levelA" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 3</button>
        </div>
      </article>
    </section>

    <!-- Spelpanel -->
    <section id="play" class="play-panel hidden">
      <header class="play-header">
        <div>
          <h2 id="play-title">Aktiv niv√•</h2>
          <small id="whoPlays">Ingen elev vald.</small>
        </div>
        <button id="btnCancel" class="btn btn-sm">‚¨ÖÔ∏è Avsluta utan att l√§mna in</button>
      </header>
      <div id="questions" class="questions">
        <div class="question mini">V√§lj en niv√• f√∂r att b√∂rja.</div>
      </div>
      <footer class="play-footer">
        <div class="mini">
          Svar registreras n√§r du klickar i alternativen eller sl√§pper kort i r√§tt ruta.
        </div>
        <div class="play-actions">
          <button id="btnSpeakQuestion" class="btn btn-sm">üîä L√§s upp fr√•gan</button>
          <button id="btnFinish" class="btn btn-sm btn-primary">‚úÖ L√§mna in niv√•</button>
        </div>
      </footer>
    </section>

    <!-- Resultatpanel -->
    <section id="result" class="result-panel hidden">
      <header class="result-header">
        <div>
          <div class="score" id="scoreText">0%<span> resultat</span></div>
          <div id="scoreDetail" class="result-meta">0/0 po√§ng</div>
          <div class="result-meta">
            Elev: <span id="resName">-</span> (<span id="resClass">-</span>)
          </div>
        </div>
        <div>
          <div id="passBadge" class="badge-fail">Resultat</div>
          <div id="unlockText" class="result-meta"></div>
        </div>
      </header>

      <div class="result-actions" id="resultActionsNormal">
        <button id="btnBack" class="btn btn-sm">‚¨ÖÔ∏è Tillbaka till niv√•er</button>
        <button id="btnSubmitGame" class="btn btn-sm btn-primary">‚úâÔ∏è L√§mna in spel f√∂r po√§ng</button>
      </div>
    </section>
  </div>

  <!-- Embedded grundbank (kan vara tom eller kort) -->
  <script id="embedded-data" type="application/json">
  {
    "bank": {
      "mcq": [
        {
          "level": "E",
          "type": "mcq",
          "q": "Vad √§r viktigast f√∂rst n√§r du kommer till k√∂ket?",
          "options": ["Ta p√• f√∂rkl√§de", "Tv√§tta h√§nderna", "S√§tta p√• ugnen", "Smaka p√• maten"],
          "answer": 1
        },
        {
          "level": "C",
          "type": "mcq",
          "q": "En g√§st klagar p√• kall mat. Vad √§r ett bra f√∂rsta steg?",
          "options": ["Ignorera g√§sten", "Skylla p√• k√∂ket", "Be om urs√§kt och erbjuda l√∂sning", "S√§ga att det inte √§r ditt fel"],
          "answer": 2
        },
        {
          "level": "A",
          "type": "mcq",
          "q": "Du planerar en buff√©. Vad √§r viktigast f√∂r s√§ker livsmedelshantering?",
          "options": ["Att det ser fint ut", "Att alla r√§tter √§r varma samtidigt", "R√§tt temperaturer och tidsgr√§nser", "Att det finns m√•nga olika r√§tter"],
          "answer": 2
        }
      ]
    }
  }
  </script>

  <!-- L√§rarl√§ge ‚Äì Gate -->
  <div id="teacherGate" class="gate-backdrop hidden">
    <div class="gate-box">
      <h2>üîë L√§rarl√§ge</h2>
      <p id="teacherGateText">
        Ange l√§rarl√∂senord. F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.
      </p>
      <input id="teacherPasswordInput" class="input" type="password" placeholder="L√∂senord..." />
      <div class="gate-actions">
        <button id="btnTeacherCancel" class="btn btn-sm">Avbryt</button>
        <button id="btnTeacherConfirm" class="btn btn-sm btn-primary">Forts√§tt</button>
      </div>
    </div>
  </div>

  <!-- L√§rarl√§ge ‚Äì Modal -->
  <div id="teacherModal" class="modal-backdrop hidden">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h2>L√§rarl√§ge ‚Äì F√•ngvaktaren</h2>
          <small>Hantera inst√§llningar, fr√•gebank, bildfr√•gor, drag & drop, export och elevprogression.</small>
        </div>
        <button id="btnCloseTeacher" class="btn btn-sm">St√§ng</button>
      </header>

      <div class="modal-body">
        <!-- Flikar -->
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="settings" id="tab-settings">‚öôÔ∏è Inst√§llningar</button>
          <button class="tab-btn" data-tab="questions" id="tab-questions">üÖ∞Ô∏è Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="images" id="tab-images">üñºÔ∏è Bildfr√•gor</button>
          <button class="tab-btn" data-tab="dragdrop" id="tab-dragdrop">üéØ Drag & Drop</button>
          <button class="tab-btn" data-tab="progress" id="tab-progress">üìà Elevprogression</button>
          <button class="tab-btn" data-tab="bank" id="tab-bank">üóÇÔ∏è Fr√•gebank</button>
        </nav>

        <div class="tab-content">
          <!-- Inst√§llningar -->
          <section class="tab-panel" data-panel="settings">
            <div class="settings-grid">
              <div class="card">
                <h3>L√§rarl√∂senord</h3>
                <p>Det l√∂senord du anv√§nder f√∂r att √∂ppna l√§rarl√§get. H√§r kan du byta det.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputOldPassword">Nuvarande l√∂senord</label>
                    <input id="inputOldPassword" class="input" type="password" placeholder="L√§mna tomt om inget satt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPassword">Nytt l√∂senord</label>
                    <input id="inputNewPassword" class="input" type="password" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPasswordRepeat">Upprepa nytt l√∂senord</label>
                    <input id="inputNewPasswordRepeat" class="input" type="password" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnChangeTeacherPassword" class="btn btn-sm">üîê Spara nytt l√∂senord</button>
                </div>
                <p id="passwordStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Google-inloggning & uppladdning (l√§rare)</h3>
                <p>
                  Logga in med ditt Google-konto f√∂r att spara och ladda fr√•gebanker via Firebase.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label">Status</label>
                    <p id="googleStatus" class="mini">‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.</p>
                  </div>
                  <div class="field">
                    <button id="btnGooglePlaceholder" class="btn btn-sm" type="button">
                      üîó Logga in med Google
                    </button>
                  </div>
                  <div class="field">
                    <button id="btnGoogleLogout" class="btn btn-sm hidden" type="button">
                      üö™ Logga ut fr√•n Google
                    </button>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Gr√§ns f√∂r godk√§nt per niv√•</h3>
                <p>Justera procentgr√§ns f√∂r E, C och A. Anv√§nds som riktm√§rke f√∂r ‚ÄùGodk√§nd niv√•‚Äù.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputThresE">Niv√• 1 (E)</label>
                    <input id="inputThresE" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresC">Niv√• 2 (C)</label>
                    <input id="inputThresC" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresA">Niv√• 3 (A)</label>
                    <input id="inputThresA" type="number" min="0" max="100" class="input-number" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveThresholds" class="btn btn-sm btn-primary">üíæ Spara niv√•-gr√§nser</button>
                </div>
              </div>

              <div class="card">
                <h3>L√§rarens e-post</h3>
                <p>
                  Anv√§nds som mottagare n√§r eleven l√§mnar in resultat via e-post
                  (‚ÄùSkapa e-post‚Äù p√• Elevresultat/JSON).
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputTeacherEmail">E-postadress</label>
                    <input id="inputTeacherEmail" class="input" placeholder="namn@skola.se" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveTeacherEmail" class="btn btn-sm">üíæ Spara e-postadress</button>
                </div>
                <p id="teacherEmailStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Elevdata p√• denna enhet</h3>
                <p class="mini">
                  Dessa knappar p√•verkar bara den h√§r datorn/surfplattan. Anv√§nd dem n√§r du vill nollst√§lla progression lokalt.
                </p>
                <div class="card-row" style="margin-top:6px;gap:8px;flex-wrap:wrap;">
                  <button id="btnClearStudentData" class="btn btn-sm btn-danger" type="button">
                    üßπ Rensa elev + progression
                  </button>
                  <button id="btnResetGameData" class="btn btn-sm" type="button">
                    ‚ôªÔ∏è Nollst√§ll spelpo√§ng
                  </button>
                </div>
                <p id="resetStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Koppling: delm√•l & delbitar</h3>
                <p>
                  Skriv ett delm√•l och en delbit i taget. Klicka p√• ‚ÄùL√§gg till delbit‚Äù
                  f√∂r att l√§gga till i listan. ‚ÄùSpara‚Äù skriver listan till spelets minne
                  (localStorage). ‚ÄùTa bort alla‚Äù rensar listan.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputGoalSingle">Delm√•l</label>
                    <input id="inputGoalSingle" class="input" placeholder="t.ex. Delm√•l 5 ‚Äì Hygien i k√∂ket" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputPartSingle">Delbit</label>
                    <input id="inputPartSingle" class="input" placeholder="t.ex. 51‚Äì60 eller 51,52,53" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnAddGoalPart" class="btn btn-sm">‚ûï L√§gg till delbit</button>
                </div>
                <p id="goalsStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card card-full-width">
                <h3>Aktuella delm√•l och delbitar</h3>
                <p class="mini">Nedan visas de delm√•l och delbitar som √§r sparade i spelet just nu.</p>
                <ul id="goalsList" class="goals-list"></ul>
              </div>
            </div>
          </section>

          <!-- Flervalsfr√•gor -->
          <section class="tab-panel hidden" data-panel="questions">
            <div class="questions-editor">
              <h3>Hantera flervalsfr√•gor (MCQ)</h3>
              <p class="mini">
                L√§gg till nya flervalsfr√•gor, redigera eller importera m√•nga p√• en g√•ng.
              </p>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Snabbimport av flervalsfr√•gor</h3>
                <p class="mini">
                  Klistra in fr√•gor i formatet nedan. En asterisk (*) framf√∂r r√§tt svar.
                  En tom rad mellan fr√•gorna √§r bra men inte ett krav.
                </p>
                <pre class="mini" style="background:#020617;border-radius:6px;padding:8px;margin-top:4px;white-space:pre-wrap;">
Vilken av dessa √§r en proteink√§lla?
*Kycklingfil√©
√Ñpple
Gurka
P√§ron

Vilken av dessa √§r en frukt?
√Ñpple
*P√§ron
Potatis
Gurka
                </pre>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqJsonLevel">Niv√•</label>
                    <select id="mcqJsonLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqJsonGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqJsonGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <textarea
                  id="mcqJsonInput"
                  class="input"
                  rows="8"
                  placeholder="Klistra in dina fr√•gor h√§r..."
                  style="margin-top:8px;font-family:monospace;border-radius:6px;"
                ></textarea>
                <div style="margin-top:8px;display:flex;justify-content:flex-end;">
                  <button id="btnMcqJsonImport" class="btn btn-sm btn-primary" type="button">
                    üì• Importera fr√•gor fr√•n text
                  </button>
                </div>
              </div>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqLevel">Niv√•</label>
                    <select id="mcqLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqQuestion">Fr√•getext</label>
                    <input id="mcqQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="0" id="mcqCorrect0" style="margin-right:4px;" />
                      Alternativ 1
                    </label>
                    <input id="mcqOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="1" id="mcqCorrect1" style="margin-right:4px;" />
                      Alternativ 2
                    </label>
                    <input id="mcqOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="2" id="mcqCorrect2" style="margin-right:4px;" />
                      Alternativ 3
                    </label>
                    <input id="mcqOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="3" id="mcqCorrect3" style="margin-right:4px;" />
                      Alternativ 4
                    </label>
                    <input id="mcqOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="mcqAnswer">Korrekt svar (Index)</label>
                    <input id="mcqAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnMcqAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till fr√•ga</button>
                    <button id="btnMcqUpdate" class="btn btn-sm hidden" type="button">üíæ Spara √§ndring</button>
                  </div>
                  <button id="btnMcqClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella flervalsfr√•gor (<span id="mcqCount">0</span> st)</h3>
                <ul id="mcqList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Bildfr√•gor -->
          <section class="tab-panel hidden" data-panel="images">
            <div class="questions-editor">
              <h3>Hantera bildfr√•gor (IMG)</h3>
              <p class="mini">L√§gg till fr√•gor d√§r en bild visas tillsammans med flervalsalternativ.</p>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera bildfr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgLevel">Niv√•</label>
                    <select id="imgLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgQuestion">Fr√•getext</label>
                    <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgFile">Bildfil</label>
                    <input id="imgFile" type="file" accept="image/*" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">F√∂rhandsvisning</label>
                    <div id="imgPreview" class="img-preview-box mini">Ingen bild vald √§nnu.</div>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="0" id="imgCorrect0" style="margin-right:4px;" />
                      Alternativ 1
                    </label>
                    <input id="imgOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="1" id="imgCorrect1" style="margin-right:4px;" />
                      Alternativ 2
                    </label>
                    <input id="imgOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="2" id="imgCorrect2" style="margin-right:4px;" />
                      Alternativ 3
                    </label>
                    <input id="imgOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="3" id="imgCorrect3" style="margin-right:4px;" />
                      Alternativ 4
                    </label>
                    <input id="imgOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="imgAnswer">Korrekt svar (Index)</label>
                    <input id="imgAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="imgGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnImgAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till bildfr√•ga</button>
                  </div>
                  <button id="btnImgClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
                <ul id="imgList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Drag & Drop (komprimerad bygg-ruta) -->
          <section class="tab-panel hidden" data-panel="dragdrop">
            <div class="questions-editor">
              <h3>Hantera Drag &amp; Drop-fr√•gor</h3>
              <p class="mini">Skapa korta fr√•gor d√§r eleverna drar ord/begrepp till r√§tt kolumn.</p>

              <div class="card" style="margin-top:10px;max-width:720px;margin-left:auto;margin-right:auto;padding:10px;">
                <h4>Bygg fr√•ga (kompakt)</h4>
                <div class="card-row" style="margin-top:6px;">
                  <div class="field" style="flex:0 0 90px;">
                    <label class="small-label" for="dragLevel">Niv√•</label>
                    <select id="dragLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragQuestion">Instruktion</label>
                    <input id="dragQuestion" class="input" placeholder="Ex: Dra r√§tt livsmedel till 'Kylvara'." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragColumn1">Kolumn 1</label>
                    <input id="dragColumn1" class="input" placeholder="t.ex. Kylvara" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragColumn2">Kolumn 2</label>
                    <input id="dragColumn2" class="input" placeholder="t.ex. Torrvara" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragItemText">Objekt att dra</label>
                    <input id="dragItemText" class="input" placeholder="t.ex. 'R√• kyckling'" />
                  </div>
                  <div class="field" style="flex:0 0 140px;">
                    <label class="small-label" for="dragItemCorrect">Korrekt kolumn</label>
                    <select id="dragItemCorrect" class="input">
                      <option value="0">Kolumn 1</option>
                      <option value="1">Kolumn 2</option>
                    </select>
                  </div>
                  <div class="field" style="flex:0 0 110px;">
                    <label class="small-label">&nbsp;</label>
                    <button id="btnDragAddItem" class="btn btn-sm btn-primary" type="button" style="width:100%;">‚ûï L√§gg till</button>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label">Objekt i denna fr√•ga</label>
                    <ul id="dragItemsPreview" class="question-list"></ul>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="dragGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;justify-content:space-between;">
                  <div>
                    <button id="btnDragAddQuestion" class="btn btn-sm btn-primary" type="button">üíæ Spara fr√•ga</button>
                  </div>
                  <button id="btnDragClearForm" class="btn btn-sm btn-secondary" type="button">
                    Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:10px;">
                <h3>Aktuella Drag &amp; Drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
                <ul id="dragList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Elevprogression ‚Äì 4 rutor -->
          <section class="tab-panel hidden" data-panel="progress">
            <div class="card">
              <h3>Elevprogression</h3>
              <p class="mini">
                H√§r kan du sammanfatta vad eleven √§r stark p√•, vad som beh√∂ver √∂vas och exportera en JSON-text till elevkortet.
              </p>

              <div class="progress-grid">
                <div class="progress-box" id="progressPointsBox">
                  <h4>Elevens po√§ng (lokalt)</h4>
                  <p id="progressPointsText" class="mini">
                    Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.
                  </p>

                  <div style="margin-top:10px;">
                    <h4>Elever (aktiv bank)</h4>

                    <!-- Wrapper (bak√•tkompatibel) -->
                    <div id="playedStudentsTabs" class="tab-nav" style="margin-top:6px;">
                      <!-- NYTT: Stabil host f√∂r elevknappar -->
                      <ul id="rosterTabs" class="mini tab-nav" style="margin:0;padding:0;list-style:none;">
                        <li class="mini">Ingen elev inl√§st √§nnu.</li>
                      </ul>
                    </div>

                    <!-- Bak√•tkompatibel lista (d√∂ljs f√∂r att inte visa ‚ÄúOk√§nd elev [TOKEN]‚Äù) -->
                    <ul id="playedStudentsList" class="goals-list mini hidden">
                      <li>Ingen elev inl√§st √§nnu.</li>
                    </ul>
                  </div>
                </div>

                <div class="progress-box" id="progressStrongBox">
                  <h4>Starka delbitar</h4>
                  <ul id="progressStrongList" class="goals-list mini">
                    <li>Inga starka delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressWeakBox">
                  <h4>Delbitar att √∂va p√•</h4>
                  <ul id="progressWeakList" class="goals-list mini">
                    <li>Inga svaga delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressExportBox">
                  <h4>Export till elevkort (JSON)</h4>
                  <p class="mini">
                    N√§r du √§r n√∂jd med en elevs progression kan du skapa en JSON-str√§ng som klistras in i elevkortet.
                  </p>
                  <textarea
                    id="progressExportJson"
                    class="input"
                    rows="4"
                    readonly
                    style="font-family:monospace;font-size:0.8rem;border-radius:6px;"
                  ></textarea>
                  <div style="margin-top:6px;display:flex;gap:8px;justify-content:flex-end;">
                    <button id="btnGenerateProgressJson" class="btn btn-sm" type="button">üîÅ Skapa JSON</button>
                    <button id="btnCopyProgressJson" class="btn btn-sm btn-primary" type="button">üìã Kopiera kod</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Fr√•gebank / Firebase -->
          <section class="tab-panel hidden" data-panel="bank">
            <div class="settings-grid">
              <div class="card">
                <h3>Ladda fr√•gebank fr√•n molnet (Firebase)</h3>
                <p class="mini">
                  Visar bankar som har sparats p√• ditt Google-konto. Aktivera bankarna nedan f√∂r att l√§gga till fr√•gorna i spelet.
                </p>
                <p id="cloudBankStatus" class="mini" style="margin-top:4px;"></p>
                <ul id="cloudBankList" class="goals-list" style="margin-top:10px;"></ul>
                <div style="margin-top:10px;">
                  <button id="btnLoadCloudBanks" class="btn btn-sm" type="button">‚òÅÔ∏è Ladda moln-bankar</button>
                </div>
              </div>

              <div class="card">
                <h3>Spara aktuell fr√•gebank till molnet</h3>
                <p class="mini">
                  Namnge din fr√•gebank. Sparar *alla* fr√•gor du skapat i flervals-, bild- och drag/drop-flikarna.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="inputBankName">Namn p√• fr√•gebank</label>
                    <input id="inputBankName" class="input" placeholder="T.ex. Livsmedel HT25" />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <button id="btnSaveToCloud" class="btn btn-sm btn-primary" type="button">üíæ Spara bank till molnet</button>
                </div>
              </div>

              <div class="card card-full-width">
                <h3>Export / Import av fr√•gebank (JSON)</h3>
                <p class="mini">
                  Exportera hela din nuvarande fr√•gebank som en JSON-fil (s√§kerhetskopia) eller importera en befintlig bank fr√•n fil.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <button id="btnExportBank" class="btn btn-sm" type="button">‚¨áÔ∏è Exportera till JSON</button>
                  <label class="btn btn-sm" for="fileImport">‚¨ÜÔ∏è Importera fr√•n JSON</label>
                  <input type="file" id="fileImport" accept=".json" style="display:none;" />
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <!-- NYTT: Roster-modal (beh√∂vs f√∂r mejl + gr√∂n ‚Äúskickad‚Äù + rosterRows) -->
  <div id="bankRosterModal" class="hidden">
    <div class="card">
      <div class="card-row" style="justify-content:space-between;align-items:center;">
        <div class="field" style="flex:1 1 auto;">
          <h3>Elever (aktiv bank)</h3>
          <p class="mini" style="margin:4px 0 0;">
            L√§gg in elevens namn och e-post. Klicka ‚úâÔ∏è f√∂r att skapa mejl med spell√§nk. Knappen blir gr√∂n efter mejl.
          </p>
        </div>
        <div class="field" style="flex:0 0 140px;display:flex;justify-content:flex-end;">
          <button id="btnCloseRosterModal" class="btn btn-sm" type="button">St√§ng</button>
        </div>
      </div>

      <div class="card-row" style="margin-top:8px;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
        <button id="btnRosterAddRow" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till elevrad</button>
        <button id="btnRosterSave" class="btn btn-sm" type="button">üíæ Spara elevlista</button>
      </div>

      <div id="rosterRows" style="margin-top:10px;"></div>
    </div>
  </div>
</body>
<!-- slut SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->





<!-- start SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker, roster, progression, editor-refresh) -->
<script>
(function () {
  "use strict";

  // =========================================================
  // 3_0 ‚Äì Guard (f√∂rhindrar dubbel-injektion)
  // =========================================================
  if (window.__FV_SECTION3_LOADED__) return;
  window.__FV_SECTION3_LOADED__ = true;

  // =========================================================
  // 3A ‚Äì BAS: helpers + state (ES5-s√§kert, inga backticks)
  // =========================================================
  var FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
    apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
    authDomain: "fangvaktaren-904db.firebaseapp.com",
    projectId: "fangvaktaren-904db",
    storageBucket: "fangvaktaren-904db.firebasestorage.app",
    messagingSenderId: "105301219768",
    appId: "1:105301219768:web:66b131fba86a541b78174d",
    measurementId: "G-NXL9GSFZ77"
  };

  var STORAGE_KEY = window.STORAGE_KEY || "fangvaktaren-v17";
  var CLOUD_ROOT_COLLECTION = window.CLOUD_ROOT_COLLECTION || "teachers";
  var CLOUD_BANKS_SUBCOLLECTION = window.CLOUD_BANKS_SUBCOLLECTION || "banks";
  var PUBLIC_BANKS_COLLECTION = window.PUBLIC_BANKS_COLLECTION || "public_banks";

  // Exponera konstanter om andra sektioner beh√∂ver dem
  window.FIREBASE_CONFIG = FIREBASE_CONFIG;
  window.STORAGE_KEY = STORAGE_KEY;
  window.CLOUD_ROOT_COLLECTION = CLOUD_ROOT_COLLECTION;
  window.CLOUD_BANKS_SUBCOLLECTION = CLOUD_BANKS_SUBCOLLECTION;
  window.PUBLIC_BANKS_COLLECTION = PUBLIC_BANKS_COLLECTION;

  function _id(x) { return document.getElementById(x); }
  function _qs(sel, root) { return (root || document).querySelector(sel); }
  function _qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }
  function _safeStr(v) { return (v === null || v === undefined) ? "" : String(v); }
  function _trim(v) { return _safeStr(v).trim(); }
  function _now() { return Date.now(); }

  function _escapeHtml(s) {
    var t = _safeStr(s);
    return t
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function _getBaseUrl() {
    try { return window.location.origin + window.location.pathname; }
    catch (e) { return _safeStr(window.location.href || "").split("?")[0]; }
  }

  function _randToken(len) {
    var n = (typeof len === "number" && len > 6) ? len : 10;
    var alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    var out = "";
    try {
      if (window.crypto && window.crypto.getRandomValues) {
        var buf = new Uint8Array(n);
        window.crypto.getRandomValues(buf);
        for (var i = 0; i < n; i++) out += alphabet[buf[i] % alphabet.length];
        return out;
      }
    } catch (e) {}
    for (var j = 0; j < n; j++) out += alphabet[Math.floor(Math.random() * alphabet.length)];
    return out;
  }

  function _defaultState() {
    return {
      v: 17,
      activeBank: { mode: "", ownerUid: "", bankId: "", publicId: "", name: "" },
      // (Beh√•ll √∂vriga delar fr√•n din app i SEKTION 4/andra sektioner)
      roster: {} // roster[bankId] = [{name,email,token,sentAt}]
    };
  }

  function loadState() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return _defaultState();
      var s = JSON.parse(raw);
      if (!s || typeof s !== "object") return _defaultState();
      if (!s.activeBank) s.activeBank = { mode: "", ownerUid: "", bankId: "", publicId: "", name: "" };
      if (!s.roster || typeof s.roster !== "object") s.roster = {};
      return s;
    } catch (e) {
      return _defaultState();
    }
  }

  function saveState(s) {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
    catch (e) {}
  }

  function setActiveBankMeta(meta) {
    var s = loadState();
    s.activeBank = {
      mode: _trim(meta && meta.mode),
      ownerUid: _trim(meta && meta.ownerUid),
      bankId: _trim(meta && meta.bankId),
      publicId: _trim(meta && meta.publicId),
      name: _trim(meta && meta.name)
    };
    saveState(s);
    try { window.activeCloudBankId = s.activeBank.bankId || ""; } catch (e) {}
  }

  // Exponera core-state API (kompat)
  window.loadState = window.loadState || loadState;
  window.saveState = window.saveState || saveState;
  window.setActiveBankMeta = window.setActiveBankMeta || setActiveBankMeta;

  // =========================================================
  // 3C ‚Äì FIREBASE: init + login + db/auth-instans (robust)
  // =========================================================
  function initFirebase() {
    var statusEl = _id("googleStatus");
    try {
      if (!window.firebase) {
        if (statusEl) statusEl.textContent = "‚ö†Ô∏è Firebase saknas (bibliotek ej laddat).";
        return false;
      }
      if (!window.firebase.apps || !window.firebase.initializeApp) {
        if (statusEl) statusEl.textContent = "‚ö†Ô∏è Firebase API saknas (fel version?).";
        return false;
      }
      if (!window.firebase.apps.length) window.firebase.initializeApp(FIREBASE_CONFIG);

      window.firebaseAppInstance = window.firebase.app();
      window.firebaseAuthInstance = window.firebase.auth();
      window.firebaseDbInstance = window.firebase.firestore();

      if (window.firebaseAuthInstance && !window.__fvAuthBound) {
        window.__fvAuthBound = true;
        window.firebaseAuthInstance.onAuthStateChanged(function (user) {
          window.currentTeacherUser = user || null;
          var btnLogout = _id("btnGoogleLogout");
          if (user) {
            if (statusEl) statusEl.textContent = "‚òÅÔ∏è Inloggad som " + (user.email || "l√§rare") + " ‚Äì moln aktiverat.";
            if (btnLogout) btnLogout.classList.remove("hidden");
          } else {
            if (statusEl) statusEl.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì moln av.";
            if (btnLogout) btnLogout.classList.add("hidden");
          }
        });
      }

      try { console.log("Firebase init OK"); } catch (e) {}
      return true;
    } catch (e2) {
      if (statusEl) statusEl.textContent = "‚ö†Ô∏è Firebase init misslyckades.";
      return false;
    }
  }

  function googleLogin() {
    try {
      if (!initFirebase()) return;
      if (!window.firebaseAuthInstance) return;
      var provider = new window.firebase.auth.GoogleAuthProvider();
      window.firebaseAuthInstance.signInWithPopup(provider).catch(function (e) {
        try { console.warn("Google login misslyckades:", e); } catch (_) {}
        alert("Kunde inte logga in med Google.");
      });
    } catch (e2) {
      alert("Kunde inte logga in med Google.");
    }
  }

  function googleLogout() {
    try {
      if (!initFirebase()) return;
      if (!window.firebaseAuthInstance) return;
      window.firebaseAuthInstance.signOut();
    } catch (e) {}
  }

  // Exponera
  window.initFirebase = window.initFirebase || initFirebase;
  window.googleLogin = window.googleLogin || googleLogin;
  window.googleLogout = window.googleLogout || googleLogout;

  // =========================================================
  // 3C_1 ‚Äì Moln-banker: list / set active / delete (binder bara om UI finns)
  // =========================================================
  function _getTeacherUid() {
    try { if (window.currentTeacherUser && window.currentTeacherUser.uid) return _safeStr(window.currentTeacherUser.uid); } catch (e) {}
    try {
      if (window.firebaseAuthInstance && window.firebaseAuthInstance.currentUser && window.firebaseAuthInstance.currentUser.uid) {
        return _safeStr(window.firebaseAuthInstance.currentUser.uid);
      }
    } catch (e2) {}
    return "";
  }

  function _db() { return window.firebaseDbInstance || null; }

  function _banksRef(uid) {
    var db = _db();
    if (!db || !uid) return null;
    return db.collection(CLOUD_ROOT_COLLECTION).doc(uid).collection(CLOUD_BANKS_SUBCOLLECTION);
  }

  function loadCloudBanksListV4() {
    var listEl = _id("cloudBanksList");
    if (!listEl) return;

    if (!initFirebase()) {
      listEl.innerHTML = "<li class='question-item'>‚ö†Ô∏è Firebase saknas</li>";
      return;
    }

    var uid = _getTeacherUid();
    if (!uid) {
      listEl.innerHTML = "<li class='question-item'>‚òÅÔ∏è Logga in med Google f√∂rst.</li>";
      return;
    }

    var ref = _banksRef(uid);
    if (!ref) {
      listEl.innerHTML = "<li class='question-item'>‚ö†Ô∏è Kunde inte skapa bank-referens.</li>";
      return;
    }

    listEl.innerHTML = "<li class='question-item'>‚è≥ Laddar banker‚Ä¶</li>";

    ref.get().then(function (qsnap) {
      var items = [];
      qsnap.forEach(function (doc) {
        var d = doc.data() || {};
        items.push({
          id: doc.id,
          name: _trim(d.name || "Namnl√∂s bank"),
          publicId: _trim(d.publicId || ""),
          updatedAt: Number(d.updatedAt || 0) || 0
        });
      });

      items.sort(function (a, b) { return (b.updatedAt || 0) - (a.updatedAt || 0); });

      var s = loadState();
      var activeId = _trim((s.activeBank && s.activeBank.bankId) || "");
      listEl.innerHTML = "";

      if (!items.length) {
        listEl.innerHTML = "<li class='question-item'>Inga moln-banker √§nnu.</li>";
        return;
      }

      for (var i = 0; i < items.length; i++) {
        (function (it) {
          var li = document.createElement("li");
          li.className = "question-item";
          li.setAttribute("data-bank-id", it.id);

          var isActive = (activeId && activeId === it.id);

          var main = document.createElement("div");
          main.className = "list-main";
          main.innerHTML = "<div class='q-text'>" + _escapeHtml(it.name) + (isActive ? " <span class='mini'>‚úÖ Aktiv</span>" : "") + "</div>";

          var actions = document.createElement("div");
          actions.className = "list-actions";

          var btnActivate = document.createElement("button");
          btnActivate.type = "button";
          btnActivate.className = "btn btn-sm";
          btnActivate.textContent = isActive ? "Aktiv" : "Aktivera";

          var btnDelete = document.createElement("button");
          btnDelete.type = "button";
          btnDelete.className = "btn btn-sm danger";
          btnDelete.textContent = "Ta bort";

          btnActivate.addEventListener("click", function () {
            setActiveBankMeta({ mode: "cloud", ownerUid: uid, bankId: it.id, publicId: it.publicId, name: it.name });
            try { window.activeCloudBankId = it.id; } catch (e) {}
            loadCloudBanksListV4();
            try { if (typeof window.refreshEditors === "function") window.refreshEditors(); } catch (e2) {}
          });

          btnDelete.addEventListener("click", function () {
            if (!confirm("Ta bort bank '" + it.name + "'?")) return;
            deleteCloudBankById(it.id).then(function () {
              loadCloudBanksListV4();
            });
          });

          actions.appendChild(btnActivate);
          actions.appendChild(btnDelete);

          li.appendChild(main);
          li.appendChild(actions);
          listEl.appendChild(li);
        })(items[i]);
      }
    }).catch(function (e) {
      listEl.innerHTML = "<li class='question-item'>‚ö†Ô∏è Kunde inte ladda banker.</li>";
      try { console.warn("Kunde inte ladda banker:", e); } catch (_) {}
    });
  }

  function deleteCloudBankById(bid) {
    return new Promise(function (resolve) {
      try {
        if (!initFirebase()) return resolve(false);
        var uid = _getTeacherUid();
        if (!uid) return resolve(false);

        var db = _db();
        if (!db) return resolve(false);

        var bankRef = db.collection(CLOUD_ROOT_COLLECTION).doc(uid)
          .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(bid));

        bankRef.get().then(function (snap) {
          var d = (snap && snap.exists) ? (snap.data() || {}) : {};
          var publicId = _trim(d.publicId || "");
          var p = Promise.resolve();

          if (publicId) {
            p = db.collection(PUBLIC_BANKS_COLLECTION).doc(publicId).delete().catch(function (e) {
              try { console.warn("Kunde inte ta bort public-banken (ok att ignorera):", e); } catch (_) {}
            });
          }

          p.then(function () {
            bankRef.delete().then(function () {
              try {
                var s = loadState();
                if (String((s.activeBank && s.activeBank.bankId) || "") === String(bid)) {
                  setActiveBankMeta({ mode: "", ownerUid: "", bankId: "", publicId: "", name: "" });
                  try { window.activeCloudBankId = ""; } catch (e2) {}
                }
              } catch (e3) {}
              resolve(true);
            }).catch(function () { resolve(false); });
          });
        }).catch(function () { resolve(false); });
      } catch (e4) {
        resolve(false);
      }
    });
  }

  // Kompat-alias
  window.loadCloudBanksListV4 = window.loadCloudBanksListV4 || loadCloudBanksListV4;
  window.deleteCloudBankById = window.deleteCloudBankById || deleteCloudBankById;

  // =========================================================
  // 3D ‚Äì ROSTER (√∂ppnar direkt + timeout p√• molnload + mejl + skickat-status)
  // =========================================================
  var ROSTER_MODAL_ID = "bankRosterModal";
  var ROSTER_ROWS_ID = "rosterRows";
  var BTN_ADD_ROW_ID = "btnRosterAddRow";
  var BTN_SAVE_ID = "btnRosterSave";
  var BTN_CLOSE_ID = "btnCloseRosterModal";
  var LOAD_TIMEOUT_MS = 2500;

  function _ensureModalVisible(modalEl) {
    if (!modalEl) return;
    try { modalEl.classList.remove("hidden"); } catch (e) {}
    try { modalEl.setAttribute("aria-hidden", "false"); } catch (e2) {}
    try { modalEl.style.display = "block"; } catch (e3) {}
  }

  function _ensureModalHidden(modalEl) {
    if (!modalEl) return;
    try { modalEl.classList.add("hidden"); } catch (e) {}
    try { modalEl.setAttribute("aria-hidden", "true"); } catch (e2) {}
    try { modalEl.style.display = "none"; } catch (e3) {}
  }

  function _getActiveBankId() {
    try {
      if (typeof window.activeCloudBankId !== "undefined" && window.activeCloudBankId !== null) return _safeStr(window.activeCloudBankId);
    } catch (e) {}
    var s = loadState();
    return _trim((s.activeBank && s.activeBank.bankId) || "");
  }

  function _getPublicIdFromState() {
    var s = loadState();
    return _trim((s.activeBank && s.activeBank.publicId) || "");
  }

  function _buildPlayLink(token) {
    var base = _getBaseUrl();
    var publicId = _getPublicIdFromState();
    var t = _trim(token);
    if (!publicId || !t) return "";
    return base + "?public=" + encodeURIComponent(publicId) + "&token=" + encodeURIComponent(t);
  }

  function _buildMailto(email, token) {
    var e = _trim(email);
    if (!e) return "";
    var link = _buildPlayLink(token);
    var subject = "F√•ngvaktaren ‚Äì din spell√§nk";
    var body = "Hej!\n\nH√§r √§r din l√§nk till spelet:\n" + (link || "[saknar l√§nk]") + "\n\nLycka till!\n";
    return "mailto:" + encodeURIComponent(e) +
      "?subject=" + encodeURIComponent(subject) +
      "&body=" + encodeURIComponent(body);
  }

  function _normalizeRosterRow(o) {
    o = o || {};
    var sentAt = 0;
    try { sentAt = Number(o.sentAt || 0) || 0; } catch (e) { sentAt = 0; }
    return {
      name: _trim(o.name),
      email: _trim(o.email),
      token: _trim(o.token),
      sentAt: sentAt
    };
  }

  function _clear(el) {
    if (!el) return;
    while (el.firstChild) el.removeChild(el.firstChild);
  }

  function _makeInput(type, placeholder, cls) {
    var inp = document.createElement("input");
    inp.type = type || "text";
    if (placeholder) inp.placeholder = placeholder;
    if (cls) inp.className = cls;
    try { inp.autocomplete = "off"; } catch (e) {}
    return inp;
  }

  function _makeBtn(text, cls) {
    var b = document.createElement("button");
    b.type = "button";
    b.textContent = text || "OK";
    if (cls) b.className = cls;
    return b;
  }

  function _makeLink(text, cls) {
    var a = document.createElement("a");
    a.href = "#";
    a.textContent = text || "L√§nk";
    a.target = "_blank";
    a.rel = "noopener";
    if (cls) a.className = cls;
    return a;
  }

  function _rowDom(rowObj) {
    var row = _normalizeRosterRow(rowObj);

    var wrap = document.createElement("div");
    wrap.className = "roster-row";
    wrap.setAttribute("data-roster-row", "1");
    wrap.setAttribute("data-sent-at", String(row.sentAt || 0));

    var nameInp = _makeInput("text", "Namn", "roster-name");
    var emailInp = _makeInput("email", "E-post", "roster-email");
    var tokenInp = _makeInput("text", "Token", "roster-token");

    nameInp.value = row.name;
    emailInp.value = row.email;
    tokenInp.value = row.token;

    var actions = document.createElement("div");
    actions.className = "roster-actions";

    var btnToken = _makeBtn("üéüÔ∏è Token", "btn roster-make-token");
    var linkA = _makeLink("üîó L√§nk", "roster-link");
    var mailA = _makeLink("‚úâÔ∏è Mejla", "roster-mail");
    var btnSent = _makeBtn(row.sentAt ? "‚úÖ Skickat" : "‚¨úÔ∏è Skickat", "btn roster-sent");
    var btnDel = _makeBtn("üóëÔ∏è", "btn roster-del");

    function refreshDerived() {
      var t = _trim(tokenInp.value);
      var e = _trim(emailInp.value);
      var play = _buildPlayLink(t);

      if (play) {
        linkA.href = play;
        linkA.style.pointerEvents = "";
        linkA.style.opacity = "";
      } else {
        linkA.href = "#";
        linkA.style.pointerEvents = "none";
        linkA.style.opacity = "0.5";
      }

      var mailto = _buildMailto(e, t);
      if (mailto) {
        mailA.href = mailto;
        mailA.style.pointerEvents = "";
        mailA.style.opacity = "";
      } else {
        mailA.href = "#";
        mailA.style.pointerEvents = "none";
        mailA.style.opacity = "0.5";
      }
    }

    btnToken.addEventListener("click", function () {
      var t = _trim(tokenInp.value);
      if (!t) tokenInp.value = _randToken(10);
      refreshDerived();
    });

    btnSent.addEventListener("click", function () {
      var cur = 0;
      try { cur = Number(wrap.getAttribute("data-sent-at") || "0") || 0; } catch (e) { cur = 0; }
      if (cur) {
        wrap.setAttribute("data-sent-at", "0");
        btnSent.textContent = "‚¨úÔ∏è Skickat";
      } else {
        wrap.setAttribute("data-sent-at", String(_now()));
        btnSent.textContent = "‚úÖ Skickat";
      }
    });

    btnDel.addEventListener("click", function () {
      try { wrap.parentNode && wrap.parentNode.removeChild(wrap); } catch (e) {}
    });

    nameInp.addEventListener("input", refreshDerived);
    emailInp.addEventListener("input", refreshDerived);
    tokenInp.addEventListener("input", refreshDerived);

    actions.appendChild(btnToken);
    actions.appendChild(linkA);
    actions.appendChild(mailA);
    actions.appendChild(btnSent);
    actions.appendChild(btnDel);

    wrap.appendChild(nameInp);
    wrap.appendChild(emailInp);
    wrap.appendChild(tokenInp);
    wrap.appendChild(actions);

    refreshDerived();
    return wrap;
  }

  function _containerToRoster(container) {
    var rows = [];
    var list = _qsa("[data-roster-row='1']", container);
    for (var i = 0; i < list.length; i++) {
      var r = list[i];
      var nameInp = _qs(".roster-name", r);
      var emailInp = _qs(".roster-email", r);
      var tokenInp = _qs(".roster-token", r);
      var sentAt = 0;
      try { sentAt = Number(r.getAttribute("data-sent-at") || "0") || 0; } catch (e) { sentAt = 0; }

      var obj = {
        name: _trim(nameInp ? nameInp.value : ""),
        email: _trim(emailInp ? emailInp.value : ""),
        token: _trim(tokenInp ? tokenInp.value : ""),
        sentAt: sentAt
      };

      if (obj.name || obj.email || obj.token) rows.push(_normalizeRosterRow(obj));
    }
    return rows;
  }

  function _renderRoster(container, rows) {
    _clear(container);
    var arr = Array.isArray(rows) ? rows : [];
    if (!arr.length) arr = [ { name: "", email: "", token: "", sentAt: 0 } ];
    for (var i = 0; i < arr.length; i++) container.appendChild(_rowDom(arr[i]));
  }

  function _withTimeout(promise, ms) {
    var t = (typeof ms === "number" && ms > 0) ? ms : LOAD_TIMEOUT_MS;
    return new Promise(function (resolve) {
      var done = false;
      var timer = setTimeout(function () {
        if (done) return;
        done = true;
        resolve(null);
      }, t);

      promise.then(function (v) {
        if (done) return;
        done = true;
        clearTimeout(timer);
        resolve(v);
      }).catch(function () {
        if (done) return;
        done = true;
        clearTimeout(timer);
        resolve(null);
      });
    });
  }

  function _loadRosterCloud(bid) {
    return new Promise(function (resolve) {
      try {
        if (!initFirebase()) return resolve(null);
        var uid = _getTeacherUid();
        if (!uid) return resolve(null);
        var db = _db();
        if (!db) return resolve(null);

        db.collection(CLOUD_ROOT_COLLECTION).doc(uid)
          .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(bid))
          .get()
          .then(function (snap) {
            var d = (snap && snap.exists) ? (snap.data() || {}) : {};
            if (!Array.isArray(d.roster)) return resolve([]);
            var out = [];
            for (var i = 0; i < d.roster.length; i++) out.push(_normalizeRosterRow(d.roster[i]));
            resolve(out);
          })
          .catch(function () { resolve(null); });
      } catch (e) {
        resolve(null);
      }
    });
  }

  function _saveRosterCloud(bid, rows) {
    return new Promise(function (resolve) {
      try {
        if (!initFirebase()) return resolve(false);
        var uid = _getTeacherUid();
        if (!uid) return resolve(false);
        var db = _db();
        if (!db) return resolve(false);

        db.collection(CLOUD_ROOT_COLLECTION).doc(uid)
          .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(bid))
          .set({ roster: rows, rosterUpdatedAt: _now() }, { merge: true })
          .then(function () { resolve(true); })
          .catch(function () { resolve(false); });
      } catch (e) {
        resolve(false);
      }
    });
  }

  function openRosterModal() {
    var modal = _id(ROSTER_MODAL_ID);
    var rowsEl = _id(ROSTER_ROWS_ID);
    if (!modal || !rowsEl) return;

    var bid = _getActiveBankId();
    if (!bid) {
      alert("Aktivera en moln-bank f√∂rst.");
      return;
    }

    _ensureModalVisible(modal);

    // Render direkt fr√•n local state
    var s = loadState();
    var localRows = (s.roster && s.roster[bid]) ? s.roster[bid] : [];
    _renderRoster(rowsEl, localRows);

    // Ladda moln i bakgrunden (timeout)
    _withTimeout(_loadRosterCloud(bid), LOAD_TIMEOUT_MS).then(function (cloudRows) {
      if (!cloudRows) return;
      _renderRoster(rowsEl, cloudRows);
      var s2 = loadState();
      if (!s2.roster) s2.roster = {};
      s2.roster[bid] = cloudRows;
      saveState(s2);
    });
  }

  function _addRosterRow() {
    var rowsEl = _id(ROSTER_ROWS_ID);
    if (!rowsEl) return;
    rowsEl.appendChild(_rowDom({ name: "", email: "", token: "", sentAt: 0 }));
  }

  function _saveRoster() {
    var rowsEl = _id(ROSTER_ROWS_ID);
    if (!rowsEl) return;

    var bid = _getActiveBankId();
    if (!bid) {
      alert("Aktivera en moln-bank f√∂rst.");
      return;
    }

    var rows = _containerToRoster(rowsEl);

    // Spara lokalt
    var s = loadState();
    if (!s.roster) s.roster = {};
    s.roster[bid] = rows;
    saveState(s);

    // Spara i moln
    _saveRosterCloud(bid, rows).then(function (ok) {
      try {
        console.log(ok ? "‚úÖ Elevlista sparad (moln + lokalt)." : "‚ö†Ô∏è Elevlista sparad lokalt (moln misslyckades).");
      } catch (e) {}
    });
  }

  function _closeRosterModal() {
    var modal = _id(ROSTER_MODAL_ID);
    if (!modal) return;
    _ensureModalHidden(modal);
  }

  function _bindRosterButtons() {
    var btnAdd = _id(BTN_ADD_ROW_ID);
    var btnSave = _id(BTN_SAVE_ID);
    var btnClose = _id(BTN_CLOSE_ID);

    if (btnAdd && !btnAdd.__fvBound) {
      btnAdd.__fvBound = true;
      btnAdd.addEventListener("click", _addRosterRow);
    }
    if (btnSave && !btnSave.__fvBound) {
      btnSave.__fvBound = true;
      btnSave.addEventListener("click", _saveRoster);
    }
    if (btnClose && !btnClose.__fvBound) {
      btnClose.__fvBound = true;
      btnClose.addEventListener("click", _closeRosterModal);
    }
  }

  // Exponera roster API (kompat)
  window.openRosterModal = window.openRosterModal || openRosterModal;
  window.openRosterModalV3D = window.openRosterModalV3D || openRosterModal;

  // =========================================================
  // 3E ‚Äì Binder UI (bara om knappar finns)
  // =========================================================
  function bindSection3UI() {
    // Firebase init + auth status
    try { initFirebase(); } catch (e) {}

    // Login/Logout
    var btnLogin = _id("btnGoogleLogin");
    var btnLogout = _id("btnGoogleLogout");
    if (btnLogin && !btnLogin.__fvBound) {
      btnLogin.__fvBound = true;
      btnLogin.addEventListener("click", googleLogin);
    }
    if (btnLogout && !btnLogout.__fvBound) {
      btnLogout.__fvBound = true;
      btnLogout.addEventListener("click", googleLogout);
    }

    // Ladda moln-bankar
    var btnLoadBanks = _id("btnLoadCloudBanks");
    if (btnLoadBanks && !btnLoadBanks.__fvBound) {
      btnLoadBanks.__fvBound = true;
      btnLoadBanks.addEventListener("click", loadCloudBanksListV4);
    }

    // Roster-knapp (om den finns)
    var btnOpenRoster = _id("btnOpenRoster");
    if (btnOpenRoster && !btnOpenRoster.__fvBound) {
      btnOpenRoster.__fvBound = true;
      btnOpenRoster.addEventListener("click", openRosterModal);
    }

    _bindRosterButtons();
  }

  // Kompat: initApp brukar finnas i annan sektion ‚Äì vi binder √§nd√• s√§kert h√§r
  function initAppSection3() {
    bindSection3UI();
  }

  window.bindSection3UI = window.bindSection3UI || bindSection3UI;
  window.initAppSection3 = window.initAppSection3 || initAppSection3;

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAppSection3);
  } else {
    initAppSection3();
  }

})();
</script>
<!-- slut SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker, roster, progression, editor-refresh) -->






<!-- start SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->
<script>
"use strict";

/* =========================
   4_0 ‚Äì Globala spelvariabler (kr√§vs f√∂r "use strict")
   ========================= */
let currentLevel = null;
let currentQuestions = [];
let currentAnswers = [];
let lastSubmission = null;

/* =========================
   4_0b ‚Äì Fallbacks (f√∂rhindrar krascher om helpers saknas)
   ========================= */
function shuffle(arr){
  const a = Array.isArray(arr) ? arr.slice() : [];
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    const tmp = a[i];
    a[i] = a[j];
    a[j] = tmp;
  }
  return a;
}

if (typeof window.getLinksForQuestion !== "function"){
  window.getLinksForQuestion = function(){ return []; };
}

/* =========================
   4a ‚Äì Elevdata & UI-sync
   ========================= */

function ensureStudentSet() {
  const s = loadState();
  if (!s.student.name || !s.student.klass) {
    alert("Skriv in namn och klass och spara eleven f√∂rst.");
    return false;
  }
  return true;
}

function handleSaveStudent() {
  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  const s = loadState();

  s.student.name = (nameInput && nameInput.value.trim()) || "";
  s.student.klass = (classInput && classInput.value.trim()) || "";
  saveState(s);
  syncUI();
}

function updateStudentStatsUI() {
  const s = loadState();
  const ptsEl = getEl("studentPointsValue");
  const hsEl = getEl("highscoreSummary");

  const totalPoints = (s.progression && typeof s.progression.totalPoints === "number")
    ? s.progression.totalPoints
    : 0;

  if (ptsEl) ptsEl.textContent = `${totalPoints} p`;

  if (hsEl) {
    const hs = Array.isArray(s.highscores) ? s.highscores.slice() : [];
    if (!hs.length) {
      hsEl.textContent = "Ingen highscore √§nnu.";
      return;
    }
    hs.sort((a, b) => (b.points || 0) - (a.points || 0));
    const studentId = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
    const idx = hs.findIndex((e) => e.id === studentId);
    if (idx >= 0) {
      hsEl.textContent = `Plats ${idx + 1} av ${hs.length} (${hs[idx].points || 0} p)`;
    } else {
      hsEl.textContent = `Highscorelista: ${hs.length} elever p√• denna enhet.`;
    }
  }
}

function normalizeGoalsMap(s) {
  if (!s) return [];

  // St√∂d flera m√∂jliga format
  const raw =
    (Array.isArray(s.goalsMap) && s.goalsMap) ||
    (s.bank && Array.isArray(s.bank.goalsMap) && s.bank.goalsMap) ||
    (s.bank && s.bank.meta && Array.isArray(s.bank.meta.goalsMap) && s.bank.meta.goalsMap) ||
    [];

  const out = [];

  raw.forEach((g, i) => {
    if (!g) return;

    // F√∂rv√§ntat: { id, goal, part } eller { id, goalTitle, partText }
    const id =
      (g.id != null ? String(g.id) : null) ||
      (g.partId != null ? String(g.partId) : null) ||
      (g.delbit != null ? String(g.delbit) : null) ||
      String(i + 1);

    const goal =
      (g.goal != null ? String(g.goal) : null) ||
      (g.goalTitle != null ? String(g.goalTitle) : null) ||
      (g.delmal != null ? String(g.delmal) : null) ||
      "";

    const part =
      (g.part != null ? String(g.part) : null) ||
      (g.partText != null ? String(g.partText) : null) ||
      (g.text != null ? String(g.text) : null) ||
      (g.delbitText != null ? String(g.delbitText) : null) ||
      "";

    out.push({ id, goal, part });
  });

  return out;
}

function renderGoalsListAndSelects() {
  const s = loadState();
  const goals = normalizeGoalsMap(s);

  // Lista i Inst√§llningar
  const listEl = getEl("goalsList");
  if (listEl) {
    listEl.innerHTML = "";
    if (!goals.length) {
      const li = document.createElement("li");
      li.textContent = "Inga delm√•l/delbitar sparade √§nnu.";
      listEl.appendChild(li);
    } else {
      goals.forEach((g) => {
        const li = document.createElement("li");
        const left = g.goal ? `${g.goal}` : "Delm√•l";
        const right = g.part ? ` ‚Äì ${g.part}` : "";
        li.textContent = `Delbit ${g.id}: ${left}${right}`;
        listEl.appendChild(li);
      });
    }
  }

  // Selects i editorerna
  const selectIds = ["mcqGoalPart", "imgGoalPart", "dragGoalPart", "mcqJsonGoalPart"];
  selectIds.forEach((id) => {
    const sel = getEl(id);
    if (!sel) return;

    const keepValue = sel.value || "";
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Ingen koppling";
    sel.appendChild(opt0);

    goals.forEach((g) => {
      const opt = document.createElement("option");
      opt.value = String(g.id);
      const goalTxt = (g.goal || "").trim();
      const partTxt = (g.part || "").trim();
      opt.textContent = goalTxt && partTxt
        ? `Delbit ${g.id}: ${goalTxt} ‚Äì ${partTxt}`
        : goalTxt
          ? `Delbit ${g.id}: ${goalTxt}`
          : partTxt
            ? `Delbit ${g.id}: ${partTxt}`
            : `Delbit ${g.id}`;
      sel.appendChild(opt);
    });

    if (keepValue) sel.value = keepValue;
  });
}

function updateProgressionPanel() {
  const s = loadState();
  const prog = s.progression || {};
  const best = s.best || {};
  const thres = s.thres || {};

  const pointsText = getEl("progressPointsText");
  const strongEl = getEl("progressStrongList");
  const weakEl = getEl("progressWeakList");

  const last = prog.lastResult || null;
  const totalPoints = typeof prog.totalPoints === "number" ? prog.totalPoints : 0;

  const tE = (thres && typeof thres.E === "number") ? thres.E : 70;
  const tC = (thres && typeof thres.C === "number") ? thres.C : 70;
  const tA = (thres && typeof thres.A === "number") ? thres.A : 70;

  if (pointsText) {
    if (!last) {
      pointsText.textContent = "Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.";
    } else {
      pointsText.textContent =
        `Totalt: ${totalPoints} p. ` +
        `Senast: niv√• ${last.level} ‚Äì ${last.score}% (${last.correct}/${last.total} r√§tt) +${last.pointsGained || 0}p. ` +
        `B√§sta: E ${best.E || 0}% (gr√§ns ${tE}%), C ${best.C || 0}% (gr√§ns ${tC}%), A ${best.A || 0}% (gr√§ns ${tA}%).`;
    }
  }

  if (strongEl) strongEl.innerHTML = "";
  if (weakEl) weakEl.innerHTML = "";

  const wrongByGoal = prog.wrongByGoalId || {};
  const correctByGoal = prog.correctByGoalId || {};

  const allIds = new Set([
    ...Object.keys(wrongByGoal),
    ...Object.keys(correctByGoal)
  ]);

  if (!allIds.size) {
    if (strongEl) {
      const li = document.createElement("li");
      li.textContent = "Inga starka delbitar inl√§sta √§nnu.";
      strongEl.appendChild(li);
    }
    if (weakEl) {
      const li = document.createElement("li");
      li.textContent = "Inga svaga delbitar inl√§sta √§nnu.";
      weakEl.appendChild(li);
    }
    return;
  }

  const baseThres =
    typeof thres.E === "number" ? thres.E :
    typeof thres.C === "number" ? thres.C :
    typeof thres.A === "number" ? thres.A : 70;

  const stats = [];
  allIds.forEach((id) => {
    const c = correctByGoal[id] || 0;
    const w = wrongByGoal[id] || 0;
    const total = c + w;
    if (!total) return;
    const acc = Math.round((c / total) * 100);
    stats.push({ id, correct: c, wrong: w, total, acc });
  });

  const strong = stats
    .filter((st) => st.acc >= baseThres && st.correct > 0)
    .sort((a, b) => b.acc - a.acc || b.correct - a.correct)
    .slice(0, 12);

  const weak = stats
    .filter((st) => st.acc < baseThres || st.wrong > 0)
    .sort((a, b) => b.wrong - a.wrong || a.acc - b.acc)
    .slice(0, 12);

  if (strongEl) {
    if (!strong.length) {
      const li = document.createElement("li");
      li.textContent = "Inga tydliga styrkor √§nnu ‚Äì forts√§tt spela.";
      strongEl.appendChild(li);
    } else {
      strong.forEach((st) => {
        const li = document.createElement("li");
        li.textContent = `Delbit ${st.id} ‚Äì ${st.acc}% r√§tt (${st.correct}/${st.total})`;
        strongEl.appendChild(li);
      });
    }
  }

  if (weakEl) {
    if (!weak.length) {
      const li = document.createElement("li");
      li.textContent = "Inga tydliga svagheter ‚Äì bra jobbat!";
      weakEl.appendChild(li);
    } else {
      weak.forEach((st) => {
        const li = document.createElement("li");
        li.textContent = `Delbit ${st.id} ‚Äì ${st.wrong} fel (${st.correct}/${st.total} r√§tt, ${st.acc}%)`;
        weakEl.appendChild(li);
      });
    }
  }
}

function handleGenerateProgressJson() {
  const s = loadState();
  const prog = s.progression || {};
  const last = prog.lastResult || null;

  const output = getEl("progressExportJson");
  if (!output) return;

  if (!last) {
    output.value = "";
    return;
  }

  const payload = {
    source: "fangvaktaren",
    version: "v17",
    student: {
      name: s.student.name || "",
      klass: s.student.klass || ""
    },
    result: {
      level: last.level,
      scorePercent: last.score,
      correct: last.correct,
      total: last.total,
      pointsGained: last.pointsGained,
      totalPointsAfter: last.totalPointsAfter,
      timestamp: last.timestamp
    },
    progression: {
      totalPoints: (prog.totalPoints || 0),
      best: s.best || {},
      wrongByGoalId: prog.wrongByGoalId || {},
      correctByGoalId: prog.correctByGoalId || {}
    }
  };

  output.value = JSON.stringify(payload, null, 2);
}

function handleCopyProgressJson() {
  const output = getEl("progressExportJson");
  if (!output) return;

  const text = output.value || "";
  if (!text.trim()) return;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).catch(() => {});
  }
}

function updateAllProgressionUI() {
  updateStudentStatsUI();
  updateProgressionPanel();
  renderGoalsListAndSelects();
}

function handleClearStudentData() {
  const s = loadState();
  if (!confirm("Detta rensar alla sparade elevuppgifter, highscore och progression p√• DENNA dator. Forts√§tt?")) return;

  s.student = { name: "", klass: "" };
  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];

  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Elevdata rensad p√• denna enhet.";
}

function handleResetGameData() {
  const s = loadState();
  if (!confirm("Detta nollst√§ller po√§ng, progression och highscore men beh√•ller nuvarande elevnamn/klass. Forts√§tt?")) return;

  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];

  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Spelpo√§ng och progression nollst√§lld.";
}

function syncUI() {
  const s = loadState();
  const hasStudent = !!(s.student.name && s.student.klass);

  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  if (nameInput) nameInput.value = s.student.name || "";
  if (classInput) classInput.value = s.student.klass || "";

  const studentSaved = getEl("studentSaved");
  if (studentSaved) {
    studentSaved.textContent = hasStudent
      ? `Sparad: ${s.student.name} (${s.student.klass})`
      : "Ej sparad elev";
  }

  const bestE = getEl("best-levelE");
  const bestC = getEl("best-levelC");
  const bestA = getEl("best-levelA");
  if (bestE) bestE.textContent = (s.best && s.best.E) || 0;
  if (bestC) bestC.textContent = (s.best && s.best.C) || 0;
  if (bestA) bestA.textContent = (s.best && s.best.A) || 0;

  const thresE = getEl("thres-levelE");
  const thresC = getEl("thres-levelC");
  const thresA = getEl("thres-levelA");
  if (thresE && s.thres && typeof s.thres.E === "number") thresE.textContent = s.thres.E;
  if (thresC && s.thres && typeof s.thres.C === "number") thresC.textContent = s.thres.C;
  if (thresA && s.thres && typeof s.thres.A === "number") thresA.textContent = s.thres.A;

  const cardE = getEl("card-levelE");
  const cardC = getEl("card-levelC");
  const cardA = getEl("card-levelA");
  const btnE = getEl("start-levelE");
  const btnC = getEl("start-levelC");
  const btnA = getEl("start-levelA");
  const badgeE = getEl("badge-levelE");
  const badgeC = getEl("badge-levelC");
  const badgeA = getEl("badge-levelA");

  if (cardE && btnE && badgeE) {
    if (hasStudent) {
      cardE.classList.remove("locked");
      btnE.disabled = false;
      badgeE.textContent = "Starta";
      badgeE.classList.remove("badge-lock");
      badgeE.classList.add("badge-ok");
    } else {
      cardE.classList.add("locked");
      btnE.disabled = true;
      badgeE.textContent = "L√•st";
      badgeE.classList.remove("badge-ok");
      badgeE.classList.add("badge-lock");
    }
  }

  if (cardC && btnC && badgeC) {
    if (s.unlocked && s.unlocked.C) {
      cardC.classList.remove("locked");
      btnC.disabled = false;
      badgeC.textContent = "Uppl√•st";
      badgeC.classList.remove("badge-lock");
      badgeC.classList.add("badge-ok");
    } else {
      cardC.classList.add("locked");
      btnC.disabled = true;
      badgeC.textContent = "L√•st";
      badgeC.classList.remove("badge-ok");
      badgeC.classList.add("badge-lock");
    }
  }

  if (cardA && btnA && badgeA) {
    if (s.unlocked && s.unlocked.A) {
      cardA.classList.remove("locked");
      btnA.disabled = false;
      badgeA.textContent = "Uppl√•st";
      badgeA.classList.remove("badge-lock");
      badgeA.classList.add("badge-ok");
    } else {
      cardA.classList.add("locked");
      btnA.disabled = true;
      badgeA.textContent = "L√•st";
      badgeA.classList.remove("badge-ok");
      badgeA.classList.add("badge-lock");
    }
  }

  const who = getEl("whoPlays");
  if (who) {
    who.textContent = hasStudent
      ? `${s.student.name} (${s.student.klass})`
      : "Ingen elev vald.";
  }

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const studentCard = getEl("studentCard");

  const isPlaying = !!currentLevel;
  const isResultVisible = resultSection && !resultSection.classList.contains("hidden");

  if (studentCard) {
    studentCard.classList.toggle("hidden", isPlaying || isResultVisible);
  }

  updateAllProgressionUI();
}

/* =========================
   4b ‚Äì Spel-logik (fr√•gerendering & niv√•er)
   ========================= */

function renderDragQuestion(q, index, host) {
  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"}) ‚Äì Drag & Drop`;
  container.appendChild(header);

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.flexWrap = "wrap";
  wrapper.style.gap = "12px";
  wrapper.style.marginTop = "6px";

  const sourcesCol = document.createElement("div");
  sourcesCol.style.flex = "1 1 180px";

  const targetsCol = document.createElement("div");
  targetsCol.style.flex = "2 1 260px";

  const srcTitle = document.createElement("div");
  srcTitle.className = "mini";
  srcTitle.textContent = "Kort att dra:";
  sourcesCol.appendChild(srcTitle);

  const srcZone = document.createElement("div");
  srcZone.style.border = "1px dashed #1f2937";
  srcZone.style.borderRadius = "8px";
  srcZone.style.padding = "6px";
  srcZone.style.minHeight = "40px";
  srcZone.style.display = "flex";
  srcZone.style.flexWrap = "wrap";
  srcZone.style.gap = "4px";
  sourcesCol.appendChild(srcZone);

  const tgtTitle = document.createElement("div");
  tgtTitle.className = "mini";
  tgtTitle.textContent = "Kategori-rutor:";
  targetsCol.appendChild(tgtTitle);

  const tgtZone = document.createElement("div");
  tgtZone.style.display = "flex";
  tgtZone.style.flexWrap = "wrap";
  tgtZone.style.gap = "8px";
  targetsCol.appendChild(tgtZone);

  wrapper.appendChild(sourcesCol);
  wrapper.appendChild(targetsCol);
  container.appendChild(wrapper);

  const sources = Array.isArray(q.dragSources) ? q.dragSources : [];
  const targets = Array.isArray(q.dragTargets) ? q.dragTargets : [];
  const answers = {};
  currentAnswers[index] = answers;

  function makeDraggableChip(src) {
    const chip = document.createElement("div");
    chip.textContent = src.label;
    chip.draggable = true;
    chip.dataset.itemId = src.id;
    chip.className = "chip";
    chip.style.cursor = "grab";
    chip.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", src.id);
    });
    return chip;
  }

  function setupDropTarget(el, targetId) {
    el.addEventListener("dragover", (ev) => ev.preventDefault());
    el.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      el.appendChild(existing);

      if (targetId === null) delete answers[itemId];
      else answers[itemId] = targetId;
    });
  }

  setupDropTarget(srcZone, null);

  sources.forEach((src) => {
    const chip = makeDraggableChip(src);
    srcZone.appendChild(chip);
  });

  targets.forEach((tgt) => {
    const box = document.createElement("div");
    box.style.border = "1px solid #1f2937";
    box.style.borderRadius = "8px";
    box.style.padding = "6px";
    box.style.minHeight = "46px";
    box.style.minWidth = "110px";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "4px";

    const cap = document.createElement("div");
    cap.className = "mini";
    cap.textContent = tgt.label;
    box.appendChild(cap);

    const slot = document.createElement("div");
    slot.style.display = "flex";
    slot.style.flexWrap = "wrap";
    slot.style.gap = "4px";
    box.appendChild(slot);

    box.addEventListener("dragover", (ev) => ev.preventDefault());
    box.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;
      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;
      slot.appendChild(existing);
      answers[itemId] = tgt.id;
    });

    tgtZone.appendChild(box);
  });

  host.appendChild(container);
}

function renderQuestionItem(q, index, host) {
  if (q.type === "drag") {
    renderDragQuestion(q, index, host);
    return;
  }

  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"})`;
  container.appendChild(header);

  if (q.type === "img" && q.imgDataUrl) {
    const img = document.createElement("img");
    img.src = q.imgDataUrl;
    img.alt = "Bildfr√•ga";
    container.appendChild(img);
  }

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const optionsList = document.createElement("div");
  optionsList.className = "options-list";
  (q.options || []).forEach((opt, optIndex) => {
    const label = document.createElement("label");
    label.className = "option-label";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = `q-${index}`;
    input.value = String(optIndex);
    input.addEventListener("change", () => {
      currentAnswers[index] = optIndex;
    });

    const span = document.createElement("span");
    span.textContent = opt;

    label.appendChild(input);
    label.appendChild(span);
    optionsList.appendChild(label);
  });
  container.appendChild(optionsList);

  host.appendChild(container);
}

function startLevel(level) {
  if (!ensureStudentSet()) return;

  const s = loadState();
  const allQuestions = []
    .concat(s.bank.mcq || [])
    .concat(s.bank.img || [])
    .concat(s.bank.drag || []);

  const pool = allQuestions.filter((q) => (q.level || "E") === level);
  if (!pool.length) {
    alert("Det finns inga fr√•gor p√• denna niv√• √§nnu.");
    return;
  }

  currentLevel = level;
  currentQuestions = shuffle(pool);
  currentAnswers = new Array(currentQuestions.length).fill(null);

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const questionsHost = getEl("questions");

  if (resultSection) resultSection.classList.add("hidden");
  if (playSection) playSection.classList.remove("hidden");
  if (questionsHost) {
    questionsHost.innerHTML = "";
    currentQuestions.forEach((q, idx) => renderQuestionItem(q, idx, questionsHost));
  }

  const title = getEl("play-title");
  const who = getEl("whoPlays");
  if (title) {
    if (level === "E") title.textContent = "Niv√• 1 ‚Äì Grundniv√• (E)";
    else if (level === "C") title.textContent = "Niv√• 2 ‚Äì Mellanniv√• (C)";
    else title.textContent = "Niv√• 3 ‚Äì Avancerad (A)";
  }
  if (who) {
    who.textContent = `${s.student.name} (${s.student.klass})`;
  }

  syncUI();
}

function finishLevel() {
  if (!currentLevel || !currentQuestions.length) {
    alert("Ingen niv√• √§r aktiv.");
    return;
  }

  const s = loadState();
  const goals = normalizeGoalsMap(s);
  let correctCount = 0;
  let pointsGained = 0;
  let allCorrect = true;

  if (!s.progression || typeof s.progression !== "object") {
    s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  }
  s.progression.totalPoints = s.progression.totalPoints || 0;
  s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
  s.progression.correctByGoalId = s.progression.correctByGoalId || {};

  const wrongByGoal = s.progression.wrongByGoalId;
  const correctByGoal = s.progression.correctByGoalId;

  const lvl = currentLevel;
  const basePointsPerQuestion =
    lvl === "A" ? 3 :
    lvl === "C" ? 2 : 1;

  currentQuestions.forEach((q, index) => {
    const ansVal = currentAnswers[index];
    let isCorrect = false;

    if (q.type === "drag") {
      const correctMap = q.correctMap || {};
      const keys = Object.keys(correctMap);
      if (!keys.length) {
        isCorrect = false;
      } else if (!ansVal || typeof ansVal !== "object") {
        isCorrect = false;
      } else {
        let allOk = true;
        for (const itemId of keys) {
          if (!ansVal[itemId] || ansVal[itemId] !== correctMap[itemId]) {
            allOk = false;
            break;
          }
        }
        isCorrect = allOk;
      }
    } else {
      if (ansVal != null) {
        const correctIndex = typeof q.answer === "number" ? q.answer : q.correct;
        isCorrect = ansVal === correctIndex;
      } else {
        isCorrect = false;
      }
    }

    if (isCorrect) {
      correctCount++;
      pointsGained += basePointsPerQuestion;
    } else {
      allCorrect = false;
    }

    const links = getLinksForQuestion(q, goals);
    if (links && links.length) {
      links.forEach((lnk) => {
        const key = String(lnk.id);
        if (isCorrect) correctByGoal[key] = (correctByGoal[key] || 0) + 1;
        else wrongByGoal[key] = (wrongByGoal[key] || 0) + 1;
      });
    }
  });

  const total = currentQuestions.length;
  const percentage = total ? Math.round((correctCount / total) * 100) : 0;
  const threshold = (s.thres && s.thres[lvl] != null) ? s.thres[lvl] : 70;

  if (!s.best) s.best = { E: 0, C: 0, A: 0 };
  if (percentage > (s.best[lvl] || 0)) s.best[lvl] = percentage;

  if (!s.unlocked) s.unlocked = { C: false, A: false };
  if (lvl === "E" && percentage >= threshold) s.unlocked.C = true;
  if (lvl === "C" && percentage >= threshold) s.unlocked.A = true;

  if (total > 0 && allCorrect) pointsGained += 5;

  s.progression.totalPoints += pointsGained;
  const totalPointsAfter = s.progression.totalPoints;

  const nowIso = new Date().toISOString();
  const lastResult = {
    level: lvl,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    timestamp: nowIso
  };
  s.progression.lastResult = lastResult;

  if (!Array.isArray(s.highscores)) s.highscores = [];
  const id = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
  const newEntry = {
    id,
    name: s.student.name || "Elev",
    klass: s.student.klass || "-",
    points: totalPointsAfter,
    level: lvl,
    score: percentage,
    updatedAt: nowIso
  };
  const idx = s.highscores.findIndex((e) => e.id === id);
  if (idx >= 0) {
    if ((newEntry.points || 0) >= (s.highscores[idx].points || 0)) s.highscores[idx] = newEntry;
  } else {
    s.highscores.push(newEntry);
  }

  saveState(s);

  lastSubmission = {
    level: lvl,
    studentName: s.student.name,
    studentClass: s.student.klass,
    timestamp: nowIso,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    answers: currentAnswers.slice(),
    questions: currentQuestions.map((q) => ({
      q: q.q || q.text || "",
      type: q.type || "mcq",
      level: q.level || lvl,
      answer: typeof q.answer === "number" ? q.answer : q.correct,
      goal: q.goal || null,
      parts: q.parts || null
    }))
  };

  const playSection = getEl("play");
  const resultSection = getEl("result");
  if (playSection) playSection.classList.add("hidden");
  if (resultSection) resultSection.classList.remove("hidden");

  const scoreText = getEl("scoreText");
  const scoreDetail = getEl("scoreDetail");
  const resName = getEl("resName");
  const resClass = getEl("resClass");
  const passBadge = getEl("passBadge");
  const unlockText = getEl("unlockText");

  if (scoreText) scoreText.innerHTML = `${percentage}%<span> resultat</span>`;
  if (scoreDetail) {
    scoreDetail.textContent =
      `${correctCount}/${total} r√§tt ‚Äì niv√•po√§ng: +${pointsGained}p, totalt: ${totalPointsAfter}p`;
  }
  if (resName) resName.textContent = s.student.name || "-";
  if (resClass) resClass.textContent = s.student.klass || "-";

  if (passBadge) {
    const passed = percentage >= threshold;
    if (passed) {
      passBadge.className = "badge-pass";
      passBadge.textContent = "Godk√§nd niv√•";
    } else {
      passBadge.className = "badge-fail";
      passBadge.textContent = "Inte godk√§nd √§nnu";
    }
  }

  if (unlockText) {
    let txt = "";
    if (lvl === "E" && s.unlocked.C) txt = "Niv√• 2 (C) √§r nu uppl√•st.";
    else if (lvl === "C" && s.unlocked.A) txt = "Niv√• 3 (A) √§r nu uppl√•st.";
    unlockText.textContent = txt;
  }

  currentLevel = null;
  currentQuestions = [];
  currentAnswers = [];

  updateAllProgressionUI();
  syncUI();
}
</script>
<!-- slut SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->





<!-- start SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->
<script>
"use strict";

(function FV5(){
  /* =========================================================
     5A ‚Äì Bas-hj√§lpare (utan $) + s√§ker rebind
     ========================================================= */

  if (typeof window.getEl !== "function") {
    window.getEl = function getEl(id){ return document.getElementById(id); };
  }

  function _fv5_rebindButton(id, binder){
    const el = getEl(id);
    if (!el || !el.parentNode) return null;
    const clone = el.cloneNode(true);
    el.parentNode.replaceChild(clone, el);
    try{ if (typeof binder === "function") binder(clone); }catch{}
    return clone;
  }

  function _fv5_safeCall(fn, ...args){
    try{ if (typeof fn === "function") return fn(...args); }catch{}
    return undefined;
  }

  function _fv5_getStateSafe(){
    try{ if (typeof window.loadState === "function") return window.loadState(); }catch{}
    return null;
  }

  /* =========================================================
     5B ‚Äì ID-bridge (molnlista) + bankstatus
     ========================================================= */

  function _fv5_bridgeCloudListIds(){
    // Vi √§ndrar INTE layout ‚Äì bara ser till att det finns en list-host som SEKTION 3 hittar.
    try{
      const existing = getEl("cloudBankList");
      const v4 = getEl("cloudBanksListV4");
      const v5 = getEl("cloudBanksListV5");
      if (existing && !v4 && !v5){
        existing.id = "cloudBanksListV4";
      }
    }catch{}
  }

  function _fv5_countLocalBank(){
    const s = _fv5_getStateSafe() || {};
    const b = s.bank || {};
    const mcq = Array.isArray(b.mcq) ? b.mcq.length : 0;
    const img = Array.isArray(b.img) ? b.img.length : 0;
    const drag = Array.isArray(b.drag) ? b.drag.length : 0;
    return { mcq, img, drag, total: mcq + img + drag };
  }

  function updateBankStatusUI(){
    const hostList =
      getEl("cloudBanksListV4") ||
      getEl("cloudBanksListV5") ||
      getEl("cloudBanksList") ||
      getEl("cloudBankList");

    if (!hostList) return;

    const hostCard = hostList.closest(".card") || hostList.parentElement;
    if (!hostCard) return;

    let statusEl = getEl("bankStatus");
    if (!statusEl){
      statusEl = document.createElement("p");
      statusEl.id = "bankStatus";
      statusEl.className = "mini";
      statusEl.style.marginTop = "6px";
    }

    // Placera status precis f√∂re listan
    if (statusEl.parentNode !== hostCard){
      try{ if (statusEl.parentNode) statusEl.parentNode.removeChild(statusEl); }catch{}
      hostCard.insertBefore(statusEl, hostList);
    } else if (statusEl.nextSibling !== hostList){
      hostCard.insertBefore(statusEl, hostList);
    }

    const s = _fv5_getStateSafe() || {};
    const a = s.activeBank || {};
    const counts = _fv5_countLocalBank();

    if (!counts.total){
      statusEl.textContent = "Status: Ingen bank laddad (0 fr√•gor).";
      return;
    }

    const hasCloudActive = !!String(a.bankId || "").trim();
    const bankName = String(a.name || a.bankName || "").trim();

    if (hasCloudActive){
      statusEl.textContent =
        `Status: Moln-bank${bankName ? ` "${bankName}"` : ""} (${String(a.bankId)}) med ${counts.total} fr√•gor ` +
        `(MCQ: ${counts.mcq}, bild: ${counts.img}, drag & drop: ${counts.drag}).`;
    } else {
      statusEl.textContent =
        `Status: Lokal bank (p√• denna enhet) med ${counts.total} fr√•gor ` +
        `(MCQ: ${counts.mcq}, bild: ${counts.img}, drag & drop: ${counts.drag}).`;
    }
  }

  /* =========================================================
     5C ‚Äì L√§rarl√§ge (gate + modal)
     ========================================================= */

  function showTeacherPasswordInStatus(){
    const s = _fv5_getStateSafe() || {};
    const statusEl = getEl("passwordStatus");
    if (!statusEl) return;
    statusEl.textContent = (s.teacherPassword ? `Aktuellt l√§rarl√∂senord: ${s.teacherPassword}` : "");
  }

  function openTeacherGate(){
    const gate = getEl("teacherGate");
    const input = getEl("teacherPasswordInput");
    const text = getEl("teacherGateText");
    const s = _fv5_getStateSafe() || {};

    if (gate) gate.classList.remove("hidden");
    if (input){
      input.value = "";
      input.type = "password";
      input.focus();
    }
    if (text){
      text.textContent = s.teacherPassword
        ? "Ange l√§rarl√∂senord f√∂r att √∂ppna l√§rarl√§get."
        : "F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.";
    }
  }

  function closeTeacherGate(){
    const gate = getEl("teacherGate");
    if (gate) gate.classList.add("hidden");
  }

  function openTeacherModal(){
    const modal = getEl("teacherModal");
    if (modal) modal.classList.remove("hidden");
    _fv5_safeCall(window.tryRefreshRosterTabs, true);
  }

  function closeTeacherModal(){
    const modal = getEl("teacherModal");
    if (modal) modal.classList.add("hidden");
  }

  function handleTeacherConfirm(){
    const input = getEl("teacherPasswordInput");
    const text = getEl("teacherGateText");
    if (!input) return;

    const entered = input.value.trim();
    if (!entered){ alert("Skriv in ett l√∂senord."); return; }

    const s = _fv5_getStateSafe();
    if (!s){ alert("Tekniskt fel: state saknas."); return; }

    if (!s.teacherPassword){
      s.teacherPassword = entered;
      _fv5_safeCall(window.saveState, s);
      showTeacherPasswordInStatus();
      if (text) text.textContent = "L√∂senord sparat. √ñppnar l√§rarl√§ge.";
      closeTeacherGate();
      openTeacherModal();
      return;
    }

    if (s.teacherPassword === entered){
      if (text) text.textContent = "L√∂senord OK. √ñppnar l√§rarl√§ge.";
      closeTeacherGate();
      openTeacherModal();
    } else {
      if (text) text.textContent = "Fel l√∂senord. F√∂rs√∂k igen.";
      input.value = "";
      input.focus();
    }
  }

  /* =========================================================
     5D ‚Äì Flikar (teacher modal) + progress-trigger
     ========================================================= */

  function setupTabNavigation(){
    const tabButtons = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".tab-panel");
    if (!tabButtons.length || !panels.length) return;

    function activateTab(tabId){
      tabButtons.forEach((btn)=>{
        const isActive = btn.getAttribute("data-tab") === tabId;
        btn.classList.toggle("active", isActive);
      });

      panels.forEach((panel)=>{
        const panelId = panel.getAttribute("data-panel");
        panel.classList.toggle("hidden", panelId !== tabId);
      });

      if (tabId === "progress"){
        _fv5_safeCall(window.tryRefreshRosterTabs, true);
      }
    }

    tabButtons.forEach((btn)=>{
      btn.addEventListener("click", ()=>{
        const tabId = btn.getAttribute("data-tab");
        if (!tabId) return;
        activateTab(tabId);
      });
    });

    // Default
    if (document.querySelector('.tab-btn[data-tab="settings"]')) activateTab("settings");
  }

  /* =========================================================
     5E ‚Äì Molnknappar (ladda/spara/login/logout)
     ========================================================= */

  async function _fv5_loadCloudBanksNow(){
    try{
      _fv5_bridgeCloudListIds();
      if (typeof window.initFirebase === "function"){ try{ await window.initFirebase(); }catch{} }

      const fn =
        (typeof window.loadCloudBanksListV5 === "function") ? window.loadCloudBanksListV5 :
        (typeof window.loadCloudBanksListV4 === "function") ? window.loadCloudBanksListV4 :
        (typeof window.loadCloudBanksList === "function") ? window.loadCloudBanksList :
        null;

      if (!fn){
        alert("Molnlist-funktionen saknas (loadCloudBanksListV5/V4). Kontrollera att SEKTION 3 √§r laddad.");
        return;
      }

      await fn();
      updateBankStatusUI();
      _fv5_safeCall(window.tryRefreshRosterTabs, true);
    }catch(e){
      console.error("Kunde inte ladda moln-bankar:", e);
      alert("Kunde inte ladda moln-bankar. Se konsolen.");
    }
  }

  /* =========================================================
     5F ‚Äì initApp + DOMContentLoaded (idempotent)
     ========================================================= */

  async function initApp(){
    if (window.__FANGVAKTAREN_INITAPP_DONE){
      console.log("initApp: hoppar √∂ver (redan initierad)");
      return;
    }
    window.__FANGVAKTAREN_INITAPP_DONE = true;

    console.log("initApp start");

    _fv5_bridgeCloudListIds();

    // Initiera inst√§llningsdelar om de finns
    _fv5_safeCall(window.initTeacherEmailSettings);
    _fv5_safeCall(window.initThresholdSettings);
    _fv5_safeCall(window.initTeacherPasswordSettings);
    showTeacherPasswordInStatus();

    _fv5_safeCall(window.initGoalsMap);
    _fv5_safeCall(window.initQuestionForms);
    _fv5_safeCall(window.initImageQuestionsEditor);
    _fv5_safeCall(window.initDragDropQuestionsEditor);

    setupTabNavigation();

    _fv5_safeCall(window.syncUI);
    updateBankStatusUI();

    /* ---------- Elevyta ---------- */
    _fv5_rebindButton("btnSaveStudent", (b)=>{ if (typeof window.handleSaveStudent==="function") b.addEventListener("click", window.handleSaveStudent); });

    _fv5_rebindButton("start-levelE", (b)=>{ if (typeof window.startLevel==="function") b.addEventListener("click", ()=>window.startLevel("E")); });
    _fv5_rebindButton("start-levelC", (b)=>{ if (typeof window.startLevel==="function") b.addEventListener("click", ()=>window.startLevel("C")); });
    _fv5_rebindButton("start-levelA", (b)=>{ if (typeof window.startLevel==="function") b.addEventListener("click", ()=>window.startLevel("A")); });

    _fv5_rebindButton("btnFinish", (b)=>{ if (typeof window.finishLevel==="function") b.addEventListener("click", window.finishLevel); });

    _fv5_rebindButton("btnBack", (b)=>{
      b.addEventListener("click", ()=>{
        const result = getEl("result");
        const play = getEl("play");
        if (result) result.classList.add("hidden");
        if (play) play.classList.add("hidden");
        const studentCard = getEl("studentCard");
        if (studentCard) studentCard.classList.remove("hidden");
        _fv5_safeCall(window.syncUI);
      });
    });

    _fv5_rebindButton("btnCancel", (b)=>{
      b.addEventListener("click", ()=>{
        try{ window.currentLevel = null; }catch{}
        try{ window.currentQuestions = []; }catch{}
        try{ window.currentAnswers = []; }catch{}
        const play = getEl("play");
        const result = getEl("result");
        if (play) play.classList.add("hidden");
        if (result) result.classList.add("hidden");
        const studentCard = getEl("studentCard");
        if (studentCard) studentCard.classList.remove("hidden");
        _fv5_safeCall(window.syncUI);
      });
    });

    _fv5_rebindButton("btnSubmitGame", (b)=>{
      b.addEventListener("click", async ()=>{
        try{
          if (typeof window.saveCurrentResultToFirestore !== "function") throw new Error("saveCurrentResultToFirestore saknas");
          await window.saveCurrentResultToFirestore();
          alert("Ditt resultat √§r inl√§mnat till l√§raren.");
        }catch(err){
          console.error("Fel vid inl√§mning:", err);
          alert("Kunde inte l√§mna in resultatet. F√∂rs√∂k igen eller kontakta l√§raren.");
        }
      });
    });

    /* ---------- L√§rarl√§ge ---------- */
    _fv5_rebindButton("btnTeacherMode", (b)=> b.addEventListener("click", openTeacherGate));
    _fv5_rebindButton("btnTeacherCancel", (b)=> b.addEventListener("click", closeTeacherGate));
    _fv5_rebindButton("btnTeacherConfirm", (b)=> b.addEventListener("click", handleTeacherConfirm));
    _fv5_rebindButton("btnCloseTeacher", (b)=> b.addEventListener("click", closeTeacherModal));

    /* ---------- Inst√§llningar ---------- */
    _fv5_rebindButton("btnSaveThresholds", (b)=>{
      if (typeof window.handleSaveThresholds === "function"){
        b.addEventListener("click", ()=>{
          window.handleSaveThresholds();
          updateBankStatusUI();
        });
      }
    });

    _fv5_rebindButton("btnSaveTeacherEmail", (b)=>{ if (typeof window.handleSaveTeacherEmail==="function") b.addEventListener("click", window.handleSaveTeacherEmail); });

    _fv5_rebindButton("btnChangeTeacherPassword", (b)=>{
      if (typeof window.handleChangeTeacherPassword === "function"){
        b.addEventListener("click", ()=>{
          window.handleChangeTeacherPassword();
          showTeacherPasswordInStatus();
        });
      }
    });

    /* ---------- Delm√•l/delbitar ---------- */
    _fv5_rebindButton("btnAddGoalPart", (b)=>{ if (typeof window.handleAddGoalPart==="function") b.addEventListener("click", window.handleAddGoalPart); });
    _fv5_rebindButton("btnSaveGoalsMap", (b)=>{ if (typeof window.handleSaveGoalsMap==="function") b.addEventListener("click", window.handleSaveGoalsMap); });
    _fv5_rebindButton("btnClearGoalsMap", (b)=>{ if (typeof window.handleClearGoalsMap==="function") b.addEventListener("click", window.handleClearGoalsMap); });

    /* ---------- Rensa ---------- */
    _fv5_rebindButton("btnClearStudentData", (b)=>{ if (typeof window.handleClearStudentData==="function") b.addEventListener("click", window.handleClearStudentData); });
    _fv5_rebindButton("btnResetGameData", (b)=>{ if (typeof window.handleResetGameData==="function") b.addEventListener("click", window.handleResetGameData); });

    /* ---------- Moln / Firebase ---------- */
    _fv5_rebindButton("btnLoadCloudBanks", (b)=> b.addEventListener("click", _fv5_loadCloudBanksNow));

    _fv5_rebindButton("btnSaveToCloud", (b)=>{
      b.addEventListener("click", async ()=>{
        try{
          if (typeof window.handleSaveToCloud !== "function") throw new Error("handleSaveToCloud saknas (SEKTION 3?)");
          await window.handleSaveToCloud();
          await _fv5_loadCloudBanksNow();
        }catch(err){
          console.error("Spara bank misslyckades:", err);
          alert("Kunde inte spara bank till molnet. Se konsolen.");
        }
      });
    });

    _fv5_rebindButton("btnExportBank", (b)=>{ if (typeof window.handleExportBank==="function") b.addEventListener("click", ()=>{ window.handleExportBank(); updateBankStatusUI(); }); });

    const fileImport = getEl("fileImport");
    if (fileImport && !fileImport.__fv5Bound){
      fileImport.__fv5Bound = true;
      if (typeof window.handleImportBank === "function"){
        fileImport.addEventListener("change", (evt)=>{ window.handleImportBank(evt); updateBankStatusUI(); });
      }
    }

    _fv5_rebindButton("btnGooglePlaceholder", (b)=>{ if (typeof window.handleGoogleLogin==="function") b.addEventListener("click", window.handleGoogleLogin); });
    _fv5_rebindButton("btnGoogleLogout", (b)=>{ if (typeof window.handleGoogleLogout==="function") b.addEventListener("click", window.handleGoogleLogout); });

    _fv5_rebindButton("btnPublishSharedBank", (b)=>{ if (typeof window.handlePublishSharedBank==="function") b.addEventListener("click", window.handlePublishSharedBank); });

    console.log("initApp klar ‚Äì knappar kopplade");
  }

  // Exponera (om andra sektioner vill kalla)
  window.updateBankStatusUI = updateBankStatusUI;
  window.openTeacherGate = openTeacherGate;
  window.closeTeacherGate = closeTeacherGate;
  window.openTeacherModal = openTeacherModal;
  window.closeTeacherModal = closeTeacherModal;
  window.handleTeacherConfirm = handleTeacherConfirm;
  window.initApp = initApp;

  document.addEventListener("DOMContentLoaded", function(){
    if (window.__FANGVAKTAREN_DOMREADY_DONE) return;
    window.__FANGVAKTAREN_DOMREADY_DONE = true;

    // Init Firebase om SEKTION 3 finns
    if (typeof window.initFirebase === "function"){
      try{
        if (!window.__FANGVAKTAREN_FIREBASE_INIT_DONE){
          window.__FANGVAKTAREN_FIREBASE_INIT_DONE = true;
          window.initFirebase();
        }
      }catch(e){
        console.error("Fel vid initFirebase:", e);
      }
    }

    try{ initApp(); }
    catch(e){ console.error("Fel vid initApp:", e); }
  });

})(); // FV5
</script>
<!-- slut SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->









<!-- start SEKTION 6: AVSLUTANDE TAGGAR -->
</body>
</html>
<!-- slut SEKTION 6: AVSLUTANDE TAGGAR -->
