<!-- start SEKTION 1: HEAD & STIL -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>F√•ngvaktaren ‚Äì Progressionsspel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --accent-e:#b45309;
      --accent-c:#2563eb;
      --accent-a:#7c3aed;
      --accent-danger:#ef4444;
      --accent-info:#38bdf8;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --chip:#020617;
    }

    *{box-sizing:border-box;}

    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#020617 0,#020617 40%,#000 100%);
      color:var(--text);
    }

    body{
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:960px;
      margin:0 auto;
      min-height:100vh;
      padding:12px 12px 32px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(15,23,42,.85));
      border:1px solid #1f2937;
      box-shadow:0 0 40px rgba(15,23,42,.9);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(10px);
    }

    .header-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .title-block h1{
      margin:0;
      font-size:1.2rem;
      letter-spacing:.03em;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:999px;
      background:radial-gradient(circle,var(--accent-e),#111827);
      color:#fff;
      font-weight:700;
      font-size:.9rem;
      box-shadow:0 0 12px rgba(180,83,9,.8);
    }

    /* ---------- Buttons ---------- */

    .btn{
      --btn-bg:#111827;
      --btn-border:rgba(75,85,99,.9);
      border-radius:999px;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      padding:6px 12px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
      transition:
        background-color .15s ease,
        border-color .15s ease,
        box-shadow .18s ease,
        transform .12s ease,
        opacity .15s ease;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 0 0 rgba(59,130,246,0);
    }

    .btn-sm{
      padding:5px 10px;
      font-size:.8rem;
    }

    .btn-primary{
      --btn-bg:linear-gradient(135deg,var(--accent-e),var(--accent-c));
      --btn-border:rgba(96,165,250,.9);
      color:#f9fafb;
      box-shadow:
        0 0 0 1px rgba(148,163,184,.4),
        0 0 18px rgba(56,189,248,.45);
    }

    .btn-danger{
      --btn-bg:rgba(127,29,29,.95);
      --btn-border:rgba(239,68,68,.9);
      box-shadow:
        0 0 0 1px rgba(248,113,113,.5),
        0 0 14px rgba(248,113,113,.4);
    }

    .btn-secondary{
      --btn-bg:#020617;
      --btn-border:rgba(75,85,99,.8);
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(148,163,184,.6),
        0 0 24px rgba(59,130,246,.55);
      opacity:.97;
    }

    .btn:active{
      transform:translateY(0);
      box-shadow:
        0 0 0 1px rgba(107,114,128,.8),
        0 0 12px rgba(37,99,235,.45);
      opacity:.92;
    }

    .btn:disabled,
    .btn[disabled]{
      opacity:.45;
      cursor:default;
      box-shadow:
        0 0 0 1px rgba(31,41,55,1),
        0 0 0 rgba(0,0,0,0);
      transform:none;
    }

    /* Spara elev ‚Äì tydlig gr√∂n, fyllig knapp */
    #btnSaveStudent{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      border-color:rgba(34,197,94,1);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 20px rgba(34,197,94,.75);
    }

    #btnSaveStudent:hover{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 26px rgba(34,197,94,.9);
      transform:translateY(-1px);
    }

    #btnSaveStudent:active{
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 14px rgba(34,197,94,.8);
      transform:translateY(0);
    }

    #btnSaveStudent:disabled{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      opacity:.45;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 0 rgba(0,0,0,0);
    }

    /* L√§rarl√§ge ‚Äì m√∂rk bakgrund, gr√∂n kontur (outline-knapp) */
    #btnTeacherMode{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherMode:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherMode:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* L√∂senords-popup: ‚ÄúForts√§tt‚Äù ‚Äì samma gr√∂na kontur som l√§rarl√§ge */
    #btnTeacherConfirm{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherConfirm:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherConfirm:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* Spara niv√•gr√§nser ‚Äì gr√∂n kontur, samma stil */
    #btnSaveThresholds{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnSaveThresholds:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnSaveThresholds:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* ---------- Layout helpers ---------- */

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1 1 120px;
      min-width:0;
    }

    label{
      font-size:.7rem;
      color:var(--muted);
    }

    .small-label{
      font-size:.7rem;
      color:var(--muted);
    }

    .input,
    .input-number{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:.8rem;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }

    .input-number{
      appearance:textfield;
      -moz-appearance:textfield;
    }

    .input-number::-webkit-outer-spin-button,
    .input-number::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    .input:focus,
    .input-number:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
      background:#020617;
    }

    .mini{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.4;
    }

    .hidden{
      display:none !important;
    }

    /* ---------- Elevkort ---------- */

    .student-card{
      background:radial-gradient(circle at top left,#020617,#020617 55%,#000 100%);
      border-radius:16px;
      padding:12px 12px 14px;
      border:1px solid rgba(31,41,55,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .student-main-row{
      align-items:flex-end;
    }

    .student-save-field{
      max-width:180px;
    }

    .student-status-row{
      margin-top:2px;
    }

    .student-saved-label{
      font-size:.75rem;
      color:var(--muted);
    }

    .student-stats-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
    }

    .score-box{
      flex:1 1 160px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 55%,#000 100%);
      display:flex;
      flex-direction:column;
      gap:2px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 20px rgba(56,189,248,.4),
        0 12px 28px rgba(15,23,42,.9);
    }

    .score-label{
      font-size:.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .score-value{
      font-size:1rem;
      font-weight:600;
    }

    /* ---------- Niv√•-kort ---------- */

    .levels-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }

    .level-card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.9);
    }

    .level-card.locked{
      opacity:.7;
      filter:saturate(.7);
    }

    .level-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .level-title span:first-child{
      font-weight:600;
      font-size:.9rem;
    }

    .level-title small{
      display:block;
      font-size:.7rem;
      color:var(--muted);
    }

    .level-body{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:.78rem;
    }

    .level-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-top:4px;
    }

    .badge{
      border-radius:999px;
      padding:2px 8px;
      font-size:.7rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
    }

    .badge-lock{
      color:#fbbf24;
      border-color:rgba(245,158,11,.7);
      box-shadow:0 0 12px rgba(245,158,11,.35);
    }

    .badge-ok{
      color:#4ade80;
      border-color:rgba(74,222,128,.9);
      box-shadow:0 0 16px rgba(22,163,74,.65);
    }

    .badge-pass{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 18px rgba(22,163,74,.7);
    }

    .badge-fail{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#991b1b,#ef4444);
      color:#fee2e2;
      box-shadow:
        0 0 0 1px rgba(127,29,29,1),
        0 0 18px rgba(248,113,113,.7);
    }

    /* ---------- Spelpanel / Resultat ---------- */

    .play-panel,
    .result-panel{
      margin-top:8px;
      padding:10px 10px 12px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
    }

    .play-header,
    .result-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .questions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:4px;
    }

    .question{
      padding:8px 9px;
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top left,#020617,#020617 60%,#020617 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 26px rgba(15,23,42,.9);
      font-size:.85rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .q-text{
      font-size:.85rem;
      margin-top:2px;
    }

    .options-list{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:2px;
    }

    .option-label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
      padding:4px 6px;
      border-radius:999px;
      background:#020617;
      border:1px solid rgba(31,41,55,1);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,transform .1s ease;
    }

    .option-label input{
      accent-color:var(--accent-c);
    }

    .option-label:hover{
      background:#020617;
      border-color:rgba(59,130,246,.7);
      box-shadow:
        0 0 0 1px rgba(59,130,246,.9),
        0 0 16px rgba(37,99,235,.6);
      transform:translateY(-1px);
    }

    .play-footer{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:.75rem;
    }

    .play-actions{
      display:flex;
      gap:6px;
    }

    .score{
      font-size:1.6rem;
      font-weight:700;
    }

    .score span{
      font-size:.8rem;
      font-weight:400;
      margin-left:4px;
      color:var(--muted);
    }

    .result-meta{
      font-size:.78rem;
      color:var(--muted);
      margin-top:2px;
    }

    .result-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ---------- Modal & gate ---------- */

    .gate-backdrop,
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
      backdrop-filter:blur(10px);
    }

    .gate-box{
      width:100%;
      max-width:320px;
      padding:14px 14px 16px;
      border-radius:16px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:.85rem;
    }

    .gate-actions{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }

    .modal{
      width:100%;
      max-width:980px;
      max-height:90vh;
      padding:12px 12px 14px;
      border-radius:18px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:4px;
    }

    .modal-body{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding-right:2px;
    }

    /* ---------- Flikar ---------- */

    .tab-nav{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
    }

    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(55,65,81,1);
      padding:4px 9px;
      font-size:.75rem;
      background:#020617;
      color:var(--muted);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,color .15s ease;
    }

    .tab-btn.active{
      color:#e5e7eb;
      border-color:rgba(96,165,250,1);
      background:linear-gradient(135deg,#0369a1,#4f46e5);
      box-shadow:
        0 0 0 1px rgba(37,99,235,1),
        0 0 20px rgba(56,189,248,.7);
    }

    .tab-panel{
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 16px 34px rgba(15,23,42,.95);
    }

    /* ---------- Cards & grids ---------- */

    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px 10px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.95);
      font-size:.82rem;
    }

    .card-full-width{
      grid-column:1/-1;
    }

    .card-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }

    .questions-editor{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .goals-list,
    .question-list{
      list-style:none;
      padding:0;
      margin:4px 0 0;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.8rem;
    }

    .question-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      flex-direction:column;
      gap:4px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    /* St√∂d f√∂r "list-item" (anv√§nds i SEKTION 3 f√∂r listor) */
    .list-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    .list-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1 1 auto;
    }

    .q-meta{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.35;
    }

    .question-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:2px;
    }

    .img-preview-box{
      border-radius:10px;
      border:1px dashed rgba(55,65,81,1);
      padding:6px;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .img-preview-box img{
      max-width:100%;
      border-radius:8px;
    }

    .img-thumb{
      width:64px;
      height:44px;
      border-radius:8px;
      border:1px solid rgba(31,41,55,1);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#020617;
      margin-right:6px;
    }

    .img-thumb img{
      max-width:100%;
      max-height:100%;
      object-fit:cover;
    }

    .question-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .chip{
      border-radius:999px;
      padding:3px 8px;
      font-size:.75rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 6px 14px rgba(15,23,42,.85);
    }

    /* Elevprogression ‚Äì rutorna staplas p√• h√∂jden (en kolumn) */
    .progress-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }

    .progress-box{
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 24px rgba(15,23,42,.9);
      font-size:.8rem;
    }

    .mini-card{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      padding:6px 7px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .mini-title{
      font-size:.82rem;
      font-weight:600;
    }

    /* ---------- GDPR: Modal f√∂r elevlista/tokens (endast id-bundet) ---------- */

    #bankRosterModal,
    #rosterViewerModal{
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(15,23,42,.78);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      backdrop-filter:blur(10px);
    }

    #bankRosterModal.hidden,
    #rosterViewerModal.hidden{
      display:none !important;
    }

    #bankRosterModal .card,
    #rosterViewerModal .card{
      width:min(980px,100%);
      max-height:88vh;
      overflow:auto;
      padding:12px 12px 14px;
      border-radius:18px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
    }

    #bankRosterModal .card h3,
    #rosterViewerModal .card h3{
      margin:0;
      font-size:.95rem;
      letter-spacing:.01em;
    }

    #bankRosterModal .input,
    #bankRosterModal .textarea,
    #rosterViewerModal .input,
    #rosterViewerModal .textarea{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      color:var(--text);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1);
    }

    #bankRosterModal .textarea,
    #rosterViewerModal .textarea{
      width:100%;
      padding:8px 10px;
      min-height:90px;
      resize:vertical;
      font-size:.8rem;
      outline:none;
    }

    #bankRosterModal .textarea:focus,
    #rosterViewerModal .textarea:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
    }

    /* Roster-lista: b√§ttre radlayout p√• sm√• sk√§rmar */
    #bankRosterModal #rosterRows .card-row{
      align-items:center;
      padding:6px 0;
      border-top:1px solid rgba(31,41,55,.7);
    }

    #bankRosterModal #rosterRows .card-row:first-child{
      border-top:none;
    }

    #bankRosterModal #rosterRows .btn.btn-danger{
      border-radius:12px;
    }

    @media (max-width:640px){
      #bankRosterModal .card,
      #rosterViewerModal .card{
        max-height:92vh;
        padding:10px;
      }
      #bankRosterModal #rosterRows .card-row > *{
        flex:1 1 100% !important;
      }
      #bankRosterModal #rosterRows .card-row div[style*="flex:0 0 160px"]{
        flex:1 1 100% !important;
        justify-content:flex-start !important;
      }
    }

    /* ---------- Responsivitet ---------- */

    @media (max-width:640px){
      .app{
        padding:8px 8px 24px;
      }
      .app-header{
        padding:8px 9px;
      }
      .levels-grid{
        grid-template-columns:1fr;
      }
      .play-header,
      .result-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .play-footer{
        flex-direction:column;
        align-items:flex-start;
      }
      .modal{
        padding:10px;
      }
    }

    /* ---------- F√§rger f√∂r niv√•kort (E / C / A) ---------- */

    #card-levelE{
      background:radial-gradient(circle at top,#ea580c,#b45309 55%,#020617 100%);
      border-color:rgba(234,88,12,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(234,88,12,.9);
    }

    #card-levelC{
      background:radial-gradient(circle at top,#1d4ed8,#1e40af 55%,#020617 100%);
      border-color:rgba(37,99,235,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(37,99,235,.9);
    }

    #card-levelA{
      background:radial-gradient(circle at top,#7c3aed,#6d28d9 55%,#020617 100%);
      border-color:rgba(124,58,237,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(124,58,237,.9);
    }
  </style>
</head>
<!-- slut SEKTION 1: HEAD & STIL -->










<!-- start SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->
<!-- √ÑNDRING: Lade in ‚ÄúElever som spelat (aktiv bank)‚Äù som en lista i Elevprogression-rutan (utan att √§ndra layouten i √∂vrigt). (11 rader) -->
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <h1><span class="logo">F</span>F√•ngvaktaren</h1>
      </div>
      <button id="btnTeacherMode" class="btn btn-sm btn-primary">üîë L√§rarl√§ge</button>
    </header>

    <!-- Elevkort / namn, klass, po√§ng, highscore -->
    <section id="studentCard" class="student-card">
      <div class="row student-main-row">
        <div class="field">
          <label for="studentName">Namn</label>
          <input id="studentName" class="input" placeholder="Elevens namn..." autocomplete="off" />
        </div>
        <div class="field">
          <label for="studentClass">Klass</label>
          <input id="studentClass" class="input" placeholder="Klass..." autocomplete="off" />
        </div>
        <div class="field student-save-field">
          <label>&nbsp;</label>
          <button id="btnSaveStudent" class="btn btn-sm btn-primary" style="width:100%;">üíæ Spara elev</button>
        </div>
      </div>

      <div class="student-status-row">
        <span id="studentSaved" class="student-saved-label">Ej sparad elev</span>
      </div>

      <div class="student-stats-row">
        <div class="score-box glow-box">
          <div class="score-label">Po√§ng</div>
          <div class="score-value" id="studentPointsValue">0 p</div>
        </div>
        <div class="score-box glow-box">
          <div class="score-label">Highscore</div>
          <div class="score-value" id="highscoreSummary">
            Ingen highscore √§nnu.
          </div>
        </div>
      </div>
    </section>

    <!-- Niv√•kort -->
    <section class="levels-grid">
      <article id="card-levelE" class="level-card level-e locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 1</span>
            <small>Grundniv√• ‚Äì E</small>
          </div>
          <span id="badge-levelE" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelE">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelE">70</span>%</span>
          <span class="mini">L√•ses upp n√§r eleven sparat namn & klass.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• E-niv√•.</div>
          <button id="start-levelE" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 1</button>
        </div>
      </article>

      <article id="card-levelC" class="level-card level-c locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 2</span>
            <small>Mellanniv√• ‚Äì C</small>
          </div>
          <span id="badge-levelC" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelC">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelC">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 1 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• C-niv√•.</div>
          <button id="start-levelC" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 2</button>
        </div>
      </article>

      <article id="card-levelA" class="level-card level-a locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 3</span>
            <small>Avancerad ‚Äì A</small>
          </div>
          <span id="badge-levelA" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelA">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelA">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 2 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• A-niv√•.</div>
          <button id="start-levelA" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 3</button>
        </div>
      </article>
    </section>

    <!-- Spelpanel -->
    <section id="play" class="play-panel hidden">
      <header class="play-header">
        <div>
          <h2 id="play-title">Aktiv niv√•</h2>
          <small id="whoPlays">Ingen elev vald.</small>
        </div>
        <button id="btnCancel" class="btn btn-sm">‚¨ÖÔ∏è Avsluta utan att l√§mna in</button>
      </header>
      <div id="questions" class="questions">
        <div class="question mini">V√§lj en niv√• f√∂r att b√∂rja.</div>
      </div>
      <footer class="play-footer">
        <div class="mini">
          Svar registreras n√§r du klickar i alternativen eller sl√§pper kort i r√§tt ruta.
        </div>
        <div class="play-actions">
          <button id="btnSpeakQuestion" class="btn btn-sm">üîä L√§s upp fr√•gan</button>
          <button id="btnFinish" class="btn btn-sm btn-primary">‚úÖ L√§mna in niv√•</button>
        </div>
      </footer>
    </section>

    <!-- Resultatpanel -->
    <section id="result" class="result-panel hidden">
      <header class="result-header">
        <div>
          <div class="score" id="scoreText">0%<span> resultat</span></div>
          <div id="scoreDetail" class="result-meta">0/0 po√§ng</div>
          <div class="result-meta">
            Elev: <span id="resName">-</span> (<span id="resClass">-</span>)
          </div>
        </div>
        <div>
          <div id="passBadge" class="badge-fail">Resultat</div>
          <div id="unlockText" class="result-meta"></div>
        </div>
      </header>

      <div class="result-actions" id="resultActionsNormal">
        <button id="btnBack" class="btn btn-sm">‚¨ÖÔ∏è Tillbaka till niv√•er</button>
        <button id="btnSubmitGame" class="btn btn-sm btn-primary">‚úâÔ∏è L√§mna in spel f√∂r po√§ng</button>
      </div>
    </section>
  </div>

  <!-- Embedded grundbank (kan vara tom eller kort) -->
  <script id="embedded-data" type="application/json">
  {
    "bank": {
      "mcq": [
        {
          "level": "E",
          "type": "mcq",
          "q": "Vad √§r viktigast f√∂rst n√§r du kommer till k√∂ket?",
          "options": ["Ta p√• f√∂rkl√§de", "Tv√§tta h√§nderna", "S√§tta p√• ugnen", "Smaka p√• maten"],
          "answer": 1
        },
        {
          "level": "C",
          "type": "mcq",
          "q": "En g√§st klagar p√• kall mat. Vad √§r ett bra f√∂rsta steg?",
          "options": ["Ignorera g√§sten", "Skylla p√• k√∂ket", "Be om urs√§kt och erbjuda l√∂sning", "S√§ga att det inte √§r ditt fel"],
          "answer": 2
        },
        {
          "level": "A",
          "type": "mcq",
          "q": "Du planerar en buff√©. Vad √§r viktigast f√∂r s√§ker livsmedelshantering?",
          "options": ["Att det ser fint ut", "Att alla r√§tter √§r varma samtidigt", "R√§tt temperaturer och tidsgr√§nser", "Att det finns m√•nga olika r√§tter"],
          "answer": 2
        }
      ]
    }
  }
  </script>

  <!-- L√§rarl√§ge ‚Äì Gate -->
  <div id="teacherGate" class="gate-backdrop hidden">
    <div class="gate-box">
      <h2>üîë L√§rarl√§ge</h2>
      <p id="teacherGateText">
        Ange l√§rarl√∂senord. F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.
      </p>
      <input id="teacherPasswordInput" class="input" type="password" placeholder="L√∂senord..." />
      <div class="gate-actions">
        <button id="btnTeacherCancel" class="btn btn-sm">Avbryt</button>
        <button id="btnTeacherConfirm" class="btn btn-sm btn-primary">Forts√§tt</button>
      </div>
    </div>
  </div>

  <!-- L√§rarl√§ge ‚Äì Modal -->
  <div id="teacherModal" class="modal-backdrop hidden">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h2>L√§rarl√§ge ‚Äì F√•ngvaktaren</h2>
          <small>Hantera inst√§llningar, fr√•gebank, bildfr√•gor, drag & drop, export och elevprogression.</small>
        </div>
        <button id="btnCloseTeacher" class="btn btn-sm">St√§ng</button>
      </header>

      <div class="modal-body">
        <!-- Flikar -->
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="settings" id="tab-settings">‚öôÔ∏è Inst√§llningar</button>
          <button class="tab-btn" data-tab="questions" id="tab-questions">üÖ∞Ô∏è Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="images" id="tab-images">üñºÔ∏è Bildfr√•gor</button>
          <button class="tab-btn" data-tab="dragdrop" id="tab-dragdrop">üéØ Drag & Drop</button>
          <button class="tab-btn" data-tab="progress" id="tab-progress">üìà Elevprogression</button>
          <button class="tab-btn" data-tab="bank" id="tab-bank">üóÇÔ∏è Fr√•gebank</button>
        </nav>

        <div class="tab-content">
          <!-- Inst√§llningar -->
          <section class="tab-panel" data-panel="settings">
            <div class="settings-grid">
              <div class="card">
                <h3>L√§rarl√∂senord</h3>
                <p>Det l√∂senord du anv√§nder f√∂r att √∂ppna l√§rarl√§get. H√§r kan du byta det.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputOldPassword">Nuvarande l√∂senord</label>
                    <input id="inputOldPassword" class="input" type="password" placeholder="L√§mna tomt om inget satt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPassword">Nytt l√∂senord</label>
                    <input id="inputNewPassword" class="input" type="password" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPasswordRepeat">Upprepa nytt l√∂senord</label>
                    <input id="inputNewPasswordRepeat" class="input" type="password" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnChangeTeacherPassword" class="btn btn-sm">üîê Spara nytt l√∂senord</button>
                </div>
                <p id="passwordStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Google-inloggning & uppladdning (l√§rare)</h3>
                <p>
                  Logga in med ditt Google-konto f√∂r att spara och ladda fr√•gebanker via Firebase.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label">Status</label>
                    <p id="googleStatus" class="mini">‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.</p>
                  </div>
                  <div class="field">
                    <button id="btnGooglePlaceholder" class="btn btn-sm" type="button">
                      üîó Logga in med Google
                    </button>
                  </div>
                  <div class="field">
                    <button id="btnGoogleLogout" class="btn btn-sm hidden" type="button">
                      üö™ Logga ut fr√•n Google
                    </button>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Gr√§ns f√∂r godk√§nt per niv√•</h3>
                <p>Justera procentgr√§ns f√∂r E, C och A. Anv√§nds som riktm√§rke f√∂r ‚ÄùGodk√§nd niv√•‚Äù.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputThresE">Niv√• 1 (E)</label>
                    <input id="inputThresE" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresC">Niv√• 2 (C)</label>
                    <input id="inputThresC" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresA">Niv√• 3 (A)</label>
                    <input id="inputThresA" type="number" min="0" max="100" class="input-number" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveThresholds" class="btn btn-sm btn-primary">üíæ Spara niv√•-gr√§nser</button>
                </div>
              </div>

              <div class="card">
                <h3>L√§rarens e-post</h3>
                <p>
                  Anv√§nds som mottagare n√§r eleven l√§mnar in resultat via e-post
                  (‚ÄùSkapa e-post‚Äù p√• Elevresultat/JSON).
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputTeacherEmail">E-postadress</label>
                    <input id="inputTeacherEmail" class="input" placeholder="namn@skola.se" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveTeacherEmail" class="btn btn-sm">üíæ Spara e-postadress</button>
                </div>
                <p id="teacherEmailStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Elevdata p√• denna enhet</h3>
                <p class="mini">
                  Dessa knappar p√•verkar bara den h√§r datorn/surfplattan. Anv√§nd dem n√§r du vill nollst√§lla progression lokalt.
                </p>
                <div class="card-row" style="margin-top:6px;gap:8px;flex-wrap:wrap;">
                  <button id="btnClearStudentData" class="btn btn-sm btn-danger" type="button">
                    üßπ Rensa elev + progression
                  </button>
                  <button id="btnResetGameData" class="btn btn-sm" type="button">
                    ‚ôªÔ∏è Nollst√§ll spelpo√§ng
                  </button>
                </div>
                <p id="resetStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Koppling: delm√•l & delbitar</h3>
                <p>
                  Skriv ett delm√•l och en delbit i taget. Klicka p√• ‚ÄùL√§gg till delbit‚Äù
                  f√∂r att l√§gga till i listan. ‚ÄùSpara‚Äù skriver listan till spelets minne
                  (localStorage). ‚ÄùTa bort alla‚Äù rensar listan.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputGoalSingle">Delm√•l</label>
                    <input id="inputGoalSingle" class="input" placeholder="t.ex. Delm√•l 5 ‚Äì Hygien i k√∂ket" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputPartSingle">Delbit</label>
                    <input id="inputPartSingle" class="input" placeholder="t.ex. 51‚Äì60 eller 51,52,53" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnAddGoalPart" class="btn btn-sm">‚ûï L√§gg till delbit</button>
                </div>
                <p id="goalsStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card card-full-width">
                <h3>Aktuella delm√•l och delbitar</h3>
                <p class="mini">Nedan visas de delm√•l och delbitar som √§r sparade i spelet just nu.</p>
                <ul id="goalsList" class="goals-list"></ul>
              </div>
            </div>
          </section>

          <!-- Flervalsfr√•gor -->
          <section class="tab-panel hidden" data-panel="questions">
            <div class="questions-editor">
              <h3>Hantera flervalsfr√•gor (MCQ)</h3>
              <p class="mini">
                L√§gg till nya flervalsfr√•gor, redigera eller importera m√•nga p√• en g√•ng.
              </p>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Snabbimport av flervalsfr√•gor</h3>
                <p class="mini">
                  Klistra in fr√•gor i formatet nedan. En asterisk (*) framf√∂r r√§tt svar.
                  En tom rad mellan fr√•gorna √§r bra men inte ett krav.
                </p>
                <pre class="mini" style="background:#020617;border-radius:6px;padding:8px;margin-top:4px;white-space:pre-wrap;">
Vilken av dessa √§r en proteink√§lla?
*Kycklingfil√©
√Ñpple
Gurka
P√§ron

Vilken av dessa √§r en frukt?
√Ñpple
*P√§ron
Potatis
Gurka
                </pre>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqJsonLevel">Niv√•</label>
                    <select id="mcqJsonLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqJsonGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqJsonGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <textarea
                  id="mcqJsonInput"
                  class="input"
                  rows="8"
                  placeholder="Klistra in dina fr√•gor h√§r..."
                  style="margin-top:8px;font-family:monospace;border-radius:6px;"
                ></textarea>
                <div style="margin-top:8px;display:flex;justify-content:flex-end;">
                  <button id="btnMcqJsonImport" class="btn btn-sm btn-primary" type="button">
                    üì• Importera fr√•gor fr√•n text
                  </button>
                </div>
              </div>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqLevel">Niv√•</label>
                    <select id="mcqLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqQuestion">Fr√•getext</label>
                    <input id="mcqQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="0" id="mcqCorrect0" style="margin-right:4px;" />
                      Alternativ 1
                    </label>
                    <input id="mcqOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="1" id="mcqCorrect1" style="margin-right:4px;" />
                      Alternativ 2
                    </label>
                    <input id="mcqOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="2" id="mcqCorrect2" style="margin-right:4px;" />
                      Alternativ 3
                    </label>
                    <input id="mcqOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="3" id="mcqCorrect3" style="margin-right:4px;" />
                      Alternativ 4
                    </label>
                    <input id="mcqOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="mcqAnswer">Korrekt svar (Index)</label>
                    <input id="mcqAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnMcqAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till fr√•ga</button>
                    <button id="btnMcqUpdate" class="btn btn-sm hidden" type="button">üíæ Spara √§ndring</button>
                  </div>
                  <button id="btnMcqClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella flervalsfr√•gor (<span id="mcqCount">0</span> st)</h3>
                <ul id="mcqList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Bildfr√•gor -->
          <section class="tab-panel hidden" data-panel="images">
            <div class="questions-editor">
              <h3>Hantera bildfr√•gor (IMG)</h3>
              <p class="mini">L√§gg till fr√•gor d√§r en bild visas tillsammans med flervalsalternativ.</p>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera bildfr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgLevel">Niv√•</label>
                    <select id="imgLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgQuestion">Fr√•getext</label>
                    <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgFile">Bildfil</label>
                    <input id="imgFile" type="file" accept="image/*" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">F√∂rhandsvisning</label>
                    <div id="imgPreview" class="img-preview-box mini">Ingen bild vald √§nnu.</div>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="0" id="imgCorrect0" style="margin-right:4px;" />
                      Alternativ 1
                    </label>
                    <input id="imgOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="1" id="imgCorrect1" style="margin-right:4px;" />
                      Alternativ 2
                    </label>
                    <input id="imgOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="2" id="imgCorrect2" style="margin-right:4px;" />
                      Alternativ 3
                    </label>
                    <input id="imgOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="3" id="imgCorrect3" style="margin-right:4px;" />
                      Alternativ 4
                    </label>
                    <input id="imgOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="imgAnswer">Korrekt svar (Index)</label>
                    <input id="imgAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="imgGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnImgAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till bildfr√•ga</button>
                  </div>
                  <button id="btnImgClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
                <ul id="imgList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Drag & Drop (komprimerad bygg-ruta) -->
          <section class="tab-panel hidden" data-panel="dragdrop">
            <div class="questions-editor">
              <h3>Hantera Drag &amp; Drop-fr√•gor</h3>
              <p class="mini">Skapa korta fr√•gor d√§r eleverna drar ord/begrepp till r√§tt kolumn.</p>

              <div class="card" style="margin-top:10px;max-width:720px;margin-left:auto;margin-right:auto;padding:10px;">
                <h4>Bygg fr√•ga (kompakt)</h4>
                <div class="card-row" style="margin-top:6px;">
                  <div class="field" style="flex:0 0 90px;">
                    <label class="small-label" for="dragLevel">Niv√•</label>
                    <select id="dragLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragQuestion">Instruktion</label>
                    <input id="dragQuestion" class="input" placeholder="Ex: Dra r√§tt livsmedel till 'Kylvara'." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragColumn1">Kolumn 1</label>
                    <input id="dragColumn1" class="input" placeholder="t.ex. Kylvara" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragColumn2">Kolumn 2</label>
                    <input id="dragColumn2" class="input" placeholder="t.ex. Torrvara" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragItemText">Objekt att dra</label>
                    <input id="dragItemText" class="input" placeholder="t.ex. 'R√• kyckling'" />
                  </div>
                  <div class="field" style="flex:0 0 140px;">
                    <label class="small-label" for="dragItemCorrect">Korrekt kolumn</label>
                    <select id="dragItemCorrect" class="input">
                      <option value="0">Kolumn 1</option>
                      <option value="1">Kolumn 2</option>
                    </select>
                  </div>
                  <div class="field" style="flex:0 0 110px;">
                    <label class="small-label">&nbsp;</label>
                    <button id="btnDragAddItem" class="btn btn-sm btn-primary" type="button" style="width:100%;">‚ûï L√§gg till</button>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label">Objekt i denna fr√•ga</label>
                    <ul id="dragItemsPreview" class="question-list"></ul>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="dragGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;justify-content:space-between;">
                  <div>
                    <button id="btnDragAddQuestion" class="btn btn-sm btn-primary" type="button">üíæ Spara fr√•ga</button>
                  </div>
                  <button id="btnDragClearForm" class="btn btn-sm btn-secondary" type="button">
                    Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:10px;">
                <h3>Aktuella Drag &amp; Drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
                <ul id="dragList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Elevprogression ‚Äì 4 rutor -->
          <section class="tab-panel hidden" data-panel="progress">
            <div class="card">
              <h3>Elevprogression</h3>
              <p class="mini">
                H√§r kan du sammanfatta vad eleven √§r stark p√•, vad som beh√∂ver √∂vas och exportera en JSON-text till elevkortet.
              </p>

              <div class="progress-grid">
                <div class="progress-box" id="progressPointsBox">
                  <h4>Elevens po√§ng (lokalt)</h4>
                  <p id="progressPointsText" class="mini">
                    Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.
                  </p>

                  <div style="margin-top:10px;">
                    <h4>Elever som spelat (aktiv bank)</h4>
                    <ul id="playedStudentsList" class="goals-list mini">
                      <li>Ingen elev inl√§st √§nnu.</li>
                    </ul>
                  </div>
                </div>

                <div class="progress-box" id="progressStrongBox">
                  <h4>Starka delbitar</h4>
                  <ul id="progressStrongList" class="goals-list mini">
                    <li>Inga starka delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressWeakBox">
                  <h4>Delbitar att √∂va p√•</h4>
                  <ul id="progressWeakList" class="goals-list mini">
                    <li>Inga svaga delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressExportBox">
                  <h4>Export till elevkort (JSON)</h4>
                  <p class="mini">
                    N√§r du √§r n√∂jd med en elevs progression kan du skapa en JSON-str√§ng som klistras in i elevkortet.
                  </p>
                  <textarea
                    id="progressExportJson"
                    class="input"
                    rows="4"
                    readonly
                    style="font-family:monospace;font-size:0.8rem;border-radius:6px;"
                  ></textarea>
                  <div style="margin-top:6px;display:flex;gap:8px;justify-content:flex-end;">
                    <button id="btnGenerateProgressJson" class="btn btn-sm" type="button">üîÅ Skapa JSON</button>
                    <button id="btnCopyProgressJson" class="btn btn-sm btn-primary" type="button">üìã Kopiera kod</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Fr√•gebank / Firebase -->
          <section class="tab-panel hidden" data-panel="bank">
            <div class="settings-grid">
              <div class="card">
                <h3>Ladda fr√•gebank fr√•n molnet (Firebase)</h3>
                <p class="mini">
                  Visar bankar som har sparats p√• ditt Google-konto. Aktivera bankarna nedan f√∂r att l√§gga till fr√•gorna i spelet.
                </p>
                <p id="cloudBankStatus" class="mini" style="margin-top:4px;"></p>
                <ul id="cloudBankList" class="goals-list" style="margin-top:10px;"></ul>
                <div style="margin-top:10px;">
                  <button id="btnLoadCloudBanks" class="btn btn-sm" type="button">‚òÅÔ∏è Ladda moln-bankar</button>
                </div>
              </div>

              <div class="card">
                <h3>Spara aktuell fr√•gebank till molnet</h3>
                <p class="mini">
                  Namnge din fr√•gebank. Sparar *alla* fr√•gor du skapat i flervals-, bild- och drag/drop-flikarna.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="inputBankName">Namn p√• fr√•gebank</label>
                    <input id="inputBankName" class="input" placeholder="T.ex. Livsmedel HT25" />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <button id="btnSaveToCloud" class="btn btn-sm btn-primary" type="button">üíæ Spara bank till molnet</button>
                </div>
              </div>

              <div class="card card-full-width">
                <h3>Export / Import av fr√•gebank (JSON)</h3>
                <p class="mini">
                  Exportera hela din nuvarande fr√•gebank som en JSON-fil (s√§kerhetskopia) eller importera en befintlig bank fr√•n fil.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <button id="btnExportBank" class="btn btn-sm" type="button">‚¨áÔ∏è Exportera till JSON</button>
                  <label class="btn btn-sm" for="fileImport">‚¨ÜÔ∏è Importera fr√•n JSON</label>
                  <input type="file" id="fileImport" accept=".json" style="display:none;" />
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
</body>
<!-- slut SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->






<!-- start SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker & editorer) -->


<!-- start SEKTION 3A: BAS ‚Äì konstanter, state, utils -->
<script>
"use strict";

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
  authDomain: "fangvaktaren-904db.firebaseapp.com",
  projectId: "fangvaktaren-904db",
  storageBucket: "fangvaktaren-904db.firebasestorage.app",
  messagingSenderId: "105301219768",
  appId: "1:105301219768:web:66b131fba86a541b78174d",
  measurementId: "G-NXL9GSFZ77"
};

const STORAGE_KEY = "fangvaktaren-v17";

// teachers/{uid}/banks/{bankId}
const CLOUD_ROOT_COLLECTION = "teachers";
const CLOUD_BANKS_SUBCOLLECTION = "banks";

// public_banks/{publicId} (elevl√§nk utan inloggning)
const PUBLIC_BANKS_COLLECTION = "public_banks";

// Lokal (endast l√§rardator): roster per bankId (namn/e-post/token)
const TEACHER_LOCAL_ROSTER_KEY = STORAGE_KEY + "::teacherRosterByBankId_v1";

const $ = (sel) => document.querySelector(sel);
const $all = (sel) => document.querySelectorAll(sel);

let firebaseAppInstance = null;
let firebaseAuthInstance = null;
let firebaseDbInstance = null;
let currentTeacherUser = null;

let currentLevel = null;
let currentQuestions = [];
let currentAnswers = [];
let lastSubmission = null;

// editor-state
let currentMcqLinks = [];
let currentImgLinks = [];
let currentDragLinks = [];
let currentMcqCorrectIndex = 0;
let currentImgCorrectIndex = 0;
let currentImgDataUrl = null;

let currentDragSourcesTmp = [];
let currentDragTargetsTmp = [];
let currentDragCorrectMapTmp = {};

const defaultState = {
  student: { name: "", klass: "", token: "" },

  best: { E: 0, C: 0, A: 0 },
  unlocked: { E: false, C: false, A: false },
  thres: { E: 70, C: 70, A: 70 },

  teacherPassword: null,
  teacherEmail: "",

  goalsMap: [],

  bank: { mcq: [], img: [], drag: [] },

  activeBank: {
    mode: "",     // "teacher" | "public" | ""
    ownerUid: "", // uid f√∂r teachers/{uid}/banks
    bankId: "",   // bankId under teachers/{uid}/banks/{bankId}
    publicId: ""  // public_banks/{publicId}
  },

  progression: {
    totalPoints: 0,
    wrongByGoalId: {},
    correctByGoalId: {}
  }
};

function deepCloneDefault() { return JSON.parse(JSON.stringify(defaultState)); }

function clampInt(val, min, max) {
  const n = parseInt(val, 10);
  if (isNaN(n)) return min;
  return Math.max(min, Math.min(max, n));
}

function shuffle(arr) { return arr.slice().sort(() => Math.random() - 0.5); }

function escapeHtml(str) {
  if (!str && str !== 0) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function isPermissionDenied(err) {
  const code = (err && (err.code || err.name)) ? String(err.code || err.name) : "";
  const msg = (err && err.message) ? String(err.message) : "";
  return (
    code.includes("permission-denied") ||
    code.includes("PERMISSION_DENIED") ||
    msg.includes("Missing or insufficient permissions")
  );
}

function ensureBankShape(bank) {
  const b = Object.assign({ mcq: [], img: [], drag: [] }, bank || {});
  if (!Array.isArray(b.mcq)) b.mcq = [];
  if (!Array.isArray(b.img)) b.img = [];
  if (!Array.isArray(b.drag)) b.drag = [];
  return b;
}

function getBankFromState() {
  const s = loadState();
  return ensureBankShape(s.bank);
}

function setBankInState(bankObj) {
  const s = loadState();
  s.bank = ensureBankShape(bankObj);
  saveState(s);
}

function setActiveBankMeta(meta) {
  const s = loadState();
  s.activeBank = Object.assign({ mode: "", ownerUid: "", bankId: "", publicId: "" }, s.activeBank || {}, meta || {});
  saveState(s);
}

function getQueryParam(name) {
  try {
    const u = new URL(window.location.href);
    return (u.searchParams.get(name) || "").trim();
  } catch {
    return "";
  }
}

function genToken(len = 10) {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  const bytes = new Uint8Array(len);
  (window.crypto || window.msCrypto).getRandomValues(bytes);
  for (let i = 0; i < len; i++) out += chars[bytes[i] % chars.length];
  return out;
}
</script>
<!-- slut SEKTION 3A: BAS ‚Äì konstanter, state, utils -->



<!-- start SEKTION 3B: STATE ‚Äì embedded-data, load/save, roster local -->
<!-- √ÑNDRING: (1) Formaterar ‚ÄúElevens po√§ng‚Äù med en niv√• per rad, (2) ber√§knar & renderar starka/svaga delbitar fr√•n progression, (3) h√§mtar & visar ‚ÄúElever som spelat‚Äù fr√•n Firestore f√∂r aktiv bank. (~170 rader) -->
<script>
"use strict";

function mergeEmbeddedBank(state) {
  const el = document.getElementById("embedded-data");
  if (!el) return state;
  try {
    const raw = el.textContent || el.innerHTML || "{}";
    const data = JSON.parse(raw);
    if (data && data.bank) {
      state.bank = Object.assign({ mcq: [], img: [], drag: [] }, state.bank || {});
      state.bank.mcq = (state.bank.mcq || []).concat(data.bank.mcq || []);
      state.bank.img = (state.bank.img || []).concat(data.bank.img || []);
      state.bank.drag = (state.bank.drag || []).concat(data.bank.drag || []);
    }
  } catch (e) {
    console.warn("Kunde inte l√§sa embedded-data:", e);
  }
  return state;
}

function _normalizeGoalsMapArray(arr) {
  const out = [];
  const list = Array.isArray(arr) ? arr : [];
  for (let i = 0; i < list.length; i++) {
    const g = list[i];
    if (g && typeof g === "object") {
      const id = (g.id != null) ? g.id : Date.now() + i;
      const goal = (g.goal != null) ? String(g.goal) : "";
      const parts = (g.parts != null) ? String(g.parts) : "";
      out.push({ id, goal, parts });
    } else if (typeof g === "string") {
      out.push({ id: Date.now() + i, goal: "", parts: g });
    }
  }
  return out;
}

function normalizeState(s) {
  s.student = Object.assign({ name: "", klass: "", token: "" }, s.student || {});
  s.best = Object.assign({ E: 0, C: 0, A: 0 }, s.best || {});
  s.unlocked = Object.assign({ E: false, C: false, A: false }, s.unlocked || {});
  s.thres = Object.assign({ E: 70, C: 70, A: 70 }, s.thres || {});
  s.teacherPassword = (s.teacherPassword != null) ? s.teacherPassword : null;
  s.teacherEmail = (s.teacherEmail != null) ? String(s.teacherEmail) : "";
  s.lastSubmission = (s.lastSubmission != null) ? s.lastSubmission : null;

  s.bank = Object.assign({ mcq: [], img: [], drag: [] }, s.bank || {});
  if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
  if (!Array.isArray(s.bank.img)) s.bank.img = [];
  if (!Array.isArray(s.bank.drag)) s.bank.drag = [];
  s.goalsMap = _normalizeGoalsMapArray(s.goalsMap);

  if (!s.progression || typeof s.progression !== "object") {
    s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {} };
  } else {
    s.progression.totalPoints = (typeof s.progression.totalPoints === "number") ? s.progression.totalPoints : (s.progression.totalPoints || 0);
    s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
    s.progression.correctByGoalId = s.progression.correctByGoalId || {};
  }

  s.activeBank = Object.assign({ mode: "", ownerUid: "", bankId: "", publicId: "" }, s.activeBank || {});
  return s;
}

function _safeNum(n, fallback = 0) {
  const x = Number(n);
  return isFinite(x) ? x : fallback;
}

function _formatPercent(n) {
  const x = Math.round(_safeNum(n, 0));
  return String(Math.max(0, Math.min(100, x)));
}

function _renderUl(ul, items, emptyText) {
  if (!ul) return;
  const arr = Array.isArray(items) ? items : [];
  ul.innerHTML = "";
  if (!arr.length) {
    const li = document.createElement("li");
    li.textContent = emptyText || "Ingen data √§nnu.";
    ul.appendChild(li);
    return;
  }
  for (let i = 0; i < arr.length; i++) {
    const li = document.createElement("li");
    li.innerHTML = items[i];
    ul.appendChild(li);
  }
}

function _computeStrongWeakLists(state) {
  const s = state || loadState();
  const gm = Array.isArray(s.goalsMap) ? s.goalsMap : [];
  const corr = (s.progression && s.progression.correctByGoalId) ? s.progression.correctByGoalId : {};
  const wrong = (s.progression && s.progression.wrongByGoalId) ? s.progression.wrongByGoalId : {};

  const rows = [];
  for (let i = 0; i < gm.length; i++) {
    const g = gm[i];
    const key = String(g.id);
    const c = _safeNum(corr[key], 0);
    const w = _safeNum(wrong[key], 0);
    const a = c + w;
    if (a <= 0) continue;
    const acc = a ? (c / a) : 0;
    rows.push({
      id: g.id,
      goal: g.goal || "",
      parts: g.parts || "",
      correct: c,
      wrong: w,
      attempts: a,
      acc: acc
    });
  }

  const strong = rows
    .filter(r => r.correct >= 1 && r.correct >= r.wrong)
    .sort((a, b) => (b.acc - a.acc) || (b.attempts - a.attempts));

  const weak = rows
    .filter(r => r.wrong >= 1 && r.wrong > r.correct)
    .sort((a, b) => (a.acc - b.acc) || (b.attempts - a.attempts));

  const strongOut = strong.slice(0, 10).map(r => {
    const title = `${escapeHtml(r.parts)} ‚Äì ${escapeHtml(r.goal)}`.trim();
    const meta = `${r.correct}/${r.attempts} r√§tt`;
    return `${title ? title : "Delbit"} <span class="mini">(${escapeHtml(meta)})</span>`;
  });

  const weakOut = weak.slice(0, 10).map(r => {
    const title = `${escapeHtml(r.parts)} ‚Äì ${escapeHtml(r.goal)}`.trim();
    const meta = `${r.correct}/${r.attempts} r√§tt`;
    return `${title ? title : "Delbit"} <span class="mini">(${escapeHtml(meta)})</span>`;
  });

  return { strongOut, weakOut };
}

function _formatPointsHtml(state) {
  const s = state || loadState();
  const total = _safeNum(s.progression && s.progression.totalPoints, 0);

  const bestE = _formatPercent(s.best && s.best.E);
  const bestC = _formatPercent(s.best && s.best.C);
  const bestA = _formatPercent(s.best && s.best.A);

  const thE = _formatPercent(s.thres && s.thres.E);
  const thC = _formatPercent(s.thres && s.thres.C);
  const thA = _formatPercent(s.thres && s.thres.A);

  const ls = (typeof lastSubmission !== "undefined" && lastSubmission) ? lastSubmission : (s.lastSubmission || null);

  let lastLine = "Senast: -";
  if (ls && typeof ls === "object") {
    const lvl = (ls.level != null) ? String(ls.level) : "-";
    const pct = (ls.percent != null) ? _formatPercent(ls.percent) : "-";
    const got = (ls.correct != null) ? String(ls.correct) : "-";
    const tot = (ls.total != null) ? String(ls.total) : "-";
    const pts = (ls.pointsGained != null) ? String(ls.pointsGained) : "";
    lastLine = `Senast: niv√• ${escapeHtml(lvl)} ‚Äì ${escapeHtml(pct)}% (${escapeHtml(got)}/${escapeHtml(tot)} r√§tt)${pts ? " +" + escapeHtml(pts) + "p" : ""}.`;
  }

  return [
    `Totalt: <strong>${escapeHtml(total)} p</strong>.`,
    `${lastLine}`,
    `B√§sta:`,
    `‚Ä¢ E ${escapeHtml(bestE)}% (gr√§ns ${escapeHtml(thE)}%)`,
    `‚Ä¢ C ${escapeHtml(bestC)}% (gr√§ns ${escapeHtml(thC)}%)`,
    `‚Ä¢ A ${escapeHtml(bestA)}% (gr√§ns ${escapeHtml(thA)}%)`
  ].join("<br>");
}

function tryUpdateProgressUI() {
  try {
    const s = loadState();

    const pEl = document.getElementById("progressPointsText");
    if (pEl) pEl.innerHTML = _formatPointsHtml(s);

    const { strongOut, weakOut } = _computeStrongWeakLists(s);

    _renderUl(
      document.getElementById("progressStrongList"),
      strongOut,
      "Inga starka delbitar inl√§sta √§nnu."
    );

    _renderUl(
      document.getElementById("progressWeakList"),
      weakOut,
      "Inga svaga delbitar inl√§sta √§nnu."
    );
  } catch (e) {
    console.warn("tryUpdateProgressUI misslyckades:", e);
  }
}

/* GDPR: roster (namn/e-post/token) lagras ENDAST lokalt p√• l√§rardatorn */

function loadTeacherRosterMap() {
  try {
    const raw = localStorage.getItem(TEACHER_LOCAL_ROSTER_KEY);
    if (!raw) return {};
    const obj = JSON.parse(raw);
    return obj && typeof obj === "object" ? obj : {};
  } catch {
    return {};
  }
}

function saveTeacherRosterMap(mapObj) {
  try {
    localStorage.setItem(TEACHER_LOCAL_ROSTER_KEY, JSON.stringify(mapObj || {}));
  } catch (e) {
    console.warn("Kunde inte spara l√§rarens elevlista lokalt:", e);
  }
}

/* ====== Elever som spelat (h√§mtas fr√•n Firestore f√∂r aktiv bank) ====== */

let _playedStudentsLastFetchAt = 0;
let _playedStudentsFetchPromise = null;

function _getStudentsCollectionRefFromActiveBank() {
  if (!firebaseDbInstance) return null;
  const s = loadState();
  const a = s.activeBank || {};
  if (a.mode === "teacher" && a.ownerUid && a.bankId) {
    return firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION).doc(String(a.ownerUid))
      .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(a.bankId))
      .collection("students");
  }
  if (a.mode === "public" && a.publicId) {
    return firebaseDbInstance
      .collection(PUBLIC_BANKS_COLLECTION).doc(String(a.publicId))
      .collection("students");
  }
  return null;
}

function _extractUpdatedAtMillis(v) {
  if (!v) return 0;
  if (typeof v === "number") return v;
  if (v && typeof v.toMillis === "function") return v.toMillis();
  if (v && typeof v.seconds === "number") return v.seconds * 1000;
  return 0;
}

async function _fetchPlayedStudentsOnce() {
  const ref = _getStudentsCollectionRefFromActiveBank();
  if (!ref) return [];

  let snap = null;
  try {
    snap = await ref.limit(200).get();
  } catch (e) {
    snap = await ref.get();
  }

  const out = [];
  snap.forEach((doc) => {
    const d = doc.data() || {};
    const token = doc.id || "";
    const name = d.name || d.studentName || (d.student && d.student.name) || "";
    const klass = d.klass || d.class || d.studentClass || (d.student && (d.student.klass || d.student.class)) || "";
    const pts = d.totalPoints || d.points || (d.progression && d.progression.totalPoints) || "";
    const updatedAt = _extractUpdatedAtMillis(d.updatedAt || d.updated || d.lastUpdated || d.ts || d.timestamp);

    out.push({
      token: String(token || ""),
      name: String(name || ""),
      klass: String(klass || ""),
      points: pts,
      updatedAt: updatedAt
    });
  });

  out.sort((a, b) => (b.updatedAt - a.updatedAt) || (String(a.name).localeCompare(String(b.name))));
  return out;
}

function tryRefreshPlayedStudentsList(force = false) {
  const ul = document.getElementById("playedStudentsList");
  if (!ul) return;

  const now = Date.now();
  if (!force && (now - _playedStudentsLastFetchAt) < 3000) return;
  if (_playedStudentsFetchPromise) return;

  const ref = _getStudentsCollectionRefFromActiveBank();
  if (!ref) {
    _renderUl(ul, [], "Ingen aktiv bank vald (eller Firebase ej initierad).");
    return;
  }

  _playedStudentsLastFetchAt = now;
  _playedStudentsFetchPromise = _fetchPlayedStudentsOnce()
    .then((arr) => {
      const items = (arr || []).slice(0, 60).map((x) => {
        const name = x.name ? escapeHtml(x.name) : "Ok√§nd elev";
        const klass = x.klass ? ` (${escapeHtml(x.klass)})` : "";
        const token = x.token ? ` <span class="mini">[${escapeHtml(x.token)}]</span>` : "";
        const pts = (x.points !== "" && x.points != null) ? ` <span class="mini">‚Äì ${escapeHtml(String(x.points))} p</span>` : "";
        return `${name}${klass}${token}${pts}`;
      });

      _renderUl(ul, items, "Ingen elev har l√§mnat in resultat √§nnu.");
    })
    .catch((e) => {
      console.warn("Kunde inte h√§mta elever som spelat:", e);
      _renderUl(ul, [], "Kunde inte l√§sa elever (kontrollera Firestore-regler / bank).");
    })
    .finally(() => {
      _playedStudentsFetchPromise = null;
    });
}

function loadState() {
  let s = null;
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) s = JSON.parse(raw);
  } catch (e) {
    console.warn("Kunde inte l√§sa state, √•terst√§ller:", e);
  }

  if (!s) {
    s = deepCloneDefault();
    s = mergeEmbeddedBank(s);
    saveState(s);
  }

  const normalized = normalizeState(s);

  setTimeout(() => {
    tryUpdateProgressUI();
    tryRefreshPlayedStudentsList(false);
  }, 0);

  return normalized;
}

function saveState(state) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn("Kunde inte spara state:", e);
  }

  setTimeout(() => {
    tryUpdateProgressUI();
    tryRefreshPlayedStudentsList(false);
  }, 0);
}
</script>
<!-- slut SEKTION 3B: STATE ‚Äì embedded-data, load/save, roster local -->






<!-- start SEKTION 3C: FIREBASE ‚Äì init + Google login -->
<!-- √ÑNDRAT: Tar bort ‚Äútimeout‚Äù-fel som l√•ser UI, v√§ntar l√§ngre och forts√§tter retry tyst tills firebase-bibliotek finns; triggar event + autorefresh av molnlistan n√§r DB blir ready. Omskrivna rader: ca 120 -->
<script>
"use strict";

/* Robust init: undvik ‚ÄúFirebase-bibliotek saknas‚Äù n√§r gstatic laddar l√•ngsamt */
(function FV_FIREBASE_BOOTSTRAP(){
  if (window.__fvFirebaseBootstrapInstalled) return;
  window.__fvFirebaseBootstrapInstalled = true;

  window.__fvFirebaseInitInProgress = false;
  window.__fvFirebaseReady = false;

  window.__fvFirebaseReadyPromise = window.__fvFirebaseReadyPromise || new Promise((resolve) => {
    window.__fvFirebaseReadyResolve = resolve;
  });

  // L√•ngsam n√§t? forts√§tt retry (utan att spamma)
  window.__fvFirebaseLibRetryTimer = window.__fvFirebaseLibRetryTimer || null;

  async function _fv_waitForFirebaseLibs(maxMs){
    const start = Date.now();
    const timeout = (typeof maxMs === "number" ? maxMs : 45000);

    while (Date.now() - start < timeout) {
      if (window.firebase && typeof window.firebase.initializeApp === "function") return true;
      await new Promise(r => setTimeout(r, 120));
    }
    return false;
  }

  function _fv_scheduleRetryInit(){
    if (window.__fvFirebaseReady) return;
    if (window.__fvFirebaseLibRetryTimer) return;

    window.__fvFirebaseLibRetryTimer = setInterval(async () => {
      if (window.__fvFirebaseReady) {
        clearInterval(window.__fvFirebaseLibRetryTimer);
        window.__fvFirebaseLibRetryTimer = null;
        return;
      }
      try { await initFirebase(); } catch {}
      if (window.__fvFirebaseReady) {
        clearInterval(window.__fvFirebaseLibRetryTimer);
        window.__fvFirebaseLibRetryTimer = null;
      }
    }, 2000);
  }

  window._fv_waitForFirebaseLibs = _fv_waitForFirebaseLibs;
  window._fv_scheduleRetryInit = _fv_scheduleRetryInit;
})();

async function initFirebase() {
  const statusEl = $("#googleStatus");

  // debounce: om redan klar eller p√•g√•r
  if (window.__fvFirebaseReady) return true;
  if (window.__fvFirebaseInitInProgress) {
    try { await window.__fvFirebaseReadyPromise; } catch {}
    return !!window.__fvFirebaseReady;
  }
  window.__fvFirebaseInitInProgress = true;

  try {
    if (statusEl && (!window.firebase || typeof window.firebase.initializeApp !== "function")) {
      statusEl.textContent = "‚è≥ Laddar Firebase‚Ä¶ (v√§nta)";
    }

    const ok = await window._fv_waitForFirebaseLibs(45000);
    if (!ok) {
      // Inget ‚Äúfel‚Äù h√§r ‚Äì forts√§tt f√∂rs√∂ka i bakgrunden s√• UI inte fastnar p√• ‚ÄúDB saknas‚Äù
      window.__fvFirebaseInitInProgress = false;
      try { window._fv_scheduleRetryInit(); } catch {}
      return false;
    }

    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(FIREBASE_CONFIG);
    }

    firebaseAppInstance = firebase.app();
    firebaseAuthInstance = firebase.auth();
    firebaseDbInstance = firebase.firestore();

    window.__fvFirebaseReady = true;
    window.__fvFirebaseInitInProgress = false;
    try { if (window.__fvFirebaseReadyResolve) window.__fvFirebaseReadyResolve(true); } catch {}

    // signalera "ready" s√• andra sektioner kan reagera
    try { window.dispatchEvent(new CustomEvent("fv-firebase-ready")); } catch {}

    if (firebaseAuthInstance && typeof firebaseAuthInstance.onAuthStateChanged === "function") {
      firebaseAuthInstance.onAuthStateChanged((user) => {
        currentTeacherUser = user || null;
        const btnLogout = $("#btnGoogleLogout");
        if (!statusEl) return;

        if (user) {
          statusEl.textContent = `‚òÅÔ∏è Inloggad som ${user.email || "l√§rare"} ‚Äì moln-banker aktiverade.`;
          if (btnLogout) btnLogout.classList.remove("hidden");
          try { if (typeof window.loadCloudBanksListV4 === "function") window.loadCloudBanksListV4(); } catch {}
        } else {
          statusEl.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka p√• Google f√∂r att logga in.";
          if (btnLogout) btnLogout.classList.add("hidden");
        }
      });
    }

    console.log("Firebase init OK");
    return true;
  } catch (e) {
    console.error("Fel vid initFirebase:", e);
    if (statusEl) statusEl.textContent = "‚ö†Ô∏è Tekniskt fel: kunde inte starta Firebase.";
    window.__fvFirebaseInitInProgress = false;
    try { window._fv_scheduleRetryInit(); } catch {}
    return false;
  }
}

async function handleGoogleLogin() {
  const statusEl = $("#googleStatus");
  try { await initFirebase(); } catch {}

  if (!firebaseAuthInstance) {
    alert("Tekniskt fel: Firebase Auth saknas.");
    return;
  }
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    await firebaseAuthInstance.signInWithPopup(provider);
  } catch (err) {
    console.error("Google-inloggning misslyckades:", err);
    if (statusEl) statusEl.textContent = "‚ö†Ô∏è Kunde inte logga in med Google. F√∂rs√∂k igen.";
  }
}

async function handleGoogleLogout() {
  try {
    if (firebaseAuthInstance) await firebaseAuthInstance.signOut();
  } catch (err) {
    console.error("Kunde inte logga ut:", err);
  }
}

/* K√∂r init tidigt + forts√§tt retry om n√§tet √§r segt */
try { initFirebase(); } catch {}
window.addEventListener("load", () => { try { initFirebase(); } catch {} });
</script>
<!-- slut SEKTION 3C: FIREBASE ‚Äì init + Google login -->











<!-- start SEKTION 3Da: MOLN-BANK ‚Äì helpers + UI host + styles + roster UI -->
<!-- √ÑNDRAT: √Öterskapar borttagen 3Da (helpers + styles + roster UI). Omskrivna rader: ca 240 -->
<script>
"use strict";

function _fv3d_escape(s){
  if (typeof escapeHtml === "function") return escapeHtml(s);
  if (!s && s !== 0) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function _fv3d_genToken(len){
  try { if (typeof genToken === "function") return genToken(len || 10); } catch {}
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  const bytes = new Uint8Array(len || 10);
  (window.crypto || window.msCrypto).getRandomValues(bytes);
  for (let i = 0; i < bytes.length; i++) out += chars[bytes[i] % chars.length];
  return out;
}

function _fv3d_hasFirebaseReady(){
  return !!(typeof firebaseDbInstance !== "undefined" && firebaseDbInstance);
}
function _fv3d_hasTeacher(){
  return !!(typeof currentTeacherUser !== "undefined" && currentTeacherUser && currentTeacherUser.uid);
}

function _fv3d_activeBankId(){
  try {
    if (typeof window.activeCloudBankId !== "undefined" && window.activeCloudBankId) return String(window.activeCloudBankId);
  } catch {}
  try {
    if (typeof loadState === "function") {
      const s = loadState();
      const ab = (s && s.activeBank) ? s.activeBank : {};
      if ((ab.mode || "") === "teacher" && ab.bankId) return String(ab.bankId);
    }
  } catch {}
  return "";
}

function _fv3d_activePublicId(){
  try{
    if (typeof loadState !== "function") return "";
    const s = loadState();
    const ab = (s && s.activeBank) ? s.activeBank : {};
    if ((ab.publicId || "").trim()) return String(ab.publicId).trim();
  }catch{}
  return "";
}

function _fv3d_setActiveMeta(bankId, publicId){
  try {
    if (typeof setActiveBankMeta === "function" && _fv3d_hasTeacher()) {
      setActiveBankMeta({
        mode: "teacher",
        ownerUid: String(currentTeacherUser.uid),
        bankId: String(bankId),
        publicId: publicId ? String(publicId) : ""
      });
    } else if (typeof loadState === "function" && typeof saveState === "function") {
      const s = loadState();
      s.activeBank = Object.assign({ mode:"", ownerUid:"", bankId:"", publicId:"" }, s.activeBank || {}, {
        mode: _fv3d_hasTeacher() ? "teacher" : (s.activeBank && s.activeBank.mode) || "",
        ownerUid: _fv3d_hasTeacher() ? String(currentTeacherUser.uid) : (s.activeBank && s.activeBank.ownerUid) || "",
        bankId: String(bankId || (s.activeBank && s.activeBank.bankId) || ""),
        publicId: publicId ? String(publicId) : ((s.activeBank && s.activeBank.publicId) || "")
      });
      saveState(s);
    }
    try { window.activeCloudBankId = String(bankId); } catch {}
  } catch {}
}

function _fv3d_getBaseUrl(){
  try {
    const href = String(window.location.href || "");
    const noHash = href.split("#")[0];
    return noHash.split("?")[0];
  } catch {
    return "";
  }
}

function _fv3d_bankShape(bank){
  const b = Object.assign({ mcq: [], img: [], drag: [] }, bank || {});
  if (!Array.isArray(b.mcq)) b.mcq = [];
  if (!Array.isArray(b.img)) b.img = [];
  if (!Array.isArray(b.drag)) b.drag = [];
  return b;
}

function _fv3d_isPermissionDenied(err){
  try {
    const msg = (err && (err.message || err.toString())) ? String(err.message || err.toString()) : "";
    const code = err && err.code ? String(err.code) : "";
    return code === "permission-denied" || msg.toLowerCase().includes("missing or insufficient permissions");
  } catch { return false; }
}

function _fv3d_ensureStyles(){
  if (document.getElementById("fv3d-styles")) return;
  const st = document.createElement("style");
  st.id = "fv3d-styles";
  st.textContent = `
    .cloud-bank-active{
      border-color:rgba(74,222,128,.95) !important;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 16px rgba(34,197,94,.55),
        0 12px 28px rgba(15,23,42,.9) !important;
    }
    .cloud-bank-active .mini,
    .cloud-bank-active .chip{ color:#bbf7d0 !important; }

    .fv3d-actions{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .fv3d-actions .btn{ white-space:nowrap; }
    #fv3d-cloud-status{ margin-top:6px; }

    #fv3dRosterBox{
      margin-top:10px;
      border:1px solid rgba(31,41,55,1);
      border-radius:12px;
      background:#020617;
      box-shadow:0 0 0 1px rgba(15,23,42,1), 0 10px 24px rgba(15,23,42,.9);
      padding:10px;
    }
    #fv3dRosterBox.hidden{ display:none !important; }

    #fv3dRosterTop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    #fv3dRosterMeta{ margin-top:4px; }

    #fv3dRosterGrid{
      display:grid;
      grid-auto-flow:row;
      gap:8px;
      margin-top:10px;
    }

    .fv3d-roster-card{
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      box-shadow:0 0 0 1px rgba(15,23,42,1), 0 10px 24px rgba(15,23,42,.9);
      padding:8px;
      display:flex;
      flex-direction:row;
      align-items:center;
      gap:8px;
      overflow:hidden;
    }

    .fv3d-roster-row{
      display:flex;
      flex:1 1 auto;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .fv3d-roster-row .input{ min-width:0; }

    .fv3d-field-name{ flex: 2 1 220px; }
    .fv3d-field-klass{ flex: 1 1 120px; }
    .fv3d-field-email{ flex: 2 1 240px; }
    .fv3d-field-token{ flex: 1 1 160px; }

    .fv3d-token{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      letter-spacing:.04em;
    }

    .fv3d-roster-actions{
      display:flex;
      flex:0 0 auto;
      justify-content:flex-end;
      gap:6px;
    }

    .fv3d-btn-xs{
      padding:4px 8px;
      font-size:.74rem;
      border-radius:999px;
    }

    #fv3dRosterBottom{
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    #fv3dRosterStatus{ margin-top:8px; white-space:pre-wrap; }
    #fv3dRosterLinkBox{ margin-top:8px; }
    #fv3dRosterLink{
      width:100%;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      letter-spacing:.02em;
    }
  `;
  document.head.appendChild(st);
}

function _fv3d_findTeacherPanel(){
  const byTab = document.querySelector('.tab-panel[data-panel="cloud"]')
            || document.querySelector('.tab-panel[data-panel="teacher"]')
            || document.querySelector('.tab-panel[data-panel="settings"]');
  if (byTab) return byTab;

  const btn = document.getElementById("btnLoadCloudBanks") || Array.from(document.querySelectorAll("button")).find(b=>{
    const t=(b.textContent||"").toLowerCase();
    return t.includes("ladda") && t.includes("moln");
  });
  if (btn) return btn.closest(".card") || btn.closest(".tab-panel") || btn.parentElement || document.body;

  return document.body;
}

function _fv3d_ensureCloudHost(){
  let host =
    document.getElementById("cloudBanksListV4") ||
    document.getElementById("cloudBanksList") ||
    document.querySelector("ul#cloudBanksListV4, ul#cloudBanksList");

  let status =
    document.getElementById("fv3d-cloud-status") ||
    document.getElementById("cloudBanksStatus");

  if (host && status) return { host, status };

  const panel = _fv3d_findTeacherPanel();

  if (!status) {
    status = document.createElement("div");
    status.id = "fv3d-cloud-status";
    status.className = "mini";
  }
  if (!host) {
    host = document.createElement("ul");
    host.id = "cloudBanksListV4";
    host.className = "question-list";
  }

  const btnLoad = document.getElementById("btnLoadCloudBanks") || Array.from(document.querySelectorAll("button")).find(b=>{
    const t=(b.textContent||"").toLowerCase();
    return t.includes("ladda") && t.includes("moln");
  });

  if (btnLoad && btnLoad.parentElement) {
    const container = btnLoad.closest(".card") || btnLoad.parentElement;
    if (!status.parentElement) container.appendChild(status);
    if (!host.parentElement) container.appendChild(host);
  } else {
    if (panel) {
      if (!status.parentElement) panel.insertBefore(status, panel.firstChild);
      if (!host.parentElement) panel.insertBefore(host, status.nextSibling);
    } else {
      document.body.appendChild(status);
      document.body.appendChild(host);
    }
  }

  return { host, status };
}

function _fv3d_setStatus(msg){
  const { status } = _fv3d_ensureCloudHost();
  if (status) status.textContent = msg || "";
}

/* =========================
   Inline elevlista-ruta
   ========================= */

function _fv3d_ensureRosterBox(){
  _fv3d_ensureStyles();
  const { host } = _fv3d_ensureCloudHost();
  const container = host ? (host.closest(".card") || host.parentElement || _fv3d_findTeacherPanel()) : _fv3d_findTeacherPanel();

  let box = document.getElementById("fv3dRosterBox");
  if (box) return box;

  box = document.createElement("div");
  box.id = "fv3dRosterBox";
  box.className = "hidden";

  box.innerHTML = `
    <div id="fv3dRosterTop">
      <div>
        <h3 style="margin:0;">Elevlista (lokalt) + tokens</h3>
        <div id="fv3dRosterMeta" class="mini">-</div>
      </div>
      <div class="fv3d-actions">
        <button id="fv3dRosterCopyLinks" class="btn fv3d-btn-xs" type="button">Kopiera l√§nkar</button>
        <button id="fv3dRosterSave" class="btn fv3d-btn-xs btn-primary" type="button">Spara till vald bank</button>
        <button id="fv3dRosterClose" class="btn fv3d-btn-xs" type="button">St√§ng</button>
      </div>
    </div>

    <div id="fv3dRosterLinkBox" class="field">
      <label class="small-label" for="fv3dRosterLink">Elevl√§nk (public)</label>
      <input id="fv3dRosterLink" class="input" readonly value="" placeholder="Skapas automatiskt n√§r du trycker üìß p√• en elev..." />
      <div class="mini" style="margin-top:4px;">üìß p√• en elev skapar elevl√§nk automatiskt om den saknas.</div>
    </div>

    <div id="fv3dRosterGrid"></div>

    <div id="fv3dRosterBottom">
      <button id="fv3dRosterAddBottom" class="btn fv3d-btn-xs btn-primary" type="button">‚ûï L√§gg till elev</button>
      <span class="mini">Tomma rader sparas inte.</span>
    </div>

    <div id="fv3dRosterStatus" class="mini"></div>
  `;

  container.appendChild(box);

  const btnClose = document.getElementById("fv3dRosterClose");
  if (btnClose) btnClose.addEventListener("click", ()=>{
    box.classList.add("hidden");
    const st = document.getElementById("fv3dRosterStatus");
    if (st) st.textContent = "";
  });

  return box;
}

function _fv3d_mailto(to, subject, body){
  try{
    const url = `mailto:${encodeURIComponent(to || "")}?subject=${encodeURIComponent(subject || "")}&body=${encodeURIComponent(body || "")}`;
    window.open(url, "_blank");
  }catch{}
}

function _fv3d_makeRosterCard(data){
  const card = document.createElement("div");
  card.className = "fv3d-roster-card";

  const row = document.createElement("div");
  row.className = "fv3d-roster-row";

  const name = document.createElement("input");
  name.className = "input fv3d-field-name";
  name.placeholder = "Namn";
  name.value = (data && data.name) || "";

  const klass = document.createElement("input");
  klass.className = "input fv3d-field-klass";
  klass.placeholder = "Klass";
  klass.value = (data && data.klass) || "";

  const email = document.createElement("input");
  email.className = "input fv3d-field-email";
  email.placeholder = "E-post";
  email.value = (data && data.email) || "";

  const token = document.createElement("input");
  token.className = "input fv3d-field-token fv3d-token";
  token.readOnly = true;
  token.value = (data && typeof data.token === "string") ? data.token : "";

  function ensureToken(){
    if (!token.value.trim()) token.value = _fv3d_genToken(10);
    return token.value.trim();
  }

  function isUsedRow(){
    const a = name.value.trim();
    const b = klass.value.trim();
    const c = email.value.trim();
    const t = token.value.trim();
    return !!(t || a || b || c);
  }

  function onAnyInput(){
    const a = name.value.trim();
    const b = klass.value.trim();
    const c = email.value.trim();
    if ((a || b || c) && !token.value.trim()) ensureToken();
  }
  name.addEventListener("input", onAnyInput);
  klass.addEventListener("input", onAnyInput);
  email.addEventListener("input", onAnyInput);

  row.appendChild(name);
  row.appendChild(klass);
  row.appendChild(email);
  row.appendChild(token);

  const actions = document.createElement("div");
  actions.className = "fv3d-roster-actions";

  const btnTok = document.createElement("button");
  btnTok.className = "btn fv3d-btn-xs";
  btnTok.type = "button";
  btnTok.textContent = "üé≤ Token";
  btnTok.title = "Skapa token f√∂r raden";
  btnTok.addEventListener("click", ()=>{ ensureToken(); });

  const btnMail = document.createElement("button");
  btnMail.className = "btn fv3d-btn-xs";
  btnMail.type = "button";
  btnMail.textContent = "üìß";
  btnMail.title = "Skapa mejl till denna elev (skapar elevl√§nk automatiskt)";
  btnMail.addEventListener("click", async ()=>{
    const em = email.value.trim();
    if (!em) { alert("Skriv e-post p√• raden f√∂rst."); return; }

    const status = document.getElementById("fv3dRosterStatus");
    const linkInput = document.getElementById("fv3dRosterLink");

    const tkn = ensureToken();

    let rosterTokensFromUI = [];
    try {
      const collected = _fv3d_collectRosterFromUI();
      rosterTokensFromUI = (collected && Array.isArray(collected.tokens)) ? collected.tokens : [];
    } catch {}

    let publicUrl = (linkInput && linkInput.value.trim()) ? linkInput.value.trim() : "";
    if (!publicUrl) {
      if (status) status.textContent = "Skapar elevl√§nk‚Ä¶";
      try {
        const pub = await _fv3d_publishActiveBankToPublic({ rosterTokensOverride: rosterTokensFromUI });
        publicUrl = pub && pub.publicUrl ? String(pub.publicUrl) : "";
        if (linkInput && publicUrl) linkInput.value = publicUrl;
      } catch (e) {
        console.error("Kunde inte skapa elevl√§nk:", e);
        if (_fv3d_isPermissionDenied(e)) {
          if (status) status.textContent = "‚ùå Kan inte skapa elevl√§nk: saknar r√§ttigheter i Firestore (permission-denied).";
          alert("Kan inte skapa elevl√§nk eftersom Firestore-reglerna stoppar skrivning till public_banks.\n\nL√∂sning: uppdatera Firestore Rules f√∂r public_banks s√• att din inloggade l√§raranv√§ndare f√•r skriva.");
        } else {
          if (status) status.textContent = "‚ùå Kunde inte skapa elevl√§nk. Se konsolen.";
          alert("Kunde inte skapa elevl√§nk. Se konsolen f√∂r detaljer.");
        }
        return;
      }
    }

    if (!publicUrl) {
      if (status) status.textContent = "‚ùå Ingen elevl√§nk kunde skapas.";
      alert("Ingen elevl√§nk kunde skapas.");
      return;
    }

    const joiner = publicUrl.includes("?") ? "&" : "?";
    const urlWithToken = `${publicUrl}${joiner}token=${encodeURIComponent(tkn)}`;

    const subj = "F√•ngvaktaren ‚Äì l√§nk till spelet";
    const body =
      `Hej!\n\n` +
      `H√§r √§r l√§nken till spelet:\n${urlWithToken}\n\n` +
      `Din token (om du beh√∂ver skriva in den): ${tkn}\n\n` +
      `Lycka till!\n`;

    _fv3d_mailto(em, subj, body);
    if (status) status.textContent = "‚úÖ Mejl √∂ppnat f√∂r utskick.";
  });

  const btnDel = document.createElement("button");
  btnDel.className = "btn fv3d-btn-xs btn-danger";
  btnDel.type = "button";
  btnDel.textContent = "üóëÔ∏è";
  btnDel.title = "Ta bort elevruta";
  btnDel.addEventListener("click", ()=> card.remove());

  actions.appendChild(btnTok);
  actions.appendChild(btnMail);
  actions.appendChild(btnDel);

  card.appendChild(row);
  card.appendChild(actions);

  card.getRosterData = () => ({
    name: name.value.trim(),
    klass: klass.value.trim(),
    email: email.value.trim(),
    token: token.value.trim(),
    _isUsed: isUsedRow()
  });

  card.ensureToken = ensureToken;

  return card;
}

function _fv3d_loadLocalRosterMap(){
  if (typeof loadTeacherRosterMap === "function") {
    try { return loadTeacherRosterMap() || {}; } catch { return {}; }
  }
  return {};
}

function _fv3d_saveLocalRosterMap(mapObj){
  if (typeof saveTeacherRosterMap === "function") {
    try { saveTeacherRosterMap(mapObj || {}); return true; } catch {}
  }
  return false;
}

function _fv3d_collectRosterFromUI(){
  const grid = document.getElementById("fv3dRosterGrid");
  if (!grid) return { rosterLocal: [], tokens: [] };

  const cards = Array.from(grid.children || []);

  const usedCards = cards
    .map((c)=> (typeof c.getRosterData === "function" ? c.getRosterData() : null))
    .filter(Boolean)
    .filter((r)=> !!(r._isUsed || r.token || r.name || r.klass || r.email));

  const rosterLocal = usedCards.map((r)=>{
    let tk = (r.token || "").trim();
    if (!tk) tk = _fv3d_genToken(10);
    return {
      name: (r.name || "").trim(),
      klass: (r.klass || "").trim(),
      email: (r.email || "").trim(),
      token: tk
    };
  });

  const tokens = rosterLocal.map(r=> String(r.token || "").trim()).filter(Boolean);
  return { rosterLocal, tokens };
}

function _fv3d_showRosterBox({ bankId, bankName, initialStudents, publicId }){
  const box = _fv3d_ensureRosterBox();
  const grid = document.getElementById("fv3dRosterGrid");
  const meta = document.getElementById("fv3dRosterMeta");
  const status = document.getElementById("fv3dRosterStatus");
  const btnAddBottom = document.getElementById("fv3dRosterAddBottom");
  const linkInput = document.getElementById("fv3dRosterLink");

  if (!grid) return;

  box.dataset.bankId = String(bankId || "");
  box.dataset.bankName = String(bankName || "");
  box.dataset.publicId = publicId ? String(publicId) : "";

  grid.innerHTML = "";
  if (status) status.textContent = "";

  const students = Array.isArray(initialStudents) ? initialStudents.slice() : [];

  if (!students.length) {
    for (let i = 0; i < 10; i++) students.push({ name:"", klass:"", email:"", token:"" });
  }
  if (students.length < 10) {
    const addN = 10 - students.length;
    for (let i = 0; i < addN; i++) students.push({ name:"", klass:"", email:"", token:"" });
  }

  students.forEach((st)=> grid.appendChild(_fv3d_makeRosterCard(st)));

  if (meta) {
    const nm = bankName ? String(bankName) : "Moln-bank";
    meta.textContent = `${nm} (${bankId}) ‚Äì sparar alltid till vald bank.`;
  }

  const base = _fv3d_getBaseUrl();
  const existingPublicId = publicId ? String(publicId) : "";
  if (linkInput) linkInput.value = (base && existingPublicId) ? `${base}?public=${encodeURIComponent(existingPublicId)}` : "";

  if (btnAddBottom && grid) {
    btnAddBottom.onclick = () => {
      grid.appendChild(_fv3d_makeRosterCard({ name:"", klass:"", email:"", token:"" }));
    };
  }

  box.classList.remove("hidden");
}

async function _fv3d_openRosterInline(bankId){
  _fv3d_ensureStyles();
  _fv3d_ensureRosterBox();

  const localMap = _fv3d_loadLocalRosterMap();
  const localStudents = (localMap[bankId] && Array.isArray(localMap[bankId].students)) ? localMap[bankId].students : [];
  const localName = (localMap[bankId] && localMap[bankId].bankName) ? localMap[bankId].bankName : "";
  const localPublicId = (localMap[bankId] && localMap[bankId].publicId) ? String(localMap[bankId].publicId) : "";

  if (_fv3d_hasFirebaseReady() && _fv3d_hasTeacher()) {
    try {
      const ref = firebaseDbInstance
        .collection(CLOUD_ROOT_COLLECTION)
        .doc(String(currentTeacherUser.uid))
        .collection(CLOUD_BANKS_SUBCOLLECTION)
        .doc(String(bankId));

      const doc = await ref.get();
      if (doc.exists) {
        const data = doc.data() || {};
        const bankName = data.name || localName || "Moln-bank";
        const publicId = data.publicId ? String(data.publicId) : localPublicId;

        if (localStudents.length) {
          _fv3d_showRosterBox({ bankId, bankName, initialStudents: localStudents, publicId });
          return;
        }

        const tokens = Array.isArray(data.rosterTokens) ? data.rosterTokens.map(String).filter(t=>String(t||"").trim()) : [];
        if (tokens.length) {
          const students = tokens.slice(0, 200).map((t)=>({ name:"", klass:"", email:"", token:String(t) }));
          _fv3d_showRosterBox({ bankId, bankName, initialStudents: students, publicId });
          return;
        }

        _fv3d_showRosterBox({ bankId, bankName, initialStudents: [], publicId });
        return;
      }
    } catch (e) {
      console.error("Elevlista inline: kunde inte l√§sa bank:", e);
    }
  }

  const bankName = localName || "Moln-bank";
  _fv3d_showRosterBox({ bankId, bankName, initialStudents: localStudents, publicId: localPublicId });
}
</script>
<!-- slut SEKTION 3Da: MOLN-BANK ‚Äì helpers + UI host + styles + roster UI -->

<!-- start SEKTION 3Db: MOLN-BANK ‚Äì publish public + spara roster + kopiera l√§nkar -->
<!-- √ÑNDRAT: √Öterskapar borttagen 3Db (publish public + spara roster + kopiera l√§nkar) + √•terkopplar gr√∂nmarkering via _fv3d_setActiveMeta. Omskrivna rader: ca 220 -->
<script>
"use strict";

/* =========================
   Publicera bank till public_banks
   ========================= */

async function _fv3d_publishActiveBankToPublic(opts){
  if (!_fv3d_hasFirebaseReady() || !_fv3d_hasTeacher()) throw new Error("Firebase/Teacher saknas");

  const status = document.getElementById("fv3dRosterStatus");
  const linkInput = document.getElementById("fv3dRosterLink");

  const activeId = _fv3d_activeBankId();
  if (!activeId) throw new Error("Ingen aktiv bank");

  const teacherRef = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION)
    .doc(String(currentTeacherUser.uid))
    .collection(CLOUD_BANKS_SUBCOLLECTION)
    .doc(String(activeId));

  const tdoc = await teacherRef.get();
  if (!tdoc.exists) throw new Error("Aktiv bank finns inte");

  const data = tdoc.data() || {};
  const bank = _fv3d_bankShape(data.bank || {});
  const goalsMap = Array.isArray(data.goalsMap) ? data.goalsMap : [];

  let rosterTokens = Array.isArray(data.rosterTokens) ? data.rosterTokens.map(String) : [];
  if (opts && Array.isArray(opts.rosterTokensOverride) && opts.rosterTokensOverride.length) {
    rosterTokens = opts.rosterTokensOverride.map(String).filter(t=>String(t||"").trim());
    await teacherRef.set({ rosterTokens: rosterTokens }, { merge: true });
  }

  let publicId = data.publicId ? String(data.publicId) : "";

  if (!publicId) {
    publicId = firebaseDbInstance.collection(PUBLIC_BANKS_COLLECTION).doc().id;
    await teacherRef.set({ publicId: publicId }, { merge: true });
  }

  const pubRef = firebaseDbInstance.collection(PUBLIC_BANKS_COLLECTION).doc(String(publicId));

  const pubSnap = await pubRef.get().catch(()=>null);
  const existsAlready = !!(pubSnap && pubSnap.exists);

  const pubPayload = {
    name: data.name || "Elevbank",
    sourceTeacherUid: String(currentTeacherUser.uid),
    sourceBankId: String(activeId),
    schemaVersion: "v17-public-bank-v1",
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    bank: bank,
    goalsMap: goalsMap,
    rosterTokens: rosterTokens
  };
  if (!existsAlready) pubPayload.createdAt = firebase.firestore.FieldValue.serverTimestamp();

  await pubRef.set(pubPayload, { merge: true });

  const base = _fv3d_getBaseUrl();
  const publicUrl = base ? `${base}?public=${encodeURIComponent(publicId)}` : "";

  if (linkInput) linkInput.value = publicUrl;
  if (status) status.textContent = `‚úÖ Elevl√§nk skapad.`;

  try {
    const box = document.getElementById("fv3dRosterBox");
    const bankId = box ? String(box.dataset.bankId || "") : "";
    if (bankId) {
      const map = _fv3d_loadLocalRosterMap();
      if (!map[bankId]) map[bankId] = { bankName:"", savedAt:"", students:[], publicId:"" };
      map[bankId].publicId = publicId;
      _fv3d_saveLocalRosterMap(map);
    }
  } catch {}

  return { publicId, publicUrl };
}

/* =========================
   Spara rosterTokens till vald bank + lokalt
   ========================= */

async function _fv3d_saveRosterToCloudAndLocal(){
  const box = document.getElementById("fv3dRosterBox");
  const status = document.getElementById("fv3dRosterStatus");
  const meta = document.getElementById("fv3dRosterMeta");

  if (!box) return;

  const clickedBankId = String(box.dataset.bankId || "");
  const clickedBankName = String(box.dataset.bankName || "");
  const clickedPublicId = String(box.dataset.publicId || "");

  const activeId = _fv3d_activeBankId();
  const targetBankId = clickedBankId || activeId;

  if (!targetBankId) {
    if (status) status.textContent = "‚ö†Ô∏è Ingen vald/aktiv bank. Aktivera en bank f√∂rst.";
    alert("Ingen vald/aktiv bank. Klicka 'Aktivera' p√• en bank f√∂rst.");
    return;
  }

  const { rosterLocal, tokens } = _fv3d_collectRosterFromUI();
  const tokenSet = new Set(tokens);
  if (tokens.length !== tokenSet.size) {
    if (status) status.textContent = "‚ö†Ô∏è Dubbla tokens finns. Ta bort en elev och l√§gg till ny.";
    alert("Du har dubbla tokens i listan. Ta bort en elevruta och l√§gg till ny (ny token skapas).");
    return;
  }

  try {
    const map = _fv3d_loadLocalRosterMap();
    map[targetBankId] = {
      bankName: clickedBankName || (map[targetBankId] && map[targetBankId].bankName) || "",
      savedAt: new Date().toISOString(),
      students: rosterLocal,
      publicId: clickedPublicId || (map[targetBankId] && map[targetBankId].publicId) || ""
    };
    _fv3d_saveLocalRosterMap(map);
  } catch (e) {
    console.warn("Kunde inte spara elevlista lokalt:", e);
  }

  if (meta) {
    const nm = clickedBankName ? String(clickedBankName) : "Moln-bank";
    meta.textContent = `${nm} (${targetBankId}) ‚Äì sparar tokens (lokalt + moln om inloggad).`;
  }

  if (status) status.textContent = `‚úÖ Sparat lokalt (${tokens.length} elever) ‚Äì kopplat till bank: ${targetBankId}.`;

  if (!_fv3d_hasFirebaseReady() || !_fv3d_hasTeacher()) {
    if (status) status.textContent = `‚úÖ Sparat lokalt (${tokens.length} elever). (Logga in f√∂r att spara tokens i molnet.)`;
    alert(`Sparat lokalt! ${tokens.length} elever kopplade till bank.\n(Logga in f√∂r molnsparning.)`);
    return;
  }

  try {
    if (status) status.textContent = "Sparar tokens i molnet‚Ä¶";

    const ref = firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION)
      .doc(String(currentTeacherUser.uid))
      .collection(CLOUD_BANKS_SUBCOLLECTION)
      .doc(String(targetBankId));

    const existsSnap = await ref.get();
    if (!existsSnap.exists) {
      if (status) status.textContent = "‚ùå Banken finns inte i molnet. Ladda/aktivera banken igen och f√∂rs√∂k.";
      alert("Banken finns inte i molnet (kunde inte hittas).\nL√∂sning: Ladda moln-banker, aktivera banken och prova igen.");
      return;
    }

    const bankData = existsSnap.data() || {};
    const publicIdToUse = (bankData.publicId ? String(bankData.publicId) : clickedPublicId);

    await ref.set(
      {
        rosterTokens: tokens,
        rosterUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },
      { merge: true }
    );

    const batch = firebaseDbInstance.batch();
    const studentsCol = ref.collection("students");

    tokens.forEach((tkn)=>{
      const sdoc = studentsCol.doc(String(tkn));
      batch.set(
        sdoc,
        {
          token: String(tkn),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastResult: null,
          progression: { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {} },
          best: { E: 0, C: 0, A: 0 }
        },
        { merge: true }
      );
    });

    await batch.commit();

    if (publicIdToUse) {
      try {
        await firebaseDbInstance.collection(PUBLIC_BANKS_COLLECTION).doc(String(publicIdToUse)).set(
          { rosterTokens: tokens, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
          { merge: true }
        );
        box.dataset.publicId = String(publicIdToUse);
      } catch (e2) {
        console.warn("Kunde inte uppdatera rosterTokens i public_banks:", e2);
      }
    }

    if (status) status.textContent = `‚úÖ Sparat i molnet + lokalt: ${tokens.length} elever till bank (${targetBankId}).`;
    alert(`Sparat! ${tokens.length} elever sparade.\nBank: ${targetBankId}`);
  } catch (e) {
    console.error("Kunde inte spara tokens i molnet:", e);
    if (status) status.textContent = "‚ö†Ô∏è Sparat lokalt, men kunde inte spara i molnet (se konsol).";
    alert("Sparade elevlistan lokalt, men kunde inte spara tokens i molnet. Se konsolen f√∂r detaljer.");
  }
}

/* =========================
   Bind roster-knappar
   ========================= */

(function FV3D_RosterBindOnce(){
  if (window.__fv3d_rosterBind) return;
  window.__fv3d_rosterBind = true;

  document.addEventListener("click", async (e)=>{
    const t = e.target && e.target.closest ? e.target.closest("button") : null;
    if (!t) return;

    if (t.id === "fv3dRosterSave") {
      e.preventDefault();
      await _fv3d_saveRosterToCloudAndLocal();
      return;
    }

    if (t.id === "fv3dRosterCopyLinks") {
      e.preventDefault();
      const st = document.getElementById("fv3dRosterStatus");
      const linkEl = document.getElementById("fv3dRosterLink");

      if (linkEl && !linkEl.value.trim()) {
        let rosterTokensFromUI = [];
        try { rosterTokensFromUI = (_fv3d_collectRosterFromUI().tokens || []); } catch {}
        try { await _fv3d_publishActiveBankToPublic({ rosterTokensOverride: rosterTokensFromUI }); } catch (e2) {
          console.error("Kopiera l√§nkar: kunde inte skapa elevl√§nk:", e2);
          if (_fv3d_isPermissionDenied(e2)) {
            if (st) st.textContent = "‚ùå Kan inte skapa elevl√§nk (permission-denied). Fix Firestore Rules f√∂r public_banks.";
            alert("Kan inte skapa elevl√§nk (permission-denied). Fix Firestore Rules f√∂r public_banks.");
          } else {
            if (st) st.textContent = "‚ùå Kunde inte skapa elevl√§nk. Se konsol.";
            alert("Kunde inte skapa elevl√§nk. Se konsolen.");
          }
          return;
        }
      }

      const basePublic = linkEl ? linkEl.value.trim() : "";
      if (!basePublic) { alert("Kunde inte skapa elevl√§nk."); return; }

      const rows = Array.from(document.getElementById("fv3dRosterGrid").children || []);
      rows.forEach((c)=>{
        try{
          if (c && c.ensureToken && typeof c.getRosterData === "function") {
            const d = c.getRosterData();
            const wants = (d.email||"").trim() || (d.name||"").trim() || (d.klass||"").trim();
            if (wants && !String(d.token||"").trim()) c.ensureToken();
          }
        }catch{}
      });

      const { rosterLocal } = _fv3d_collectRosterFromUI();
      const lines = rosterLocal.map((r)=>{
        const joiner = basePublic.includes("?") ? "&" : "?";
        const urlWithToken = `${basePublic}${joiner}token=${encodeURIComponent(r.token || "")}`;
        return `${r.name || ""}\t${r.klass || ""}\t${r.email || ""}\t${r.token || ""}\t${urlWithToken}`;
      });

      const out = lines.join("\n");
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(out);
        if (st) st.textContent = `üìã Kopierade ${lines.length} elevl√§nkar (namn, klass, e-post, token, l√§nk).`;
      } catch {
        if (st) st.textContent = `Kunde inte kopiera automatiskt. Markera text i status och kopiera manuellt:\n${out}`;
      }
      return;
    }
  });
})();
</script>
<!-- slut SEKTION 3Db: MOLN-BANK ‚Äì publish public + spara roster + kopiera l√§nkar -->








<!-- start SEKTION 3Dc: MOLN-BANK ‚Äì molnlistan, activate/delete, bind & ACTIVE-MARK (bankId + publicId) -->
<script>
"use strict";
/* √Ñndrat: Markerar aktiv bank som gr√∂n √§ven n√§r aktiviteten kommer fr√•n elevl√§nk (activeBank.publicId). Omskrivna rader: ca 22 */

function _fv3d_markActive(){
  const { host } = _fv3d_ensureCloudHost();
  if (!host) return;

  const activeBankId = _fv3d_activeBankId();
  const activePublicId = _fv3d_activePublicId();

  Array.from(host.querySelectorAll("li.list-item")).forEach((li)=>{
    const bid = String(li.getAttribute("data-bank-id") || "").trim();
    const pid = String(li.getAttribute("data-public-id") || "").trim();

    const matchTeacher = !!(activeBankId && bid && bid === String(activeBankId));
    const matchPublic  = !!(activePublicId && pid && pid === String(activePublicId));

    if (matchTeacher || matchPublic) li.classList.add("cloud-bank-active");
    else li.classList.remove("cloud-bank-active");
  });
}

function _fv3d_makeRow(docId, data){
  const li = document.createElement("li");
  li.className = "list-item";
  li.setAttribute("data-bank-id", String(docId));

  const publicId = (data && data.publicId) ? String(data.publicId) : "";
  if (publicId) li.setAttribute("data-public-id", publicId);

  const name = data && data.name ? String(data.name) : "Moln-bank";
  const bank = _fv3d_bankShape(data && data.bank ? data.bank : {});
  const mcq = bank.mcq.length, img = bank.img.length, drag = bank.drag.length;
  const total = mcq + img + drag;

  const rosterTokens = Array.isArray(data && data.rosterTokens) ? data.rosterTokens : [];
  const rosterCount = rosterTokens.map(t=>String(t||"").trim()).filter(Boolean).length;

  li.innerHTML = `
    <div class="list-main">
      <div class="q-text">${_fv3d_escape(name)} <span class="mini">(${total} fr√•gor)</span></div>
      <div class="q-meta">MCQ: ${mcq} ‚Ä¢ Bild: ${img} ‚Ä¢ Drag: ${drag}</div>
      <div class="q-meta">Tilldelade elever: ${rosterCount}</div>
    </div>
    <div class="fv3d-actions">
      <button class="btn btn-sm" type="button" data-fv3d-roster="${_fv3d_escape(docId)}">Elevlista</button>
      <button class="btn btn-sm btn-primary" type="button" data-fv3d-activate="${_fv3d_escape(docId)}">Aktivera</button>
      <button class="btn btn-sm btn-danger" type="button" data-fv3d-delete="${_fv3d_escape(docId)}" title="Ta bort">üóëÔ∏è</button>
    </div>
  `;
  return li;
}

async function _fv3d_loadBanks(){
  _fv3d_ensureStyles();
  const { host } = _fv3d_ensureCloudHost();

  host.innerHTML = `<li class="mini">Laddar moln-banker‚Ä¶</li>`;

  if (!_fv3d_hasFirebaseReady()) {
    host.innerHTML = `<li class="mini">‚ö†Ô∏è Firebase DB saknas (initFirebase k√∂rs inte).</li>`;
    _fv3d_setStatus("‚ö†Ô∏è Firebase DB saknas.");
    return;
  }
  if (!_fv3d_hasTeacher()) {
    host.innerHTML = `<li class="mini">‚òÅÔ∏è Logga in med Google f√∂r att se dina banker.</li>`;
    _fv3d_setStatus("‚òÅÔ∏è Inte inloggad.");
    return;
  }

  try {
    _fv3d_setStatus("Laddar‚Ä¶");

    const col = firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION)
      .doc(String(currentTeacherUser.uid))
      .collection(CLOUD_BANKS_SUBCOLLECTION);

    const snap = await col.limit(100).get();
    const docs = snap && snap.docs ? snap.docs.slice() : [];

    docs.sort((a,b)=>{
      try{
        const da = a.data() || {};
        const db = b.data() || {};
        const ta = da.createdAt && da.createdAt.toMillis ? da.createdAt.toMillis() : 0;
        const tb = db.createdAt && db.createdAt.toMillis ? db.createdAt.toMillis() : 0;
        return tb - ta;
      }catch{ return 0; }
    });

    host.innerHTML = "";
    if (!docs.length) {
      host.innerHTML = `<li class="mini">Inga moln-banker hittades f√∂r detta konto.</li>`;
      _fv3d_setStatus("0 banker.");
      return;
    }

    docs.forEach((d)=> host.appendChild(_fv3d_makeRow(d.id, d.data ? d.data() : {})));

    _fv3d_setStatus(`Laddat ${docs.length} banker.`);
    _fv3d_markActive();
  } catch (e) {
    console.error("Moln-banker: fel vid laddning:", e);
    host.innerHTML = `<li class="mini">‚ö†Ô∏è Fel vid laddning. Se konsolen.</li>`;
    _fv3d_setStatus("‚ö†Ô∏è Fel vid laddning (se konsol).");
  }
}

if (typeof window.loadCloudBanksListV4 !== "function") window.loadCloudBanksListV4 = _fv3d_loadBanks;
if (typeof window.loadCloudBanksList !== "function") window.loadCloudBanksList = _fv3d_loadBanks;

async function _fv3d_activate(bankId){
  if (!_fv3d_hasFirebaseReady() || !_fv3d_hasTeacher()) { alert("Logga in med Google f√∂rst."); return; }

  try {
    const ref = firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION)
      .doc(String(currentTeacherUser.uid))
      .collection(CLOUD_BANKS_SUBCOLLECTION)
      .doc(String(bankId));

    const doc = await ref.get();
    if (!doc.exists) { alert("Banken finns inte."); return; }
    const data = doc.data() || {};

    const bank = _fv3d_bankShape(data.bank || {});
    const goalsMap = Array.isArray(data.goalsMap) ? data.goalsMap : [];
    const publicId = data.publicId ? String(data.publicId) : "";

    if (typeof setBankInState === "function") setBankInState(bank);

    try{
      if (typeof loadState === "function" && typeof saveState === "function") {
        const s = loadState();
        s.goalsMap = goalsMap;
        saveState(s);
      }
    }catch{}

    _fv3d_setActiveMeta(bankId, publicId);

    try { if (typeof renderGoalsList === "function") renderGoalsList(); } catch {}
    try { if (typeof renderMcqList === "function") renderMcqList(); } catch {}
    try { if (typeof renderImgList === "function") renderImgList(); } catch {}
    try { if (typeof renderDragList === "function") renderDragList(); } catch {}
    try { if (typeof syncUI === "function") syncUI(); } catch {}
    try { if (typeof updateBankStatusUI === "function") updateBankStatusUI(); } catch {}

    _fv3d_markActive();
  } catch (e) {
    console.error("Aktivera bank: fel:", e);
    alert("Kunde inte aktivera bank. Se konsol.");
  }
}

async function _fv3d_delete(bankId){
  if (!_fv3d_hasFirebaseReady() || !_fv3d_hasTeacher()) { alert("Logga in med Google f√∂rst."); return; }
  if (!confirm("Ta bort moln-banken?")) return;

  try {
    const ref = firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION)
      .doc(String(currentTeacherUser.uid))
      .collection(CLOUD_BANKS_SUBCOLLECTION)
      .doc(String(bankId));

    await ref.delete();

    const active = _fv3d_activeBankId();
    if (active && String(active) === String(bankId)) {
      try {
        if (typeof setActiveBankMeta === "function") setActiveBankMeta({ mode:"", ownerUid:"", bankId:"", publicId:"" });
        if (typeof loadState === "function" && typeof saveState === "function") {
          const s = loadState();
          s.activeBank = { mode:"", ownerUid:"", bankId:"", publicId:"" };
          saveState(s);
        }
      } catch {}
      window.activeCloudBankId = "";
    }

    await window.loadCloudBanksListV4();
  } catch (e) {
    console.error("Ta bort bank: fel:", e);
    alert("Kunde inte ta bort bank. Se konsol.");
  }
}

function _fv3d_bind(){
  _fv3d_ensureStyles();
  _fv3d_ensureCloudHost();
  _fv3d_ensureRosterBox();

  if (!document.body.dataset.fv3dBound) {
    document.body.dataset.fv3dBound = "1";

    document.addEventListener("click", async (e)=>{
      const t = e.target && e.target.closest ? e.target.closest("button,[role='button'],a") : null;
      if (!t) return;

      if (t.id === "btnLoadCloudBanks") {
        e.preventDefault();
        await window.loadCloudBanksListV4();
        return;
      }
      const txt = (t.textContent || "").trim().toLowerCase();
      if (txt.includes("ladda") && txt.includes("moln")) {
        e.preventDefault();
        await window.loadCloudBanksListV4();
        return;
      }

      const act = t.getAttribute("data-fv3d-activate");
      if (act) { e.preventDefault(); await _fv3d_activate(String(act)); return; }

      const del = t.getAttribute("data-fv3d-delete");
      if (del) { e.preventDefault(); await _fv3d_delete(String(del)); return; }

      const ros = t.getAttribute("data-fv3d-roster");
      if (ros) {
        e.preventDefault();
        try { await _fv3d_activate(String(ros)); } catch {}
        await _fv3d_openRosterInline(String(ros));
        return;
      }
    });
  }

  try {
    if (_fv3d_hasFirebaseReady() && _fv3d_hasTeacher()) {
      const { host } = _fv3d_ensureCloudHost();
      const empty = !host || !host.children || host.children.length === 0;
      if (empty) window.loadCloudBanksListV4();
    }
  } catch {}

  try {
    if (typeof firebaseAuthInstance !== "undefined" && firebaseAuthInstance && typeof firebaseAuthInstance.onAuthStateChanged === "function") {
      if (!firebaseAuthInstance.__fv3dHooked) {
        firebaseAuthInstance.__fv3dHooked = true;
        firebaseAuthInstance.onAuthStateChanged((user)=>{
          try { currentTeacherUser = user || null; } catch {}
          if (user) {
            try { window.loadCloudBanksListV4(); } catch {}
          } else {
            const { host } = _fv3d_ensureCloudHost();
            if (host) host.innerHTML = `<li class="mini">‚òÅÔ∏è Logga in med Google f√∂r att se dina banker.</li>`;
            _fv3d_setStatus("‚òÅÔ∏è Inte inloggad.");
            const box = document.getElementById("fv3dRosterBox");
            if (box) box.classList.add("hidden");
          }
        });
      }
    }
  } catch {}

  // Viktigt: om activeBank.publicId redan finns i state (fr√•n elevvyn), markera n√§r listan v√§l syns
  try { _fv3d_markActive(); } catch {}
}

document.addEventListener("DOMContentLoaded", _fv3d_bind);
</script>
<!-- slut SEKTION 3Dc: MOLN-BANK ‚Äì molnlistan, activate/delete, bind & ACTIVE-MARK (bankId + publicId) -->







<!-- start SEKTION 3Dd: ELEVRESULTAT ‚Äì lista elever som spelat + v√§lj elev + starka/svaga delbitar + format (E/C/A per rad) -->
<!-- √ÑNDRAT: L√§gger till inl√§sning av elevernas resultat fr√•n Firestore per aktiv bank/token och renderar elevlista i Elevprogression. Omskrivna/nya rader: ca 260 -->
<script>
"use strict";

/* =========================
   3Dd ‚Äì Elevresultat (Firestore -> UI)
   ========================= */

function _fv3d_getProgressPanel(){
  return document.querySelector('.tab-panel[data-panel="progress"]') || document.getElementById("progressPointsBox")?.closest(".tab-panel") || null;
}

function _fv3d_ensureStudentsUI(){
  const panel = _fv3d_getProgressPanel();
  if (!panel) return null;

  // Se till att vi har en container i progress-tabben utan att √§ndra HTML i SEKTION 2
  let wrap = document.getElementById("fv3dStudentsWrap");
  if (!wrap) {
    wrap = document.createElement("div");
    wrap.id = "fv3dStudentsWrap";
    wrap.className = "card card-full-width";
    wrap.style.marginTop = "10px";
    wrap.innerHTML = `
      <h3>Elever som spelat (fr√•n aktiv bank)</h3>
      <p class="mini" id="fv3dStudentsHint">Klicka p√• en elev f√∂r att visa po√§ng + starka/svaga delbitar.</p>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:8px;">
        <button id="fv3dStudentsRefresh" class="btn btn-sm" type="button">üîÅ Uppdatera</button>
      </div>
      <ul id="fv3dStudentsList" class="goals-list" style="margin-top:10px;"></ul>
      <p class="mini" id="fv3dStudentsStatus" style="margin-top:8px; white-space:pre-wrap;"></p>
    `;

    const hostCard = panel.querySelector(".card") || panel;
    hostCard.appendChild(wrap);
  }

  return wrap;
}

function _fv3d_setStudentsStatus(msg){
  const el = document.getElementById("fv3dStudentsStatus");
  if (el) el.textContent = msg || "";
}

function _fv3d_getActiveContextForResults(){
  // Returnerar { mode, ownerUid, bankId, publicId }
  try {
    if (typeof loadState === "function") {
      const s = loadState();
      const ab = (s && s.activeBank) ? s.activeBank : {};
      return {
        mode: String(ab.mode || ""),
        ownerUid: String(ab.ownerUid || ""),
        bankId: String(ab.bankId || ""),
        publicId: String(ab.publicId || "")
      };
    }
  } catch {}
  return { mode:"", ownerUid:"", bankId:"", publicId:"" };
}

async function _fv3d_resolveTeacherBankFromPublic(publicId){
  // public_banks/{publicId} -> { sourceTeacherUid, sourceBankId }
  if (!_fv3d_hasFirebaseReady()) throw new Error("Firebase saknas");
  const ref = firebaseDbInstance.collection(PUBLIC_BANKS_COLLECTION).doc(String(publicId));
  const snap = await ref.get();
  if (!snap.exists) throw new Error("Public bank finns inte");
  const data = snap.data() || {};
  const uid = String(data.sourceTeacherUid || "").trim();
  const bid = String(data.sourceBankId || "").trim();
  if (!uid || !bid) throw new Error("Public bank saknar sourceTeacherUid/sourceBankId");
  return { ownerUid: uid, bankId: bid };
}

function _fv3d_studentLabel(d){
  const nm = (d && (d.name || d.studentName || d.displayName)) ? String(d.name || d.studentName || d.displayName) : "";
  const kl = (d && (d.klass || d.class || d.studentClass)) ? String(d.klass || d.class || d.studentClass) : "";
  const tk = (d && d.token) ? String(d.token) : "";
  if (nm || kl) return `${nm || "Ok√§nd"}${kl ? " (" + kl + ")" : ""}${tk ? " ‚Äì " + tk : ""}`;
  return tk ? `Token: ${tk}` : "Ok√§nd elev";
}

function _fv3d_safeNum(x){ return (typeof x === "number" && isFinite(x)) ? x : 0; }

function _fv3d_formatBestLines(best, thres){
  const b = best || { E:0, C:0, A:0 };
  const t = thres || { E:0, C:0, A:0 };
  const lineE = `B√§sta E: ${_fv3d_safeNum(b.E)}% (gr√§ns ${_fv3d_safeNum(t.E)}%)`;
  const lineC = `B√§sta C: ${_fv3d_safeNum(b.C)}% (gr√§ns ${_fv3d_safeNum(t.C)}%)`;
  const lineA = `B√§sta A: ${_fv3d_safeNum(b.A)}% (gr√§ns ${_fv3d_safeNum(t.A)}%)`;
  return `${lineE}\n${lineC}\n${lineA}`;
}

function _fv3d_formatLastLine(lastSubmission){
  if (!lastSubmission || typeof lastSubmission !== "object") return "Senast: -";
  const lvl = String(lastSubmission.level || lastSubmission.currentLevel || "-");
  const pct = (typeof lastSubmission.percent === "number") ? `${Math.round(lastSubmission.percent)}%` : (lastSubmission.scorePct != null ? `${lastSubmission.scorePct}%` : "-");
  const corr = (typeof lastSubmission.correct === "number") ? lastSubmission.correct : (typeof lastSubmission.correctCount === "number" ? lastSubmission.correctCount : null);
  const tot  = (typeof lastSubmission.total === "number") ? lastSubmission.total : (typeof lastSubmission.totalCount === "number" ? lastSubmission.totalCount : null);
  const pts  = (typeof lastSubmission.points === "number") ? lastSubmission.points : (typeof lastSubmission.earnedPoints === "number" ? lastSubmission.earnedPoints : null);

  const ratio = (corr != null && tot != null) ? ` (${corr}/${tot} r√§tt)` : "";
  const add   = (pts != null) ? ` +${pts}p` : "";
  return `Senast: niv√• ${lvl} ‚Äì ${pct}${ratio}${add}`;
}

function _fv3d_renderStrongWeakFromProgression(prog){
  const strongList = document.getElementById("progressStrongList");
  const weakList = document.getElementById("progressWeakList");
  if (!strongList || !weakList) return;

  const s = (typeof loadState === "function") ? loadState() : null;
  const goalsMap = (s && Array.isArray(s.goalsMap)) ? s.goalsMap : [];

  const correct = (prog && prog.correctByGoalId) ? prog.correctByGoalId : {};
  const wrong   = (prog && prog.wrongByGoalId) ? prog.wrongByGoalId : {};

  const rows = [];
  const keys = new Set([ ...Object.keys(correct||{}), ...Object.keys(wrong||{}) ]);

  keys.forEach((k)=>{
    const c = _fv3d_safeNum(correct[k]);
    const w = _fv3d_safeNum(wrong[k]);
    const a = c + w;
    if (!a) return;
    const acc = a ? (c / a) : 0;
    const gm = goalsMap.find(g => String(g.id) === String(k));
    const label = gm ? `${gm.goal || "Delm√•l"} ‚Äì ${gm.parts || ""}`.trim() : `Delbit-id: ${k}`;
    rows.push({ key:String(k), c, w, a, acc, label });
  });

  // heuristik: "stark" = minst 3 f√∂rs√∂k och >= 80% r√§tt
  // "svag"   = minst 3 f√∂rs√∂k och <= 60% r√§tt, eller minst 2 fel
  const strong = rows
    .filter(r => r.a >= 3 && r.acc >= 0.80)
    .sort((a,b)=> (b.acc - a.acc) || (b.a - a.a))
    .slice(0, 8);

  const weak = rows
    .filter(r => (r.a >= 3 && r.acc <= 0.60) || (r.w >= 2 && r.acc < 0.80))
    .sort((a,b)=> (b.w - a.w) || (a.acc - b.acc) || (b.a - a.a))
    .slice(0, 8);

  strongList.innerHTML = "";
  weakList.innerHTML = "";

  if (!strong.length) strongList.innerHTML = `<li>Inga starka delbitar hittades √§nnu.</li>`;
  else {
    strong.forEach(r=>{
      const li = document.createElement("li");
      li.textContent = `${r.label} ‚Ä¢ ${Math.round(r.acc*100)}% (${r.c} r√§tt, ${r.w} fel)`;
      strongList.appendChild(li);
    });
  }

  if (!weak.length) weakList.innerHTML = `<li>Inga svaga delbitar hittades √§nnu.</li>`;
  else {
    weak.forEach(r=>{
      const li = document.createElement("li");
      li.textContent = `${r.label} ‚Ä¢ ${Math.round(r.acc*100)}% (${r.c} r√§tt, ${r.w} fel)`;
      weakList.appendChild(li);
    });
  }
}

function _fv3d_applyStudentToProgressUI(studentDoc){
  const pointsEl = document.getElementById("progressPointsText");
  if (!pointsEl) return;

  const s = (typeof loadState === "function") ? loadState() : null;
  const thres = (s && s.thres) ? s.thres : {E:0,C:0,A:0};

  const totalPoints = _fv3d_safeNum(studentDoc && studentDoc.totalPoints != null ? studentDoc.totalPoints : (studentDoc && studentDoc.progression && studentDoc.progression.totalPoints));
  const lastSub = studentDoc && (studentDoc.lastSubmission || studentDoc.lastResult || studentDoc.last);
  const best = studentDoc && (studentDoc.best || {E:0,C:0,A:0});

  const lines =
    `Totalt: ${totalPoints} p.` + "\n" +
    _fv3d_formatLastLine(lastSub) + "\n" +
    _fv3d_formatBestLines(best, thres);

  pointsEl.textContent = lines;

  const prog = studentDoc && (studentDoc.progression || { totalPoints: totalPoints, wrongByGoalId:{}, correctByGoalId:{} });
  _fv3d_renderStrongWeakFromProgression(prog);

  // Exportbox: fyll JSON (om knapparna anv√§nds)
  const exportEl = document.getElementById("progressExportJson");
  if (exportEl) {
    try {
      const payload = {
        token: studentDoc && studentDoc.token ? String(studentDoc.token) : "",
        name: studentDoc && studentDoc.name ? String(studentDoc.name) : "",
        klass: studentDoc && studentDoc.klass ? String(studentDoc.klass) : "",
        totalPoints: totalPoints,
        best: best,
        last: lastSub || null,
        progression: prog
      };
      exportEl.value = JSON.stringify(payload);
    } catch {}
  }
}

function _fv3d_makeStudentRow(studentDoc){
  const li = document.createElement("li");
  li.className = "list-item";

  const label = _fv3d_studentLabel(studentDoc);
  const totalPoints = _fv3d_safeNum(studentDoc && studentDoc.totalPoints != null ? studentDoc.totalPoints : (studentDoc && studentDoc.progression && studentDoc.progression.totalPoints));
  const best = studentDoc && studentDoc.best ? studentDoc.best : {E:0,C:0,A:0};

  li.innerHTML = `
    <div class="list-main">
      <div class="q-text">${_fv3d_escape(label)}</div>
      <div class="q-meta">Po√§ng: ${totalPoints} ‚Ä¢ B√§sta: E ${_fv3d_safeNum(best.E)}% ‚Ä¢ C ${_fv3d_safeNum(best.C)}% ‚Ä¢ A ${_fv3d_safeNum(best.A)}%</div>
    </div>
    <div class="fv3d-actions">
      <button class="btn btn-sm btn-primary" type="button" data-fv3d-pick-student="1">Visa</button>
    </div>
  `;

  const btn = li.querySelector("button[data-fv3d-pick-student]");
  if (btn) {
    btn.addEventListener("click", ()=>{
      _fv3d_applyStudentToProgressUI(studentDoc);
      _fv3d_setStudentsStatus(`Visar: ${label}`);
    });
  }

  return li;
}

async function _fv3d_loadStudentsFromFirestoreForActive(){
  _fv3d_ensureStudentsUI();
  const list = document.getElementById("fv3dStudentsList");
  if (!list) return;

  list.innerHTML = `<li class="mini">Laddar elevresultat‚Ä¶</li>`;
  _fv3d_setStudentsStatus("");

  if (!_fv3d_hasFirebaseReady()) {
    list.innerHTML = `<li class="mini">‚ö†Ô∏è Firebase saknas (initFirebase k√∂rs inte).</li>`;
    _fv3d_setStudentsStatus("‚ö†Ô∏è Firebase saknas.");
    return;
  }
  if (!_fv3d_hasTeacher()) {
    list.innerHTML = `<li class="mini">‚òÅÔ∏è Logga in med Google f√∂r att l√§sa elevresultat.</li>`;
    _fv3d_setStudentsStatus("‚òÅÔ∏è Inte inloggad.");
    return;
  }

  const ctx = _fv3d_getActiveContextForResults();
  let ownerUid = String(currentTeacherUser.uid || "");
  let bankId = (ctx && ctx.bankId) ? String(ctx.bankId) : "";
  const publicId = (ctx && ctx.publicId) ? String(ctx.publicId) : "";

  // Om vi saknar bankId men har publicId, f√∂rs√∂k resolve till teacher bank
  if (!bankId && publicId) {
    try {
      const resolved = await _fv3d_resolveTeacherBankFromPublic(publicId);
      ownerUid = resolved.ownerUid;
      bankId = resolved.bankId;
    } catch (e) {
      console.error("Kunde inte resolve public -> teacher bank:", e);
      list.innerHTML = `<li class="mini">‚ö†Ô∏è Kan inte hitta bank via publicId. Se konsolen.</li>`;
      _fv3d_setStudentsStatus("‚ö†Ô∏è Kan inte resolve publicId till bank.");
      return;
    }
  }

  if (!bankId) {
    list.innerHTML = `<li class="mini">‚ö†Ô∏è Ingen aktiv bank. Aktivera en bank i Fr√•gebank-fliken.</li>`;
    _fv3d_setStudentsStatus("‚ö†Ô∏è Ingen aktiv bankId.");
    return;
  }

  try {
    const studentsCol = firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION)
      .doc(String(ownerUid))
      .collection(CLOUD_BANKS_SUBCOLLECTION)
      .doc(String(bankId))
      .collection("students");

    // F√∂rs√∂k h√§mta senaste 200 (docId=token)
    const snap = await studentsCol.limit(200).get();
    const docs = (snap && snap.docs) ? snap.docs : [];

    if (!docs.length) {
      list.innerHTML = `<li class="mini">Inga elevresultat hittades √§nnu f√∂r denna bank.</li>`;
      _fv3d_setStudentsStatus(`Bank: ${bankId}\nTips: l√•t en elev spela och l√§mna in niv√• ‚Äì d√• skapas students/{token}.`);
      return;
    }

    const students = docs.map(d=>{
      const data = d.data() || {};
      // normalisera token
      if (!data.token) data.token = d.id;
      // normalisera totalPoints
      if (data.totalPoints == null && data.progression && typeof data.progression.totalPoints === "number") data.totalPoints = data.progression.totalPoints;
      return data;
    });

    // sort: mest po√§ng f√∂rst
    students.sort((a,b)=> _fv3d_safeNum(b.totalPoints) - _fv3d_safeNum(a.totalPoints));

    list.innerHTML = "";
    students.forEach(st=> list.appendChild(_fv3d_makeStudentRow(st)));

    _fv3d_setStudentsStatus(`Bank: ${bankId}\nHittade ${students.length} elev(er). Klicka ‚ÄúVisa‚Äù p√• en elev.`);
  } catch (e) {
    console.error("Fel vid laddning av elever:", e);
    if (_fv3d_isPermissionDenied(e)) {
      list.innerHTML = `<li class="mini">‚ùå Saknar r√§ttigheter att l√§sa students (permission-denied).</li>`;
      _fv3d_setStudentsStatus("‚ùå permission-denied: Firestore Rules stoppar l√§sning av students.");
    } else {
      list.innerHTML = `<li class="mini">‚ö†Ô∏è Fel vid laddning. Se konsolen.</li>`;
      _fv3d_setStudentsStatus("‚ö†Ô∏è Fel vid laddning (se konsol).");
    }
  }
}

/* =========================
   Bind: refresh + auto-load n√§r progress-tabben √∂ppnas
   ========================= */

(function FV3D_StudentsBindOnce(){
  if (window.__fv3d_studentsBind) return;
  window.__fv3d_studentsBind = true;

  document.addEventListener("click", async (e)=>{
    const t = e.target && e.target.closest ? e.target.closest("button") : null;
    if (!t) return;

    if (t.id === "fv3dStudentsRefresh") {
      e.preventDefault();
      await _fv3d_loadStudentsFromFirestoreForActive();
      return;
    }

    // N√§r man klickar in p√• progress-tabben: ladda elevlista
    if (t.id === "tab-progress" || t.getAttribute("data-tab") === "progress") {
      // liten delay s√• panelen hinner visas
      setTimeout(()=>{ _fv3d_loadStudentsFromFirestoreForActive(); }, 80);
      return;
    }
  });

  // Om progress-tabben r√•kar vara f√∂rst: skapa UI
  document.addEventListener("DOMContentLoaded", ()=>{
    try { _fv3d_ensureStudentsUI(); } catch {}
  });
})();

// Exponera f√∂r andra sektioner (om du vill trigga efter bank-aktivering)
window.fv3dLoadStudentsForActiveBank = _fv3d_loadStudentsFromFirestoreForActive;
</script>
<!-- slut SEKTION 3Dd: ELEVRESULTAT ‚Äì lista elever som spelat + v√§lj elev + starka/svaga delbitar + format (E/C/A per rad) -->







<!-- start SEKTION 3E: DELM√ÖL & DELBITAR (goalsMap) -->
<!-- √ÑNDRAT: Skapar saknade knappar (Spara/Ta bort alla) dynamiskt i UI s√• 3E funkar med din SEKTION 2 utan HTML-√§ndring. Omskrivna rader: ca 70 -->
<script>
"use strict";

/* √ÑNDRINGAR (kort):
   1) Auto-skapar #btnSaveGoalsMap och #btnClearGoalsMap om de saknas i HTML.
   2) L√§gger dem i samma kort som ‚ÄúKoppling: delm√•l & delbitar‚Äù.
*/

function populateGoalSelect(selectElIdOrEl) {
  try {
    const sel =
      (typeof selectElIdOrEl === "string")
        ? document.querySelector(selectElIdOrEl)
        : selectElIdOrEl;

    if (!sel) return;

    const s = (typeof loadState === "function") ? loadState() : { goalsMap: [] };
    const goals = Array.isArray(s.goalsMap) ? s.goalsMap : [];

    sel.innerHTML = "";
    const def = document.createElement("option");
    def.value = "";
    def.textContent = "Ingen koppling";
    sel.appendChild(def);

    goals.forEach((g) => {
      const opt = document.createElement("option");
      opt.value = String(g.id);
      const goal = (g.goal || "-");
      const parts = (g.parts || "-");
      opt.textContent = `${goal} ‚Ä¢ ${parts}`;
      sel.appendChild(opt);
    });
  } catch (e) {
    console.warn("populateGoalSelect misslyckades:", e);
  }
}

function _goals_refreshAllGoalSelects() {
  try { populateGoalSelect("#mcqGoalPart"); } catch {}
  try { populateGoalSelect("#imgGoalPart"); } catch {}
  try { populateGoalSelect("#dragGoalPart"); } catch {}
  try { populateGoalSelect("#mcqJsonGoalPart"); } catch {}
}

function _goals_groupByGoal(list){
  const groups = new Map();
  (list || []).forEach((g)=>{
    const goal = String((g && g.goal) ? g.goal : "").trim() || "Delm√•l (saknas rubrik)";
    if (!groups.has(goal)) groups.set(goal, []);
    groups.get(goal).push(g);
  });
  return Array.from(groups.entries()).map(([goal, items])=>({ goal, items }));
}

function renderGoalsList() {
  const host = document.querySelector("#goalsList");
  if (!host) return false;

  const s = (typeof loadState === "function") ? loadState() : { goalsMap: [] };
  const list = Array.isArray(s.goalsMap) ? s.goalsMap : [];

  host.innerHTML = "";

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga sparade delm√•l/delbitar √§nnu.";
    host.appendChild(li);
    _goals_refreshAllGoalSelects();
    return true;
  }

  const grouped = _goals_groupByGoal(list);

  grouped.forEach((grp) => {
    const liGoal = document.createElement("li");
    liGoal.className = "list-item";
    liGoal.innerHTML = `
      <div class="list-main">
        <div class="q-text">${escapeHtml(grp.goal)}</div>
        <div class="q-meta">${grp.items.length} delbitar</div>
      </div>
      <div></div>
    `;
    host.appendChild(liGoal);

    grp.items.forEach((g) => {
      const li = document.createElement("li");
      li.className = "list-item";
      li.setAttribute("data-goal-id", String(g.id));

      const parts = (typeof escapeHtml === "function") ? escapeHtml(g.parts || "-") : String(g.parts || "-");

      li.innerHTML = `
        <div class="list-main">
          <div class="q-text">${parts}</div>
        </div>
        <div>
          <button class="btn btn-sm btn-danger" type="button" data-del-goal-id="${String(g.id)}">üóëÔ∏è</button>
        </div>
      `;
      host.appendChild(li);
    });
  });

  host.querySelectorAll("button[data-del-goal-id]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del-goal-id");
      if (!id) return;

      const s2 = (typeof loadState === "function") ? loadState() : null;
      if (!s2 || typeof saveState !== "function") return;

      s2.goalsMap = (Array.isArray(s2.goalsMap) ? s2.goalsMap : []).filter((g) => String(g.id) !== String(id));
      saveState(s2);

      renderGoalsList();
      _goals_refreshAllGoalSelects();
      if (typeof syncUI === "function") syncUI();
    });
  });

  _goals_refreshAllGoalSelects();
  return true;
}

function _goals_renderRetry(maxTries){
  let tries = 0;
  function tick(){
    tries++;
    const ok = renderGoalsList();
    if (!ok && tries < maxTries) setTimeout(tick, 120);
  }
  tick();
}

function _goals_ensureSaveClearButtons(btnAdd){
  // Din HTML har bara "L√§gg till delbit" ‚Äì d√§rf√∂r skapar vi "Spara" och "Ta bort alla" h√§r.
  const card = btnAdd ? (btnAdd.closest(".card") || btnAdd.parentElement) : null;
  if (!card) return;

  let btnSave = document.querySelector("#btnSaveGoalsMap");
  let btnClear = document.querySelector("#btnClearGoalsMap");

  if (btnSave && btnClear) return;

  const row = document.createElement("div");
  row.className = "card-row";
  row.style.marginTop = "6px";
  row.style.gap = "8px";
  row.style.flexWrap = "wrap";

  if (!btnSave) {
    btnSave = document.createElement("button");
    btnSave.id = "btnSaveGoalsMap";
    btnSave.className = "btn btn-sm btn-primary";
    btnSave.type = "button";
    btnSave.textContent = "üíæ Spara";
    row.appendChild(btnSave);
  }

  if (!btnClear) {
    btnClear = document.createElement("button");
    btnClear.id = "btnClearGoalsMap";
    btnClear.className = "btn btn-sm btn-danger";
    btnClear.type = "button";
    btnClear.textContent = "üßπ Ta bort alla";
    row.appendChild(btnClear);
  }

  card.appendChild(row);
}

function initGoalsMap() {
  if (window.__goalsMapInited) return;
  window.__goalsMapInited = true;

  const inputGoal = document.querySelector("#inputGoalSingle");
  const inputPart = document.querySelector("#inputPartSingle");
  const btnAdd = document.querySelector("#btnAddGoalPart");
  const statusEl = document.querySelector("#goalsStatus");

  if (btnAdd) _goals_ensureSaveClearButtons(btnAdd);

  const btnSave = document.querySelector("#btnSaveGoalsMap");
  const btnClear = document.querySelector("#btnClearGoalsMap");

  if (btnAdd) {
    btnAdd.addEventListener("click", () => {
      const goalText = (inputGoal && inputGoal.value.trim()) || "";
      const partsText = (inputPart && inputPart.value.trim()) || "";

      if (!goalText || !partsText) {
        if (statusEl) statusEl.textContent = "Skriv b√•de delm√•l (rubrik) och delbit (text).";
        return;
      }

      const s = (typeof loadState === "function") ? loadState() : null;
      if (!s || typeof saveState !== "function") return;

      if (!Array.isArray(s.goalsMap)) s.goalsMap = [];
      s.goalsMap.push({ id: Date.now(), goal: goalText, parts: partsText });
      saveState(s);

      if (inputGoal) inputGoal.value = "";
      if (inputPart) inputPart.value = "";
      if (statusEl) statusEl.textContent = "Delbit tillagd.";

      renderGoalsList();
      if (typeof syncUI === "function") syncUI();
    });
  }

  if (btnSave) {
    btnSave.addEventListener("click", () => {
      try {
        const s = (typeof loadState === "function") ? loadState() : null;
        if (s && typeof saveState === "function") saveState(s);
        if (statusEl) statusEl.textContent = "Delm√•l & delbitar sparade.";
      } catch (e) {
        if (statusEl) statusEl.textContent = "Kunde inte spara (se konsol).";
        console.error(e);
      }
      renderGoalsList();
    });
  }

  if (btnClear) {
    btnClear.addEventListener("click", () => {
      if (!confirm("Ta bort alla delm√•l och delbitar?")) return;

      const s = (typeof loadState === "function") ? loadState() : null;
      if (!s || typeof saveState !== "function") return;

      s.goalsMap = [];
      saveState(s);

      if (statusEl) statusEl.textContent = "Alla delm√•l/delbitar borttagna.";
      renderGoalsList();
      if (typeof syncUI === "function") syncUI();
    });
  }

  _goals_renderRetry(25);
}

/* Failsafe: spegla globalt */
window.populateGoalSelect = populateGoalSelect;
window.renderGoalsList = renderGoalsList;
window.initGoalsMap = initGoalsMap;

/* K√∂r s√• tidigt som m√∂jligt + retry tills paneler finns */
try { initGoalsMap(); } catch {}
document.addEventListener("DOMContentLoaded", () => {
  try { initGoalsMap(); } catch {}
  try { _goals_renderRetry(25); } catch {}
});
</script>
<!-- slut SEKTION 3E: DELM√ÖL & DELBITAR (goalsMap) -->









<!-- start SEKTION 3F: KOPPLINGAR ‚Äì helpers f√∂r delm√•ls-taggar -->
<script>
"use strict";

function buildGoalInfoText(q) {
  const tags = [];

  const esc = (typeof window.escapeHtml === "function")
    ? window.escapeHtml
    : function (str) {
        if (!str && str !== 0) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      };

  if (q && Array.isArray(q.links) && q.links.length) {
    q.links.forEach((lnk) => {
      const goal = esc(lnk.goal || "-");
      const parts = esc(lnk.parts || "-");
      tags.push(`<span class="goal-tag">${goal} (Delbitar: ${parts})</span>`);
    });
  } else if (q) {
    if (q.goal || q.parts) {
      let txt = "Delm√•l: " + (q.goal || "-");
      if (q.parts) txt += " (Delbitar: " + q.parts + ")";
      tags.push(`<span class="goal-tag">${esc(txt)}</span>`);
    }
    if (q.goalExtra || q.partsExtra) {
      let txt2 = "Delm√•l: " + (q.goalExtra || "-");
      if (q.partsExtra) txt2 += " (Delbitar: " + q.partsExtra + ")";
      tags.push(`<span class="goal-tag">${esc(txt2)}</span>`);
    }
  }

  if (!tags.length) return '<span class="goal-tag goal-tag-none">Ingen koppling till delm√•l</span>';
  return tags.join(" ");
}

function getLinksFromIds(idArray) {
  const s = (typeof window.loadState === "function") ? window.loadState() : { goalsMap: [] };
  const goals = (s && Array.isArray(s.goalsMap)) ? s.goalsMap : [];
  return (idArray || [])
    .map((id) => goals.find((g) => String(g.id) === String(id)))
    .filter(Boolean)
    .map((g) => ({ id: g.id, goal: g.goal, parts: g.parts }));
}

window.buildGoalInfoText = buildGoalInfoText;
window.getLinksFromIds = getLinksFromIds;
</script>
<!-- slut SEKTION 3F: KOPPLINGAR ‚Äì helpers f√∂r delm√•ls-taggar -->



<!-- start SEKTION 3G: FLERVAL (MCQ) ‚Äì lista, editor, snabbimport -->
<script>
"use strict";

/* (of√∂r√§ndrad fr√•n din version ‚Äì beh√•ller funktionalitet) */
function renderMcqList() {
  const listEl = $("#mcqList");
  const countEl = $("#mcqCount");
  if (!listEl) return;

  const s = loadState();
  const list = (s.bank && s.bank.mcq) || [];

  listEl.innerHTML = "";
  if (countEl) countEl.textContent = String(list.length);

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga fr√•gor i banken √§nnu.";
    listEl.appendChild(li);
    return;
  }

  list.forEach((q, idx) => {
    const li = document.createElement("li");
    li.className = "list-item";

    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    else if (lvl === "A") tagClass = "level-a";

    const goalInfo = buildGoalInfoText(q);

    li.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          [${idx + 1}] ${escapeHtml(q.q || "")}
          <span class="level-tag ${tagClass}">${lvl}</span>
        </div>
        <div class="q-meta">${goalInfo}</div>
      </div>
      <div>
        <button class="btn btn-sm btn-danger" type="button" data-del-index="${idx}">üóëÔ∏è</button>
      </div>
    `;
    listEl.appendChild(li);
  });

  listEl.querySelectorAll("button[data-del-index]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const index = Number(btn.getAttribute("data-del-index"));
      const s2 = loadState();
      if (!Array.isArray(s2.bank.mcq) || index < 0 || index >= s2.bank.mcq.length) return;
      s2.bank.mcq.splice(index, 1);
      saveState(s2);
      renderMcqList();
      if (typeof syncUI === "function") syncUI();
    });
  });
}

function initQuestionForms() {
  const mcqLevel = $("#mcqLevel");
  const mcqQuestion = $("#mcqQuestion");
  const mcqOpt0 = $("#mcqOption0");
  const mcqOpt1 = $("#mcqOption1");
  const mcqOpt2 = $("#mcqOption2");
  const mcqOpt3 = $("#mcqOption3");
  const mcqGoalPart = $("#mcqGoalPart");
  const btnAdd = $("#btnMcqAdd");
  const btnClear = $("#btnMcqClear");

  if (!btnAdd || !mcqLevel || !mcqQuestion || !mcqOpt0 || !mcqOpt1) return;

  currentMcqCorrectIndex = 0;
  currentMcqLinks = [];

  const answerHostId = "mcqCorrectContainer";
  let answerHost = document.getElementById(answerHostId);
  if (!answerHost && mcqQuestion && mcqQuestion.parentElement) {
    answerHost = document.createElement("div");
    answerHost.id = answerHostId;
    answerHost.className = "mini";
    answerHost.style.marginTop = "6px";
    mcqQuestion.parentElement.appendChild(answerHost);
  }

  if (answerHost && !answerHost.dataset.ready) {
    answerHost.dataset.ready = "1";
    answerHost.textContent = "V√§lj vilket alternativ som √§r r√§tt: ";
    const row = document.createElement("span");
    row.style.marginLeft = "8px";
    ["1", "2", "3", "4"].forEach((lbl, idx) => {
      const lab = document.createElement("label");
      lab.style.marginRight = "8px";
      lab.style.cursor = "pointer";
      const r = document.createElement("input");
      r.type = "radio";
      r.name = "mcqCorrectRadio";
      r.value = String(idx);
      if (idx === 0) r.checked = true;
      r.addEventListener("change", () => { currentMcqCorrectIndex = idx; });
      lab.appendChild(r);
      lab.appendChild(document.createTextNode(" " + lbl));
      row.appendChild(lab);
    });
    answerHost.appendChild(row);
  }

  let mcqLinksPreview = $("#mcqGoalLinksPreview");
  if (mcqGoalPart && mcqGoalPart.parentElement && !document.getElementById("btnMcqAddGoalLink")) {
    const btnLink = document.createElement("button");
    btnLink.type = "button";
    btnLink.className = "btn btn-sm";
    btnLink.id = "btnMcqAddGoalLink";
    btnLink.textContent = "‚ûï L√§gg till delm√•ls-koppling";

    mcqLinksPreview = document.createElement("div");
    mcqLinksPreview.id = "mcqGoalLinksPreview";
    mcqLinksPreview.className = "mini";
    mcqLinksPreview.style.marginTop = "6px";
    mcqLinksPreview.textContent = "Inga kopplingar √§nnu.";

    mcqGoalPart.parentElement.appendChild(btnLink);
    mcqGoalPart.parentElement.appendChild(mcqLinksPreview);

    btnLink.addEventListener("click", () => {
      const val = mcqGoalPart.value;
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!currentMcqLinks.some((x) => String(x.id) === String(link.id))) currentMcqLinks.push(link);
      if (mcqLinksPreview) {
        mcqLinksPreview.innerHTML = currentMcqLinks
          .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
          .join(" ");
      }
    });
  }

  btnAdd.addEventListener("click", () => {
    const s = loadState();
    const level = mcqLevel.value || "E";
    const text = mcqQuestion.value.trim();
    const opts = [
      mcqOpt0.value.trim(),
      mcqOpt1.value.trim(),
      mcqOpt2 ? mcqOpt2.value.trim() : "",
      mcqOpt3 ? mcqOpt3.value.trim() : ""
    ].filter((o) => o.length > 0);

    if (!text || opts.length < 2) {
      alert("Skriv en fr√•ga och minst tv√• svarsalternativ.");
      return;
    }

    let answerIndex = currentMcqCorrectIndex || 0;
    if (answerIndex >= opts.length) answerIndex = 0;

    const links = currentMcqLinks.slice();

    const newQ = {
      type: "mcq",
      level,
      q: text,
      options: opts,
      answer: answerIndex,
      links: links
    };

    if (links.length) {
      newQ.goal = links[0].goal;
      newQ.parts = links[0].parts;
    }

    if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
    s.bank.mcq.push(newQ);
    saveState(s);

    mcqQuestion.value = "";
    mcqOpt0.value = "";
    mcqOpt1.value = "";
    if (mcqOpt2) mcqOpt2.value = "";
    if (mcqOpt3) mcqOpt3.value = "";
    if (mcqGoalPart) mcqGoalPart.value = "";
    currentMcqLinks = [];
    if (mcqLinksPreview) mcqLinksPreview.textContent = "Inga kopplingar √§nnu.";
    currentMcqCorrectIndex = 0;

    const firstRadio = document.querySelector('input[name="mcqCorrectRadio"][value="0"]');
    if (firstRadio) firstRadio.checked = true;

    renderMcqList();
    if (typeof syncUI === "function") syncUI();
  });

  if (btnClear) {
    btnClear.addEventListener("click", () => {
      mcqQuestion.value = "";
      mcqOpt0.value = "";
      mcqOpt1.value = "";
      if (mcqOpt2) mcqOpt2.value = "";
      if (mcqOpt3) mcqOpt3.value = "";
      if (mcqGoalPart) mcqGoalPart.value = "";
      currentMcqLinks = [];
      const preview = $("#mcqGoalLinksPreview");
      if (preview) preview.textContent = "Inga kopplingar √§nnu.";
    });
  }

  initMcqQuickImportUI();

  renderMcqList();
  populateGoalSelect("#mcqGoalPart");
}

function initMcqQuickImportUI() {
  const questionsPanel = document.querySelector('.tab-panel[data-panel="questions"]');
  if (!questionsPanel) return;
  if (document.getElementById("mcqQuickImportCard")) return;

  const card = document.createElement("div");
  card.className = "card card-full-width";
  card.id = "mcqQuickImportCard";
  card.style.marginBottom = "15px";
  card.innerHTML = `
    <h3>Snabbimport av flervalsfr√•gor (text)</h3>
    <p class="mini">
      Format per fr√•ga:<br>
      F√∂rsta raden = fr√•ga, f√∂ljande rader = svarsalternativ.<br>
      Markera r√§tt svar med <code>*</code> i b√∂rjan av raden.<br>
      Separera fr√•gor med en tom rad.
    </p>
    <textarea id="mcqQuickTextarea" class="textarea" placeholder="Klistra in dina fr√•gor h√§r..."></textarea>
    <div class="card-row" style="margin-top:8px;gap:8px;flex-wrap:wrap;">
      <div class="field" style="max-width:140px;">
        <label class="small-label" for="mcqQuickLevel">Niv√• f√∂r import</label>
        <select id="mcqQuickLevel" class="input">
          <option value="E">E</option>
          <option value="C">C</option>
          <option value="A">A</option>
        </select>
      </div>
      <div class="field">
        <label class="small-label" for="mcqJsonGoalPart">Kopplad delbit (valfritt ‚Äì g√§ller alla importerade fr√•gor)</label>
        <select id="mcqJsonGoalPart" class="input"><option value="">Ingen koppling</option></select>
        <button id="btnMcqQuickAddGoalLink" class="btn btn-sm" type="button" style="margin-top:4px;">‚ûï L√§gg till delm√•ls-koppling</button>
        <div id="mcqQuickGoalLinksPreview" class="mini" style="margin-top:4px;">Inga kopplingar √§nnu.</div>
      </div>
    </div>
    <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
      <button id="btnMcqQuickImport" class="btn btn-sm">‚¨ÜÔ∏è Importera flervalsfr√•gor</button>
    </div>
    <p class="mini" id="mcqQuickStatus" style="margin-top:4px;"></p>
  `;

  const firstChild = questionsPanel.firstElementChild || questionsPanel.firstChild;
  if (firstChild) questionsPanel.insertBefore(card, firstChild);
  else questionsPanel.appendChild(card);

  const btnImport = $("#btnMcqQuickImport");
  const txt = $("#mcqQuickTextarea");
  const status = $("#mcqQuickStatus");
  const levelSel = $("#mcqQuickLevel");
  const goalSel = $("#mcqJsonGoalPart");
  const btnAddLink = $("#btnMcqQuickAddGoalLink");
  const preview = $("#mcqQuickGoalLinksPreview");

  let quickLinks = [];
  populateGoalSelect("#mcqJsonGoalPart");

  if (btnAddLink && goalSel && preview) {
    btnAddLink.addEventListener("click", () => {
      const val = goalSel.value;
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!quickLinks.some((x) => String(x.id) === String(link.id))) quickLinks.push(link);
      preview.innerHTML = quickLinks
        .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
        .join(" ");
    });
  }

  if (btnImport && txt) {
    btnImport.addEventListener("click", () => {
      const raw = txt.value.trim();
      if (!raw) return;

      const blocks = raw.split(/\n\s*\n/).map((b) => b.trim()).filter((b) => b.length);

      const s2 = loadState();
      if (!Array.isArray(s2.bank.mcq)) s2.bank.mcq = [];
      let added = 0;

      const lvl = (levelSel && levelSel.value) ? levelSel.value : "E";
      const linksForImport = quickLinks.slice();

      blocks.forEach((block) => {
        const lines = block.split("\n").map((l) => l.trim()).filter((l) => l.length);
        if (lines.length < 3) return;

        const question = lines[0];
        const answerLines = lines.slice(1);
        const opts = [];
        let correctIdx = 0;

        answerLines.forEach((line, idx) => {
          let t = line;
          if (t.startsWith("*")) {
            t = t.replace(/^\*\s*/, "");
            correctIdx = idx;
          }
          opts.push(t);
        });

        if (!question || opts.length < 2) return;

        const qObj = { type: "mcq", level: lvl, q: question, options: opts, answer: correctIdx };
        if (linksForImport.length) {
          qObj.links = linksForImport;
          qObj.goal = linksForImport[0].goal;
          qObj.parts = linksForImport[0].parts;
        }

        s2.bank.mcq.push(qObj);
        added++;
      });

      saveState(s2);
      renderMcqList();
      if (typeof syncUI === "function") syncUI();
      if (status) status.textContent = `Importerade ${added} fr√•gor.`;
    });
  }
}
</script>
<!-- slut SEKTION 3G: FLERVAL (MCQ) ‚Äì lista, editor, snabbimport -->



<!-- start SEKTION 3H: BILDFR√ÖGOR (IMG) ‚Äì lista & editor -->
<script>
"use strict";

/* (beh√•ller din layoutfix f√∂r thumb v√§nster) */
function renderImgList() {
  const host = $("#imgList");
  const countEl = $("#imgCount");
  if (!host) return;

  const s = loadState();
  const list = (s.bank && s.bank.img) || [];

  host.innerHTML = "";
  if (countEl) countEl.textContent = String(list.length);

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga bildfr√•gor i banken √§nnu.";
    host.appendChild(li);
    return;
  }

  list.forEach((q, idx) => {
    const li = document.createElement("li");
    li.className = "list-item";

    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    else if (lvl === "A") tagClass = "level-a";

    const goalInfo = buildGoalInfoText(q);
    const hasThumb = !!q.imgDataUrl;

    li.innerHTML = `
      <div style="display:flex;align-items:stretch;gap:10px;flex:1 1 auto;min-width:0;">
        <div style="
          flex:0 0 110px;
          border:1px solid rgba(31,41,55,1);
          border-radius:12px;
          background:#020617;
          box-shadow:0 0 0 1px rgba(15,23,42,1), 0 10px 24px rgba(15,23,42,.9);
          display:flex;
          align-items:center;
          justify-content:center;
          overflow:hidden;
          padding:6px;
        ">
          ${
            hasThumb
              ? `<img src="${q.imgDataUrl}" alt="Miniatyr" style="width:100%;height:100%;max-height:78px;object-fit:cover;border-radius:8px;">`
              : `<span class="mini">Ingen bild</span>`
          }
        </div>

        <div class="list-main" style="flex:1 1 auto;min-width:0;">
          <div class="q-text">
            [${idx + 1}] ${escapeHtml(q.q || "")}
            <span class="level-tag ${tagClass}">${lvl}</span>
          </div>
          <div class="q-meta">${goalInfo}</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;flex:0 0 auto;">
        <button class="btn btn-sm btn-danger" type="button" data-del-img-index="${idx}">üóëÔ∏è</button>
      </div>
    `;

    host.appendChild(li);
  });

  host.querySelectorAll("button[data-del-img-index]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.getAttribute("data-del-img-index"));
      const s2 = loadState();
      if (!Array.isArray(s2.bank.img) || idx < 0 || idx >= s2.bank.img.length) return;
      s2.bank.img.splice(idx, 1);
      saveState(s2);
      renderImgList();
      if (typeof syncUI === "function") syncUI();
    });
  });
}

function initImageQuestionsEditor() {
  const panel = document.querySelector('.tab-panel[data-panel="images"]');
  if (!panel) return;

  panel.innerHTML = `
    <div class="card">
      <h3>Bildfr√•gor</h3>
      <p class="mini">Skapa fr√•gor med bild och 2‚Äì4 svarsalternativ.</p>

      <div class="card-row">
        <div class="field" style="flex:0 0 100px;">
          <label class="small-label" for="imgLevel">Niv√•</label>
          <select id="imgLevel" class="input">
            <option value="E">E</option>
            <option value="C">C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div class="field">
          <label class="small-label" for="imgQuestion">Fr√•getext</label>
          <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
        </div>
      </div>

      <div class="card-row" style="margin-top:8px;">
        <div class="field">
          <label class="small-label" for="imgFileInput">Bildfil</label>
          <input type="file" id="imgFileInput" accept="image/*" />
        </div>
        <div class="field">
          <label class="small-label">F√∂rhandsgranskning</label>
          <div id="imgPreviewBox" class="img-preview-box">Ingen bild vald √§nnu.</div>
        </div>
      </div>

      <div class="card-row" style="margin-top:8px;">
        <div class="field">
          <label class="small-label" for="imgOption0">Alternativ 1</label>
          <input id="imgOption0" class="input" />
        </div>
        <div class="field">
          <label class="small-label" for="imgOption1">Alternativ 2</label>
          <input id="imgOption1" class="input" />
        </div>
      </div>

      <div class="card-row" style="margin-top:8px;">
        <div class="field">
          <label class="small-label" for="imgOption2">Alternativ 3 (valfritt)</label>
          <input id="imgOption2" class="input" />
        </div>
        <div class="field">
          <label class="small-label" for="imgOption3">Alternativ 4 (valfritt)</label>
          <input id="imgOption3" class="input" />
        </div>
      </div>

      <div class="card-row" style="margin-top:8px;">
        <div class="field" id="imgCorrectContainer">
          <label class="small-label">R√§tt svar</label>
        </div>
        <div class="field">
          <label class="small-label" for="imgGoalPart">Kopplad delbit (valfritt)</label>
          <select id="imgGoalPart" class="input"><option value="">Ingen koppling</option></select>
          <button id="btnImgAddGoalLink" class="btn btn-sm" type="button" style="margin-top:4px;">‚ûï L√§gg till delm√•ls-koppling</button>
          <div id="imgGoalLinksPreview" class="mini" style="margin-top:4px;">Inga kopplingar √§nnu.</div>
        </div>
      </div>

      <div class="card-row" style="margin-top:12px;justify-content:space-between;">
        <div><button id="btnImgAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till bildfr√•ga</button></div>
        <button id="btnImgClear" class="btn btn-sm" type="button">Avbryt/Rensa formul√§r</button>
      </div>
    </div>

    <div class="card card-full-width" style="margin-top:15px;">
      <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
      <ul id="imgList" class="question-list"></ul>
    </div>
  `;

  const imgLevel = $("#imgLevel");
  const imgQuestion = $("#imgQuestion");
  const imgOpt0 = $("#imgOption0");
  const imgOpt1 = $("#imgOption1");
  const imgOpt2 = $("#imgOption2");
  const imgOpt3 = $("#imgOption3");
  const imgFileInput = $("#imgFileInput");
  const imgPreviewBox = $("#imgPreviewBox");
  const imgGoalPart = $("#imgGoalPart");
  const btnAdd = $("#btnImgAdd");
  const btnClear = $("#btnImgClear");
  const btnAddGoalLink = $("#btnImgAddGoalLink");
  const imgCorrectContainer = $("#imgCorrectContainer");
  const imgGoalLinksPreview = $("#imgGoalLinksPreview");

  currentImgDataUrl = null;
  currentImgLinks = [];
  currentImgCorrectIndex = 0;

  if (imgCorrectContainer) {
    const row = document.createElement("div");
    ["1", "2", "3", "4"].forEach((lbl, idx) => {
      const lab = document.createElement("label");
      lab.style.marginRight = "8px";
      lab.style.cursor = "pointer";
      const r = document.createElement("input");
      r.type = "radio";
      r.name = "imgCorrectRadio";
      r.value = String(idx);
      if (idx === 0) r.checked = true;
      r.addEventListener("change", () => { currentImgCorrectIndex = idx; });
      lab.appendChild(r);
      lab.appendChild(document.createTextNode(" " + lbl));
      row.appendChild(lab);
    });
    imgCorrectContainer.appendChild(row);
  }

  if (imgFileInput) {
    imgFileInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        currentImgDataUrl = null;
        if (imgPreviewBox) imgPreviewBox.textContent = "Ingen bild vald √§nnu.";
        return;
      }
      const reader = new FileReader();
      reader.onload = function () {
        currentImgDataUrl = reader.result;
        if (imgPreviewBox) {
          imgPreviewBox.innerHTML = `<img src="${currentImgDataUrl}" alt="F√∂rhandsgranskning" style="max-width:100%;max-height:160px;border-radius:8px;">`;
        }
      };
      reader.readAsDataURL(file);
    });
  }

  if (btnAddGoalLink && imgGoalLinksPreview) {
    btnAddGoalLink.addEventListener("click", () => {
      const val = imgGoalPart.value;
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!currentImgLinks.some((x) => String(x.id) === String(link.id))) currentImgLinks.push(link);
      imgGoalLinksPreview.innerHTML = currentImgLinks
        .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
        .join(" ");
    });
  }

  if (btnAdd) {
    btnAdd.addEventListener("click", () => {
      const s = loadState();
      const level = imgLevel.value || "E";
      const text = (imgQuestion && imgQuestion.value.trim()) || "";
      const opts = [
        imgOpt0 && imgOpt0.value.trim(),
        imgOpt1 && imgOpt1.value.trim(),
        imgOpt2 && imgOpt2.value.trim(),
        imgOpt3 && imgOpt3.value.trim()
      ].filter((x) => x && x.length > 0);

      if (!currentImgDataUrl) { alert("V√§lj en bild f√∂r bildfr√•gan."); return; }
      if (!text || opts.length < 2) { alert("Skriv en fr√•ga och minst tv√• svarsalternativ."); return; }

      let ans = currentImgCorrectIndex || 0;
      if (ans >= opts.length) ans = 0;

      const links = currentImgLinks.slice();
      const qObj = {
        type: "img",
        level,
        q: text,
        options: opts,
        answer: ans,
        imgDataUrl: currentImgDataUrl,
        links: links
      };
      if (links.length) { qObj.goal = links[0].goal; qObj.parts = links[0].parts; }

      if (!Array.isArray(s.bank.img)) s.bank.img = [];
      s.bank.img.push(qObj);
      saveState(s);

      currentImgDataUrl = null;
      currentImgLinks = [];
      currentImgCorrectIndex = 0;

      if (imgQuestion) imgQuestion.value = "";
      if (imgOpt0) imgOpt0.value = "";
      if (imgOpt1) imgOpt1.value = "";
      if (imgOpt2) imgOpt2.value = "";
      if (imgOpt3) imgOpt3.value = "";
      if (imgFileInput) imgFileInput.value = "";
      if (imgPreviewBox) imgPreviewBox.textContent = "Ingen bild vald √§nnu.";
      if (imgGoalPart) imgGoalPart.value = "";
      if (imgGoalLinksPreview) imgGoalLinksPreview.textContent = "Inga kopplingar √§nnu.";

      const firstR = document.querySelector('input[name="imgCorrectRadio"][value="0"]');
      if (firstR) firstR.checked = true;

      renderImgList();
      if (typeof syncUI === "function") syncUI();
    });
  }

  if (btnClear) {
    btnClear.addEventListener("click", () => {
      if (imgQuestion) imgQuestion.value = "";
      if (imgOpt0) imgOpt0.value = "";
      if (imgOpt1) imgOpt1.value = "";
      if (imgOpt2) imgOpt2.value = "";
      if (imgOpt3) imgOpt3.value = "";
      if (imgFileInput) imgFileInput.value = "";
      if (imgPreviewBox) imgPreviewBox.textContent = "Ingen bild vald √§nnu.";
      if (imgGoalPart) imgGoalPart.value = "";
      if (imgGoalLinksPreview) imgGoalLinksPreview.textContent = "Inga kopplingar √§nnu.";
      currentImgDataUrl = null;
      currentImgLinks = [];
      currentImgCorrectIndex = 0;
      const firstR = document.querySelector('input[name="imgCorrectRadio"][value="0"]');
      if (firstR) firstR.checked = true;
    });
  }

  populateGoalSelect("#imgGoalPart");
  renderImgList();
}
</script>
<!-- slut SEKTION 3H: BILDFR√ÖGOR (IMG) ‚Äì lista & editor -->



<!-- start SEKTION 3I: DRAG & DROP ‚Äì lista & editor -->
<script>
"use strict";

/* (of√∂r√§ndrad fr√•n din version ‚Äì beh√•ller funktionalitet) */
function renderDragList() {
  const host = $("#dragList");
  const countEl = $("#dragCount");
  if (!host) return;

  const s = loadState();
  const list = (s.bank && s.bank.drag) || [];

  host.innerHTML = "";
  if (countEl) countEl.textContent = String(list.length);

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga drag & drop-fr√•gor i banken √§nnu.";
    host.appendChild(li);
    return;
  }

  list.forEach((q, idx) => {
    const li = document.createElement("li");
    li.className = "list-item";
    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    else if (lvl === "A") tagClass = "level-a";

    const sources = Array.isArray(q.dragSources) ? q.dragSources : [];
    const targets = Array.isArray(q.dragTargets) ? q.dragTargets : [];
    const goalInfo = buildGoalInfoText(q);

    const srcLabels = sources.map((s) => s.label).join(", ");
    const tgtLabels = targets.map((t) => t.label).join(", ");

    li.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          [${idx + 1}] ${escapeHtml(q.q || "")}
          <span class="level-tag ${tagClass}">${lvl}</span>
        </div>
        <div class="q-meta">
          Korten: ${escapeHtml(srcLabels || "-")}<br>
          Kategorier: ${escapeHtml(tgtLabels || "-")}
        </div>
        <div class="q-meta">${goalInfo}</div>
      </div>
      <div>
        <button class="btn btn-sm btn-danger" type="button" data-del-drag-index="${idx}">üóëÔ∏è</button>
      </div>
    `;
    host.appendChild(li);
  });

  host.querySelectorAll("button[data-del-drag-index]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.getAttribute("data-del-drag-index"));
      const s2 = loadState();
      if (!Array.isArray(s2.bank.drag) || idx < 0 || idx >= s2.bank.drag.length) return;
      s2.bank.drag.splice(idx, 1);
      saveState(s2);
      renderDragList();
      if (typeof syncUI === "function") syncUI();
    });
  });
}

function initDragDropQuestionsEditor() {
  const panel = document.querySelector('.tab-panel[data-panel="dragdrop"]');
  if (!panel) return;

  panel.innerHTML = `
    <div class="card">
      <h3>Drag &amp; Drop-fr√•gor</h3>
      <p class="mini">Skapa sorteringsfr√•gor: eleverna drar kort till r√§tt kategori.</p>

      <div class="card-row">
        <div class="field" style="flex:0 0 100px;">
          <label class="small-label" for="dragLevel">Niv√•</label>
          <select id="dragLevel" class="input">
            <option value="E">E</option>
            <option value="C">C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div class="field">
          <label class="small-label" for="dragQuestion">Fr√•getext</label>
          <input id="dragQuestion" class="input" placeholder="T.ex. Dra varje sak till r√§tt kategori..." />
        </div>
      </div>

      <div class="card-row" style="margin-top:8px;">
        <div class="field">
          <label class="small-label" for="dragItems">Kort (ett per rad)</label>
          <textarea id="dragItems" class="textarea" style="min-height:80px;"></textarea>
        </div>
        <div class="field">
          <label class="small-label" for="dragCategories">Kategorier (ett per rad)</label>
          <textarea id="dragCategories" class="textarea" style="min-height:80px;"></textarea>
        </div>
      </div>

      <div class="card-row" style="margin-top:8px;">
        <div class="field" style="flex:1;">
          <button id="btnDragBuildMapping" class="btn btn-sm" type="button">Bygg f√∂rdelning (kort ‚Üí kategori)</button>
          <div id="dragMappingArea" class="mini" style="margin-top:6px;">Inget f√∂rdelat √§nnu.</div>
        </div>
        <div class="field">
          <label class="small-label" for="dragGoalPart">Kopplad delbit (valfritt)</label>
          <select id="dragGoalPart" class="input"><option value="">Ingen koppling</option></select>
          <button id="btnDragAddGoalLink" class="btn btn-sm" type="button" style="margin-top:4px;">‚ûï L√§gg till delm√•ls-koppling</button>
          <div id="dragGoalLinksPreview" class="mini" style="margin-top:4px;">Inga kopplingar √§nnu.</div>
        </div>
      </div>

      <div class="card-row" style="margin-top:12px;justify-content:space-between;">
        <div><button id="btnDragAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till drag &amp; drop-fr√•ga</button></div>
        <button id="btnDragClear" class="btn btn-sm" type="button">Avbryt/Rensa formul√§r</button>
      </div>
    </div>

    <div class="card card-full-width" style="margin-top:15px;">
      <h3>Aktuella drag &amp; drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
      <ul id="dragList" class="question-list"></ul>
    </div>
  `;

  const dragLevel = $("#dragLevel");
  const dragQuestion = $("#dragQuestion");
  const dragItems = $("#dragItems");
  const dragCategories = $("#dragCategories");
  const dragGoalPart = $("#dragGoalPart");
  const dragLinksPreview = $("#dragGoalLinksPreview");
  const btnAdd = $("#btnDragAdd");
  const btnClear = $("#btnDragClear");
  const btnAddGoalLink = $("#btnDragAddGoalLink");
  const btnBuildMapping = $("#btnDragBuildMapping");
  const mappingArea = $("#dragMappingArea");

  currentDragLinks = [];
  currentDragSourcesTmp = [];
  currentDragTargetsTmp = [];
  currentDragCorrectMapTmp = {};

  if (btnAddGoalLink && dragLinksPreview) {
    btnAddGoalLink.addEventListener("click", () => {
      const val = dragGoalPart.value;
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!currentDragLinks.some((x) => String(x.id) === String(link.id))) currentDragLinks.push(link);
      dragLinksPreview.innerHTML = currentDragLinks
        .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
        .join(" ");
    });
  }

  if (btnBuildMapping && mappingArea) {
    btnBuildMapping.addEventListener("click", () => {
      const srcLines = (dragItems && dragItems.value.split("\n").map((x) => x.trim()).filter((x) => x.length)) || [];
      const catLines = (dragCategories && dragCategories.value.split("\n").map((x) => x.trim()).filter((x) => x.length)) || [];

      if (!srcLines.length || !catLines.length) { alert("Skriv minst ett kort och minst en kategori f√∂rst."); return; }

      currentDragSourcesTmp = srcLines.map((label, idx) => ({ id: "s" + idx, label }));
      currentDragTargetsTmp = catLines.map((label, idx) => ({ id: "t" + idx, label }));
      currentDragCorrectMapTmp = {};

      mappingArea.innerHTML = "";
      const info = document.createElement("p");
      info.className = "mini";
      info.textContent = "V√§lj kategori f√∂r varje kort:";
      mappingArea.appendChild(info);

      currentDragSourcesTmp.forEach((src) => {
        const row = document.createElement("div");
        row.className = "card-row";
        row.style.alignItems = "center";

        const lblField = document.createElement("div");
        lblField.className = "field";
        lblField.style.flex = "1";
        lblField.innerHTML = `<span>${escapeHtml(src.label)}</span>`;

        const selField = document.createElement("div");
        selField.className = "field";
        selField.style.flex = "1";

        const sel = document.createElement("select");
        sel.className = "input";
        sel.dataset.sourceId = src.id;

        currentDragTargetsTmp.forEach((tgt) => {
          const opt = document.createElement("option");
          opt.value = tgt.id;
          opt.textContent = tgt.label;
          sel.appendChild(opt);
        });

        sel.addEventListener("change", () => {
          const sid = sel.dataset.sourceId;
          const tid = sel.value;
          if (sid && tid) currentDragCorrectMapTmp[sid] = tid;
        });

        if (currentDragTargetsTmp.length) {
          sel.value = currentDragTargetsTmp[0].id;
          currentDragCorrectMapTmp[src.id] = currentDragTargetsTmp[0].id;
        }

        selField.appendChild(sel);
        row.appendChild(lblField);
        row.appendChild(selField);
        mappingArea.appendChild(row);
      });
    });
  }

  if (btnAdd) {
    btnAdd.addEventListener("click", () => {
      const s = loadState();
      const level = dragLevel.value || "E";
      const text = (dragQuestion && dragQuestion.value.trim()) || "";

      if (!text) { alert("Skriv fr√•getext f√∂rst."); return; }
      if (!currentDragSourcesTmp.length || !currentDragTargetsTmp.length) { alert("Bygg f√∂rst upp kort och kategorier via 'Bygg f√∂rdelning'."); return; }

      for (const src of currentDragSourcesTmp) {
        if (!currentDragCorrectMapTmp[src.id]) { alert("Alla kort m√•ste ha en vald kategori."); return; }
      }

      const links = currentDragLinks.slice();
      const qObj = {
        type: "drag",
        level,
        q: text,
        dragSources: currentDragSourcesTmp.slice(),
        dragTargets: currentDragTargetsTmp.slice(),
        correctMap: Object.assign({}, currentDragCorrectMapTmp),
        links: links
      };
      if (links.length) { qObj.goal = links[0].goal; qObj.parts = links[0].parts; }

      if (!Array.isArray(s.bank.drag)) s.bank.drag = [];
      s.bank.drag.push(qObj);
      saveState(s);

      if (dragQuestion) dragQuestion.value = "";
      if (dragItems) dragItems.value = "";
      if (dragCategories) dragCategories.value = "";
      if (dragGoalPart) dragGoalPart.value = "";
      if (dragLinksPreview) dragLinksPreview.textContent = "Inga kopplingar √§nnu.";
      if (mappingArea) mappingArea.textContent = "Inget f√∂rdelat √§nnu.";

      currentDragLinks = [];
      currentDragSourcesTmp = [];
      currentDragTargetsTmp = [];
      currentDragCorrectMapTmp = {};

      renderDragList();
      if (typeof syncUI === "function") syncUI();
    });
  }

  if (btnClear) {
    btnClear.addEventListener("click", () => {
      if (dragQuestion) dragQuestion.value = "";
      if (dragItems) dragItems.value = "";
      if (dragCategories) dragCategories.value = "";
      if (dragGoalPart) dragGoalPart.value = "";
      if (dragLinksPreview) dragLinksPreview.textContent = "Inga kopplingar √§nnu.";
      if (mappingArea) mappingArea.textContent = "Inget f√∂rdelat √§nnu.";
      currentDragLinks = [];
      currentDragSourcesTmp = [];
      currentDragTargetsTmp = [];
      currentDragCorrectMapTmp = {};
    });
  }

  populateGoalSelect("#dragGoalPart");
  renderDragList();
}
</script>
<!-- slut SEKTION 3I: DRAG & DROP ‚Äì lista & editor -->



<!-- start SEKTION 3J: L√ÑRARINST√ÑLLNINGAR ‚Äì l√∂sen, e-post, niv√•gr√§nser -->
<script>
"use strict";

/* (of√∂r√§ndrad) */
function initTeacherPasswordSettings() {
  const statusEl = $("#passwordStatus");
  const btnChange = $("#btnChangeTeacherPassword");
  const inputOld = $("#inputOldPassword");
  const inputNew = $("#inputNewPassword");
  const inputNewRepeat = $("#inputNewPasswordRepeat");
  if (!btnChange) return;

  btnChange.addEventListener("click", () => {
    const s = loadState();
    const current = s.teacherPassword;
    const oldVal = (inputOld && inputOld.value) || "";
    const newVal = (inputNew && inputNew.value) || "";
    const repeatVal = (inputNewRepeat && inputNewRepeat.value) || "";

    if (!newVal || !repeatVal) { if (statusEl) statusEl.textContent = "Nytt l√∂senord f√•r inte vara tomt."; return; }
    if (newVal !== repeatVal) { if (statusEl) statusEl.textContent = "Nya l√∂senorden matchar inte."; return; }
    if (current && oldVal !== current) { if (statusEl) statusEl.textContent = "Nuvarande l√∂senord st√§mmer inte."; return; }

    s.teacherPassword = newVal;
    saveState(s);
    if (statusEl) statusEl.textContent = "L√§rarl√∂senord uppdaterat.";
    if (inputOld) inputOld.value = "";
    if (inputNew) inputNew.value = "";
    if (inputNewRepeat) inputNewRepeat.value = "";
  });
}

function initTeacherEmailSettings() {
  const inputEmail = $("#inputTeacherEmail");
  const btnSave = $("#btnSaveTeacherEmail");
  const statusEl = $("#teacherEmailStatus");
  const s = loadState();

  if (inputEmail) inputEmail.value = s.teacherEmail || "";

  if (btnSave) {
    btnSave.addEventListener("click", () => {
      const val = (inputEmail && inputEmail.value.trim()) || "";
      const s2 = loadState();
      s2.teacherEmail = val;
      saveState(s2);
      if (statusEl) statusEl.textContent = val ? "E-postadress sparad." : "E-postadress rensad.";
    });
  }
}

function initThresholdSettings() {
  const inputE = $("#inputThresE");
  const inputC = $("#inputThresC");
  const inputA = $("#inputThresA");
  const btnSave = $("#btnSaveThresholds");
  const s = loadState();

  if (inputE) inputE.value = s.thres.E;
  if (inputC) inputC.value = s.thres.C;
  if (inputA) inputA.value = s.thres.A;

  if (btnSave) {
    btnSave.addEventListener("click", () => {
      const s2 = loadState();
      if (inputE) s2.thres.E = clampInt(inputE.value, 0, 100);
      if (inputC) s2.thres.C = clampInt(inputC.value, 0, 100);
      if (inputA) s2.thres.A = clampInt(inputA.value, 0, 100);
      saveState(s2);
      if (typeof syncUI === "function") syncUI();
    });
  }
}
</script>
<!-- slut SEKTION 3J: L√ÑRARINST√ÑLLNINGAR ‚Äì l√∂sen, e-post, niv√•gr√§nser -->



<!-- start SEKTION 3K: INL√ÑMNING ‚Äì spara resultat/progression via token (GDPR) -->
<script>
"use strict";

function _fv_stripUndefinedDeep(val){
  if (val === undefined) return undefined;
  if (val === null) return null;

  // beh√•ll Firestore FieldValue / andra icke-plain objects som de √§r
  const isPlainObject = (v) => v && typeof v === "object" && v.constructor === Object;

  if (Array.isArray(val)) {
    const arr = [];
    val.forEach((v)=>{
      const vv = _fv_stripUndefinedDeep(v);
      if (vv !== undefined) arr.push(vv);
    });
    return arr;
  }

  if (isPlainObject(val)) {
    const out = {};
    Object.keys(val).forEach((k)=>{
      const vv = _fv_stripUndefinedDeep(val[k]);
      if (vv !== undefined) out[k] = vv;
    });
    return out;
  }

  return val;
}

async function saveCurrentResultToFirestore() {
  if (!firebaseDbInstance) throw new Error("firebaseDbInstance saknas");

  const s = loadState();
  const token = (s.student && s.student.token) ? String(s.student.token).trim() : "";
  if (!token) throw new Error("token saknas");

  const ab = s.activeBank || {};
  const mode = ab.mode || "";

  const bestSafe = Object.assign({ E: 0, C: 0, A: 0 }, s.best || {});
  const progSafe = Object.assign({ totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {} }, s.progression || {});
  if (!progSafe.wrongByGoalId || typeof progSafe.wrongByGoalId !== "object") progSafe.wrongByGoalId = {};
  if (!progSafe.correctByGoalId || typeof progSafe.correctByGoalId !== "object") progSafe.correctByGoalId = {};

  let payload = {
    token: token,
    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
    best: bestSafe,
    lastSubmission: lastSubmission || null,
    progression: progSafe
  };

  payload = _fv_stripUndefinedDeep(payload);

  if (mode === "public" && ab.publicId) {
    const ref = firebaseDbInstance
      .collection(PUBLIC_BANKS_COLLECTION)
      .doc(String(ab.publicId))
      .collection("students")
      .doc(token);

    await ref.set(payload, { merge: true });
    return;
  }

  if (mode === "teacher" && ab.ownerUid && ab.bankId) {
    const ref = firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION)
      .doc(String(ab.ownerUid))
      .collection(CLOUD_BANKS_SUBCOLLECTION)
      .doc(String(ab.bankId))
      .collection("students")
      .doc(token);

    await ref.set(payload, { merge: true });
    return;
  }

  throw new Error("Ingen aktiv bank-meta (public/teacher) f√∂r inl√§mning");
}
</script>
<!-- slut SEKTION 3K: INL√ÑMNING ‚Äì spara resultat/progression via token (GDPR) -->



<!-- start SEKTION 3L: ROUTER + KNAPPBINDNING (FIX: login, knappar, public autoload) -->
<!-- √ÑNDRAT: F√§rdigst√§ller avklippt SEKTION 3L + speglar firebaseDbInstance/currentTeacherUser till window.* s√• public-autoload fungerar. Omskrivna rader: ca 165 -->
<script>
"use strict";
/* √ÑNDRING:
- L√§gger in retry-loop som v√§ntar in firebaseDbInstance och auto-laddar public_banks vid ?public=... (s√• fr√•gorna finns direkt vid start).
- Synkar currentTeacherUser + window.currentTeacherUser konsekvent.
- Speglar firebaseDbInstance till window.firebaseDbInstance (kritisk fix f√∂r autoload).
*/

(function FV3L(){
  if (window.__fv3l_ran) return;
  window.__fv3l_ran = true;

  function fvQS(sel){ try { return document.querySelector(sel); } catch { return null; } }
  function fvAll(sel){ try { return Array.from(document.querySelectorAll(sel)); } catch { return []; } }

  function fvFindButtonByText(allNeedles){
    const needles = (allNeedles || []).map(s => String(s || "").toLowerCase()).filter(Boolean);
    const btns = fvAll("button, [role='button'], a");
    for (const b of btns){
      const t = String(b.textContent || "").toLowerCase();
      if (!t) continue;
      const ok = needles.every(n => t.includes(n));
      if (ok) return b;
    }
    return null;
  }

  function fvBindClick(el, fn){
    if (!el || typeof fn !== "function") return false;
    if (el.dataset && el.dataset.fvBound === "1") return true;
    try{
      el.addEventListener("click", (e)=>{ try{ fn(e); } catch(err){ console.error("FV3L click handler error:", err); }} );
      if (el.dataset) el.dataset.fvBound = "1";
      return true;
    }catch{
      return false;
    }
  }

  function fvSleep(ms){ return new Promise(r => setTimeout(r, ms || 0)); }

  function fvMirrorFirebaseGlobals(){
    try { if (typeof firebaseAppInstance !== "undefined") window.firebaseAppInstance = firebaseAppInstance; } catch {}
    try { if (typeof firebaseAuthInstance !== "undefined") window.firebaseAuthInstance = firebaseAuthInstance; } catch {}
    try { if (typeof firebaseDbInstance !== "undefined") window.firebaseDbInstance = firebaseDbInstance; } catch {}
    try { if (typeof currentTeacherUser !== "undefined") window.currentTeacherUser = currentTeacherUser; } catch {}
  }

  function fvHasPublicParam(){
    try{
      if (typeof getQueryParam !== "function") return false;
      return !!String(getQueryParam("public") || "").trim();
    }catch{ return false; }
  }

  function fvEnsureStateTokenFromUrl(){
    try{
      if (typeof getQueryParam !== "function") return;
      const token = (getQueryParam("token") || "").trim();
      if (!token) return;

      if (typeof loadState !== "function" || typeof saveState !== "function") return;
      const s = loadState();
      if (!s.student) s.student = { name:"", klass:"", token:"" };
      if (String(s.student.token || "").trim() !== token){
        s.student.token = token;
        saveState(s);
      }
    }catch(e){
      console.warn("FV3L token url -> state misslyckades:", e);
    }
  }

  function fvEnsureActiveBankMetaFromUrl(){
    try{
      if (typeof getQueryParam !== "function") return;
      const publicId = (getQueryParam("public") || "").trim();
      if (!publicId) return;

      if (typeof setActiveBankMeta === "function"){
        setActiveBankMeta({ mode:"public", publicId: publicId, ownerUid:"", bankId:"" });
      } else if (typeof loadState === "function" && typeof saveState === "function"){
        const s = loadState();
        s.activeBank = Object.assign({ mode:"", ownerUid:"", bankId:"", publicId:"" }, s.activeBank || {}, {
          mode:"public", publicId: publicId, ownerUid:"", bankId:""
        });
        saveState(s);
      }

      try { window.activeCloudBankId = ""; } catch {}
    }catch(e){
      console.warn("FV3L public url -> activeBank meta misslyckades:", e);
    }
  }

  async function fvLoadPublicBankIfNeeded(){
    try{
      if (typeof getQueryParam !== "function") return;
      const publicId = (getQueryParam("public") || "").trim();
      if (!publicId) return;

      fvMirrorFirebaseGlobals();
      if (!window.firebaseDbInstance) return;

      const key = "__fv3l_loaded_publicId";
      if (window[key] && String(window[key]) === String(publicId)) return;

      const ref = window.firebaseDbInstance.collection(PUBLIC_BANKS_COLLECTION).doc(String(publicId));
      const snap = await ref.get();
      if (!snap.exists) {
        console.warn("Public bank saknas:", publicId);
        return;
      }

      const data = snap.data() || {};
      const bank = (data.bank ? ensureBankShape(data.bank) : ensureBankShape({}));
      const goalsMap = Array.isArray(data.goalsMap) ? data.goalsMap : [];

      try{
        if (typeof loadState === "function" && typeof saveState === "function") {
          const s = loadState();
          s.bank = bank;
          s.goalsMap = goalsMap;
          s.activeBank = Object.assign({ mode:"", ownerUid:"", bankId:"", publicId:"" }, s.activeBank || {}, {
            mode:"public", publicId:String(publicId), ownerUid:"", bankId:""
          });
          saveState(s);
        }
      }catch(e2){
        console.warn("Kunde inte skriva public bank till state:", e2);
      }

      try { if (typeof renderGoalsList === "function") renderGoalsList(); } catch {}
      try { if (typeof renderMcqList === "function") renderMcqList(); } catch {}
      try { if (typeof renderImgList === "function") renderImgList(); } catch {}
      try { if (typeof renderDragList === "function") renderDragList(); } catch {}
      try { if (typeof syncUI === "function") syncUI(); } catch {}
      try { if (typeof updateBankStatusUI === "function") updateBankStatusUI(); } catch {}

      window[key] = String(publicId);
      window.__fv3l_publicLoaded = true;
    }catch(e){
      console.warn("FV3L autoLoad public bank misslyckades:", e);
    }
  }

  function fvEnsureTeacherMetaIfPossible(){
    try{
      fvMirrorFirebaseGlobals();
      const hasTeacher = !!(window.currentTeacherUser && window.currentTeacherUser.uid);
      if (!hasTeacher) return;

      let bankId = "";
      try{
        if (typeof window.activeCloudBankId !== "undefined" && window.activeCloudBankId) bankId = String(window.activeCloudBankId);
      }catch{}
      if (!bankId && typeof loadState === "function"){
        const s = loadState();
        if (s && s.activeBank && s.activeBank.mode === "teacher" && s.activeBank.bankId) bankId = String(s.activeBank.bankId);
      }
      if (!bankId) return;

      if (typeof setActiveBankMeta === "function"){
        setActiveBankMeta({ mode:"teacher", ownerUid:String(window.currentTeacherUser.uid), bankId:String(bankId), publicId:"" });
      } else if (typeof loadState === "function" && typeof saveState === "function"){
        const s2 = loadState();
        s2.activeBank = Object.assign({ mode:"", ownerUid:"", bankId:"", publicId:"" }, s2.activeBank || {}, {
          mode:"teacher",
          ownerUid:String(window.currentTeacherUser.uid),
          bankId:String(bankId),
          publicId:""
        });
        saveState(s2);
      }
    }catch(e){
      console.warn("FV3L teacher meta safeguard misslyckades:", e);
    }
  }

  function fvBindTeacherButtons(){
    const btnLogin = document.getElementById("btnGoogleLogin") || fvFindButtonByText(["google", "logga"]);
    const btnLogout = document.getElementById("btnGoogleLogout") || fvFindButtonByText(["logga", "ut"]);

    const btnLoadCloud = document.getElementById("btnLoadCloudBanks")
      || fvFindButtonByText(["ladda", "moln"])
      || fvFindButtonByText(["moln", "bank"]);

    if (btnLogin && typeof handleGoogleLogin === "function") fvBindClick(btnLogin, (e)=>{ e.preventDefault(); handleGoogleLogin(); });
    if (btnLogout && typeof handleGoogleLogout === "function") fvBindClick(btnLogout, (e)=>{ e.preventDefault(); handleGoogleLogout(); });

    if (btnLoadCloud){
      const loader = (typeof window.loadCloudBanksListV4 === "function") ? window.loadCloudBanksListV4
                   : (typeof window.loadCloudBanksList === "function") ? window.loadCloudBanksList
                   : null;
      if (loader) fvBindClick(btnLoadCloud, async (e)=>{ e.preventDefault(); await loader(); });
    }
  }

  function fvEnsureFirebaseInitOnce(){
    try{
      if (window.__fv3l_firebaseInitDone) { fvMirrorFirebaseGlobals(); return; }
      if (typeof initFirebase !== "function") return;

      try{
        if (typeof firebaseDbInstance !== "undefined" && firebaseDbInstance){
          window.__fv3l_firebaseInitDone = true;
          fvMirrorFirebaseGlobals();
          return;
        }
      }catch{}

      initFirebase();
      window.__fv3l_firebaseInitDone = true;
      fvMirrorFirebaseGlobals();
    }catch(e){
      console.warn("FV3L initFirebase misslyckades:", e);
    }
  }

  async function fvWaitForFirebaseDb(maxAttempts, delayMs){
    const attempts = Math.max(1, parseInt(maxAttempts || 40, 10));
    const delay = Math.max(50, parseInt(delayMs || 250, 10));

    for (let i=0; i<attempts; i++){
      try{
        fvEnsureFirebaseInitOnce();
        fvMirrorFirebaseGlobals();
        if (window.firebaseDbInstance) return true;
      }catch{}
      await fvSleep(delay);
    }
    fvMirrorFirebaseGlobals();
    return !!window.firebaseDbInstance;
  }

  async function fvEnsurePublicAutoload(){
    try{
      if (!fvHasPublicParam()) return;
      if (window.__fv3l_publicLoaded) return;

      fvEnsureStateTokenFromUrl();
      fvEnsureActiveBankMetaFromUrl();

      const ok = await fvWaitForFirebaseDb(40, 250);
      if (!ok) return;

      await fvLoadPublicBankIfNeeded();
    }catch(e){
      console.warn("FV3L ensure public autoload misslyckades:", e);
    }
  }

  function fvHookAuthStateOnce(){
    try{
      fvMirrorFirebaseGlobals();
      const auth = window.firebaseAuthInstance || firebaseAuthInstance;
      if (!auth || typeof auth.onAuthStateChanged !== "function") return;
      if (auth.__fv3l_hooked) return;
      auth.__fv3l_hooked = true;

      auth.onAuthStateChanged((user)=>{
        try { currentTeacherUser = user || null; } catch {}
        try { window.currentTeacherUser = user || null; } catch {}

        // Om l√§raren loggar in: h√•ll teacher-meta sane (men r√∂r ej public-mode)
        try{
          if (!fvHasPublicParam()) fvEnsureTeacherMetaIfPossible();
        }catch{}

        // Uppdatera gr√∂nmarkering n√§r listan finns
        try { if (typeof _fv3d_markActive === "function") _fv3d_markActive(); } catch {}
      });
    }catch{}
  }

  async function fvBootstrap(){
    try{
      fvEnsureFirebaseInitOnce();
      fvHookAuthStateOnce();
      fvBindTeacherButtons();
      await fvEnsurePublicAutoload();

      // Extra retry f√∂r knappar/paneler som renderas sent
      for (let i=0; i<8; i++){
        await fvSleep(180);
        fvBindTeacherButtons();
        fvHookAuthStateOnce();
      }
    }catch(e){
      console.warn("FV3L bootstrap misslyckades:", e);
    }
  }

  // K√∂r nu eller p√• DOMContentLoaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", fvBootstrap);
  } else {
    fvBootstrap();
  }

})();
</script>
<!-- slut SEKTION 3L: ROUTER + KNAPPBINDNING (FIX: login, knappar, public autoload) -->








<!-- slut SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker & editorer) -->








<!-- start SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->
<script>
"use strict";

/* =========================
   4a ‚Äì Elevdata & UI-sync
   ========================= */

function ensureStudentSet() {
  const s = loadState();
  if (!s.student.name || !s.student.klass) {
    alert("Skriv in namn och klass och spara eleven f√∂rst.");
    return false;
  }
  return true;
}

function handleSaveStudent() {
  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  const s = loadState();

  s.student.name = (nameInput && nameInput.value.trim()) || "";
  s.student.klass = (classInput && classInput.value.trim()) || "";
  saveState(s);
  syncUI();
}

function updateStudentStatsUI() {
  const s = loadState();
  const ptsEl = getEl("studentPointsValue");
  const hsEl = getEl("highscoreSummary");

  const totalPoints = (s.progression && typeof s.progression.totalPoints === "number")
    ? s.progression.totalPoints
    : 0;

  if (ptsEl) ptsEl.textContent = `${totalPoints} p`;

  if (hsEl) {
    const hs = Array.isArray(s.highscores) ? s.highscores.slice() : [];
    if (!hs.length) {
      hsEl.textContent = "Ingen highscore √§nnu.";
      return;
    }
    hs.sort((a, b) => (b.points || 0) - (a.points || 0));
    const studentId = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
    const idx = hs.findIndex((e) => e.id === studentId);
    if (idx >= 0) {
      hsEl.textContent = `Plats ${idx + 1} av ${hs.length} (${hs[idx].points || 0} p)`;
    } else {
      hsEl.textContent = `Highscorelista: ${hs.length} elever p√• denna enhet.`;
    }
  }
}

function normalizeGoalsMap(s) {
  if (!s) return [];

  // St√∂d flera m√∂jliga format
  const raw =
    (Array.isArray(s.goalsMap) && s.goalsMap) ||
    (s.bank && Array.isArray(s.bank.goalsMap) && s.bank.goalsMap) ||
    (s.bank && s.bank.meta && Array.isArray(s.bank.meta.goalsMap) && s.bank.meta.goalsMap) ||
    [];

  const out = [];

  raw.forEach((g, i) => {
    if (!g) return;

    // F√∂rv√§ntat: { id, goal, part } eller { id, goalTitle, partText }
    const id =
      (g.id != null ? String(g.id) : null) ||
      (g.partId != null ? String(g.partId) : null) ||
      (g.delbit != null ? String(g.delbit) : null) ||
      String(i + 1);

    const goal =
      (g.goal != null ? String(g.goal) : null) ||
      (g.goalTitle != null ? String(g.goalTitle) : null) ||
      (g.delmal != null ? String(g.delmal) : null) ||
      "";

    const part =
      (g.part != null ? String(g.part) : null) ||
      (g.partText != null ? String(g.partText) : null) ||
      (g.text != null ? String(g.text) : null) ||
      (g.delbitText != null ? String(g.delbitText) : null) ||
      "";

    out.push({ id, goal, part });
  });

  return out;
}

function renderGoalsListAndSelects() {
  const s = loadState();
  const goals = normalizeGoalsMap(s);

  // Lista i Inst√§llningar
  const listEl = getEl("goalsList");
  if (listEl) {
    listEl.innerHTML = "";
    if (!goals.length) {
      const li = document.createElement("li");
      li.textContent = "Inga delm√•l/delbitar sparade √§nnu.";
      listEl.appendChild(li);
    } else {
      goals.forEach((g) => {
        const li = document.createElement("li");
        const left = g.goal ? `${g.goal}` : "Delm√•l";
        const right = g.part ? ` ‚Äì ${g.part}` : "";
        li.textContent = `Delbit ${g.id}: ${left}${right}`;
        listEl.appendChild(li);
      });
    }
  }

  // Selects i editorerna
  const selectIds = ["mcqGoalPart", "imgGoalPart", "dragGoalPart", "mcqJsonGoalPart"];
  selectIds.forEach((id) => {
    const sel = getEl(id);
    if (!sel) return;

    const keepValue = sel.value || "";
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Ingen koppling";
    sel.appendChild(opt0);

    goals.forEach((g) => {
      const opt = document.createElement("option");
      opt.value = String(g.id);
      const goalTxt = (g.goal || "").trim();
      const partTxt = (g.part || "").trim();
      opt.textContent = goalTxt && partTxt
        ? `Delbit ${g.id}: ${goalTxt} ‚Äì ${partTxt}`
        : goalTxt
          ? `Delbit ${g.id}: ${goalTxt}`
          : partTxt
            ? `Delbit ${g.id}: ${partTxt}`
            : `Delbit ${g.id}`;
      sel.appendChild(opt);
    });

    if (keepValue) sel.value = keepValue;
  });
}

function updateProgressionPanel() {
  const s = loadState();
  const prog = s.progression || {};
  const best = s.best || {};
  const thres = s.thres || {};

  const pointsText = getEl("progressPointsText");
  const strongEl = getEl("progressStrongList");
  const weakEl = getEl("progressWeakList");

  const last = prog.lastResult || null;
  const totalPoints = typeof prog.totalPoints === "number" ? prog.totalPoints : 0;

  const tE = (thres && typeof thres.E === "number") ? thres.E : 70;
  const tC = (thres && typeof thres.C === "number") ? thres.C : 70;
  const tA = (thres && typeof thres.A === "number") ? thres.A : 70;

  if (pointsText) {
    if (!last) {
      pointsText.textContent = "Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.";
    } else {
      pointsText.textContent =
        `Totalt: ${totalPoints} p. ` +
        `Senast: niv√• ${last.level} ‚Äì ${last.score}% (${last.correct}/${last.total} r√§tt) +${last.pointsGained || 0}p. ` +
        `B√§sta: E ${best.E || 0}% (gr√§ns ${tE}%), C ${best.C || 0}% (gr√§ns ${tC}%), A ${best.A || 0}% (gr√§ns ${tA}%).`;
    }
  }

  if (strongEl) strongEl.innerHTML = "";
  if (weakEl) weakEl.innerHTML = "";

  const wrongByGoal = prog.wrongByGoalId || {};
  const correctByGoal = prog.correctByGoalId || {};

  const allIds = new Set([
    ...Object.keys(wrongByGoal),
    ...Object.keys(correctByGoal)
  ]);

  if (!allIds.size) {
    if (strongEl) {
      const li = document.createElement("li");
      li.textContent = "Inga starka delbitar inl√§sta √§nnu.";
      strongEl.appendChild(li);
    }
    if (weakEl) {
      const li = document.createElement("li");
      li.textContent = "Inga svaga delbitar inl√§sta √§nnu.";
      weakEl.appendChild(li);
    }
    return;
  }

  const baseThres =
    typeof thres.E === "number" ? thres.E :
    typeof thres.C === "number" ? thres.C :
    typeof thres.A === "number" ? thres.A : 70;

  const stats = [];
  allIds.forEach((id) => {
    const c = correctByGoal[id] || 0;
    const w = wrongByGoal[id] || 0;
    const total = c + w;
    if (!total) return;
    const acc = Math.round((c / total) * 100);
    stats.push({ id, correct: c, wrong: w, total, acc });
  });

  const strong = stats
    .filter((st) => st.acc >= baseThres && st.correct > 0)
    .sort((a, b) => b.acc - a.acc || b.correct - a.correct)
    .slice(0, 12);

  const weak = stats
    .filter((st) => st.acc < baseThres || st.wrong > 0)
    .sort((a, b) => b.wrong - a.wrong || a.acc - b.acc)
    .slice(0, 12);

  if (strongEl) {
    if (!strong.length) {
      const li = document.createElement("li");
      li.textContent = "Inga tydliga styrkor √§nnu ‚Äì forts√§tt spela.";
      strongEl.appendChild(li);
    } else {
      strong.forEach((st) => {
        const li = document.createElement("li");
        li.textContent = `Delbit ${st.id} ‚Äì ${st.acc}% r√§tt (${st.correct}/${st.total})`;
        strongEl.appendChild(li);
      });
    }
  }

  if (weakEl) {
    if (!weak.length) {
      const li = document.createElement("li");
      li.textContent = "Inga tydliga svagheter ‚Äì bra jobbat!";
      weakEl.appendChild(li);
    } else {
      weak.forEach((st) => {
        const li = document.createElement("li");
        li.textContent = `Delbit ${st.id} ‚Äì ${st.wrong} fel (${st.correct}/${st.total} r√§tt, ${st.acc}%)`;
        weakEl.appendChild(li);
      });
    }
  }
}

function handleGenerateProgressJson() {
  const s = loadState();
  const prog = s.progression || {};
  const last = prog.lastResult || null;

  const output = getEl("progressExportJson");
  if (!output) return;

  if (!last) {
    output.value = "";
    return;
  }

  const payload = {
    source: "fangvaktaren",
    version: "v17",
    student: {
      name: s.student.name || "",
      klass: s.student.klass || ""
    },
    result: {
      level: last.level,
      scorePercent: last.score,
      correct: last.correct,
      total: last.total,
      pointsGained: last.pointsGained,
      totalPointsAfter: last.totalPointsAfter,
      timestamp: last.timestamp
    },
    progression: {
      totalPoints: (prog.totalPoints || 0),
      best: s.best || {},
      wrongByGoalId: prog.wrongByGoalId || {},
      correctByGoalId: prog.correctByGoalId || {}
    }
  };

  output.value = JSON.stringify(payload, null, 2);
}

function handleCopyProgressJson() {
  const output = getEl("progressExportJson");
  if (!output) return;

  const text = output.value || "";
  if (!text.trim()) return;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).catch(() => {});
  }
}

function updateAllProgressionUI() {
  updateStudentStatsUI();
  updateProgressionPanel();
  renderGoalsListAndSelects();
}

function handleClearStudentData() {
  const s = loadState();
  if (!confirm("Detta rensar alla sparade elevuppgifter, highscore och progression p√• DENNA dator. Forts√§tt?")) return;

  s.student = { name: "", klass: "" };
  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];

  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Elevdata rensad p√• denna enhet.";
}

function handleResetGameData() {
  const s = loadState();
  if (!confirm("Detta nollst√§ller po√§ng, progression och highscore men beh√•ller nuvarande elevnamn/klass. Forts√§tt?")) return;

  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];

  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Spelpo√§ng och progression nollst√§lld.";
}

function syncUI() {
  const s = loadState();
  const hasStudent = !!(s.student.name && s.student.klass);

  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  if (nameInput) nameInput.value = s.student.name || "";
  if (classInput) classInput.value = s.student.klass || "";

  const studentSaved = getEl("studentSaved");
  if (studentSaved) {
    studentSaved.textContent = hasStudent
      ? `Sparad: ${s.student.name} (${s.student.klass})`
      : "Ej sparad elev";
  }

  const bestE = getEl("best-levelE");
  const bestC = getEl("best-levelC");
  const bestA = getEl("best-levelA");
  if (bestE) bestE.textContent = (s.best && s.best.E) || 0;
  if (bestC) bestC.textContent = (s.best && s.best.C) || 0;
  if (bestA) bestA.textContent = (s.best && s.best.A) || 0;

  const thresE = getEl("thres-levelE");
  const thresC = getEl("thres-levelC");
  const thresA = getEl("thres-levelA");
  if (thresE && s.thres && typeof s.thres.E === "number") thresE.textContent = s.thres.E;
  if (thresC && s.thres && typeof s.thres.C === "number") thresC.textContent = s.thres.C;
  if (thresA && s.thres && typeof s.thres.A === "number") thresA.textContent = s.thres.A;

  const cardE = getEl("card-levelE");
  const cardC = getEl("card-levelC");
  const cardA = getEl("card-levelA");
  const btnE = getEl("start-levelE");
  const btnC = getEl("start-levelC");
  const btnA = getEl("start-levelA");
  const badgeE = getEl("badge-levelE");
  const badgeC = getEl("badge-levelC");
  const badgeA = getEl("badge-levelA");

  if (cardE && btnE && badgeE) {
    if (hasStudent) {
      cardE.classList.remove("locked");
      btnE.disabled = false;
      badgeE.textContent = "Starta";
      badgeE.classList.remove("badge-lock");
      badgeE.classList.add("badge-ok");
    } else {
      cardE.classList.add("locked");
      btnE.disabled = true;
      badgeE.textContent = "L√•st";
      badgeE.classList.remove("badge-ok");
      badgeE.classList.add("badge-lock");
    }
  }

  if (cardC && btnC && badgeC) {
    if (s.unlocked && s.unlocked.C) {
      cardC.classList.remove("locked");
      btnC.disabled = false;
      badgeC.textContent = "Uppl√•st";
      badgeC.classList.remove("badge-lock");
      badgeC.classList.add("badge-ok");
    } else {
      cardC.classList.add("locked");
      btnC.disabled = true;
      badgeC.textContent = "L√•st";
      badgeC.classList.remove("badge-ok");
      badgeC.classList.add("badge-lock");
    }
  }

  if (cardA && btnA && badgeA) {
    if (s.unlocked && s.unlocked.A) {
      cardA.classList.remove("locked");
      btnA.disabled = false;
      badgeA.textContent = "Uppl√•st";
      badgeA.classList.remove("badge-lock");
      badgeA.classList.add("badge-ok");
    } else {
      cardA.classList.add("locked");
      btnA.disabled = true;
      badgeA.textContent = "L√•st";
      badgeA.classList.remove("badge-ok");
      badgeA.classList.add("badge-lock");
    }
  }

  const who = getEl("whoPlays");
  if (who) {
    who.textContent = hasStudent
      ? `${s.student.name} (${s.student.klass})`
      : "Ingen elev vald.";
  }

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const studentCard = getEl("studentCard");

  const isPlaying = typeof currentLevel !== "undefined" && !!currentLevel;
  const isResultVisible = resultSection && !resultSection.classList.contains("hidden");

  if (studentCard) {
    studentCard.classList.toggle("hidden", isPlaying || isResultVisible);
  }

  updateAllProgressionUI();
}

/* =========================
   4b ‚Äì Spel-logik (fr√•gerendering & niv√•er)
   ========================= */

function renderDragQuestion(q, index, host) {
  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"}) ‚Äì Drag & Drop`;
  container.appendChild(header);

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.flexWrap = "wrap";
  wrapper.style.gap = "12px";
  wrapper.style.marginTop = "6px";

  const sourcesCol = document.createElement("div");
  sourcesCol.style.flex = "1 1 180px";

  const targetsCol = document.createElement("div");
  targetsCol.style.flex = "2 1 260px";

  const srcTitle = document.createElement("div");
  srcTitle.className = "mini";
  srcTitle.textContent = "Kort att dra:";
  sourcesCol.appendChild(srcTitle);

  const srcZone = document.createElement("div");
  srcZone.style.border = "1px dashed #1f2937";
  srcZone.style.borderRadius = "8px";
  srcZone.style.padding = "6px";
  srcZone.style.minHeight = "40px";
  srcZone.style.display = "flex";
  srcZone.style.flexWrap = "wrap";
  srcZone.style.gap = "4px";
  sourcesCol.appendChild(srcZone);

  const tgtTitle = document.createElement("div");
  tgtTitle.className = "mini";
  tgtTitle.textContent = "Kategori-rutor:";
  targetsCol.appendChild(tgtTitle);

  const tgtZone = document.createElement("div");
  tgtZone.style.display = "flex";
  tgtZone.style.flexWrap = "wrap";
  tgtZone.style.gap = "8px";
  targetsCol.appendChild(tgtZone);

  wrapper.appendChild(sourcesCol);
  wrapper.appendChild(targetsCol);
  container.appendChild(wrapper);

  const sources = Array.isArray(q.dragSources) ? q.dragSources : [];
  const targets = Array.isArray(q.dragTargets) ? q.dragTargets : [];
  const answers = {};
  currentAnswers[index] = answers;

  function makeDraggableChip(src) {
    const chip = document.createElement("div");
    chip.textContent = src.label;
    chip.draggable = true;
    chip.dataset.itemId = src.id;
    chip.className = "chip";
    chip.style.cursor = "grab";
    chip.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", src.id);
    });
    return chip;
  }

  function setupDropTarget(el, targetId) {
    el.addEventListener("dragover", (ev) => ev.preventDefault());
    el.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      el.appendChild(existing);

      if (targetId === null) delete answers[itemId];
      else answers[itemId] = targetId;
    });
  }

  setupDropTarget(srcZone, null);

  sources.forEach((src) => {
    const chip = makeDraggableChip(src);
    srcZone.appendChild(chip);
  });

  targets.forEach((tgt) => {
    const box = document.createElement("div");
    box.style.border = "1px solid #1f2937";
    box.style.borderRadius = "8px";
    box.style.padding = "6px";
    box.style.minHeight = "46px";
    box.style.minWidth = "110px";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "4px";

    const cap = document.createElement("div");
    cap.className = "mini";
    cap.textContent = tgt.label;
    box.appendChild(cap);

    const slot = document.createElement("div");
    slot.style.display = "flex";
    slot.style.flexWrap = "wrap";
    slot.style.gap = "4px";
    box.appendChild(slot);

    box.addEventListener("dragover", (ev) => ev.preventDefault());
    box.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;
      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;
      slot.appendChild(existing);
      answers[itemId] = tgt.id;
    });

    tgtZone.appendChild(box);
  });

  host.appendChild(container);
}

function renderQuestionItem(q, index, host) {
  if (q.type === "drag") {
    renderDragQuestion(q, index, host);
    return;
  }

  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"})`;
  container.appendChild(header);

  if (q.type === "img" && q.imgDataUrl) {
    const img = document.createElement("img");
    img.src = q.imgDataUrl;
    img.alt = "Bildfr√•ga";
    container.appendChild(img);
  }

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const optionsList = document.createElement("div");
  optionsList.className = "options-list";
  (q.options || []).forEach((opt, optIndex) => {
    const label = document.createElement("label");
    label.className = "option-label";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = `q-${index}`;
    input.value = String(optIndex);
    input.addEventListener("change", () => {
      currentAnswers[index] = optIndex;
    });

    const span = document.createElement("span");
    span.textContent = opt;

    label.appendChild(input);
    label.appendChild(span);
    optionsList.appendChild(label);
  });
  container.appendChild(optionsList);

  host.appendChild(container);
}

function startLevel(level) {
  if (!ensureStudentSet()) return;

  const s = loadState();
  const allQuestions = []
    .concat(s.bank.mcq || [])
    .concat(s.bank.img || [])
    .concat(s.bank.drag || []);

  const pool = allQuestions.filter((q) => (q.level || "E") === level);
  if (!pool.length) {
    alert("Det finns inga fr√•gor p√• denna niv√• √§nnu.");
    return;
  }

  currentLevel = level;
  currentQuestions = shuffle(pool);
  currentAnswers = new Array(currentQuestions.length).fill(null);

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const questionsHost = getEl("questions");

  if (resultSection) resultSection.classList.add("hidden");
  if (playSection) playSection.classList.remove("hidden");
  if (questionsHost) {
    questionsHost.innerHTML = "";
    currentQuestions.forEach((q, idx) => renderQuestionItem(q, idx, questionsHost));
  }

  const title = getEl("play-title");
  const who = getEl("whoPlays");
  if (title) {
    if (level === "E") title.textContent = "Niv√• 1 ‚Äì Grundniv√• (E)";
    else if (level === "C") title.textContent = "Niv√• 2 ‚Äì Mellanniv√• (C)";
    else title.textContent = "Niv√• 3 ‚Äì Avancerad (A)";
  }
  if (who) {
    who.textContent = `${s.student.name} (${s.student.klass})`;
  }

  syncUI();
}

function finishLevel() {
  if (!currentLevel || !currentQuestions.length) {
    alert("Ingen niv√• √§r aktiv.");
    return;
  }

  const s = loadState();
  const goals = normalizeGoalsMap(s);
  let correctCount = 0;
  let pointsGained = 0;
  let allCorrect = true;

  if (!s.progression || typeof s.progression !== "object") {
    s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  }
  s.progression.totalPoints = s.progression.totalPoints || 0;
  s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
  s.progression.correctByGoalId = s.progression.correctByGoalId || {};

  const wrongByGoal = s.progression.wrongByGoalId;
  const correctByGoal = s.progression.correctByGoalId;

  const lvl = currentLevel;
  const basePointsPerQuestion =
    lvl === "A" ? 3 :
    lvl === "C" ? 2 : 1;

  currentQuestions.forEach((q, index) => {
    const ansVal = currentAnswers[index];
    let isCorrect = false;

    if (q.type === "drag") {
      const correctMap = q.correctMap || {};
      const keys = Object.keys(correctMap);
      if (!keys.length) {
        isCorrect = false;
      } else if (!ansVal || typeof ansVal !== "object") {
        isCorrect = false;
      } else {
        let allOk = true;
        for (const itemId of keys) {
          if (!ansVal[itemId] || ansVal[itemId] !== correctMap[itemId]) {
            allOk = false;
            break;
          }
        }
        isCorrect = allOk;
      }
    } else {
      if (ansVal != null) {
        const correctIndex = typeof q.answer === "number" ? q.answer : q.correct;
        isCorrect = ansVal === correctIndex;
      } else {
        isCorrect = false;
      }
    }

    if (isCorrect) {
      correctCount++;
      pointsGained += basePointsPerQuestion;
    } else {
      allCorrect = false;
    }

    const links = getLinksForQuestion(q, goals);
    if (links && links.length) {
      links.forEach((lnk) => {
        const key = String(lnk.id);
        if (isCorrect) correctByGoal[key] = (correctByGoal[key] || 0) + 1;
        else wrongByGoal[key] = (wrongByGoal[key] || 0) + 1;
      });
    }
  });

  const total = currentQuestions.length;
  const percentage = total ? Math.round((correctCount / total) * 100) : 0;
  const threshold = (s.thres && s.thres[lvl] != null) ? s.thres[lvl] : 70;

  if (!s.best) s.best = { E: 0, C: 0, A: 0 };
  if (percentage > (s.best[lvl] || 0)) s.best[lvl] = percentage;

  if (!s.unlocked) s.unlocked = { C: false, A: false };
  if (lvl === "E" && percentage >= threshold) s.unlocked.C = true;
  if (lvl === "C" && percentage >= threshold) s.unlocked.A = true;

  if (total > 0 && allCorrect) pointsGained += 5;

  s.progression.totalPoints += pointsGained;
  const totalPointsAfter = s.progression.totalPoints;

  const nowIso = new Date().toISOString();
  const lastResult = {
    level: lvl,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    timestamp: nowIso
  };
  s.progression.lastResult = lastResult;

  if (!Array.isArray(s.highscores)) s.highscores = [];
  const id = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
  const newEntry = {
    id,
    name: s.student.name || "Elev",
    klass: s.student.klass || "-",
    points: totalPointsAfter,
    level: lvl,
    score: percentage,
    updatedAt: nowIso
  };
  const idx = s.highscores.findIndex((e) => e.id === id);
  if (idx >= 0) {
    if ((newEntry.points || 0) >= (s.highscores[idx].points || 0)) s.highscores[idx] = newEntry;
  } else {
    s.highscores.push(newEntry);
  }

  saveState(s);

  lastSubmission = {
    level: lvl,
    studentName: s.student.name,
    studentClass: s.student.klass,
    timestamp: nowIso,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    answers: currentAnswers.slice(),
    questions: currentQuestions.map((q) => ({
      q: q.q || q.text || "",
      type: q.type || "mcq",
      level: q.level || lvl,
      answer: typeof q.answer === "number" ? q.answer : q.correct,
      goal: q.goal || null,
      parts: q.parts || null
    }))
  };

  const playSection = getEl("play");
  const resultSection = getEl("result");
  if (playSection) playSection.classList.add("hidden");
  if (resultSection) resultSection.classList.remove("hidden");

  const scoreText = getEl("scoreText");
  const scoreDetail = getEl("scoreDetail");
  const resName = getEl("resName");
  const resClass = getEl("resClass");
  const passBadge = getEl("passBadge");
  const unlockText = getEl("unlockText");

  if (scoreText) scoreText.innerHTML = `${percentage}%<span> resultat</span>`;
  if (scoreDetail) {
    scoreDetail.textContent =
      `${correctCount}/${total} r√§tt ‚Äì niv√•po√§ng: +${pointsGained}p, totalt: ${totalPointsAfter}p`;
  }
  if (resName) resName.textContent = s.student.name || "-";
  if (resClass) resClass.textContent = s.student.klass || "-";

  if (passBadge) {
    const passed = percentage >= threshold;
    if (passed) {
      passBadge.className = "badge-pass";
      passBadge.textContent = "Godk√§nd niv√•";
    } else {
      passBadge.className = "badge-fail";
      passBadge.textContent = "Inte godk√§nd √§nnu";
    }
  }

  if (unlockText) {
    let txt = "";
    if (lvl === "E" && s.unlocked.C) txt = "Niv√• 2 (C) √§r nu uppl√•st.";
    else if (lvl === "C" && s.unlocked.A) txt = "Niv√• 3 (A) √§r nu uppl√•st.";
    unlockText.textContent = txt;
  }

  currentLevel = null;
  currentQuestions = [];
  currentAnswers = [];

  updateAllProgressionUI();
  syncUI();
}
</script>
<!-- slut SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->


<!-- start SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post, l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->
<script>
"use strict";

/* Hj√§lpfunktion f√∂r att slippa getElementById √∂verallt */
function getEl(id) {
  return document.getElementById(id);
}

/* =========================
   5b ‚Äì L√§rarl√∂senord & status
   ========================= */

function showTeacherPasswordInStatus() {
  const s = loadState();
  const statusEl = getEl("passwordStatus");
  if (statusEl && s.teacherPassword) {
    statusEl.textContent = `Aktuellt l√§rarl√∂senord: ${s.teacherPassword}`;
  } else if (statusEl) {
    statusEl.textContent = "";
  }
}

/* =========================
   5c ‚Äì L√§rarl√§ge: gate + modal
   ========================= */

function openTeacherGate() {
  const gate = getEl("teacherGate");
  const input = getEl("teacherPasswordInput");
  const text = getEl("teacherGateText");
  const s = loadState();

  if (gate) gate.classList.remove("hidden");
  if (input) {
    input.value = "";
    input.type = "password";
    input.focus();
  }

  if (text) {
    if (s.teacherPassword) {
      text.textContent = "Ange l√§rarl√∂senord f√∂r att √∂ppna l√§rarl√§get.";
    } else {
      text.textContent = "F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.";
    }
  }
}

function closeTeacherGate() {
  const gate = getEl("teacherGate");
  if (gate) gate.classList.add("hidden");
}

function openTeacherModal() {
  const modal = getEl("teacherModal");
  if (modal) modal.classList.remove("hidden");
}

function closeTeacherModal() {
  const modal = getEl("teacherModal");
  if (modal) modal.classList.add("hidden");
}

function handleTeacherConfirm() {
  const input = getEl("teacherPasswordInput");
  const text = getEl("teacherGateText");
  if (!input) return;

  const entered = input.value.trim();
  if (!entered) {
    alert("Skriv in ett l√∂senord.");
    return;
  }

  const s = loadState();

  // F√∂rsta g√•ngen: s√§tt l√∂senordet
  if (!s.teacherPassword) {
    s.teacherPassword = entered;
    saveState(s);
    showTeacherPasswordInStatus();
    if (text) text.textContent = "L√∂senord sparat. √ñppnar l√§rarl√§ge.";
    closeTeacherGate();
    openTeacherModal();
    return;
  }

  // Efter√•t: kontrollera l√∂senordet
  if (s.teacherPassword === entered) {
    if (text) text.textContent = "L√∂senord OK. √ñppnar l√§rarl√§ge.";
    closeTeacherGate();
    openTeacherModal();
  } else {
    if (text) text.textContent = "Fel l√∂senord. F√∂rs√∂k igen.";
    input.value = "";
    input.focus();
  }
}

/* =========================
   5d ‚Äì Fliknavigering i l√§rarmodal
   ========================= */

function setupTabNavigation() {
  const tabButtons = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");

  if (!tabButtons.length || !panels.length) return;

  function activateTab(tabId) {
    tabButtons.forEach((btn) => {
      const isActive = btn.getAttribute("data-tab") === tabId;
      if (isActive) btn.classList.add("active");
      else btn.classList.remove("active");
    });

    panels.forEach((panel) => {
      const panelId = panel.getAttribute("data-panel");
      panel.classList.toggle("hidden", panelId !== tabId);
    });
  }

  tabButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tabId = btn.getAttribute("data-tab");
      if (!tabId) return;
      activateTab(tabId);
    });
  });

  // S√§kerst√§ll att "settings" √§r aktiv som start (om den finns)
  const defaultTab = document.querySelector('.tab-btn[data-tab="settings"]');
  if (defaultTab) activateTab("settings");
}

/* =========================
   5e ‚Äì Bankstatus (UI)
   ========================= */

function updateBankStatusUI() {
  const listEl = getEl("cloudBankList");
  if (!listEl) return;

  const hostCard = listEl.closest(".card");
  if (!hostCard) return;

  let statusEl = getEl("bankStatus");
  if (!statusEl) {
    statusEl = document.createElement("p");
    statusEl.id = "bankStatus";
    statusEl.className = "mini";
    statusEl.style.marginTop = "6px";
  }

  // S√§kerst√§ll att status ligger precis f√∂re listan
  if (statusEl.parentNode !== hostCard) {
    if (statusEl.parentNode) statusEl.parentNode.removeChild(statusEl);
    hostCard.insertBefore(statusEl, listEl);
  } else if (statusEl.nextSibling !== listEl) {
    hostCard.insertBefore(statusEl, listEl);
  }

  const s = loadState();
  const bank = s.bank || {};
  const mcqCount = Array.isArray(bank.mcq) ? bank.mcq.length : 0;
  const imgCount = Array.isArray(bank.img) ? bank.img.length : 0;
  const dragCount = Array.isArray(bank.drag) ? bank.drag.length : 0;
  const total = mcqCount + imgCount + dragCount;

  if (!total) {
    statusEl.textContent = "Status: Ingen fr√•gebank laddad.";
  } else {
    statusEl.textContent =
      `Status: Aktiv bank med ${total} fr√•gor ` +
      `(MCQ: ${mcqCount}, bild: ${imgCount}, drag & drop: ${dragCount}).`;
  }
}

/* =========================
   5f ‚Äì Initiering & knappar
   ========================= */

function initApp() {
  console.log("initApp start");

  // 1. S√§kerst√§ll fr√•gebank (merga embedded-data om tom)
  let s = loadState();
  const hasBank =
    s.bank &&
    (
      (Array.isArray(s.bank.mcq) && s.bank.mcq.length) ||
      (Array.isArray(s.bank.img) && s.bank.img.length) ||
      (Array.isArray(s.bank.drag) && s.bank.drag.length)
    );

  if (!hasBank && typeof mergeEmbeddedBank === "function") {
    console.log("Ingen lokal bank ‚Äì mergar embedded-data");
    s = mergeEmbeddedBank(s);
    saveState(s);
  }

  // 2. Initiera inst√§llningsdelar om de finns
  if (typeof initTeacherEmailSettings === "function") initTeacherEmailSettings();
  if (typeof initThresholdSettings === "function") initThresholdSettings();
  if (typeof initTeacherPasswordSettings === "function") initTeacherPasswordSettings();
  showTeacherPasswordInStatus();

  if (typeof initGoalsMap === "function") initGoalsMap();
  if (typeof initQuestionForms === "function") initQuestionForms();
  if (typeof initImageQuestionsEditor === "function") initImageQuestionsEditor();
  if (typeof initDragDropQuestionsEditor === "function") initDragDropQuestionsEditor();

  // Fliknavigering
  setupTabNavigation();

  if (typeof setupCloudBankUI === "function") setupCloudBankUI();
  if (typeof syncUI === "function") syncUI();

  // Uppdatera visuell bankstatus
  updateBankStatusUI();

  /* ---------- Elevyta: knappar ---------- */

  const btnSaveStudent = getEl("btnSaveStudent");
  if (btnSaveStudent) {
    btnSaveStudent.addEventListener("click", handleSaveStudent);
  }

  const btnStartE = getEl("start-levelE");
  const btnStartC = getEl("start-levelC");
  const btnStartA = getEl("start-levelA");
  if (btnStartE) btnStartE.addEventListener("click", () => startLevel("E"));
  if (btnStartC) btnStartC.addEventListener("click", () => startLevel("C"));
  if (btnStartA) btnStartA.addEventListener("click", () => startLevel("A"));

  const btnFinish = getEl("btnFinish");
  if (btnFinish) btnFinish.addEventListener("click", finishLevel);

  const btnBack = getEl("btnBack");
  if (btnBack) {
    btnBack.addEventListener("click", () => {
      const result = getEl("result");
      const play = getEl("play");
      if (result) result.classList.add("hidden");
      if (play) play.classList.add("hidden");
      const studentCard = getEl("studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      if (typeof syncUI === "function") syncUI();
    });
  }

  const btnCancel = getEl("btnCancel");
  if (btnCancel) {
    btnCancel.addEventListener("click", () => {
      if (typeof currentLevel !== "undefined") currentLevel = null;
      if (typeof currentQuestions !== "undefined") currentQuestions = [];
      if (typeof currentAnswers !== "undefined") currentAnswers = [];
      const play = getEl("play");
      const result = getEl("result");
      if (play) play.classList.add("hidden");
      if (result) result.classList.add("hidden");
      const studentCard = getEl("studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      if (typeof syncUI === "function") syncUI();
    });
  }

  const btnSubmitGame = getEl("btnSubmitGame");
  if (btnSubmitGame) {
    btnSubmitGame.addEventListener("click", async () => {
      try {
        await saveCurrentResultToFirestore();
        alert("Ditt resultat √§r inl√§mnat till l√§raren.");
      } catch (err) {
        console.error("Fel vid inl√§mning:", err);
        alert("Kunde inte l√§mna in resultatet. F√∂rs√∂k igen eller kontakta l√§raren.");
      }
    });
  }

  /* ---------- L√§rarl√§ge: knappar ---------- */

  const btnTeacherMode = getEl("btnTeacherMode");
  if (btnTeacherMode) {
    btnTeacherMode.addEventListener("click", openTeacherGate);
  }

  const btnTeacherCancel = getEl("btnTeacherCancel");
  if (btnTeacherCancel) {
    btnTeacherCancel.addEventListener("click", closeTeacherGate);
  }

  const btnTeacherConfirm = getEl("btnTeacherConfirm");
  if (btnTeacherConfirm) {
    btnTeacherConfirm.addEventListener("click", handleTeacherConfirm);
  }

  const btnCloseTeacher = getEl("btnCloseTeacher");
  if (btnCloseTeacher) {
    btnCloseTeacher.addEventListener("click", closeTeacherModal);
  }

  /* ---------- Inst√§llningar: tr√∂sklar, e-post, l√∂sen ---------- */

  const btnSaveThresholds = getEl("btnSaveThresholds");
  if (btnSaveThresholds && typeof handleSaveThresholds === "function") {
    btnSaveThresholds.addEventListener("click", handleSaveThresholds);
  }

  // (E-postfunktionen √§r borttagen ‚Äì vi beh√•ller endast ev. spar-knappen om du vill lagra adressen lokalt)
  const btnSaveTeacherEmail = getEl("btnSaveTeacherEmail");
  if (btnSaveTeacherEmail && typeof handleSaveTeacherEmail === "function") {
    btnSaveTeacherEmail.addEventListener("click", handleSaveTeacherEmail);
  }

  const btnChangeTeacherPassword = getEl("btnChangeTeacherPassword");
  if (btnChangeTeacherPassword && typeof handleChangeTeacherPassword === "function") {
    btnChangeTeacherPassword.addEventListener("click", handleChangeTeacherPassword);
  }

  /* ---------- Delm√•l/delbitar ---------- */

  const btnAddGoalPart = getEl("btnAddGoalPart");
  if (btnAddGoalPart && typeof handleAddGoalPart === "function") {
    btnAddGoalPart.addEventListener("click", handleAddGoalPart);
  }

  const btnSaveGoalsMap = getEl("btnSaveGoalsMap");
  if (btnSaveGoalsMap && typeof handleSaveGoalsMap === "function") {
    btnSaveGoalsMap.addEventListener("click", handleSaveGoalsMap);
  }

  const btnClearGoalsMap = getEl("btnClearGoalsMap");
  if (btnClearGoalsMap && typeof handleClearGoalsMap === "function") {
    btnClearGoalsMap.addEventListener("click", handleClearGoalsMap);
  }

  /* ---------- Rensa / nollst√§ll elevdata ---------- */

  const btnClearStudentData = getEl("btnClearStudentData");
  if (btnClearStudentData && typeof handleClearStudentData === "function") {
    btnClearStudentData.addEventListener("click", handleClearStudentData);
  }

  const btnResetGameData = getEl("btnResetGameData");
  if (btnResetGameData && typeof handleResetGameData === "function") {
    btnResetGameData.addEventListener("click", handleResetGameData);
  }

  /* ---------- Fr√•gebank & Firebase ---------- */

  const btnLoadCloudBanks = getEl("btnLoadCloudBanks");
  if (btnLoadCloudBanks && typeof handleLoadCloudBanks === "function") {
    btnLoadCloudBanks.addEventListener("click", () => {
      // Om l√§raren inte √§r inloggad kan Firestore ge "Missing or insufficient permissions"
      if (typeof currentTeacherUser !== "undefined" && !currentTeacherUser) {
        alert("Logga in med Google f√∂rst f√∂r att ladda moln-bankar.");
        return;
      }
      handleLoadCloudBanks();
      updateBankStatusUI();
    });
  }

  const btnSaveToCloud = getEl("btnSaveToCloud");
  if (btnSaveToCloud && typeof handleSaveToCloud === "function") {
    btnSaveToCloud.addEventListener("click", () => {
      handleSaveToCloud();
      updateBankStatusUI();
    });
  }

  const btnExportBank = getEl("btnExportBank");
  if (btnExportBank && typeof handleExportBank === "function") {
    btnExportBank.addEventListener("click", () => {
      handleExportBank();
      updateBankStatusUI();
    });
  }

  const fileImport = getEl("fileImport");
  if (fileImport && typeof handleImportBank === "function") {
    fileImport.addEventListener("change", (evt) => {
      handleImportBank(evt);
      updateBankStatusUI();
    });
  }

  const btnGoogleLogin = getEl("btnGooglePlaceholder");
  if (btnGoogleLogin && typeof handleGoogleLogin === "function") {
    btnGoogleLogin.addEventListener("click", handleGoogleLogin);
  }

  const btnGoogleLogout = getEl("btnGoogleLogout");
  if (btnGoogleLogout && typeof handleGoogleLogout === "function") {
    btnGoogleLogout.addEventListener("click", handleGoogleLogout);
  }

  // Publik bank/elevl√§nk (om UI finns)
  const btnPublishSharedBank = getEl("btnPublishSharedBank");
  if (btnPublishSharedBank && typeof handlePublishSharedBank === "function") {
    btnPublishSharedBank.addEventListener("click", handlePublishSharedBank);
  }

  console.log("initApp klar ‚Äì knappar kopplade");
}

/* =========================
   5g ‚Äì DOMContentLoaded
   ========================= */

document.addEventListener("DOMContentLoaded", function () {
  if (typeof initFirebase === "function") {
    try {
      initFirebase();
      console.log("Firebase init OK");
    } catch (e) {
      console.error("Fel vid initFirebase:", e);
    }
  }

  try {
    initApp();
  } catch (e) {
    console.error("Fel vid initApp:", e);
  }
});

/* Testa nu. Om n√•got fortfarande saknas: klistra in konsol-loggen + vad som inte syns. */
/* Ingen mer kod i denna leverans ‚Äì detta √§r hela SEKTION 5. */
</script>
<!-- slut SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post, l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->

<!-- start SEKTION 5X: GDPR-S√ÑKERHETSPATCH (pseudonymisering, dataminimering, gallring) -->
<script>
"use strict";

(function GDPR_PATCH(){
  /* =========================
     GDPR-inst√§llningar (√§ndra vid behov)
     ========================= */
  const GDPR = {
    // Hur l√§nge elevdata f√•r ligga kvar lokalt innan den rensas automatiskt
    retentionDays: 30,

    // Om true: lagra namn/klass i localStorage (INTE rekommenderat). Om false: lagra endast pseudonym/elevkod.
    storePersonal: false,

    // Om true: rensa namn/klass √§ven i highscoreposter
    anonymizeHighscore: true
  };

  function nowMs(){ return Date.now(); }
  function daysToMs(d){ return d * 24 * 60 * 60 * 1000; }

  // Enkel stabil hash (FNV-1a) f√∂r pseudonym-ID (ej kryptografisk, men duger f√∂r pseudonymisering lokalt)
  function fnv1a(str){
    let h = 0x811c9dc5;
    for (let i = 0; i < str.length; i++){
      h ^= str.charCodeAt(i);
      h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
    }
    return ("00000000" + h.toString(16)).slice(-8);
  }

  function makeStudentId(name, klass){
    const n = (name || "").trim().toLowerCase();
    const k = (klass || "").trim().toLowerCase();
    const base = (n || "-") + "|" + (k || "-");
    return "FV-" + fnv1a("fangvaktaren|v17|" + base);
  }

  function isElevkod(str){
    const s = (str || "").trim();
    // Accepterar t.ex. E21, e21, E-21
    return /^E[- ]?\d{1,4}$/i.test(s);
  }

  function getStudentKey(s){
    if (!s || !s.student) return "";
    return (s.student.id || "").trim();
  }

  function getStudentLabel(s){
    if (!s || !s.student) return "Elev";
    const lbl = (s.student.label || "").trim();
    if (lbl) return lbl;
    const id = (s.student.id || "").trim();
    if (id) return "Elev " + id.slice(-4);
    return "Elev";
  }

  function normalizeStateForGDPR(s){
    if (!s || typeof s !== "object") s = {};
    if (!s.student || typeof s.student !== "object") s.student = { name:"", klass:"", id:"", label:"", klassLabel:"" };
    if (!s.meta || typeof s.meta !== "object") s.meta = {};
    if (typeof s.meta.lastActiveMs !== "number") s.meta.lastActiveMs = nowMs();
    return s;
  }

  function purgePersonalData(s){
    s = normalizeStateForGDPR(s);

    // Student: spara endast id + valfri label (ex elevkod). Rensa namn/klass om vi inte f√•r spara personligt.
    if (!GDPR.storePersonal){
      s.student.name = "";
      s.student.klass = "";
    }

    // Highscore: rensa namn/klass f√∂r att undvika personuppgifter i listan
    if (GDPR.anonymizeHighscore && Array.isArray(s.highscores)){
      s.highscores = s.highscores.map((e) => {
        const out = Object.assign({}, e);
        if (!GDPR.storePersonal){
          delete out.name;
          delete out.klass;
        }
        // s√§kerst√§ll att id finns
        if (!out.id && out.studentId) out.id = out.studentId;
        return out;
      });
    }

    return s;
  }

  /* =========================
     Wrap: loadState/saveState
     ========================= */
  const _loadState = (typeof loadState === "function") ? loadState : null;
  const _saveState = (typeof saveState === "function") ? saveState : null;

  if (_loadState){
    window.loadState = function(){
      let s = _loadState();
      s = normalizeStateForGDPR(s);

      // Gallring: om f√∂r gammalt -> rensa elevdata men beh√•ll bank/goals/tr√∂sklar/l√§rarl√∂sen
      const last = s.meta.lastActiveMs;
      if (typeof last === "number" && (nowMs() - last) > daysToMs(GDPR.retentionDays)){
        const keep = {
          bank: s.bank,
          goalsMap: s.goalsMap,
          thres: s.thres,
          teacherPassword: s.teacherPassword,
          teacherEmail: s.teacherEmail
        };

        s.student = { name:"", klass:"", id:"", label:"", klassLabel:"" };
        s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
        s.best = { E: 0, C: 0, A: 0 };
        s.unlocked = { C: false, A: false };
        s.highscores = [];
        s.meta.lastActiveMs = nowMs();

        // √Öterst√§ll det vi vill beh√•lla
        if (keep.bank) s.bank = keep.bank;
        if (keep.goalsMap) s.goalsMap = keep.goalsMap;
        if (keep.thres) s.thres = keep.thres;
        if (keep.teacherPassword) s.teacherPassword = keep.teacherPassword;
        if (keep.teacherEmail) s.teacherEmail = keep.teacherEmail;
      }

      return purgePersonalData(s);
    };
  }

  if (_saveState){
    window.saveState = function(state){
      let s = normalizeStateForGDPR(state);
      s.meta.lastActiveMs = nowMs();
      s = purgePersonalData(s);
      return _saveState(s);
    };
  }

  /* =========================
     Override: ensureStudentSet / handleSaveStudent / updateStudentStatsUI / syncUI / handleGenerateProgressJson / finishLevel
     ========================= */

  window.ensureStudentSet = function(){
    const s = loadState();
    const ok = !!(getStudentKey(s) || (s.student.name && s.student.klass));
    if (!ok){
      alert("Skriv in elevkod/namn + klass och spara eleven f√∂rst.");
      return false;
    }
    return true;
  };

  window.handleSaveStudent = function(){
    const nameInput = getEl("studentName");
    const classInput = getEl("studentClass");

    const rawName = (nameInput && nameInput.value.trim()) || "";
    const rawClass = (classInput && classInput.value.trim()) || "";

    const s = loadState();

    // Om anv√§ndaren skriver elevkod i "namn"-f√§ltet: anv√§nd den direkt som ID
    let id = "";
    if (isElevkod(rawName)) {
      id = rawName.toUpperCase().replace(/\s+/g,"").replace("E-","E");
    } else {
      id = makeStudentId(rawName, rawClass);
    }

    s.student.id = id;
    s.student.label = rawName ? rawName : ("Elev " + id.slice(-4));  // g√§rna elevkod
    s.student.klassLabel = rawClass || "";

    if (GDPR.storePersonal){
      s.student.name = rawName;
      s.student.klass = rawClass;
    } else {
      s.student.name = "";
      s.student.klass = "";
    }

    saveState(s);
    if (typeof syncUI === "function") syncUI();
  };

  window.updateStudentStatsUI = function(){
    const s = loadState();
    const ptsEl = getEl("studentPointsValue");
    const hsEl = getEl("highscoreSummary");

    const totalPoints = (s.progression && typeof s.progression.totalPoints === "number")
      ? s.progression.totalPoints
      : 0;

    if (ptsEl) ptsEl.textContent = `${totalPoints} p`;

    if (!hsEl) return;

    const hs = Array.isArray(s.highscores) ? s.highscores.slice() : [];
    if (!hs.length){
      hsEl.textContent = "Ingen highscore √§nnu.";
      return;
    }

    hs.sort((a,b) => (b.points || 0) - (a.points || 0));

    const sid = getStudentKey(s) || ((s.student.name || "Elev") + "||" + (s.student.klass || "-"));
    const idx = hs.findIndex((e) => (e.id || "") === sid);

    if (idx >= 0){
      hsEl.textContent = `Plats ${idx + 1} av ${hs.length} (${hs[idx].points || 0} p)`;
    } else {
      hsEl.textContent = `Highscorelista: ${hs.length} elever p√• denna enhet.`;
    }
  };

  // SyncUI m√•ste r√§kna "hasStudent" via student.id ocks√• (s√• niv√• 1 kan startas utan namn/klass i localStorage)
  window.syncUI = function(){
    const s = loadState();
    const hasStudent = !!(getStudentKey(s) || (s.student.name && s.student.klass));

    const nameInput = getEl("studentName");
    const classInput = getEl("studentClass");

    // Visa label/klassLabel i f√§lten om vi inte lagrar personligt
    if (nameInput) nameInput.value = GDPR.storePersonal ? (s.student.name || "") : (s.student.label || "");
    if (classInput) classInput.value = GDPR.storePersonal ? (s.student.klass || "") : (s.student.klassLabel || "");

    const studentSaved = getEl("studentSaved");
    if (studentSaved){
      studentSaved.textContent = hasStudent
        ? `Sparad: ${getStudentLabel(s)}${s.student.klassLabel ? " (" + s.student.klassLabel + ")" : ""}`
        : "Ej sparad elev";
    }

    const bestE = getEl("best-levelE");
    const bestC = getEl("best-levelC");
    const bestA = getEl("best-levelA");
    if (bestE) bestE.textContent = (s.best && s.best.E) || 0;
    if (bestC) bestC.textContent = (s.best && s.best.C) || 0;
    if (bestA) bestA.textContent = (s.best && s.best.A) || 0;

    const thresE = getEl("thres-levelE");
    const thresC = getEl("thres-levelC");
    const thresA = getEl("thres-levelA");
    if (thresE && s.thres && typeof s.thres.E === "number") thresE.textContent = s.thres.E;
    if (thresC && s.thres && typeof s.thres.C === "number") thresC.textContent = s.thres.C;
    if (thresA && s.thres && typeof s.thres.A === "number") thresA.textContent = s.thres.A;

    const cardE = getEl("card-levelE");
    const cardC = getEl("card-levelC");
    const cardA = getEl("card-levelA");
    const btnE = getEl("start-levelE");
    const btnC = getEl("start-levelC");
    const btnA = getEl("start-levelA");
    const badgeE = getEl("badge-levelE");
    const badgeC = getEl("badge-levelC");
    const badgeA = getEl("badge-levelA");

    if (cardE && btnE && badgeE){
      if (hasStudent){
        cardE.classList.remove("locked");
        btnE.disabled = false;
        badgeE.textContent = "Starta";
        badgeE.classList.remove("badge-lock");
        badgeE.classList.add("badge-ok");
      } else {
        cardE.classList.add("locked");
        btnE.disabled = true;
        badgeE.textContent = "L√•st";
        badgeE.classList.remove("badge-ok");
        badgeE.classList.add("badge-lock");
      }
    }

    if (cardC && btnC && badgeC){
      if (s.unlocked && s.unlocked.C){
        cardC.classList.remove("locked");
        btnC.disabled = false;
        badgeC.textContent = "Uppl√•st";
        badgeC.classList.remove("badge-lock");
        badgeC.classList.add("badge-ok");
      } else {
        cardC.classList.add("locked");
        btnC.disabled = true;
        badgeC.textContent = "L√•st";
        badgeC.classList.remove("badge-ok");
        badgeC.classList.add("badge-lock");
      }
    }

    if (cardA && btnA && badgeA){
      if (s.unlocked && s.unlocked.A){
        cardA.classList.remove("locked");
        btnA.disabled = false;
        badgeA.textContent = "Uppl√•st";
        badgeA.classList.remove("badge-lock");
        badgeA.classList.add("badge-ok");
      } else {
        cardA.classList.add("locked");
        btnA.disabled = true;
        badgeA.textContent = "L√•st";
        badgeA.classList.remove("badge-ok");
        badgeA.classList.add("badge-lock");
      }
    }

    const who = getEl("whoPlays");
    if (who){
      who.textContent = hasStudent ? getStudentLabel(s) : "Ingen elev vald.";
    }

    const playSection = getEl("play");
    const resultSection = getEl("result");
    const studentCard = getEl("studentCard");

    const isPlaying = typeof currentLevel !== "undefined" && !!currentLevel;
    const isResultVisible = resultSection && !resultSection.classList.contains("hidden");

    if (studentCard){
      studentCard.classList.toggle("hidden", isPlaying || isResultVisible);
    }

    if (typeof updateAllProgressionUI === "function") updateAllProgressionUI();
  };

  window.handleGenerateProgressJson = function(){
    const s = loadState();
    const prog = s.progression || {};
    const last = prog.lastResult || null;

    const output = getEl("progressExportJson");
    if (!output) return;

    if (!last){
      output.value = "";
      return;
    }

    const payload = {
      source: "fangvaktaren",
      version: "v17",
      student: {
        id: getStudentKey(s) || "",
        label: getStudentLabel(s) || ""
      },
      result: {
        level: last.level,
        scorePercent: last.score,
        correct: last.correct,
        total: last.total,
        pointsGained: last.pointsGained,
        totalPointsAfter: last.totalPointsAfter,
        timestamp: last.timestamp
      },
      progression: {
        totalPoints: (prog.totalPoints || 0),
        best: s.best || {},
        wrongByGoalId: prog.wrongByGoalId || {},
        correctByGoalId: prog.correctByGoalId || {}
      }
    };

    output.value = JSON.stringify(payload, null, 2);
  };

  // Override finishLevel f√∂r att anv√§nda student.id som nyckel och undvika att skriva namn/klass i highscore/submission
  const _finishLevel_original = (typeof finishLevel === "function") ? finishLevel : null;
  window.finishLevel = function(){
    // Om original saknas: fall tillbaka
    if (!_finishLevel_original) return;

    // Vi k√∂r en kopia av logiken fr√•n SEKTION 4 (men med GDPR-s√§kra f√§lt)
    if (!currentLevel || !currentQuestions.length){
      alert("Ingen niv√• √§r aktiv.");
      return;
    }

    const s = loadState();
    const goals = (typeof normalizeGoalsMap === "function") ? normalizeGoalsMap(s) : [];
    let correctCount = 0;
    let pointsGained = 0;
    let allCorrect = true;

    if (!s.progression || typeof s.progression !== "object"){
      s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
    }
    s.progression.totalPoints = s.progression.totalPoints || 0;
    s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
    s.progression.correctByGoalId = s.progression.correctByGoalId || {};

    const wrongByGoal = s.progression.wrongByGoalId;
    const correctByGoal = s.progression.correctByGoalId;

    const lvl = currentLevel;
    const basePointsPerQuestion =
      lvl === "A" ? 3 :
      lvl === "C" ? 2 : 1;

    currentQuestions.forEach((q, index) => {
      const ansVal = currentAnswers[index];
      let isCorrect = false;

      if (q.type === "drag"){
        const correctMap = q.correctMap || {};
        const keys = Object.keys(correctMap);
        if (!keys.length){
          isCorrect = false;
        } else if (!ansVal || typeof ansVal !== "object"){
          isCorrect = false;
        } else {
          let allOk = true;
          for (const itemId of keys){
            if (!ansVal[itemId] || ansVal[itemId] !== correctMap[itemId]){
              allOk = false;
              break;
            }
          }
          isCorrect = allOk;
        }
      } else {
        if (ansVal != null){
          const correctIndex = typeof q.answer === "number" ? q.answer : q.correct;
          isCorrect = ansVal === correctIndex;
        } else {
          isCorrect = false;
        }
      }

      if (isCorrect){
        correctCount++;
        pointsGained += basePointsPerQuestion;
      } else {
        allCorrect = false;
      }

      const links = (typeof getLinksForQuestion === "function") ? getLinksForQuestion(q, goals) : [];
      if (links && links.length){
        links.forEach((lnk) => {
          const key = String(lnk.id);
          if (isCorrect) correctByGoal[key] = (correctByGoal[key] || 0) + 1;
          else wrongByGoal[key] = (wrongByGoal[key] || 0) + 1;
        });
      }
    });

    const total = currentQuestions.length;
    const percentage = total ? Math.round((correctCount / total) * 100) : 0;
    const threshold = (s.thres && s.thres[lvl] != null) ? s.thres[lvl] : 70;

    if (!s.best) s.best = { E: 0, C: 0, A: 0 };
    if (percentage > (s.best[lvl] || 0)) s.best[lvl] = percentage;

    if (!s.unlocked) s.unlocked = { C: false, A: false };
    if (lvl === "E" && percentage >= threshold) s.unlocked.C = true;
    if (lvl === "C" && percentage >= threshold) s.unlocked.A = true;

    if (total > 0 && allCorrect) pointsGained += 5;

    s.progression.totalPoints += pointsGained;
    const totalPointsAfter = s.progression.totalPoints;

    const nowIso = new Date().toISOString();
    const lastResult = {
      level: lvl,
      score: percentage,
      correct: correctCount,
      total,
      pointsGained,
      totalPointsAfter,
      timestamp: nowIso
    };
    s.progression.lastResult = lastResult;

    if (!Array.isArray(s.highscores)) s.highscores = [];
    const studentId = getStudentKey(s) || makeStudentId(getStudentLabel(s), s.student.klassLabel || "-");
    const newEntry = {
      id: studentId,
      points: totalPointsAfter,
      level: lvl,
      score: percentage,
      updatedAt: nowIso
    };
    if (GDPR.storePersonal){
      newEntry.name = s.student.name || "";
      newEntry.klass = s.student.klass || "";
    } else {
      newEntry.label = getStudentLabel(s);
      newEntry.klassLabel = s.student.klassLabel || "";
    }

    const idx = s.highscores.findIndex((e) => (e.id || "") === studentId);
    if (idx >= 0){
      if ((newEntry.points || 0) >= (s.highscores[idx].points || 0)) s.highscores[idx] = newEntry;
    } else {
      s.highscores.push(newEntry);
    }

    saveState(s);

    // Spara submission utan personuppgifter
    if (typeof lastSubmission !== "undefined"){
      lastSubmission = {
        level: lvl,
        studentId: studentId,
        studentLabel: getStudentLabel(s),
        studentClassLabel: s.student.klassLabel || "",
        timestamp: nowIso,
        score: percentage,
        correct: correctCount,
        total,
        pointsGained,
        totalPointsAfter,
        answers: currentAnswers.slice(),
        questions: currentQuestions.map((q) => ({
          q: q.q || q.text || "",
          type: q.type || "mcq",
          level: q.level || lvl,
          answer: typeof q.answer === "number" ? q.answer : q.correct,
          goal: q.goal || null,
          parts: q.parts || null
        }))
      };
    }

    const playSection = getEl("play");
    const resultSection = getEl("result");
    if (playSection) playSection.classList.add("hidden");
    if (resultSection) resultSection.classList.remove("hidden");

    const scoreText = getEl("scoreText");
    const scoreDetail = getEl("scoreDetail");
    const resName = getEl("resName");
    const resClass = getEl("resClass");
    const passBadge = getEl("passBadge");
    const unlockText = getEl("unlockText");

    if (scoreText) scoreText.innerHTML = `${percentage}%<span> resultat</span>`;
    if (scoreDetail){
      scoreDetail.textContent =
        `${correctCount}/${total} r√§tt ‚Äì niv√•po√§ng: +${pointsGained}p, totalt: ${totalPointsAfter}p`;
    }
    if (resName) resName.textContent = getStudentLabel(s);
    if (resClass) resClass.textContent = (s.student.klassLabel || "-");

    if (passBadge){
      const passed = percentage >= threshold;
      if (passed){
        passBadge.className = "badge-pass";
        passBadge.textContent = "Godk√§nd niv√•";
      } else {
        passBadge.className = "badge-fail";
        passBadge.textContent = "Inte godk√§nd √§nnu";
      }
    }

    if (unlockText){
      let txt = "";
      if (lvl === "E" && s.unlocked.C) txt = "Niv√• 2 (C) √§r nu uppl√•st.";
      else if (lvl === "C" && s.unlocked.A) txt = "Niv√• 3 (A) √§r nu uppl√•st.";
      unlockText.textContent = txt;
    }

    currentLevel = null;
    currentQuestions = [];
    currentAnswers = [];

    if (typeof updateAllProgressionUI === "function") updateAllProgressionUI();
    if (typeof syncUI === "function") syncUI();
  };

  // S√§kerst√§ll UI efter patch
  try {
    if (typeof syncUI === "function") syncUI();
  } catch (e) {}

})();
</script>
<!-- slut SEKTION 5X: GDPR-S√ÑKERHETSPATCH (pseudonymisering, dataminimering, gallring) -->



<!-- start SEKTION 6: AVSLUTANDE TAGGAR -->
</body>
</html>
<!-- slut SEKTION 6: AVSLUTANDE TAGGAR -->
