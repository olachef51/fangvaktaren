<!-- start SEKTION 1: HEAD & STIL -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>F√•ngvaktaren ‚Äì Progressionsspel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --accent-e:#b45309;
      --accent-c:#2563eb;
      --accent-a:#7c3aed;
      --accent-danger:#ef4444;
      --accent-info:#38bdf8;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --chip:#020617;
    }

    *{box-sizing:border-box;}

    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#020617 0,#020617 40%,#000 100%);
      color:var(--text);
    }

    body{
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:960px;
      margin:0 auto;
      min-height:100vh;
      padding:12px 12px 32px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(15,23,42,.85));
      border:1px solid #1f2937;
      box-shadow:0 0 40px rgba(15,23,42,.9);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(10px);
    }

    .header-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .title-block h1{
      margin:0;
      font-size:1.2rem;
      letter-spacing:.03em;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:999px;
      background:radial-gradient(circle,var(--accent-e),#111827);
      color:#fff;
      font-weight:700;
      font-size:.9rem;
      box-shadow:0 0 12px rgba(180,83,9,.8);
    }

    /* ---------- Buttons ---------- */

    .btn{
      --btn-bg:#111827;
      --btn-border:rgba(75,85,99,.9);
      border-radius:999px;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      padding:6px 12px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
      transition:
        background-color .15s ease,
        border-color .15s ease,
        box-shadow .18s ease,
        transform .12s ease,
        opacity .15s ease;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 0 0 rgba(59,130,246,0);
    }

    .btn-sm{
      padding:5px 10px;
      font-size:.8rem;
    }

    .btn-primary{
      --btn-bg:linear-gradient(135deg,var(--accent-e),var(--accent-c));
      --btn-border:rgba(96,165,250,.9);
      color:#f9fafb;
      box-shadow:
        0 0 0 1px rgba(148,163,184,.4),
        0 0 18px rgba(56,189,248,.45);
    }

    .btn-danger{
      --btn-bg:rgba(127,29,29,.95);
      --btn-border:rgba(239,68,68,.9);
      box-shadow:
        0 0 0 1px rgba(248,113,113,.5),
        0 0 14px rgba(248,113,113,.4);
    }

    .btn-secondary{
      --btn-bg:#020617;
      --btn-border:rgba(75,85,99,.8);
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(148,163,184,.6),
        0 0 24px rgba(59,130,246,.55);
      opacity:.97;
    }

    .btn:active{
      transform:translateY(0);
      box-shadow:
        0 0 0 1px rgba(107,114,128,.8),
        0 0 12px rgba(37,99,235,.45);
      opacity:.92;
    }

    .btn:disabled,
    .btn[disabled]{
      opacity:.45;
      cursor:default;
      box-shadow:
        0 0 0 1px rgba(31,41,55,1),
        0 0 0 rgba(0,0,0,0);
      transform:none;
    }

    /* Spara elev ‚Äì tydlig gr√∂n, fyllig knapp */
    #btnSaveStudent{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      border-color:rgba(34,197,94,1);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 20px rgba(34,197,94,.75);
    }

    #btnSaveStudent:hover{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 26px rgba(34,197,94,.9);
      transform:translateY(-1px);
    }

    #btnSaveStudent:active{
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 14px rgba(34,197,94,.8);
      transform:translateY(0);
    }

    #btnSaveStudent:disabled{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      opacity:.45;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 0 rgba(0,0,0,0);
    }

    /* L√§rarl√§ge ‚Äì m√∂rk bakgrund, gr√∂n kontur (outline-knapp) */
    #btnTeacherMode{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherMode:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherMode:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* L√∂senords-popup: ‚ÄúForts√§tt‚Äù ‚Äì samma gr√∂na kontur som l√§rarl√§ge */
    #btnTeacherConfirm{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherConfirm:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherConfirm:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* Spara niv√•gr√§nser ‚Äì gr√∂n kontur, samma stil */
    #btnSaveThresholds{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnSaveThresholds:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnSaveThresholds:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* ---------- Layout helpers ---------- */

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1 1 120px;
      min-width:0;
    }

    label{
      font-size:.7rem;
      color:var(--muted);
    }

    .small-label{
      font-size:.7rem;
      color:var(--muted);
    }

    .input,
    .input-number{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:.8rem;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }

    .input-number{
      appearance:textfield;
      -moz-appearance:textfield;
    }

    .input-number::-webkit-outer-spin-button,
    .input-number::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    .input:focus,
    .input-number:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
      background:#020617;
    }

    .mini{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.4;
    }

    .hidden{
      display:none !important;
    }

    /* ---------- Elevkort ---------- */

    .student-card{
      background:radial-gradient(circle at top left,#020617,#020617 55%,#000 100%);
      border-radius:16px;
      padding:12px 12px 14px;
      border:1px solid rgba(31,41,55,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .student-main-row{
      align-items:flex-end;
    }

    .student-save-field{
      max-width:180px;
    }

    .student-status-row{
      margin-top:2px;
    }

    .student-saved-label{
      font-size:.75rem;
      color:var(--muted);
    }

    .student-stats-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
    }

    .score-box{
      flex:1 1 160px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 55%,#000 100%);
      display:flex;
      flex-direction:column;
      gap:2px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 20px rgba(56,189,248,.4),
        0 12px 28px rgba(15,23,42,.9);
    }

    .score-label{
      font-size:.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .score-value{
      font-size:1rem;
      font-weight:600;
    }

    /* ---------- Niv√•-kort ---------- */

    .levels-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }

    .level-card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.9);
    }

    .level-card.locked{
      opacity:.7;
      filter:saturate(.7);
    }

    .level-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .level-title span:first-child{
      font-weight:600;
      font-size:.9rem;
    }

    .level-title small{
      display:block;
      font-size:.7rem;
      color:var(--muted);
    }

    .level-body{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:.78rem;
    }

    .level-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-top:4px;
    }

    .badge{
      border-radius:999px;
      padding:2px 8px;
      font-size:.7rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
    }

    .badge-lock{
      color:#fbbf24;
      border-color:rgba(245,158,11,.7);
      box-shadow:0 0 12px rgba(245,158,11,.35);
    }

    .badge-ok{
      color:#4ade80;
      border-color:rgba(74,222,128,.9);
      box-shadow:0 0 16px rgba(22,163,74,.65);
    }

    .badge-pass{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 18px rgba(22,163,74,.7);
    }

    .badge-fail{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#991b1b,#ef4444);
      color:#fee2e2;
      box-shadow:
        0 0 0 1px rgba(127,29,29,1),
        0 0 18px rgba(248,113,113,.7);
    }

    /* ---------- Spelpanel / Resultat ---------- */

    .play-panel,
    .result-panel{
      margin-top:8px;
      padding:10px 10px 12px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
    }

    .play-header,
    .result-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .questions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:4px;
    }

    .question{
      padding:8px 9px;
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top left,#020617,#020617 60%,#020617 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 26px rgba(15,23,42,.9);
      font-size:.85rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .q-text{
      font-size:.85rem;
      margin-top:2px;
    }

    .options-list{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:2px;
    }

    .option-label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
      padding:4px 6px;
      border-radius:999px;
      background:#020617;
      border:1px solid rgba(31,41,55,1);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,transform .1s ease;
    }

    .option-label input{
      accent-color:var(--accent-c);
    }

    .option-label:hover{
      background:#020617;
      border-color:rgba(59,130,246,.7);
      box-shadow:
        0 0 0 1px rgba(59,130,246,.9),
        0 0 16px rgba(37,99,235,.6);
      transform:translateY(-1px);
    }

    .play-footer{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:.75rem;
    }

    .play-actions{
      display:flex;
      gap:6px;
    }

    .score{
      font-size:1.6rem;
      font-weight:700;
    }

    .score span{
      font-size:.8rem;
      font-weight:400;
      margin-left:4px;
      color:var(--muted);
    }

    .result-meta{
      font-size:.78rem;
      color:var(--muted);
      margin-top:2px;
    }

    .result-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ---------- Modal & gate ---------- */

    .gate-backdrop,
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
      backdrop-filter:blur(10px);
    }

    .gate-box{
      width:100%;
      max-width:320px;
      padding:14px 14px 16px;
      border-radius:16px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:.85rem;
    }

    .gate-actions{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }

    .modal{
      width:100%;
      max-width:980px;
      max-height:90vh;
      padding:12px 12px 14px;
      border-radius:18px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:4px;
    }

    .modal-body{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding-right:2px;
    }

    /* ---------- Flikar ---------- */

    .tab-nav{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
    }

    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(55,65,81,1);
      padding:4px 9px;
      font-size:.75rem;
      background:#020617;
      color:var(--muted);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,color .15s ease;
    }

    .tab-btn.active{
      color:#e5e7eb;
      border-color:rgba(96,165,250,1);
      background:linear-gradient(135deg,#0369a1,#4f46e5);
      box-shadow:
        0 0 0 1px rgba(37,99,235,1),
        0 0 20px rgba(56,189,248,.7);
    }

    .tab-panel{
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 16px 34px rgba(15,23,42,.95);
    }

    /* ---------- Cards & grids ---------- */

    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px 10px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.95);
      font-size:.82rem;
    }

    .card-full-width{
      grid-column:1/-1;
    }

    .card-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }

    .questions-editor{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .goals-list,
    .question-list{
      list-style:none;
      padding:0;
      margin:4px 0 0;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.8rem;
    }

    .question-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      flex-direction:column;
      gap:4px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    .question-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:2px;
    }

    .img-preview-box{
      border-radius:10px;
      border:1px dashed rgba(55,65,81,1);
      padding:6px;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .img-preview-box img{
      max-width:100%;
      border-radius:8px;
    }

    .img-thumb{
      width:64px;
      height:44px;
      border-radius:8px;
      border:1px solid rgba(31,41,55,1);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#020617;
      margin-right:6px;
    }

    .img-thumb img{
      max-width:100%;
      max-height:100%;
      object-fit:cover;
    }

    .question-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .chip{
      border-radius:999px;
      padding:3px 8px;
      font-size:.75rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 6px 14px rgba(15,23,42,.85);
    }

    /* Elevprogression ‚Äì rutorna staplas p√• h√∂jden (en kolumn) */
    .progress-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }

    .progress-box{
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 24px rgba(15,23,42,.9);
      font-size:.8rem;
    }

    .mini-card{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      padding:6px 7px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .mini-title{
      font-size:.82rem;
      font-weight:600;
    }

    /* ---------- Responsivitet ---------- */

    @media (max-width:640px){
      .app{
        padding:8px 8px 24px;
      }
      .app-header{
        padding:8px 9px;
      }
      .levels-grid{
        grid-template-columns:1fr;
      }
      .play-header,
      .result-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .play-footer{
        flex-direction:column;
        align-items:flex-start;
      }
      .modal{
        padding:10px;
      }
    }

    /* ---------- F√§rger f√∂r niv√•kort (E / C / A) ---------- */

    #card-levelE{
      background:radial-gradient(circle at top,#ea580c,#b45309 55%,#020617 100%);
      border-color:rgba(234,88,12,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(234,88,12,.9);
    }

    #card-levelC{
      background:radial-gradient(circle at top,#1d4ed8,#1e40af 55%,#020617 100%);
      border-color:rgba(37,99,235,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(37,99,235,.9);
    }

    #card-levelA{
      background:radial-gradient(circle at top,#7c3aed,#6d28d9 55%,#020617 100%);
      border-color:rgba(124,58,237,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(124,58,237,.9);
    }
  </style>
</head>
<!-- slut SEKTION 1: HEAD & STIL -->










<!-- start SEKTION 2: FIREBASE-BIBLIOTEK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<!-- slut SEKTION 2: FIREBASE-BIBLIOTEK -->


<!-- start SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <h1><span class="logo">F</span>F√•ngvaktaren</h1>
      </div>
      <button id="btnTeacherMode" class="btn btn-sm btn-primary">üîë L√§rarl√§ge</button>
    </header>

    <!-- Elevkort / namn, klass, po√§ng, highscore -->
    <section id="studentCard" class="student-card">
      <div class="row student-main-row">
        <div class="field">
          <label for="studentName">Namn</label>
          <input id="studentName" class="input" placeholder="Elevens namn..." autocomplete="off" />
        </div>
        <div class="field">
          <label for="studentClass">Klass</label>
          <input id="studentClass" class="input" placeholder="Klass..." autocomplete="off" />
        </div>
        <div class="field student-save-field">
          <label>&nbsp;</label>
          <button id="btnSaveStudent" class="btn btn-sm btn-primary" style="width:100%;">üíæ Spara elev</button>
        </div>
      </div>

      <div class="student-status-row">
        <span id="studentSaved" class="student-saved-label">Ej sparad elev</span>
      </div>

      <div class="student-stats-row">
        <div class="score-box glow-box">
          <div class="score-label">Po√§ng</div>
          <div class="score-value" id="studentPointsValue">0 p</div>
        </div>
        <div class="score-box glow-box">
          <div class="score-label">Highscore</div>
          <div class="score-value" id="highscoreSummary">
            Ingen highscore √§nnu.
          </div>
        </div>
      </div>
    </section>

    <!-- Niv√•kort -->
    <section class="levels-grid">
      <article id="card-levelE" class="level-card level-e locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 1</span>
            <small>Grundniv√• ‚Äì E</small>
          </div>
          <span id="badge-levelE" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelE">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelE">70</span>%</span>
          <span class="mini">L√•ses upp n√§r eleven sparat namn & klass.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• E-niv√•.</div>
          <button id="start-levelE" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 1</button>
        </div>
      </article>

      <article id="card-levelC" class="level-card level-c locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 2</span>
            <small>Mellanniv√• ‚Äì C</small>
          </div>
          <span id="badge-levelC" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelC">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelC">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 1 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• C-niv√•.</div>
          <button id="start-levelC" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 2</button>
        </div>
      </article>

      <article id="card-levelA" class="level-card level-a locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 3</span>
            <small>Avancerad ‚Äì A</small>
          </div>
          <span id="badge-levelA" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelA">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelA">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 2 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• A-niv√•.</div>
          <button id="start-levelA" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 3</button>
        </div>
      </article>
    </section>

    <!-- Spelpanel -->
    <section id="play" class="play-panel hidden">
      <header class="play-header">
        <div>
          <h2 id="play-title">Aktiv niv√•</h2>
          <small id="whoPlays">Ingen elev vald.</small>
        </div>
        <button id="btnCancel" class="btn btn-sm">‚¨ÖÔ∏è Avsluta utan att l√§mna in</button>
      </header>
      <div id="questions" class="questions">
        <div class="question mini">V√§lj en niv√• f√∂r att b√∂rja.</div>
      </div>
      <footer class="play-footer">
        <div class="mini">
          Svar registreras n√§r du klickar i alternativen eller sl√§pper kort i r√§tt ruta.
        </div>
        <div class="play-actions">
          <button id="btnSpeakQuestion" class="btn btn-sm">üîä L√§s upp fr√•gan</button>
          <button id="btnFinish" class="btn btn-sm btn-primary">‚úÖ L√§mna in niv√•</button>
        </div>
      </footer>
    </section>

    <!-- Resultatpanel -->
    <section id="result" class="result-panel hidden">
      <header class="result-header">
        <div>
          <div class="score" id="scoreText">0%<span> resultat</span></div>
          <div id="scoreDetail" class="result-meta">0/0 po√§ng</div>
          <div class="result-meta">
            Elev: <span id="resName">-</span> (<span id="resClass">-</span>)
          </div>
        </div>
        <div>
          <div id="passBadge" class="badge-fail">Resultat</div>
          <div id="unlockText" class="result-meta"></div>
        </div>
      </header>

      <div class="result-actions" id="resultActionsNormal">
        <button id="btnBack" class="btn btn-sm">‚¨ÖÔ∏è Tillbaka till niv√•er</button>
        <button id="btnSubmitGame" class="btn btn-sm btn-primary">‚úâÔ∏è L√§mna in spel f√∂r po√§ng</button>
      </div>
    </section>
  </div>

  <!-- Embedded grundbank (kan vara tom eller kort) -->
  <script id="embedded-data" type="application/json">
  {
    "bank": {
      "mcq": [
        {
          "level": "E",
          "type": "mcq",
          "q": "Vad √§r viktigast f√∂rst n√§r du kommer till k√∂ket?",
          "options": ["Ta p√• f√∂rkl√§de", "Tv√§tta h√§nderna", "S√§tta p√• ugnen", "Smaka p√• maten"],
          "answer": 1
        },
        {
          "level": "C",
          "type": "mcq",
          "q": "En g√§st klagar p√• kall mat. Vad √§r ett bra f√∂rsta steg?",
          "options": ["Ignorera g√§sten", "Skylla p√• k√∂ket", "Be om urs√§kt och erbjuda l√∂sning", "S√§ga att det inte √§r ditt fel"],
          "answer": 2
        },
        {
          "level": "A",
          "type": "mcq",
          "q": "Du planerar en buff√©. Vad √§r viktigast f√∂r s√§ker livsmedelshantering?",
          "options": ["Att det ser fint ut", "Att alla r√§tter √§r varma samtidigt", "R√§tt temperaturer och tidsgr√§nser", "Att det finns m√•nga olika r√§tter"],
          "answer": 2
        }
      ]
    }
  }
  </script>

  <!-- L√§rarl√§ge ‚Äì Gate -->
  <div id="teacherGate" class="gate-backdrop hidden">
    <div class="gate-box">
      <h2>üîë L√§rarl√§ge</h2>
      <p id="teacherGateText">
        Ange l√§rarl√∂senord. F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.
      </p>
      <input id="teacherPasswordInput" class="input" type="password" placeholder="L√∂senord..." />
      <div class="gate-actions">
        <button id="btnTeacherCancel" class="btn btn-sm">Avbryt</button>
        <button id="btnTeacherConfirm" class="btn btn-sm btn-primary">Forts√§tt</button>
      </div>
    </div>
  </div>

  <!-- L√§rarl√§ge ‚Äì Modal -->
  <div id="teacherModal" class="modal-backdrop hidden">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h2>L√§rarl√§ge ‚Äì F√•ngvaktaren</h2>
          <small>Hantera inst√§llningar, fr√•gebank, bildfr√•gor, drag & drop, export och elevprogression.</small>
        </div>
        <button id="btnCloseTeacher" class="btn btn-sm">St√§ng</button>
      </header>

      <div class="modal-body">
        <!-- Flikar -->
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="settings" id="tab-settings">‚öôÔ∏è Inst√§llningar</button>
          <button class="tab-btn" data-tab="questions" id="tab-questions">üÖ∞Ô∏è Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="images" id="tab-images">üñºÔ∏è Bildfr√•gor</button>
          <button class="tab-btn" data-tab="dragdrop" id="tab-dragdrop">üéØ Drag & Drop</button>
          <button class="tab-btn" data-tab="progress" id="tab-progress">üìà Elevprogression</button>
          <button class="tab-btn" data-tab="bank" id="tab-bank">üóÇÔ∏è Fr√•gebank</button>
        </nav>

        <div class="tab-content">
          <!-- Inst√§llningar -->
          <section class="tab-panel" data-panel="settings">
            <div class="settings-grid">
              <div class="card">
                <h3>L√§rarl√∂senord</h3>
                <p>Det l√∂senord du anv√§nder f√∂r att √∂ppna l√§rarl√§get. H√§r kan du byta det.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputOldPassword">Nuvarande l√∂senord</label>
                    <input id="inputOldPassword" class="input" type="password" placeholder="L√§mna tomt om inget satt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPassword">Nytt l√∂senord</label>
                    <input id="inputNewPassword" class="input" type="password" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPasswordRepeat">Upprepa nytt l√∂senord</label>
                    <input id="inputNewPasswordRepeat" class="input" type="password" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnChangeTeacherPassword" class="btn btn-sm">üîê Spara nytt l√∂senord</button>
                </div>
                <p id="passwordStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Google-inloggning & uppladdning (l√§rare)</h3>
                <p>
                  Logga in med ditt Google-konto f√∂r att spara och ladda fr√•gebanker via Firebase.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label">Status</label>
                    <p id="googleStatus" class="mini">‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.</p>
                  </div>
                  <div class="field">
                    <button id="btnGooglePlaceholder" class="btn btn-sm" type="button">
                      üîó Logga in med Google
                    </button>
                  </div>
                  <div class="field">
                    <button id="btnGoogleLogout" class="btn btn-sm hidden" type="button">
                      üö™ Logga ut fr√•n Google
                    </button>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Gr√§ns f√∂r godk√§nt per niv√•</h3>
                <p>Justera procentgr√§ns f√∂r E, C och A. Anv√§nds som riktm√§rke f√∂r ‚ÄùGodk√§nd niv√•‚Äù.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputThresE">Niv√• 1 (E)</label>
                    <input id="inputThresE" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresC">Niv√• 2 (C)</label>
                    <input id="inputThresC" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresA">Niv√• 3 (A)</label>
                    <input id="inputThresA" type="number" min="0" max="100" class="input-number" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveThresholds" class="btn btn-sm btn-primary">üíæ Spara niv√•-gr√§nser</button>
                </div>
              </div>

              <div class="card">
                <h3>L√§rarens e-post</h3>
                <p>
                  Anv√§nds som mottagare n√§r eleven l√§mnar in resultat via e-post
                  (‚ÄùSkapa e-post‚Äù p√• Elevresultat/JSON).
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputTeacherEmail">E-postadress</label>
                    <input id="inputTeacherEmail" class="input" placeholder="namn@skola.se" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveTeacherEmail" class="btn btn-sm">üíæ Spara e-postadress</button>
                </div>
                <p id="teacherEmailStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Elevdata p√• denna enhet</h3>
                <p class="mini">
                  Dessa knappar p√•verkar bara den h√§r datorn/surfplattan. Anv√§nd dem n√§r du vill nollst√§lla progression lokalt.
                </p>
                <div class="card-row" style="margin-top:6px;gap:8px;flex-wrap:wrap;">
                  <button id="btnClearStudentData" class="btn btn-sm btn-danger" type="button">
                    üßπ Rensa elev + progression
                  </button>
                  <button id="btnResetGameData" class="btn btn-sm" type="button">
                    ‚ôªÔ∏è Nollst√§ll spelpo√§ng
                  </button>
                </div>
                <p id="resetStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Koppling: delm√•l & delbitar</h3>
                <p>
                  Skriv ett delm√•l och en delbit i taget. Klicka p√• ‚ÄùL√§gg till delbit‚Äù
                  f√∂r att l√§gga till i listan. ‚ÄùSpara‚Äù skriver listan till spelets minne
                  (localStorage). ‚ÄùTa bort alla‚Äù rensar listan.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputGoalSingle">Delm√•l</label>
                    <input id="inputGoalSingle" class="input" placeholder="t.ex. Delm√•l 5 ‚Äì Hygien i k√∂ket" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputPartSingle">Delbit</label>
                    <input id="inputPartSingle" class="input" placeholder="t.ex. 51‚Äì60 eller 51,52,53" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnAddGoalPart" class="btn btn-sm">‚ûï L√§gg till delbit</button>
                </div>
                <p id="goalsStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card card-full-width">
                <h3>Aktuella delm√•l och delbitar</h3>
                <p class="mini">Nedan visas de delm√•l och delbitar som √§r sparade i spelet just nu.</p>
                <ul id="goalsList" class="goals-list"></ul>
              </div>
            </div>
          </section>

          <!-- Flervalsfr√•gor -->
          <section class="tab-panel hidden" data-panel="questions">
            <div class="questions-editor">
              <h3>Hantera flervalsfr√•gor (MCQ)</h3>
              <p class="mini">
                L√§gg till nya flervalsfr√•gor, redigera eller importera m√•nga p√• en g√•ng.
              </p>

              <!-- Kort 1: Snabbimport via text -->
              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Snabbimport av flervalsfr√•gor</h3>
                <p class="mini">
                  Klistra in fr√•gor i formatet nedan. En asterisk (*) framf√∂r r√§tt svar.
                  En tom rad mellan fr√•gorna √§r bra men inte ett krav.
                </p>
                <pre class="mini" style="background:#020617;border-radius:6px;padding:8px;margin-top:4px;white-space:pre-wrap;">
Vilken av dessa √§r en proteink√§lla?
*Kycklingfil√©
√Ñpple
Gurka
P√§ron

Vilken av dessa √§r en frukt?
√Ñpple
*P√§ron
Potatis
Gurka
                </pre>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqJsonLevel">Niv√•</label>
                    <select id="mcqJsonLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqJsonGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqJsonGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <textarea
                  id="mcqJsonInput"
                  class="input"
                  rows="8"
                  placeholder="Klistra in dina fr√•gor h√§r..."
                  style="margin-top:8px;font-family:monospace;border-radius:6px;"
                ></textarea>
                <div style="margin-top:8px;display:flex;justify-content:flex-end;">
                  <button id="btnMcqJsonImport" class="btn btn-sm btn-primary" type="button">
                    üì• Importera fr√•gor fr√•n text
                  </button>
                </div>
              </div>

              <!-- Kort 2: L√§gg till / redigera fr√•ga -->
              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqLevel">Niv√•</label>
                    <select id="mcqLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqQuestion">Fr√•getext</label>
                    <input id="mcqQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <!-- EXAKT 4 alternativ: radio + textruta -->
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="mcqCorrect"
                        value="0"
                        id="mcqCorrect0"
                        style="margin-right:4px;"
                      />
                      Alternativ 1
                    </label>
                    <input id="mcqOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="mcqCorrect"
                        value="1"
                        id="mcqCorrect1"
                        style="margin-right:4px;"
                      />
                      Alternativ 2
                    </label>
                    <input id="mcqOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="mcqCorrect"
                        value="2"
                        id="mcqCorrect2"
                        style="margin-right:4px;"
                      />
                      Alternativ 3
                    </label>
                    <input id="mcqOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="mcqCorrect"
                        value="3"
                        id="mcqCorrect3"
                        style="margin-right:4px;"
                      />
                      Alternativ 4
                    </label>
                    <input id="mcqOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="mcqAnswer">Korrekt svar (Index)</label>
                    <input id="mcqAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnMcqAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till fr√•ga</button>
                    <button id="btnMcqUpdate" class="btn btn-sm hidden" type="button">üíæ Spara √§ndring</button>
                  </div>
                  <button id="btnMcqClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <!-- Kort 3: Lista befintliga fr√•gor -->
              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella flervalsfr√•gor (<span id="mcqCount">0</span> st)</h3>
                <ul id="mcqList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Bildfr√•gor -->
          <section class="tab-panel hidden" data-panel="images">
            <div class="questions-editor">
              <h3>Hantera bildfr√•gor (IMG)</h3>
              <p class="mini">L√§gg till fr√•gor d√§r en bild visas tillsammans med flervalsalternativ.</p>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera bildfr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgLevel">Niv√•</label>
                    <select id="imgLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgQuestion">Fr√•getext</label>
                    <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgFile">Bildfil</label>
                    <input id="imgFile" type="file" accept="image/*" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">F√∂rhandsvisning</label>
                    <div id="imgPreview" class="img-preview-box mini">Ingen bild vald √§nnu.</div>
                  </div>
                </div>

                <!-- EXAKT 4 alternativ: radio + textruta -->
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="imgCorrect"
                        value="0"
                        id="imgCorrect0"
                        style="margin-right:4px;"
                      />
                      Alternativ 1
                    </label>
                    <input id="imgOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="imgCorrect"
                        value="1"
                        id="imgCorrect1"
                        style="margin-right:4px;"
                      />
                      Alternativ 2
                    </label>
                    <input id="imgOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="imgCorrect"
                        value="2"
                        id="imgCorrect2"
                        style="margin-right:4px;"
                      />
                      Alternativ 3
                    </label>
                    <input id="imgOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="imgCorrect"
                        value="3"
                        id="imgCorrect3"
                        style="margin-right:4px;"
                      />
                      Alternativ 4
                    </label>
                    <input id="imgOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="imgAnswer">Korrekt svar (Index)</label>
                    <input id="imgAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="imgGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnImgAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till bildfr√•ga</button>
                  </div>
                  <button id="btnImgClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
                <ul id="imgList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Drag & Drop (komprimerad bygg-ruta) -->
          <section class="tab-panel hidden" data-panel="dragdrop">
            <div class="questions-editor">
              <h3>Hantera Drag &amp; Drop-fr√•gor</h3>
              <p class="mini">Skapa korta fr√•gor d√§r eleverna drar ord/begrepp till r√§tt kolumn.</p>

              <div class="card" style="margin-top:10px;max-width:720px;margin-left:auto;margin-right:auto;padding:10px;">
                <h4>Bygg fr√•ga (kompakt)</h4>
                <div class="card-row" style="margin-top:6px;">
                  <div class="field" style="flex:0 0 90px;">
                    <label class="small-label" for="dragLevel">Niv√•</label>
                    <select id="dragLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragQuestion">Instruktion</label>
                    <input id="dragQuestion" class="input" placeholder="Ex: Dra r√§tt livsmedel till 'Kylvara'." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragColumn1">Kolumn 1</label>
                    <input id="dragColumn1" class="input" placeholder="t.ex. Kylvara" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragColumn2">Kolumn 2</label>
                    <input id="dragColumn2" class="input" placeholder="t.ex. Torrvara" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragItemText">Objekt att dra</label>
                    <input id="dragItemText" class="input" placeholder="t.ex. 'R√• kyckling'" />
                  </div>
                  <div class="field" style="flex:0 0 140px;">
                    <label class="small-label" for="dragItemCorrect">Korrekt kolumn</label>
                    <select id="dragItemCorrect" class="input">
                      <option value="0">Kolumn 1</option>
                      <option value="1">Kolumn 2</option>
                    </select>
                  </div>
                  <div class="field" style="flex:0 0 110px;">
                    <label class="small-label">&nbsp;</label>
                    <button id="btnDragAddItem" class="btn btn-sm btn-primary" type="button" style="width:100%;">‚ûï L√§gg till</button>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label">Objekt i denna fr√•ga</label>
                    <ul id="dragItemsPreview" class="question-list"></ul>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="dragGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;justify-content:space-between;">
                  <div>
                    <button id="btnDragAddQuestion" class="btn btn-sm btn-primary" type="button">üíæ Spara fr√•ga</button>
                  </div>
                  <button id="btnDragClearForm" class="btn btn-sm btn-secondary" type="button">
                    Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:10px;">
                <h3>Aktuella Drag &amp; Drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
                <ul id="dragList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Elevprogression ‚Äì 4 rutor -->
          <section class="tab-panel hidden" data-panel="progress">
            <div class="card">
              <h3>Elevprogression</h3>
              <p class="mini">
                H√§r kan du sammanfatta vad eleven √§r stark p√•, vad som beh√∂ver √∂vas och exportera en JSON-text till elevkortet.
              </p>

              <div class="progress-grid">
                <div class="progress-box" id="progressPointsBox">
                  <h4>Elevens po√§ng (lokalt)</h4>
                  <p id="progressPointsText" class="mini">
                    Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.
                  </p>
                </div>

                <div class="progress-box" id="progressStrongBox">
                  <h4>Starka delbitar</h4>
                  <ul id="progressStrongList" class="goals-list mini">
                    <li>Inga starka delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressWeakBox">
                  <h4>Delbitar att √∂va p√•</h4>
                  <ul id="progressWeakList" class="goals-list mini">
                    <li>Inga svaga delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressExportBox">
                  <h4>Export till elevkort (JSON)</h4>
                  <p class="mini">
                    N√§r du √§r n√∂jd med en elevs progression kan du skapa en JSON-str√§ng som klistras in i elevkortet.
                  </p>
                  <textarea
                    id="progressExportJson"
                    class="input"
                    rows="4"
                    readonly
                    style="font-family:monospace;font-size:0.8rem;border-radius:6px;"
                  ></textarea>
                  <div style="margin-top:6px;display:flex;gap:8px;justify-content:flex-end;">
                    <button id="btnGenerateProgressJson" class="btn btn-sm" type="button">üîÅ Skapa JSON</button>
                    <button id="btnCopyProgressJson" class="btn btn-sm btn-primary" type="button">üìã Kopiera kod</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Fr√•gebank / Firebase -->
          <section class="tab-panel hidden" data-panel="bank">
            <div class="settings-grid">
              <div class="card">
                <h3>Ladda fr√•gebank fr√•n molnet (Firebase)</h3>
                <p class="mini">
                  Visar bankar som har sparats p√• ditt Google-konto. Aktivera bankarna nedan f√∂r att l√§gga till fr√•gorna i spelet.
                </p>
                <p id="cloudBankStatus" class="mini" style="margin-top:4px;"></p>
                <ul id="cloudBankList" class="goals-list" style="margin-top:10px;"></ul>
                <div style="margin-top:10px;">
                  <button id="btnLoadCloudBanks" class="btn btn-sm" type="button">‚òÅÔ∏è Ladda moln-bankar</button>
                </div>
              </div>

              <div class="card">
                <h3>Spara aktuell fr√•gebank till molnet</h3>
                <p class="mini">
                  Namnge din fr√•gebank. Sparar *alla* fr√•gor du skapat i flervals-, bild- och drag/drop-flikarna.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="inputBankName">Namn p√• fr√•gebank</label>
                    <input id="inputBankName" class="input" placeholder="T.ex. Livsmedel HT25" />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <button id="btnSaveToCloud" class="btn btn-sm btn-primary" type="button">üíæ Spara bank till molnet</button>
                </div>
              </div>

              <div class="card card-full-width">
                <h3>Export / Import av fr√•gebank (JSON)</h3>
                <p class="mini">
                  Exportera hela din nuvarande fr√•gebank som en JSON-fil (s√§kerhetskopia) eller importera en befintlig bank fr√•n fil.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <button id="btnExportBank" class="btn btn-sm" type="button">‚¨áÔ∏è Exportera till JSON</button>
                  <label class="btn btn-sm" for="fileImport">‚¨ÜÔ∏è Importera fr√•n JSON</label>
                  <input type="file" id="fileImport" accept=".json" style="display:none;" />
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
</body>
<!-- slut SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->






<!-- start SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker & editorer) -->

<!-- start SEKTION 3A: BAS, STATE, HJ√ÑLPARE, FIREBASE, AUTH & AUTOLOAD (?bank=) -->
<script>
"use strict";

/* =========================
   Globala variabler som SEKTION 4 f√∂rv√§ntar sig
   ========================= */
window.currentLevel = window.currentLevel || null;
window.currentQuestions = window.currentQuestions || [];
window.currentAnswers = window.currentAnswers || [];
window.lastSubmission = window.lastSubmission || null;

/* =========================
   Firebase-konfiguration (v8)
   ========================= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
  authDomain: "fangvaktaren-904db.firebaseapp.com",
  projectId: "fangvaktaren-904db.firebaseapp.com".includes("firebaseapp.com") ? "fangvaktaren-904db" : "fangvaktaren-904db",
  storageBucket: "fangvaktaren-904db.firebasestorage.app",
  messagingSenderId: "105301219768",
  appId: "1:105301219768:web:66b131fba86a541b78174d",
  measurementId: "G-NXL9GSFZ77"
};

const STORAGE_KEY = "fangvaktaren-v17";
const CLOUD_ROOT_COLLECTION = "teachers";
const CLOUD_BANKS_SUBCOLLECTION = "banks";

/* =========================
   Sm√• hj√§lpare
   ========================= */
function safeJsonParse(txt){ try { return JSON.parse(txt); } catch(_){ return null; } }
function clampInt(n, a, b){ const x = parseInt(n,10); if(isNaN(x)) return a; return Math.max(a, Math.min(b, x)); }
function getQueryParam(key){
  try { return new URL(window.location.href).searchParams.get(key); } catch(_) { return null; }
}
function shuffle(arr){
  const a = Array.isArray(arr) ? arr.slice() : [];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* =========================
   State: load/save
   ========================= */
function defaultState(){
  return {
    version: "v17",
    student: { name:"", klass:"" },
    teacherEmail: "",
    teacherPassword: "",
    bankName: "",
    bank: { mcq:[], img:[], drag:[] },
    goalsMap: [],
    thres: { E:70, C:70, A:70 },
    unlocked: { C:false, A:false },
    best: { E:0, C:0, A:0 },
    highscores: [],
    progression: { totalPoints:0, wrongByGoalId:{}, correctByGoalId:{}, lastResult:null },
    activeCloudBankId: null,
    activeSharedBankId: null,
    linkedSharedBankId: "",
    lastLinkedSharedSource: ""
  };
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  const parsed = raw ? safeJsonParse(raw) : null;
  const base = defaultState();
  const s = (parsed && typeof parsed === "object") ? parsed : {};

  const out = Object.assign({}, base, s);
  out.student = Object.assign({}, base.student, s.student||{});
  out.bank = Object.assign({}, base.bank, s.bank||{});
  out.thres = Object.assign({}, base.thres, s.thres||{});
  out.unlocked = Object.assign({}, base.unlocked, s.unlocked||{});
  out.best = Object.assign({}, base.best, s.best||{});
  out.progression = Object.assign({}, base.progression, s.progression||{});

  if(!Array.isArray(out.bank.mcq)) out.bank.mcq = [];
  if(!Array.isArray(out.bank.img)) out.bank.img = [];
  if(!Array.isArray(out.bank.drag)) out.bank.drag = [];
  if(!Array.isArray(out.goalsMap)) out.goalsMap = [];
  if(!Array.isArray(out.highscores)) out.highscores = [];
  if(!out.progression.wrongByGoalId || typeof out.progression.wrongByGoalId !== "object") out.progression.wrongByGoalId = {};
  if(!out.progression.correctByGoalId || typeof out.progression.correctByGoalId !== "object") out.progression.correctByGoalId = {};

  return out;
}

function saveState(s){
  const st = (s && typeof s === "object") ? s : defaultState();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
  return st;
}

/* =========================
   Mappa fr√•ga -> delbit/delm√•l
   (SEKTION 4 anropar getLinksForQuestion)
   ========================= */
function getLinksForQuestion(q, goals){
  const links = [];
  if(!q) return links;

  const direct =
    q.goalId ?? q.goalPartId ?? q.goalPart ?? q.linkId ?? q.delbitId ?? q.delbit ?? null;

  if(direct != null && String(direct).trim() !== ""){
    links.push({ id: String(direct).trim() });
    return links;
  }

  if(q.goal != null){
    const g = String(q.goal).trim();
    if(g && /^[0-9]+$/.test(g)) {
      links.push({ id: g });
      return links;
    }
  }

  const gm = Array.isArray(goals) ? goals : (Array.isArray(loadState().goalsMap) ? loadState().goalsMap : []);
  const goalTxt = (q.goal || "").toString().trim().toLowerCase();
  const partTxt = (q.parts || q.part || "").toString().trim().toLowerCase();

  if(goalTxt || partTxt){
    const hit = gm.find((x) => {
      const a = (x.goal||"").toString().trim().toLowerCase();
      const b = (x.parts||"").toString().trim().toLowerCase();
      if(goalTxt && partTxt) return a===goalTxt && b===partTxt;
      if(goalTxt) return a===goalTxt;
      return false;
    });
    if(hit && hit.id != null) links.push({ id: String(hit.id) });
  }

  return links;
}

/* =========================
   Firestore-s√§ker payload
   ========================= */
function sanitizeForFirestore(obj){
  const seen = new WeakSet();
  function walk(x){
    if(x === null) return null;
    const t = typeof x;
    if(t === "string" || t === "number" || t === "boolean") return x;
    if(t === "undefined" || t === "function") return null;
    if(x instanceof Date) return x;
    if(Array.isArray(x)) return x.map(walk).filter(v => v !== null);
    if(t === "object"){
      if(seen.has(x)) return null;
      seen.add(x);
      const out = {};
      Object.keys(x).forEach((k)=>{
        const v = walk(x[k]);
        if(v !== null) out[k] = v;
      });
      return out;
    }
    return null;
  }
  return walk(obj);
}

/* =========================
   Firebase init + auth helpers
   ========================= */
window.firebaseAppInstance = window.firebaseAppInstance || null;
window.firebaseAuthInstance = window.firebaseAuthInstance || null;
window.firebaseDbInstance = window.firebaseDbInstance || null;
window.currentTeacherUser = window.currentTeacherUser || null;

function initFirebase(){
  if(window.__fvFirebaseInited) return;
  window.__fvFirebaseInited = true;

  if(!window.firebase || !firebase.initializeApp){
    console.warn("Firebase-bibliotek saknas.");
    return;
  }

  try {
    window.firebaseAppInstance = firebase.apps && firebase.apps.length
      ? firebase.apps[0]
      : firebase.initializeApp(FIREBASE_CONFIG);

    window.firebaseAuthInstance = firebase.auth();
    window.firebaseDbInstance = firebase.firestore();

    if(window.firebaseAuthInstance && typeof window.firebaseAuthInstance.onAuthStateChanged === "function"){
      window.firebaseAuthInstance.onAuthStateChanged((user)=>{
        window.currentTeacherUser = user || null;
        try { if(typeof window.fvRefreshCloudBanks === "function") window.fvRefreshCloudBanks(); } catch(_){}
      });
    }
  } catch(e){
    console.error("initFirebase fel:", e);
  }
}

async function handleGoogleLogin(){
  if(!window.firebaseAuthInstance){
    alert("Firebase √§r inte redo.");
    return;
  }
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await window.firebaseAuthInstance.signInWithPopup(provider);
  } catch(e){
    console.error("Google login fel:", e);
    alert("Kunde inte logga in med Google. Se konsolen.");
  }
}

async function handleGoogleLogout(){
  if(!window.firebaseAuthInstance) return;
  try{
    await window.firebaseAuthInstance.signOut();
  } catch(e){
    console.error("Google logout fel:", e);
  }
}

/* =========================
   Embedded bank (om du har en s√•dan i filen)
   ========================= */
function mergeEmbeddedBank(state){
  const s = state || loadState();
  const embedded = window.EMBEDDED_BANK || window.embeddedBank || null;
  if(!embedded || typeof embedded !== "object") return s;

  const hasLocal =
    (s.bank && (
      (Array.isArray(s.bank.mcq) && s.bank.mcq.length) ||
      (Array.isArray(s.bank.img) && s.bank.img.length) ||
      (Array.isArray(s.bank.drag) && s.bank.drag.length)
    ));

  if(hasLocal) return s;

  const next = Object.assign({}, s);
  next.bank = Object.assign({ mcq:[], img:[], drag:[] }, embedded.bank || embedded);
  if(Array.isArray(embedded.goalsMap)) next.goalsMap = embedded.goalsMap;
  if(embedded.bankName) next.bankName = embedded.bankName;
  return next;
}

/* =========================
   Auto-load fr√•n publicerad elevl√§nk: ?bank=ID
   - L√§ser sharedBanks/{ID} och laddar bank + goalsMap
   ========================= */
async function autoLoadSharedBank(){
  const id = getQueryParam("bank") || getQueryParam("sharedBank") || getQueryParam("sb");
  const sharedId = (id || "").trim();
  if(!sharedId) return;

  initFirebase();
  const db = window.firebaseDbInstance || (window.firebase && firebase.firestore ? firebase.firestore() : null);
  if(!db) return;

  try{
    const doc = await db.collection("sharedBanks").doc(sharedId).get();
    if(!doc.exists){
      console.warn("sharedBanks saknar:", sharedId);
      return;
    }
    const data = doc.data() || {};
    const bank = data.bank || { mcq:[], img:[], drag:[] };
    const goalsMap = Array.isArray(data.goalsMap) ? data.goalsMap : null;

    const s = loadState();
    s.bank = bank;
    if(goalsMap) s.goalsMap = goalsMap;
    s.activeSharedBankId = sharedId;
    s.linkedSharedBankId = sharedId;
    s.lastLinkedSharedSource = "URL";
    window.activeSharedBankId = sharedId;
    window.activeSharedBankName = data.name || "";
    saveState(s);

    try { if(typeof updateBankStatusUI === "function") updateBankStatusUI(); } catch(_){}
    try { if(typeof syncUI === "function") syncUI(); } catch(_){}
    try { if(typeof initGoalsMap === "function") initGoalsMap(); } catch(_){}
  } catch(e){
    console.warn("autoLoadSharedBank fel:", e);
  }
}

/* Exponera funktioner som SEKTION 5 anv√§nder */
window.initFirebase = initFirebase;
window.handleGoogleLogin = handleGoogleLogin;
window.handleGoogleLogout = handleGoogleLogout;
window.loadState = loadState;
window.saveState = saveState;
window.mergeEmbeddedBank = mergeEmbeddedBank;
window.shuffle = shuffle;
window.getLinksForQuestion = getLinksForQuestion;
window.sanitizeForFirestore = sanitizeForFirestore;
window.getQueryParam = window.getQueryParam || getQueryParam;
window.autoLoadSharedBank = autoLoadSharedBank;

document.addEventListener("DOMContentLoaded", function(){
  initFirebase();
  try {
    const s0 = loadState();
    const s1 = mergeEmbeddedBank(s0);
    if(s1 !== s0) saveState(s1);
  } catch(_){}
  autoLoadSharedBank();
});
</script>
<!-- slut SEKTION 3A: BAS, STATE, HJ√ÑLPARE, FIREBASE, AUTH & AUTOLOAD (?bank=) -->





<!-- start SEKTION 3B: L√ÑRARVERKTYG (delm√•l/delbitar, fr√•geeditorer, bank export/import, moln-bankar, Google-login) -->
<script>
"use strict";

/* =========================
   3B.1 ‚Äì Sm√• hj√§lpare
   ========================= */

function _fvNowIso(){
  try { return new Date().toISOString(); } catch(_){ return ""; }
}
function _fvSafeText(v){
  return (v == null ? "" : String(v)).replace(/\s+/g," ").trim();
}
function _fvEl(id){ return document.getElementById(id); }
function _fvAlert(msg){ alert(msg); }

function _fvEnsureStateShape(s){
  s = s || {};
  if (!s.bank) s.bank = { mcq: [], img: [], drag: [] };
  if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
  if (!Array.isArray(s.bank.img)) s.bank.img = [];
  if (!Array.isArray(s.bank.drag)) s.bank.drag = [];
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];
  if (!s.thres || typeof s.thres !== "object") s.thres = { E: 70, C: 70, A: 70 };
  if (!s.unlocked) s.unlocked = { C: false, A: false };
  if (!s.best) s.best = { E: 0, C: 0, A: 0 };
  if (!s.progression) s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  return s;
}

function _fvIsAuthed(){
  return !!(typeof firebaseAuthInstance !== "undefined" && firebaseAuthInstance && firebaseAuthInstance.currentUser);
}

function _fvUser(){
  return (firebaseAuthInstance && firebaseAuthInstance.currentUser) ? firebaseAuthInstance.currentUser : null;
}

function _fvSetMini(elId, txt){
  const el = _fvEl(elId);
  if (el) el.textContent = txt || "";
}

function _fvBaseUrl(){
  // h√•ller kvar din github-pages-basutg√•ng (utan query)
  try{
    const u = new URL(window.location.href);
    u.search = "";
    u.hash = "";
    return u.toString().replace(/\/$/, "");
  }catch(_){
    return (window.location.origin || "") + (window.location.pathname || "");
  }
}

/* =========================
   3B.2 ‚Äì Delm√•l & delbitar (goalsMap)
   ========================= */

function _fvGoalsListLabel(item){
  const g = _fvSafeText(item.goal || item.goalTitle || item.delmal || item.delm√•l || "");
  const p = _fvSafeText(item.parts || item.part || item.partText || item.text || "");
  const id = _fvSafeText(item.id || "");
  const left = g || "(saknar delm√•l)";
  const right = p || "(saknar delbit)";
  return { id, goal: left, part: right };
}

function _fvRenderGoalsList(){
  const list = _fvEl("goalsList");
  if (!list) return;

  const s = _fvEnsureStateShape(loadState());
  const gm = Array.isArray(s.goalsMap) ? s.goalsMap.slice() : [];
  list.innerHTML = "";

  if (!gm.length){
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga delm√•l/delbitar sparade √§nnu.";
    list.appendChild(li);
    return;
  }

  // Visning: en ruta per delm√•l+delbit (som du bad om)
  gm.forEach((item) => {
    const { id, goal, part } = _fvGoalsListLabel(item);

    const li = document.createElement("li");
    li.style.border = "1px solid #1f2937";
    li.style.borderRadius = "10px";
    li.style.padding = "10px";
    li.style.display = "flex";
    li.style.alignItems = "center";
    li.style.justifyContent = "space-between";
    li.style.gap = "10px";

    const textWrap = document.createElement("div");
    textWrap.style.display = "flex";
    textWrap.style.flexDirection = "column";
    textWrap.style.gap = "4px";

    const h = document.createElement("div");
    h.style.fontWeight = "700";
    h.textContent = goal;

    const sub = document.createElement("div");
    sub.className = "mini";
    sub.textContent = part;

    textWrap.appendChild(h);
    textWrap.appendChild(sub);

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn btn-sm btn-danger";
    btn.textContent = "üóëÔ∏è";
    btn.title = "Ta bort";
    btn.addEventListener("click", () => {
      const s2 = _fvEnsureStateShape(loadState());
      s2.goalsMap = (Array.isArray(s2.goalsMap) ? s2.goalsMap : []).filter((x) => String(x.id) !== String(id));
      saveState(s2);
      _fvRenderGoalsList();
      _fvPopulateGoalSelects();
      _fvSetMini("goalsStatus", "Delbit borttagen.");
    });

    li.appendChild(textWrap);
    li.appendChild(btn);
    list.appendChild(li);
  });
}

function _fvPopulateGoalSelects(){
  const s = _fvEnsureStateShape(loadState());
  const gm = Array.isArray(s.goalsMap) ? s.goalsMap.slice() : [];

  const targets = ["mcqGoalPart","imgGoalPart","dragGoalPart","mcqJsonGoalPart"];
  targets.forEach((id) => {
    const sel = _fvEl(id);
    if (!sel) return;
    const cur = sel.value || "";
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Ingen koppling";
    sel.appendChild(opt0);

    gm.forEach((item) => {
      const { id: gid, goal, part } = _fvGoalsListLabel(item);
      const opt = document.createElement("option");
      opt.value = String(gid);
      opt.textContent = `${goal} ‚Äì ${part}`;
      sel.appendChild(opt);
    });

    // √•terst√§ll om m√∂jligt
    if (cur) sel.value = cur;
  });
}

function initGoalsMap(){
  const s = _fvEnsureStateShape(loadState());
  saveState(s);

  _fvRenderGoalsList();
  _fvPopulateGoalSelects();

  _fvSetMini("goalsStatus", "");
}

function handleAddGoalPart(){
  const goalEl = _fvEl("inputGoalSingle");
  const partEl = _fvEl("inputPartSingle");
  const goal = _fvSafeText(goalEl ? goalEl.value : "");
  const part = _fvSafeText(partEl ? partEl.value : "");

  if (!goal || !part){
    _fvSetMini("goalsStatus", "Fyll i b√•de delm√•l och delbit.");
    return;
  }

  const s = _fvEnsureStateShape(loadState());
  const id = String(Date.now()) + String(Math.floor(Math.random()*1000)).padStart(3,"0");

  s.goalsMap.push({
    id,
    goal,
    parts: part
  });

  saveState(s);

  if (goalEl) goalEl.value = "";
  if (partEl) partEl.value = "";

  _fvRenderGoalsList();
  _fvPopulateGoalSelects();
  _fvSetMini("goalsStatus", "Delm√•l/delbit tillagd.");
}

function handleSaveGoalsMap(){
  // i denna version sparas direkt i handleAddGoalPart, men beh√•ller knappen
  const s = _fvEnsureStateShape(loadState());
  saveState(s);
  _fvRenderGoalsList();
  _fvPopulateGoalSelects();
  _fvSetMini("goalsStatus", "Sparat.");
}

function handleClearGoalsMap(){
  if (!confirm("Ta bort alla delm√•l/delbitar i listan?")) return;
  const s = _fvEnsureStateShape(loadState());
  s.goalsMap = [];
  saveState(s);
  _fvRenderGoalsList();
  _fvPopulateGoalSelects();
  _fvSetMini("goalsStatus", "Listan rensad.");
}

/* =========================
   3B.3 ‚Äì Fr√•geeditor: MCQ
   ========================= */

let _fvMcqEditingIndex = -1;

function _fvMcqGetForm(){
  const level = _fvEl("mcqLevel") ? _fvEl("mcqLevel").value : "E";
  const qText = _fvSafeText(_fvEl("mcqQuestion") ? _fvEl("mcqQuestion").value : "");
  const opts = [];
  for (let i=0;i<4;i++){
    opts.push(_fvSafeText(_fvEl("mcqOption"+i) ? _fvEl("mcqOption"+i).value : ""));
  }
  const ans = _fvEl("mcqAnswer") ? parseInt(_fvEl("mcqAnswer").value, 10) : NaN;

  const sel = _fvEl("mcqGoalPart");
  const goalPartId = sel ? _fvSafeText(sel.value) : "";

  return { level, qText, opts, ans, goalPartId };
}

function _fvMcqClearForm(){
  if (_fvEl("mcqLevel")) _fvEl("mcqLevel").value = "E";
  if (_fvEl("mcqQuestion")) _fvEl("mcqQuestion").value = "";
  for (let i=0;i<4;i++){
    if (_fvEl("mcqOption"+i)) _fvEl("mcqOption"+i).value = "";
    const r = _fvEl("mcqCorrect"+i);
    if (r) r.checked = false;
  }
  if (_fvEl("mcqAnswer")) _fvEl("mcqAnswer").value = "";
  if (_fvEl("mcqGoalPart")) _fvEl("mcqGoalPart").value = "";

  _fvMcqEditingIndex = -1;

  const btnAdd = _fvEl("btnMcqAdd");
  const btnUpd = _fvEl("btnMcqUpdate");
  if (btnAdd) btnAdd.classList.remove("hidden");
  if (btnUpd) btnUpd.classList.add("hidden");
}

function _fvMcqFillForm(q){
  if (_fvEl("mcqLevel")) _fvEl("mcqLevel").value = q.level || "E";
  if (_fvEl("mcqQuestion")) _fvEl("mcqQuestion").value = q.q || q.text || "";
  const options = Array.isArray(q.options) ? q.options : ["","","",""];
  for (let i=0;i<4;i++){
    if (_fvEl("mcqOption"+i)) _fvEl("mcqOption"+i).value = options[i] || "";
    const r = _fvEl("mcqCorrect"+i);
    if (r) r.checked = false;
  }
  const correctIndex = (typeof q.answer === "number") ? q.answer : (typeof q.correct === "number" ? q.correct : 0);
  if (_fvEl("mcqAnswer")) _fvEl("mcqAnswer").value = String(correctIndex);

  const sel = _fvEl("mcqGoalPart");
  const gp = _fvSafeText(q.goalPartId || q.goalId || q.goalPart || q.linkId || q.delbitId || q.delbit || "");
  if (sel) sel.value = gp || "";

  const btnAdd = _fvEl("btnMcqAdd");
  const btnUpd = _fvEl("btnMcqUpdate");
  if (btnAdd) btnAdd.classList.add("hidden");
  if (btnUpd) btnUpd.classList.remove("hidden");
}

function _fvMcqRenderList(){
  const list = _fvEl("mcqList");
  const cnt = _fvEl("mcqCount");
  if (!list) return;

  const s = _fvEnsureStateShape(loadState());
  const arr = Array.isArray(s.bank.mcq) ? s.bank.mcq.slice() : [];

  list.innerHTML = "";
  if (cnt) cnt.textContent = String(arr.length);

  if (!arr.length){
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga flervalsfr√•gor √§nnu.";
    list.appendChild(li);
    return;
  }

  arr.forEach((q, idx) => {
    const li = document.createElement("li");
    li.style.border = "1px solid #1f2937";
    li.style.borderRadius = "10px";
    li.style.padding = "10px";
    li.style.display = "flex";
    li.style.flexDirection = "column";
    li.style.gap = "8px";

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.justifyContent = "space-between";
    top.style.alignItems = "flex-start";
    top.style.gap = "10px";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.flexDirection = "column";
    left.style.gap = "4px";

    const title = document.createElement("div");
    title.style.fontWeight = "700";
    title.textContent = `${q.level || "E"} ‚Äì ${_fvSafeText(q.q || q.text || "")}`;

    const gpId = _fvSafeText(q.goalPartId || q.goalId || q.goalPart || q.linkId || q.delbitId || q.delbit || "");
    let gpLabel = "";
    if (gpId){
      const gm = Array.isArray(s.goalsMap) ? s.goalsMap : [];
      const hit = gm.find((x) => String(x.id) === String(gpId));
      if (hit){
        const L = _fvGoalsListLabel(hit);
        gpLabel = `${L.goal} ‚Äì ${L.part}`;
      } else {
        gpLabel = `Kopplad delbit: ${gpId}`;
      }
    }

    const sub = document.createElement("div");
    sub.className = "mini";
    sub.textContent = gpLabel ? gpLabel : "Ingen delbit-koppling";

    left.appendChild(title);
    left.appendChild(sub);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.flexWrap = "wrap";
    right.style.justifyContent = "flex-end";

    const btnEdit = document.createElement("button");
    btnEdit.type = "button";
    btnEdit.className = "btn btn-sm";
    btnEdit.textContent = "‚úèÔ∏è Redigera";
    btnEdit.addEventListener("click", () => {
      _fvMcqEditingIndex = idx;
      _fvMcqFillForm(q);
    });

    const btnDel = document.createElement("button");
    btnDel.type = "button";
    btnDel.className = "btn btn-sm btn-danger";
    btnDel.textContent = "üóëÔ∏è Ta bort";
    btnDel.addEventListener("click", () => {
      if (!confirm("Ta bort denna fr√•ga?")) return;
      const s2 = _fvEnsureStateShape(loadState());
      s2.bank.mcq.splice(idx, 1);
      saveState(s2);
      _fvMcqRenderList();
      if (typeof updateBankStatusUI === "function") updateBankStatusUI();
    });

    right.appendChild(btnEdit);
    right.appendChild(btnDel);

    top.appendChild(left);
    top.appendChild(right);

    li.appendChild(top);

    const optsWrap = document.createElement("div");
    optsWrap.style.display = "flex";
    optsWrap.style.flexDirection = "column";
    optsWrap.style.gap = "4px";

    const options = Array.isArray(q.options) ? q.options : [];
    const correctIndex = (typeof q.answer === "number") ? q.answer : (typeof q.correct === "number" ? q.correct : -1);

    options.forEach((opt, i) => {
      const row = document.createElement("div");
      row.className = "mini";
      row.textContent = `${i+1}. ${opt || ""}` + (i === correctIndex ? " ‚úÖ" : "");
      optsWrap.appendChild(row);
    });

    li.appendChild(optsWrap);
    list.appendChild(li);
  });
}

function handleMcqAdd(){
  const f = _fvMcqGetForm();
  if (!f.qText) return _fvAlert("Skriv en fr√•getext.");
  if (f.opts.filter((x) => !!x).length < 2) return _fvAlert("Fyll i minst 2 svarsalternativ.");
  if (!(f.ans >= 0 && f.ans <= 3)) return _fvAlert("Ange korrekt svar (0‚Äì3).");

  const s = _fvEnsureStateShape(loadState());

  // h√§mta goal/part text f√∂r visning/robusthet
  let goalTitle = "";
  let partText = "";
  if (f.goalPartId){
    const hit = (Array.isArray(s.goalsMap) ? s.goalsMap : []).find((x) => String(x.id) === String(f.goalPartId));
    if (hit){
      const L = _fvGoalsListLabel(hit);
      goalTitle = L.goal;
      partText = L.part;
    }
  }

  s.bank.mcq.push({
    id: String(Date.now()) + "mcq",
    level: f.level,
    type: "mcq",
    q: f.qText,
    options: f.opts,
    answer: f.ans,
    goalPartId: f.goalPartId || "",
    goalTitle: goalTitle || "",
    partText: partText || ""
  });

  saveState(s);
  _fvMcqClearForm();
  _fvMcqRenderList();
  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
}

function handleMcqUpdate(){
  if (_fvMcqEditingIndex < 0) return;
  const f = _fvMcqGetForm();
  if (!f.qText) return _fvAlert("Skriv en fr√•getext.");
  if (f.opts.filter((x) => !!x).length < 2) return _fvAlert("Fyll i minst 2 svarsalternativ.");
  if (!(f.ans >= 0 && f.ans <= 3)) return _fvAlert("Ange korrekt svar (0‚Äì3).");

  const s = _fvEnsureStateShape(loadState());
  const q = s.bank.mcq[_fvMcqEditingIndex];
  if (!q) return;

  let goalTitle = "";
  let partText = "";
  if (f.goalPartId){
    const hit = (Array.isArray(s.goalsMap) ? s.goalsMap : []).find((x) => String(x.id) === String(f.goalPartId));
    if (hit){
      const L = _fvGoalsListLabel(hit);
      goalTitle = L.goal;
      partText = L.part;
    }
  }

  q.level = f.level;
  q.q = f.qText;
  q.options = f.opts;
  q.answer = f.ans;
  q.goalPartId = f.goalPartId || "";
  q.goalTitle = goalTitle || "";
  q.partText = partText || "";

  saveState(s);
  _fvMcqClearForm();
  _fvMcqRenderList();
  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
}

function _fvParseMcqTextBlock(text){
  // format:
  // Question?
  // *Correct
  // Wrong
  // Wrong
  // Wrong
  // (blank line)
  const raw = (text || "").replace(/\r/g,"").trim();
  if (!raw) return [];
  const blocks = raw.split(/\n\s*\n+/g);
  const out = [];

  blocks.forEach((blk) => {
    const lines = blk.split("\n").map((x)=>x.trim()).filter(Boolean);
    if (lines.length < 5) return; // q + 4 opts
    const qText = lines[0];
    const opts = lines.slice(1,5);
    let answer = 0;

    const cleaned = opts.map((o, i) => {
      if (o.startsWith("*")){
        answer = i;
        return o.slice(1).trim();
      }
      return o;
    });

    out.push({ qText, options: cleaned, answer });
  });

  return out;
}

function handleMcqJsonImport(){
  const levelSel = _fvEl("mcqJsonLevel");
  const gpSel = _fvEl("mcqJsonGoalPart");
  const input = _fvEl("mcqJsonInput");

  const level = levelSel ? levelSel.value : "E";
  const goalPartId = gpSel ? _fvSafeText(gpSel.value) : "";
  const text = input ? input.value : "";

  const parsed = _fvParseMcqTextBlock(text);
  if (!parsed.length){
    _fvAlert("Hittade inga fr√•gor. Kontrollera formatet (fr√•ga + 4 svar).");
    return;
  }

  const s = _fvEnsureStateShape(loadState());

  let goalTitle = "";
  let partText = "";
  if (goalPartId){
    const hit = (Array.isArray(s.goalsMap) ? s.goalsMap : []).find((x) => String(x.id) === String(goalPartId));
    if (hit){
      const L = _fvGoalsListLabel(hit);
      goalTitle = L.goal;
      partText = L.part;
    }
  }

  parsed.forEach((p) => {
    s.bank.mcq.push({
      id: String(Date.now()) + "mcq" + Math.floor(Math.random()*1000),
      level,
      type: "mcq",
      q: p.qText,
      options: p.options,
      answer: p.answer,
      goalPartId: goalPartId || "",
      goalTitle: goalTitle || "",
      partText: partText || ""
    });
  });

  saveState(s);
  if (input) input.value = "";
  _fvMcqRenderList();
  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
}

/* =========================
   3B.4 ‚Äì Bildfr√•gor (IMG)
   ========================= */

let _fvImgEditingIndex = -1;
let _fvImgPendingDataUrl = "";

function _fvImgClearForm(){
  if (_fvEl("imgLevel")) _fvEl("imgLevel").value = "E";
  if (_fvEl("imgQuestion")) _fvEl("imgQuestion").value = "";
  for (let i=0;i<4;i++){
    if (_fvEl("imgOption"+i)) _fvEl("imgOption"+i).value = "";
    const r = _fvEl("imgCorrect"+i);
    if (r) r.checked = false;
  }
  if (_fvEl("imgAnswer")) _fvEl("imgAnswer").value = "";
  if (_fvEl("imgGoalPart")) _fvEl("imgGoalPart").value = "";
  if (_fvEl("imgFile")) _fvEl("imgFile").value = "";
  const pv = _fvEl("imgPreview");
  if (pv) pv.textContent = "Ingen bild vald √§nnu.";
  _fvImgEditingIndex = -1;
  _fvImgPendingDataUrl = "";
}

function _fvImgRenderList(){
  const list = _fvEl("imgList");
  const cnt = _fvEl("imgCount");
  if (!list) return;

  const s = _fvEnsureStateShape(loadState());
  const arr = Array.isArray(s.bank.img) ? s.bank.img.slice() : [];

  list.innerHTML = "";
  if (cnt) cnt.textContent = String(arr.length);

  if (!arr.length){
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga bildfr√•gor √§nnu.";
    list.appendChild(li);
    return;
  }

  arr.forEach((q, idx) => {
    const li = document.createElement("li");
    li.style.border = "1px solid #1f2937";
    li.style.borderRadius = "10px";
    li.style.padding = "10px";
    li.style.display = "flex";
    li.style.flexDirection = "column";
    li.style.gap = "8px";

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.justifyContent = "space-between";
    top.style.alignItems = "flex-start";
    top.style.gap = "10px";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.gap = "10px";
    left.style.alignItems = "flex-start";

    if (q.imgDataUrl){
      const img = document.createElement("img");
      img.src = q.imgDataUrl;
      img.alt = "Miniatyr";
      img.style.width = "72px";
      img.style.height = "72px";
      img.style.objectFit = "cover";
      img.style.borderRadius = "8px";
      img.style.border = "1px solid #1f2937";
      left.appendChild(img);
    }

    const textWrap = document.createElement("div");
    textWrap.style.display = "flex";
    textWrap.style.flexDirection = "column";
    textWrap.style.gap = "4px";

    const title = document.createElement("div");
    title.style.fontWeight = "700";
    title.textContent = `${q.level || "E"} ‚Äì ${_fvSafeText(q.q || q.text || "")}`;

    const gpId = _fvSafeText(q.goalPartId || q.goalId || q.goalPart || q.linkId || q.delbitId || q.delbit || "");
    let gpLabel = "";
    if (gpId){
      const gm = Array.isArray(s.goalsMap) ? s.goalsMap : [];
      const hit = gm.find((x) => String(x.id) === String(gpId));
      if (hit){
        const L = _fvGoalsListLabel(hit);
        gpLabel = `${L.goal} ‚Äì ${L.part}`;
      } else {
        gpLabel = `Kopplad delbit: ${gpId}`;
      }
    }
    const sub = document.createElement("div");
    sub.className = "mini";
    sub.textContent = gpLabel ? gpLabel : "Ingen delbit-koppling";

    textWrap.appendChild(title);
    textWrap.appendChild(sub);

    left.appendChild(textWrap);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.flexWrap = "wrap";
    right.style.justifyContent = "flex-end";

    const btnDel = document.createElement("button");
    btnDel.type = "button";
    btnDel.className = "btn btn-sm btn-danger";
    btnDel.textContent = "üóëÔ∏è Ta bort";
    btnDel.addEventListener("click", () => {
      if (!confirm("Ta bort denna bildfr√•ga?")) return;
      const s2 = _fvEnsureStateShape(loadState());
      s2.bank.img.splice(idx, 1);
      saveState(s2);
      _fvImgRenderList();
      if (typeof updateBankStatusUI === "function") updateBankStatusUI();
    });

    right.appendChild(btnDel);

    top.appendChild(left);
    top.appendChild(right);

    li.appendChild(top);

    const options = Array.isArray(q.options) ? q.options : [];
    const correctIndex = (typeof q.answer === "number") ? q.answer : (typeof q.correct === "number" ? q.correct : -1);

    const optsWrap = document.createElement("div");
    optsWrap.style.display = "flex";
    optsWrap.style.flexDirection = "column";
    optsWrap.style.gap = "4px";

    options.forEach((opt, i) => {
      const row = document.createElement("div");
      row.className = "mini";
      row.textContent = `${i+1}. ${opt || ""}` + (i === correctIndex ? " ‚úÖ" : "");
      optsWrap.appendChild(row);
    });

    li.appendChild(optsWrap);

    list.appendChild(li);
  });
}

function initImageQuestionsEditor(){
  const file = _fvEl("imgFile");
  const pv = _fvEl("imgPreview");
  if (file){
    file.addEventListener("change", () => {
      const f = file.files && file.files[0] ? file.files[0] : null;
      if (!f){
        _fvImgPendingDataUrl = "";
        if (pv) pv.textContent = "Ingen bild vald √§nnu.";
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        _fvImgPendingDataUrl = String(reader.result || "");
        if (pv){
          pv.innerHTML = "";
          const img = document.createElement("img");
          img.src = _fvImgPendingDataUrl;
          img.alt = "F√∂rhandsvisning";
          img.style.maxWidth = "220px";
          img.style.borderRadius = "10px";
          img.style.border = "1px solid #1f2937";
          pv.appendChild(img);
        }
      };
      reader.readAsDataURL(f);
    });
  }

  _fvImgRenderList();
}

function handleImgAdd(){
  const level = _fvEl("imgLevel") ? _fvEl("imgLevel").value : "E";
  const qText = _fvSafeText(_fvEl("imgQuestion") ? _fvEl("imgQuestion").value : "");
  const opts = [];
  for (let i=0;i<4;i++){
    opts.push(_fvSafeText(_fvEl("imgOption"+i) ? _fvEl("imgOption"+i).value : ""));
  }
  const ans = _fvEl("imgAnswer") ? parseInt(_fvEl("imgAnswer").value, 10) : NaN;
  const sel = _fvEl("imgGoalPart");
  const goalPartId = sel ? _fvSafeText(sel.value) : "";

  if (!qText) return _fvAlert("Skriv en fr√•getext.");
  if (!_fvImgPendingDataUrl) return _fvAlert("V√§lj en bild.");
  if (opts.filter((x)=>!!x).length < 2) return _fvAlert("Fyll i minst 2 svarsalternativ.");
  if (!(ans >= 0 && ans <= 3)) return _fvAlert("Ange korrekt svar (0‚Äì3).");

  const s = _fvEnsureStateShape(loadState());

  let goalTitle = "";
  let partText = "";
  if (goalPartId){
    const hit = (Array.isArray(s.goalsMap) ? s.goalsMap : []).find((x)=>String(x.id)===String(goalPartId));
    if (hit){
      const L = _fvGoalsListLabel(hit);
      goalTitle = L.goal;
      partText = L.part;
    }
  }

  s.bank.img.push({
    id: String(Date.now()) + "img",
    level,
    type: "img",
    q: qText,
    imgDataUrl: _fvImgPendingDataUrl,
    options: opts,
    answer: ans,
    goalPartId: goalPartId || "",
    goalTitle: goalTitle || "",
    partText: partText || ""
  });

  saveState(s);
  _fvImgClearForm();
  _fvImgRenderList();
  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
}

/* =========================
   3B.5 ‚Äì Drag & Drop
   ========================= */

let _fvDragDraft = { sources: [], targets: [], correctMap: {} };

function _fvDragResetDraft(){
  _fvDragDraft = { sources: [], targets: [], correctMap: {} };
  const ul = _fvEl("dragItemsPreview");
  if (ul) ul.innerHTML = "";
}

function _fvDragRenderDraft(){
  const ul = _fvEl("dragItemsPreview");
  if (!ul) return;
  ul.innerHTML = "";
  if (!_fvDragDraft.sources.length){
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga objekt tillagda √§nnu.";
    ul.appendChild(li);
    return;
  }
  _fvDragDraft.sources.forEach((src) => {
    const li = document.createElement("li");
    li.style.border = "1px solid #1f2937";
    li.style.borderRadius = "10px";
    li.style.padding = "8px";
    li.style.display = "flex";
    li.style.justifyContent = "space-between";
    li.style.alignItems = "center";
    li.style.gap = "10px";

    const txt = document.createElement("div");
    txt.className = "mini";
    txt.textContent = `${src.label} ‚Üí ${_fvDragDraft.targets[src._correctIndex || 0] ? _fvDragDraft.targets[src._correctIndex || 0].label : ""}`;

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn btn-sm btn-danger";
    btn.textContent = "üóëÔ∏è";
    btn.addEventListener("click", () => {
      _fvDragDraft.sources = _fvDragDraft.sources.filter((x) => x.id !== src.id);
      delete _fvDragDraft.correctMap[src.id];
      _fvDragRenderDraft();
    });

    li.appendChild(txt);
    li.appendChild(btn);
    ul.appendChild(li);
  });
}

function initDragDropQuestionsEditor(){
  _fvDragResetDraft();
  _fvDragRenderDraft();
  _fvDragRenderList();
}

function handleDragAddItem(){
  const txtEl = _fvEl("dragItemText");
  const colEl = _fvEl("dragItemCorrect");
  const t = _fvSafeText(txtEl ? txtEl.value : "");
  const correctIndex = colEl ? parseInt(colEl.value, 10) : 0;

  if (!t) return _fvAlert("Skriv ett objekt att dra.");
  if (!(correctIndex === 0 || correctIndex === 1)) return;

  const col1 = _fvSafeText(_fvEl("dragColumn1") ? _fvEl("dragColumn1").value : "");
  const col2 = _fvSafeText(_fvEl("dragColumn2") ? _fvEl("dragColumn2").value : "");
  if (!col1 || !col2) return _fvAlert("Fyll i b√•da kolumnnamnen f√∂rst.");

  _fvDragDraft.targets = [
    { id: "t1", label: col1 },
    { id: "t2", label: col2 }
  ];

  const id = "i" + String(Date.now()) + String(Math.floor(Math.random()*1000)).padStart(3,"0");
  _fvDragDraft.sources.push({ id, label: t, _correctIndex: correctIndex });
  _fvDragDraft.correctMap[id] = correctIndex === 0 ? "t1" : "t2";

  if (txtEl) txtEl.value = "";
  _fvDragRenderDraft();
}

function handleDragAddQuestion(){
  const level = _fvEl("dragLevel") ? _fvEl("dragLevel").value : "E";
  const instr = _fvSafeText(_fvEl("dragQuestion") ? _fvEl("dragQuestion").value : "");
  const col1 = _fvSafeText(_fvEl("dragColumn1") ? _fvEl("dragColumn1").value : "");
  const col2 = _fvSafeText(_fvEl("dragColumn2") ? _fvEl("dragColumn2").value : "");
  const sel = _fvEl("dragGoalPart");
  const goalPartId = sel ? _fvSafeText(sel.value) : "";

  if (!instr) return _fvAlert("Skriv en instruktion.");
  if (!col1 || !col2) return _fvAlert("Fyll i b√•da kolumnnamnen.");
  if (_fvDragDraft.sources.length < 2) return _fvAlert("L√§gg till minst 2 objekt att dra.");

  const s = _fvEnsureStateShape(loadState());

  let goalTitle = "";
  let partText = "";
  if (goalPartId){
    const hit = (Array.isArray(s.goalsMap) ? s.goalsMap : []).find((x)=>String(x.id)===String(goalPartId));
    if (hit){
      const L = _fvGoalsListLabel(hit);
      goalTitle = L.goal;
      partText = L.part;
    }
  }

  s.bank.drag.push({
    id: String(Date.now()) + "drag",
    level,
    type: "drag",
    q: instr,
    dragSources: _fvDragDraft.sources.map((x)=>({ id: x.id, label: x.label })),
    dragTargets: [
      { id: "t1", label: col1 },
      { id: "t2", label: col2 }
    ],
    correctMap: Object.assign({}, _fvDragDraft.correctMap),
    goalPartId: goalPartId || "",
    goalTitle: goalTitle || "",
    partText: partText || ""
  });

  saveState(s);

  // Rensa formul√§r
  if (_fvEl("dragQuestion")) _fvEl("dragQuestion").value = "";
  if (_fvEl("dragColumn1")) _fvEl("dragColumn1").value = "";
  if (_fvEl("dragColumn2")) _fvEl("dragColumn2").value = "";
  if (_fvEl("dragGoalPart")) _fvEl("dragGoalPart").value = "";

  _fvDragResetDraft();
  _fvDragRenderDraft();
  _fvDragRenderList();
  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
}

function handleDragClearForm(){
  if (_fvEl("dragLevel")) _fvEl("dragLevel").value = "E";
  if (_fvEl("dragQuestion")) _fvEl("dragQuestion").value = "";
  if (_fvEl("dragColumn1")) _fvEl("dragColumn1").value = "";
  if (_fvEl("dragColumn2")) _fvEl("dragColumn2").value = "";
  if (_fvEl("dragItemText")) _fvEl("dragItemText").value = "";
  if (_fvEl("dragItemCorrect")) _fvEl("dragItemCorrect").value = "0";
  if (_fvEl("dragGoalPart")) _fvEl("dragGoalPart").value = "";
  _fvDragResetDraft();
  _fvDragRenderDraft();
}

function _fvDragRenderList(){
  const list = _fvEl("dragList");
  const cnt = _fvEl("dragCount");
  if (!list) return;

  const s = _fvEnsureStateShape(loadState());
  const arr = Array.isArray(s.bank.drag) ? s.bank.drag.slice() : [];

  list.innerHTML = "";
  if (cnt) cnt.textContent = String(arr.length);

  if (!arr.length){
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga drag & drop-fr√•gor √§nnu.";
    list.appendChild(li);
    return;
  }

  arr.forEach((q, idx) => {
    const li = document.createElement("li");
    li.style.border = "1px solid #1f2937";
    li.style.borderRadius = "10px";
    li.style.padding = "10px";
    li.style.display = "flex";
    li.style.flexDirection = "column";
    li.style.gap = "8px";

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.justifyContent = "space-between";
    top.style.alignItems = "flex-start";
    top.style.gap = "10px";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.flexDirection = "column";
    left.style.gap = "4px";

    const title = document.createElement("div");
    title.style.fontWeight = "700";
    title.textContent = `${q.level || "E"} ‚Äì ${_fvSafeText(q.q || "")}`;

    const gpId = _fvSafeText(q.goalPartId || "");
    let gpLabel = "";
    if (gpId){
      const gm = Array.isArray(s.goalsMap) ? s.goalsMap : [];
      const hit = gm.find((x) => String(x.id) === String(gpId));
      if (hit){
        const L = _fvGoalsListLabel(hit);
        gpLabel = `${L.goal} ‚Äì ${L.part}`;
      } else {
        gpLabel = `Kopplad delbit: ${gpId}`;
      }
    }
    const sub = document.createElement("div");
    sub.className = "mini";
    sub.textContent = gpLabel ? gpLabel : "Ingen delbit-koppling";

    left.appendChild(title);
    left.appendChild(sub);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.flexWrap = "wrap";
    right.style.justifyContent = "flex-end";

    const btnDel = document.createElement("button");
    btnDel.type = "button";
    btnDel.className = "btn btn-sm btn-danger";
    btnDel.textContent = "üóëÔ∏è Ta bort";
    btnDel.addEventListener("click", () => {
      if (!confirm("Ta bort denna drag & drop-fr√•ga?")) return;
      const s2 = _fvEnsureStateShape(loadState());
      s2.bank.drag.splice(idx, 1);
      saveState(s2);
      _fvDragRenderList();
      if (typeof updateBankStatusUI === "function") updateBankStatusUI();
    });

    right.appendChild(btnDel);

    top.appendChild(left);
    top.appendChild(right);

    li.appendChild(top);

    const mini = document.createElement("div");
    mini.className = "mini";
    const t1 = (q.dragTargets && q.dragTargets[0]) ? q.dragTargets[0].label : "Kolumn 1";
    const t2 = (q.dragTargets && q.dragTargets[1]) ? q.dragTargets[1].label : "Kolumn 2";
    const n = Array.isArray(q.dragSources) ? q.dragSources.length : 0;
    mini.textContent = `Kolumner: "${t1}" / "${t2}" ‚Äì objekt: ${n} st`;
    li.appendChild(mini);

    list.appendChild(li);
  });
}

/* =========================
   3B.6 ‚Äì Fr√•gebank: export / import
   ========================= */

function handleExportBank(){
  const s = _fvEnsureStateShape(loadState());
  const payload = {
    exportedAt: _fvNowIso(),
    bank: s.bank,
    goalsMap: s.goalsMap,
    thres: s.thres
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "fangvaktaren-bank.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function handleImportBank(evt){
  const file = evt && evt.target && evt.target.files && evt.target.files[0] ? evt.target.files[0] : null;
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(String(reader.result || "{}"));
      const s = _fvEnsureStateShape(loadState());

      if (data.bank && typeof data.bank === "object"){
        s.bank = _fvEnsureStateShape({ bank: data.bank }).bank;
      }
      if (Array.isArray(data.goalsMap)) s.goalsMap = data.goalsMap;
      if (data.thres && typeof data.thres === "object") s.thres = data.thres;

      saveState(s);

      initGoalsMap();
      _fvMcqRenderList();
      _fvImgRenderList();
      _fvDragRenderList();
      if (typeof updateBankStatusUI === "function") updateBankStatusUI();

      _fvAlert("Import klar.");
    }catch(e){
      console.error("Import fel:", e);
      _fvAlert("Kunde inte importera filen (felaktig JSON).");
    }
  };
  reader.readAsText(file);
}

/* =========================
   3B.7 ‚Äì Google-login (l√§rare)
   ========================= */

let _fvAuthHooked = false;

function _fvUpdateGoogleStatus(){
  const st = _fvEl("googleStatus");
  const btnIn = _fvEl("btnGooglePlaceholder");
  const btnOut = _fvEl("btnGoogleLogout");

  const user = _fvUser();
  if (!st) return;

  if (user){
    st.textContent = `‚òÅÔ∏è Inloggad: ${user.email || user.uid}`;
    if (btnIn) btnIn.classList.add("hidden");
    if (btnOut) btnOut.classList.remove("hidden");
  } else {
    st.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.";
    if (btnIn) btnIn.classList.remove("hidden");
    if (btnOut) btnOut.classList.add("hidden");
  }
}

async function handleGoogleLogin(){
  if (!firebaseAuthInstance) return _fvAlert("Firebase Auth √§r inte initierat.");

  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // Popup f√∂rst
    await firebaseAuthInstance.signInWithPopup(provider);
    _fvUpdateGoogleStatus();
  }catch(err){
    console.error("Google login fel:", err);

    // Fallback: redirect
    try{
      const provider2 = new firebase.auth.GoogleAuthProvider();
      provider2.setCustomParameters({ prompt: "select_account" });
      await firebaseAuthInstance.signInWithRedirect(provider2);
    }catch(e2){
      console.error("Google redirect fel:", e2);
      _fvAlert("Kunde inte logga in med Google. Se konsolen.");
    }
  }
}

async function handleGoogleLogout(){
  if (!firebaseAuthInstance) return;
  try{
    await firebaseAuthInstance.signOut();
  }catch(err){
    console.error("Logout fel:", err);
  }
  _fvUpdateGoogleStatus();
}

/* =========================
   3B.8 ‚Äì Moln-bankar (Firestore)
   - FIX: ingen auto-load utan login
   - FIX: sp√§rr mot dubbel/trippel k√∂rning
   - FIX: tydlig status vid permission-denied + fallback till gamla collections
   ========================= */

let _fvCloudLoading = false;

function setupCloudBankUI(){
  _fvUpdateGoogleStatus();

  if (firebaseAuthInstance && !_fvAuthHooked){
    _fvAuthHooked = true;

    firebaseAuthInstance.onAuthStateChanged(async () => {
      _fvUpdateGoogleStatus();

      // Om anv√§ndaren kommer tillbaka fr√•n redirect
      try{
        const res = await firebaseAuthInstance.getRedirectResult();
        if (res && res.user){
          _fvUpdateGoogleStatus();
        }
      }catch(_){}

      // Ladda INTE automatiskt moln-bankar (undviker spam/permissions)
      _fvSetMini("cloudBankStatus", "");
    });
  }
}

function _fvDocToCloudBank(doc){
  const data = doc.data() || {};
  return {
    id: doc.id,
    name: data.name || data.bankName || "Namnl√∂s bank",
    createdAt: data.createdAt || null,
    updatedAt: data.updatedAt || null,
    bank: data.bank || data.bankData || null,
    goalsMap: data.goalsMap || [],
    thres: data.thres || null,
    sharedBankId: data.sharedBankId || data.sharedBank || data.sharedId || ""
  };
}

function _fvFormatTs(ts){
  try{
    if (!ts) return "-";
    if (typeof ts.toDate === "function") return ts.toDate().toLocaleString("sv-SE");
    if (typeof ts === "string") return new Date(ts).toLocaleString("sv-SE");
    return "-";
  }catch(_){
    return "-";
  }
}

function renderCloudBankList(){
  const list = _fvEl("cloudBankList");
  if (!list) return;

  list.innerHTML = "";
  const s = _fvEnsureStateShape(loadState());

  const banks = Array.isArray(cloudBanks) ? cloudBanks.slice() : [];
  if (!banks.length){
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga bankar hittades.";
    list.appendChild(li);
    return;
  }

  banks.forEach((b) => {
    const li = document.createElement("li");
    li.style.border = "1px solid #1f2937";
    li.style.borderRadius = "10px";
    li.style.padding = "10px";
    li.style.display = "flex";
    li.style.flexDirection = "column";
    li.style.gap = "8px";

    const head = document.createElement("div");
    head.style.display = "flex";
    head.style.justifyContent = "space-between";
    head.style.alignItems = "flex-start";
    head.style.gap = "10px";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.flexDirection = "column";
    left.style.gap = "4px";

    const title = document.createElement("div");
    title.style.fontWeight = "700";
    title.textContent = b.name || "Namnl√∂s bank";

    const bankObj = b.bank || {};
    const mcqCount = (bankObj && Array.isArray(bankObj.mcq)) ? bankObj.mcq.length : 0;
    const imgCount = (bankObj && Array.isArray(bankObj.img)) ? bankObj.img.length : 0;
    const dragCount = (bankObj && Array.isArray(bankObj.drag)) ? bankObj.drag.length : 0;
    const total = mcqCount + imgCount + dragCount;

    const meta = document.createElement("div");
    meta.className = "mini";
    meta.textContent =
      `Skapad: ${_fvFormatTs(b.createdAt)} | Uppdaterad: ${_fvFormatTs(b.updatedAt)} | ` +
      `Fr√•gor: ${total} (MCQ: ${mcqCount}, bild: ${imgCount}, drag: ${dragCount})`;

    const idRow = document.createElement("div");
    idRow.className = "mini";
    const shared = _fvSafeText(b.sharedBankId);
    idRow.textContent = shared ? `Bank-ID: ${b.id} | sharedBank-id: ${shared}` : `Bank-ID: ${b.id}`;

    left.appendChild(title);
    left.appendChild(meta);
    left.appendChild(idRow);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.flexWrap = "wrap";
    right.style.justifyContent = "flex-end";

    const btnAct = document.createElement("button");
    btnAct.type = "button";
    btnAct.className = "btn btn-sm btn-primary";
    btnAct.textContent = "Aktivera bank";
    btnAct.addEventListener("click", async () => {
      await handleActivateCloudBank(b.id);
    });

    const btnCopy = document.createElement("button");
    btnCopy.type = "button";
    btnCopy.className = "btn btn-sm";
    btnCopy.textContent = "Kopiera elevl√§nk";
    btnCopy.addEventListener("click", async () => {
      const sharedId = _fvSafeText(b.sharedBankId);
      if (!sharedId){
        _fvAlert("Denna bank saknar sharedBank-id. (Skapa elevl√§nk/publik bank f√∂rst.)");
        return;
      }
      const link = `${_fvBaseUrl()}/?bank=${encodeURIComponent(sharedId)}`;
      try{
        await navigator.clipboard.writeText(link);
        _fvSetMini("cloudBankStatus", "Elevl√§nk kopierad.");
      }catch(_){
        _fvAlert(link);
      }
    });

    const btnDel = document.createElement("button");
    btnDel.type = "button";
    btnDel.className = "btn btn-sm btn-danger";
    btnDel.textContent = "Ta bort";
    btnDel.addEventListener("click", async () => {
      await handleDeleteCloudBank(b.id);
    });

    right.appendChild(btnAct);
    right.appendChild(btnDel);
    right.appendChild(btnCopy);

    head.appendChild(left);
    head.appendChild(right);

    li.appendChild(head);

    list.appendChild(li);
  });
}

async function fvRefreshCloudBanks(){
  if (_fvCloudLoading) return;
  _fvCloudLoading = true;

  const statusEl = _fvEl("cloudBankStatus");
  if (statusEl) statusEl.textContent = "Laddar bankar...";

  try{
    if (!firebaseDbInstance || !firebaseAuthInstance){
      if (statusEl) statusEl.textContent = "Firebase √§r inte initierat.";
      cloudBanks = [];
      renderCloudBankList();
      return;
    }

    const user = _fvUser();
    if (!user){
      if (statusEl) statusEl.textContent = "Logga in med Google f√∂r att ladda moln-bankar.";
      cloudBanks = [];
      renderCloudBankList();
      return;
    }

    const uid = user.uid;

    // 1) Prim√§rt: teachers/{uid}/banks
    try{
      const snap = await firebaseDbInstance
        .collection("teachers").doc(uid).collection("banks")
        .orderBy("updatedAt","desc")
        .get();

      cloudBanks = [];
      snap.forEach((doc) => cloudBanks.push(_fvDocToCloudBank(doc)));

      if (statusEl) statusEl.textContent = `Hittade ${cloudBanks.length} bankar i molnet.`;
      renderCloudBankList();
      return;
    }catch(err1){
      // permission-denied? -> fallback
      if (err1 && err1.code !== "permission-denied") throw err1;
      console.warn("[3B] teachers/{uid}/banks permission-denied, testar fallback...");
    }

    // 2) Fallback: fangvaktaren_banks (√§ldre struktur)
    try{
      const snap2 = await firebaseDbInstance
        .collection("fangvaktaren_banks")
        .where("ownerUid","==",uid)
        .orderBy("updatedAt","desc")
        .get();

      cloudBanks = [];
      snap2.forEach((doc) => cloudBanks.push(_fvDocToCloudBank(doc)));

      if (statusEl) statusEl.textContent = `Hittade ${cloudBanks.length} bankar (fallback).`;
      renderCloudBankList();
      return;
    }catch(err2){
      if (err2 && err2.code !== "permission-denied") throw err2;
    }

    // 3) Fallback: fangvaktaren_banker (annan √§ldre struktur)
    try{
      const snap3 = await firebaseDbInstance
        .collection("fangvaktaren_banker")
        .where("ownerUid","==",uid)
        .orderBy("updatedAt","desc")
        .get();

      cloudBanks = [];
      snap3.forEach((doc) => cloudBanks.push(_fvDocToCloudBank(doc)));

      if (statusEl) statusEl.textContent = `Hittade ${cloudBanks.length} bankar (fallback 2).`;
      renderCloudBankList();
      return;
    }catch(err3){
      if (err3 && err3.code !== "permission-denied") throw err3;
    }

    cloudBanks = [];
    renderCloudBankList();

    if (statusEl){
      statusEl.textContent =
        "Saknar beh√∂righet att l√§sa moln-bankar (permission-denied). " +
        "Detta √§r Firestore Rules. (teachers/{uid}/banks m√•ste till√•ta read f√∂r uid.)";
    }

  }catch(err){
    console.error(" [3B] Laddning av moln-banker fel:", err);
    cloudBanks = [];
    renderCloudBankList();
    if (statusEl) statusEl.textContent = "Fel vid laddning av moln-bankar. Se konsolen.";
  }finally{
    _fvCloudLoading = false;
  }
}

async function handleLoadCloudBanks(){
  await fvRefreshCloudBanks();
  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
}

async function handleActivateCloudBank(bankId){
  const user = _fvUser();
  if (!user) return _fvAlert("Logga in med Google f√∂rst.");

  const uid = user.uid;

  // f√∂rs√∂k samma ordning som vid load
  let docData = null;

  try{
    const d = await firebaseDbInstance.collection("teachers").doc(uid).collection("banks").doc(bankId).get();
    if (d.exists) docData = d.data() || null;
  }catch(_){}

  if (!docData){
    try{
      const d2 = await firebaseDbInstance.collection("fangvaktaren_banks").doc(bankId).get();
      if (d2.exists) docData = d2.data() || null;
    }catch(_){}
  }

  if (!docData){
    try{
      const d3 = await firebaseDbInstance.collection("fangvaktaren_banker").doc(bankId).get();
      if (d3.exists) docData = d3.data() || null;
    }catch(_){}
  }

  if (!docData) return _fvAlert("Kunde inte hitta bank-dokumentet.");

  const s = _fvEnsureStateShape(loadState());

  // viktigt: koppla med goalsMap + bank + thres s√• delbitar f√∂ljer med
  const bank = docData.bank || docData.bankData || null;
  if (bank && typeof bank === "object"){
    s.bank = _fvEnsureStateShape({ bank }).bank;
  }
  if (Array.isArray(docData.goalsMap)) s.goalsMap = docData.goalsMap;
  if (docData.thres && typeof docData.thres === "object") s.thres = docData.thres;

  saveState(s);

  initGoalsMap();
  _fvMcqRenderList();
  _fvImgRenderList();
  _fvDragRenderList();

  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
  _fvSetMini("cloudBankStatus", "Bank aktiverad.");
}

async function handleDeleteCloudBank(bankId){
  const user = _fvUser();
  if (!user) return _fvAlert("Logga in med Google f√∂rst.");
  if (!confirm("Ta bort denna bank fr√•n molnet?")) return;

  const uid = user.uid;

  // f√∂rs√∂k ta bort i teachers f√∂rst, annars i fallback
  let ok = false;

  try{
    await firebaseDbInstance.collection("teachers").doc(uid).collection("banks").doc(bankId).delete();
    ok = true;
  }catch(_){}

  if (!ok){
    try{
      await firebaseDbInstance.collection("fangvaktaren_banks").doc(bankId).delete();
      ok = true;
    }catch(_){}
  }

  if (!ok){
    try{
      await firebaseDbInstance.collection("fangvaktaren_banker").doc(bankId).delete();
      ok = true;
    }catch(_){}
  }

  if (!ok) return _fvAlert("Kunde inte ta bort bank (saknar beh√∂righet?).");

  _fvSetMini("cloudBankStatus", "Bank borttagen.");
  await fvRefreshCloudBanks();
  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
}

async function handleSaveToCloud(){
  const user = _fvUser();
  if (!user) return _fvAlert("Logga in med Google f√∂rst.");
  if (!firebaseDbInstance) return _fvAlert("Firebase DB saknas.");

  const nameEl = _fvEl("inputBankName");
  const bankName = _fvSafeText(nameEl ? nameEl.value : "");
  if (!bankName) return _fvAlert("Skriv ett namn p√• fr√•gebanken.");

  const s = _fvEnsureStateShape(loadState());
  const bank = s.bank;

  const payload = {
    name: bankName,
    bank: bank,
    goalsMap: Array.isArray(s.goalsMap) ? s.goalsMap : [],
    thres: s.thres || { E:70, C:70, A:70 },
    ownerUid: user.uid,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  // f√∂rs√∂k spara till teachers/{uid}/banks, annars till fallback collection
  let saved = false;
  try{
    await firebaseDbInstance.collection("teachers").doc(user.uid).collection("banks").add(payload);
    saved = true;
  }catch(err1){
    if (err1 && err1.code !== "permission-denied") console.error("Save teachers/banks fel:", err1);
  }

  if (!saved){
    try{
      await firebaseDbInstance.collection("fangvaktaren_banks").add(payload);
      saved = true;
    }catch(err2){
      if (err2 && err2.code !== "permission-denied") console.error("Save fangvaktaren_banks fel:", err2);
    }
  }

  if (!saved){
    try{
      await firebaseDbInstance.collection("fangvaktaren_banker").add(payload);
      saved = true;
    }catch(err3){
      console.error("Save fallback2 fel:", err3);
    }
  }

  if (!saved) return _fvAlert("Kunde inte spara till molnet (permission-denied). Firestore Rules.");

  _fvSetMini("cloudBankStatus", "Bank sparad till molnet.");
  await fvRefreshCloudBanks();
  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
}

/* =========================
   3B.9 ‚Äì Init: koppla knappar i editorer
   ========================= */

function initQuestionForms(){
  // MCQ
  const btnMcqAdd = _fvEl("btnMcqAdd");
  if (btnMcqAdd) btnMcqAdd.addEventListener("click", handleMcqAdd);

  const btnMcqUpdate = _fvEl("btnMcqUpdate");
  if (btnMcqUpdate) btnMcqUpdate.addEventListener("click", handleMcqUpdate);

  const btnMcqClear = _fvEl("btnMcqClear");
  if (btnMcqClear) btnMcqClear.addEventListener("click", _fvMcqClearForm);

  const btnMcqJsonImport = _fvEl("btnMcqJsonImport");
  if (btnMcqJsonImport) btnMcqJsonImport.addEventListener("click", handleMcqJsonImport);

  // IMG
  const btnImgAdd = _fvEl("btnImgAdd");
  if (btnImgAdd) btnImgAdd.addEventListener("click", handleImgAdd);

  const btnImgClear = _fvEl("btnImgClear");
  if (btnImgClear) btnImgClear.addEventListener("click", _fvImgClearForm);

  // DRAG
  const btnDragAddItem = _fvEl("btnDragAddItem");
  if (btnDragAddItem) btnDragAddItem.addEventListener("click", handleDragAddItem);

  const btnDragAddQuestion = _fvEl("btnDragAddQuestion");
  if (btnDragAddQuestion) btnDragAddQuestion.addEventListener("click", handleDragAddQuestion);

  const btnDragClearForm = _fvEl("btnDragClearForm");
  if (btnDragClearForm) btnDragClearForm.addEventListener("click", handleDragClearForm);

  // Delm√•l/delbitar
  const btnAddGoalPart = _fvEl("btnAddGoalPart");
  if (btnAddGoalPart) btnAddGoalPart.addEventListener("click", handleAddGoalPart);

  const btnSaveGoalsMap = _fvEl("btnSaveGoalsMap");
  if (btnSaveGoalsMap) btnSaveGoalsMap.addEventListener("click", handleSaveGoalsMap);

  const btnClearGoalsMap = _fvEl("btnClearGoalsMap");
  if (btnClearGoalsMap) btnClearGoalsMap.addEventListener("click", handleClearGoalsMap);

  // Render initiala listor
  _fvMcqRenderList();
  _fvImgRenderList();
  _fvDragRenderList();

  // Form reset
  _fvMcqClearForm();
  _fvImgClearForm();
  _fvDragResetDraft();
  _fvDragRenderDraft();
}

/* =========================
   3B.10 ‚Äì Exponerade "initTeacherEmailSettings" etc (f√∂r kompatibilitet)
   ========================= */

function initTeacherEmailSettings(){ /* finns i SEKTION 5/andra delar ‚Äì l√§mnas tom h√§r */ }
function initThresholdSettings(){ /* finns i SEKTION 5/andra delar ‚Äì l√§mnas tom h√§r */ }
function initTeacherPasswordSettings(){ /* finns i SEKTION 5/andra delar ‚Äì l√§mnas tom h√§r */ }

/* =========================
   3B.11 ‚Äì S√§ker refresh-funktion (f√∂r efter bank-aktiviering)
   ========================= */

function refreshAllTeacherLists(){
  initGoalsMap();
  _fvMcqRenderList();
  _fvImgRenderList();
  _fvDragRenderList();
  if (typeof updateBankStatusUI === "function") updateBankStatusUI();
}

/* =========================
   3B.12 ‚Äì Auto: init om DOM redan √§r redo
   ========================= */

(function(){
  if (document.readyState === "loading") return;
  try{
    // detta √§r s√§kert √§ven om SEKTION 5 initApp k√∂r senare
    const s = _fvEnsureStateShape(loadState());
    saveState(s);
    initGoalsMap();
    initQuestionForms();
    initImageQuestionsEditor();
    initDragDropQuestionsEditor();
    setupCloudBankUI();
  }catch(_){}
})();
</script>

<!--
√ÑNDRING (SEKTION 3B):
- Stoppar moln-laddning utan inloggning och sp√§rrar dubbel/trippelk√∂rning.
- Laddar/sparar bank + goalsMap + thres i samma dokument, s√• delbitar f√∂ljer med.
- Visar tydligt permission-denied och testar fallback-collections (fangvaktaren_banks/banker).
RADER: Stor omskrivning av hela SEKTION 3B (byt ut hela sektionen).
TESTA: Logga in ‚Üí klicka ‚ÄúLadda moln-bankar‚Äù ‚Üí aktivera en bank ‚Üí kolla att fr√•gor + delm√•l/delbitar syns.
-->
<!-- slut SEKTION 3B: L√ÑRARVERKTYG (delm√•l/delbitar, fr√•geeditorer, bank export/import, moln-bankar, Google-login) -->







<!-- start SEKTION 3C: DELM√ÖL & DELBITAR (goalsMap) -->
<script>
"use strict";

/* =========================
   3c ‚Äì Delm√•l & delbitar (goalsMap)
   Visning: 1 ruta per delm√•l, delbitar som underrader med delete-knapp.
   ========================= */

function _fvNorm(v){
  return (v == null ? "" : String(v)).replace(/\s+/g, " ").trim();
}

function _fvUpdateGoalSelects(){
  const s = loadState();
  const gm = Array.isArray(s.goalsMap) ? s.goalsMap : [];

  const selects = [
    "mcqGoalPart","imgGoalPart","dragGoalPart","mcqJsonGoalPart"
  ].map(getEl).filter(Boolean);

  selects.forEach((sel) => {
    const prev = sel.value || "";
    sel.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Ingen koppling";
    sel.appendChild(opt0);

    gm.forEach((it) => {
      const o = document.createElement("option");
      o.value = String(it.id);

      const goalTxt = _fvNorm(it.goal || it.delmal || it.title || "");
      const partTxt = _fvNorm(it.partText || it.parts || it.part || it.delbit || "");

      // Visa: Delm√•l ‚Äî Delbit (utan att visa id)
      o.textContent = goalTxt
        ? (goalTxt + (partTxt ? " ‚Äî " + partTxt : ""))
        : (partTxt || "Delbit");

      sel.appendChild(o);
    });

    // f√∂rs√∂k beh√•lla tidigare val om det finns kvar
    if (prev && Array.from(sel.options).some((o) => o.value === prev)) {
      sel.value = prev;
    } else {
      sel.value = "";
    }
  });
}

function _fvRenderGoalsList(){
  const listEl = getEl("goalsList");
  const statusEl = getEl("goalsStatus");
  if (!listEl) return;

  const s = loadState();
  const gm = Array.isArray(s.goalsMap) ? s.goalsMap.slice() : [];

  listEl.innerHTML = "";

  if (!gm.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga delm√•l/delbitar sparade √§nnu.";
    listEl.appendChild(li);
    if (statusEl) statusEl.textContent = "";
    _fvUpdateGoalSelects();
    return;
  }

  // Grupp: delm√•lstext -> items (beh√•ll ordning)
  const groups = new Map();
  gm.forEach((it) => {
    const goalTitle = _fvNorm(it.goal || it.delmal || it.title || "Delm√•l");
    const key = goalTitle || "Delm√•l";
    if (!groups.has(key)) groups.set(key, []);
    groups.get(key).push(it);
  });

  groups.forEach((items, goalTitle) => {
    // <li> som "kort"
    const outerLi = document.createElement("li");
    outerLi.style.listStyle = "none";
    outerLi.style.margin = "10px 0";

    const card = document.createElement("div");
    card.className = "card";
    card.style.padding = "10px";

    const h = document.createElement("h4");
    h.textContent = goalTitle;
    h.style.margin = "0 0 8px 0";
    card.appendChild(h);

    const ul = document.createElement("ul");
    ul.style.margin = "0";
    ul.style.padding = "0";
    ul.style.display = "flex";
    ul.style.flexDirection = "column";
    ul.style.gap = "6px";

    items.forEach((it) => {
      const partTxt = _fvNorm(it.partText || it.parts || it.part || it.delbit || "");

      const row = document.createElement("li");
      row.style.listStyle = "none";
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.gap = "10px";
      row.style.border = "1px solid #1f2937";
      row.style.borderRadius = "10px";
      row.style.padding = "8px 10px";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "2px";

      // Underrubrik = delbit (inte id)
      const sub = document.createElement("div");
      sub.className = "mini";
      sub.textContent = partTxt || "Delbit";
      left.appendChild(sub);

      row.appendChild(left);

      // Delete-knapp (till h√∂ger)
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-sm btn-danger";
      btn.textContent = "üóëÔ∏è";
      btn.title = "Ta bort delbit";
      btn.addEventListener("click", () => {
        const s2 = loadState();
        const gm2 = Array.isArray(s2.goalsMap) ? s2.goalsMap : [];
        const id = String(it.id);
        s2.goalsMap = gm2.filter((x) => String(x.id) !== id);
        saveState(s2);
        _fvRenderGoalsList();
      });
      row.appendChild(btn);

      ul.appendChild(row);
    });

    card.appendChild(ul);
    outerLi.appendChild(card);
    listEl.appendChild(outerLi);
  });

  if (statusEl) statusEl.textContent = `Sparade kopplingar: ${gm.length} st.`;
  _fvUpdateGoalSelects();
}

function handleAddGoalPart(){
  const goalIn = getEl("inputGoalSingle");
  const partIn = getEl("inputPartSingle");
  const statusEl = getEl("goalsStatus");

  const goalTxt = _fvNorm(goalIn ? goalIn.value : "");
  const partTxt = _fvNorm(partIn ? partIn.value : "");

  if (!goalTxt || !partTxt) {
    if (statusEl) statusEl.textContent = "Fyll i b√•de delm√•l och delbit.";
    return;
  }

  const s = loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];

  s.goalsMap.push({
    id: Date.now(),
    goal: goalTxt,
    partText: partTxt
  });

  saveState(s);

  if (goalIn) goalIn.value = "";
  if (partIn) partIn.value = "";
  if (statusEl) statusEl.textContent = "Delbit tillagd.";

  _fvRenderGoalsList();
}

function handleSaveGoalsMap(){
  const statusEl = getEl("goalsStatus");
  const s = loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];
  saveState(s);
  if (statusEl) statusEl.textContent = "Delm√•l/delbitar sparade.";
  _fvRenderGoalsList();
}

function handleClearGoalsMap(){
  const statusEl = getEl("goalsStatus");
  if (!confirm("Ta bort alla delm√•l/delbitar i listan?")) return;
  const s = loadState();
  s.goalsMap = [];
  saveState(s);
  if (statusEl) statusEl.textContent = "Listan √§r rensad.";
  _fvRenderGoalsList();
}

function initGoalsMap(){
  const s = loadState();
  if (!Array.isArray(s.goalsMap)) {
    s.goalsMap = [];
    saveState(s);
  }
  _fvRenderGoalsList();
}
</script>
<!-- slut SEKTION 3C: DELM√ÖL & DELBITAR (goalsMap) -->







<!-- start SEKTION 3D: FIX ‚Äì Mappa fr√•ga -> delbit/delm√•l (getLinksForQuestion) -->
<script>
(function(){
  "use strict";

  function _normTxt(v){
    return (v == null ? "" : String(v)).replace(/\s+/g, " ").trim().toLowerCase();
  }
  function _pickFirst(obj, keys){
    if(!obj) return null;
    for(const k of keys){
      if(obj[k] != null && String(obj[k]).trim() !== "") return obj[k];
    }
    return null;
  }

  // SEKTION 4 anropar getLinksForQuestion(q, goals)
  window.getLinksForQuestion = function getLinksForQuestion(q, goals){
    const links = [];
    if(!q) return links;

    // 1) Direkt id-koppling (prioriteras)
    const direct = _pickFirst(q, [
      "goalPartId","goalId","goalPart","linkId","delbitId","delbit","partId","goalPartID"
    ]);
    if(direct != null && String(direct).trim() !== ""){
      links.push({ id: String(direct).trim() });
      return links;
    }

    // 2) Om q.goal r√•kar vara ett rent nummer (delbit-id)
    if(q.goal != null){
      const g = String(q.goal).trim();
      if(g && /^[0-9]+$/.test(g)){
        links.push({ id: g });
        return links;
      }
    }

    // 3) Textmatchning mot goalsMap
    const gm =
      (Array.isArray(goals) && goals.length) ? goals :
      (typeof window.loadState === "function" && Array.isArray(window.loadState().goalsMap)) ? window.loadState().goalsMap :
      [];

    const qGoalTxt = _normTxt(_pickFirst(q, ["goal","goalTitle","delmal","delm√•l","goalText"]));
    const qPartTxt = _normTxt(_pickFirst(q, ["part","parts","partText","delbitText","partsText"]));

    if(!qGoalTxt && !qPartTxt) return links;

    // f√∂rs√∂k hitta exakt match (goal + part), annars goal-only
    let hit = null;

    if(qGoalTxt && qPartTxt){
      hit = gm.find((x) => {
        const g = _normTxt(_pickFirst(x, ["goal","goalTitle","delmal","delm√•l","title"]));
        const p = _normTxt(_pickFirst(x, ["part","parts","partText","text","delbitText","delbit"]));
        return g === qGoalTxt && p === qPartTxt;
      }) || null;
    }

    if(!hit && qGoalTxt){
      hit = gm.find((x) => {
        const g = _normTxt(_pickFirst(x, ["goal","goalTitle","delmal","delm√•l","title"]));
        return g === qGoalTxt;
      }) || null;
    }

    if(hit && hit.id != null && String(hit.id).trim() !== ""){
      links.push({ id: String(hit.id).trim() });
    }

    return links;
  };
})();
</script>
<!-- slut SEKTION 3D: FIX ‚Äì Mappa fr√•ga -> delbit/delm√•l (getLinksForQuestion) -->


<!-- start SEKTION 3E: FIX ‚Äì Moln-banker: stoppa "Missing or insufficient permissions" n√§r ej inloggad -->
<script>
(function(){
  "use strict";

  // √ñverskriv/patcha fvRefreshCloudBanks s√• den INTE f√∂rs√∂ker l√§sa Firestore utan Google-inloggning
  window.fvRefreshCloudBanks = async function fvRefreshCloudBanks(){
    const statusEl = document.getElementById("cloudBankStatus");
    const listEl = document.getElementById("cloudBankList");

    try{
      if(listEl) listEl.innerHTML = "";

      // Kr√§ver att SEKTION 3A har initFirebase + globala instanser
      const auth = window.firebaseAuthInstance || (window.firebase && window.firebase.auth ? window.firebase.auth() : null);
      const db = window.firebaseDbInstance || (window.firebase && window.firebase.firestore ? window.firebase.firestore() : null);

      if(!auth || !db){
        if(statusEl) statusEl.textContent = "Firebase √§r inte initierad √§nnu.";
        return;
      }

      const user = auth.currentUser || window.currentTeacherUser || null;
      if(!user){
        // Detta √§r det som tidigare gav: Missing or insufficient permissions
        if(statusEl) statusEl.textContent = "Logga in med Google (Inst√§llningar) f√∂r att se dina moln-banker.";
        return;
      }

      const ROOT = window.CLOUD_ROOT_COLLECTION || "teachers";
      const SUB  = window.CLOUD_BANKS_SUBCOLLECTION || "banks";

      // L√§s l√§rarens privata banker: teachers/{uid}/banks
      const colRef = db.collection(ROOT).doc(user.uid).collection(SUB);

      // undvik orderBy (kan kr√§va index) ‚Äì enkel get
      const snap = await colRef.get();

      const banks = [];
      snap.forEach((doc) => {
        const data = doc.data() || {};
        banks.push({ id: doc.id, ...data });
      });

      // Spara i global state om du anv√§nder det
      window.cloudBanks = banks;

      if(statusEl){
        statusEl.textContent = banks.length
          ? `Hittade ${banks.length} bankar i molnet.`
          : "Inga bankar hittades i molnet f√∂r detta konto.";
      }

      // Om du redan har en render-funktion, anv√§nd den ‚Äì annars visa en enkel lista
      if(typeof window.renderCloudBankList === "function"){
        window.renderCloudBankList(banks);
        return;
      }

      if(listEl){
        listEl.innerHTML = "";
        banks.forEach((b) => {
          const li = document.createElement("li");
          li.className = "goal-item";
          const name = b.name || b.bankName || "Namnl√∂s bank";
          const mcq = Array.isArray(b.mcq) ? b.mcq.length : (Array.isArray(b.bank?.mcq) ? b.bank.mcq.length : 0);
          const img = Array.isArray(b.img) ? b.img.length : (Array.isArray(b.bank?.img) ? b.bank.img.length : 0);
          const drag = Array.isArray(b.drag) ? b.drag.length : (Array.isArray(b.bank?.drag) ? b.bank.drag.length : 0);
          const total = mcq + img + drag;

          li.innerHTML = `<div><strong>${name}</strong><div class="mini">Fr√•gor: ${total} (MCQ: ${mcq}, bild: ${img}, drag: ${drag})</div></div>`;
          listEl.appendChild(li);
        });
      }
    }catch(err){
      console.error("[3B] Laddning av moln-banker fel:", err);
      if(statusEl){
        const msg = (err && err.message) ? err.message : String(err);
        if(/insufficient permissions|missing or insufficient/i.test(msg)){
          statusEl.textContent = "Beh√∂righetsfel: du √§r inte inloggad (eller Firestore-reglerna blockerar). Logga in med Google och f√∂rs√∂k igen.";
        }else{
          statusEl.textContent = "Fel vid laddning av moln-banker. Se konsolen f√∂r detaljer.";
        }
      }
    }
  };

  // S√§kerst√§ll att knappen "Ladda moln-bankar" anv√§nder patchen
  window.handleLoadCloudBanks = function handleLoadCloudBanks(){
    return window.fvRefreshCloudBanks();
  };
})();
</script>
<!-- slut SEKTION 3E: FIX ‚Äì Moln-banker: stoppa "Missing or insufficient permissions" n√§r ej inloggad -->

<!-- KOMMENTAR (test): Detta √§r all kod f√∂r denna fix (3D + 3E). Byt in sektionerna och testa igen: (1) att texten inte ‚Äúbl√∂der‚Äù ut, (2) att moln-bankar inte ger permissions-fel n√§r du inte √§r inloggad, och (3) att delbit-kopplingar r√§knas i progression. -->


<!-- start SEKTION 3F: GOALSMAP ‚Äì HJ√ÑLPARE F√ñR SELECTS (OM DE FINNS) -->
<script>
"use strict";

function initGoalsMap(){
  const s = loadState();
  const goals = Array.isArray(s.goalsMap) ? s.goalsMap : [];

  function fillSelect(id){
    const sel = document.getElementById(id);
    if(!sel) return;

    const cur = sel.value;
    sel.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî V√§lj delm√•l/delbit ‚Äî";
    sel.appendChild(opt0);

    goals.forEach((g)=>{
      const o = document.createElement("option");
      o.value = String(g.id);
      const gtxt = (g.goal || "").toString().trim();
      const ptxt = (g.parts || "").toString().trim();
      o.textContent = ptxt ? (`Delbit ${g.id}: ${gtxt} ‚Äì ${ptxt}`) : (`Delbit ${g.id}: ${gtxt}`);
      sel.appendChild(o);
    });

    if(cur) sel.value = cur;
  }

  fillSelect("mcqGoalPart");
  fillSelect("imgGoalPart");
  fillSelect("dragGoalPart");
}

window.initGoalsMap = initGoalsMap;

document.addEventListener("DOMContentLoaded", function(){
  try { initGoalsMap(); } catch(_){}
});
</script>
<!-- slut SEKTION 3F: GOALSMAP ‚Äì HJ√ÑLPARE F√ñR SELECTS (OM DE FINNS) -->


<!-- start SEKTION 3G: TALSYNTHES F√ñR FR√ÖGOR -->
<script>
(function () {
  function speakText(text) {
    if (!("speechSynthesis" in window)) {
      alert("Din webbl√§sare st√∂djer tyv√§rr inte talsyntes.");
      return;
    }
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "sv-SE";
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    window.speechSynthesis.speak(utterance);
  }

  function isControlButtonText(txt) {
    const lower = (txt || "").toLowerCase();
    return (
      lower.includes("n√§sta") ||
      lower.includes("avbryt") ||
      lower.includes("tillbaka") ||
      lower.includes("l√§mna in") ||
      lower.includes("starta om") ||
      lower.includes("√∂ppna l√§rarl√§ge") ||
      lower.includes("v√§lj niv√•") ||
      lower.includes("avsluta")
    );
  }

  function buildQuestionTextFromBox(box) {
    if (!box) return "";

    const optionSelector = "button, li, label, .answer-option, .mcq-option, .img-option, .drag-option, .play-option, .option";
    const optionEls = Array.from(box.querySelectorAll(optionSelector));
    const optionTexts = [];

    optionEls.forEach((el) => {
      if (el.classList && el.classList.contains("tts-speak-btn")) return;
      const txt = (el.innerText || "").trim();
      if (!txt) return;
      if (isControlButtonText(txt)) return;
      optionTexts.push(txt);
    });

    const textEls = Array.from(box.querySelectorAll("h1,h2,h3,h4,p,div,span")).filter((el) => {
      if (el.closest("button")) return false;
      if (el.classList && el.classList.contains("tts-speak-btn")) return false;
      return true;
    });

    const lines = [];
    textEls.forEach((el) => {
      const raw = (el.innerText || "");
      raw.split("\n").forEach((r) => {
        const line = r.trim();
        if (!line) return;
        if (optionTexts.includes(line)) return;
        if (isControlButtonText(line)) return;
        lines.push(line);
      });
    });

    if (!lines.length) return "";

    let headerIndex = -1;
    for (let i = 0; i < lines.length; i++) {
      if (/^fr√•ga\s*\d+/i.test(lines[i])) { headerIndex = i; break; }
    }

    let questionIndex = -1;
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].includes("?")) { questionIndex = i; break; }
    }
    if (questionIndex === -1) {
      for (let i = 0; i < lines.length; i++) {
        if (i === headerIndex) continue;
        questionIndex = i;
        break;
      }
    }

    const parts = [];
    if (questionIndex !== -1) {
      parts.push("Fr√•ga:");
      if (headerIndex !== -1 && headerIndex < questionIndex) parts.push(lines[headerIndex]);
      parts.push(lines[questionIndex]);
    }

    if (optionTexts.length) {
      parts.push("Svarsalternativ:");
      optionTexts.forEach((t, idx) => parts.push("Alternativ " + (idx + 1) + ": " + t));
    }

    return parts.join(". ");
  }

  function attachSpeakButtonsToAllQuestions() {
    const play = document.getElementById("play");
    if (!play) return;

    const headers = Array.from(play.querySelectorAll("h1,h2,h3,h4,div,span,p")).filter((n) => {
      const txt = (n.innerText || "").trim().toLowerCase();
      return /^fr√•ga\s*\d/.test(txt);
    });

    headers.forEach((node) => {
      let box =
        node.closest(".question-card, .play-question-card, .inner-question, .card, li, .question") ||
        node.parentElement ||
        node;

      if (!box) return;
      if (box.dataset.ttsAttached === "1") return;
      box.dataset.ttsAttached = "1";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-sm tts-speak-btn";
      btn.textContent = "üîä L√§s upp fr√•gan";
      btn.style.marginTop = "6px";

      btn.addEventListener("click", function () {
        const text = buildQuestionTextFromBox(box);
        if (!text) return alert("Hittar ingen fr√•ga att l√§sa upp i denna ruta.");
        speakText(text);
      });

      box.appendChild(btn);
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const globalBtn = document.getElementById("btnSpeakQuestion");
    if (globalBtn && globalBtn.parentNode) globalBtn.parentNode.removeChild(globalBtn);

    attachSpeakButtonsToAllQuestions();

    if ("MutationObserver" in window) {
      const play = document.getElementById("play");
      if (play) {
        const obs = new MutationObserver(function () {
          attachSpeakButtonsToAllQuestions();
        });
        obs.observe(play, { childList: true, subtree: true });
      }
    }
  });
})();
</script>
<!-- slut SEKTION 3G: TALSYNTHES F√ñR FR√ÖGOR -->

<!-- slut SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker & editorer) -->










<!-- start SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->
<script>
"use strict";

/* =========================
   4a ‚Äì Elevdata & UI-sync
   ========================= */

function ensureStudentSet() {
  const s = loadState();
  if (!s.student.name || !s.student.klass) {
    alert("Skriv in namn och klass och spara eleven f√∂rst.");
    return false;
  }
  return true;
}

function handleSaveStudent() {
  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  const s = loadState();

  s.student.name = (nameInput && nameInput.value.trim()) || "";
  s.student.klass = (classInput && classInput.value.trim()) || "";
  saveState(s);
  syncUI();
}

function updateStudentStatsUI() {
  const s = loadState();
  const ptsEl = getEl("studentPointsValue");
  const hsEl = getEl("highscoreSummary");

  const totalPoints = (s.progression && typeof s.progression.totalPoints === "number")
    ? s.progression.totalPoints
    : 0;

  if (ptsEl) ptsEl.textContent = `${totalPoints} p`;

  if (hsEl) {
    const hs = Array.isArray(s.highscores) ? s.highscores.slice() : [];
    if (!hs.length) {
      hsEl.textContent = "Ingen highscore √§nnu.";
      return;
    }
    hs.sort((a, b) => (b.points || 0) - (a.points || 0));
    const studentId = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
    const idx = hs.findIndex((e) => e.id === studentId);
    if (idx >= 0) {
      hsEl.textContent = `Plats ${idx + 1} av ${hs.length} (${hs[idx].points || 0} p)`;
    } else {
      hsEl.textContent = `Highscorelista: ${hs.length} elever p√• denna enhet.`;
    }
  }
}

function normalizeGoalsMap(s) {
  if (!s) return [];

  // St√∂d flera m√∂jliga format
  const raw =
    (Array.isArray(s.goalsMap) && s.goalsMap) ||
    (s.bank && Array.isArray(s.bank.goalsMap) && s.bank.goalsMap) ||
    (s.bank && s.bank.meta && Array.isArray(s.bank.meta.goalsMap) && s.bank.meta.goalsMap) ||
    [];

  const out = [];

  raw.forEach((g, i) => {
    if (!g) return;

    // F√∂rv√§ntat: { id, goal, part } eller { id, goalTitle, partText }
    const id =
      (g.id != null ? String(g.id) : null) ||
      (g.partId != null ? String(g.partId) : null) ||
      (g.delbit != null ? String(g.delbit) : null) ||
      String(i + 1);

    const goal =
      (g.goal != null ? String(g.goal) : null) ||
      (g.goalTitle != null ? String(g.goalTitle) : null) ||
      (g.delmal != null ? String(g.delmal) : null) ||
      "";

    const part =
      (g.part != null ? String(g.part) : null) ||
      (g.partText != null ? String(g.partText) : null) ||
      (g.text != null ? String(g.text) : null) ||
      (g.delbitText != null ? String(g.delbitText) : null) ||
      "";

    out.push({ id, goal, part });
  });

  return out;
}

function renderGoalsListAndSelects() {
  const s = loadState();
  const goals = normalizeGoalsMap(s);

  // Lista i Inst√§llningar
  const listEl = getEl("goalsList");
  if (listEl) {
    listEl.innerHTML = "";
    if (!goals.length) {
      const li = document.createElement("li");
      li.textContent = "Inga delm√•l/delbitar sparade √§nnu.";
      listEl.appendChild(li);
    } else {
      goals.forEach((g) => {
        const li = document.createElement("li");
        const left = g.goal ? `${g.goal}` : "Delm√•l";
        const right = g.part ? ` ‚Äì ${g.part}` : "";
        li.textContent = `Delbit ${g.id}: ${left}${right}`;
        listEl.appendChild(li);
      });
    }
  }

  // Selects i editorerna
  const selectIds = ["mcqGoalPart", "imgGoalPart", "dragGoalPart", "mcqJsonGoalPart"];
  selectIds.forEach((id) => {
    const sel = getEl(id);
    if (!sel) return;

    const keepValue = sel.value || "";
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Ingen koppling";
    sel.appendChild(opt0);

    goals.forEach((g) => {
      const opt = document.createElement("option");
      opt.value = String(g.id);
      const goalTxt = (g.goal || "").trim();
      const partTxt = (g.part || "").trim();
      opt.textContent = goalTxt && partTxt
        ? `Delbit ${g.id}: ${goalTxt} ‚Äì ${partTxt}`
        : goalTxt
          ? `Delbit ${g.id}: ${goalTxt}`
          : partTxt
            ? `Delbit ${g.id}: ${partTxt}`
            : `Delbit ${g.id}`;
      sel.appendChild(opt);
    });

    if (keepValue) sel.value = keepValue;
  });
}

function updateProgressionPanel() {
  const s = loadState();
  const prog = s.progression || {};
  const best = s.best || {};
  const thres = s.thres || {};

  const pointsText = getEl("progressPointsText");
  const strongEl = getEl("progressStrongList");
  const weakEl = getEl("progressWeakList");

  const last = prog.lastResult || null;
  const totalPoints = typeof prog.totalPoints === "number" ? prog.totalPoints : 0;

  const tE = (thres && typeof thres.E === "number") ? thres.E : 70;
  const tC = (thres && typeof thres.C === "number") ? thres.C : 70;
  const tA = (thres && typeof thres.A === "number") ? thres.A : 70;

  if (pointsText) {
    if (!last) {
      pointsText.textContent = "Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.";
    } else {
      pointsText.textContent =
        `Totalt: ${totalPoints} p. ` +
        `Senast: niv√• ${last.level} ‚Äì ${last.score}% (${last.correct}/${last.total} r√§tt) +${last.pointsGained || 0}p. ` +
        `B√§sta: E ${best.E || 0}% (gr√§ns ${tE}%), C ${best.C || 0}% (gr√§ns ${tC}%), A ${best.A || 0}% (gr√§ns ${tA}%).`;
    }
  }

  if (strongEl) strongEl.innerHTML = "";
  if (weakEl) weakEl.innerHTML = "";

  const wrongByGoal = prog.wrongByGoalId || {};
  const correctByGoal = prog.correctByGoalId || {};

  const allIds = new Set([
    ...Object.keys(wrongByGoal),
    ...Object.keys(correctByGoal)
  ]);

  if (!allIds.size) {
    if (strongEl) {
      const li = document.createElement("li");
      li.textContent = "Inga starka delbitar inl√§sta √§nnu.";
      strongEl.appendChild(li);
    }
    if (weakEl) {
      const li = document.createElement("li");
      li.textContent = "Inga svaga delbitar inl√§sta √§nnu.";
      weakEl.appendChild(li);
    }
    return;
  }

  const baseThres =
    typeof thres.E === "number" ? thres.E :
    typeof thres.C === "number" ? thres.C :
    typeof thres.A === "number" ? thres.A : 70;

  const stats = [];
  allIds.forEach((id) => {
    const c = correctByGoal[id] || 0;
    const w = wrongByGoal[id] || 0;
    const total = c + w;
    if (!total) return;
    const acc = Math.round((c / total) * 100);
    stats.push({ id, correct: c, wrong: w, total, acc });
  });

  const strong = stats
    .filter((st) => st.acc >= baseThres && st.correct > 0)
    .sort((a, b) => b.acc - a.acc || b.correct - a.correct)
    .slice(0, 12);

  const weak = stats
    .filter((st) => st.acc < baseThres || st.wrong > 0)
    .sort((a, b) => b.wrong - a.wrong || a.acc - b.acc)
    .slice(0, 12);

  if (strongEl) {
    if (!strong.length) {
      const li = document.createElement("li");
      li.textContent = "Inga tydliga styrkor √§nnu ‚Äì forts√§tt spela.";
      strongEl.appendChild(li);
    } else {
      strong.forEach((st) => {
        const li = document.createElement("li");
        li.textContent = `Delbit ${st.id} ‚Äì ${st.acc}% r√§tt (${st.correct}/${st.total})`;
        strongEl.appendChild(li);
      });
    }
  }

  if (weakEl) {
    if (!weak.length) {
      const li = document.createElement("li");
      li.textContent = "Inga tydliga svagheter ‚Äì bra jobbat!";
      weakEl.appendChild(li);
    } else {
      weak.forEach((st) => {
        const li = document.createElement("li");
        li.textContent = `Delbit ${st.id} ‚Äì ${st.wrong} fel (${st.correct}/${st.total} r√§tt, ${st.acc}%)`;
        weakEl.appendChild(li);
      });
    }
  }
}

function handleGenerateProgressJson() {
  const s = loadState();
  const prog = s.progression || {};
  const last = prog.lastResult || null;

  const output = getEl("progressExportJson");
  if (!output) return;

  if (!last) {
    output.value = "";
    return;
  }

  const payload = {
    source: "fangvaktaren",
    version: "v17",
    student: {
      name: s.student.name || "",
      klass: s.student.klass || ""
    },
    result: {
      level: last.level,
      scorePercent: last.score,
      correct: last.correct,
      total: last.total,
      pointsGained: last.pointsGained,
      totalPointsAfter: last.totalPointsAfter,
      timestamp: last.timestamp
    },
    progression: {
      totalPoints: (prog.totalPoints || 0),
      best: s.best || {},
      wrongByGoalId: prog.wrongByGoalId || {},
      correctByGoalId: prog.correctByGoalId || {}
    }
  };

  output.value = JSON.stringify(payload, null, 2);
}

function handleCopyProgressJson() {
  const output = getEl("progressExportJson");
  if (!output) return;

  const text = output.value || "";
  if (!text.trim()) return;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).catch(() => {});
  }
}

function updateAllProgressionUI() {
  updateStudentStatsUI();
  updateProgressionPanel();
  renderGoalsListAndSelects();
}

function handleClearStudentData() {
  const s = loadState();
  if (!confirm("Detta rensar alla sparade elevuppgifter, highscore och progression p√• DENNA dator. Forts√§tt?")) return;

  s.student = { name: "", klass: "" };
  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];

  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Elevdata rensad p√• denna enhet.";
}

function handleResetGameData() {
  const s = loadState();
  if (!confirm("Detta nollst√§ller po√§ng, progression och highscore men beh√•ller nuvarande elevnamn/klass. Forts√§tt?")) return;

  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];

  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Spelpo√§ng och progression nollst√§lld.";
}

function syncUI() {
  const s = loadState();
  const hasStudent = !!(s.student.name && s.student.klass);

  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  if (nameInput) nameInput.value = s.student.name || "";
  if (classInput) classInput.value = s.student.klass || "";

  const studentSaved = getEl("studentSaved");
  if (studentSaved) {
    studentSaved.textContent = hasStudent
      ? `Sparad: ${s.student.name} (${s.student.klass})`
      : "Ej sparad elev";
  }

  const bestE = getEl("best-levelE");
  const bestC = getEl("best-levelC");
  const bestA = getEl("best-levelA");
  if (bestE) bestE.textContent = (s.best && s.best.E) || 0;
  if (bestC) bestC.textContent = (s.best && s.best.C) || 0;
  if (bestA) bestA.textContent = (s.best && s.best.A) || 0;

  const thresE = getEl("thres-levelE");
  const thresC = getEl("thres-levelC");
  const thresA = getEl("thres-levelA");
  if (thresE && s.thres && typeof s.thres.E === "number") thresE.textContent = s.thres.E;
  if (thresC && s.thres && typeof s.thres.C === "number") thresC.textContent = s.thres.C;
  if (thresA && s.thres && typeof s.thres.A === "number") thresA.textContent = s.thres.A;

  const cardE = getEl("card-levelE");
  const cardC = getEl("card-levelC");
  const cardA = getEl("card-levelA");
  const btnE = getEl("start-levelE");
  const btnC = getEl("start-levelC");
  const btnA = getEl("start-levelA");
  const badgeE = getEl("badge-levelE");
  const badgeC = getEl("badge-levelC");
  const badgeA = getEl("badge-levelA");

  if (cardE && btnE && badgeE) {
    if (hasStudent) {
      cardE.classList.remove("locked");
      btnE.disabled = false;
      badgeE.textContent = "Starta";
      badgeE.classList.remove("badge-lock");
      badgeE.classList.add("badge-ok");
    } else {
      cardE.classList.add("locked");
      btnE.disabled = true;
      badgeE.textContent = "L√•st";
      badgeE.classList.remove("badge-ok");
      badgeE.classList.add("badge-lock");
    }
  }

  if (cardC && btnC && badgeC) {
    if (s.unlocked && s.unlocked.C) {
      cardC.classList.remove("locked");
      btnC.disabled = false;
      badgeC.textContent = "Uppl√•st";
      badgeC.classList.remove("badge-lock");
      badgeC.classList.add("badge-ok");
    } else {
      cardC.classList.add("locked");
      btnC.disabled = true;
      badgeC.textContent = "L√•st";
      badgeC.classList.remove("badge-ok");
      badgeC.classList.add("badge-lock");
    }
  }

  if (cardA && btnA && badgeA) {
    if (s.unlocked && s.unlocked.A) {
      cardA.classList.remove("locked");
      btnA.disabled = false;
      badgeA.textContent = "Uppl√•st";
      badgeA.classList.remove("badge-lock");
      badgeA.classList.add("badge-ok");
    } else {
      cardA.classList.add("locked");
      btnA.disabled = true;
      badgeA.textContent = "L√•st";
      badgeA.classList.remove("badge-ok");
      badgeA.classList.add("badge-lock");
    }
  }

  const who = getEl("whoPlays");
  if (who) {
    who.textContent = hasStudent
      ? `${s.student.name} (${s.student.klass})`
      : "Ingen elev vald.";
  }

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const studentCard = getEl("studentCard");

  const isPlaying = typeof currentLevel !== "undefined" && !!currentLevel;
  const isResultVisible = resultSection && !resultSection.classList.contains("hidden");

  if (studentCard) {
    studentCard.classList.toggle("hidden", isPlaying || isResultVisible);
  }

  updateAllProgressionUI();
}

/* =========================
   4b ‚Äì Spel-logik (fr√•gerendering & niv√•er)
   ========================= */

function renderDragQuestion(q, index, host) {
  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"}) ‚Äì Drag & Drop`;
  container.appendChild(header);

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.flexWrap = "wrap";
  wrapper.style.gap = "12px";
  wrapper.style.marginTop = "6px";

  const sourcesCol = document.createElement("div");
  sourcesCol.style.flex = "1 1 180px";

  const targetsCol = document.createElement("div");
  targetsCol.style.flex = "2 1 260px";

  const srcTitle = document.createElement("div");
  srcTitle.className = "mini";
  srcTitle.textContent = "Kort att dra:";
  sourcesCol.appendChild(srcTitle);

  const srcZone = document.createElement("div");
  srcZone.style.border = "1px dashed #1f2937";
  srcZone.style.borderRadius = "8px";
  srcZone.style.padding = "6px";
  srcZone.style.minHeight = "40px";
  srcZone.style.display = "flex";
  srcZone.style.flexWrap = "wrap";
  srcZone.style.gap = "4px";
  sourcesCol.appendChild(srcZone);

  const tgtTitle = document.createElement("div");
  tgtTitle.className = "mini";
  tgtTitle.textContent = "Kategori-rutor:";
  targetsCol.appendChild(tgtTitle);

  const tgtZone = document.createElement("div");
  tgtZone.style.display = "flex";
  tgtZone.style.flexWrap = "wrap";
  tgtZone.style.gap = "8px";
  targetsCol.appendChild(tgtZone);

  wrapper.appendChild(sourcesCol);
  wrapper.appendChild(targetsCol);
  container.appendChild(wrapper);

  const sources = Array.isArray(q.dragSources) ? q.dragSources : [];
  const targets = Array.isArray(q.dragTargets) ? q.dragTargets : [];
  const answers = {};
  currentAnswers[index] = answers;

  function makeDraggableChip(src) {
    const chip = document.createElement("div");
    chip.textContent = src.label;
    chip.draggable = true;
    chip.dataset.itemId = src.id;
    chip.className = "chip";
    chip.style.cursor = "grab";
    chip.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", src.id);
    });
    return chip;
  }

  function setupDropTarget(el, targetId) {
    el.addEventListener("dragover", (ev) => ev.preventDefault());
    el.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      el.appendChild(existing);

      if (targetId === null) delete answers[itemId];
      else answers[itemId] = targetId;
    });
  }

  setupDropTarget(srcZone, null);

  sources.forEach((src) => {
    const chip = makeDraggableChip(src);
    srcZone.appendChild(chip);
  });

  targets.forEach((tgt) => {
    const box = document.createElement("div");
    box.style.border = "1px solid #1f2937";
    box.style.borderRadius = "8px";
    box.style.padding = "6px";
    box.style.minHeight = "46px";
    box.style.minWidth = "110px";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "4px";

    const cap = document.createElement("div");
    cap.className = "mini";
    cap.textContent = tgt.label;
    box.appendChild(cap);

    const slot = document.createElement("div");
    slot.style.display = "flex";
    slot.style.flexWrap = "wrap";
    slot.style.gap = "4px";
    box.appendChild(slot);

    box.addEventListener("dragover", (ev) => ev.preventDefault());
    box.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;
      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;
      slot.appendChild(existing);
      answers[itemId] = tgt.id;
    });

    tgtZone.appendChild(box);
  });

  host.appendChild(container);
}

function renderQuestionItem(q, index, host) {
  if (q.type === "drag") {
    renderDragQuestion(q, index, host);
    return;
  }

  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"})`;
  container.appendChild(header);

  if (q.type === "img" && q.imgDataUrl) {
    const img = document.createElement("img");
    img.src = q.imgDataUrl;
    img.alt = "Bildfr√•ga";
    container.appendChild(img);
  }

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const optionsList = document.createElement("div");
  optionsList.className = "options-list";
  (q.options || []).forEach((opt, optIndex) => {
    const label = document.createElement("label");
    label.className = "option-label";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = `q-${index}`;
    input.value = String(optIndex);
    input.addEventListener("change", () => {
      currentAnswers[index] = optIndex;
    });

    const span = document.createElement("span");
    span.textContent = opt;

    label.appendChild(input);
    label.appendChild(span);
    optionsList.appendChild(label);
  });
  container.appendChild(optionsList);

  host.appendChild(container);
}

function startLevel(level) {
  if (!ensureStudentSet()) return;

  const s = loadState();
  const allQuestions = []
    .concat(s.bank.mcq || [])
    .concat(s.bank.img || [])
    .concat(s.bank.drag || []);

  const pool = allQuestions.filter((q) => (q.level || "E") === level);
  if (!pool.length) {
    alert("Det finns inga fr√•gor p√• denna niv√• √§nnu.");
    return;
  }

  currentLevel = level;
  currentQuestions = shuffle(pool);
  currentAnswers = new Array(currentQuestions.length).fill(null);

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const questionsHost = getEl("questions");

  if (resultSection) resultSection.classList.add("hidden");
  if (playSection) playSection.classList.remove("hidden");
  if (questionsHost) {
    questionsHost.innerHTML = "";
    currentQuestions.forEach((q, idx) => renderQuestionItem(q, idx, questionsHost));
  }

  const title = getEl("play-title");
  const who = getEl("whoPlays");
  if (title) {
    if (level === "E") title.textContent = "Niv√• 1 ‚Äì Grundniv√• (E)";
    else if (level === "C") title.textContent = "Niv√• 2 ‚Äì Mellanniv√• (C)";
    else title.textContent = "Niv√• 3 ‚Äì Avancerad (A)";
  }
  if (who) {
    who.textContent = `${s.student.name} (${s.student.klass})`;
  }

  syncUI();
}

function finishLevel() {
  if (!currentLevel || !currentQuestions.length) {
    alert("Ingen niv√• √§r aktiv.");
    return;
  }

  const s = loadState();
  const goals = normalizeGoalsMap(s);
  let correctCount = 0;
  let pointsGained = 0;
  let allCorrect = true;

  if (!s.progression || typeof s.progression !== "object") {
    s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  }
  s.progression.totalPoints = s.progression.totalPoints || 0;
  s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
  s.progression.correctByGoalId = s.progression.correctByGoalId || {};

  const wrongByGoal = s.progression.wrongByGoalId;
  const correctByGoal = s.progression.correctByGoalId;

  const lvl = currentLevel;
  const basePointsPerQuestion =
    lvl === "A" ? 3 :
    lvl === "C" ? 2 : 1;

  currentQuestions.forEach((q, index) => {
    const ansVal = currentAnswers[index];
    let isCorrect = false;

    if (q.type === "drag") {
      const correctMap = q.correctMap || {};
      const keys = Object.keys(correctMap);
      if (!keys.length) {
        isCorrect = false;
      } else if (!ansVal || typeof ansVal !== "object") {
        isCorrect = false;
      } else {
        let allOk = true;
        for (const itemId of keys) {
          if (!ansVal[itemId] || ansVal[itemId] !== correctMap[itemId]) {
            allOk = false;
            break;
          }
        }
        isCorrect = allOk;
      }
    } else {
      if (ansVal != null) {
        const correctIndex = typeof q.answer === "number" ? q.answer : q.correct;
        isCorrect = ansVal === correctIndex;
      } else {
        isCorrect = false;
      }
    }

    if (isCorrect) {
      correctCount++;
      pointsGained += basePointsPerQuestion;
    } else {
      allCorrect = false;
    }

    const links = getLinksForQuestion(q, goals);
    if (links && links.length) {
      links.forEach((lnk) => {
        const key = String(lnk.id);
        if (isCorrect) correctByGoal[key] = (correctByGoal[key] || 0) + 1;
        else wrongByGoal[key] = (wrongByGoal[key] || 0) + 1;
      });
    }
  });

  const total = currentQuestions.length;
  const percentage = total ? Math.round((correctCount / total) * 100) : 0;
  const threshold = (s.thres && s.thres[lvl] != null) ? s.thres[lvl] : 70;

  if (!s.best) s.best = { E: 0, C: 0, A: 0 };
  if (percentage > (s.best[lvl] || 0)) s.best[lvl] = percentage;

  if (!s.unlocked) s.unlocked = { C: false, A: false };
  if (lvl === "E" && percentage >= threshold) s.unlocked.C = true;
  if (lvl === "C" && percentage >= threshold) s.unlocked.A = true;

  if (total > 0 && allCorrect) pointsGained += 5;

  s.progression.totalPoints += pointsGained;
  const totalPointsAfter = s.progression.totalPoints;

  const nowIso = new Date().toISOString();
  const lastResult = {
    level: lvl,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    timestamp: nowIso
  };
  s.progression.lastResult = lastResult;

  if (!Array.isArray(s.highscores)) s.highscores = [];
  const id = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
  const newEntry = {
    id,
    name: s.student.name || "Elev",
    klass: s.student.klass || "-",
    points: totalPointsAfter,
    level: lvl,
    score: percentage,
    updatedAt: nowIso
  };
  const idx = s.highscores.findIndex((e) => e.id === id);
  if (idx >= 0) {
    if ((newEntry.points || 0) >= (s.highscores[idx].points || 0)) s.highscores[idx] = newEntry;
  } else {
    s.highscores.push(newEntry);
  }

  saveState(s);

  lastSubmission = {
    level: lvl,
    studentName: s.student.name,
    studentClass: s.student.klass,
    timestamp: nowIso,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    answers: currentAnswers.slice(),
    questions: currentQuestions.map((q) => ({
      q: q.q || q.text || "",
      type: q.type || "mcq",
      level: q.level || lvl,
      answer: typeof q.answer === "number" ? q.answer : q.correct,
      goal: q.goal || null,
      parts: q.parts || null
    }))
  };

  const playSection = getEl("play");
  const resultSection = getEl("result");
  if (playSection) playSection.classList.add("hidden");
  if (resultSection) resultSection.classList.remove("hidden");

  const scoreText = getEl("scoreText");
  const scoreDetail = getEl("scoreDetail");
  const resName = getEl("resName");
  const resClass = getEl("resClass");
  const passBadge = getEl("passBadge");
  const unlockText = getEl("unlockText");

  if (scoreText) scoreText.innerHTML = `${percentage}%<span> resultat</span>`;
  if (scoreDetail) {
    scoreDetail.textContent =
      `${correctCount}/${total} r√§tt ‚Äì niv√•po√§ng: +${pointsGained}p, totalt: ${totalPointsAfter}p`;
  }
  if (resName) resName.textContent = s.student.name || "-";
  if (resClass) resClass.textContent = s.student.klass || "-";

  if (passBadge) {
    const passed = percentage >= threshold;
    if (passed) {
      passBadge.className = "badge-pass";
      passBadge.textContent = "Godk√§nd niv√•";
    } else {
      passBadge.className = "badge-fail";
      passBadge.textContent = "Inte godk√§nd √§nnu";
    }
  }

  if (unlockText) {
    let txt = "";
    if (lvl === "E" && s.unlocked.C) txt = "Niv√• 2 (C) √§r nu uppl√•st.";
    else if (lvl === "C" && s.unlocked.A) txt = "Niv√• 3 (A) √§r nu uppl√•st.";
    unlockText.textContent = txt;
  }

  currentLevel = null;
  currentQuestions = [];
  currentAnswers = [];

  updateAllProgressionUI();
  syncUI();
}
</script>
<!-- slut SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->


<!-- start SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post, l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->
<script>
"use strict";

/* Hj√§lpfunktion f√∂r att slippa getElementById √∂verallt */
function getEl(id) {
  return document.getElementById(id);
}

/* =========================
   5b ‚Äì L√§rarl√∂senord & status
   ========================= */

function showTeacherPasswordInStatus() {
  const s = loadState();
  const statusEl = getEl("passwordStatus");
  if (statusEl && s.teacherPassword) {
    statusEl.textContent = `Aktuellt l√§rarl√∂senord: ${s.teacherPassword}`;
  } else if (statusEl) {
    statusEl.textContent = "";
  }
}

/* =========================
   5c ‚Äì L√§rarl√§ge: gate + modal
   ========================= */

function openTeacherGate() {
  const gate = getEl("teacherGate");
  const input = getEl("teacherPasswordInput");
  const text = getEl("teacherGateText");
  const s = loadState();

  if (gate) gate.classList.remove("hidden");
  if (input) {
    input.value = "";
    input.type = "password";
    input.focus();
  }

  if (text) {
    if (s.teacherPassword) {
      text.textContent = "Ange l√§rarl√∂senord f√∂r att √∂ppna l√§rarl√§get.";
    } else {
      text.textContent = "F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.";
    }
  }
}

function closeTeacherGate() {
  const gate = getEl("teacherGate");
  if (gate) gate.classList.add("hidden");
}

function openTeacherModal() {
  const modal = getEl("teacherModal");
  if (modal) modal.classList.remove("hidden");
}

function closeTeacherModal() {
  const modal = getEl("teacherModal");
  if (modal) modal.classList.add("hidden");
}

function handleTeacherConfirm() {
  const input = getEl("teacherPasswordInput");
  const text = getEl("teacherGateText");
  if (!input) return;

  const entered = input.value.trim();
  if (!entered) {
    alert("Skriv in ett l√∂senord.");
    return;
  }

  const s = loadState();

  // F√∂rsta g√•ngen: s√§tt l√∂senordet
  if (!s.teacherPassword) {
    s.teacherPassword = entered;
    saveState(s);
    showTeacherPasswordInStatus();
    if (text) text.textContent = "L√∂senord sparat. √ñppnar l√§rarl√§ge.";
    closeTeacherGate();
    openTeacherModal();
    return;
  }

  // Efter√•t: kontrollera l√∂senordet
  if (s.teacherPassword === entered) {
    if (text) text.textContent = "L√∂senord OK. √ñppnar l√§rarl√§ge.";
    closeTeacherGate();
    openTeacherModal();
  } else {
    if (text) text.textContent = "Fel l√∂senord. F√∂rs√∂k igen.";
    input.value = "";
    input.focus();
  }
}

/* =========================
   5d ‚Äì Fliknavigering i l√§rarmodal
   ========================= */

function setupTabNavigation() {
  const tabButtons = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");

  if (!tabButtons.length || !panels.length) return;

  function activateTab(tabId) {
    tabButtons.forEach((btn) => {
      const isActive = btn.getAttribute("data-tab") === tabId;
      if (isActive) btn.classList.add("active");
      else btn.classList.remove("active");
    });

    panels.forEach((panel) => {
      const panelId = panel.getAttribute("data-panel");
      panel.classList.toggle("hidden", panelId !== tabId);
    });
  }

  tabButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tabId = btn.getAttribute("data-tab");
      if (!tabId) return;
      activateTab(tabId);
    });
  });

  // S√§kerst√§ll att "settings" √§r aktiv som start (om den finns)
  const defaultTab = document.querySelector('.tab-btn[data-tab="settings"]');
  if (defaultTab) activateTab("settings");
}

/* =========================
   5e ‚Äì Bankstatus (UI)
   ========================= */

function updateBankStatusUI() {
  const listEl = getEl("cloudBankList");
  if (!listEl) return;

  const hostCard = listEl.closest(".card");
  if (!hostCard) return;

  let statusEl = getEl("bankStatus");
  if (!statusEl) {
    statusEl = document.createElement("p");
    statusEl.id = "bankStatus";
    statusEl.className = "mini";
    statusEl.style.marginTop = "6px";
  }

  // S√§kerst√§ll att status ligger precis f√∂re listan
  if (statusEl.parentNode !== hostCard) {
    if (statusEl.parentNode) statusEl.parentNode.removeChild(statusEl);
    hostCard.insertBefore(statusEl, listEl);
  } else if (statusEl.nextSibling !== listEl) {
    hostCard.insertBefore(statusEl, listEl);
  }

  const s = loadState();
  const bank = s.bank || {};
  const mcqCount = Array.isArray(bank.mcq) ? bank.mcq.length : 0;
  const imgCount = Array.isArray(bank.img) ? bank.img.length : 0;
  const dragCount = Array.isArray(bank.drag) ? bank.drag.length : 0;
  const total = mcqCount + imgCount + dragCount;

  if (!total) {
    statusEl.textContent = "Status: Ingen fr√•gebank laddad.";
  } else {
    statusEl.textContent =
      `Status: Aktiv bank med ${total} fr√•gor ` +
      `(MCQ: ${mcqCount}, bild: ${imgCount}, drag & drop: ${dragCount}).`;
  }
}

/* =========================
   5f ‚Äì Initiering & knappar
   ========================= */

function initApp() {
  console.log("initApp start");

  // 1. S√§kerst√§ll fr√•gebank (merga embedded-data om tom)
  let s = loadState();
  const hasBank =
    s.bank &&
    (
      (Array.isArray(s.bank.mcq) && s.bank.mcq.length) ||
      (Array.isArray(s.bank.img) && s.bank.img.length) ||
      (Array.isArray(s.bank.drag) && s.bank.drag.length)
    );

  if (!hasBank && typeof mergeEmbeddedBank === "function") {
    console.log("Ingen lokal bank ‚Äì mergar embedded-data");
    s = mergeEmbeddedBank(s);
    saveState(s);
  }

  // 2. Initiera inst√§llningsdelar om de finns
  if (typeof initTeacherEmailSettings === "function") initTeacherEmailSettings();
  if (typeof initThresholdSettings === "function") initThresholdSettings();
  if (typeof initTeacherPasswordSettings === "function") initTeacherPasswordSettings();
  showTeacherPasswordInStatus();

  if (typeof initGoalsMap === "function") initGoalsMap();
  if (typeof initQuestionForms === "function") initQuestionForms();
  if (typeof initImageQuestionsEditor === "function") initImageQuestionsEditor();
  if (typeof initDragDropQuestionsEditor === "function") initDragDropQuestionsEditor();

  // Fliknavigering
  setupTabNavigation();

  if (typeof setupCloudBankUI === "function") setupCloudBankUI();
  if (typeof syncUI === "function") syncUI();

  // Uppdatera visuell bankstatus
  updateBankStatusUI();

  /* ---------- Elevyta: knappar ---------- */

  const btnSaveStudent = getEl("btnSaveStudent");
  if (btnSaveStudent) {
    btnSaveStudent.addEventListener("click", handleSaveStudent);
  }

  const btnStartE = getEl("start-levelE");
  const btnStartC = getEl("start-levelC");
  const btnStartA = getEl("start-levelA");
  if (btnStartE) btnStartE.addEventListener("click", () => startLevel("E"));
  if (btnStartC) btnStartC.addEventListener("click", () => startLevel("C"));
  if (btnStartA) btnStartA.addEventListener("click", () => startLevel("A"));

  const btnFinish = getEl("btnFinish");
  if (btnFinish) btnFinish.addEventListener("click", finishLevel);

  const btnBack = getEl("btnBack");
  if (btnBack) {
    btnBack.addEventListener("click", () => {
      const result = getEl("result");
      const play = getEl("play");
      if (result) result.classList.add("hidden");
      if (play) play.classList.add("hidden");
      const studentCard = getEl("studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      if (typeof syncUI === "function") syncUI();
    });
  }

  const btnCancel = getEl("btnCancel");
  if (btnCancel) {
    btnCancel.addEventListener("click", () => {
      if (typeof currentLevel !== "undefined") currentLevel = null;
      if (typeof currentQuestions !== "undefined") currentQuestions = [];
      if (typeof currentAnswers !== "undefined") currentAnswers = [];
      const play = getEl("play");
      const result = getEl("result");
      if (play) play.classList.add("hidden");
      if (result) result.classList.add("hidden");
      const studentCard = getEl("studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      if (typeof syncUI === "function") syncUI();
    });
  }

  const btnSubmitGame = getEl("btnSubmitGame");
  if (btnSubmitGame) {
    btnSubmitGame.addEventListener("click", async () => {
      try {
        await saveCurrentResultToFirestore();
        alert("Ditt resultat √§r inl√§mnat till l√§raren.");
      } catch (err) {
        console.error("Fel vid inl√§mning:", err);
        alert("Kunde inte l√§mna in resultatet. F√∂rs√∂k igen eller kontakta l√§raren.");
      }
    });
  }

  /* ---------- L√§rarl√§ge: knappar ---------- */

  const btnTeacherMode = getEl("btnTeacherMode");
  if (btnTeacherMode) {
    btnTeacherMode.addEventListener("click", openTeacherGate);
  }

  const btnTeacherCancel = getEl("btnTeacherCancel");
  if (btnTeacherCancel) {
    btnTeacherCancel.addEventListener("click", closeTeacherGate);
  }

  const btnTeacherConfirm = getEl("btnTeacherConfirm");
  if (btnTeacherConfirm) {
    btnTeacherConfirm.addEventListener("click", handleTeacherConfirm);
  }

  const btnCloseTeacher = getEl("btnCloseTeacher");
  if (btnCloseTeacher) {
    btnCloseTeacher.addEventListener("click", closeTeacherModal);
  }

  /* ---------- Inst√§llningar: tr√∂sklar, e-post, l√∂sen ---------- */

  const btnSaveThresholds = getEl("btnSaveThresholds");
  if (btnSaveThresholds && typeof handleSaveThresholds === "function") {
    btnSaveThresholds.addEventListener("click", handleSaveThresholds);
  }

  // (E-postfunktionen √§r borttagen ‚Äì vi beh√•ller endast ev. spar-knappen om du vill lagra adressen lokalt)
  const btnSaveTeacherEmail = getEl("btnSaveTeacherEmail");
  if (btnSaveTeacherEmail && typeof handleSaveTeacherEmail === "function") {
    btnSaveTeacherEmail.addEventListener("click", handleSaveTeacherEmail);
  }

  const btnChangeTeacherPassword = getEl("btnChangeTeacherPassword");
  if (btnChangeTeacherPassword && typeof handleChangeTeacherPassword === "function") {
    btnChangeTeacherPassword.addEventListener("click", handleChangeTeacherPassword);
  }

  /* ---------- Delm√•l/delbitar ---------- */

  const btnAddGoalPart = getEl("btnAddGoalPart");
  if (btnAddGoalPart && typeof handleAddGoalPart === "function") {
    btnAddGoalPart.addEventListener("click", handleAddGoalPart);
  }

  const btnSaveGoalsMap = getEl("btnSaveGoalsMap");
  if (btnSaveGoalsMap && typeof handleSaveGoalsMap === "function") {
    btnSaveGoalsMap.addEventListener("click", handleSaveGoalsMap);
  }

  const btnClearGoalsMap = getEl("btnClearGoalsMap");
  if (btnClearGoalsMap && typeof handleClearGoalsMap === "function") {
    btnClearGoalsMap.addEventListener("click", handleClearGoalsMap);
  }

  /* ---------- Rensa / nollst√§ll elevdata ---------- */

  const btnClearStudentData = getEl("btnClearStudentData");
  if (btnClearStudentData && typeof handleClearStudentData === "function") {
    btnClearStudentData.addEventListener("click", handleClearStudentData);
  }

  const btnResetGameData = getEl("btnResetGameData");
  if (btnResetGameData && typeof handleResetGameData === "function") {
    btnResetGameData.addEventListener("click", handleResetGameData);
  }

  /* ---------- Fr√•gebank & Firebase ---------- */

  const btnLoadCloudBanks = getEl("btnLoadCloudBanks");
  if (btnLoadCloudBanks && typeof handleLoadCloudBanks === "function") {
    btnLoadCloudBanks.addEventListener("click", () => {
      // Om l√§raren inte √§r inloggad kan Firestore ge "Missing or insufficient permissions"
      if (typeof currentTeacherUser !== "undefined" && !currentTeacherUser) {
        alert("Logga in med Google f√∂rst f√∂r att ladda moln-bankar.");
        return;
      }
      handleLoadCloudBanks();
      updateBankStatusUI();
    });
  }

  const btnSaveToCloud = getEl("btnSaveToCloud");
  if (btnSaveToCloud && typeof handleSaveToCloud === "function") {
    btnSaveToCloud.addEventListener("click", () => {
      handleSaveToCloud();
      updateBankStatusUI();
    });
  }

  const btnExportBank = getEl("btnExportBank");
  if (btnExportBank && typeof handleExportBank === "function") {
    btnExportBank.addEventListener("click", () => {
      handleExportBank();
      updateBankStatusUI();
    });
  }

  const fileImport = getEl("fileImport");
  if (fileImport && typeof handleImportBank === "function") {
    fileImport.addEventListener("change", (evt) => {
      handleImportBank(evt);
      updateBankStatusUI();
    });
  }

  const btnGoogleLogin = getEl("btnGooglePlaceholder");
  if (btnGoogleLogin && typeof handleGoogleLogin === "function") {
    btnGoogleLogin.addEventListener("click", handleGoogleLogin);
  }

  const btnGoogleLogout = getEl("btnGoogleLogout");
  if (btnGoogleLogout && typeof handleGoogleLogout === "function") {
    btnGoogleLogout.addEventListener("click", handleGoogleLogout);
  }

  // Publik bank/elevl√§nk (om UI finns)
  const btnPublishSharedBank = getEl("btnPublishSharedBank");
  if (btnPublishSharedBank && typeof handlePublishSharedBank === "function") {
    btnPublishSharedBank.addEventListener("click", handlePublishSharedBank);
  }

  console.log("initApp klar ‚Äì knappar kopplade");
}

/* =========================
   5g ‚Äì DOMContentLoaded
   ========================= */

document.addEventListener("DOMContentLoaded", function () {
  if (typeof initFirebase === "function") {
    try {
      initFirebase();
      console.log("Firebase init OK");
    } catch (e) {
      console.error("Fel vid initFirebase:", e);
    }
  }

  try {
    initApp();
  } catch (e) {
    console.error("Fel vid initApp:", e);
  }
});

/* Testa nu. Om n√•got fortfarande saknas: klistra in konsol-loggen + vad som inte syns. */
/* Ingen mer kod i denna leverans ‚Äì detta √§r hela SEKTION 5. */
</script>
<!-- slut SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post, l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->




<!-- start SEKTION 6: AVSLUTANDE TAGGAR -->
</body>
</html>
<!-- slut SEKTION 6: AVSLUTANDE TAGGAR -->
