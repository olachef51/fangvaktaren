<!-- start SEKTION 1: HEAD & STIL -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>F√•ngvaktaren ‚Äì Progressionsspel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --accent-e:#b45309;
      --accent-c:#2563eb;
      --accent-a:#7c3aed;
      --accent-danger:#ef4444;
      --accent-info:#38bdf8;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --chip:#020617;
    }

    *{box-sizing:border-box;}

    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#020617 0,#020617 40%,#000 100%);
      color:var(--text);
    }

    body{
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:960px;
      margin:0 auto;
      min-height:100vh;
      padding:12px 12px 32px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(15,23,42,.85));
      border:1px solid #1f2937;
      box-shadow:0 0 40px rgba(15,23,42,.9);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(10px);
    }

    .header-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .title-block h1{
      margin:0;
      font-size:1.2rem;
      letter-spacing:.03em;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:999px;
      background:radial-gradient(circle,var(--accent-e),#111827);
      color:#fff;
      font-weight:700;
      font-size:.9rem;
      box-shadow:0 0 12px rgba(180,83,9,.8);
    }

    /* ---------- Buttons ---------- */

    .btn{
      --btn-bg:#111827;
      --btn-border:rgba(75,85,99,.9);
      border-radius:999px;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      padding:6px 12px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
      transition:
        background-color .15s ease,
        border-color .15s ease,
        box-shadow .18s ease,
        transform .12s ease,
        opacity .15s ease;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 0 0 rgba(59,130,246,0);
    }

    .btn-sm{
      padding:5px 10px;
      font-size:.8rem;
    }

    .btn-primary{
      --btn-bg:linear-gradient(135deg,var(--accent-e),var(--accent-c));
      --btn-border:rgba(96,165,250,.9);
      color:#f9fafb;
      box-shadow:
        0 0 0 1px rgba(148,163,184,.4),
        0 0 18px rgba(56,189,248,.45);
    }

    .btn-danger{
      --btn-bg:rgba(127,29,29,.95);
      --btn-border:rgba(239,68,68,.9);
      box-shadow:
        0 0 0 1px rgba(248,113,113,.5),
        0 0 14px rgba(248,113,113,.4);
    }

    .btn-secondary{
      --btn-bg:#020617;
      --btn-border:rgba(75,85,99,.8);
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(148,163,184,.6),
        0 0 24px rgba(59,130,246,.55);
      opacity:.97;
    }

    .btn:active{
      transform:translateY(0);
      box-shadow:
        0 0 0 1px rgba(107,114,128,.8),
        0 0 12px rgba(37,99,235,.45);
      opacity:.92;
    }

    .btn:disabled,
    .btn[disabled]{
      opacity:.45;
      cursor:default;
      box-shadow:
        0 0 0 1px rgba(31,41,55,1),
        0 0 0 rgba(0,0,0,0);
      transform:none;
    }

    /* Spara elev ‚Äì tydlig gr√∂n, fyllig knapp */
    #btnSaveStudent{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      border-color:rgba(34,197,94,1);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 20px rgba(34,197,94,.75);
    }

    #btnSaveStudent:hover{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 26px rgba(34,197,94,.9);
      transform:translateY(-1px);
    }

    #btnSaveStudent:active{
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 14px rgba(34,197,94,.8);
      transform:translateY(0);
    }

    #btnSaveStudent:disabled{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      opacity:.45;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 0 rgba(0,0,0,0);
    }

    /* L√§rarl√§ge ‚Äì m√∂rk bakgrund, gr√∂n kontur (outline-knapp) */
    #btnTeacherMode{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherMode:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherMode:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* L√∂senords-popup: ‚ÄúForts√§tt‚Äù ‚Äì samma gr√∂na kontur som l√§rarl√§ge */
    #btnTeacherConfirm{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherConfirm:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherConfirm:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* Spara niv√•gr√§nser ‚Äì gr√∂n kontur, samma stil */
    #btnSaveThresholds{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnSaveThresholds:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnSaveThresholds:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* ---------- Layout helpers ---------- */

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1 1 120px;
      min-width:0;
    }

    label{
      font-size:.7rem;
      color:var(--muted);
    }

    .small-label{
      font-size:.7rem;
      color:var(--muted);
    }

    .input,
    .input-number{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:.8rem;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }

    .input-number{
      appearance:textfield;
      -moz-appearance:textfield;
    }

    .input-number::-webkit-outer-spin-button,
    .input-number::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    .input:focus,
    .input-number:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
      background:#020617;
    }

    .mini{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.4;
    }

    .hidden{
      display:none !important;
    }

    /* ---------- Elevkort ---------- */

    .student-card{
      background:radial-gradient(circle at top left,#020617,#020617 55%,#000 100%);
      border-radius:16px;
      padding:12px 12px 14px;
      border:1px solid rgba(31,41,55,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .student-main-row{
      align-items:flex-end;
    }

    .student-save-field{
      max-width:180px;
    }

    .student-status-row{
      margin-top:2px;
    }

    .student-saved-label{
      font-size:.75rem;
      color:var(--muted);
    }

    .student-stats-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
    }

    .score-box{
      flex:1 1 160px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 55%,#000 100%);
      display:flex;
      flex-direction:column;
      gap:2px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 20px rgba(56,189,248,.4),
        0 12px 28px rgba(15,23,42,.9);
    }

    .score-label{
      font-size:.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .score-value{
      font-size:1rem;
      font-weight:600;
    }

    /* ---------- Niv√•-kort ---------- */

    .levels-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }

    .level-card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.9);
    }

    .level-card.locked{
      opacity:.7;
      filter:saturate(.7);
    }

    .level-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .level-title span:first-child{
      font-weight:600;
      font-size:.9rem;
    }

    .level-title small{
      display:block;
      font-size:.7rem;
      color:var(--muted);
    }

    .level-body{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:.78rem;
    }

    .level-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-top:4px;
    }

    .badge{
      border-radius:999px;
      padding:2px 8px;
      font-size:.7rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
    }

    .badge-lock{
      color:#fbbf24;
      border-color:rgba(245,158,11,.7);
      box-shadow:0 0 12px rgba(245,158,11,.35);
    }

    .badge-ok{
      color:#4ade80;
      border-color:rgba(74,222,128,.9);
      box-shadow:0 0 16px rgba(22,163,74,.65);
    }

    .badge-pass{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 18px rgba(22,163,74,.7);
    }

    .badge-fail{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#991b1b,#ef4444);
      color:#fee2e2;
      box-shadow:
        0 0 0 1px rgba(127,29,29,1),
        0 0 18px rgba(248,113,113,.7);
    }

    /* ---------- Spelpanel / Resultat ---------- */

    .play-panel,
    .result-panel{
      margin-top:8px;
      padding:10px 10px 12px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
    }

    .play-header,
    .result-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .questions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:4px;
    }

    .question{
      padding:8px 9px;
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top left,#020617,#020617 60%,#020617 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 26px rgba(15,23,42,.9);
      font-size:.85rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .q-text{
      font-size:.85rem;
      margin-top:2px;
    }

    .options-list{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:2px;
    }

    .option-label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
      padding:4px 6px;
      border-radius:999px;
      background:#020617;
      border:1px solid rgba(31,41,55,1);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,transform .1s ease;
    }

    .option-label input{
      accent-color:var(--accent-c);
    }

    .option-label:hover{
      background:#020617;
      border-color:rgba(59,130,246,.7);
      box-shadow:
        0 0 0 1px rgba(59,130,246,.9),
        0 0 16px rgba(37,99,235,.6);
      transform:translateY(-1px);
    }

    .play-footer{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:.75rem;
    }

    .play-actions{
      display:flex;
      gap:6px;
    }

    .score{
      font-size:1.6rem;
      font-weight:700;
    }

    .score span{
      font-size:.8rem;
      font-weight:400;
      margin-left:4px;
      color:var(--muted);
    }

    .result-meta{
      font-size:.78rem;
      color:var(--muted);
      margin-top:2px;
    }

    .result-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ---------- Modal & gate ---------- */

    .gate-backdrop,
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
      backdrop-filter:blur(10px);
    }

    .gate-box{
      width:100%;
      max-width:320px;
      padding:14px 14px 16px;
      border-radius:16px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:.85rem;
    }

    .gate-actions{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }

    .modal{
      width:100%;
      max-width:980px;
      max-height:90vh;
      padding:12px 12px 14px;
      border-radius:18px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:4px;
    }

    .modal-body{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding-right:2px;
    }

    /* ---------- Flikar ---------- */

    .tab-nav{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
    }

    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(55,65,81,1);
      padding:4px 9px;
      font-size:.75rem;
      background:#020617;
      color:var(--muted);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,color .15s ease;
    }

    .tab-btn.active{
      color:#e5e7eb;
      border-color:rgba(96,165,250,1);
      background:linear-gradient(135deg,#0369a1,#4f46e5);
      box-shadow:
        0 0 0 1px rgba(37,99,235,1),
        0 0 20px rgba(56,189,248,.7);
    }

    .tab-panel{
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 16px 34px rgba(15,23,42,.95);
    }

    /* ---------- Cards & grids ---------- */

    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px 10px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.95);
      font-size:.82rem;
    }

    .card-full-width{
      grid-column:1/-1;
    }

    .card-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }

    .questions-editor{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .goals-list,
    .question-list{
      list-style:none;
      padding:0;
      margin:4px 0 0;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.8rem;
    }

    .question-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      flex-direction:column;
      gap:4px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    .question-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:2px;
    }

    .img-preview-box{
      border-radius:10px;
      border:1px dashed rgba(55,65,81,1);
      padding:6px;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .img-preview-box img{
      max-width:100%;
      border-radius:8px;
    }

    .img-thumb{
      width:64px;
      height:44px;
      border-radius:8px;
      border:1px solid rgba(31,41,55,1);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#020617;
      margin-right:6px;
    }

    .img-thumb img{
      max-width:100%;
      max-height:100%;
      object-fit:cover;
    }

    .question-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .chip{
      border-radius:999px;
      padding:3px 8px;
      font-size:.75rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 6px 14px rgba(15,23,42,.85);
    }

    /* Elevprogression ‚Äì rutorna staplas p√• h√∂jden (en kolumn) */
    .progress-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }

    .progress-box{
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 24px rgba(15,23,42,.9);
      font-size:.8rem;
    }

    .mini-card{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      padding:6px 7px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .mini-title{
      font-size:.82rem;
      font-weight:600;
    }

    /* ---------- Responsivitet ---------- */

    @media (max-width:640px){
      .app{
        padding:8px 8px 24px;
      }
      .app-header{
        padding:8px 9px;
      }
      .levels-grid{
        grid-template-columns:1fr;
      }
      .play-header,
      .result-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .play-footer{
        flex-direction:column;
        align-items:flex-start;
      }
      .modal{
        padding:10px;
      }
    }

    /* ---------- F√§rger f√∂r niv√•kort (E / C / A) ---------- */

    #card-levelE{
      background:radial-gradient(circle at top,#ea580c,#b45309 55%,#020617 100%);
      border-color:rgba(234,88,12,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(234,88,12,.9);
    }

    #card-levelC{
      background:radial-gradient(circle at top,#1d4ed8,#1e40af 55%,#020617 100%);
      border-color:rgba(37,99,235,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(37,99,235,.9);
    }

    #card-levelA{
      background:radial-gradient(circle at top,#7c3aed,#6d28d9 55%,#020617 100%);
      border-color:rgba(124,58,237,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(124,58,237,.9);
    }
  </style>
</head>
<!-- slut SEKTION 1: HEAD & STIL -->










<!-- start SEKTION 2: FIREBASE-BIBLIOTEK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<!-- slut SEKTION 2: FIREBASE-BIBLIOTEK -->


<!-- start SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <h1><span class="logo">F</span>F√•ngvaktaren</h1>
      </div>
      <button id="btnTeacherMode" class="btn btn-sm btn-primary">üîë L√§rarl√§ge</button>
    </header>

    <!-- Elevkort / namn, klass, po√§ng, highscore -->
    <section id="studentCard" class="student-card">
      <div class="row student-main-row">
        <div class="field">
          <label for="studentName">Namn</label>
          <input id="studentName" class="input" placeholder="Elevens namn..." autocomplete="off" />
        </div>
        <div class="field">
          <label for="studentClass">Klass</label>
          <input id="studentClass" class="input" placeholder="Klass..." autocomplete="off" />
        </div>
        <div class="field student-save-field">
          <label>&nbsp;</label>
          <button id="btnSaveStudent" class="btn btn-sm btn-primary" style="width:100%;">üíæ Spara elev</button>
        </div>
      </div>

      <div class="student-status-row">
        <span id="studentSaved" class="student-saved-label">Ej sparad elev</span>
      </div>

      <div class="student-stats-row">
        <div class="score-box glow-box">
          <div class="score-label">Po√§ng</div>
          <div class="score-value" id="studentPointsValue">0 p</div>
        </div>
        <div class="score-box glow-box">
          <div class="score-label">Highscore</div>
          <div class="score-value" id="highscoreSummary">
            Ingen highscore √§nnu.
          </div>
        </div>
      </div>
    </section>

    <!-- Niv√•kort -->
    <section class="levels-grid">
      <article id="card-levelE" class="level-card level-e locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 1</span>
            <small>Grundniv√• ‚Äì E</small>
          </div>
          <span id="badge-levelE" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelE">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelE">70</span>%</span>
          <span class="mini">L√•ses upp n√§r eleven sparat namn & klass.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• E-niv√•.</div>
          <button id="start-levelE" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 1</button>
        </div>
      </article>

      <article id="card-levelC" class="level-card level-c locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 2</span>
            <small>Mellanniv√• ‚Äì C</small>
          </div>
          <span id="badge-levelC" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelC">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelC">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 1 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• C-niv√•.</div>
          <button id="start-levelC" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 2</button>
        </div>
      </article>

      <article id="card-levelA" class="level-card level-a locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 3</span>
            <small>Avancerad ‚Äì A</small>
          </div>
          <span id="badge-levelA" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelA">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelA">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 2 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• A-niv√•.</div>
          <button id="start-levelA" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 3</button>
        </div>
      </article>
    </section>

    <!-- Spelpanel -->
    <section id="play" class="play-panel hidden">
      <header class="play-header">
        <div>
          <h2 id="play-title">Aktiv niv√•</h2>
          <small id="whoPlays">Ingen elev vald.</small>
        </div>
        <button id="btnCancel" class="btn btn-sm">‚¨ÖÔ∏è Avsluta utan att l√§mna in</button>
      </header>
      <div id="questions" class="questions">
        <div class="question mini">V√§lj en niv√• f√∂r att b√∂rja.</div>
      </div>
      <footer class="play-footer">
        <div class="mini">
          Svar registreras n√§r du klickar i alternativen eller sl√§pper kort i r√§tt ruta.
        </div>
        <div class="play-actions">
          <button id="btnSpeakQuestion" class="btn btn-sm">üîä L√§s upp fr√•gan</button>
          <button id="btnFinish" class="btn btn-sm btn-primary">‚úÖ L√§mna in niv√•</button>
        </div>
      </footer>
    </section>

    <!-- Resultatpanel -->
    <section id="result" class="result-panel hidden">
      <header class="result-header">
        <div>
          <div class="score" id="scoreText">0%<span> resultat</span></div>
          <div id="scoreDetail" class="result-meta">0/0 po√§ng</div>
          <div class="result-meta">
            Elev: <span id="resName">-</span> (<span id="resClass">-</span>)
          </div>
        </div>
        <div>
          <div id="passBadge" class="badge-fail">Resultat</div>
          <div id="unlockText" class="result-meta"></div>
        </div>
      </header>

      <div class="result-actions" id="resultActionsNormal">
        <button id="btnBack" class="btn btn-sm">‚¨ÖÔ∏è Tillbaka till niv√•er</button>
        <button id="btnSubmitGame" class="btn btn-sm btn-primary">‚úâÔ∏è L√§mna in spel f√∂r po√§ng</button>
      </div>
    </section>
  </div>

  <!-- Embedded grundbank (kan vara tom eller kort) -->
  <script id="embedded-data" type="application/json">
  {
    "bank": {
      "mcq": [
        {
          "level": "E",
          "type": "mcq",
          "q": "Vad √§r viktigast f√∂rst n√§r du kommer till k√∂ket?",
          "options": ["Ta p√• f√∂rkl√§de", "Tv√§tta h√§nderna", "S√§tta p√• ugnen", "Smaka p√• maten"],
          "answer": 1
        },
        {
          "level": "C",
          "type": "mcq",
          "q": "En g√§st klagar p√• kall mat. Vad √§r ett bra f√∂rsta steg?",
          "options": ["Ignorera g√§sten", "Skylla p√• k√∂ket", "Be om urs√§kt och erbjuda l√∂sning", "S√§ga att det inte √§r ditt fel"],
          "answer": 2
        },
        {
          "level": "A",
          "type": "mcq",
          "q": "Du planerar en buff√©. Vad √§r viktigast f√∂r s√§ker livsmedelshantering?",
          "options": ["Att det ser fint ut", "Att alla r√§tter √§r varma samtidigt", "R√§tt temperaturer och tidsgr√§nser", "Att det finns m√•nga olika r√§tter"],
          "answer": 2
        }
      ]
    }
  }
  </script>

  <!-- L√§rarl√§ge ‚Äì Gate -->
  <div id="teacherGate" class="gate-backdrop hidden">
    <div class="gate-box">
      <h2>üîë L√§rarl√§ge</h2>
      <p id="teacherGateText">
        Ange l√§rarl√∂senord. F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.
      </p>
      <input id="teacherPasswordInput" class="input" type="password" placeholder="L√∂senord..." />
      <div class="gate-actions">
        <button id="btnTeacherCancel" class="btn btn-sm">Avbryt</button>
        <button id="btnTeacherConfirm" class="btn btn-sm btn-primary">Forts√§tt</button>
      </div>
    </div>
  </div>

  <!-- L√§rarl√§ge ‚Äì Modal -->
  <div id="teacherModal" class="modal-backdrop hidden">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h2>L√§rarl√§ge ‚Äì F√•ngvaktaren</h2>
          <small>Hantera inst√§llningar, fr√•gebank, bildfr√•gor, drag & drop, export och elevprogression.</small>
        </div>
        <button id="btnCloseTeacher" class="btn btn-sm">St√§ng</button>
      </header>

      <div class="modal-body">
        <!-- Flikar -->
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="settings" id="tab-settings">‚öôÔ∏è Inst√§llningar</button>
          <button class="tab-btn" data-tab="questions" id="tab-questions">üÖ∞Ô∏è Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="images" id="tab-images">üñºÔ∏è Bildfr√•gor</button>
          <button class="tab-btn" data-tab="dragdrop" id="tab-dragdrop">üéØ Drag & Drop</button>
          <button class="tab-btn" data-tab="progress" id="tab-progress">üìà Elevprogression</button>
          <button class="tab-btn" data-tab="bank" id="tab-bank">üóÇÔ∏è Fr√•gebank</button>
        </nav>

        <div class="tab-content">
          <!-- Inst√§llningar -->
          <section class="tab-panel" data-panel="settings">
            <div class="settings-grid">
              <div class="card">
                <h3>L√§rarl√∂senord</h3>
                <p>Det l√∂senord du anv√§nder f√∂r att √∂ppna l√§rarl√§get. H√§r kan du byta det.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputOldPassword">Nuvarande l√∂senord</label>
                    <input id="inputOldPassword" class="input" type="password" placeholder="L√§mna tomt om inget satt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPassword">Nytt l√∂senord</label>
                    <input id="inputNewPassword" class="input" type="password" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPasswordRepeat">Upprepa nytt l√∂senord</label>
                    <input id="inputNewPasswordRepeat" class="input" type="password" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnChangeTeacherPassword" class="btn btn-sm">üîê Spara nytt l√∂senord</button>
                </div>
                <p id="passwordStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Google-inloggning & uppladdning (l√§rare)</h3>
                <p>
                  Logga in med ditt Google-konto f√∂r att spara och ladda fr√•gebanker via Firebase.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label">Status</label>
                    <p id="googleStatus" class="mini">‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.</p>
                  </div>
                  <div class="field">
                    <button id="btnGooglePlaceholder" class="btn btn-sm" type="button">
                      üîó Logga in med Google
                    </button>
                  </div>
                  <div class="field">
                    <button id="btnGoogleLogout" class="btn btn-sm hidden" type="button">
                      üö™ Logga ut fr√•n Google
                    </button>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Gr√§ns f√∂r godk√§nt per niv√•</h3>
                <p>Justera procentgr√§ns f√∂r E, C och A. Anv√§nds som riktm√§rke f√∂r ‚ÄùGodk√§nd niv√•‚Äù.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputThresE">Niv√• 1 (E)</label>
                    <input id="inputThresE" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresC">Niv√• 2 (C)</label>
                    <input id="inputThresC" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresA">Niv√• 3 (A)</label>
                    <input id="inputThresA" type="number" min="0" max="100" class="input-number" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveThresholds" class="btn btn-sm btn-primary">üíæ Spara niv√•-gr√§nser</button>
                </div>
              </div>

              <div class="card">
                <h3>L√§rarens e-post</h3>
                <p>
                  Anv√§nds som mottagare n√§r eleven l√§mnar in resultat via e-post
                  (‚ÄùSkapa e-post‚Äù p√• Elevresultat/JSON).
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputTeacherEmail">E-postadress</label>
                    <input id="inputTeacherEmail" class="input" placeholder="namn@skola.se" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveTeacherEmail" class="btn btn-sm">üíæ Spara e-postadress</button>
                </div>
                <p id="teacherEmailStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Elevdata p√• denna enhet</h3>
                <p class="mini">
                  Dessa knappar p√•verkar bara den h√§r datorn/surfplattan. Anv√§nd dem n√§r du vill nollst√§lla progression lokalt.
                </p>
                <div class="card-row" style="margin-top:6px;gap:8px;flex-wrap:wrap;">
                  <button id="btnClearStudentData" class="btn btn-sm btn-danger" type="button">
                    üßπ Rensa elev + progression
                  </button>
                  <button id="btnResetGameData" class="btn btn-sm" type="button">
                    ‚ôªÔ∏è Nollst√§ll spelpo√§ng
                  </button>
                </div>
                <p id="resetStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Koppling: delm√•l & delbitar</h3>
                <p>
                  Skriv ett delm√•l och en delbit i taget. Klicka p√• ‚ÄùL√§gg till delbit‚Äù
                  f√∂r att l√§gga till i listan. ‚ÄùSpara‚Äù skriver listan till spelets minne
                  (localStorage). ‚ÄùTa bort alla‚Äù rensar listan.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputGoalSingle">Delm√•l</label>
                    <input id="inputGoalSingle" class="input" placeholder="t.ex. Delm√•l 5 ‚Äì Hygien i k√∂ket" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputPartSingle">Delbit</label>
                    <input id="inputPartSingle" class="input" placeholder="t.ex. 51‚Äì60 eller 51,52,53" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnAddGoalPart" class="btn btn-sm">‚ûï L√§gg till delbit</button>
                </div>
                <p id="goalsStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card card-full-width">
                <h3>Aktuella delm√•l och delbitar</h3>
                <p class="mini">Nedan visas de delm√•l och delbitar som √§r sparade i spelet just nu.</p>
                <ul id="goalsList" class="goals-list"></ul>
              </div>
            </div>
          </section>

          <!-- Flervalsfr√•gor -->
          <section class="tab-panel hidden" data-panel="questions">
            <div class="questions-editor">
              <h3>Hantera flervalsfr√•gor (MCQ)</h3>
              <p class="mini">
                L√§gg till nya flervalsfr√•gor, redigera eller importera m√•nga p√• en g√•ng.
              </p>

              <!-- Kort 1: Snabbimport via text -->
              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Snabbimport av flervalsfr√•gor</h3>
                <p class="mini">
                  Klistra in fr√•gor i formatet nedan. En asterisk (*) framf√∂r r√§tt svar.
                  En tom rad mellan fr√•gorna √§r bra men inte ett krav.
                </p>
                <pre class="mini" style="background:#020617;border-radius:6px;padding:8px;margin-top:4px;white-space:pre-wrap;">
Vilken av dessa √§r en proteink√§lla?
*Kycklingfil√©
√Ñpple
Gurka
P√§ron

Vilken av dessa √§r en frukt?
√Ñpple
*P√§ron
Potatis
Gurka
                </pre>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqJsonLevel">Niv√•</label>
                    <select id="mcqJsonLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqJsonGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqJsonGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <textarea
                  id="mcqJsonInput"
                  class="input"
                  rows="8"
                  placeholder="Klistra in dina fr√•gor h√§r..."
                  style="margin-top:8px;font-family:monospace;border-radius:6px;"
                ></textarea>
                <div style="margin-top:8px;display:flex;justify-content:flex-end;">
                  <button id="btnMcqJsonImport" class="btn btn-sm btn-primary" type="button">
                    üì• Importera fr√•gor fr√•n text
                  </button>
                </div>
              </div>

              <!-- Kort 2: L√§gg till / redigera fr√•ga -->
              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqLevel">Niv√•</label>
                    <select id="mcqLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqQuestion">Fr√•getext</label>
                    <input id="mcqQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <!-- EXAKT 4 alternativ: radio + textruta -->
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="mcqCorrect"
                        value="0"
                        id="mcqCorrect0"
                        style="margin-right:4px;"
                      />
                      Alternativ 1
                    </label>
                    <input id="mcqOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="mcqCorrect"
                        value="1"
                        id="mcqCorrect1"
                        style="margin-right:4px;"
                      />
                      Alternativ 2
                    </label>
                    <input id="mcqOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="mcqCorrect"
                        value="2"
                        id="mcqCorrect2"
                        style="margin-right:4px;"
                      />
                      Alternativ 3
                    </label>
                    <input id="mcqOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="mcqCorrect"
                        value="3"
                        id="mcqCorrect3"
                        style="margin-right:4px;"
                      />
                      Alternativ 4
                    </label>
                    <input id="mcqOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="mcqAnswer">Korrekt svar (Index)</label>
                    <input id="mcqAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnMcqAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till fr√•ga</button>
                    <button id="btnMcqUpdate" class="btn btn-sm hidden" type="button">üíæ Spara √§ndring</button>
                  </div>
                  <button id="btnMcqClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <!-- Kort 3: Lista befintliga fr√•gor -->
              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella flervalsfr√•gor (<span id="mcqCount">0</span> st)</h3>
                <ul id="mcqList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Bildfr√•gor -->
          <section class="tab-panel hidden" data-panel="images">
            <div class="questions-editor">
              <h3>Hantera bildfr√•gor (IMG)</h3>
              <p class="mini">L√§gg till fr√•gor d√§r en bild visas tillsammans med flervalsalternativ.</p>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera bildfr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgLevel">Niv√•</label>
                    <select id="imgLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgQuestion">Fr√•getext</label>
                    <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgFile">Bildfil</label>
                    <input id="imgFile" type="file" accept="image/*" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">F√∂rhandsvisning</label>
                    <div id="imgPreview" class="img-preview-box mini">Ingen bild vald √§nnu.</div>
                  </div>
                </div>

                <!-- EXAKT 4 alternativ: radio + textruta -->
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="imgCorrect"
                        value="0"
                        id="imgCorrect0"
                        style="margin-right:4px;"
                      />
                      Alternativ 1
                    </label>
                    <input id="imgOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="imgCorrect"
                        value="1"
                        id="imgCorrect1"
                        style="margin-right:4px;"
                      />
                      Alternativ 2
                    </label>
                    <input id="imgOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="imgCorrect"
                        value="2"
                        id="imgCorrect2"
                        style="margin-right:4px;"
                      />
                      Alternativ 3
                    </label>
                    <input id="imgOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input
                        type="radio"
                        name="imgCorrect"
                        value="3"
                        id="imgCorrect3"
                        style="margin-right:4px;"
                      />
                      Alternativ 4
                    </label>
                    <input id="imgOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="imgAnswer">Korrekt svar (Index)</label>
                    <input id="imgAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="imgGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnImgAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till bildfr√•ga</button>
                  </div>
                  <button id="btnImgClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
                <ul id="imgList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Drag & Drop (komprimerad bygg-ruta) -->
          <section class="tab-panel hidden" data-panel="dragdrop">
            <div class="questions-editor">
              <h3>Hantera Drag &amp; Drop-fr√•gor</h3>
              <p class="mini">Skapa korta fr√•gor d√§r eleverna drar ord/begrepp till r√§tt kolumn.</p>

              <div class="card" style="margin-top:10px;max-width:720px;margin-left:auto;margin-right:auto;padding:10px;">
                <h4>Bygg fr√•ga (kompakt)</h4>
                <div class="card-row" style="margin-top:6px;">
                  <div class="field" style="flex:0 0 90px;">
                    <label class="small-label" for="dragLevel">Niv√•</label>
                    <select id="dragLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragQuestion">Instruktion</label>
                    <input id="dragQuestion" class="input" placeholder="Ex: Dra r√§tt livsmedel till 'Kylvara'." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragColumn1">Kolumn 1</label>
                    <input id="dragColumn1" class="input" placeholder="t.ex. Kylvara" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragColumn2">Kolumn 2</label>
                    <input id="dragColumn2" class="input" placeholder="t.ex. Torrvara" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragItemText">Objekt att dra</label>
                    <input id="dragItemText" class="input" placeholder="t.ex. 'R√• kyckling'" />
                  </div>
                  <div class="field" style="flex:0 0 140px;">
                    <label class="small-label" for="dragItemCorrect">Korrekt kolumn</label>
                    <select id="dragItemCorrect" class="input">
                      <option value="0">Kolumn 1</option>
                      <option value="1">Kolumn 2</option>
                    </select>
                  </div>
                  <div class="field" style="flex:0 0 110px;">
                    <label class="small-label">&nbsp;</label>
                    <button id="btnDragAddItem" class="btn btn-sm btn-primary" type="button" style="width:100%;">‚ûï L√§gg till</button>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label">Objekt i denna fr√•ga</label>
                    <ul id="dragItemsPreview" class="question-list"></ul>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="dragGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;justify-content:space-between;">
                  <div>
                    <button id="btnDragAddQuestion" class="btn btn-sm btn-primary" type="button">üíæ Spara fr√•ga</button>
                  </div>
                  <button id="btnDragClearForm" class="btn btn-sm btn-secondary" type="button">
                    Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:10px;">
                <h3>Aktuella Drag &amp; Drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
                <ul id="dragList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- Elevprogression ‚Äì 4 rutor -->
          <section class="tab-panel hidden" data-panel="progress">
            <div class="card">
              <h3>Elevprogression</h3>
              <p class="mini">
                H√§r kan du sammanfatta vad eleven √§r stark p√•, vad som beh√∂ver √∂vas och exportera en JSON-text till elevkortet.
              </p>

              <div class="progress-grid">
                <div class="progress-box" id="progressPointsBox">
                  <h4>Elevens po√§ng (lokalt)</h4>
                  <p id="progressPointsText" class="mini">
                    Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.
                  </p>
                </div>

                <div class="progress-box" id="progressStrongBox">
                  <h4>Starka delbitar</h4>
                  <ul id="progressStrongList" class="goals-list mini">
                    <li>Inga starka delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressWeakBox">
                  <h4>Delbitar att √∂va p√•</h4>
                  <ul id="progressWeakList" class="goals-list mini">
                    <li>Inga svaga delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressExportBox">
                  <h4>Export till elevkort (JSON)</h4>
                  <p class="mini">
                    N√§r du √§r n√∂jd med en elevs progression kan du skapa en JSON-str√§ng som klistras in i elevkortet.
                  </p>
                  <textarea
                    id="progressExportJson"
                    class="input"
                    rows="4"
                    readonly
                    style="font-family:monospace;font-size:0.8rem;border-radius:6px;"
                  ></textarea>
                  <div style="margin-top:6px;display:flex;gap:8px;justify-content:flex-end;">
                    <button id="btnGenerateProgressJson" class="btn btn-sm" type="button">üîÅ Skapa JSON</button>
                    <button id="btnCopyProgressJson" class="btn btn-sm btn-primary" type="button">üìã Kopiera kod</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Fr√•gebank / Firebase -->
          <section class="tab-panel hidden" data-panel="bank">
            <div class="settings-grid">
              <div class="card">
                <h3>Ladda fr√•gebank fr√•n molnet (Firebase)</h3>
                <p class="mini">
                  Visar bankar som har sparats p√• ditt Google-konto. Aktivera bankarna nedan f√∂r att l√§gga till fr√•gorna i spelet.
                </p>
                <p id="cloudBankStatus" class="mini" style="margin-top:4px;"></p>
                <ul id="cloudBankList" class="goals-list" style="margin-top:10px;"></ul>
                <div style="margin-top:10px;">
                  <button id="btnLoadCloudBanks" class="btn btn-sm" type="button">‚òÅÔ∏è Ladda moln-bankar</button>
                </div>
              </div>

              <div class="card">
                <h3>Spara aktuell fr√•gebank till molnet</h3>
                <p class="mini">
                  Namnge din fr√•gebank. Sparar *alla* fr√•gor du skapat i flervals-, bild- och drag/drop-flikarna.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="inputBankName">Namn p√• fr√•gebank</label>
                    <input id="inputBankName" class="input" placeholder="T.ex. Livsmedel HT25" />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <button id="btnSaveToCloud" class="btn btn-sm btn-primary" type="button">üíæ Spara bank till molnet</button>
                </div>
              </div>

              <!-- NYTT KORT: G√∂r publik fr√•gebank / elevl√§nk -->
              <div class="card">
                <h3>üåê G√∂r publik fr√•gebank</h3>
                <p class="mini">
                  Skapa en elevl√§nk som automatiskt laddar denna fr√•gebank n√§r eleverna √∂ppnar spelet.
                </p>
                <div class="card-row" style="margin-top:8px;flex-direction:column;gap:8px;">
                  <button id="btnPublishSharedBank" class="btn btn-sm" type="button">
                    üåê Skapa elevl√§nk
                  </button>
                  <div class="field">
                    <label class="small-label" for="sharedBankLinkOutput">Elevl√§nk</label>
                    <input
                      id="sharedBankLinkOutput"
                      class="input"
                      type="text"
                      readonly
                      placeholder="L√§nken visas h√§r n√§r den har skapats..."
                    />
                  </div>
                  <p id="sharedBankStatus" class="mini"></p>
                </div>
              </div>

              <div class="card card-full-width">
                <h3>Export / Import av fr√•gebank (JSON)</h3>
                <p class="mini">
                  Exportera hela din nuvarande fr√•gebank som en JSON-fil (s√§kerhetskopia) eller importera en befintlig bank fr√•n fil.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <button id="btnExportBank" class="btn btn-sm" type="button">‚¨áÔ∏è Exportera till JSON</button>
                  <label class="btn btn-sm" for="fileImport">‚¨ÜÔ∏è Importera fr√•n JSON</label>
                  <input type="file" id="fileImport" accept=".json" style="display:none;" />
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
</body>
<!-- slut SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->






<!-- start SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker & editorer) -->

<!-- start SEKTION 3A: BAS, STATE, FIREBASE & MOLN-BANKER -->
<script>
"use strict";

/* =========================
   3a ‚Äì Konstanter & grundstate
   ========================= */

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
  authDomain: "fangvaktaren-904db.firebaseapp.com",
  projectId: "fangvaktaren-904db",
  storageBucket: "fangvaktaren-904db.firebasestorage.app",
  messagingSenderId: "105301219768",
  appId: "1:105301219768:web:66b131fba86a541b78174d",
  measurementId: "G-NXL9GSFZ77"
};

const STORAGE_KEY = "fangvaktaren-v17";

// üîÅ anv√§nder teachers/{uid}/banks
const CLOUD_ROOT_COLLECTION = "teachers";
const CLOUD_BANKS_SUBCOLLECTION = "banks";

// üåê publik collection f√∂r auto-load till elever
const SHARED_BANKS_COLLECTION = "sharedBanks";

const $ = (sel) => document.querySelector(sel);
const $all = (sel) => document.querySelectorAll(sel);

let firebaseAppInstance = null;
let firebaseAuthInstance = null;
let firebaseDbInstance = null;
let currentTeacherUser = null;

let currentLevel = null;
let currentQuestions = [];
let currentAnswers = [];
let lastSubmission = null;

// editor-state
let currentMcqLinks = [];
let currentImgLinks = [];
let currentDragLinks = [];
let currentMcqCorrectIndex = 0;
let currentImgCorrectIndex = 0;
let currentImgDataUrl = null;

// drag & drop-editor ‚Äì tempor√§r state f√∂r nya fr√•gor
let currentDragSourcesTmp = [];
let currentDragTargetsTmp = [];
let currentDragCorrectMapTmp = {};

// üîπ Globala mark√∂rer f√∂r aktiv publicerad bank (f√∂r highscore/inl√§mning)
window.activeSharedBankId = window.activeSharedBankId || null;

const defaultState = {
  student: { name: "", klass: "" },
  best: { E: 0, C: 0, A: 0 },
  unlocked: { E: false, C: false, A: false },
  thres: { E: 70, C: 70, A: 70 },
  teacherPassword: null,
  teacherEmail: "",
  goalsMap: [],
  bank: {
    mcq: [],
    img: [],
    drag: []
  },
  progression: {
    totalPoints: 0,
    wrongByGoalId: {},
    correctByGoalId: {}
  }
};

function deepCloneDefault() {
  return JSON.parse(JSON.stringify(defaultState));
}

function clampInt(val, min, max) {
  const n = parseInt(val, 10);
  if (isNaN(n)) return min;
  return Math.max(min, Math.min(max, n));
}

function shuffle(arr) {
  return arr.slice().sort(() => Math.random() - 0.5);
}

function escapeHtml(str) {
  if (!str && str !== 0) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

/* =========================
   Hj√§lp: sanera objekt f√∂r Firestore
   ========================= */
function sanitizeForFirestore(value) {
  if (
    value === null ||
    typeof value === "string" ||
    typeof value === "number" ||
    typeof value === "boolean"
  ) {
    return value;
  }
  if (value === undefined) return null;

  if (Array.isArray(value)) {
    return value
      .map((item) => sanitizeForFirestore(item))
      .filter((item) => item !== undefined);
  }

  if (typeof value === "object") {
    const cleaned = {};
    for (const key of Object.keys(value)) {
      const v = sanitizeForFirestore(value[key]);
      if (v !== undefined) cleaned[key] = v;
    }
    return cleaned;
  }

  return null;
}

/* =========================
   3b ‚Äì State-hantering & embedded-data
   ========================= */

function mergeEmbeddedBank(state) {
  const el = document.getElementById("embedded-data");
  if (!el) return state;
  try {
    const raw = el.textContent || el.innerHTML || "{}";
    const data = JSON.parse(raw);
    if (data && data.bank) {
      state.bank = Object.assign({ mcq: [], img: [], drag: [] }, state.bank || {});
      state.bank.mcq = (state.bank.mcq || []).concat(data.bank.mcq || []);
      state.bank.img = (state.bank.img || []).concat(data.bank.img || []);
      state.bank.drag = (state.bank.drag || []).concat(data.bank.drag || []);
    }
  } catch (e) {
    console.warn("Kunde inte l√§sa embedded-data:", e);
  }
  return state;
}

function loadState() {
  let s = null;
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) s = JSON.parse(raw);
  } catch (e) {
    console.warn("Kunde inte l√§sa state, √•terst√§ller:", e);
  }

  if (!s) {
    s = deepCloneDefault();
    s = mergeEmbeddedBank(s);
    saveState(s);
  }

  s.student = Object.assign({ name: "", klass: "" }, s.student || {});
  s.best = Object.assign({ E: 0, C: 0, A: 0 }, s.best || {});
  s.unlocked = Object.assign({ E: false, C: false, A: false }, s.unlocked || {});
  s.thres = Object.assign({ E: 70, C: 70, A: 70 }, s.thres || {});
  s.bank = Object.assign({ mcq: [], img: [], drag: [] }, s.bank || {});

  if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
  if (!Array.isArray(s.bank.img)) s.bank.img = [];
  if (!Array.isArray(s.bank.drag)) s.bank.drag = [];

  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];

  if (!s.progression || typeof s.progression !== "object") {
    s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {} };
  } else {
    s.progression.totalPoints = s.progression.totalPoints || 0;
    s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
    s.progression.correctByGoalId = s.progression.correctByGoalId || {};
  }

  if (typeof s.teacherEmail !== "string") s.teacherEmail = "";

  return s;
}

function saveState(state) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn("Kunde inte spara state:", e);
  }
}

/* =========================
   3c ‚Äì Firebase init & Google-inloggning
   ========================= */

function initFirebase() {
  const statusEl = $("#googleStatus");
  try {
    if (!window.firebase) {
      console.warn("Firebase-bibliotek kunde inte hittas.");
      if (statusEl) statusEl.textContent = "‚ö†Ô∏è Tekniskt fel: Firebase-bibliotek kunde inte laddas.";
      return;
    }
    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);

    firebaseAppInstance = firebase.app();
    firebaseAuthInstance = firebase.auth();
    firebaseDbInstance = firebase.firestore();

    console.log("Firebase init OK");
    setupGoogleLogin();

    // üåê auto-load av publik bank till elever (om URL har ?bank=... eller ?sb=... eller ?sharedBank=...)
    autoLoadSharedBank();
  } catch (e) {
    console.error("Firebase init misslyckades:", e);
    if (statusEl) statusEl.textContent = "‚ö†Ô∏è Tekniskt fel: kunde inte starta Firebase.";
  }
}

function setupGoogleLogin() {
  const btnLogin = $("#btnGooglePlaceholder");
  const btnLogout = $("#btnGoogleLogout");
  const statusEl = $("#googleStatus");
  if (!btnLogin || !statusEl) return;

  if (!firebaseAuthInstance) {
    console.warn("Firebase Auth saknas vid setupGoogleLogin.");
    statusEl.textContent = "‚ö†Ô∏è Tekniskt fel: Firebase Auth saknas.";
    return;
  }

  firebaseAuthInstance.onAuthStateChanged((user) => {
    currentTeacherUser = user || null;
    if (!statusEl) return;

    if (user) {
      statusEl.textContent = `‚òÅÔ∏è Inloggad som ${user.email || "l√§rare"} ‚Äì moln-banker aktiverade.`;
      if (btnLogout) btnLogout.classList.remove("hidden");
    } else {
      statusEl.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.";
      if (btnLogout) btnLogout.classList.add("hidden");
    }
  });

  if (!btnLogin.__fvLoginBound) {
    btnLogin.__fvLoginBound = true;
    btnLogin.addEventListener("click", async () => {
      if (!firebaseAuthInstance) {
        alert("Tekniskt fel: Firebase Auth saknas.");
        return;
      }
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await firebaseAuthInstance.signInWithPopup(provider);
      } catch (err) {
        console.error("Google-inloggning misslyckades:", err);
        statusEl.textContent = "‚ö†Ô∏è Kunde inte logga in med Google. F√∂rs√∂k igen.";
      }
    });
  }

  if (btnLogout && !btnLogout.__fvLogoutBound) {
    btnLogout.__fvLogoutBound = true;
    btnLogout.addEventListener("click", async () => {
      try {
        await firebaseAuthInstance.signOut();
      } catch (err) {
        console.error("Kunde inte logga ut:", err);
      }
    });
  }
}

/* =========================
   3d ‚Äì Moln-banker (Firestore)
   ========================= */

function getBankFromState() {
  const s = loadState();
  return Object.assign({ mcq: [], img: [], drag: [] }, s.bank || {});
}

function normalizeBankFromDoc(data) {
  if (!data || typeof data !== "object") return { mcq: [], img: [], drag: [] };

  // 1) data.bank.mcq/img/drag
  if (data.bank && (Array.isArray(data.bank.mcq) || Array.isArray(data.bank.img) || Array.isArray(data.bank.drag))) {
    return {
      mcq: data.bank.mcq || [],
      img: data.bank.img || [],
      drag: data.bank.drag || []
    };
  }

  // 2) data.mcq/img/drag
  if (Array.isArray(data.mcq) || Array.isArray(data.img) || Array.isArray(data.drag)) {
    return {
      mcq: data.mcq || [],
      img: data.img || [],
      drag: data.drag || []
    };
  }

  // 3) data.questions -> mcq
  if (Array.isArray(data.questions)) {
    return { mcq: data.questions, img: [], drag: [] };
  }

  // 4) leta nested
  for (const key of Object.keys(data)) {
    const nested = data[key];
    if (!nested || typeof nested !== "object") continue;

    if (nested.bank && (Array.isArray(nested.bank.mcq) || Array.isArray(nested.bank.img) || Array.isArray(nested.bank.drag))) {
      return {
        mcq: nested.bank.mcq || [],
        img: nested.bank.img || [],
        drag: nested.bank.drag || []
      };
    }

    if (Array.isArray(nested.mcq) || Array.isArray(nested.img) || Array.isArray(nested.drag)) {
      return {
        mcq: nested.mcq || [],
        img: nested.img || [],
        drag: nested.drag || []
      };
    }

    if (Array.isArray(nested.questions)) {
      return { mcq: nested.questions, img: [], drag: [] };
    }
  }

  return { mcq: [], img: [], drag: [] };
}

// üîπ Visar f√∂r eleverna vilken fr√•gebank som √§r aktiv
function updateActiveBankBanner() {
  const s = loadState();
  const bank = s.bank || {};
  const mcqCount = Array.isArray(bank.mcq) ? bank.mcq.length : 0;
  const imgCount = Array.isArray(bank.img) ? bank.img.length : 0;
  const dragCount = Array.isArray(bank.drag) ? bank.drag.length : 0;

  let text = "Ingen fr√•gebank aktiverad.";
  if (mcqCount || imgCount || dragCount) {
    text = `Aktiv fr√•gebank: ${mcqCount} flervalsfr√•gor, ${imgCount} bildfr√•gor, ${dragCount} drag & drop-fr√•gor.`;
  }

  let banner = document.getElementById("activeBankBanner");
  if (!banner) {
    const header = document.querySelector(".app-header");
    if (!header) return;
    banner = document.createElement("div");
    banner.id = "activeBankBanner";
    banner.className = "mini";
    header.appendChild(banner);
  }
  banner.textContent = text;
}

function setBankAndGoalsInState(bank, goalsMap) {
  const s = loadState();
  s.bank = Object.assign({ mcq: [], img: [], drag: [] }, bank || {});
  if (Array.isArray(goalsMap)) s.goalsMap = goalsMap.slice();
  saveState(s);

  updateActiveBankBanner();

  if (typeof updateBankStatusUI === "function") {
    try { updateBankStatusUI(); } catch (e) { console.warn("updateBankStatusUI gav fel:", e); }
  }
}

function setBankInState(bank) {
  setBankAndGoalsInState(bank, null);
}

// =========================
// 3d.1 ‚Äì Hj√§lpare f√∂r URL-parametrar
// =========================
function getQueryParam(name) {
  try {
    const params = new URLSearchParams(window.location.search || "");
    return params.get(name);
  } catch (e) {
    console.warn("getQueryParam fel:", e);
    return null;
  }
}

// =========================
// 3d.1b ‚Äì Aktiv publicerad bank-id
// =========================
function getActiveBankIdForResults() {
  if (window.activeSharedBankId) return window.activeSharedBankId;
  try {
    const fromUrl =
      getQueryParam("sharedBank") ||
      getQueryParam("sb") ||
      getQueryParam("bank");
    return fromUrl || null;
  } catch (e) {
    return null;
  }
}

// =========================
// 3d.2 ‚Äì Auto-load av publik bank f√∂r elever
// =========================
async function autoLoadSharedBank() {
  if (!firebaseDbInstance) {
    console.warn("autoLoadSharedBank: firebaseDbInstance saknas.");
    return;
  }

  const bankId =
    getQueryParam("bank") || getQueryParam("sb") || getQueryParam("sharedBank");

  if (!bankId) {
    console.log("autoLoadSharedBank: ingen bank-param i URL ‚Äì hoppar √∂ver.");
    return;
  }

  try {
    console.log("üåê autoLoadSharedBank: f√∂rs√∂ker ladda", SHARED_BANKS_COLLECTION + "/" + bankId);

    const docSnap = await firebaseDbInstance
      .collection(SHARED_BANKS_COLLECTION)
      .doc(bankId)
      .get();

    if (!docSnap.exists) {
      console.warn("autoLoadSharedBank: hittade ingen shared-bank med id", bankId);
      return;
    }

    const data = docSnap.data() || {};
    const normalizedBank = normalizeBankFromDoc(data);

    const goalsFromDoc = Array.isArray(data.goalsMap)
      ? data.goalsMap
      : (data.bank && Array.isArray(data.bank.goalsMap) ? data.bank.goalsMap : []);

    const teacherEmailFromDoc =
      data.teacherEmail ||
      (data.bank && data.bank.teacherEmail) ||
      null;

    setBankAndGoalsInState(normalizedBank, goalsFromDoc);

    // üîπ Markera vilken shared-bank som √§r aktiv (f√∂r highscore/inl√§mning)
    window.activeSharedBankId = bankId;

    // üîπ S√§tt l√§rarens e-post i elevens state om den finns i banken
    if (teacherEmailFromDoc) {
      const sLocal = loadState();
      sLocal.teacherEmail = teacherEmailFromDoc;
      saveState(sLocal);
    }

    if (typeof renderMcqList === "function") renderMcqList();
    if (typeof renderImgList === "function") renderImgList();
    if (typeof renderDragList === "function") renderDragList();
    if (typeof renderGoalsList === "function") renderGoalsList();
    if (typeof syncUI === "function") syncUI();

    if (typeof refreshHighscoreFromFirestore === "function") {
      try { refreshHighscoreFromFirestore(bankId); } catch (e) {}
    }

    console.log("‚úÖ autoLoadSharedBank: shared-bank laddad & aktiverad.");
  } catch (err) {
    console.error("autoLoadSharedBank: fel vid laddning av shared-bank:", err);
  }
}

// =========================
// 3d.3 ‚Äì L√§rarens moln-banker (teachers/{uid}/banks)
// =========================

async function loadCloudBanksList() {
  const listEl = $("#cloudBankList");
  if (!listEl) return;
  listEl.innerHTML = "";

  if (!firebaseDbInstance || !currentTeacherUser) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Du m√•ste vara inloggad med Google f√∂r att se dina moln-banker.";
    listEl.appendChild(li);
    return;
  }

  try {
    const snap = await firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION)
      .doc(currentTeacherUser.uid)
      .collection(CLOUD_BANKS_SUBCOLLECTION)
      .orderBy("createdAt", "desc")
      .get();

    if (snap.empty) {
      const li = document.createElement("li");
      li.className = "mini";
      li.textContent = "Inga moln-banker hittades √§nnu.";
      listEl.appendChild(li);
      return;
    }

    snap.forEach((docSnap) => {
      const data = docSnap.data() || {};
      const normalizedBank = normalizeBankFromDoc(data);

      const goalsFromDoc = Array.isArray(data.goalsMap)
        ? data.goalsMap
        : (data.bank && Array.isArray(data.bank.goalsMap) ? data.bank.goalsMap : []);

      const teacherEmailFromDoc =
        data.teacherEmail ||
        (data.bank && data.bank.teacherEmail) ||
        null;

      const li = document.createElement("li");
      li.className = "list-item";

      const main = document.createElement("div");
      main.className = "list-main";

      const title = document.createElement("div");
      title.className = "q-text";
      title.textContent = data.name || "Namnl√∂s bank";

      const meta = document.createElement("div");
      meta.className = "q-meta";
      const ts = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
      meta.textContent = (ts ? `Skapad: ${ts.toLocaleString("sv-SE")}` : "Skapad: ok√§nt datum");

      main.appendChild(title);
      main.appendChild(meta);

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.flexDirection = "column";
      actions.style.gap = "4px";

      const btnActivate = document.createElement("button");
      btnActivate.className = "btn btn-sm";
      btnActivate.textContent = "Aktivera denna bank";
      btnActivate.addEventListener("click", () => {
        setBankAndGoalsInState(normalizedBank, goalsFromDoc);

        // (OBS) Moln-bank-id √§r inte en publicerad bank. Resultat/highscore kr√§ver elevl√§nk (?bank=...).
        window.activeSharedBankId = null;

        if (teacherEmailFromDoc) {
          const sLocal = loadState();
          sLocal.teacherEmail = teacherEmailFromDoc;
          saveState(sLocal);
        }

        if (typeof renderMcqList === "function") renderMcqList();
        if (typeof renderImgList === "function") renderImgList();
        if (typeof renderDragList === "function") renderDragList();
        if (typeof renderGoalsList === "function") renderGoalsList();
        if (typeof syncUI === "function") syncUI();

        alert("Moln-bank aktiverad. Dina fr√•gor √§r nu laddade i spelet.");
      });
      actions.appendChild(btnActivate);

      const btnDelete = document.createElement("button");
      btnDelete.className = "btn btn-sm btn-danger";
      btnDelete.textContent = "üóëÔ∏è Ta bort";
      btnDelete.addEventListener("click", async () => {
        if (!confirm("Ta bort denna moln-bank permanent?")) return;
        try {
          await firebaseDbInstance
            .collection(CLOUD_ROOT_COLLECTION)
            .doc(currentTeacherUser.uid)
            .collection(CLOUD_BANKS_SUBCOLLECTION)
            .doc(docSnap.id)
            .delete();
          alert("Moln-bank borttagen.");
          loadCloudBanksList();
        } catch (err) {
          console.error("Kunde inte ta bort bank:", err);
          alert("Kunde inte ta bort bank. Se konsolen f√∂r detaljer.");
        }
      });
      actions.appendChild(btnDelete);

      li.appendChild(main);
      li.appendChild(actions);
      listEl.appendChild(li);
    });
  } catch (e) {
    console.error("Kunde inte ladda moln-banker:", e);
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Fel vid laddning av moln-banker. Se konsolen f√∂r detaljer.";
    listEl.appendChild(li);
  }
}

function setupCloudBankUI() {
  const btnLoad = $("#btnLoadCloudBanks");
  const btnSave = $("#btnSaveToCloud");
  const btnExport = $("#btnExportBank");
  const fileImport = $("#fileImport");

  if (btnLoad && !btnLoad.__fvBound) {
    btnLoad.__fvBound = true;
    btnLoad.addEventListener("click", () => loadCloudBanksList());
  }

  if (btnSave && !btnSave.__fvBound) {
    btnSave.__fvBound = true;
    btnSave.addEventListener("click", async () => {
      if (!firebaseDbInstance || !currentTeacherUser) {
        alert("Du m√•ste vara inloggad med Google f√∂r att spara till molnet.");
        return;
      }
      const nameInput = $("#inputBankName");
      const name = (nameInput && nameInput.value.trim()) || "Min fr√•gebank";
      const rawBank = getBankFromState();
      const bank = sanitizeForFirestore(rawBank);
      const sFull = loadState();

      try {
        await firebaseDbInstance
          .collection(CLOUD_ROOT_COLLECTION)
          .doc(currentTeacherUser.uid)
          .collection(CLOUD_BANKS_SUBCOLLECTION)
          .add({
            ownerUid: currentTeacherUser.uid,
            ownerEmail: currentTeacherUser.email || null,
            name,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            bank,
            goalsMap: sFull.goalsMap || [],
            teacherEmail: sFull.teacherEmail || null
          });
        alert("Fr√•gebank sparad till molnet.");
        if (nameInput) nameInput.value = name;
      } catch (e) {
        console.error("Kunde inte spara bank till molnet:", e);
        alert("Det gick inte att spara bank till molnet. Se konsolen f√∂r detaljer.");
      }
    });
  }

  if (btnExport && !btnExport.__fvBound) {
    btnExport.__fvBound = true;
    btnExport.addEventListener("click", () => {
      const bank = getBankFromState();
      const blob = new Blob([JSON.stringify(bank, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "fangvaktaren_bank.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  if (fileImport && !fileImport.__fvBound) {
    fileImport.__fvBound = true;
    fileImport.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function () {
        try {
          const imported = JSON.parse(reader.result);
          setBankInState(imported);
          if (typeof renderMcqList === "function") renderMcqList();
          if (typeof renderImgList === "function") renderImgList();
          if (typeof renderDragList === "function") renderDragList();
          if (typeof syncUI === "function") syncUI();
          if (typeof updateBankStatusUI === "function") {
            try { updateBankStatusUI(); } catch (_) {}
          }
          alert("Fr√•gebank importerad.");
        } catch (err) {
          console.error("Fel vid import av JSON-bank:", err);
          alert("Kunde inte l√§sa JSON-filen. Kontrollera formatet.");
        }
      };
      reader.readAsText(file, "utf-8");
    });
  }
}
</script>
<!-- slut SEKTION 3A: BAS, STATE, FIREBASE & MOLN-BANKER -->

<!-- start SEKTION 3B: FR√ÖGEEDITORER, L√ÑRARL√ÑGE & NAVIGATION -->
<script>
/* =========================
   3e ‚Äì Delm√•l & delbitar (goalsMap)
   ========================= */

function populateGoalSelect(selectElId) {
  const sel = typeof selectElId === "string" ? $(selectElId) : $("#mcqGoalPart");
  if (!sel) return;
  const s = loadState();
  const goals = s.goalsMap || [];

  sel.innerHTML = "";
  const def = document.createElement("option");
  def.value = "";
  def.textContent = "Ingen koppling";
  sel.appendChild(def);

  goals.forEach((g) => {
    const opt = document.createElement("option");
    opt.value = String(g.id);
    opt.textContent = `${g.goal || "-"} (Delbitar: ${g.parts || "-"})`;
    sel.appendChild(opt);
  });
}

function renderGoalsList() {
  const host = $("#goalsList");
  if (!host) return;

  const s = loadState();
  const list = s.goalsMap || [];

  host.innerHTML = "";
  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga sparade delm√•l √§nnu.";
    host.appendChild(li);
    populateGoalSelect("#mcqGoalPart");
    populateGoalSelect("#imgGoalPart");
    populateGoalSelect("#dragGoalPart");
    populateGoalSelect("#mcqJsonGoalPart");
    return;
  }

  list.forEach((g) => {
    const li = document.createElement("li");
    li.className = "list-item";
    li.innerHTML = `
      <div style="
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:8px;
        border:1px solid rgba(148,163,184,0.5);
        border-radius:8px;
        padding:6px 8px;
        width:100%;
      ">
        <div class="list-main">
          <div class="q-text">${escapeHtml(g.goal || "-")}</div>
          <div class="q-meta">Delbitar: ${escapeHtml(g.parts || "-")}</div>
        </div>
        <div>
          <button class="btn btn-sm btn-danger" data-del-goal-id="${g.id}">üóëÔ∏è</button>
        </div>
      </div>
    `;
    host.appendChild(li);
  });

  host.querySelectorAll("button[data-del-goal-id]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del-goal-id");
      const s2 = loadState();
      s2.goalsMap = (s2.goalsMap || []).filter((g) => String(g.id) !== id);
      saveState(s2);
      renderGoalsList();
    });
  });

  populateGoalSelect("#mcqGoalPart");
  populateGoalSelect("#imgGoalPart");
  populateGoalSelect("#dragGoalPart");
  populateGoalSelect("#mcqJsonGoalPart");
}

function initGoalsMap() {
  const inputGoal = $("#inputGoalSingle");
  const inputPart = $("#inputPartSingle");
  const btnAdd = $("#btnAddGoalPart");
  const btnSave = $("#btnSaveGoalsMap");
  const btnClear = $("#btnClearGoalsMap");
  const statusEl = $("#goalsStatus");

  if (btnAdd && !btnAdd.__fvBound) {
    btnAdd.__fvBound = true;
    btnAdd.addEventListener("click", () => {
      const goalText = (inputGoal && inputGoal.value.trim()) || "";
      const partsText = (inputPart && inputPart.value.trim()) || "";
      if (!goalText || !partsText) {
        if (statusEl) statusEl.textContent = "Skriv b√•de delm√•l och delbit.";
        return;
      }
      const s = loadState();
      if (!Array.isArray(s.goalsMap)) s.goalsMap = [];
      s.goalsMap.push({
        id: Date.now(),
        goal: goalText,
        parts: partsText
      });
      saveState(s);
      if (inputGoal) inputGoal.value = "";
      if (inputPart) inputPart.value = "";
      if (statusEl) statusEl.textContent = "Delbit tillagd.";
      renderGoalsList();
    });
  }

  if (btnSave && !btnSave.__fvBound) {
    btnSave.__fvBound = true;
    btnSave.addEventListener("click", () => {
      const s = loadState();
      saveState(s);
      if (statusEl) statusEl.textContent = "Delm√•l & delbitar sparade.";
    });
  }

  if (btnClear && !btnClear.__fvBound) {
    btnClear.__fvBound = true;
    btnClear.addEventListener("click", () => {
      if (!confirm("Ta bort alla delm√•l och delbitar?")) return;
      const s = loadState();
      s.goalsMap = [];
      saveState(s);
      if (statusEl) statusEl.textContent = "Alla delm√•l borttagna.";
      renderGoalsList();
    });
  }

  renderGoalsList();
}

/* =========================
   3f ‚Äì Hj√§lp: delm√•ls-taggar & kopplingar
   ========================= */

function buildGoalInfoText(q) {
  const tags = [];

  if (Array.isArray(q.links) && q.links.length) {
    q.links.forEach((lnk) => {
      const goal = escapeHtml(lnk.goal || "-");
      const parts = escapeHtml(lnk.parts || "-");
      tags.push(`<span class="goal-tag">${goal} (Delbitar: ${parts})</span>`);
    });
  } else {
    if (q.goal || q.parts) {
      let txt = "Delm√•l: " + (q.goal || "-");
      if (q.parts) txt += " (Delbitar: " + q.parts + ")";
      tags.push(`<span class="goal-tag">${escapeHtml(txt)}</span>`);
    }
    if (q.goalExtra || q.partsExtra) {
      let txt2 = "Delm√•l: " + (q.goalExtra || "-");
      if (q.partsExtra) txt2 += " (Delbitar: " + q.partsExtra + ")";
      tags.push(`<span class="goal-tag">${escapeHtml(txt2)}</span>`);
    }
  }

  if (!tags.length) return '<span class="goal-tag goal-tag-none">Ingen koppling till delm√•l</span>';
  return tags.join(" ");
}

function getLinksFromIds(idArray) {
  const s = loadState();
  const goals = s.goalsMap || [];
  return idArray
    .map((id) => goals.find((g) => String(g.id) === String(id)))
    .filter(Boolean)
    .map((g) => ({ id: g.id, goal: g.goal, parts: g.parts }));
}

/* =========================
   3g ‚Äì Flervalsfr√•gor (MCQ) ‚Äì lista & editor
   ========================= */

function renderMcqList() {
  const listEl = $("#mcqList");
  const countEl = $("#mcqCount");
  if (!listEl) return;

  const s = loadState();
  const list = (s.bank && s.bank.mcq) || [];

  listEl.innerHTML = "";
  if (countEl) countEl.textContent = String(list.length);

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga fr√•gor i banken √§nnu.";
    listEl.appendChild(li);
    if (typeof updateActiveBankBanner === "function") updateActiveBankBanner();
    return;
  }

  list.forEach((q, idx) => {
    const li = document.createElement("li");
    li.className = "list-item";

    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    else if (lvl === "A") tagClass = "level-a";

    const goalInfo = buildGoalInfoText(q);

    li.innerHTML = `
      <div style="
        display:flex;
        align-items:flex-start;
        gap:8px;
        width:100%;
        border:1px solid rgba(148,163,184,0.5);
        border-radius:8px;
        padding:6px 8px;
      ">
        <div style="
          flex:0 0 64px;
          display:flex;
          align-items:center;
          justify-content:center;
        ">
          <span class="level-tag ${tagClass}">${lvl}</span>
        </div>
        <div class="list-main" style="flex:1;">
          <div class="q-text">[${idx + 1}] ${escapeHtml(q.q || "")}</div>
          <div class="q-meta">${goalInfo}</div>
        </div>
        <div style="
          flex:0 0 auto;
          display:flex;
          align-items:center;
          justify-content:flex-end;
        ">
          <button class="btn btn-sm btn-danger" data-del-index="${idx}">üóëÔ∏è</button>
        </div>
      </div>
    `;
    listEl.appendChild(li);
  });

  listEl.querySelectorAll("button[data-del-index]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const index = Number(btn.getAttribute("data-del-index"));
      const s2 = loadState();
      if (!Array.isArray(s2.bank.mcq) || index < 0 || index >= s2.bank.mcq.length) return;
      s2.bank.mcq.splice(index, 1);
      saveState(s2);
      renderMcqList();
      if (typeof syncUI === "function") syncUI();
    });
  });

  if (typeof updateActiveBankBanner === "function") updateActiveBankBanner();
}

function initQuestionForms() {
  const mcqLevel = $("#mcqLevel");
  const mcqQuestion = $("#mcqQuestion");
  const mcqOpt0 = $("#mcqOption0");
  const mcqOpt1 = $("#mcqOption1");
  const mcqOpt2 = $("#mcqOption2");
  const mcqOpt3 = $("#mcqOption3");
  const mcqAnswerNumber = $("#mcqAnswer");
  const mcqGoalPart = $("#mcqGoalPart");
  const btnAdd = $("#btnMcqAdd");
  const btnClear = $("#btnMcqClear");
  const txtQuick = $("#mcqJsonInput");
  const btnQuickImport = $("#btnMcqJsonImport");

  const mcqCorrect0 = $("#mcqCorrect0");
  const mcqCorrect1 = $("#mcqCorrect1");
  const mcqCorrect2 = $("#mcqCorrect2");
  const mcqCorrect3 = $("#mcqCorrect3");
  const mcqCorrectBoxes = [mcqCorrect0, mcqCorrect1, mcqCorrect2, mcqCorrect3].filter(Boolean);

  const btnLink = $("#btnMcqAddGoalLink");
  let mcqLinksPreview = $("#mcqGoalLinksPreview");

  if (!btnAdd || !mcqLevel || !mcqQuestion || !mcqOpt0 || !mcqOpt1 || !mcqOpt2 || !mcqOpt3) return;

  // D√∂lj "Korrekt svar (Index)"
  if (mcqAnswerNumber) {
    const container = mcqAnswerNumber.closest(".field") || mcqAnswerNumber.parentElement || mcqAnswerNumber;
    container.style.display = "none";
  }

  currentMcqCorrectIndex = 0;
  currentMcqLinks = [];

  if (mcqLinksPreview) mcqLinksPreview.textContent = "Inga kopplingar √§nnu.";

  if (btnLink && mcqGoalPart && !btnLink.__fvBound) {
    btnLink.__fvBound = true;
    btnLink.addEventListener("click", () => {
      const val = mcqGoalPart.value;
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!currentMcqLinks.some((x) => String(x.id) === String(link.id))) currentMcqLinks.push(link);

      if (mcqLinksPreview) {
        mcqLinksPreview.innerHTML = currentMcqLinks
          .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
          .join(" ");
      }
    });
  }

  if (!btnAdd.__fvBound) {
    btnAdd.__fvBound = true;
    btnAdd.addEventListener("click", () => {
      const s = loadState();
      const level = mcqLevel.value || "E";
      const text = mcqQuestion.value.trim();

      const v0 = mcqOpt0.value.trim();
      const v1 = mcqOpt1.value.trim();
      const v2 = mcqOpt2.value.trim();
      const v3 = mcqOpt3.value.trim();

      if (!text) return alert("Skriv en fr√•ga.");
      if (!v0 || !v1 || !v2 || !v3) return alert("Skriv exakt fyra svarsalternativ (alla fyra m√•ste vara ifyllda).");

      const opts = [v0, v1, v2, v3];

      let answerIndex = 0;
      if (mcqCorrectBoxes.length) {
        const checkedIdx = mcqCorrectBoxes.findIndex((cb) => cb.checked);
        if (checkedIdx === -1) return alert("Markera vilket alternativ som √§r r√§tt med bocken.");
        answerIndex = checkedIdx;
      }

      const links = currentMcqLinks.slice();

      const newQ = {
        type: "mcq",
        level,
        q: text,
        options: opts,
        answer: answerIndex,
        links: links
      };

      if (links.length) {
        newQ.goal = links[0].goal;
        newQ.parts = links[0].parts;
      }

      if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
      s.bank.mcq.push(newQ);
      saveState(s);

      mcqQuestion.value = "";
      mcqOpt0.value = "";
      mcqOpt1.value = "";
      mcqOpt2.value = "";
      mcqOpt3.value = "";
      if (mcqGoalPart) mcqGoalPart.value = "";
      currentMcqLinks = [];
      if (mcqLinksPreview) mcqLinksPreview.textContent = "Inga kopplingar √§nnu.";
      mcqCorrectBoxes.forEach((cb) => (cb.checked = false));

      renderMcqList();
      if (typeof syncUI === "function") syncUI();
    });
  }

  if (btnClear && !btnClear.__fvBound) {
    btnClear.__fvBound = true;
    btnClear.addEventListener("click", () => {
      mcqQuestion.value = "";
      mcqOpt0.value = "";
      mcqOpt1.value = "";
      mcqOpt2.value = "";
      mcqOpt3.value = "";
      if (mcqGoalPart) mcqGoalPart.value = "";
      currentMcqLinks = [];
      const preview = $("#mcqGoalLinksPreview");
      if (preview) preview.textContent = "Inga kopplingar √§nnu.";
      mcqCorrectBoxes.forEach((cb) => (cb.checked = false));
    });
  }

  if (btnQuickImport && txtQuick && !btnQuickImport.__fvBound) {
    btnQuickImport.__fvBound = true;
    btnQuickImport.addEventListener("click", () => {
      const raw = txtQuick.value.trim();
      if (!raw) return alert("Klistra in dina fr√•gor i rutan f√∂rst.");

      const blocks = raw
        .split(/\n\s*\n/)
        .map((b) => b.trim())
        .filter((b) => b.length);

      const s2 = loadState();
      if (!Array.isArray(s2.bank.mcq)) s2.bank.mcq = [];

      const levelForImport = (mcqLevel && mcqLevel.value) ? mcqLevel.value : "E";

      let linksForImport = [];
      if (mcqGoalPart && mcqGoalPart.value) linksForImport = getLinksFromIds([mcqGoalPart.value]);

      let added = 0;

      blocks.forEach((block) => {
        const lines = block.split("\n").map((l) => l.trim()).filter((l) => l.length);
        if (lines.length < 3) return;

        const question = lines[0];
        const answerLines = lines.slice(1);

        const opts = [];
        let correctIdx = 0;

        answerLines.forEach((line, idx) => {
          let text = line;
          if (text.startsWith("*")) {
            text = text.replace(/^\*\s*/, "");
            correctIdx = idx;
          }
          opts.push(text);
        });

        if (!question || opts.length < 2) return;

        const qObj = {
          type: "mcq",
          level: levelForImport,
          q: question,
          options: opts,
          answer: correctIdx
        };

        if (linksForImport.length) {
          qObj.links = linksForImport.slice();
          qObj.goal = linksForImport[0].goal;
          qObj.parts = linksForImport[0].parts;
        }

        s2.bank.mcq.push(qObj);
        added++;
      });

      saveState(s2);
      renderMcqList();
      if (typeof syncUI === "function") syncUI();
      alert(`Importerade ${added} fr√•gor.`);
    });
  }

  renderMcqList();
  populateGoalSelect("#mcqGoalPart");
}

/* =========================
   3h ‚Äì Bildfr√•gor (IMG) ‚Äì lista & editor
   ========================= */

function renderImgList() {
  const host = $("#imgList");
  const countEl = $("#imgCount");
  if (!host) return;

  const s = loadState();
  const list = (s.bank && s.bank.img) || [];

  host.innerHTML = "";
  if (countEl) countEl.textContent = String(list.length);

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga bildfr√•gor i banken √§nnu.";
    host.appendChild(li);
    return;
  }

  list.forEach((q, idx) => {
    const li = document.createElement("li");
    li.className = "list-item";

    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    else if (lvl === "A") tagClass = "level-a";

    const goalInfo = buildGoalInfoText(q);
    const hasThumb = !!q.imgDataUrl;

    const thumbHtml = hasThumb
      ? `<img src="${q.imgDataUrl}" alt="Miniatyr" style="max-width:60px;max-height:50px;border-radius:4px;object-fit:cover;">`
      : `<div style="font-size:0.75rem;opacity:0.7;">Ingen bild</div>`;

    li.innerHTML = `
      <div style="
        display:flex;
        align-items:flex-start;
        gap:8px;
        width:100%;
        border:1px solid rgba(148,163,184,0.5);
        border-radius:8px;
        padding:6px 8px;
      ">
        <div style="
          flex:0 0 72px;
          display:flex;
          align-items:center;
          justify-content:center;
        ">
          ${thumbHtml}
        </div>
        <div class="list-main" style="flex:1;">
          <div class="q-text">
            [${idx + 1}] ${escapeHtml(q.q || "")}
            <span class="level-tag ${tagClass}">${lvl}</span>
          </div>
          <div class="q-meta">${goalInfo}</div>
        </div>
        <div style="
          flex:0 0 auto;
          display:flex;
          align-items:center;
          justify-content:flex-end;
        ">
          <button class="btn btn-sm btn-danger" data-del-img-index="${idx}">üóëÔ∏è</button>
        </div>
      </div>
    `;
    host.appendChild(li);
  });

  host.querySelectorAll("button[data-del-img-index]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.getAttribute("data-del-img-index"));
      const s2 = loadState();
      if (!Array.isArray(s2.bank.img) || idx < 0 || idx >= s2.bank.img.length) return;
      s2.bank.img.splice(idx, 1);
      saveState(s2);
      renderImgList();
      if (typeof syncUI === "function") syncUI();
    });
  });
}

function initImageQuestionsEditor() {
  const imgLevel = $("#imgLevel");
  const imgQuestion = $("#imgQuestion");
  const imgOpt0 = $("#imgOption0");
  const imgOpt1 = $("#imgOption1");
  const imgOpt2 = $("#imgOption2");
  const imgOpt3 = $("#imgOption3");
  const imgFile = $("#imgFile");
  const imgPreview = $("#imgPreview");
  const imgGoalPart = $("#imgGoalPart");
  const btnAdd = $("#btnImgAdd");
  const btnClear = $("#btnImgClear");
  const btnAddGoalLink = $("#btnImgAddGoalLink");
  const imgAnswerNumber = $("#imgAnswer");
  const imgGoalLinksPreview = $("#imgGoalLinksPreview");

  const imgCorrect0 = $("#imgCorrect0");
  const imgCorrect1 = $("#imgCorrect1");
  const imgCorrect2 = $("#imgCorrect2");
  const imgCorrect3 = $("#imgCorrect3");
  const imgCorrectBoxes = [imgCorrect0, imgCorrect1, imgCorrect2, imgCorrect3].filter(Boolean);

  if (!imgLevel || !imgQuestion || !imgOpt0 || !imgOpt1 || !imgOpt2 || !imgOpt3 || !imgFile || !btnAdd) return;

  currentImgDataUrl = null;
  currentImgLinks = [];
  currentImgCorrectIndex = 0;

  if (imgAnswerNumber) {
    const container = imgAnswerNumber.closest(".field") || imgAnswerNumber.parentElement || imgAnswerNumber;
    container.style.display = "none";
  }

  if (imgFile && !imgFile.__fvBound) {
    imgFile.__fvBound = true;
    imgFile.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        currentImgDataUrl = null;
        if (imgPreview) imgPreview.textContent = "Ingen bild vald √§nnu.";
        return;
      }
      const reader = new FileReader();
      reader.onload = function () {
        currentImgDataUrl = reader.result;
        if (imgPreview) {
          imgPreview.innerHTML = `<img src="${currentImgDataUrl}" alt="F√∂rhandsgranskning" style="max-width:100%;max-height:80px;border-radius:8px;">`;
        }
      };
      reader.readAsDataURL(file);
    });
  }

  if (imgGoalLinksPreview) imgGoalLinksPreview.textContent = "Inga kopplingar √§nnu.";

  if (btnAddGoalLink && imgGoalPart && !btnAddGoalLink.__fvBound) {
    btnAddGoalLink.__fvBound = true;
    btnAddGoalLink.addEventListener("click", () => {
      const val = imgGoalPart.value;
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!currentImgLinks.some((x) => String(x.id) === String(link.id))) currentImgLinks.push(link);

      if (imgGoalLinksPreview) {
        imgGoalLinksPreview.innerHTML = currentImgLinks
          .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
          .join(" ");
      }
    });
  }

  if (!btnAdd.__fvBound) {
    btnAdd.__fvBound = true;
    btnAdd.addEventListener("click", () => {
      const s = loadState();
      const level = imgLevel.value || "E";
      const text = (imgQuestion.value || "").trim();

      const v0 = (imgOpt0.value || "").trim();
      const v1 = (imgOpt1.value || "").trim();
      const v2 = (imgOpt2.value || "").trim();
      const v3 = (imgOpt3.value || "").trim();

      if (!currentImgDataUrl) return alert("V√§lj en bild f√∂r bildfr√•gan.");
      if (!text) return alert("Skriv en fr√•ga.");
      if (!v0 || !v1 || !v2 || !v3) return alert("Skriv exakt fyra svarsalternativ (alla fyra m√•ste vara ifyllda).");

      const opts = [v0, v1, v2, v3];

      let ans = 0;
      if (imgCorrectBoxes.length) {
        const checkedIdx = imgCorrectBoxes.findIndex((cb) => cb.checked);
        if (checkedIdx === -1) return alert("Markera vilket alternativ som √§r r√§tt med bocken.");
        ans = checkedIdx;
      }

      const links = currentImgLinks.slice();
      const qObj = {
        type: "img",
        level,
        q: text,
        options: opts,
        answer: ans,
        imgDataUrl: currentImgDataUrl,
        links: links
      };

      if (links.length) {
        qObj.goal = links[0].goal;
        qObj.parts = links[0].parts;
      }

      if (!Array.isArray(s.bank.img)) s.bank.img = [];
      s.bank.img.push(qObj);
      saveState(s);

      currentImgDataUrl = null;
      currentImgLinks = [];
      currentImgCorrectIndex = 0;
      imgQuestion.value = "";
      imgOpt0.value = "";
      imgOpt1.value = "";
      imgOpt2.value = "";
      imgOpt3.value = "";
      imgFile.value = "";
      if (imgPreview) imgPreview.textContent = "Ingen bild vald √§nnu.";
      if (imgGoalPart) imgGoalPart.value = "";
      if (imgGoalLinksPreview) imgGoalLinksPreview.textContent = "Inga kopplingar √§nnu.";
      imgCorrectBoxes.forEach((cb) => (cb.checked = false));

      renderImgList();
      if (typeof syncUI === "function") syncUI();
    });
  }

  if (btnClear && !btnClear.__fvBound) {
    btnClear.__fvBound = true;
    btnClear.addEventListener("click", () => {
      imgQuestion.value = "";
      imgOpt0.value = "";
      imgOpt1.value = "";
      imgOpt2.value = "";
      imgOpt3.value = "";
      imgFile.value = "";
      if (imgPreview) imgPreview.textContent = "Ingen bild vald √§nnu.";
      if (imgGoalPart) imgGoalPart.value = "";
      if (imgGoalLinksPreview) imgGoalLinksPreview.textContent = "Inga kopplingar √§nnu.";
      currentImgDataUrl = null;
      currentImgLinks = [];
      currentImgCorrectIndex = 0;
      imgCorrectBoxes.forEach((cb) => (cb.checked = false));
    });
  }

  populateGoalSelect("#imgGoalPart");
  renderImgList();
}

/* =========================
   3i ‚Äì Drag & Drop-fr√•gor ‚Äì lista & editor
   ========================= */

function renderDragList() {
  const host = $("#dragList");
  const countEl = $("#dragCount");
  if (!host) return;

  const s = loadState();
  const list = (s.bank && s.bank.drag) || [];

  host.innerHTML = "";
  if (countEl) countEl.textContent = String(list.length);

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga drag & drop-fr√•gor i banken √§nnu.";
    host.appendChild(li);
    return;
  }

  list.forEach((q, idx) => {
    const li = document.createElement("li");
    li.className = "list-item";

    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    else if (lvl === "A") tagClass = "level-a";

    const sources = Array.isArray(q.dragSources) ? q.dragSources : [];
    const targets = Array.isArray(q.dragTargets) ? q.dragTargets : [];
    const goalInfo = buildGoalInfoText(q);

    const srcLabels = sources.map((s) => s.label).join(", ");
    const tgtLabels = targets.map((t) => t.label).join(", ");

    li.innerHTML = `
      <div style="
        display:flex;
        align-items:flex-start;
        gap:8px;
        width:100%;
        border:1px solid rgba(148,163,184,0.5);
        border-radius:8px;
        padding:6px 8px;
      ">
        <div style="
          flex:0 0 72px;
          display:flex;
          align-items:center;
          justify-content:center;
          font-size:0.75rem;
          opacity:0.8;
        ">
          Drag
        </div>
        <div class="list-main" style="flex:1;">
          <div class="q-text">
            [${idx + 1}] ${escapeHtml(q.q || "")}
            <span class="level-tag ${tagClass}">${lvl}</span>
          </div>
          <div class="q-meta">
            Korten: ${escapeHtml(srcLabels || "-")}<br>
            Kategorier: ${escapeHtml(tgtLabels || "-")}
          </div>
          <div class="q-meta">${goalInfo}</div>
        </div>
        <div style="
          flex:0 0 auto;
          display:flex;
          align-items:center;
          justify-content:flex-end;
        ">
          <button class="btn btn-sm btn-danger" data-del-drag-index="${idx}">üóëÔ∏è</button>
        </div>
      </div>
    `;
    host.appendChild(li);
  });

  host.querySelectorAll("button[data-del-drag-index]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.getAttribute("data-del-drag-index"));
      const s2 = loadState();
      if (!Array.isArray(s2.bank.drag) || idx < 0 || idx >= s2.bank.drag.length) return;
      s2.bank.drag.splice(idx, 1);
      saveState(s2);
      renderDragList();
      if (typeof syncUI === "function") syncUI();
    });
  });
}

function initDragDropQuestionsEditor() {
  const dragLevel = $("#dragLevel");
  const dragQuestion = $("#dragQuestion");
  const dragItems = $("#dragItemText") ? null : $("#dragItems");
  const dragCategories = $("#dragColumn1") ? null : $("#dragCategories");
  const dragGoalPart = $("#dragGoalPart");
  const dragLinksPreview = $("#dragGoalLinksPreview");
  const btnAdd = $("#btnDragAddQuestion") || $("#btnDragAdd");
  const btnClear = $("#btnDragClearForm") || $("#btnDragClear");
  const btnAddGoalLink = $("#btnDragAddGoalLink");
  const btnBuildMapping = $("#btnDragBuildMapping");
  const mappingArea = $("#dragMappingArea") || $("#dragItemsPreview");

  currentDragLinks = [];
  currentDragSourcesTmp = [];
  currentDragTargetsTmp = [];
  currentDragCorrectMapTmp = {};

  if (dragLinksPreview) dragLinksPreview.textContent = "Inga kopplingar √§nnu.";

  if (btnAddGoalLink && !btnAddGoalLink.__fvBound) {
    btnAddGoalLink.__fvBound = true;
    btnAddGoalLink.addEventListener("click", () => {
      const val = dragGoalPart ? dragGoalPart.value : "";
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!currentDragLinks.some((x) => String(x.id) === String(link.id))) currentDragLinks.push(link);

      if (dragLinksPreview) {
        dragLinksPreview.innerHTML = currentDragLinks
          .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
          .join(" ");
      }
    });
  }

  if (btnBuildMapping && mappingArea && dragItems && dragCategories && !btnBuildMapping.__fvBound) {
    btnBuildMapping.__fvBound = true;
    btnBuildMapping.addEventListener("click", () => {
      const srcLines = (dragItems.value || "").split("\n").map((x) => x.trim()).filter((x) => x.length);
      const catLines = (dragCategories.value || "").split("\n").map((x) => x.trim()).filter((x) => x.length);

      if (!srcLines.length || !catLines.length) return alert("Skriv minst ett kort och minst en kategori f√∂rst.");

      currentDragSourcesTmp = srcLines.map((label, idx) => ({ id: "s" + idx, label }));
      currentDragTargetsTmp = catLines.map((label, idx) => ({ id: "t" + idx, label }));
      currentDragCorrectMapTmp = {};

      mappingArea.innerHTML = "";
      const info = document.createElement("p");
      info.className = "mini";
      info.textContent = "V√§lj kategori f√∂r varje kort:";
      mappingArea.appendChild(info);

      currentDragSourcesTmp.forEach((src) => {
        const row = document.createElement("div");
        row.className = "card-row";
        row.style.alignItems = "center";

        const lblField = document.createElement("div");
        lblField.className = "field";
        lblField.style.flex = "1";
        lblField.innerHTML = `<span>${escapeHtml(src.label)}</span>`;

        const selField = document.createElement("div");
        selField.className = "field";
        selField.style.flex = "1";

        const sel = document.createElement("select");
        sel.className = "input";
        sel.dataset.sourceId = src.id;

        currentDragTargetsTmp.forEach((tgt) => {
          const opt = document.createElement("option");
          opt.value = tgt.id;
          opt.textContent = tgt.label;
          sel.appendChild(opt);
        });

        sel.addEventListener("change", () => {
          const sid = sel.dataset.sourceId;
          const tid = sel.value;
          if (sid && tid) currentDragCorrectMapTmp[sid] = tid;
        });

        if (currentDragTargetsTmp.length) {
          sel.value = currentDragTargetsTmp[0].id;
          currentDragCorrectMapTmp[src.id] = currentDragTargetsTmp[0].id;
        }

        selField.appendChild(sel);
        row.appendChild(lblField);
        row.appendChild(selField);
        mappingArea.appendChild(row);
      });
    });
  }

  if (btnAdd && !btnAdd.__fvBound) {
    btnAdd.__fvBound = true;
    btnAdd.addEventListener("click", () => {
      const s = loadState();
      const level = dragLevel ? (dragLevel.value || "E") : "E";
      const text = (dragQuestion && dragQuestion.value.trim()) || "";

      if (!text) return alert("Skriv fr√•getext f√∂rst.");
      if (!currentDragSourcesTmp.length || !currentDragTargetsTmp.length) return alert("Bygg f√∂rst upp kort och kategorier via 'Bygg f√∂rdelning'.");

      for (const src of currentDragSourcesTmp) {
        if (!currentDragCorrectMapTmp[src.id]) return alert("Alla kort m√•ste ha en vald kategori.");
      }

      const links = currentDragLinks.slice();
      const qObj = {
        type: "drag",
        level,
        q: text,
        dragSources: currentDragSourcesTmp.slice(),
        dragTargets: currentDragTargetsTmp.slice(),
        correctMap: Object.assign({}, currentDragCorrectMapTmp),
        links: links
      };

      if (links.length) {
        qObj.goal = links[0].goal;
        qObj.parts = links[0].parts;
      }

      if (!Array.isArray(s.bank.drag)) s.bank.drag = [];
      s.bank.drag.push(qObj);
      saveState(s);

      if (dragQuestion) dragQuestion.value = "";
      if (dragItems) dragItems.value = "";
      if (dragCategories) dragCategories.value = "";
      if (dragGoalPart) dragGoalPart.value = "";
      if (dragLinksPreview) dragLinksPreview.textContent = "Inga kopplingar √§nnu.";
      if (mappingArea) mappingArea.textContent = "Inget f√∂rdelat √§nnu ‚Äì skriv kort och kategorier och klicka sedan p√• knappen.";

      currentDragLinks = [];
      currentDragSourcesTmp = [];
      currentDragTargetsTmp = [];
      currentDragCorrectMapTmp = {};

      renderDragList();
      if (typeof syncUI === "function") syncUI();
    });
  }

  if (btnClear && !btnClear.__fvBound) {
    btnClear.__fvBound = true;
    btnClear.addEventListener("click", () => {
      if (dragQuestion) dragQuestion.value = "";
      if (dragItems) dragItems.value = "";
      if (dragCategories) dragCategories.value = "";
      if (dragGoalPart) dragGoalPart.value = "";
      if (dragLinksPreview) dragLinksPreview.textContent = "Inga kopplingar √§nnu.";
      if (mappingArea) mappingArea.textContent = "Inget f√∂rdelat √§nnu ‚Äì skriv kort och kategorier och klicka sedan p√• knappen.";
      currentDragLinks = [];
      currentDragSourcesTmp = [];
      currentDragTargetsTmp = [];
      currentDragCorrectMapTmp = {};
    });
  }

  populateGoalSelect("#dragGoalPart");
  renderDragList();
}

/* =========================
   3j ‚Äì L√§rarl√§ge: l√∂senord, e-post, niv√•gr√§nser
   ========================= */

function initTeacherPasswordSettings() {
  const statusEl = $("#passwordStatus");
  const btnChange = $("#btnChangeTeacherPassword");
  const inputOld = $("#inputOldPassword");
  const inputNew = $("#inputNewPassword");
  const inputNewRepeat = $("#inputNewPasswordRepeat");

  if (!btnChange || btnChange.__fvBound) return;

  btnChange.__fvBound = true;
  btnChange.addEventListener("click", () => {
    const s = loadState();
    const current = s.teacherPassword;
    const oldVal = (inputOld && inputOld.value) || "";
    const newVal = (inputNew && inputNew.value) || "";
    const repeatVal = (inputNewRepeat && inputNewRepeat.value) || "";

    if (!newVal || !repeatVal) {
      if (statusEl) statusEl.textContent = "Nytt l√∂senord f√•r inte vara tomt.";
      return;
    }
    if (newVal !== repeatVal) {
      if (statusEl) statusEl.textContent = "Nya l√∂senorden matchar inte.";
      return;
    }
    if (current && oldVal !== current) {
      if (statusEl) statusEl.textContent = "Nuvarande l√∂senord st√§mmer inte.";
      return;
    }
    s.teacherPassword = newVal;
    saveState(s);
    if (statusEl) statusEl.textContent = "L√§rarl√∂senord uppdaterat.";
    if (inputOld) inputOld.value = "";
    if (inputNew) inputNew.value = "";
    if (inputNewRepeat) inputNewRepeat.value = "";
  });
}

function initTeacherEmailSettings() {
  const inputEmail = $("#inputTeacherEmail");
  const btnSave = $("#btnSaveTeacherEmail");
  const statusEl = $("#teacherEmailStatus");
  const s = loadState();

  if (inputEmail) inputEmail.value = s.teacherEmail || "";

  if (btnSave && !btnSave.__fvBound) {
    btnSave.__fvBound = true;
    btnSave.addEventListener("click", () => {
      const val = (inputEmail && inputEmail.value.trim()) || "";
      const s2 = loadState();
      s2.teacherEmail = val;
      saveState(s2);
      if (statusEl) statusEl.textContent = val ? "E-postadress sparad." : "E-postadress rensad.";
    });
  }
}

function initThresholdSettings() {
  const inputE = $("#inputThresE");
  const inputC = $("#inputThresC");
  const inputA = $("#inputThresA");
  const btnSave = $("#btnSaveThresholds");
  const s = loadState();

  if (inputE) inputE.value = s.thres.E;
  if (inputC) inputC.value = s.thres.C;
  if (inputA) inputA.value = s.thres.A;

  if (btnSave && !btnSave.__fvBound) {
    btnSave.__fvBound = true;
    btnSave.addEventListener("click", () => {
      const s2 = loadState();
      if (inputE) s2.thres.E = clampInt(inputE.value, 0, 100);
      if (inputC) s2.thres.C = clampInt(inputC.value, 0, 100);
      if (inputA) s2.thres.A = clampInt(inputA.value, 0, 100);
      saveState(s2);
      if (typeof syncUI === "function") syncUI();
    });
  }
}

/* =========================
   3k ‚Äì L√§rarl√§ge: gate, modal & flikar
   ========================= */

function openTeacherGate() {
  const gate = $("#teacherGate");
  const text = $("#teacherGateText");
  const input = $("#teacherPasswordInput");
  const s = loadState();
  if (!gate || !text || !input) return;

  gate.classList.remove("hidden");
  input.value = "";
  text.textContent = s.teacherPassword
    ? "Ange l√§rarl√∂senord f√∂r att √∂ppna l√§rarl√§get."
    : "F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.";
}

function closeTeacherGate() {
  const gate = $("#teacherGate");
  if (gate) gate.classList.add("hidden");
}

function openTeacherModal() {
  const modal = $("#teacherModal");
  if (modal) modal.classList.remove("hidden");
}

function closeTeacherModal() {
  const modal = $("#teacherModal");
  if (modal) modal.classList.add("hidden");
}

function handleTeacherConfirm() {
  const input = $("#teacherPasswordInput");
  if (!input) return;
  const value = input.value;
  const s = loadState();

  if (!s.teacherPassword) {
    s.teacherPassword = value;
    saveState(s);
    closeTeacherGate();
    openTeacherModal();
    return;
  }

  if (value === s.teacherPassword) {
    closeTeacherGate();
    openTeacherModal();
  } else {
    alert("Fel l√§rarl√∂senord.");
  }
}

function setupTabNavigation() {
  const tabs = $all(".tab-btn");
  const panels = $all(".tab-panel");

  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const target = tab.getAttribute("data-tab");
      tabs.forEach((t) => t.classList.remove("active"));
      panels.forEach((p) => p.classList.add("hidden"));

      tab.classList.add("active");
      const panel = document.querySelector(`.tab-panel[data-panel="${target}"]`);
      if (panel) panel.classList.remove("hidden");
    });
  });
}

/* =========================
   3l ‚Äì S√§ker bank-status
   ========================= */

function updateBankStatusUI() {
  try {
    if (typeof updateActiveBankBanner === "function") updateActiveBankBanner();
  } catch (_) {}

  const s = loadState();
  const bank = s.bank || {};
  const mcqCount = Array.isArray(bank.mcq) ? bank.mcq.length : 0;
  const imgCount = Array.isArray(bank.img) ? bank.img.length : 0;
  const dragCount = Array.isArray(bank.drag) ? bank.drag.length : 0;

  const el = document.getElementById("cloudBankStatus");
  if (!el) return;

  if (!mcqCount && !imgCount && !dragCount) {
    el.textContent = "Ingen fr√•gebank aktiverad √§nnu. Skapa fr√•gor eller ladda en bank fr√•n molnet.";
  } else {
    el.textContent = `Aktiv fr√•gebank: ${mcqCount} flervalsfr√•gor, ${imgCount} bildfr√•gor, ${dragCount} drag & drop-fr√•gor.`;
  }
}

/* =========================
   3m ‚Äì Flytta bockarna (endast MCQ/IMG) till v√§nster
   ========================= */

function repositionOptionCheckboxes() {
  const cbs = Array.from(document.querySelectorAll('input[type="checkbox"][id^="mcqCorrect"], input[type="checkbox"][id^="imgCorrect"]'));
  cbs.forEach((cb) => {
    const textInput = cb.nextElementSibling;
    if (!textInput || textInput.tagName !== "INPUT" || textInput.type !== "text") return;
    if (cb.closest(".option-row-flex")) return;

    const parent = cb.parentNode;
    if (!parent) return;

    const wrapper = document.createElement("div");
    wrapper.className = "option-row-flex";
    wrapper.style.display = "flex";
    wrapper.style.alignItems = "center";
    wrapper.style.gap = "6px";

    parent.insertBefore(wrapper, cb);
    wrapper.appendChild(cb);
    wrapper.appendChild(textInput);
  });
}

window.addEventListener("load", repositionOptionCheckboxes);
</script>
<!-- slut SEKTION 3B: FR√ÖGEEDITORER, L√ÑRARL√ÑGE & NAVIGATION -->


<!-- start SEKTION 3C: PUBLIK FR√ÖGEBANK & ELEV-L√ÑNK (FIX: ?bank=ID + AUTOLOAD bank/sharedBank/sb) -->
<script>
(function () {
  "use strict";

  /* =========================
     3m ‚Äì Publicera fr√•gebank som elevl√§nk + autoload fr√•n URL
     - Skapar elevl√§nk som: ?bank=ID (kompatibel med din GitHub-l√§nk)
     - L√§ser b√•de: ?bank=ID, ?sharedBank=ID, ?sb=ID
     ========================= */

  if (window.__fvSharedV3CInit) return;
  window.__fvSharedV3CInit = true;

  function fvGetQueryParam(key) {
    try {
      if (typeof getQueryParam === "function") return getQueryParam(key);
    } catch (_) {}
    try {
      return new URL(window.location.href).searchParams.get(key);
    } catch (_) {}
    return null;
  }

  function fvGetSharedIdFromUrl() {
    return (
      fvGetQueryParam("bank") ||
      fvGetQueryParam("sharedBank") ||
      fvGetQueryParam("sb") ||
      null
    );
  }

  function fvGetDb() {
    try {
      if (typeof firebaseDbInstance !== "undefined" && firebaseDbInstance) return firebaseDbInstance;
    } catch (_) {}
    try {
      if (window.firebaseDbInstance) return window.firebaseDbInstance;
    } catch (_) {}
    try {
      if (window.firebase && window.firebase.firestore) return window.firebase.firestore();
    } catch (_) {}
    return null;
  }

  function fvGetAuth() {
    try {
      if (typeof firebaseAuthInstance !== "undefined" && firebaseAuthInstance) return firebaseAuthInstance;
    } catch (_) {}
    try {
      if (window.firebaseAuthInstance) return window.firebaseAuthInstance;
    } catch (_) {}
    return null;
  }

  function fvSetActiveSharedBankId(id) {
    const clean = (id || "").trim();
    try { window.activeSharedBankId = clean; } catch (_) {}
    try { window.activeCloudBankId = null; } catch (_) {}

    try {
      const s = (typeof loadState === "function") ? loadState() : {};
      s.linkedSharedBankId = clean;
      s.activeSharedBankId = clean;
      if (typeof saveState === "function") saveState(s);
      else {
        try { localStorage.setItem("fangvaktaren-v17", JSON.stringify(s)); } catch (_) {}
      }
    } catch (_) {}
  }

  async function fvAutoloadSharedBankFromUrl() {
    try {
      const sharedId = fvGetSharedIdFromUrl();
      if (!sharedId) {
        // Ingen parameter, helt OK
        return;
      }

      if (window.__fvSharedBankLoadedId === sharedId) return;

      const db = fvGetDb();
      if (!db) {
        // v√§nta p√• firebaseDbInstance
        return;
      }

      const doc = await db.collection("sharedBanks").doc(sharedId).get();
      if (!doc.exists) {
        console.warn("autoLoadSharedBank: hittade ingen sharedBanks-dokument f√∂r ID:", sharedId);
        return;
      }

      const data = doc.data() || {};
      const bank = data.bank || null;

      if (!bank) {
        console.warn("autoLoadSharedBank: dokument finns men saknar bank:", sharedId);
        return;
      }

      // S√§tt aktiv bank-id s√• inl√§mning/progression kan hitta r√§tt direkt
      fvSetActiveSharedBankId(sharedId);
      window.__fvSharedBankLoadedId = sharedId;

      // L√§gg in bank i state (minsta kompatibla s√§tt)
      try {
        const s = (typeof loadState === "function") ? loadState() : {};
        s.bank = bank;
        s.bankMeta = s.bankMeta || {};
        s.bankMeta.sharedBankId = sharedId;
        s.bankMeta.name = data.name || s.bankMeta.name || "";
        if (typeof saveState === "function") saveState(s);
        else {
          try { localStorage.setItem("fangvaktaren-v17", JSON.stringify(s)); } catch (_) {}
        }
      } catch (_) {}

      // F√∂rs√∂k uppdatera UI om funktioner finns
      try {
        if (typeof applyBankToEditorState === "function") applyBankToEditorState(bank);
      } catch (_) {}
      try {
        if (typeof syncUI === "function") syncUI();
      } catch (_) {}
      try {
        if (typeof updateBankStatusUI === "function") updateBankStatusUI();
      } catch (_) {}

      console.log("autoLoadSharedBank: laddade shared bank OK:", sharedId);
    } catch (err) {
      console.error("autoLoadSharedBank: fel:", err);
    }
  }

  async function publishCurrentBankAsShared() {
    const statusEl = document.getElementById("sharedBankStatus");
    const linkOutput = document.getElementById("sharedBankLinkOutput");
    const nameInput = document.getElementById("inputBankName");

    function setStatus(msg) {
      if (statusEl) statusEl.textContent = msg;
    }

    try {
      const db = fvGetDb();
      const auth = fvGetAuth();

      if (!window.firebase || !db || !auth) {
        setStatus("Firebase √§r inte redo. Logga in med Google och f√∂rs√∂k igen.");
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        setStatus("Du m√•ste vara inloggad med Google f√∂r att skapa en elevl√§nk.");
        return;
      }

      const s = (typeof loadState === "function") ? loadState() : {};
      const rawBank = s.bank || {};
      const bank = (typeof sanitizeForFirestore === "function") ? sanitizeForFirestore(rawBank) : rawBank;

      const hasMcq = Array.isArray(bank.mcq) && bank.mcq.length > 0;
      const hasImg = Array.isArray(bank.img) && bank.img.length > 0;
      const hasDrag = Array.isArray(bank.drag) && bank.drag.length > 0;

      if (!hasMcq && !hasImg && !hasDrag) {
        setStatus("Det finns inga fr√•gor i den aktuella banken att publicera.");
        return;
      }

      const bankName = (nameInput && nameInput.value.trim()) || "Fr√•gebank utan namn";
      setStatus("Publicerar fr√•gebank...");

      const payload = {
        ownerUid: user.uid,
        ownerEmail: user.email || null,
        name: bankName,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        bank: bank
      };

      const docRef = await db.collection("sharedBanks").add(payload);
      const sharedId = docRef.id;

      const baseUrl = window.location.origin + window.location.pathname;
      const shareUrl = baseUrl + "?bank=" + encodeURIComponent(sharedId); // ‚úÖ viktig fix

      if (linkOutput) {
        linkOutput.value = shareUrl;
        try { linkOutput.focus(); linkOutput.select(); } catch (_) {}
      } else {
        try { prompt("Kopiera elevl√§nken:", shareUrl); } catch (_) {}
      }

      // S√§tt aktivt s√• l√§rarfliken kan l√§sa resultat direkt utan extra steg
      fvSetActiveSharedBankId(sharedId);

      setStatus("Elevl√§nk skapad. Kopiera l√§nken och skicka till eleverna.");
    } catch (err) {
      console.error("Fel vid publicering av fr√•gebank:", err);
      const statusMsg = err && err.message ? "Fel vid publicering: " + err.message : "Fel vid publicering. Se konsolen.";
      if (statusEl) statusEl.textContent = statusMsg;
    }
  }

  function setupPublishSharedBank() {
    const btnPublish = document.getElementById("btnPublishSharedBank");
    if (!btnPublish) return;

    if (btnPublish.__fvBound) return;
    btnPublish.__fvBound = true;

    btnPublish.addEventListener("click", function () {
      publishCurrentBankAsShared();
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    setupPublishSharedBank();

    // Autoload direkt + retry medan firebase init:ar
    fvAutoloadSharedBankFromUrl();
    let tries = 25;
    const t = setInterval(function () {
      fvAutoloadSharedBankFromUrl();
      tries--;
      if (tries <= 0) clearInterval(t);
    }, 250);
  });

  // Exponera (om andra sektioner anropar den)
  window.publishCurrentBankAsShared = publishCurrentBankAsShared;
  window.autoLoadSharedBank = fvAutoloadSharedBankFromUrl;
})();
</script>
<!-- slut SEKTION 3C: PUBLIK FR√ÖGEBANK & ELEV-L√ÑNK (FIX: ?bank=ID + AUTOLOAD bank/sharedBank/sb) -->



<!-- start SEKTION 3X: ELEVPROGRESSION (NY DESIGN + DELETE-BREDVID VARJE ELEV) -->
<script>
(function () {
  "use strict";

  // ====== VERSION: 3X v9 (fix: delete-knapp bredvid varje elev, h√•rda inline-stilar) ======
  if (window.__fvProgV9Init) return;
  window.__fvProgV9Init = true;

  const RESULTS_COLLECTION_NAME = "results";

  function fvEnsureStyles() {
    if (document.getElementById("fvProgV9Styles")) return;
    const st = document.createElement("style");
    st.id = "fvProgV9Styles";
    st.textContent = `
      #fvStudentList{ padding-left:0; margin:0; }
      #fvStudentList li{ list-style:none; }
      .fv-del{
        display:inline-flex !important;
        align-items:center !important;
        justify-content:center !important;
        min-width:44px !important;
        padding:8px 10px !important;
        border-radius:10px !important;
        border:1px solid var(--border,#1f2937) !important;
        background: transparent !important;
        color: var(--text,#e5e7eb) !important;
        cursor:pointer !important;
      }
      .fv-del:hover{ filter:brightness(1.1); }
      .fv-del:active{ transform: translateY(1px); }
    `;
    document.head.appendChild(st);
  }

  function fvGetState() {
    try { if (typeof loadState === "function") return loadState(); } catch (_) {}
    try { const raw = localStorage.getItem("fangvaktaren-v17"); return raw ? JSON.parse(raw) : {}; } catch (_) {}
    return {};
  }
  function fvSaveState(s) {
    try { if (typeof saveState === "function") return saveState(s); } catch (_) {}
    try { localStorage.setItem("fangvaktaren-v17", JSON.stringify(s || {})); } catch (_) {}
  }

  function fvGetQueryParamSafe(key) {
    try { if (typeof getQueryParam === "function") return getQueryParam(key); } catch (_) {}
    try { return new URL(window.location.href).searchParams.get(key); } catch (_) {}
    return null;
  }

  function fvGetDb() {
    try { if (typeof firebaseDbInstance !== "undefined" && firebaseDbInstance) return firebaseDbInstance; } catch (_) {}
    try { if (window.firebaseDbInstance) return window.firebaseDbInstance; } catch (_) {}
    try { if (window.firebase && window.firebase.firestore) return window.firebase.firestore(); } catch (_) {}
    return null;
  }

  function fvToDate(v) {
    try { if (v && typeof v.toDate === "function") return v.toDate(); } catch (_) {}
    return v instanceof Date ? v : null;
  }
  function fvFmtDate(d) {
    try { if (d instanceof Date) return d.toLocaleString("sv-SE"); } catch (_) {}
    return "";
  }
  function fvPickScore(d) {
    if (typeof d.scorePercent === "number") return d.scorePercent;
    if (typeof d.percent === "number") return d.percent;
    if (typeof d.score === "number") return d.score;
    return null;
  }
  function fvNormalizeEntry(docId, d) {
    return {
      id: docId,
      studentName: d.studentName || d.name || "",
      studentClass: d.studentClass || d.class || d.className || "",
      level: d.level || d.levelId || d.levelName || null,
      score: fvPickScore(d),
      correct: typeof d.correct === "number" ? d.correct : null,
      total: typeof d.total === "number" ? d.total : null,
      totalPoints: typeof d.totalPoints === "number" ? d.totalPoints : null,
      bestE: d.bestE != null ? d.bestE : null,
      bestC: d.bestC != null ? d.bestC : null,
      bestA: d.bestA != null ? d.bestA : null,
      strongGoals: Array.isArray(d.strongGoals) ? d.strongGoals : [],
      weakGoals: Array.isArray(d.weakGoals) ? d.weakGoals : [],
      goalPassThreshold: typeof d.goalPassThreshold === "number" ? d.goalPassThreshold : null,
      createdAt: fvToDate(d.createdAt)
    };
  }

  function fvKey(e) {
    return (e.studentName || "").trim().toLowerCase() + "|||" + (e.studentClass || "").trim().toLowerCase();
  }

  function fvGetLinkedSharedBankId() {
    try { if (window.activeSharedBankId) return window.activeSharedBankId; } catch (_) {}
    const fromUrl =
      fvGetQueryParamSafe("bank") ||
      fvGetQueryParamSafe("sharedBank") ||
      fvGetQueryParamSafe("sb");
    if (fromUrl) return fromUrl;
    const s = fvGetState();
    if (s && s.linkedSharedBankId) return s.linkedSharedBankId;
    return "";
  }

  function fvSetLinkedSharedBankId(id) {
    const clean = (id || "").trim();
    try { window.activeSharedBankId = clean; } catch (_) {}
    const s = fvGetState();
    s.linkedSharedBankId = clean;
    fvSaveState(s);

    const inp = document.getElementById("fvLinkedSharedBankId");
    if (inp) inp.value = clean;

    const st = document.getElementById("fvLinkStatus");
    if (st) st.textContent = clean ? ("Kopplad till sharedBank-id: " + clean) : "Ingen sharedBank kopplad √§nnu.";
  }

  function fvFindProgressHost() {
    return (
      document.querySelector('.tab-panel[data-panel="progress"]') ||
      document.querySelector('.tab-panel[data-panel="elevprogression"]') ||
      document.querySelector("#teacherModal .modal-body") ||
      document.getElementById("teacherModal") ||
      document.body
    );
  }

  function fvRemoveDuplicateLinkBoxesByTitle() {
    const titles = Array.from(document.querySelectorAll("h4"))
      .filter((h) => (h.textContent || "").trim() === "Koppla elevresultat (sharedBank-id)");
    if (titles.length <= 1) return;
    for (let i = titles.length - 1; i >= 1; i--) {
      const box = titles[i].closest(".progress-box") || titles[i].parentElement;
      if (box && box.parentNode) box.parentNode.removeChild(box);
    }
  }

  function fvCleanupOldProgressStuff() {
    const killIds = [
      "progressStudentListBox","progressStudentPointsBox","progressStrongGoalsBox","progressWeakGoalsBox",
      "teacherStudentList","progressStudentDetail","teacherHighscoreList","progressHighscoreBox","progressStudentsBox",
      "fvProgRoot","fvBoxLink","fvBoxStudents","fvBoxHighscore","fvBoxStrong","fvBoxWeak","fvBoxExport",
      "fvLinkedSharedBankId","fvBtnLinkBank","fvBtnClearBank","fvBtnRefresh","fvLinkStatus",
      "fvStudentList","fvStudentDetail","fvHighscoreList","fvStrongList","fvWeakList","fvBtnExport","fvExportOutput",
      "fvBtnDeleteSelected","fvSelectedActions"
    ];
    killIds.forEach((id) => {
      const el = document.getElementById(id);
      if (el && el.parentNode) el.parentNode.removeChild(el);
    });
    Array.from(document.querySelectorAll(".progress-grid")).forEach((g) => {
      if (g && g.parentNode) g.parentNode.removeChild(g);
    });
    fvRemoveDuplicateLinkBoxesByTitle();
  }

  function fvEnsureRoot() {
    const host = fvFindProgressHost();
    if (!host) return null;
    let root = document.getElementById("fvProgRoot");
    if (root) return root;
    root = document.createElement("div");
    root.id = "fvProgRoot";
    root.className = "progress-grid";
    try { host.prepend(root); } catch (_) { host.appendChild(root); }
    return root;
  }

  function fvBox(titleText, id) {
    const root = fvEnsureRoot();
    if (!root) return null;
    let box = document.getElementById(id);
    if (box) return box;
    box = document.createElement("div");
    box.id = id;
    box.className = "progress-box";
    const h = document.createElement("h4");
    h.textContent = titleText;
    box.appendChild(h);
    root.appendChild(box);
    return box;
  }

  function fvBuildUI() {
    fvEnsureStyles();
    fvCleanupOldProgressStuff();

    const linkBox = fvBox("Koppla elevresultat (sharedBank-id)", "fvBoxLink");
    if (linkBox) {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.alignItems = "center";
      row.style.flexWrap = "wrap";

      const inp = document.createElement("input");
      inp.id = "fvLinkedSharedBankId";
      inp.className = "input";
      inp.placeholder = "Klistra in sharedBank-id (t.ex. fr√•n ?bank=ID)";
      inp.style.flex = "1";
      inp.autocomplete = "off";

      const btnLink = document.createElement("button");
      btnLink.id = "fvBtnLinkBank";
      btnLink.type = "button";
      btnLink.className = "btn btn-sm btn-primary";
      btnLink.textContent = "Koppla";

      const btnClear = document.createElement("button");
      btnClear.id = "fvBtnClearBank";
      btnClear.type = "button";
      btnClear.className = "btn btn-sm";
      btnClear.textContent = "Rensa";

      const btnRefresh = document.createElement("button");
      btnRefresh.id = "fvBtnRefresh";
      btnRefresh.type = "button";
      btnRefresh.className = "btn btn-sm";
      btnRefresh.textContent = "Uppdatera";

      row.appendChild(inp);
      row.appendChild(btnLink);
      row.appendChild(btnClear);
      row.appendChild(btnRefresh);

      const st = document.createElement("div");
      st.id = "fvLinkStatus";
      st.className = "mini";
      st.style.marginTop = "8px";
      st.textContent = "Ingen sharedBank kopplad √§nnu.";

      linkBox.appendChild(row);
      linkBox.appendChild(st);
    }

    const studentsBox = fvBox("Elever (senaste inl√§mning per elev)", "fvBoxStudents");
    if (studentsBox) {
      const list = document.createElement("ul");
      list.id = "fvStudentList";
      list.className = "goals-list mini";

      const li = document.createElement("li");
      li.textContent = "Inga inl√§mningar inl√§sta √§nnu. Koppla sharedBank-id och klicka Uppdatera.";
      list.appendChild(li);

      const detail = document.createElement("div");
      detail.id = "fvStudentDetail";
      detail.className = "mini";
      detail.style.marginTop = "8px";
      detail.style.whiteSpace = "pre-line";
      detail.textContent = "V√§lj en elev f√∂r att se detaljer.";

      const actions = document.createElement("div");
      actions.id = "fvSelectedActions";
      actions.style.display = "flex";
      actions.style.gap = "8px";
      actions.style.flexWrap = "wrap";
      actions.style.marginTop = "8px";

      const btnDelSelected = document.createElement("button");
      btnDelSelected.id = "fvBtnDeleteSelected";
      btnDelSelected.type = "button";
      btnDelSelected.className = "btn btn-sm btn-danger";
      btnDelSelected.textContent = "Ta bort vald inl√§mning";

      actions.appendChild(btnDelSelected);

      studentsBox.appendChild(list);
      studentsBox.appendChild(detail);
      studentsBox.appendChild(actions);
    }

    const hsBox = fvBox("Highscore (sparat i molnet)", "fvBoxHighscore");
    if (hsBox) {
      const list = document.createElement("ul");
      list.id = "fvHighscoreList";
      list.className = "goals-list mini";
      const li = document.createElement("li");
      li.textContent = "Inga inl√§mningar inl√§sta √§nnu.";
      list.appendChild(li);
      hsBox.appendChild(list);
    }

    const strongBox = fvBox("Starka delbitar", "fvBoxStrong");
    if (strongBox) {
      const list = document.createElement("ul");
      list.id = "fvStrongList";
      list.className = "goals-list mini";
      const li = document.createElement("li");
      li.textContent = "V√§lj en elev f√∂r att se starka delbitar.";
      list.appendChild(li);
      strongBox.appendChild(list);
    }

    const weakBox = fvBox("Delbitar att √∂va p√•", "fvBoxWeak");
    if (weakBox) {
      const list = document.createElement("ul");
      list.id = "fvWeakList";
      list.className = "goals-list mini";
      const li = document.createElement("li");
      li.textContent = "V√§lj en elev f√∂r att se delbitar att √∂va p√•.";
      list.appendChild(li);
      weakBox.appendChild(list);
    }

    const expBox = fvBox("Export till elevkort (JSON)", "fvBoxExport");
    if (expBox) {
      const btn = document.createElement("button");
      btn.id = "fvBtnExport";
      btn.type = "button";
      btn.className = "btn btn-sm btn-primary";
      btn.textContent = "Skapa JSON f√∂r vald elev";

      const out = document.createElement("textarea");
      out.id = "fvExportOutput";
      out.className = "input";
      out.rows = 10;
      out.placeholder = "JSON hamnar h√§r...";
      out.style.marginTop = "8px";
      out.style.width = "100%";
      out.spellcheck = false;

      expBox.appendChild(btn);
      expBox.appendChild(out);
    }

    fvRemoveDuplicateLinkBoxesByTitle();
    fvSetLinkedSharedBankId(fvGetLinkedSharedBankId());
  }

  let fvAllEntries = [];
  let fvLatestByStudent = [];
  let fvHighscore = [];
  let fvSelected = null;
  let fvSelectedDocId = null;

  function fvComputeLatest(entries) {
    const map = new Map();
    entries.forEach((e) => {
      const k = fvKey(e);
      const prev = map.get(k);
      if (!prev) { map.set(k, e); return; }
      const a = prev.createdAt instanceof Date ? prev.createdAt : null;
      const b = e.createdAt instanceof Date ? e.createdAt : null;
      if (!a && b) map.set(k, e);
      else if (a && b && b > a) map.set(k, e);
    });
    return Array.from(map.values()).sort((a, b) => {
      const an = (a.studentClass || "") + " " + (a.studentName || "");
      const bn = (b.studentClass || "") + " " + (b.studentName || "");
      return an.localeCompare(bn, "sv-SE");
    });
  }

  function fvComputeHighscore(entries) {
    const best = new Map();
    entries.forEach((e) => {
      const k = fvKey(e);
      const prev = best.get(k);
      const score = typeof e.score === "number" ? e.score : -1;
      if (!prev) { best.set(k, e); return; }
      const prevScore = typeof prev.score === "number" ? prev.score : -1;
      if (score > prevScore) { best.set(k, e); return; }
      if (score === prevScore) {
        const a = prev.createdAt instanceof Date ? prev.createdAt : null;
        const b = e.createdAt instanceof Date ? e.createdAt : null;
        if (!a && b) best.set(k, e);
        else if (a && b && b > a) best.set(k, e);
      }
    });
    return Array.from(best.values()).sort((a, b) => (b.score || 0) - (a.score || 0)).slice(0, 50);
  }

  function fvSetStatus(msg) {
    const st = document.getElementById("fvLinkStatus");
    if (st) st.textContent = msg;
  }

  async function fvFetchEntries(bankId) {
    const db = fvGetDb();
    if (!db) throw new Error("No DB");
    const snap = await db
      .collection("sharedBanks")
      .doc(bankId)
      .collection(RESULTS_COLLECTION_NAME)
      .orderBy("createdAt", "desc")
      .limit(2000)
      .get();

    const entries = [];
    snap.forEach((doc) => entries.push(fvNormalizeEntry(doc.id, doc.data() || {})));
    return entries;
  }

  async function fvDeleteDoc(bankId, docId) {
    const db = fvGetDb();
    if (!db) throw new Error("No DB");
    await db
      .collection("sharedBanks")
      .doc(bankId)
      .collection(RESULTS_COLLECTION_NAME)
      .doc(docId)
      .delete();
  }

  async function fvDeleteAllForStudent(bankId, studentName, studentClass) {
    const db = fvGetDb();
    if (!db) throw new Error("No DB");

    const nameKey = (studentName || "").trim().toLowerCase();
    const classKey = (studentClass || "").trim().toLowerCase();

    const entries = await fvFetchEntries(bankId);
    const toDelete = entries
      .filter((e) => (e.studentName || "").trim().toLowerCase() === nameKey && (e.studentClass || "").trim().toLowerCase() === classKey)
      .map((e) => e.id)
      .filter(Boolean);

    for (const id of toDelete) {
      await fvDeleteDoc(bankId, id);
    }
  }

  function fvRenderStrongWeak(entry) {
    const strongList = document.getElementById("fvStrongList");
    const weakList = document.getElementById("fvWeakList");
    if (!strongList || !weakList) return;

    strongList.innerHTML = "";
    weakList.innerHTML = "";

    if (!entry) {
      const li1 = document.createElement("li");
      li1.textContent = "V√§lj en elev f√∂r att se starka delbitar.";
      strongList.appendChild(li1);

      const li2 = document.createElement("li");
      li2.textContent = "V√§lj en elev f√∂r att se delbitar att √∂va p√•.";
      weakList.appendChild(li2);
      return;
    }

    const strong = Array.isArray(entry.strongGoals) ? entry.strongGoals : [];
    const weak = Array.isArray(entry.weakGoals) ? entry.weakGoals : [];

    if (!strong.length) {
      const li = document.createElement("li");
      li.textContent = "Inga starka delbitar sparade i detta resultat (kan vara √§ldre inl√§mning utan delbitar).";
      strongList.appendChild(li);
    } else {
      strong.slice(0, 60).forEach((g) => {
        const li = document.createElement("li");
        li.textContent = `${g.goal || "(ok√§nt delm√•l)"}${g.parts ? " ‚Äì " + g.parts : ""} (${typeof g.percent === "number" ? g.percent : "?"}% r√§tt)`;
        strongList.appendChild(li);
      });
    }

    if (!weak.length) {
      const li = document.createElement("li");
      li.textContent = "Inga svaga delbitar sparade i detta resultat.";
      weakList.appendChild(li);
    } else {
      weak.slice(0, 60).forEach((g) => {
        const li = document.createElement("li");
        li.textContent = `${g.goal || "(ok√§nt delm√•l)"}${g.parts ? " ‚Äì " + g.parts : ""} (${typeof g.percent === "number" ? g.percent : "?"}% r√§tt)`;
        weakList.appendChild(li);
      });
    }
  }

  function fvRenderSelected() {
    const detail = document.getElementById("fvStudentDetail");
    if (!detail) return;

    if (!fvSelected) {
      detail.textContent = "V√§lj en elev f√∂r att se detaljer.";
      fvSelectedDocId = null;
      fvRenderStrongWeak(null);
      return;
    }

    const e = fvSelected;
    fvSelectedDocId = e.id || null;

    const lines = [];
    lines.push(`Elev: ${e.studentName || "-"} (${e.studentClass || "-"})`);
    lines.push(`Senaste resultat: ${typeof e.score === "number" ? Math.round(e.score) : "?"}% p√• niv√• ${e.level || "?"}`);
    if (e.correct != null && e.total != null) lines.push(`R√§tt: ${e.correct} av ${e.total}`);
    if (e.totalPoints != null) lines.push(`Total po√§ng: ${e.totalPoints}`);
    if (e.goalPassThreshold !=null) lines.push(`Gr√§ns godk√§nd delbit: ${e.goalPassThreshold}% r√§tt`);
    if (e.createdAt instanceof Date) lines.push(`Inl√§mnad: ${fvFmtDate(e.createdAt)}`);
    if (fvSelectedDocId) lines.push(`Resultat-id: ${fvSelectedDocId}`);

    detail.textContent = lines.join("\n");
    fvRenderStrongWeak(e);
  }

  // ====== H√ÑR: elevlistan med delete-knapp BREDVID varje elev ======
  function fvRenderStudents() {
    const list = document.getElementById("fvStudentList");
    const detail = document.getElementById("fvStudentDetail");
    if (!list || !detail) return;

    list.innerHTML = "";

    if (!fvLatestByStudent.length) {
      const li = document.createElement("li");
      li.textContent = "Inga inl√§mningar sparade √§nnu (f√∂r denna sharedBank).";
      list.appendChild(li);
      detail.textContent = "V√§lj en elev f√∂r att se detaljer.";
      return;
    }

    fvLatestByStudent.forEach((e) => {
      const li = document.createElement("li");
      li.className = "mini";
      li.style.marginBottom = "8px";

      // ROW med h√•rda inline-stilar s√• delete alltid hamnar bredvid
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.alignItems = "stretch";
      row.style.width = "100%";

      // V√ÑLJ elev (knapp)
      const pick = document.createElement("button");
      pick.type = "button";
      pick.className = "btn btn-sm btn-primary";
      pick.style.flex = "1 1 auto";
      pick.style.width = "auto";
      pick.style.textAlign = "left";
      pick.style.whiteSpace = "normal";

      pick.textContent =
        `${e.studentName || "-"} (${e.studentClass || "-"}) ‚Äì ` +
        `${typeof e.score === "number" ? Math.round(e.score) : "?"}% p√• niv√• ${e.level || "?"}` +
        `${e.createdAt instanceof Date ? " ‚Äì " + fvFmtDate(e.createdAt) : ""}`;

      pick.addEventListener("click", () => {
        fvSelected = e;
        fvRenderSelected();
      });

      // DELETE elev (knapp bredvid)
      const del = document.createElement("button");
      del.type = "button";
      del.className = "fv-del";
      del.textContent = "üóëÔ∏è";
      del.title = "Ta bort ALLA inl√§mningar f√∂r denna elev (namn + klass)";
      del.setAttribute("aria-label", "Ta bort elevens inl√§mningar");
      del.style.flex = "0 0 auto";
      del.style.width = "44px";

      del.addEventListener("click", async () => {
        try {
          const bankId = fvGetLinkedSharedBankId();
          if (!bankId) { alert("Ingen sharedBank kopplad."); return; }

          const name = e.studentName || "-";
          const cls = e.studentClass || "-";
          const msg = `Ta bort ALLA inl√§mningar f√∂r:\n${name} (${cls})\n\nDetta kan inte √•ngras.`;
          if (!confirm(msg)) return;

          await fvDeleteAllForStudent(bankId, e.studentName, e.studentClass);
          await fvRefreshFromFirestore();
        } catch (err) {
          console.error("[3X] Delete elev fel:", err);
          alert("Kunde inte ta bort elevens inl√§mningar. Se konsolen.");
        }
      });

      row.appendChild(pick);
      row.appendChild(del);
      li.appendChild(row);
      list.appendChild(li);
    });

    detail.textContent = "V√§lj en elev f√∂r att se detaljer. üóëÔ∏è tar bort ALLA elevens inl√§mningar i denna bank.";
  }

  function fvRenderHighscore() {
    const list = document.getElementById("fvHighscoreList");
    if (!list) return;

    list.innerHTML = "";
    if (!fvHighscore.length) {
      const li = document.createElement("li");
      li.textContent = "Inga inl√§mningar sparade √§nnu.";
      list.appendChild(li);
      return;
    }

    fvHighscore.slice(0, 20).forEach((e, i) => {
      const li = document.createElement("li");
      li.textContent =
        `${i + 1}. ${e.studentName || "-"} (${e.studentClass || "-"}) ‚Äì ` +
        `${typeof e.score === "number" ? Math.round(e.score) : "?"}% p√• niv√• ${e.level || "?"}` +
        `${e.createdAt instanceof Date ? " ‚Äì " + fvFmtDate(e.createdAt) : ""}`;
      list.appendChild(li);
    });
  }

  async function fvRefreshFromFirestore() {
    const db = fvGetDb();
    if (!db) {
      fvSetStatus("Firebase √§r inte redo √§nnu (ingen db-instans). √ñppna l√§rarl√§get och f√∂rs√∂k igen.");
      return;
    }

    const bankId = (document.getElementById("fvLinkedSharedBankId")?.value || "").trim() || fvGetLinkedSharedBankId();
    if (!bankId) {
      fvSetStatus("Hittar ingen sharedBank-id. Klistra in ID och klicka Koppla.");
      return;
    }

    fvSetLinkedSharedBankId(bankId);
    fvSetStatus("Laddar elevresultat fr√•n sharedBank-id: " + bankId + " ...");

    try {
      const entries = await fvFetchEntries(bankId);

      fvAllEntries = entries;
      fvLatestByStudent = fvComputeLatest(entries);
      fvHighscore = fvComputeHighscore(entries);

      fvSelected = null;
      fvSelectedDocId = null;

      fvRenderStudents();
      fvRenderHighscore();
      fvRenderSelected();

      fvSetStatus("Klart. Inl√§sta inl√§mningar: " + entries.length);
    } catch (err) {
      console.error("[3X] Fel vid laddning av elevresultat:", err);
      fvSetStatus("Fel vid laddning av elevresultat. Se konsolen.");
    }
  }

  function fvBuildExportJson(entry) {
    const bankId = fvGetLinkedSharedBankId() || "";
    return {
      source: "F√•ngvaktaren",
      sharedBankId: bankId,
      exportedAt: new Date().toISOString(),
      student: { name: entry.studentName || "", klass: entry.studentClass || "" },
      latest: {
        level: entry.level || null,
        percent: typeof entry.score === "number" ? entry.score : null,
        correct: entry.correct,
        total: entry.total,
        submittedAt: entry.createdAt instanceof Date ? entry.createdAt.toISOString() : null
      },
      points: {
        totalPoints: entry.totalPoints != null ? entry.totalPoints : null,
        best: { E: entry.bestE != null ? entry.bestE : null, C: entry.bestC != null ? entry.bestC : null, A: entry.bestA != null ? entry.bestA : null }
      },
      goals: {
        passThreshold: entry.goalPassThreshold != null ? entry.goalPassThreshold : null,
        strong: entry.strongGoals || [],
        weak: entry.weakGoals || []
      }
    };
  }

  function fvBindUI() {
    const inp = document.getElementById("fvLinkedSharedBankId");
    const btnLink = document.getElementById("fvBtnLinkBank");
    const btnClear = document.getElementById("fvBtnClearBank");
    const btnRefresh = document.getElementById("fvBtnRefresh");
    const btnExport = document.getElementById("fvBtnExport");
    const out = document.getElementById("fvExportOutput");
    const btnDeleteSelected = document.getElementById("fvBtnDeleteSelected");

    if (btnLink && !btnLink.__fvBound) {
      btnLink.__fvBound = true;
      btnLink.addEventListener("click", function () {
        const id = (inp && inp.value ? inp.value.trim() : "") || "";
        fvSetLinkedSharedBankId(id);
        fvRefreshFromFirestore();
      });
    }

    if (btnClear && !btnClear.__fvBound) {
      btnClear.__fvBound = true;
      btnClear.addEventListener("click", function () {
        if (inp) inp.value = "";
        fvSetLinkedSharedBankId("");
        fvAllEntries = [];
        fvLatestByStudent = [];
        fvHighscore = [];
        fvSelected = null;
        fvSelectedDocId = null;
        fvRenderStudents();
        fvRenderHighscore();
        fvRenderSelected();
        if (out) out.value = "";
      });
    }

    if (btnRefresh && !btnRefresh.__fvBound) {
      btnRefresh.__fvBound = true;
      btnRefresh.addEventListener("click", function () {
        fvRefreshFromFirestore();
      });
    }

    if (btnExport && !btnExport.__fvBound) {
      btnExport.__fvBound = true;
      btnExport.addEventListener("click", function () {
        if (!out) return;
        if (!fvSelected) {
          out.value = "";
          alert("V√§lj en elev f√∂rst.");
          return;
        }
        out.value = JSON.stringify(fvBuildExportJson(fvSelected), null, 2);
        try { out.focus(); out.select(); } catch (_) {}
      });
    }

    if (btnDeleteSelected && !btnDeleteSelected.__fvBound) {
      btnDeleteSelected.__fvBound = true;
      btnDeleteSelected.addEventListener("click", async function () {
        try {
          const bankId = fvGetLinkedSharedBankId();
          if (!bankId) { alert("Ingen sharedBank kopplad."); return; }
          if (!fvSelectedDocId) { alert("V√§lj en elev f√∂rst."); return; }

          const name = fvSelected?.studentName || "-";
          const cls = fvSelected?.studentClass || "-";
          const msg = `Ta bort vald inl√§mning (senaste) f√∂r:\n${name} (${cls})\n\nResultat-id: ${fvSelectedDocId}\n\nDetta kan inte √•ngras.`;
          if (!confirm(msg)) return;

          await fvDeleteDoc(bankId, fvSelectedDocId);
          await fvRefreshFromFirestore();
        } catch (err) {
          console.error("[3X] Delete selected fel:", err);
          alert("Kunde inte ta bort inl√§mningen. Se konsolen.");
        }
      });
    }
  }

  window.refreshElevProgressionFromFirestore = function (optionalBankId) {
    if (optionalBankId) fvSetLinkedSharedBankId(optionalBankId);
    fvRefreshFromFirestore();
  };
  window.refreshHighscoreFromFirestore = function (optionalBankId) {
    if (optionalBankId) fvSetLinkedSharedBankId(optionalBankId);
    fvRefreshFromFirestore();
  };

  function fvWaitForDbThenAutoRefresh(tries) {
    const t = typeof tries === "number" ? tries : 25;
    if (fvGetDb()) {
      const id = fvGetLinkedSharedBankId();
      if (id) fvRefreshFromFirestore();
      return;
    }
    if (t <= 0) return;
    setTimeout(() => fvWaitForDbThenAutoRefresh(t - 1), 250);
  }

  document.addEventListener("DOMContentLoaded", function () {
    fvBuildUI();
    fvBindUI();
    fvWaitForDbThenAutoRefresh(25);

    setTimeout(fvRemoveDuplicateLinkBoxesByTitle, 0);
    setTimeout(fvRemoveDuplicateLinkBoxesByTitle, 250);
    setTimeout(fvRemoveDuplicateLinkBoxesByTitle, 1000);
  });
})();
</script>
<!-- slut SEKTION 3X: ELEVPROGRESSION (NY DESIGN + DELETE-BREDVID VARJE ELEV) -->








<!-- start SEKTION 3Z: KOPPLA SHAREDBANK-ID & L√ÑS ELEVRESULTAT (FIX) -->
<script>
/* =========================
   3Z ‚Äì FIX:
   - Hittar sharedBank-id √§ven om URL-paramen f√∂rsvinner (sparar boot-URL direkt).
   - Fungerar √§ven om firebaseDbInstance √§r null (fallback: firebase.firestore()).
   - Accepterar ?sharedBank=, ?bank= eller ?sb= samt hel URL eller bara ID.
   ========================= */

(function () {
  // F√ÖNGA URL S√Ö TIDIGT SOM M√ñJLIGT (innan ev. history.replaceState)
  window.__fvBootHref = window.__fvBootHref || String(window.location.href || "");
  window.__fvBootSearch = window.__fvBootSearch || String(window.location.search || "");

  function fvGetDb() {
    try {
      if (typeof firebaseDbInstance !== "undefined" && firebaseDbInstance) return firebaseDbInstance;
    } catch (_) {}
    try {
      if (window.firebase && typeof firebase.firestore === "function") {
        return firebase.firestore();
      }
    } catch (_) {}
    return null;
  }

  function fvParseSharedIdFromText(txt) {
    const s = (txt || "").trim();
    if (!s) return null;

    // Hel URL
    try {
      const u = new URL(s);
      const p = u.searchParams;
      return p.get("sharedBank") || p.get("bank") || p.get("sb") || null;
    } catch (_) {}

    // Param-str√§ng
    const m = s.match(/(?:\?|&)?(?:sharedBank|bank|sb)=([^&\s]+)/i);
    if (m && m[1]) return decodeURIComponent(m[1]);

    // R√•tt ID
    if (/^[A-Za-z0-9_-]{10,}$/.test(s)) return s;

    return null;
  }

  function fvGetSharedIdFromUrlFast() {
    // 1) Boot URL/search
    const bootHref = String(window.__fvBootHref || "");
    const bootSearch = String(window.__fvBootSearch || "");

    const fromBoot = fvParseSharedIdFromText(bootHref) || fvParseSharedIdFromText(bootSearch);
    if (fromBoot) return fromBoot;

    // 2) Nuvarande URL (om den finns kvar)
    const nowHref = String(window.location.href || "");
    const nowSearch = String(window.location.search || "");
    return fvParseSharedIdFromText(nowHref) || fvParseSharedIdFromText(nowSearch);
  }

  function fvSetSharedIdLocally(sharedId) {
    if (!sharedId) return;
    window.activeSharedBankId = sharedId;
    try {
      const st = loadState();
      st.linkedSharedBankId = sharedId;
      saveState(st);
    } catch (e) {
      console.warn("[3Z] Kunde inte spara linkedSharedBankId i state:", e);
    }
  }

  async function fvResolveSharedBankId() {
    if (window.activeSharedBankId) return window.activeSharedBankId;

    const fromUrl = fvGetSharedIdFromUrlFast();
    if (fromUrl) {
      fvSetSharedIdLocally(fromUrl);
      return fromUrl;
    }

    try {
      const st = loadState();
      if (st && st.linkedSharedBankId) {
        window.activeSharedBankId = st.linkedSharedBankId;
        return st.linkedSharedBankId;
      }
    } catch (_) {}

    return null;
  }

  function fvEnsureLinkUI() {
    let grid =
      document.querySelector("#teacherModal .progress-grid") ||
      document.querySelector(".progress-grid");

    if (!grid) {
      const modalBody =
        document.querySelector("#teacherModal .modal-body") ||
        document.getElementById("teacherModal") ||
        document.body;

      grid = document.createElement("div");
      grid.className = "progress-grid";
      modalBody.appendChild(grid);
    }

    let box = document.getElementById("fvSharedLinkBox");
    if (box) return box;

    box = document.createElement("div");
    box.id = "fvSharedLinkBox";
    box.className = "progress-box";

    const title = document.createElement("h4");
    title.textContent = "Koppla elevresultat (sharedBank-id)";

    const help = document.createElement("div");
    help.className = "mini";
    help.textContent =
      "VIKTIGT: Elevresultat sparas p√• den publicerade elevl√§nken (sharedBanks-ID). Om du publicerar igen f√•r du en NY l√§nk och d√• ligger gamla resultat kvar p√• den gamla l√§nken.";

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "6px";
    row.style.flexWrap = "wrap";
    row.style.alignItems = "center";
    row.style.marginTop = "8px";

    const input = document.createElement("input");
    input.id = "fvSharedIdInput";
    input.className = "input";
    input.placeholder = "Klistra in elevl√§nk (‚Ä¶?bank=ID) eller bara ID...";
    input.style.flex = "1";
    input.autocomplete = "off";

    const btnSave = document.createElement("button");
    btnSave.id = "fvBtnSaveSharedId";
    btnSave.className = "btn btn-sm";
    btnSave.textContent = "Spara koppling";

    const btnRefresh = document.createElement("button");
    btnRefresh.id = "fvBtnRefreshResults";
    btnRefresh.className = "btn btn-sm";
    btnRefresh.textContent = "L√§s in elevresultat";

    const status = document.createElement("div");
    status.id = "fvSharedIdStatus";
    status.className = "mini";
    status.style.marginTop = "6px";
    status.textContent = "Ingen koppling sparad √§nnu.";

    row.appendChild(input);
    row.appendChild(btnSave);
    row.appendChild(btnRefresh);

    box.appendChild(title);
    box.appendChild(help);
    box.appendChild(row);
    box.appendChild(status);

    grid.prepend(box);

    // F√∂rifyll: f√∂rs√∂k l√§sa fr√•n URL/state direkt
    try {
      const id = fvGetSharedIdFromUrlFast();
      if (id) {
        input.value = id;
        status.textContent = "Hittad i URL: " + id;
        fvSetSharedIdLocally(id);
      } else {
        const st = loadState();
        if (st && st.linkedSharedBankId) {
          input.value = st.linkedSharedBankId;
          status.textContent = "Kopplad sharedBank-id: " + st.linkedSharedBankId;
          window.activeSharedBankId = st.linkedSharedBankId;
        }
      }
    } catch (_) {}

    btnSave.addEventListener("click", () => {
      const id = fvParseSharedIdFromText(input.value);
      if (!id) {
        status.textContent = "Hittar ingen sharedBank-id i texten du klistrade in.";
        return;
      }
      fvSetSharedIdLocally(id);
      status.textContent = "Kopplad sharedBank-id: " + id;
    });

    btnRefresh.addEventListener("click", () => {
      fvRefreshElevProgressionFromFirestore();
    });

    return box;
  }

  async function fvFetchResults(sharedId) {
    const db = fvGetDb();
    if (!db) {
      console.warn("[3Z] Ingen Firestore-instans (db).");
      return null;
    }
    const ref = db.collection("sharedBanks").doc(sharedId).collection("results");
    const snap = await ref.orderBy("createdAt", "desc").limit(500).get();

    const entries = [];
    snap.forEach((doc) => {
      const d = doc.data() || {};
      entries.push({
        ...d,
        id: doc.id,
        createdAt: d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null
      });
    });
    return entries;
  }

  async function fvRefreshElevProgressionFromFirestore() {
    fvEnsureLinkUI();
    const statusEl = document.getElementById("fvSharedIdStatus");

    const sharedId = await fvResolveSharedBankId();
    if (!sharedId) {
      console.warn("[3Z] Ingen sharedBankId hittades.");
      if (statusEl) {
        statusEl.textContent =
          "Hittar ingen sharedBank-id. Klistra in elevl√§nken (t.ex. ‚Ä¶?bank=ID) i rutan och klicka Spara koppling.";
      }
      return;
    }

    if (statusEl) statusEl.textContent = "L√§ser in elevresultat f√∂r: " + sharedId + " ...";

    const entries = await fvFetchResults(sharedId);
    if (entries == null) {
      if (statusEl) statusEl.textContent = "Tekniskt fel: kan inte n√• Firestore (db saknas).";
      return;
    }

    if (statusEl) {
      statusEl.textContent =
        entries.length
          ? "Elevresultat inl√§sta: " + entries.length + " st (sharedBank-id: " + sharedId + ")."
          : "Inga inl√§mningar hittades f√∂r denna l√§nk/ID: " + sharedId + ".";
    }

    // Uppdatera om UI-funktionerna finns (du har flera versioner i filen ‚Äì vi anropar bara om de finns)
    if (typeof updateElevProgressionUI === "function") {
      try { updateElevProgressionUI(entries); } catch (e) { console.warn("[3Z] updateElevProgressionUI fel:", e); }
    }
    if (typeof updateHighscoreUI === "function") {
      try {
        const hs = entries
          .slice()
          .map((d) => ({
            name: d.studentName || d.name || "",
            className: d.studentClass || d.class || d.className || "",
            level: d.levelId || d.level || "",
            score:
              typeof d.scorePercent === "number"
                ? d.scorePercent
                : typeof d.percent === "number"
                ? d.percent
                : 0,
            createdAt: d.createdAt instanceof Date ? d.createdAt : null
          }))
          .sort((a, b) => (b.score || 0) - (a.score || 0))
          .slice(0, 20);
        updateHighscoreUI(hs);
      } catch (e) {
        console.warn("[3Z] updateHighscoreUI fel:", e);
      }
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    fvEnsureLinkUI();

    // Auto: om du √∂ppnar med ?bank=ID ska den kunna l√§sa direkt
    setTimeout(() => {
      const id = fvGetSharedIdFromUrlFast();
      if (id) {
        fvSetSharedIdLocally(id);
        fvRefreshElevProgressionFromFirestore();
      }
    }, 400);
  });

  window.fvRefreshElevProgressionFromFirestore = fvRefreshElevProgressionFromFirestore;
})();
</script>
<!-- slut SEKTION 3Z: KOPPLA SHAREDBANK-ID & L√ÑS ELEVRESULTAT (FIX) -->




<!-- start SEKTION 3F: TALSYNTHES F√ñR FR√ÖGOR -->
<script>
(function () {
  function speakText(text) {
    if (!("speechSynthesis" in window)) {
      alert("Din webbl√§sare st√∂djer tyv√§rr inte talsyntes.");
      return;
    }
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "sv-SE";
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    window.speechSynthesis.speak(utterance);
  }

  function isControlButtonText(txt) {
    const lower = (txt || "").toLowerCase();
    return (
      lower.includes("n√§sta") ||
      lower.includes("avbryt") ||
      lower.includes("tillbaka") ||
      lower.includes("l√§mna in") ||
      lower.includes("starta om") ||
      lower.includes("√∂ppna l√§rarl√§ge") ||
      lower.includes("v√§lj niv√•") ||
      lower.includes("avsluta")
    );
  }

  function buildQuestionTextFromBox(box) {
    if (!box) return "";

    const optionSelector = "button, li, label, .answer-option, .mcq-option, .img-option, .drag-option, .play-option, .option";
    const optionEls = Array.from(box.querySelectorAll(optionSelector));
    const optionTexts = [];

    optionEls.forEach((el) => {
      if (el.classList && el.classList.contains("tts-speak-btn")) return;
      const txt = (el.innerText || "").trim();
      if (!txt) return;
      if (isControlButtonText(txt)) return;
      optionTexts.push(txt);
    });

    const textEls = Array.from(box.querySelectorAll("h1,h2,h3,h4,p,div,span")).filter((el) => {
      if (el.closest("button")) return false;
      if (el.classList && el.classList.contains("tts-speak-btn")) return false;
      return true;
    });

    const lines = [];
    textEls.forEach((el) => {
      const raw = (el.innerText || "");
      raw.split("\n").forEach((r) => {
        const line = r.trim();
        if (!line) return;
        if (optionTexts.includes(line)) return;
        if (isControlButtonText(line)) return;
        lines.push(line);
      });
    });

    if (!lines.length) return "";

    let headerIndex = -1;
    for (let i = 0; i < lines.length; i++) {
      if (/^fr√•ga\s*\d+/i.test(lines[i])) { headerIndex = i; break; }
    }

    let questionIndex = -1;
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].includes("?")) { questionIndex = i; break; }
    }
    if (questionIndex === -1) {
      for (let i = 0; i < lines.length; i++) {
        if (i === headerIndex) continue;
        questionIndex = i;
        break;
      }
    }

    const parts = [];
    if (questionIndex !== -1) {
      parts.push("Fr√•ga:");
      if (headerIndex !== -1 && headerIndex < questionIndex) parts.push(lines[headerIndex]);
      parts.push(lines[questionIndex]);
    }

    if (optionTexts.length) {
      parts.push("Svarsalternativ:");
      optionTexts.forEach((t, idx) => parts.push("Alternativ " + (idx + 1) + ": " + t));
    }

    return parts.join(". ");
  }

  function attachSpeakButtonsToAllQuestions() {
    const play = document.getElementById("play");
    if (!play) return;

    const headers = Array.from(play.querySelectorAll("h1,h2,h3,h4,div,span,p")).filter((n) => {
      const txt = (n.innerText || "").trim().toLowerCase();
      return /^fr√•ga\s*\d/.test(txt);
    });

    headers.forEach((node) => {
      let box =
        node.closest(".question-card, .play-question-card, .inner-question, .card, li") ||
        node.parentElement ||
        node;

      if (!box) return;
      if (box.dataset.ttsAttached === "1") return;
      box.dataset.ttsAttached = "1";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-sm tts-speak-btn";
      btn.textContent = "üîä L√§s upp fr√•gan";
      btn.style.marginTop = "6px";

      btn.addEventListener("click", function () {
        const text = buildQuestionTextFromBox(box);
        if (!text) return alert("Hittar ingen fr√•ga att l√§sa upp i denna ruta.");
        speakText(text);
      });

      box.appendChild(btn);
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const globalBtn = document.getElementById("btnSpeakQuestion");
    if (globalBtn && globalBtn.parentNode) globalBtn.parentNode.removeChild(globalBtn);

    attachSpeakButtonsToAllQuestions();

    if ("MutationObserver" in window) {
      const play = document.getElementById("play");
      if (play) {
        const obs = new MutationObserver(function () {
          attachSpeakButtonsToAllQuestions();
        });
        obs.observe(play, { childList: true, subtree: true });
      }
    }
  });
})();
</script>
<!-- slut SEKTION 3F: TALSYNTHES F√ñR FR√ÖGOR -->

<!-- slut SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker & editorer) -->




<!-- start SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->
<script>
"use strict";

/* =========================
   4a ‚Äì Elevdata & UI-sync
   ========================= */

function ensureStudentSet() {
  const s = loadState();
  if (!s.student.name || !s.student.klass) {
    alert("Skriv in namn och klass och spara eleven f√∂rst.");
    return false;
  }
  return true;
}

function handleSaveStudent() {
  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  const s = loadState();

  s.student.name = (nameInput && nameInput.value.trim()) || "";
  s.student.klass = (classInput && classInput.value.trim()) || "";
  saveState(s);
  syncUI();
}

// Tidigare visade denna "Po√§ng: 0 p." ‚Äì nu tar vi bort den helt
function updateProgressionNotice() {
  const notice = getEl("progressionNotice");
  if (notice) {
    notice.remove();
  }
}

// Highscore + delbitar + JSON i l√§rarfliken
function updateProgressionPanel() {
  const s = loadState();
  const prog = s.progression || {};
  const best = s.best || {};
  const thres = s.thres || {};

  // ---- Elevens po√§ngruta ----
  const totalPointsEl = getEl("progressTotalPoints");
  const bestEEl = getEl("progressBestE");
  const bestCEl = getEl("progressBestC");
  const bestAEl = getEl("progressBestA");
  const lastLevelEl = getEl("progressLastLevel");
  const lastSummaryEl = getEl("progressLastSummary");

  const lastResult = prog.lastResult || null;

  if (totalPointsEl) {
    totalPointsEl.textContent = `${prog.totalPoints || 0} p`;
  }
  if (bestEEl) bestEEl.textContent = (best.E || 0) + "%";
  if (bestCEl) bestCEl.textContent = (best.C || 0) + "%";
  if (bestAEl) bestAEl.textContent = (best.A || 0) + "%";

  if (lastLevelEl) {
    lastLevelEl.textContent = lastResult ? (lastResult.level || "-") : "-";
  }
  if (lastSummaryEl) {
    if (!lastResult) {
      lastSummaryEl.textContent = "Ingen spelad omg√•ng √§nnu.";
    } else {
      const txt = `${lastResult.score || 0}% (${lastResult.correct || 0}/${lastResult.total || 0} r√§tt) ‚Äì +${lastResult.pointsGained || 0}p`;
      lastSummaryEl.textContent = txt;
    }
  }

  // ---- Lokal highscore ----
  const summaryEl = getEl("localHighscoreSummary");
  const listEl = getEl("localHighscoreList");

  if (summaryEl && listEl) {
    listEl.innerHTML = "";
    const hs = Array.isArray(s.highscores) ? s.highscores.slice() : [];

    if (!hs.length) {
      summaryEl.textContent = "Ingen highscore sparad √§nnu.";
    } else {
      hs.sort((a, b) => (b.points || 0) - (a.points || 0));

      const studentId = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
      const totalPlayers = hs.length;
      const currentIndex = hs.findIndex((entry) => entry.id === studentId);
      const currentEntry = currentIndex >= 0 ? hs[currentIndex] : null;
      const rank = currentIndex >= 0 ? currentIndex + 1 : null;

      if (currentEntry && rank != null) {
        summaryEl.textContent =
          `üèÜ Highscore: plats ${rank} av ${totalPlayers} (${currentEntry.points || 0} po√§ng)`;
      } else {
        summaryEl.textContent =
          `üèÜ Highscorelista: ${totalPlayers} elever p√• denna enhet.`;
      }

      const top3 = hs.slice(0, 3);
      top3.forEach((entry) => {
        const li = document.createElement("li");
        const name = entry.name || "Elev";
        const klass = entry.klass || "-";
        const pts = entry.points || 0;
        li.textContent = `${name} (${klass}) ‚Äì ${pts} p`;
        listEl.appendChild(li);
      });
    }
  }

  // ---- Starka delbitar / delbitar att √∂va p√• ----
  const strongEl = getEl("strongPartsList");
  const weakEl = getEl("weakPartsList");

  if (strongEl && weakEl) {
    strongEl.innerHTML = "";
    weakEl.innerHTML = "";

    const wrongByGoal = prog.wrongByGoalId || {};
    const correctByGoal = prog.correctByGoalId || {};

    const allIds = new Set([
      ...Object.keys(wrongByGoal),
      ...Object.keys(correctByGoal)
    ]);

    if (!allIds.size) {
      const li1 = document.createElement("li");
      li1.textContent = "Inga delbitar kopplade √§nnu.";
      strongEl.appendChild(li1);

      const li2 = document.createElement("li");
      li2.textContent = "Spela niv√•er med delbit-koppling f√∂r att se statistik.";
      weakEl.appendChild(li2);
    } else {
      const baseThres =
        typeof thres.E === "number" ? thres.E :
        typeof thres.C === "number" ? thres.C :
        typeof thres.A === "number" ? thres.A : 70;

      const stats = [];

      allIds.forEach((id) => {
        const c = correctByGoal[id] || 0;
        const w = wrongByGoal[id] || 0;
        const total = c + w;
        if (!total) return;
        const acc = Math.round((c / total) * 100);
        stats.push({ id, correct: c, wrong: w, total, acc });
      });

      const strong = stats
        .filter((st) => st.acc >= baseThres && st.correct > 0)
        .sort((a, b) => b.acc - a.acc || b.correct - a.correct)
        .slice(0, 10);

      const weak = stats
        .filter((st) => st.acc < baseThres || st.wrong > 0)
        .sort((a, b) => b.wrong - a.wrong || a.acc - b.acc)
        .slice(0, 10);

      if (!strong.length) {
        const li = document.createElement("li");
        li.textContent = "Inga tydliga styrkor √§nnu ‚Äì forts√§tt spela.";
        strongEl.appendChild(li);
      } else {
        strong.forEach((st) => {
          const li = document.createElement("li");
          li.textContent =
            `Delbit ${st.id} ‚Äì ${st.acc}% r√§tt (${st.correct}/${st.total})`;
          strongEl.appendChild(li);
        });
      }

      if (!weak.length) {
        const li = document.createElement("li");
        li.textContent = "Inga tydliga svagheter ‚Äì bra jobbat!";
        weakEl.appendChild(li);
      } else {
        weak.forEach((st) => {
          const li = document.createElement("li");
          li.textContent =
            `Delbit ${st.id} ‚Äì ${st.wrong} fel (${st.correct}/${st.total} r√§tt, ${st.acc}%)`;
          weakEl.appendChild(li);
        });
      }
    }
  }
}

// Skapa JSON-snutt f√∂r elevkortet utifr√•n senaste resultat
function handleGenerateProgressJson() {
  const output = getEl("progressJsonOutput");
  const status = getEl("progressJsonStatus");
  const s = loadState();
  const prog = s.progression || {};

  if (!output) return;

  const last = prog.lastResult || null;
  if (!last) {
    output.value = "";
    if (status) status.textContent = "Ingen spelomg√•ng hittades. Spela en niv√• f√∂rst.";
    return;
  }

  const payload = {
    source: "fangvaktaren",
    version: "v17",
    student: {
      name: s.student.name || "",
      klass: s.student.klass || ""
    },
    result: {
      level: last.level,
      scorePercent: last.score,
      correct: last.correct,
      total: last.total,
      pointsGained: last.pointsGained,
      totalPointsAfter: last.totalPointsAfter,
      timestamp: last.timestamp
    },
    progression: {
      totalPoints: prog.totalPoints || 0,
      best: s.best || {},
      wrongByGoalId: prog.wrongByGoalId || {},
      correctByGoalId: prog.correctByGoalId || {}
    }
  };

  output.value = JSON.stringify(payload, null, 2);
  if (status) status.textContent = "JSON skapad ‚Äì kopiera och klistra in i elevkortet.";
}

function handleCopyProgressJson() {
  const output = getEl("progressJsonOutput");
  const status = getEl("progressJsonStatus");
  if (!output) return;

  const text = output.value || "";
  if (!text.trim()) {
    if (status) status.textContent = "Ingen JSON att kopiera.";
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(
      () => {
        if (status) status.textContent = "Kopierat till urklipp.";
      },
      () => {
        if (status) status.textContent = "Kunde inte kopiera automatiskt ‚Äì markera och kopiera manuellt.";
      }
    );
  } else {
    if (status) status.textContent = "Kunde inte kopiera automatiskt ‚Äì markera och kopiera manuellt.";
  }
}

// Hj√§lpare: uppdatera allt progression-relaterat UI
function updateAllProgressionUI() {
  updateProgressionNotice();
  updateProgressionPanel();
}

// Rensa all elevdata (p√• den h√§r enheten)
function handleClearStudentData() {
  const s = loadState();
  if (!confirm("Detta rensar alla sparade elevuppgifter, highscore och progression p√• DENNA dator. Forts√§tt?")) {
    return;
  }

  s.student = { name: "", klass: "" };
  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];
  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Elevdata rensad p√• denna enhet.";
}

// Nollst√§ll spelpo√§ng & progression men beh√•ll elevnamn / klass
function handleResetGameData() {
  const s = loadState();
  if (!confirm("Detta nollst√§ller po√§ng, progression och highscore men beh√•ller nuvarande elevnamn/klass. Forts√§tt?")) {
    return;
  }

  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];
  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Spelpo√§ng och progression nollst√§lld.";
}

function syncUI() {
  const s = loadState();
  const hasStudent = !!(s.student.name && s.student.klass);

  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  if (nameInput) nameInput.value = s.student.name || "";
  if (classInput) classInput.value = s.student.klass || "";

  const studentSaved = getEl("studentSaved");
  if (studentSaved) {
    if (hasStudent) {
      studentSaved.textContent = `Sparad: ${s.student.name} (${s.student.klass})`;
    } else {
      studentSaved.textContent = "Ej sparad elev";
    }
  }

  const bestE = getEl("best-levelE");
  const bestC = getEl("best-levelC");
  const bestA = getEl("best-levelA");
  if (bestE) bestE.textContent = (s.best && s.best.E) || 0;
  if (bestC) bestC.textContent = (s.best && s.best.C) || 0;
  if (bestA) bestA.textContent = (s.best && s.best.A) || 0;

  const thresE = getEl("thres-levelE");
  const thresC = getEl("thres-levelC");
  const thresA = getEl("thres-levelA");
  if (thresE && s.thres && typeof s.thres.E === "number") thresE.textContent = s.thres.E;
  if (thresC && s.thres && typeof s.thres.C === "number") thresC.textContent = s.thres.C;
  if (thresA && s.thres && typeof s.thres.A === "number") thresA.textContent = s.thres.A;

  const cardE = getEl("card-levelE");
  const cardC = getEl("card-levelC");
  const cardA = getEl("card-levelA");
  const btnE = getEl("start-levelE");
  const btnC = getEl("start-levelC");
  const btnA = getEl("start-levelA");
  const badgeE = getEl("badge-levelE");
  const badgeC = getEl("badge-levelC");
  const badgeA = getEl("badge-levelA");

  // Niv√• 1 (E)
  if (cardE && btnE && badgeE) {
    if (hasStudent) {
      cardE.classList.remove("locked");
      btnE.disabled = false;
      badgeE.textContent = "Starta";
      badgeE.classList.remove("badge-lock");
      badgeE.classList.add("badge-ok");
    } else {
      cardE.classList.add("locked");
      btnE.disabled = true;
      badgeE.textContent = "L√•st";
      badgeE.classList.remove("badge-ok");
      badgeE.classList.add("badge-lock");
    }
  }

  // Niv√• 2 (C)
  if (cardC && btnC && badgeC) {
    if (s.unlocked && s.unlocked.C) {
      cardC.classList.remove("locked");
      btnC.disabled = false;
      badgeC.textContent = "Uppl√•st";
      badgeC.classList.remove("badge-lock");
      badgeC.classList.add("badge-ok");
    } else {
      cardC.classList.add("locked");
      btnC.disabled = true;
      badgeC.textContent = "L√•st";
      badgeC.classList.remove("badge-ok");
      badgeC.classList.add("badge-lock");
    }
  }

  // Niv√• 3 (A)
  if (cardA && btnA && badgeA) {
    if (s.unlocked && s.unlocked.A) {
      cardA.classList.remove("locked");
      btnA.disabled = false;
      badgeA.textContent = "Uppl√•st";
      badgeA.classList.remove("badge-lock");
      badgeA.classList.add("badge-ok");
    } else {
      cardA.classList.add("locked");
      btnA.disabled = true;
      badgeA.textContent = "L√•st";
      badgeA.classList.remove("badge-ok");
      badgeA.classList.add("badge-lock");
    }
  }

  const who = getEl("whoPlays");
  if (who) {
    who.textContent = hasStudent
      ? `${s.student.name} (${s.student.klass})`
      : "Ingen elev vald.";
  }

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const studentCard = getEl("studentCard");

  const isPlaying = typeof currentLevel !== "undefined" && !!currentLevel;
  const isResultVisible = resultSection && !resultSection.classList.contains("hidden");

  if (studentCard) {
    studentCard.classList.toggle("hidden", isPlaying || isResultVisible);
  }

  updateAllProgressionUI();
}

/* =========================
   4b ‚Äì Spel-logik (fr√•gerendering & niv√•er)
   ========================= */

function renderDragQuestion(q, index, host) {
  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"}) ‚Äì Drag & Drop`;
  container.appendChild(header);

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.flexWrap = "wrap";
  wrapper.style.gap = "12px";
  wrapper.style.marginTop = "6px";

  const sourcesCol = document.createElement("div");
  sourcesCol.style.flex = "1 1 180px";

  const targetsCol = document.createElement("div");
  targetsCol.style.flex = "2 1 260px";

  const srcTitle = document.createElement("div");
  srcTitle.className = "mini";
  srcTitle.textContent = "Kort att dra:";
  sourcesCol.appendChild(srcTitle);

  const srcZone = document.createElement("div");
  srcZone.style.border = "1px dashed #1f2937";
  srcZone.style.borderRadius = "8px";
  srcZone.style.padding = "6px";
  srcZone.style.minHeight = "40px";
  srcZone.style.display = "flex";
  srcZone.style.flexWrap = "wrap";
  srcZone.style.gap = "4px";
  sourcesCol.appendChild(srcZone);

  const tgtTitle = document.createElement("div");
  tgtTitle.className = "mini";
  tgtTitle.textContent = "Kategori-rutor:";
  targetsCol.appendChild(tgtTitle);

  const tgtZone = document.createElement("div");
  tgtZone.style.display = "flex";
  tgtZone.style.flexWrap = "wrap";
  tgtZone.style.gap = "8px";
  targetsCol.appendChild(tgtZone);

  wrapper.appendChild(sourcesCol);
  wrapper.appendChild(targetsCol);
  container.appendChild(wrapper);

  const sources = Array.isArray(q.dragSources) ? q.dragSources : [];
  const targets = Array.isArray(q.dragTargets) ? q.dragTargets : [];
  const answers = {};
  currentAnswers[index] = answers;

  function makeDraggableChip(src) {
    const chip = document.createElement("div");
    chip.textContent = src.label;
    chip.draggable = true;
    chip.dataset.itemId = src.id;
    chip.className = "chip";
    chip.style.cursor = "grab";
    chip.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", src.id);
    });
    return chip;
  }

  function setupDropTarget(el, targetId) {
    el.addEventListener("dragover", (ev) => {
      ev.preventDefault();
    });
    el.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      el.appendChild(existing);

      if (targetId === null) {
        delete answers[itemId];
      } else {
        answers[itemId] = targetId;
      }
    });
  }

  setupDropTarget(srcZone, null);

  sources.forEach((src) => {
    const chip = makeDraggableChip(src);
    srcZone.appendChild(chip);
  });

  targets.forEach((tgt) => {
    const box = document.createElement("div");
    box.style.border = "1px solid #1f2937";
    box.style.borderRadius = "8px";
    box.style.padding = "6px";
    box.style.minHeight = "46px";
    box.style.minWidth = "110px";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "4px";

    const cap = document.createElement("div");
    cap.className = "mini";
    cap.textContent = tgt.label;
    box.appendChild(cap);

    const slot = document.createElement("div");
    slot.style.display = "flex";
    slot.style.flexWrap = "wrap";
    slot.style.gap = "4px";
    box.appendChild(slot);

    box.addEventListener("dragover", (ev) => {
      ev.preventDefault();
    });
    box.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;
      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;
      slot.appendChild(existing);
      answers[itemId] = tgt.id;
    });

    tgtZone.appendChild(box);
  });

  host.appendChild(container);
}

function renderQuestionItem(q, index, host) {
  if (q.type === "drag") {
    renderDragQuestion(q, index, host);
    return;
  }

  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"})`;
  container.appendChild(header);

  if (q.type === "img" && q.imgDataUrl) {
    const img = document.createElement("img");
    img.src = q.imgDataUrl;
    img.alt = "Bildfr√•ga";
    container.appendChild(img);
  }

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const optionsList = document.createElement("div");
  optionsList.className = "options-list";
  (q.options || []).forEach((opt, optIndex) => {
    const label = document.createElement("label");
    label.className = "option-label";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = `q-${index}`;
    input.value = String(optIndex);
    input.addEventListener("change", () => {
      currentAnswers[index] = optIndex;
    });

    const span = document.createElement("span");
    span.textContent = opt;

    label.appendChild(input);
    label.appendChild(span);
    optionsList.appendChild(label);
  });
  container.appendChild(optionsList);

  host.appendChild(container);
}

function startLevel(level) {
  if (!ensureStudentSet()) return;

  const s = loadState();
  const allQuestions = []
    .concat(s.bank.mcq || [])
    .concat(s.bank.img || [])
    .concat(s.bank.drag || []);

  const pool = allQuestions.filter((q) => (q.level || "E") === level);
  if (!pool.length) {
    alert("Det finns inga fr√•gor p√• denna niv√• √§nnu.");
    return;
  }

  currentLevel = level;
  currentQuestions = shuffle(pool);
  currentAnswers = new Array(currentQuestions.length).fill(null);

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const questionsHost = getEl("questions");

  if (resultSection) resultSection.classList.add("hidden");
  if (playSection) playSection.classList.remove("hidden");
  if (questionsHost) {
    questionsHost.innerHTML = "";
    currentQuestions.forEach((q, idx) => renderQuestionItem(q, idx, questionsHost));
  }

  const title = getEl("play-title");
  const who = getEl("whoPlays");
  if (title) {
    if (level === "E") title.textContent = "Niv√• 1 ‚Äì Grundniv√• (E)";
    else if (level === "C") title.textContent = "Niv√• 2 ‚Äì Mellanniv√• (C)";
    else title.textContent = "Niv√• 3 ‚Äì Avancerad (A)";
  }
  if (who) {
    who.textContent = `${s.student.name} (${s.student.klass})`;
  }

  syncUI();
}

function finishLevel() {
  if (!currentLevel || !currentQuestions.length) {
    alert("Ingen niv√• √§r aktiv.");
    return;
  }

  const s = loadState();
  const goals = s.goalsMap || [];
  let correctCount = 0;
  let pointsGained = 0;
  let allCorrect = true;

  if (!s.progression || typeof s.progression !== "object") {
    s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  }
  s.progression.totalPoints = s.progression.totalPoints || 0;
  s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
  s.progression.correctByGoalId = s.progression.correctByGoalId || {};

  const wrongByGoal = s.progression.wrongByGoalId;
  const correctByGoal = s.progression.correctByGoalId;

  const lvl = currentLevel;
  const basePointsPerQuestion =
    lvl === "A" ? 3 :
    lvl === "C" ? 2 : 1;

  currentQuestions.forEach((q, index) => {
    const ansVal = currentAnswers[index];
    let isCorrect = false;

    if (q.type === "drag") {
      const correctMap = q.correctMap || {};
      const keys = Object.keys(correctMap);
      if (!keys.length) {
        isCorrect = false;
      } else if (!ansVal || typeof ansVal !== "object") {
        isCorrect = false;
      } else {
        let allOk = true;
        for (const itemId of keys) {
          if (!ansVal[itemId] || ansVal[itemId] !== correctMap[itemId]) {
            allOk = false;
            break;
          }
        }
        isCorrect = allOk;
      }
    } else {
      if (ansVal != null) {
        const correctIndex = typeof q.answer === "number" ? q.answer : q.correct;
        isCorrect = ansVal === correctIndex;
      } else {
        isCorrect = false;
      }
    }

    if (isCorrect) {
      correctCount++;
      pointsGained += basePointsPerQuestion;
    } else {
      allCorrect = false;
    }

    const links = getLinksForQuestion(q, goals);
    if (links && links.length) {
      links.forEach((lnk) => {
        const key = String(lnk.id);
        if (isCorrect) {
          correctByGoal[key] = (correctByGoal[key] || 0) + 1;
        } else {
          wrongByGoal[key] = (wrongByGoal[key] || 0) + 1;
        }
      });
    }
  });

  const total = currentQuestions.length;
  const percentage = total ? Math.round((correctCount / total) * 100) : 0;
  const threshold = (s.thres && s.thres[lvl] != null) ? s.thres[lvl] : 70;

  if (!s.best) s.best = { E: 0, C: 0, A: 0 };
  if (percentage > (s.best[lvl] || 0)) {
    s.best[lvl] = percentage;
  }

  if (!s.unlocked) s.unlocked = { C: false, A: false };
  if (lvl === "E" && percentage >= threshold) s.unlocked.C = true;
  if (lvl === "C" && percentage >= threshold) s.unlocked.A = true;

  // Bonus +5p om alla r√§tt p√• niv√•n
  if (total > 0 && allCorrect) {
    pointsGained += 5;
  }

  s.progression.totalPoints += pointsGained;
  const totalPointsAfter = s.progression.totalPoints;

  const nowIso = new Date().toISOString();
  const lastResult = {
    level: lvl,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    timestamp: nowIso
  };
  s.progression.lastResult = lastResult;

  // Uppdatera lokal highscore f√∂r denna elev
  if (!Array.isArray(s.highscores)) s.highscores = [];
  const id = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
  const newEntry = {
    id,
    name: s.student.name || "Elev",
    klass: s.student.klass || "-",
    points: totalPointsAfter,
    level: lvl,
    score: percentage,
    updatedAt: nowIso
  };
  const idx = s.highscores.findIndex((e) => e.id === id);
  if (idx >= 0) {
    if ((newEntry.points || 0) >= (s.highscores[idx].points || 0)) {
      s.highscores[idx] = newEntry;
    }
  } else {
    s.highscores.push(newEntry);
  }

  saveState(s);

  // Global lastSubmission f√∂r e-postfunktionen
  lastSubmission = {
    level: lvl,
    studentName: s.student.name,
    studentClass: s.student.klass,
    timestamp: nowIso,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    answers: currentAnswers.slice(),
    questions: currentQuestions.map((q) => ({
      q: q.q || q.text || "",
      type: q.type || "mcq",
      level: q.level || lvl,
      answer: typeof q.answer === "number" ? q.answer : q.correct,
      goal: q.goal || null,
      parts: q.parts || null
    }))
  };

  const playSection = getEl("play");
  const resultSection = getEl("result");
  if (playSection) playSection.classList.add("hidden");
  if (resultSection) resultSection.classList.remove("hidden");

  const scoreText = getEl("scoreText");
  const scoreDetail = getEl("scoreDetail");
  const resName = getEl("resName");
  const resClass = getEl("resClass");
  const passBadge = getEl("passBadge");
  const unlockText = getEl("unlockText");

  if (scoreText) scoreText.innerHTML = `${percentage}%<span> resultat</span>`;
  if (scoreDetail) {
    scoreDetail.textContent =
      `${correctCount}/${total} r√§tt ‚Äì niv√•po√§ng: +${pointsGained}p, totalt: ${totalPointsAfter}p`;
  }
  if (resName) resName.textContent = s.student.name || "-";
  if (resClass) resClass.textContent = s.student.klass || "-";

  if (passBadge) {
    const passed = percentage >= threshold;
    if (passed) {
      passBadge.className = "badge-pass";
      passBadge.textContent = "Godk√§nd niv√•";
    } else {
      passBadge.className = "badge-fail";
      passBadge.textContent = "Inte godk√§nd √§nnu";
    }
  }

  if (unlockText) {
    let txt = "";
    if (lvl === "E" && s.unlocked.C) txt = "Niv√• 2 (C) √§r nu uppl√•st.";
    else if (lvl === "C" && s.unlocked.A) txt = "Niv√• 3 (A) √§r nu uppl√•st.";
    unlockText.textContent = txt;
  }

  currentLevel = null;
  currentQuestions = [];
  currentAnswers = [];

  updateAllProgressionUI();
  syncUI();
}
</script>
<!-- slut SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->






<!-- start SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post, l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->
<script>
"use strict";

/* Hj√§lpfunktion f√∂r att slippa getElementById √∂verallt */
function getEl(id) {
  return document.getElementById(id);
}

/* =========================
   5a ‚Äì E-postinl√§mning
   ========================= */

function emailResultToTeacher() {
  if (!lastSubmission) {
    alert("Det finns inget resultat att skicka. Spela en niv√• f√∂rst.");
    return;
  }
  const s = loadState();
  const inputEmail = getEl("inputTeacherEmail");
  const teacherEmail =
    s.teacherEmail ||
    (inputEmail && inputEmail.value.trim()) ||
    "";

  if (!teacherEmail) {
    alert("Ingen l√§rar-e-post √§r sparad. G√• till Inst√§llningar och fyll i 'L√§rarens e-post'.");
    return;
  }

  const jsonText = JSON.stringify(lastSubmission, null, 2);
  const subject = `F√•ngvaktaren ‚Äì resultat ${lastSubmission.studentName || "Elev"} (${lastSubmission.studentClass || ""})`;
  const body =
    `Hej!\n\n` +
    `H√§r kommer resultat fr√•n F√•ngvaktaren.\n\n` +
    `Elev: ${lastSubmission.studentName || "-"} (${lastSubmission.studentClass || "-"})\n` +
    `Niv√•: ${lastSubmission.level}\n` +
    `Resultat: ${lastSubmission.score}% (${lastSubmission.correct}/${lastSubmission.total} r√§tt)\n` +
    `Po√§ng denna niv√•: ${lastSubmission.pointsGained || 0}p\n` +
    `Totala progressionpo√§ng efter denna omg√•ng: ${lastSubmission.totalPointsAfter || 0}p\n` +
    `Datum: ${new Date(lastSubmission.timestamp).toLocaleString("sv-SE")}\n\n` +
    `JSON-data (f√∂r elevkort / dokumentation):\n` +
    `${jsonText}\n\n` +
    `V√§nliga h√§lsningar\n` +
    `${lastSubmission.studentName || "Elev"}`;

  const mailtoLink =
    `mailto:${encodeURIComponent(teacherEmail)}` +
    `?subject=${encodeURIComponent(subject)}` +
    `&body=${encodeURIComponent(body)}`;

  window.location.href = mailtoLink;
}

/* =========================
   5b ‚Äì L√§rarl√∂senord & status
   ========================= */

function showTeacherPasswordInStatus() {
  const s = loadState();
  const statusEl = getEl("passwordStatus");
  if (statusEl && s.teacherPassword) {
    statusEl.textContent = `Aktuellt l√§rarl√∂senord: ${s.teacherPassword}`;
  } else if (statusEl) {
    statusEl.textContent = "";
  }
}

/* =========================
   5c ‚Äì L√§rarl√§ge: gate + modal
   ========================= */

function openTeacherGate() {
  const gate = getEl("teacherGate");
  const input = getEl("teacherPasswordInput");
  const text = getEl("teacherGateText");
  const s = loadState();

  if (gate) gate.classList.remove("hidden");
  if (input) {
    input.value = "";
    input.type = "password";
    input.focus();
  }

  if (text) {
    if (s.teacherPassword) {
      text.textContent = "Ange l√§rarl√∂senord f√∂r att √∂ppna l√§rarl√§get.";
    } else {
      text.textContent = "F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.";
    }
  }
}

function closeTeacherGate() {
  const gate = getEl("teacherGate");
  if (gate) gate.classList.add("hidden");
}

function openTeacherModal() {
  const modal = getEl("teacherModal");
  if (modal) modal.classList.remove("hidden");
}

function closeTeacherModal() {
  const modal = getEl("teacherModal");
  if (modal) modal.classList.add("hidden");
}

function handleTeacherConfirm() {
  const input = getEl("teacherPasswordInput");
  const text = getEl("teacherGateText");
  if (!input) return;

  const entered = input.value.trim();
  if (!entered) {
    alert("Skriv in ett l√∂senord.");
    return;
  }

  const s = loadState();

  // F√∂rsta g√•ngen: s√§tt l√∂senordet
  if (!s.teacherPassword) {
    s.teacherPassword = entered;
    saveState(s);
    showTeacherPasswordInStatus();
    if (text) text.textContent = "L√∂senord sparat. √ñppnar l√§rarl√§ge.";
    closeTeacherGate();
    openTeacherModal();
    return;
  }

  // Efter√•t: kontrollera l√∂senordet
  if (s.teacherPassword === entered) {
    if (text) text.textContent = "L√∂senord OK. √ñppnar l√§rarl√§ge.";
    closeTeacherGate();
    openTeacherModal();
  } else {
    if (text) text.textContent = "Fel l√∂senord. F√∂rs√∂k igen.";
    input.value = "";
    input.focus();
  }
}

/* =========================
   5d ‚Äì Fliknavigering i l√§rarmodal
   ========================= */

function setupTabNavigation() {
  const tabButtons = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");

  if (!tabButtons.length || !panels.length) return;

  function activateTab(tabId) {
    tabButtons.forEach((btn) => {
      const isActive = btn.getAttribute("data-tab") === tabId;
      if (isActive) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    });

    panels.forEach((panel) => {
      const panelId = panel.getAttribute("data-panel");
      const shouldShow = panelId === tabId;
      panel.classList.toggle("hidden", !shouldShow);
    });
  }

  tabButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tabId = btn.getAttribute("data-tab");
      if (!tabId) return;
      activateTab(tabId);
    });
  });

  // S√§kerst√§ll att "settings" √§r aktiv som start (om den finns)
  const defaultTab = document.querySelector('.tab-btn[data-tab="settings"]');
  if (defaultTab) {
    activateTab("settings");
  }
}

/* =========================
   5e ‚Äì Bankstatus (UI)
   ========================= */

function updateBankStatusUI() {
  const listEl = getEl("cloudBankList");
  if (!listEl) return;

  // Hitta kortet runt "Ladda fr√•gebank fr√•n molnet"
  const hostCard = listEl.closest(".card");
  if (!hostCard) return;

  let statusEl = getEl("bankStatus");
  if (!statusEl) {
    statusEl = document.createElement("p");
    statusEl.id = "bankStatus";
    statusEl.className = "mini";
    statusEl.style.marginTop = "6px";
    // L√§gg status-raden precis ovanf√∂r listan med moln-bankar
    hostCard.insertBefore(statusEl, listEl);
  }

  const s = loadState();
  const bank = s.bank || {};
  const mcqCount = Array.isArray(bank.mcq) ? bank.mcq.length : 0;
  const imgCount = Array.isArray(bank.img) ? bank.img.length : 0;
  const dragCount = Array.isArray(bank.drag) ? bank.drag.length : 0;
  const total = mcqCount + imgCount + dragCount;

  if (!total) {
    statusEl.textContent = "Status: Ingen fr√•gebank laddad.";
  } else {
    statusEl.textContent =
      `Status: Aktiv bank med ${total} fr√•gor ` +
      `(MCQ: ${mcqCount}, bild: ${imgCount}, drag & drop: ${dragCount}).`;
  }
}

/* =========================
   5f ‚Äì Initiering & knappar
   ========================= */

function initApp() {
  console.log("initApp start");

  // 1. S√§kerst√§ll fr√•gebank (merga embedded-data om tom)
  let s = loadState();
  const hasBank =
    s.bank &&
    (
      (Array.isArray(s.bank.mcq) && s.bank.mcq.length) ||
      (Array.isArray(s.bank.img) && s.bank.img.length) ||
      (Array.isArray(s.bank.drag) && s.bank.drag.length)
    );

  if (!hasBank && typeof mergeEmbeddedBank === "function") {
    console.log("Ingen lokal bank ‚Äì mergar embedded-data");
    s = mergeEmbeddedBank(s);
    saveState(s);
  }

  // 2. Initiera inst√§llningsdelar om de finns
  if (typeof initTeacherEmailSettings === "function") initTeacherEmailSettings();
  if (typeof initThresholdSettings === "function") initThresholdSettings();
  if (typeof initTeacherPasswordSettings === "function") initTeacherPasswordSettings();
  showTeacherPasswordInStatus();

  if (typeof initGoalsMap === "function") initGoalsMap();
  if (typeof initQuestionForms === "function") initQuestionForms();
  if (typeof initImageQuestionsEditor === "function") initImageQuestionsEditor();
  if (typeof initDragDropQuestionsEditor === "function") initDragDropQuestionsEditor();

  // Fliknavigering
  setupTabNavigation();

  if (typeof setupCloudBankUI === "function") setupCloudBankUI();
  if (typeof syncUI === "function") syncUI();

  // Uppdatera visuell bankstatus
  updateBankStatusUI();

  /* ---------- Elevyta: knappar ---------- */

  const btnSaveStudent = getEl("btnSaveStudent");
  if (btnSaveStudent) {
    btnSaveStudent.addEventListener("click", handleSaveStudent);
  }

  const btnStartE = getEl("start-levelE");
  const btnStartC = getEl("start-levelC");
  const btnStartA = getEl("start-levelA");
  if (btnStartE) btnStartE.addEventListener("click", () => startLevel("E"));
  if (btnStartC) btnStartC.addEventListener("click", () => startLevel("C"));
  if (btnStartA) btnStartA.addEventListener("click", () => startLevel("A"));

  const btnFinish = getEl("btnFinish");
  if (btnFinish) btnFinish.addEventListener("click", finishLevel);

  const btnBack = getEl("btnBack");
  if (btnBack) {
    btnBack.addEventListener("click", () => {
      const result = getEl("result");
      const play = getEl("play");
      if (result) result.classList.add("hidden");
      if (play) play.classList.add("hidden");
      const studentCard = getEl("studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      if (typeof syncUI === "function") syncUI();
    });
  }

  const btnCancel = getEl("btnCancel");
  if (btnCancel) {
    btnCancel.addEventListener("click", () => {
      if (typeof currentLevel !== "undefined") currentLevel = null;
      if (typeof currentQuestions !== "undefined") currentQuestions = [];
      if (typeof currentAnswers !== "undefined") currentAnswers = [];
      const play = getEl("play");
      const result = getEl("result");
      if (play) play.classList.add("hidden");
      if (result) result.classList.add("hidden");
      const studentCard = getEl("studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      if (typeof syncUI === "function") syncUI();
    });
  }

  const btnSubmitGame = getEl("btnSubmitGame");
  if (btnSubmitGame) {
    btnSubmitGame.addEventListener("click", async () => {
      try {
        await saveCurrentResultToFirestore();
        alert("Ditt resultat √§r inl√§mnat till l√§raren.");
      } catch (err) {
        console.error("Fel vid inl√§mning:", err);
        alert("Kunde inte l√§mna in resultatet. F√∂rs√∂k igen eller kontakta l√§raren.");
      }
    });
  }


  /* ---------- L√§rarl√§ge: knappar ---------- */

  const btnTeacherMode = getEl("btnTeacherMode");
  if (btnTeacherMode) {
    btnTeacherMode.addEventListener("click", openTeacherGate);
  }

  const btnTeacherCancel = getEl("btnTeacherCancel");
  if (btnTeacherCancel) {
    btnTeacherCancel.addEventListener("click", closeTeacherGate);
  }

  const btnTeacherConfirm = getEl("btnTeacherConfirm");
  if (btnTeacherConfirm) {
    btnTeacherConfirm.addEventListener("click", handleTeacherConfirm);
  }

  const btnCloseTeacher = getEl("btnCloseTeacher");
  if (btnCloseTeacher) {
    btnCloseTeacher.addEventListener("click", closeTeacherModal);
  }

  /* ---------- Inst√§llningar: tr√∂sklar, e-post, l√∂sen ---------- */

  const btnSaveThresholds = getEl("btnSaveThresholds");
  if (btnSaveThresholds && typeof handleSaveThresholds === "function") {
    btnSaveThresholds.addEventListener("click", handleSaveThresholds);
  }

  const btnSaveTeacherEmail = getEl("btnSaveTeacherEmail");
  if (btnSaveTeacherEmail && typeof handleSaveTeacherEmail === "function") {
    btnSaveTeacherEmail.addEventListener("click", handleSaveTeacherEmail);
  }

  const btnChangeTeacherPassword = getEl("btnChangeTeacherPassword");
  if (btnChangeTeacherPassword && typeof handleChangeTeacherPassword === "function") {
    btnChangeTeacherPassword.addEventListener("click", handleChangeTeacherPassword);
  }

  /* ---------- Delm√•l/delbitar ---------- */

  const btnAddGoalPart = getEl("btnAddGoalPart");
  if (btnAddGoalPart && typeof handleAddGoalPart === "function") {
    btnAddGoalPart.addEventListener("click", handleAddGoalPart);
  }

  const btnSaveGoalsMap = getEl("btnSaveGoalsMap");
  if (btnSaveGoalsMap && typeof handleSaveGoalsMap === "function") {
    btnSaveGoalsMap.addEventListener("click", handleSaveGoalsMap);
  }

  const btnClearGoalsMap = getEl("btnClearGoalsMap");
  if (btnClearGoalsMap && typeof handleClearGoalsMap === "function") {
    btnClearGoalsMap.addEventListener("click", handleClearGoalsMap);
  }

  /* ---------- Rensa / nollst√§ll elevdata ---------- */

  const btnClearStudentData = getEl("btnClearStudentData");
  if (btnClearStudentData && typeof handleClearStudentData === "function") {
    btnClearStudentData.addEventListener("click", handleClearStudentData);
  }

  const btnResetGameData = getEl("btnResetGameData");
  if (btnResetGameData && typeof handleResetGameData === "function") {
    btnResetGameData.addEventListener("click", handleResetGameData);
  }

  /* ---------- Fr√•gebank & Firebase ---------- */

  const btnLoadCloudBanks = getEl("btnLoadCloudBanks");
  if (btnLoadCloudBanks && typeof handleLoadCloudBanks === "function") {
    btnLoadCloudBanks.addEventListener("click", () => {
      handleLoadCloudBanks();
      updateBankStatusUI();
    });
  }

  const btnSaveToCloud = getEl("btnSaveToCloud");
  if (btnSaveToCloud && typeof handleSaveToCloud === "function") {
    btnSaveToCloud.addEventListener("click", () => {
      handleSaveToCloud();
      // Efter ev. √§ndringar i bank ‚Äì uppdatera status
      updateBankStatusUI();
    });
  }

  const btnExportBank = getEl("btnExportBank");
  if (btnExportBank && typeof handleExportBank === "function") {
    btnExportBank.addEventListener("click", () => {
      handleExportBank();
      // Export √§ndrar inte banken, men det √§r ofarligt att fr√§scha status
      updateBankStatusUI();
    });
  }

  const fileImport = getEl("fileImport");
  if (fileImport && typeof handleImportBank === "function") {
    fileImport.addEventListener("change", (evt) => {
      handleImportBank(evt);
      updateBankStatusUI();
    });
  }

  const btnGoogleLogin = getEl("btnGooglePlaceholder");
  if (btnGoogleLogin && typeof handleGoogleLogin === "function") {
    btnGoogleLogin.addEventListener("click", handleGoogleLogin);
  }

  const btnGoogleLogout = getEl("btnGoogleLogout");
  if (btnGoogleLogout && typeof handleGoogleLogout === "function") {
    btnGoogleLogout.addEventListener("click", handleGoogleLogout);
  }

  console.log("initApp klar ‚Äì knappar kopplade");
}

/* =========================
   5g ‚Äì DOMContentLoaded
   ========================= */

document.addEventListener("DOMContentLoaded", function () {
  if (typeof initFirebase === "function") {
    try {
      initFirebase();
      console.log("Firebase init OK");
    } catch (e) {
      console.error("Fel vid initFirebase:", e);
    }
  }

  try {
    initApp();
  } catch (e) {
    console.error("Fel vid initApp:", e);
  }
});
</script>
<!-- slut SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post, l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->




<!-- start SEKTION 6: AVSLUTANDE TAGGAR -->
</body>
</html>
<!-- slut SEKTION 6: AVSLUTANDE TAGGAR -->
