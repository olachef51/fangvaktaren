<!-- start SEKTION 3F: ELEVFLIKAR & RESULTAT (Firestore ‚Üí Elevprogression) -->
<script>
"use strict";
/* √ÑNDRAT: L√§gger till elevlista + ‚Äúflikar‚Äù i Elevprogression och laddar elevresultat fr√•n Firestore f√∂r aktiv bank. Omskrivna rader: ca 260 */

function _fv3f_hasReady(){
  return !!(typeof firebaseDbInstance !== "undefined" && firebaseDbInstance && typeof currentTeacherUser !== "undefined" && currentTeacherUser && currentTeacherUser.uid);
}

function _fv3f_getActiveBankId(){
  try{
    if (typeof _fv3d_activeBankId === "function") return String(_fv3d_activeBankId() || "").trim();
  }catch{}
  try{
    if (typeof window.activeCloudBankId !== "undefined" && window.activeCloudBankId) return String(window.activeCloudBankId).trim();
  }catch{}
  try{
    if (typeof loadState === "function") {
      const s = loadState();
      const ab = (s && s.activeBank) ? s.activeBank : {};
      if ((ab.mode||"") === "teacher" && ab.bankId) return String(ab.bankId).trim();
    }
  }catch{}
  return "";
}

function _fv3f_escape(s){
  try { if (typeof escapeHtml === "function") return escapeHtml(s); } catch {}
  if (!s && s !== 0) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function _fv3f_fmtDate(ts){
  try{
    if (!ts) return "";
    if (ts.toDate) {
      const d = ts.toDate();
      return d.toLocaleString();
    }
    if (typeof ts === "number") return new Date(ts).toLocaleString();
  }catch{}
  return "";
}

function _fv3f_goalLabel(goalId){
  try{
    if (typeof loadState !== "function") return `Delbit (${goalId})`;
    const s = loadState();
    const list = Array.isArray(s.goalsMap) ? s.goalsMap : [];
    const hit = list.find(g=> String(g.id) === String(goalId));
    if (hit) {
      const g = (hit.goal || "").trim();
      const p = (hit.parts || "").trim();
      if (g && p) return `${g} ‚Ä¢ ${p}`;
      if (p) return p;
      if (g) return g;
    }
  }catch{}
  return `Delbit (${goalId})`;
}

function _fv3f_pickStrongWeak(prog){
  const correct = (prog && prog.correctByGoalId) ? prog.correctByGoalId : {};
  const wrong   = (prog && prog.wrongByGoalId) ? prog.wrongByGoalId : {};

  const rows = [];
  const keys = new Set([].concat(Object.keys(correct||{}), Object.keys(wrong||{})));

  keys.forEach((k)=>{
    const c = Number(correct[k] || 0);
    const w = Number(wrong[k] || 0);
    const n = c + w;
    if (n <= 0) return;
    const acc = n ? (c / n) : 0;
    rows.push({ goalId: k, c, w, n, acc });
  });

  // Sort f√∂r stark/svag
  const strong = rows
    .filter(r=> r.n >= 3)
    .slice()
    .sort((a,b)=> (b.acc - a.acc) || (b.n - a.n))
    .slice(0, 8);

  const weak = rows
    .filter(r=> r.n >= 3)
    .slice()
    .sort((a,b)=> (a.acc - b.acc) || (b.n - a.n))
    .slice(0, 8);

  return { strong, weak };
}

function _fv3f_setProgressBoxes(studentDocData){
  const pointsEl = document.getElementById("progressPointsText");
  const strongEl = document.getElementById("progressStrongList");
  const weakEl   = document.getElementById("progressWeakList");

  const totalPoints = Number((studentDocData && studentDocData.progression && studentDocData.progression.totalPoints) || 0);
  const best = (studentDocData && studentDocData.best) ? studentDocData.best : { E:0, C:0, A:0 };
  const last = (studentDocData && studentDocData.lastResult) ? studentDocData.lastResult : null;

  // thresholds fr√•n state (l√§rarens inst√§llning)
  let th = { E:70, C:70, A:70 };
  try{
    if (typeof loadState === "function") {
      const s = loadState();
      th = Object.assign(th, (s && s.thres) ? s.thres : {});
    }
  }catch{}

  // Senast-rad
  let lastLine = "Senast: -";
  try{
    if (last) {
      const lvl = (last.level || "-");
      const pct = (typeof last.pct === "number") ? last.pct : (typeof last.percent === "number" ? last.percent : null);
      const correctN = (typeof last.correct === "number") ? last.correct : (typeof last.correctCount === "number" ? last.correctCount : null);
      const totalN = (typeof last.total === "number") ? last.total : (typeof last.totalCount === "number" ? last.totalCount : null);
      const pts = (typeof last.pointsEarned === "number") ? last.pointsEarned : (typeof last.points === "number" ? last.points : null);

      const pctTxt = (pct != null) ? `${Math.round(pct)}%` : "-";
      const ratio = (correctN != null && totalN != null) ? ` (${correctN}/${totalN} r√§tt)` : "";
      const ptsTxt = (pts != null) ? ` +${pts}p` : "";

      lastLine = `Senast: niv√• ${lvl} ‚Äì ${pctTxt}${ratio}${ptsTxt}.`;
    }
  }catch{}

  // Po√§ngbox (en niv√• per rad)
  if (pointsEl) {
    pointsEl.innerHTML =
      `Totalt: ${totalPoints} p.<br>` +
      `${_fv3f_escape(lastLine)}<br>` +
      `B√§sta:<br>` +
      `E ${Math.round(Number(best.E||0))}% (gr√§ns ${Math.round(Number(th.E||0))}%)<br>` +
      `C ${Math.round(Number(best.C||0))}% (gr√§ns ${Math.round(Number(th.C||0))}%)<br>` +
      `A ${Math.round(Number(best.A||0))}% (gr√§ns ${Math.round(Number(th.A||0))}%)`;
  }

  // Strong/Weak
  const prog = (studentDocData && studentDocData.progression) ? studentDocData.progression : { totalPoints:0, correctByGoalId:{}, wrongByGoalId:{} };
  const { strong, weak } = _fv3f_pickStrongWeak(prog);

  if (strongEl) {
    strongEl.innerHTML = "";
    if (!strong.length) {
      const li = document.createElement("li");
      li.textContent = "Inga starka delbitar √§nnu (beh√∂ver mer data).";
      strongEl.appendChild(li);
    } else {
      strong.forEach((r)=>{
        const li = document.createElement("li");
        const pct = Math.round(r.acc * 100);
        li.textContent = `${_fv3f_goalLabel(r.goalId)} ‚Äî ${pct}% (${r.c}/${r.n})`;
        strongEl.appendChild(li);
      });
    }
  }

  if (weakEl) {
    weakEl.innerHTML = "";
    if (!weak.length) {
      const li = document.createElement("li");
      li.textContent = "Inga svaga delbitar √§nnu (beh√∂ver mer data).";
      weakEl.appendChild(li);
    } else {
      weak.forEach((r)=>{
        const li = document.createElement("li");
        const pct = Math.round(r.acc * 100);
        li.textContent = `${_fv3f_goalLabel(r.goalId)} ‚Äî ${pct}% (${r.c}/${r.n})`;
        weakEl.appendChild(li);
      });
    }
  }
}

/* =========================
   UI: elevlista i Progress-tabben
   ========================= */

function _fv3f_findProgressCard(){
  const panel = document.querySelector('.tab-panel[data-panel="progress"]');
  if (!panel) return null;
  return panel.querySelector(".card") || panel;
}

function _fv3f_ensureUI(){
  const card = _fv3f_findProgressCard();
  if (!card) return null;

  if (!document.getElementById("fv3fStudentsBox")) {
    const box = document.createElement("div");
    box.id = "fv3fStudentsBox";
    box.style.marginTop = "12px";
    box.style.border = "1px solid rgba(31,41,55,1)";
    box.style.borderRadius = "12px";
    box.style.padding = "10px";
    box.style.background = "#020617";
    box.style.boxShadow = "0 0 0 1px rgba(15,23,42,1), 0 10px 24px rgba(15,23,42,.9)";

    box.innerHTML = `
      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div>
          <h3 style="margin:0;">Elever (aktiv bank)</h3>
          <div id="fv3fStudentsMeta" class="mini">-</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input id="fv3fStudentSearch" class="input" placeholder="S√∂k (namn/token)..." style="max-width:260px;" />
          <button id="fv3fReloadStudents" class="btn btn-sm" type="button">üîÑ Ladda elever</button>
        </div>
      </div>

      <div id="fv3fStudentsTabs" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;"></div>
      <div id="fv3fStudentsStatus" class="mini" style="margin-top:8px;white-space:pre-wrap;"></div>
    `;

    // L√§gg boxen √∂verst i kortet (utan att √§ndra din HTML)
    card.appendChild(box);
  }

  return {
    meta: document.getElementById("fv3fStudentsMeta"),
    tabs: document.getElementById("fv3fStudentsTabs"),
    status: document.getElementById("fv3fStudentsStatus"),
    btnReload: document.getElementById("fv3fReloadStudents"),
    search: document.getElementById("fv3fStudentSearch")
  };
}

async function _fv3f_fetchStudentsForActiveBank(){
  if (!_fv3f_hasReady()) throw new Error("Firebase/Teacher saknas");

  const bankId = _fv3f_getActiveBankId();
  if (!bankId) throw new Error("Ingen aktiv bank");

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION)
    .doc(String(currentTeacherUser.uid))
    .collection(CLOUD_BANKS_SUBCOLLECTION)
    .doc(String(bankId))
    .collection("students");

  // Visar √§ven ‚Äúej spelat‚Äù (docs skapas n√§r roster sparas)
  const snap = await ref.orderBy("updatedAt", "desc").limit(300).get();
  const out = [];
  (snap && snap.docs ? snap.docs : []).forEach((d)=>{
    out.push({ token: d.id, data: d.data ? d.data() : {} });
  });
  return { bankId, students: out };
}

function _fv3f_btn(label, isActive){
  const b = document.createElement("button");
  b.type = "button";
  b.className = "btn btn-sm" + (isActive ? " btn-primary" : "");
  b.style.padding = "6px 10px";
  b.style.borderRadius = "999px";
  b.textContent = label;
  return b;
}

async function _fv3f_loadStudentIntoBoxes(token){
  if (!_fv3f_hasReady()) return;

  const bankId = _fv3f_getActiveBankId();
  if (!bankId) return;

  const sref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION)
    .doc(String(currentTeacherUser.uid))
    .collection(CLOUD_BANKS_SUBCOLLECTION)
    .doc(String(bankId))
    .collection("students")
    .doc(String(token));

  const snap = await sref.get();
  if (!snap.exists) {
    _fv3f_setProgressBoxes({ progression:{ totalPoints:0, correctByGoalId:{}, wrongByGoalId:{} }, best:{E:0,C:0,A:0}, lastResult:null });
    return;
  }

  const data = snap.data() || {};
  _fv3f_setProgressBoxes(data);
}

function _fv3f_renderStudentsUI(payload){
  const ui = _fv3f_ensureUI();
  if (!ui) return;

  const { bankId, students } = payload || { bankId:"", students:[] };

  // meta
  const playedCount = (students || []).filter(s=> s && s.data && s.data.lastResult).length;
  if (ui.meta) ui.meta.textContent = `Bank: ${bankId || "-"} ‚Ä¢ Elever: ${(students||[]).length} ‚Ä¢ Spelat: ${playedCount}`;

  // tabs
  if (ui.tabs) ui.tabs.innerHTML = "";

  const searchTxt = (ui.search && ui.search.value) ? ui.search.value.trim().toLowerCase() : "";
  const filtered = (students || []).filter((s)=>{
    const token = String(s.token||"");
    const name = String((s.data && (s.data.name||s.data.studentName)) || "");
    if (!searchTxt) return true;
    return token.toLowerCase().includes(searchTxt) || name.toLowerCase().includes(searchTxt);
  });

  if (!filtered.length) {
    if (ui.status) ui.status.textContent = "Inga elever matchar s√∂kningen (eller inga elevdocs finns f√∂r banken √§nnu).";
    return;
  }

  if (ui.status) ui.status.textContent = "Klicka p√• en elev f√∂r att se po√§ng och starka/svaga delbitar.";

  // default active = f√∂rsta i listan
  const firstToken = String(filtered[0].token || "");
  window.__fv3f_selectedToken = window.__fv3f_selectedToken || firstToken;

  filtered.forEach((s)=>{
    const token = String(s.token || "");
    const data = s.data || {};
    const name = String(data.name || data.studentName || "").trim();
    const klass = String(data.klass || data.studentClass || "").trim();
    const hasPlayed = !!data.lastResult;

    const labelBase = name ? name : token;
    const label = klass ? `${labelBase} (${klass})` : labelBase;
    const deco = hasPlayed ? "" : " ‚Ä¢ (ej spelat)";

    const isActive = (String(window.__fv3f_selectedToken||"") === token);
    const b = _fv3f_btn(label + deco, isActive);

    b.addEventListener("click", async ()=>{
      window.__fv3f_selectedToken = token;

      // re-render to mark active button
      _fv3f_renderStudentsUI(payload);

      // load into boxes
      try { await _fv3f_loadStudentIntoBoxes(token); } catch (e) { console.error(e); }
    });

    ui.tabs.appendChild(b);
  });

  // ensure boxes filled for current selection (once)
  const sel = String(window.__fv3f_selectedToken||"");
  const exists = filtered.some(x=> String(x.token||"") === sel);
  const useToken = exists ? sel : firstToken;

  if (useToken) {
    // fill quickly with cached snapshot data if present
    const quick = filtered.find(x=> String(x.token||"") === useToken);
    if (quick && quick.data) _fv3f_setProgressBoxes(quick.data);
    // then refresh from doc
    _fv3f_loadStudentIntoBoxes(useToken).catch(()=>{});
  }
}

async function _fv3f_reloadStudents(){
  const ui = _fv3f_ensureUI();
  if (!ui) return;

  if (!_fv3f_hasReady()) {
    if (ui.status) ui.status.textContent = "‚òÅÔ∏è Logga in med Google och aktivera en bank f√∂r att se elever.";
    return;
  }

  const bankId = _fv3f_getActiveBankId();
  if (!bankId) {
    if (ui.status) ui.status.textContent = "Aktivera en moln-bank f√∂rst (Fr√•gebank ‚Üí Aktivera).";
    return;
  }

  if (ui.status) ui.status.textContent = "Laddar elever fr√•n molnet‚Ä¶";

  try{
    const payload = await _fv3f_fetchStudentsForActiveBank();
    window.__fv3f_studentsCache = payload;
    _fv3f_renderStudentsUI(payload);
  }catch(e){
    console.error("Kunde inte ladda elever:", e);
    if (ui.status) ui.status.textContent = "‚ö†Ô∏è Kunde inte ladda elever. Se konsolen.";
  }
}

function _fv3f_bindOnce(){
  if (window.__fv3f_bound) return;
  window.__fv3f_bound = true;

  // UI init
  _fv3f_ensureUI();

  // bind buttons
  document.addEventListener("click", (e)=>{
    const btn = e.target && e.target.closest ? e.target.closest("button") : null;
    if (!btn) return;

    if (btn.id === "fv3fReloadStudents") {
      e.preventDefault();
      _fv3f_reloadStudents();
      return;
    }

    // N√§r man klickar ‚ÄúAktivera‚Äù bank ‚Üí ladda elevlista efter en kort delay
    const act = btn.getAttribute("data-fv3d-activate");
    if (act) {
      setTimeout(()=>{ try{ _fv3f_reloadStudents(); }catch{} }, 350);
      return;
    }

    // N√§r man √∂ppnar ‚ÄúElevprogression‚Äù-fliken
    if (btn.id === "tab-progress" || btn.getAttribute("data-tab") === "progress") {
      setTimeout(()=>{ try{ _fv3f_reloadStudents(); }catch{} }, 250);
      return;
    }
  });

  // S√∂k (live)
  document.addEventListener("input", (e)=>{
    const t = e.target;
    if (!t || t.id !== "fv3fStudentSearch") return;
    const payload = window.__fv3f_studentsCache;
    if (payload) _fv3f_renderStudentsUI(payload);
  });

  // N√§r auth √§ndras, f√∂rs√∂k ladda om om progress-fliken anv√§nds
  try{
    if (typeof firebaseAuthInstance !== "undefined" && firebaseAuthInstance && typeof firebaseAuthInstance.onAuthStateChanged === "function") {
      if (!firebaseAuthInstance.__fv3f_hooked) {
        firebaseAuthInstance.__fv3f_hooked = true;
        firebaseAuthInstance.onAuthStateChanged(()=> {
          setTimeout(()=>{ try{ _fv3f_reloadStudents(); }catch{} }, 400);
        });
      }
    }
  }catch{}
}

try { _fv3f_bindOnce(); } catch {}
document.addEventListener("DOMContentLoaded", ()=>{ try{ _fv3f_bindOnce(); } catch {} });
</script>
<!-- slut SEKTION 3F: ELEVFLIKAR & RESULTAT (Firestore ‚Üí Elevprogression) -->
