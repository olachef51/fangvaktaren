<!-- start DEL 3/3: Script (del 2) + Closing -->
  /* === UI Sync & Spelfl√∂de === */
  function uiSync() {
    const s = load();

    // Gr√§nser
    const thrE = $('#thres-levelE');
    const thrC = $('#thres-levelC');
    const thrA = $('#thres-levelA');
    if (thrE) thrE.textContent = s.thresholds.levelE;
    if (thrC) thrC.textContent = s.thresholds.levelC;
    if (thrA) thrA.textContent = s.thresholds.levelA;

    // B√§sta resultat
    const bestE = $('#best-levelE');
    const bestC = $('#best-levelC');
    const bestA = $('#best-levelA');
    if (bestE) bestE.textContent = s.best.levelE || 0;
    if (bestC) bestC.textContent = s.best.levelC || 0;
    if (bestA) bestA.textContent = s.best.levelA || 0;

    // Elevkort
    const nameInput  = $('#studentName');
    const classInput = $('#studentClass');
    const savedLabel = $('#studentSaved');
    if (nameInput)  nameInput.value  = s.student.name  || '';
    if (classInput) classInput.value = s.student.klass || '';
    if (savedLabel) {
      savedLabel.textContent = s.student.name
        ? `Sparad: ${s.student.name} (${s.student.klass || '‚Äî'})`
        : 'Ej sparad elev';
    }

    // Kolla om niv√•bankar √§r tomma
    const bank = s.bank || {};
    const imgs = bank.images   || [];
    const drgs = bank.dragdrop || [];
    const mcqE = bank.mcqE     || [];
    const mcqC = bank.mcqC     || [];
    const mcqA = bank.mcqA     || [];

    const noE = imagesByLevel(imgs, 'E').length +
                dragByLevel(drgs, 'E').length +
                mcqE.length === 0;

    const noC = imagesByLevel(imgs, 'C').length +
                dragByLevel(drgs, 'C').length +
                mcqC.length === 0;

    // Uppl√•sning
    const ePassedOrEmpty   = (s.best.levelE >= s.thresholds.levelE) || noE;
    const levelCUnlocked   = s.unlocked.levelC || ePassedOrEmpty;
    const cPassed          = levelCUnlocked && (s.best.levelC >= s.thresholds.levelC);
    const cEmptyAndUnlocked = noC && levelCUnlocked;
    const levelAUnlocked   = s.unlocked.levelA || cPassed || cEmptyAndUnlocked;

    // Spara uppl√•sning om den √§ndrats
    if ((levelCUnlocked && !s.unlocked.levelC) || (levelAUnlocked && !s.unlocked.levelA)) {
      s.unlocked.levelC = levelCUnlocked;
      s.unlocked.levelA = levelAUnlocked;
      save(s);
    }

    // L√•sta / uppl√•sta kort
    const cardC = $('#card-levelC');
    const cardA = $('#card-levelA');
    const btnC  = $('#start-levelC');
    const btnA  = $('#start-levelA');

    if (cardC) cardC.classList.toggle('lock', !levelCUnlocked);
    if (btnC)  btnC.disabled = !levelCUnlocked;

    if (cardA) cardA.classList.toggle('lock', !levelAUnlocked);
    if (btnA)  btnA.disabled = !levelAUnlocked;

    // Badges
    const badgeE = $('#badge-levelE');
    const badgeC = $('#badge-levelC');
    const badgeA = $('#badge-levelA');

    if (badgeE) {
      const ok = noE || s.best.levelE >= s.thresholds.levelE;
      badgeE.className = 'badge ' + (ok ? 'ok' : 'warn');
      badgeE.textContent = noE
        ? 'Tom'
        : ok ? 'Godk√§nd' : `Beh√∂ver ${s.thresholds.levelE}%`;
    }

    if (badgeC) {
      if (!levelCUnlocked) {
        badgeC.className   = 'badge warn';
        badgeC.textContent = 'L√•st';
      } else {
        const ok = noC || s.best.levelC >= s.thresholds.levelC;
        badgeC.className = 'badge ' + (ok ? 'ok' : 'warn');
        badgeC.textContent = noC
          ? 'Tom'
          : ok ? 'Godk√§nd' : 'Uppl√•st';
      }
    }

    if (badgeA) {
      if (!levelAUnlocked) {
        badgeA.className   = 'badge warn';
        badgeA.textContent = 'L√•st';
      } else {
        const ok = s.best.levelA >= s.thresholds.levelA;
        badgeA.className   = 'badge ' + (ok ? 'ok' : 'warn');
        badgeA.textContent = ok ? 'Godk√§nd' : 'Uppl√•st';
      }
    }
  }

  let currentMode = null;

  function ensureStudent() {
    const d = load().student;
    const has = d.name && d.name.trim() && d.klass && d.klass.trim();
    if (!has) notify('Fyll i Namn & Klass (klicka Spara).');
    return !!has;
  }

  async function startMode(mode) {
    if (!ensureStudent()) return;

    currentMode = mode;
    const s = load();
    const play      = $('#play');
    const student   = $('#studentCard');
    const resultBox = $('#result');
    const grid      = $('.grid');
    const qHost     = $('#questions');
    const whoText   = $('#whoPlays');
    const title     = $('#play-title');

    if (!play || !student || !grid || !qHost || !whoText || !title) return;

    play.classList.remove('hidden');
    student.classList.add('hidden');
    if (resultBox) resultBox.classList.add('hidden');
    grid.style.opacity = '0.2';

    qHost.innerHTML = `<div class="mini">Laddar...</div>`;
    whoText.textContent = `${s.student.name} (${s.student.klass})`;

    let questions = [];
    let levelName = '';

    try {
      const b = s.bank || {};
      const imgs = b.images   || [];
      const drgs = b.dragdrop || [];
      const mcqE = b.mcqE     || [];
      const mcqC = b.mcqC     || [];
      const mcqA = b.mcqA     || [];

      if (mode === 'levelE') {
        levelName = 'Niv√• 1';
        questions.push(
          ...imagesByLevel(imgs, 'E'),
          ...dragByLevel(drgs, 'E'),
          ...mcqE
        );
      } else if (mode === 'levelC') {
        levelName = 'Niv√• 2';
        questions.push(
          ...imagesByLevel(imgs, 'C'),
          ...dragByLevel(drgs, 'C'),
          ...mcqC
        );
      } else if (mode === 'levelA') {
        levelName = 'Niv√• 3';
        questions.push(
          ...imagesByLevel(imgs, 'A'),
          ...dragByLevel(drgs, 'A'),
          ...mcqA
        );
      } else {
        throw new Error('Ok√§nt l√§ge');
      }

      title.textContent = levelName;
      await renderCombinedLevel(questions);
    } catch (e) {
      console.error('Start fail:', e);
      qHost.innerHTML = `<div class="question err-text">Laddningsfel.</div>`;
    }
  }

  function isPass(mode, score, thresholds) {
    if (mode === 'levelE') return score >= thresholds.levelE;
    if (mode === 'levelC') return score >= thresholds.levelC;
    if (mode === 'levelA') return score >= thresholds.levelA;
    return false;
  }

  function finish() {
    const s = load();

    let total   = 0;
    let correct = 0;

    const critStats = {};
    const objStats  = {};

    // Initiera statsstruktur
    s.objectives.forEach((o, oi) => {
      objStats[oi] = {
        name: o.name || `Delm√•l ${oi + 1}`,
        t: 0,
        c: 0
      };
      (o.criteria || []).forEach((c, ci) => {
        if (c && c.trim()) {
          const id = `${oi}-${ci}`;
          critStats[id] = {
            name: c,
            objIdx: oi,
            t: 0,
            c: 0
          };
        }
      });
    });

    // Po√§ng per fr√•ga
    currentQuestions.forEach((q, idx) => {
      let qCorrect = false;
      let qWeight  = 1;

      if (q.type === 'image_mcq' || q.type === 'mcq') {
        total++;
        const ansIndex = resolveCorrectIndex(q);
        if (answers[idx] === ansIndex) {
          correct++;
          qCorrect = true;
        }
      } else if (q.type === 'dragdrop') {
        const map   = answers[idx] || {};
        const pairs = q.pairs || [];
        let cPairs  = 0;

        qWeight = pairs.length;
        total  += qWeight;

        pairs.forEach(p => {
          const left  = p[0];
          const right = p[1];
          if ((map[left] || '') === right) cPairs++;
        });

        correct += cPairs;
        if (cPairs === qWeight) qCorrect = true;
        qWeight = 1; // vikt f√∂r delm√•l
      }

      (q.linkedCriteria || []).forEach(id => {
        const st = critStats[id];
        if (!st) return;
        st.t += qWeight;
        if (qCorrect) st.c += qWeight;
      });
    });

    // Summera upp till delm√•l
    for (const id in critStats) {
      const st = critStats[id];
      const obj = objStats[st.objIdx];
      if (!obj) continue;
      obj.t += st.t;
      obj.c += st.c;
    }

    const score  = total > 0 ? Math.round((correct / total) * 100) : 0;
    const passed = isPass(currentMode, score, s.thresholds);

    // Spara b√§sta resultat
    if (currentMode === 'levelE') {
      s.best.levelE = Math.max(s.best.levelE || 0, score);
    } else if (currentMode === 'levelC') {
      s.best.levelC = Math.max(s.best.levelC || 0, score);
    } else if (currentMode === 'levelA') {
      s.best.levelA = Math.max(s.best.levelA || 0, score);
    }

    // Uppl√•sning
    if (currentMode === 'levelE' && passed) s.unlocked.levelC = true;
    if (currentMode === 'levelC' && passed) s.unlocked.levelA = true;

    submissionData = {
      studentName:   s.student?.name  || '?',
      studentClass:  s.student?.klass || '?',
      levelCompleted: currentMode,
      scorePercent:   score,
      correctAnswers: correct,
      totalQuestions: total,
      passed,
      criteriaStats:  critStats,
      objectiveStats: objStats,
      timestamp:      new Date().toISOString()
    };

    save(s);

    const canC = !$('#start-levelC')?.disabled;
    const canA = !$('#start-levelA')?.disabled;

    // Auto-hoppa till n√§sta niv√• om godk√§nd
    if (passed && currentMode === 'levelE' && canC) {
      notify('Niv√• 1 klar! -> Niv√• 2');
      startMode('levelC');
      return;
    }
    if (passed && currentMode === 'levelC' && canA) {
      notify('Niv√• 2 klar! -> Niv√• 3');
      startMode('levelA');
      return;
    }

    // Visa resultatvy
    const play      = $('#play');
    const grid      = $('.grid');
    const resultBox = $('#result');
    const student   = $('#studentCard');

    if (play) play.classList.add('hidden');
    if (grid) grid.style.opacity = '1';
    if (resultBox) resultBox.classList.remove('hidden');
    if (student) student.classList.add('hidden');

    const scoreText   = $('#scoreText');
    const scoreDetail = $('#scoreDetail');
    const resName     = $('#resName');
    const resClass    = $('#resClass');
    const passBadge   = $('#passBadge');
    const unlockText  = $('#unlockText');

    if (scoreText)   scoreText.textContent   = `${score}%`;
    if (scoreDetail) scoreDetail.textContent = `${correct}/${total} po√§ng`;
    if (resName)     resName.textContent     = s.student.name  || '?';
    if (resClass)    resClass.textContent    = s.student.klass || '?';

    if (passBadge) {
      passBadge.textContent = passed
        ? (currentMode === 'levelA'
          ? 'üèÅ Alla niv√•er klara!'
          : '‚úÖ Godk√§nd niv√•!')
        : '‚ùå Ej godk√§nd niv√•.';
    }

    if (unlockText) {
      let msg = '';
      if (currentMode === 'levelE') {
        msg = passed
          ? 'Niv√• 2 uppl√•st.'
          : `Beh√∂ver ${s.thresholds.levelE}%.`;
      } else if (currentMode === 'levelC') {
        msg = passed
          ? 'Niv√• 3 uppl√•st.'
          : `Beh√∂ver ${s.thresholds.levelC}%.`;
      } else {
        msg = passed
          ? 'Alla niv√•er klara!'
          : `Beh√∂ver ${s.thresholds.levelA}%.`;
      }
      unlockText.textContent = msg;
    }

    // Resultat per delm√•l
    const critContainer = $('#criteriaResults');
    if (critContainer) {
      critContainer.innerHTML = '<h4>Resultat per Delm√•l:</h4>';
      let hasCritRes = false;

      for (const idx in objStats) {
        const st = objStats[idx];
        if (st.t > 0) {
          hasCritRes = true;
          const perc = Math.round((st.c / st.t) * 100);
          const cls  = perc >= 70 ? 'res-ok' : (perc >= 40 ? 'res-warn' : 'res-err');
          const div  = document.createElement('div');
          div.className = 'criterion-result';
          div.innerHTML =
            `<strong>${escapeHTML(st.name)}:</strong> ` +
            `<span class="${cls}">${perc}%</span> (${st.c}/${st.t} p)`;
          critContainer.appendChild(div);
        }
      }
      critContainer.classList.toggle('hidden', !hasCritRes);
    }

    const isFinal        = currentMode === 'levelA';
    const prepareBtn     = $('#prepareSubmitBtn');
    const backBtn        = $('#btnBack');
    const exportSection  = $('#exportSection');
    const normalActions  = $('#resultActionsNormal');

    if (prepareBtn)    prepareBtn.classList.toggle('hidden', !isFinal);
    if (backBtn)       backBtn.classList.remove('hidden');
    if (exportSection) exportSection.classList.add('hidden');
    if (normalActions) normalActions.classList.remove('hidden');

    uiSync();
  }

  function hidePlayUI() {
    const play    = $('#play');
    const student = $('#studentCard');
    const grid    = $('.grid');
    const result  = $('#result');

    if (play)    play.classList.add('hidden');
    if (result)  result.classList.add('hidden');
    if (student) student.classList.remove('hidden');
    if (grid)    grid.style.opacity = '1';

    uiSync();
  }

  /* === Adminpanel === */
  function openAdmin() {
    const s  = load();
    const el = (sel) => document.querySelector(sel);

    if (el('#currPass'))     el('#currPass').textContent = s.teacherPassword || '';
    if (el('#teacherEmail')) el('#teacherEmail').value   = s.teacherEmail   || '';
    if (el('#thr-levelE'))   el('#thr-levelE').value     = s.thresholds?.levelE ?? 70;
    if (el('#thr-levelC'))   el('#thr-levelC').value     = s.thresholds?.levelC ?? 70;
    if (el('#thr-levelA'))   el('#thr-levelA').value     = s.thresholds?.levelA ?? 70;
    if (el('#newPass'))      el('#newPass').value        = '';

    try { renderObjectives();        } catch (e) { console.error('renderObjectives fail', e); }
    try { updateObjectiveSelects();  } catch (e) { console.error('updateObjectiveSelects fail', e); }
    try { renderMCQAdminLists();     } catch (e) { console.error('renderMCQAdminLists fail', e); }
    try { renderImageAdminList();    } catch (e) { console.error('renderImageAdminList fail', e); }
    try { renderDragAdminList();     } catch (e) { console.error('renderDragAdminList fail', e); }
    try { updateStorageInfo();       } catch (e) { console.error('updateStorageInfo fail', e); }

    const modal = el('#modal');
    if (modal) {
      modal.classList.add('show');
      setupModalTabs();
      switchTabByName('settings');
      setTimeout(() => {
        (el('#newPass') ||
         el('#teacherEmail') ||
         modal.querySelector('input,select,button'))?.focus();
      }, 50);
    }
  }

  function checkGate() {
    const pwInput = document.querySelector('#gatePw');
    const pw      = (pwInput?.value || '').trim();
    const s       = load();

    if (pwInput) pwInput.value = '';

    const ok = pw === (s.teacherPassword || '');
    if (!ok) {
      notify('Fel l√∂senord.');
      postLoginAction = null;
      return;
    }

    const gate = document.querySelector('#gate');
    if (gate) gate.classList.remove('show');

    const action = postLoginAction;
    postLoginAction = null;

    if (action === 'openAdmin') {
      openAdmin();
    } else if (action === 'downloadGame') {
      packageGameToFile()
        .catch(e => {
          console.error('Package fail:', e);
          notify('Kunde inte skapa spelfil: ' + (e?.message || e));
        });
    } else {
      openAdmin();
    }
  }

  /* === Adminlistor === */
  function getCriteriaName(s, id) {
    const [oi, ci] = id.split('-').map(Number);
    return s.objectives?.[oi]?.criteria?.[ci] || `Ok√§nd(${id})`;
  }

  function renderMCQAdminListFor(level, cId) {
    const host = $(cId);
    if (!host) return;

    const s   = load();
    const arr = (level === 'E'
      ? s.bank.mcqE
      : level === 'C'
        ? s.bank.mcqC
        : s.bank.mcqA) || [];

    host.innerHTML = arr.length > 0
      ? `<div class="mini">Niv√• ${level} (${arr.length} st)</div>`
      : '';

    arr.forEach((q, i) => {
      const opts   = getOptionTexts(q);
      const linked = q.linkedCriteria || [];
      let linkHTML = '';

      if (linked.length > 0) {
        linkHTML = '<ul class="linked-criteria-list">';
        linked.forEach(id => {
          linkHTML += `<li>üîó ${escapeHTML(getCriteriaName(s, id))}</li>`;
        });
        linkHTML += '</ul>';
      }

      const div = document.createElement('div');
      div.className = 'listItem';
      div.innerHTML = `
        <div class="mini">MCQ</div>
        <div>
          <div style="font-weight:700">${escapeHTML(getQText(q))} <span class="tag level">${level}</span></div>
          <div class="mini">
            ${opts.map((o, oi) =>
              `${escapeHTML(o)}${
                resolveCorrectIndex(q) === oi ? '<span class="tag ok">‚úì</span>' : ''
              }`
            ).join(' ‚Ä¢ ')}
          </div>
          ${linkHTML}
        </div>
        <div class="actions">
          <button class="btn secondary miniBtn" data-list="mcq" data-level="${level}" data-idx="${i}">Ta bort</button>
        </div>`;
      host.appendChild(div);
    });
  }

  function renderMCQAdminLists() {
    ['E', 'C', 'A'].forEach(l => renderMCQAdminListFor(l, `#mcqList${l}`));
  }

  async function renderImageAdminList() {
    const host = $('#imgList');
    if (!host) return;

    const s      = load();
    const images = s.bank.images || [];

    host.innerHTML = '';
    if (images.length === 0) {
      host.innerHTML = `<div class="mini">Inga bildfr√•gor.</div>`;
      return;
    }

    const frag = document.createDocumentFragment();

    images.forEach((q, i) => {
      if (!q) return;
      const opts   = getOptionTexts(q);
      const linked = q.linkedCriteria || [];
      let linkHTML = '';

      if (linked.length > 0) {
        linkHTML = '<ul class="linked-criteria-list">';
        linked.forEach(id => {
          linkHTML += `<li>üîó ${escapeHTML(getCriteriaName(s, id))}</li>`;
        });
        linkHTML += '</ul>';
      }

      const li = document.createElement('div');
      li.className = 'listItem';
      li.innerHTML = `
        <img alt="Laddar..." id="athumb-${i}"/>
        <div>
          <div style="font-weight:700">${escapeHTML(getQText(q))} <span class="tag level">${q.level || 'E'}</span></div>
          <div class="mini">
            ${opts.map((o, oi) =>
              `${escapeHTML(o)}${
                resolveCorrectIndex(q) === oi ? '<span class="tag ok">‚úì</span>' : ''
              }`
            ).join(' ‚Ä¢ ')}
          </div>
          ${linkHTML}
        </div>
        <div class="actions">
          <button class="btn secondary miniBtn" data-list="image" data-idx="${i}">Ta bort</button>
        </div>`;
      frag.appendChild(li);
    });

    host.appendChild(frag);

    // Asynkrona thumbnails
    for (let i = 0; i < images.length; i++) {
      const q = images[i];
      if (!q) continue;
      const imgEl = host.querySelector(`#athumb-${i}`);
      if (!imgEl) continue;
      try {
        const url = await resolveImgURL(q);
        if (url) {
          imgEl.src = url;
          imgEl.alt = `Mini ${i + 1}`;
          imgEl.onload = imgEl.onerror = () => {
            if (url.startsWith('blob:')) URL.revokeObjectURL(url);
          };
        } else {
          imgEl.alt = 'Bild saknas';
        }
      } catch {
        imgEl.alt = 'Laddfel';
      }
    }
  }

  function renderDragAdminList() {
    const host = $('#dragList');
    if (!host) return;

    const s     = load();
    const items = s.bank.dragdrop || [];

    host.innerHTML = '';
    if (items.length === 0) {
      host.innerHTML = `<div class="mini">Inga D&D.</div>`;
      return;
    }

    items.forEach((it, i) => {
      const pairs  = it.pairs || [];
      const level  = it.level || 'C';
      const linked = it.linkedCriteria || [];
      let linkHTML = '';

      if (linked.length > 0) {
        linkHTML = '<ul class="linked-criteria-list">';
        linked.forEach(id => {
          linkHTML += `<li>üîó ${escapeHTML(getCriteriaName(s, id))}</li>`;
        });
        linkHTML += '</ul>';
      }

      const div = document.createElement('div');
      div.className = 'listItem';
      div.innerHTML = `
        <div class="mini">DRAG</div>
        <div>
          <div style="font-weight:700">${escapeHTML(it.title || 'Matchning')} <span class="tag level">${level}</span></div>
          <div class="mini">
            ${pairs.map(p => `${escapeHTML(p[0])}‚Üî${escapeHTML(p[1])}`).join(' ‚Ä¢ ')}
          </div>
          ${linkHTML}
        </div>
        <div class="actions">
          <button class="btn secondary miniBtn" data-list="drag" data-idx="${i}">Ta bort</button>
        </div>`;
      host.appendChild(div);
    });
  }

  /* === Delm√•l === */
  function renderObjectives() {
    const s = load();
    const c = $('#objectivesListContainer');
    if (!c) return;

    c.innerHTML = '';

    if (!s.objectives || s.objectives.length === 0) {
      c.innerHTML = `<div class="mini">Inga delm√•l.</div>`;
      return;
    }

    s.objectives.forEach((o, i) => {
      const g = document.createElement('div');
      g.className   = 'objective-group';
      g.dataset.idx = String(i);

      g.innerHTML = `
        <button type="button" class="btn danger miniBtn remove-objective-btn" data-idx="${i}" title="Ta bort">X</button>
        <div class="row main-objective">
          <label for="obj${i}-name">Delm√•l ${i + 1}</label>
          <input id="obj${i}-name" class="input obj-name" value="${escapeHTML(o.name || '')}" placeholder="Namn"/>
        </div>
        <div class="row sub-row"><label for="obj${i}-crit0">Delbit .1</label><input id="obj${i}-crit0" class="input obj-crit0" value="${escapeHTML(o.criteria?.[0] || '')}" placeholder="Delbit 1"/></div>
        <div class="row sub-row"><label for="obj${i}-crit1">Delbit .2</label><input id="obj${i}-crit1" class="input obj-crit1" value="${escapeHTML(o.criteria?.[1] || '')}" placeholder="Delbit 2"/></div>
        <div class="row sub-row"><label for="obj${i}-crit2">Delbit .3</label><input id="obj${i}-crit2" class="input obj-crit2" value="${escapeHTML(o.criteria?.[2] || '')}" placeholder="Delbit 3"/></div>
        <div class="row sub-row"><label for="obj${i}-crit3">Delbit .4</label><input id="obj${i}-crit3" class="input obj-crit3" value="${escapeHTML(o.criteria?.[3] || '')}" placeholder="Delbit 4"/></div>
        <div class="row sub-row"><label for="obj${i}-crit4">Delbit .5</label><input id="obj${i}-crit4" class="input obj-crit4" value="${escapeHTML(o.criteria?.[4] || '')}" placeholder="Delbit 5"/></div>
      `;
      c.appendChild(g);
    });
  }

  function populateCriteriaDropdown(objSelectId, critSelectId) {
    const s          = load();
    const objSelect  = $(objSelectId);
    const critSelect = $(critSelectId);
    if (!objSelect || !critSelect) return;

    const selIdx = parseInt(objSelect.value, 10);

    critSelect.innerHTML = '<option value="">-- V√§lj Delbit --</option>';
    critSelect.disabled  = true;

    if (!isNaN(selIdx) && s.objectives[selIdx]) {
      s.objectives[selIdx].criteria.forEach((crit, critIdx) => {
        if (crit && crit.trim()) {
          const id  = `${selIdx}-${critIdx}`;
          const opt = document.createElement('option');
          opt.value      = id;
          opt.textContent = crit;
          critSelect.appendChild(opt);
        }
      });
      if (critSelect.options.length > 1) critSelect.disabled = false;
    }
  }

  function setupObjectiveDropdowns(objSelectId, critSelectId, addBtnId, listId, currentLinksRef) {
    const objSelect = $(objSelectId);
    const critSelect= $(critSelectId);
    const addBtn    = $(addBtnId);
    const list      = $(listId);
    if (!objSelect || !critSelect || !addBtn || !list) return;

    const s = load();

    objSelect.innerHTML = '<option value="">-- V√§lj Delm√•l --</option>';
    s.objectives.forEach((obj, idx) => {
      if (obj.name && obj.name.trim()) {
        const opt = document.createElement('option');
        opt.value      = String(idx);
        opt.textContent = obj.name;
        objSelect.appendChild(opt);
      }
    });

    const populateHandler = () => populateCriteriaDropdown(objSelectId, critSelectId);
    objSelect.addEventListener('change', populateHandler);

    const renderAddedLinks = () => {
      list.innerHTML = '';
      (currentLinksRef.links || []).forEach((linkId, index) => {
        const [objIdx, critIdx] = linkId.split('-').map(Number);
        const objName  = s.objectives?.[objIdx]?.name || '?';
        const critName = s.objectives?.[objIdx]?.criteria?.[critIdx] || '?';

        const li = document.createElement('li');
        li.innerHTML =
          `${escapeHTML(critName)} ` +
          `<small>(${escapeHTML(objName)})</small> ` +
          `<button type="button" data-index="${index}" title="Ta bort koppling">√ó</button>`;
        const btn = li.querySelector('button');
        if (btn) {
          btn.addEventListener('click', (e) => {
            const idxToRemove = parseInt(e.target.dataset.index, 10);
            if (!isNaN(idxToRemove)) {
              currentLinksRef.links.splice(idxToRemove, 1);
              renderAddedLinks();
            }
          });
        }
        list.appendChild(li);
      });
    };

    addBtn.addEventListener('click', () => {
      const selectedCritId = critSelect.value;
      if (selectedCritId && !(currentLinksRef.links || []).includes(selectedCritId)) {
        if (!currentLinksRef.links) currentLinksRef.links = [];
        currentLinksRef.links.push(selectedCritId);
        renderAddedLinks();
        critSelect.value = '';
        objSelect.value  = '';
        critSelect.disabled = true;
      }
    });

    renderAddedLinks();
  }

  function updateObjectiveSelects() {
    const s = load();
    const selects = [
      { obj: '#mcqObjectiveSelect',        crit: '#mcqCriteriaSelect'        },
      { obj: '#imageObjectiveSelect',      crit: '#imageCriteriaSelect'      },
      { obj: '#dragObjectiveSelect',       crit: '#dragCriteriaSelect'       },
      { obj: '#mcqImportObjectiveSelectE', crit: '#mcqImportCriteriaSelectE' },
      { obj: '#mcqImportObjectiveSelectC', crit: '#mcqImportCriteriaSelectC' },
      { obj: '#mcqImportObjectiveSelectA', crit: '#mcqImportCriteriaSelectA' }
    ];

    selects.forEach(pair => {
      const objSelect = $(pair.obj);
      const critId    = pair.crit;
      if (!objSelect) return;

      const currentVal = objSelect.value;
      objSelect.innerHTML = '<option value="">-- V√§lj Delm√•l --</option>';

      s.objectives.forEach((obj, idx) => {
        if (obj.name && obj.name.trim()) {
          const opt = document.createElement('option');
          opt.value      = String(idx);
          opt.textContent = obj.name;
          objSelect.appendChild(opt);
        }
      });

      objSelect.value = currentVal;
      populateCriteriaDropdown(pair.obj, critId);
    });
  }

  /* === Tabs i l√§rarl√§ge === */
  function switchTabByName(name) {
    const targetId = `tab-${name}`;

    document.querySelectorAll('#modal .tab-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === name);
    });

    document.querySelectorAll('#modal .tab-content').forEach(panel => {
      panel.classList.toggle('hidden', panel.id !== targetId);
    });

    if (name === 'image') renderImageAdminList();
    if (name === 'mcq')   renderMCQAdminLists();
    if (name === 'drag')  renderDragAdminList();
  }

  function setupModalTabs() {
    const nav = document.querySelector('#modal .tab-nav');
    if (!nav) return;

    nav.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if (!btn) return;
      e.preventDefault();
      const name = btn.dataset.tab;
      if (!name) return;
      switchTabByName(name);
    }, { passive: true });
  }

  /* === Byggare/addera === */
  function addOptionRow(listSelector, isCorrect = false, value = '') {
    const list = $(listSelector);
    if (!list) return;

    const div = document.createElement('div');
    div.className = 'builder-row';
    div.innerHTML = `
      <input type="checkbox" ${isCorrect ? 'checked' : ''} aria-label="R√§tt svar">
      <label>Alt:</label>
      <input type="text" class="input option-text" value="${escapeHTML(value)}" placeholder="Alternativtext...">
      <button type="button" class="remove-option-btn" title="Ta bort alternativ">X</button>`;
    list.appendChild(div);
  }

  function handleRemoveOption(event) {
    if (event.target.classList.contains('remove-option-btn')) {
      const row = event.target.closest('.builder-row');
      if (row) row.remove();
    }
  }

  function addDragPairRow(leftVal = '', rightVal = '') {
    const list = $('#dragPairList');
    if (!list) return;

    const div = document.createElement('div');
    div.className = 'drag-pair-row';
    div.innerHTML = `
      <input type="text" class="input drag-left" value="${escapeHTML(leftVal)}" placeholder="V√§nster bricka...">
      <span>‚ÜîÔ∏è</span>
      <input type="text" class="input drag-right" value="${escapeHTML(rightVal)}" placeholder="H√∂ger ruta...">
      <button type="button" class="remove-pair-btn" title="Ta bort par">X</button>`;
    list.appendChild(div);
  }

  function handleRemoveDragPair(event) {
    if (event.target.classList.contains('remove-pair-btn')) {
      const row = event.target.closest('.drag-pair-row');
      if (row) row.remove();
    }
  }

  function collectOptions(listSelector) {
    const options = [];
    let correctIndex = -1;

    $$(listSelector + ' .builder-row').forEach(row => {
      const textInput = row.querySelector('.option-text');
      const checkBox  = row.querySelector('input[type=checkbox]');
      const text      = (textInput?.value || '').trim();
      const isChecked = !!(checkBox && checkBox.checked);

      if (text) {
        options.push(text);
        if (isChecked && correctIndex === -1) {
          correctIndex = options.length - 1;
        }
      }
    });

    if (correctIndex === -1 && options.length > 0) correctIndex = 0;

    return { options, answer: correctIndex };
  }

  function addManualMCQ() {
    const level   = $('#mcqLevel')?.value || 'E';
    const prompt  = $('#mcqPrompt')?.value.trim() || '';
    const optData = collectOptions('#mcqOptList');
    const linked  = window.tempBuilderLinks?.mcq?.links || [];
    const status  = $('#addStatusMCQ');

    if (!prompt || optData.options.length < 2) {
      if (status) status.textContent = 'Fyll i fr√•ga och minst 2 alternativ.';
      return;
    }

    const newQ = {
      id:   'mcq_' + Date.now(),
      type: 'mcq',
      level,
      q: prompt,
      options: optData.options,
      answer:  optData.answer,
      linkedCriteria: [...linked]
    };

    const s      = load();
    const bankKey= `mcq${level}`;
    if (!s.bank[bankKey]) s.bank[bankKey] = [];
    s.bank[bankKey].push(newQ);

    if (save(s)) {
      if (status) status.textContent = `Fr√•ga tillagd (${level}).`;
      const promptEl = $('#mcqPrompt');
      const listEl   = $('#mcqOptList');
      if (promptEl) promptEl.value = '';
      if (listEl) {
        listEl.innerHTML = '';
        addOptionRow('#mcqOptList');
        addOptionRow('#mcqOptList');
      }
      window.tempBuilderLinks.mcq.links = [];
      const added = $('#mcqAddedLinks');
      if (added) added.innerHTML = '';
      const objSel  = $('#mcqObjectiveSelect');
      const critSel = $('#mcqCriteriaSelect');
      if (objSel)  objSel.value = '';
      if (critSel) {
        critSel.value    = '';
        critSel.disabled = true;
      }
      renderMCQAdminLists();
    } else if (status) {
      status.textContent = 'Kunde inte spara.';
    }
  }

  let currentImageDataUrl = null;

  async function previewImage() {
    const fileInput = $('#qImgFile');
    const preview   = $('#thumbPreview');
    const status    = $('#addStatus');

    currentImageDataUrl = null;

    if (preview) preview.innerHTML = `<em class="mini">Laddar...</em>`;

    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
      if (preview) preview.innerHTML = `<em class="mini">Ingen bild</em>`;
      return;
    }

    const file            = fileInput.files[0];
    const qualitySettings = ($('#imgQuality')?.value || '900|0.7')
      .split('|')
      .map(Number);

    const options = {
      maxSide: qualitySettings[0] || 900,
      quality: qualitySettings[1] || 0.7
    };

    try {
      currentImageDataUrl = await fileToAdaptiveDataURL(file, options);
      if (preview) {
        preview.innerHTML =
          `<img src="${currentImageDataUrl}" alt="F√∂rhandsgranskning">`;
      }
      if (status) {
        const sizeKB = Math.round(
          ((currentImageDataUrl.split(',')[1]?.length || 0) * 3 / 4) / 1024
        );
        status.textContent = `Bild klar (${sizeKB} kB).`;
      }
    } catch (e) {
      console.error('Preview/Compress fail:', e);
      if (preview) preview.innerHTML = `<em class="mini err-text">Bildfel</em>`;
      if (status)  status.textContent = 'Fel vid bildhantering.';
    }
  }

  async function addManualImageMCQ() {
    const level   = $('#imgLevel')?.value || 'E';
    const prompt  = $('#qPrompt')?.value.trim() || '';
    const optData = collectOptions('#optList');
    const linked  = window.tempBuilderLinks?.image?.links || [];
    const status  = $('#addStatus');

    if (!currentImageDataUrl) {
      if (status) status.textContent = 'V√§lj en bild f√∂rst.';
      return;
    }
    if (!prompt || optData.options.length < 2) {
      if (status) status.textContent = 'Fyll i fr√•ga och minst 2 alternativ.';
      return;
    }

    if (status) status.textContent = 'Sparar bild...';

    let imgRef = null;
    try {
      imgRef = await storeImageRefFromDataURL(currentImageDataUrl);

      const newQ = {
        id:   'img_' + Date.now(),
        type: 'image_mcq',
        level,
        imgRef,
        q: prompt,
        options: optData.options,
        answer:  optData.answer,
        linkedCriteria: [...linked]
      };

      const s = load();
      if (!s.bank.images) s.bank.images = [];
      s.bank.images.push(newQ);

      if (save(s)) {
        if (status) status.textContent = `Bildfr√•ga tillagd (${level}).`;
        const promptEl = $('#qPrompt');
        const listEl   = $('#optList');
        const fileEl   = $('#qImgFile');
        const prev     = $('#thumbPreview');

        if (promptEl) promptEl.value = 'Vad visar bilden?';
        if (listEl) {
          listEl.innerHTML = '';
          addOptionRow('#optList');
          addOptionRow('#optList');
        }
        if (fileEl) fileEl.value = '';
        if (prev)   prev.innerHTML = '<em class="mini">Ingen bild</em>';

        currentImageDataUrl = null;
        window.tempBuilderLinks.image.links = [];
        const added = $('#imageAddedLinks');
        if (added) added.innerHTML = '';
        const objSel  = $('#imageObjectiveSelect');
        const critSel = $('#imageCriteriaSelect');
        if (objSel)  objSel.value = '';
        if (critSel) {
          critSel.value    = '';
          critSel.disabled = true;
        }
        renderImageAdminList();
        updateStorageInfo();
      } else {
        if (status) status.textContent = 'Kunde inte spara fr√•gan.';
        if (imgRef) {
          try { await idbDel(imgRef); } catch {}
        }
      }
    } catch (e) {
      console.error('Add image fail:', e);
      if (status) status.textContent = 'Fel vid sparande av bild.';
    }
  }

  function addManualDragDrop() {
    const level  = $('#dragLevel')?.value || 'C';
    const title  = $('#dragTitle')?.value.trim() || '';
    const linked = window.tempBuilderLinks?.drag?.links || [];
    const status = $('#addStatusDrag');

    const pairs = [];
    $$('#dragPairList .drag-pair-row').forEach(row => {
      const left  = row.querySelector('.drag-left')?.value.trim()  || '';
      const right = row.querySelector('.drag-right')?.value.trim() || '';
      if (left && right) pairs.push([left, right]);
    });

    if (!title || pairs.length < 2) {
      if (status) status.textContent = 'Fyll i titel och minst 2 giltiga par.';
      return;
    }

    const newQ = {
      id:   'dd_' + Date.now(),
      type: 'dragdrop',
      level,
      title,
      pairs,
      linkedCriteria: [...linked]
    };

    const s = load();
    if (!s.bank.dragdrop) s.bank.dragdrop = [];
    s.bank.dragdrop.push(newQ);

    if (save(s)) {
      if (status) status.textContent = `Drag & Drop tillagd (${level}).`;
      const titleEl = $('#dragTitle');
      const listEl  = $('#dragPairList');
      if (titleEl) titleEl.value = '';
      if (listEl) {
        listEl.innerHTML = '';
        addDragPairRow();
        addDragPairRow();
      }
      window.tempBuilderLinks.drag.links = [];
      const added = $('#dragAddedLinks');
      if (added) added.innerHTML = '';
      const objSel  = $('#dragObjectiveSelect');
      const critSel = $('#dragCriteriaSelect');
      if (objSel)  objSel.value = '';
      if (critSel) {
        critSel.value    = '';
        critSel.disabled = true;
      }
      renderDragAdminList();
    } else if (status) {
      status.textContent = 'Kunde inte spara.';
    }
  }

  async function handleRemoveItem(event) {
    const button = event.target.closest('button[data-list][data-idx]');
    if (!button) return;

    const listType = button.dataset.list;
    const index    = parseInt(button.dataset.idx, 10);
    const level    = button.dataset.level;

    if (isNaN(index)) return;
    if (!confirm('√Ñr du s√§ker p√• att du vill ta bort denna fr√•ga?')) return;

    const s = load();
    let itemToRemove = null;

    try {
      if (listType === 'mcq' && level) {
        const bankKey = `mcq${level}`;
        if (s.bank[bankKey]?.[index]) {
          itemToRemove = s.bank[bankKey].splice(index, 1)[0];
        }
      } else if (listType === 'image') {
        if (s.bank.images?.[index]) {
          itemToRemove = s.bank.images.splice(index, 1)[0];
          if (itemToRemove?.imgRef) {
            try { await idbDel(itemToRemove.imgRef); } catch {}
          }
        }
      } else if (listType === 'drag') {
        if (s.bank.dragdrop?.[index]) {
          itemToRemove = s.bank.dragdrop.splice(index, 1)[0];
        }
      }

      if (itemToRemove && save(s)) {
        notify('Fr√•ga borttagen.');
        if (listType === 'mcq')      renderMCQAdminLists();
        else if (listType === 'image') renderImageAdminList();
        else if (listType === 'drag')  renderDragAdminList();
        updateStorageInfo();
      } else {
        notify('Kunde inte ta bort fr√•gan.');
      }
    } catch (e) {
      console.error('Remove item fail:', e);
      notify('Fel vid borttagning.');
    }
  }

  /* === Importera text-MCQ === */
  function importMCQ(level) {
    const textareaId = `#mcqText${level}`;
    const statusId   = `#statusMCQ${level}`;

    const ta     = $(textareaId);
    const status = $(statusId);
    if (!ta || !status) return;

    const text = ta.value.trim();
    if (!text) {
      status.textContent = 'Textf√§ltet √§r tomt.';
      return;
    }

    const linked    = window.tempImportLinks?.[level]?.links || [];
    const lines     = text.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'));
    const questions = [];
    let currentQ    = null;

    lines.forEach(line => {
      if (line.endsWith('?')) {
        if (currentQ && currentQ.options.length > 0) {
          questions.push(currentQ);
        }
        currentQ = {
          id:   `mcq_${level}_${Date.now()}_${questions.length}`,
          type: 'mcq',
          level,
          q: line,
          options: [],
          answer: -1,
          linkedCriteria: [...linked]
        };
      } else if (currentQ) {
        let optionText = line;
        let isCorrect  = false;
        if (line.startsWith('*')) {
          isCorrect  = true;
          optionText = line.substring(1).trim();
        }
        if (optionText) {
          currentQ.options.push(optionText);
          if (isCorrect) currentQ.answer = currentQ.options.length - 1;
        }
      }
    });

    if (currentQ && currentQ.options.length > 0) {
      questions.push(currentQ);
    }

    const valid = questions.filter(q => q.q && q.options.length >= 2 && q.answer !== -1);
    const invalidCount = questions.length - valid.length;

    if (valid.length === 0) {
      status.textContent = 'Inga giltiga fr√•gor hittades i texten.';
      return;
    }

    const s       = load();
    const bankKey = `mcq${level}`;
    if (!s.bank[bankKey]) s.bank[bankKey] = [];
    s.bank[bankKey].push(...valid);

    if (save(s)) {
      let msg = `${valid.length} fr√•gor importerade (${level}).`;
      if (invalidCount > 0) msg += ` ${invalidCount} ogiltiga ignorerades.`;
      status.textContent = msg;
      ta.value = '';

      window.tempImportLinks[level].links = [];
      const added  = $(`#mcqImportAddedLinks${level}`);
      const objSel = $(`#mcqImportObjectiveSelect${level}`);
      const cs     = $(`#mcqImportCriteriaSelect${level}`);
      if (added)  added.innerHTML = '';
      if (objSel) objSel.value    = '';
      if (cs) {
        cs.value    = '';
        cs.disabled = true;
      }
      renderMCQAdminLists();
    } else {
      status.textContent = 'Kunde inte spara fr√•gorna.';
    }
  }

  /* === Diverse Admin-funktioner === */
  function updateStorageInfo() {
    const s = load();
    const mcqE = s.bank.mcqE?.length     || 0;
    const mcqC = s.bank.mcqC?.length     || 0;
    const mcqA = s.bank.mcqA?.length     || 0;
    const img  = s.bank.images?.length   || 0;
    const drag = s.bank.dragdrop?.length || 0;
    const obj  = s.objectives?.length    || 0;

    const el = $('#storageInfo');
    if (el) el.textContent =
      `Status: ${mcqE} MCQ(E), ${mcqC} MCQ(C), ${mcqA} MCQ(A), ` +
      `${img} Bild, ${drag} D&D, ${obj} Delm√•l.`;
  }

  async function shrinkAllImages() {
    if (!confirm('Vill du komprimera om alla bilder till "Liten" storlek?')) return;
    notify('Komprimerar...');

    const s = load();
    let changed = 0;

    try {
      for (const q of s.bank.images || []) {
        if (!q?.imgRef) continue;
        const blob = await idbGet(q.imgRef);
        if (blob instanceof Blob) {
          const newBlob = await recompressBlob(blob, 900, 0.7);
          await idbPut(q.imgRef, newBlob);
          changed++;
        }
      }
      notify(`Komprimering klar. ${changed} bilder uppdaterade.`);
      renderImageAdminList();
    } catch (e) {
      console.error('Shrink fail:', e);
      notify('Fel vid komprimering.');
    }
  }

  async function purgeImages() {
    if (!confirm('VARNING: Detta tar bort ALLA bildfr√•gor och bilder permanent. S√§ker?')) return;
    notify('Tar bort bilder...');

    const s = load();
    try {
      await idbClearStore();
      s.bank.images = [];
      if (save(s)) {
        notify('Alla bildfr√•gor och bilder borttagna.');
        renderImageAdminList();
        updateStorageInfo();
      }
    } catch (e) {
      console.error('Purge fail:', e);
      notify('Kunde inte ta bort bilder.');
    }
  }

  function resetStudentData() {
    if (!confirm('Nollst√§ll ALL elevdata (namn, klass, resultat, uppl√•sningar)?')) return;
    const s = load();
    s.student  = { ...DEFAULT.student };
    s.best     = { ...DEFAULT.best };
    s.unlocked = { ...DEFAULT.unlocked };
    if (save(s)) {
      notify('Elevdata nollst√§lld.');
      uiSync();
    }
  }

  async function fullReset() {
    if (!confirm('VARNING: Detta nollst√§ller HELA spelet (alla fr√•gor, bilder, inst√§llningar, elevdata) utom l√∂senord och e-post. √ÑR DU HELT S√ÑKER?')) {
      return;
    }

    try {
      await idbClearStore();
      const currentPw    = load().teacherPassword;
      const currentEmail = load().teacherEmail;
      safeRemove(KEY);
      const newState = load();
      newState.teacherPassword = currentPw;
      newState.teacherEmail    = currentEmail;
      save(newState);
      notify('Hela spelet har nollst√§llts (utom l√∂senord/epost). Sidan laddas om.');
      setTimeout(() => window.location.reload(), 1500);
    } catch (e) {
      console.error('Full reset fail:', e);
      notify('Kunde inte nollst√§lla helt.');
    }
  }

  function importStudentResult() {
    const dataEl   = $('#importData');
    const statusEl = $('#importStatus');
    if (!dataEl || !statusEl) return;

    try {
      const data = JSON.parse(dataEl.value);
      if (!data || typeof data !== 'object' ||
          !data.studentName || !data.levelCompleted ||
          typeof data.scorePercent !== 'number') {
        throw new Error('Ogiltigt format.');
      }

      const s = load();
      s.student.name  = data.studentName;
      s.student.klass = data.studentClass || '';

      if (data.levelCompleted === 'levelE') {
        s.best.levelE = Math.max(s.best.levelE || 0, data.scorePercent);
      } else if (data.levelCompleted === 'levelC') {
        s.best.levelC = Math.max(s.best.levelC || 0, data.scorePercent);
      } else if (data.levelCompleted === 'levelA') {
        s.best.levelA = Math.max(s.best.levelA || 0, data.scorePercent);
      }

      if (data.passed) {
        if (data.levelCompleted === 'levelE') s.unlocked.levelC = true;
        if (data.levelCompleted === 'levelC') s.unlocked.levelA = true;
      }

      if (save(s)) {
        statusEl.textContent =
          `Importerat: ${data.studentName} (${data.levelCompleted}, ${data.scorePercent}%)`;
        dataEl.value = '';
        uiSync();
      } else {
        statusEl.textContent = 'Kunde inte spara importerad data.';
      }
    } catch (e) {
      console.error('Import error:', e);
      statusEl.textContent = `Fel: ${e.message}`;
    }
  }

  /* === Firebase moln-spara / ladda ‚Äì helpers i huvudscript === */
  function getFirebaseHandles() {
    const fv = window.fvFirebase;
    if (!fv || !fv.auth || !fv.db) return null;
    return fv;
  }

  function updateCloudUI(user, note) {
    const el        = document.getElementById('cloudStatus');
    const btnLogin  = document.getElementById('btnCloudLogin');
    const btnLogout = document.getElementById('btnCloudLogout');
    const btnSave   = document.getElementById('btnCloudSave');
    const btnLoad   = document.getElementById('btnCloudLoad');

    const hasFirebase = !!getFirebaseHandles();
    if (!el) return;

    if (!hasFirebase) {
      el.textContent = 'Moln: inte aktiverat i denna version.';
      [btnLogin, btnLogout, btnSave, btnLoad].forEach(b => {
        if (b) b.disabled = true;
      });
      return;
    }

    if (user) {
      const who = user.email || user.displayName || user.uid;
      el.textContent = 'Moln: inloggad som ' + who + (note ? ' ‚Äì ' + note : '');
      if (btnLogin)  btnLogin.disabled  = true;
      if (btnLogout) btnLogout.disabled = false;
      if (btnSave)   btnSave.disabled   = false;
      if (btnLoad)   btnLoad.disabled   = false;
    } else {
      el.textContent = 'Moln: ej inloggad.' + (note ? ' ' + note : '');
      if (btnLogin)  btnLogin.disabled  = false;
      if (btnLogout) btnLogout.disabled = true;
      if (btnSave)   btnSave.disabled   = true;
      if (btnLoad)   btnLoad.disabled   = true;
    }
  }

  async function ensureTeacherLogin() {
    const fv = getFirebaseHandles();
    if (!fv) {
      notify('Molnlagring √§r inte aktiverad i denna version.');
      return null;
    }

    const { auth, provider, signInWithPopup } = fv;

    let user = auth.currentUser;
    if (user) return user;

    try {
      const res = await signInWithPopup(auth, provider);
      user = res.user;
      updateCloudUI(user);
      return user;
    } catch (e) {
      console.error('Login fail:', e);
      notify('Kunde inte logga in.');
      updateCloudUI(null, 'fel vid inloggning.');
      return null;
    }
  }

  async function cloudSaveGame() {
    const fv = getFirebaseHandles();
    if (!fv) {
      notify('Molnlagring √§r inte aktiverad.');
      return;
    }

    const user = await ensureTeacherLogin();
    if (!user) return;

    const { db, doc, setDoc } = fv;
    const s = load();

    const payload = {
      bank:       s.bank       || {},
      objectives: s.objectives || [],
      thresholds: s.thresholds || DEFAULT.thresholds,
      updatedAt:  new Date().toISOString()
    };

    try {
      await setDoc(doc(db, 'fangvaktarenGames', user.uid), payload, { merge: true });
      updateCloudUI(user, 'senast sparad nu.');
      notify('Fr√•gebank och delm√•l sparade i molnet.');
    } catch (e) {
      console.error('Cloud save fail:', e);
      notify('Kunde inte spara till molnet.');
      updateCloudUI(user, 'fel vid sparande.');
    }
  }

  async function cloudLoadGame() {
    const fv = getFirebaseHandles();
    if (!fv) {
      notify('Molnlagring √§r inte aktiverad.');
      return;
    }

    const user = await ensureTeacherLogin();
    if (!user) return;

    const { db, doc, getDoc } = fv;

    try {
      const snap = await getDoc(doc(db, 'fangvaktarenGames', user.uid));
      if (!snap.exists()) {
        notify('Ingen sparad data hittades i molnet.');
        updateCloudUI(user, 'ingen sparad data.');
        return;
      }

      const data = snap.data() || {};
      const s    = load();

      if (data.bank)       s.bank       = data.bank;
      if (data.objectives) s.objectives = data.objectives;
      if (data.thresholds) s.thresholds = data.thresholds;

      save(s);
      renderObjectives();
      updateObjectiveSelects();
      renderMCQAdminLists();
      renderImageAdminList();
      renderDragAdminList();
      uiSync();
      updateStorageInfo();
      updateCloudUI(user, 'data h√§mtad.');
      notify('Fr√•gebank och delm√•l h√§mtade fr√•n molnet.');
    } catch (e) {
      console.error('Cloud load fail:', e);
      notify('Kunde inte h√§mta fr√•n molnet.');
      updateCloudUI(user, 'fel vid h√§mtning.');
    }
  }

  async function cloudLogout() {
    const fv = getFirebaseHandles();
    if (!fv) {
      updateCloudUI(null);
      return;
    }
    try {
      await fv.signOut(fv.auth);
    } catch (e) {
      console.error('Logout fail:', e);
    }
    updateCloudUI(null, 'utloggad.');
  }

  /* === Initiering === */
  document.addEventListener('DOMContentLoaded', async () => {
    await unpackEmbeddedData();

    uiSync();

    // Spara elev
    const saveStudentBtn = $('#saveStudent');
    if (saveStudentBtn) {
      saveStudentBtn.addEventListener('click', () => {
        const s = load();
        s.student.name  = $('#studentName')?.value.trim()  || '';
        s.student.klass = $('#studentClass')?.value.trim() || '';
        if (save(s)) uiSync(); else notify('Kunde inte spara elev.');
      });
    }

    // Startknappar
    $('#start-levelE')?.addEventListener('click', () => startMode('levelE'));
    $('#start-levelC')?.addEventListener('click', () => startMode('levelC'));
    $('#start-levelA')?.addEventListener('click', () => startMode('levelA'));

    // Spelknappar
    $('#btnSubmit')?.addEventListener('click', finish);
    $('#btnCancel')?.addEventListener('click', hidePlayUI);
    $('#btnSubmitBottom')?.addEventListener('click', finish);
    $('#btnCancelBottom')?.addEventListener('click', hidePlayUI);

    $('#btnBack')?.addEventListener('click', () => {
      const result  = $('#result');
      const student = $('#studentCard');
      if (result)  result.classList.add('hidden');
      if (student) student.classList.remove('hidden');
      uiSync();
    });

    // Resultatexport
    $('#prepareSubmitBtn')?.addEventListener('click', () => {
      if (!submissionData) return;
      const jsonArea = $('#resultJson');
      const exportEl = $('#exportSection');
      const normal   = $('#resultActionsNormal');
      if (jsonArea) jsonArea.value = JSON.stringify(submissionData, null, 2);
      if (exportEl) exportEl.classList.remove('hidden');
      if (normal)   normal.classList.add('hidden');
    });

    $('#copyJsonBtn')?.addEventListener('click', () => {
      const jsonArea = $('#resultJson');
      if (!jsonArea) return;
      navigator.clipboard.writeText(jsonArea.value)
        .then(() => notify('Resultat kopierat!'))
        .catch(() => notify('Kunde inte kopiera.'));
    });

    $('#emailJsonBtn')?.addEventListener('click', () => {
      const teacherEmail = load().teacherEmail;
      if (!teacherEmail) {
        notify('L√§rarens e-post √§r inte inst√§lld.');
        return;
      }
      const subj = `Resultat F√•ngvaktaren: ${submissionData?.studentName || '?'} (${submissionData?.levelCompleted || '?'})`;
      const body =
        `Resultatdata:\n\n${$('#resultJson')?.value || ''}\n\n---\n` +
        `Klistra in detta i l√§rarens F√•ngvaktaren-verktyg under ` +
        `Inst√§llningar -> Importera Elevresultat.`;
      window.location.href =
        `mailto:${teacherEmail}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
    });

    $('#backToOverviewBtnExport')?.addEventListener('click', () => {
      const exportEl = $('#exportSection');
      const normal   = $('#resultActionsNormal');
      if (exportEl) exportEl.classList.add('hidden');
      if (normal)   normal.classList.remove('hidden');
    });

    // L√§rarl√§ge
    $('#btnTeacher')?.addEventListener('click', () => {
      postLoginAction = 'openAdmin';
      $('#gate')?.classList.add('show');
    });

    $('#btnDownloadGame')?.addEventListener('click', () => {
      postLoginAction = 'downloadGame';
      $('#gate')?.classList.add('show');
    });

    $('#gateOk')?.addEventListener('click', checkGate);
    $('#gateCancel')?.addEventListener('click', () => {
      postLoginAction = null;
      $('#gate')?.classList.remove('show');
    });

    $('#closeModal')?.addEventListener('click', () => {
      $('#modal')?.classList.remove('show');
    });

    // Admin-knappar
    $('#savePass')?.addEventListener('click', () => {
      const np = $('#newPass')?.value || '';
      if (np.length < 4) {
        notify('L√∂senordet m√•ste vara minst 4 tecken.');
        return;
      }
      const s = load();
      s.teacherPassword = np;
      if (save(s)) {
        notify('L√∂senord sparat.');
        openAdmin();
      }
    });

    $('#saveEmail')?.addEventListener('click', () => {
      const em = $('#teacherEmail')?.value.trim() || '';
      const s  = load();
      s.teacherEmail = em;
      if (save(s)) notify('E-post sparad.');
    });

    $('#saveThresholds')?.addEventListener('click', () => {
      const s = load();
      s.thresholds.levelE = clampNum($('#thr-levelE')?.value, 0, 100, DEFAULT.thresholds.levelE);
      s.thresholds.levelC = clampNum($('#thr-levelC')?.value, 0, 100, DEFAULT.thresholds.levelC);
      s.thresholds.levelA = clampNum($('#thr-levelA')?.value, 0, 100, DEFAULT.thresholds.levelA);
      if (save(s)) {
        notify('Gr√§nser sparade.');
        openAdmin();
        uiSync();
      }
    });

    $('#addObjectiveBtn')?.addEventListener('click', () => {
      const s = load();
      s.objectives.push({
        name: '',
        criteria: ['', '', '', '', '']
      });
      save(s);
      renderObjectives();
      updateObjectiveSelects();
    });

    $('#objectivesListContainer')?.addEventListener('click', (e) => {
      if (!e.target.classList.contains('remove-objective-btn')) return;
      const idx = parseInt(e.target.dataset.idx, 10);
      if (isNaN(idx)) return;
      if (!confirm(`Ta bort Delm√•l ${idx + 1}?`)) return;
      const s = load();
      s.objectives.splice(idx, 1);
      save(s);
      renderObjectives();
      updateObjectiveSelects();
    });

    $('#saveObjectives')?.addEventListener('click', () => {
      const s = load();
      const newObjectives = [];
      $$('#objectivesListContainer .objective-group').forEach(group => {
        const name = group.querySelector('.obj-name')?.value.trim() || '';
        const criteria = [
          group.querySelector('.obj-crit0')?.value.trim() || '',
          group.querySelector('.obj-crit1')?.value.trim() || '',
          group.querySelector('.obj-crit2')?.value.trim() || '',
          group.querySelector('.obj-crit3')?.value.trim() || '',
          group.querySelector('.obj-crit4')?.value.trim() || ''
        ];
        newObjectives.push({ name, criteria });
      });
      s.objectives = newObjectives;
      if (save(s)) {
        notify('Delm√•l sparade.');
        renderObjectives();
        updateObjectiveSelects();
      }
    });

    // √ñvriga adminknappar
    $('#btnImportResult')?.addEventListener('click', importStudentResult);
    $('#btnShrinkAll')?.addEventListener('click', shrinkAllImages);
    $('#btnPurgeImg')?.addEventListener('click', purgeImages);
    $('#btnResetTeacher')?.addEventListener('click', resetStudentData);
    $('#btnFullReset')?.addEventListener('click', fullReset);

    // Flervals / Bild / Drag builder-lyssnare
    $('#btnImportMCQE')?.addEventListener('click', () => importMCQ('E'));
    $('#btnImportMCQC')?.addEventListener('click', () => importMCQ('C'));
    $('#btnImportMCQA')?.addEventListener('click', () => importMCQ('A'));

    $('#btnAddMcqOpt')?.addEventListener('click', () => addOptionRow('#mcqOptList'));
    $('#mcqOptList')?.addEventListener('click', handleRemoveOption);
    $('#btnAddMCQ')?.addEventListener('click', addManualMCQ);

    $('#btnAddOpt')?.addEventListener('click', () => addOptionRow('#optList'));
    $('#optList')?.addEventListener('click', handleRemoveOption);
    $('#qImgFile')?.addEventListener('change', previewImage);
    $('#btnAddImageMCQ')?.addEventListener('click', addManualImageMCQ);

    $('#btnAddDragPair')?.addEventListener('click', () => addDragPairRow());
    $('#dragPairList')?.addEventListener('click', handleRemoveDragPair);
    $('#btnAddDragDrop')?.addEventListener('click', addManualDragDrop);

    $$('#mcqListE, #mcqListC, #mcqListA, #imgList, #dragList')
      .forEach(list => list?.addEventListener('click', handleRemoveItem));

    // Dropdowns f√∂r delm√•lskoppling (manuell + import)
    let mcqLinks  = { links: [] };
    let imageLinks= { links: [] };
    let dragLinks = { links: [] };

    setupObjectiveDropdowns('#mcqObjectiveSelect', '#mcqCriteriaSelect', '#mcqAddLinkBtn', '#mcqAddedLinks', mcqLinks);
    setupObjectiveDropdowns('#imageObjectiveSelect', '#imageCriteriaSelect', '#imageAddLinkBtn', '#imageAddedLinks', imageLinks);
    setupObjectiveDropdowns('#dragObjectiveSelect',  '#dragCriteriaSelect',  '#dragAddLinkBtn',  '#dragAddedLinks',  dragLinks);

    window.tempBuilderLinks = {
      mcq:   mcqLinks,
      image: imageLinks,
      drag:  dragLinks
    };

    let mcqImportLinksE = { links: [] };
    let mcqImportLinksC = { links: [] };
    let mcqImportLinksA = { links: [] };

    setupObjectiveDropdowns('#mcqImportObjectiveSelectE', '#mcqImportCriteriaSelectE', '#mcqImportAddLinkBtnE', '#mcqImportAddedLinksE', mcqImportLinksE);
    setupObjectiveDropdowns('#mcqImportObjectiveSelectC', '#mcqImportCriteriaSelectC', '#mcqImportAddLinkBtnC', '#mcqImportAddedLinksC', mcqImportLinksC);
    setupObjectiveDropdowns('#mcqImportObjectiveSelectA', '#mcqImportCriteriaSelectA', '#mcqImportAddLinkBtnA', '#mcqImportAddedLinksA', mcqImportLinksA);

    window.tempImportLinks = {
      E: mcqImportLinksE,
      C: mcqImportLinksC,
      A: mcqImportLinksA
    };
  });

  // === G√∂r rutor i Inst√§llningar (password, e-post, gr√§nser, delm√•l, import, lagring) ===
  (function groupSettingsSections() {
    const root = document.getElementById('tab-settings');
    if (!root) return;

    const parts = [];
    let current = [];

    Array.from(root.children).forEach(node => {
      if (node.classList && node.classList.contains('hr')) {
        if (current.length) {
          parts.push(current);
          current = [];
        }
      } else {
        current.push(node);
      }
    });
    if (current.length) parts.push(current);

    parts.forEach(nodes => {
      const card = document.createElement('div');
      card.className = 'settings-card';
      nodes[0].before(card);
      nodes.forEach(n => card.appendChild(n));
    });

    const importLabel = root.querySelector('label[for="importData"]');
    if (importLabel) {
      const row = importLabel.closest('.row');
      if (row) row.classList.add('import-wrap');
    }
  })();
  </script>

  <!-- start: Firebase init f√∂r F√•ngvaktaren -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

    // Din Firebase-konfiguration
    const firebaseConfig = {
      apiKey: 'AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8',
      authDomain: 'fangvaktaren-904db.firebaseapp.com',
      projectId: 'fangvaktaren-904db',
      storageBucket: 'fangvaktaren-904db.firebasestorage.app',
      messagingSenderId: '105301219768',
      appId: '1:105301219768:web:66b131fba86a541b78174d',
      measurementId: 'G-NXL9GSFZ77'
    };

    // Initiera Firebase
    const app      = initializeApp(firebaseConfig);
    const auth     = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db       = getFirestore(app);

    // G√∂r Firebase tillg√§ngligt f√∂r spelet
    window.fvFirebase = {
      auth,
      provider,
      signInWithPopup,
      onAuthStateChanged,
      signOut,
      db,
      doc,
      getDoc,
      setDoc
    };

    // Hj√§lpare f√∂r att kalla huvudscriptets updateCloudUI s√§kert
    function safeCloudUI(user, note) {
      if (typeof window.updateCloudUI === 'function') {
        window.updateCloudUI(user, note);
      } else {
        console.warn('updateCloudUI √§r √§nnu inte definierad.');
      }
    }

    // Koppla knappar
    const btnCloudLogin  = document.getElementById('btnCloudLogin');
    const btnCloudLogout = document.getElementById('btnCloudLogout');
    const btnCloudSave   = document.getElementById('btnCloudSave');
    const btnCloudLoad   = document.getElementById('btnCloudLoad');

    if (btnCloudLogin) {
      btnCloudLogin.addEventListener('click', () => {
        if (typeof window.ensureTeacherLogin === 'function') {
          window.ensureTeacherLogin();
        } else {
          // fallback: direkt anv√§nd Firebase inloggning
          signInWithPopup(auth, provider)
            .then(res => safeCloudUI(res.user, 'inloggad.'))
            .catch(e => {
              console.error('Login fail:', e);
              safeCloudUI(null, 'fel vid inloggning.');
            });
        }
      });
    }

    if (btnCloudLogout) {
      btnCloudLogout.addEventListener('click', () => {
        signOut(auth)
          .then(() => safeCloudUI(null, 'utloggad.'))
          .catch(e => {
            console.error('Logout fail:', e);
            safeCloudUI(null, 'fel vid utloggning.');
          });
      });
    }

    if (btnCloudSave) {
      btnCloudSave.addEventListener('click', () => {
        if (typeof window.cloudSaveGame === 'function') {
          window.cloudSaveGame();
        } else {
          safeCloudUI(auth.currentUser, 'kan inte spara ‚Äì funktion saknas.');
        }
      });
    }

    if (btnCloudLoad) {
      btnCloudLoad.addEventListener('click', () => {
        if (typeof window.cloudLoadGame === 'function') {
          window.cloudLoadGame();
        } else {
          safeCloudUI(auth.currentUser, 'kan inte ladda ‚Äì funktion saknas.');
        }
      });
    }

    // H√•ll koll p√• auth-state
    onAuthStateChanged(auth, user => {
      safeCloudUI(user);
    });

    // Initstatus
    safeCloudUI(auth.currentUser);
  </script>
  <!-- slut: Firebase init -->

</body>
</html>
<!-- slut DEL 3/3 -->
