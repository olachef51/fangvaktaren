<!-- start SEKTION 1: HEAD & STIL --> 
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>F√•ngvaktaren ‚Äì Progressionsspel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --accent-e:#b45309;
      --accent-c:#2563eb;
      --accent-a:#7c3aed;
      --accent-danger:#ef4444;
      --accent-info:#38bdf8;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --chip:#020617;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#0b1120 0,#020617 60%,#020617 100%);
      color:var(--text);
    }
    body{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:960px;
      background:rgba(15,23,42,0.96);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 18px 45px rgba(0,0,0,0.7);
      padding:18px 18px 22px;
      position:relative;
      overflow:hidden;
    }
    .app::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0 0,rgba(180,83,9,0.18),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(37,99,235,0.20),transparent 55%),
        radial-gradient(circle at 50% 100%,rgba(124,58,237,0.18),transparent 60%);
      opacity:0.9;
      pointer-events:none;
      z-index:-1;
    }

    .goal-tag{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:var(--card,#020617);
      color:var(--text,#e5e7eb);
      border:1px solid var(--border,#1f2937);
      font-size:0.75rem;
      margin:1px 3px 0 0;
      white-space:normal;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      background:var(--card,#020617);
      color:var(--text,#e5e7eb);
      border:1px solid var(--border,#1f2937);
      font-size:0.75rem;
      margin:2px 4px 0 0;
      cursor:pointer;
      white-space:nowrap;
    }

    .chip:hover{
      background:#111827;
    }

    .goal-tag.goal-tag-none{
      opacity:0.7;
      font-style:italic;
    }

    .app-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .title-block h1{
      margin:0;
      font-size:1.4rem;
      letter-spacing:0.04em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .title-block h1 span.logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:26px;
      height:26px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0,var(--accent-e),#92400e);
      box-shadow:0 0 18px rgba(180,83,9,0.6);
      font-size:1.1rem;
    }
    .subtitle{
      margin:4px 0 0;
      font-size:0.82rem;
      color:var(--muted);
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      color:var(--text);
      font-size:0.8rem;
      padding:6px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      line-height:1.3;
      white-space:nowrap;
    }
    .btn:hover{
      border-color:var(--accent-info);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .btn-primary{
      border-color:var(--accent-info);
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#0b1120;
      font-weight:600;
    }
    .btn-danger{
      border-color:var(--accent-danger);
      color:#fecaca;
    }
    .btn-sm{padding:4px 9px;font-size:0.75rem;}

    .student-card{
      margin-bottom:16px;
      padding:12px 12px 10px;
      border-radius:14px;
      background:radial-gradient(circle at 0 0,#111827,#020617);
      border:1px solid rgba(148,163,184,0.35);
    }
    .student-card .row{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:6px;
    }
    .student-card label{
      font-size:0.78rem;
      color:var(--muted);
      display:block;
      margin-bottom:2px;
    }
    .student-card .field{
      flex:1 1 auto;
      min-width:0;
    }
    .input{
      width:100%;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.82rem;
    }
    .input:focus{
      outline:none;
      border-color:var(--accent-info);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .student-status{
      font-size:0.78rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:2px;
      flex-wrap:wrap;
    }

    .levels-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      margin-bottom:16px;
      transition:opacity 0.15s ease;
    }
    @media (max-width:780px){
      .levels-grid{
        grid-template-columns:1fr;
      }
      .app-header{
        flex-direction:column;
        align-items:flex-start;
      }
    }
    .level-card{
      border-radius:14px;
      padding:11px 11px 10px;
      background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(15,23,42,0.96));
      border:1px solid rgba(31,41,55,0.9);
      position:relative;
      overflow:hidden;
      transform:translateY(0);
      transition:transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }
    .level-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      opacity:0.7;
      pointer-events:none;
      z-index:-1;
    }
    .level-card:hover{
      transform:translateY(-2px);
      box-shadow:0 0 18px rgba(15,23,42,0.9);
    }
    .level-card.level-e{
      border-color:rgba(180,83,9,0.8);
      background:radial-gradient(circle at 0 0,rgba(180,83,9,0.35),rgba(15,23,42,0.96));
      box-shadow:0 0 18px rgba(180,83,9,0.35);
    }
    .level-card.level-c{
      border-color:rgba(37,99,235,0.9);
      background:radial-gradient(circle at 0 0,rgba(37,99,235,0.40),rgba(15,23,42,0.96));
      box-shadow:0 0 18px rgba(37,99,235,0.45);
    }
    .level-card.level-a{
      border-color:rgba(124,58,237,0.9);
      background:radial-gradient(circle at 0 0,rgba(124,58,237,0.45),rgba(15,23,42,0.96));
      box-shadow:0 0 18px rgba(124,58,237,0.55);
    }
    .level-e::before{
      background:radial-gradient(circle at 0 0,rgba(180,83,9,0.45),transparent 60%);
    }
    .level-c::before{
      background:radial-gradient(circle at 0 0,rgba(37,99,235,0.50),transparent 60%);
    }
    .level-a::before{
      background:radial-gradient(circle at 0 0,rgba(124,58,237,0.55),transparent 60%);
    }
    .level-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:4px;
      margin-bottom:4px;
    }
    .level-title{
      font-size:0.9rem;
      font-weight:600;
      display:flex;
      flex-direction:column;
      gap:0;
    }
    .level-title small{
      font-size:0.72rem;
      color:var(--muted);
      font-weight:400;
    }
    .badge{
      font-size:0.7rem;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.9);
      white-space:nowrap;
    }
    .badge-ok{
      border-color:var(--accent-e);
      color:#fed7aa;
      background:rgba(180,83,9,0.35);
      box-shadow:0 0 10px rgba(180,83,9,0.5);
    }
    .badge-warn{
      border-color:var(--accent-c);
      color:#bfdbfe;
      background:rgba(37,99,235,0.25);
    }
    .badge-lock{
      border-color:var(--accent-danger);
      color:#fecaca;
      background:rgba(248,113,113,0.18);
    }
    .level-body{
      font-size:0.78rem;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:6px;
    }
    .level-body strong{color:var(--text);}
    .level-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .level-footer .hint{
      font-size:0.7rem;
      color:var(--muted);
    }
    .level-card.locked{
      opacity:0.55;
      box-shadow:none;
    }

    .play-panel{
      margin-top:6px;
      padding:10px 10px 10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.8);
      background:radial-gradient(circle at 0 0,#020617,#020617);
    }
    .play-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .play-header h2{
      margin:0;
      font-size:0.98rem;
    }
    .play-header small{
      font-size:0.74rem;
      color:var(--muted);
    }
    .questions{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:360px;
      overflow-y:auto;
      padding-right:4px;
      margin-bottom:6px;
    }
    .question{
      border-radius:10px;
      border:1px solid rgba(55,65,81,0.9);
      padding:8px 9px 7px;
      background:#020617;
      font-size:0.8rem;
    }
    .question > div:first-child{
      margin-bottom:4px;
    }
    .question img{
      max-width:100%;
      max-height:200px;
      border-radius:10px;
      display:block;
      margin-bottom:6px;
    }
    .options-list{
      display:flex;
      flex-direction:column;
      gap:3px;
      margin-top:2px;
    }
    .option-label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.78rem;
      cursor:pointer;
    }
    .option-label input{
      accent-color:#38bdf8;
    }
    .mini{
      font-size:0.72rem;
      color:var(--muted);
    }

    .play-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .play-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .result-panel{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.8);
      background:radial-gradient(circle at 100% 0,#020617,#020617);
      font-size:0.82rem;
    }
    .result-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
      margin-bottom:6px;
    }
    .score{
      font-size:1.3rem;
      font-weight:700;
    }
    .score span{
      font-size:0.8rem;
      color:var(--muted);
      font-weight:400;
      margin-left:4px;
    }
    .badge-pass{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:8px 18px;
      font-size:0.9rem;
      font-weight:700;
      border:none;
      background:linear-gradient(135deg,#22c55e,#0ea5e9);
      color:#022c22;
      gap:6px;
      box-shadow:0 0 20px rgba(34,197,94,0.6);
      text-transform:uppercase;
      letter-spacing:0.03em;
      animation:badgePop 0.7s ease-out;
    }
    .badge-pass::before{
      content:"‚úÖ";
      font-size:1rem;
    }
    .badge-fail{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:4px 9px;
      font-size:0.76rem;
      border:1px solid var(--accent-danger);
      color:#fecaca;
      background:rgba(248,113,113,0.12);
      gap:4px;
    }
    .result-meta{
      font-size:0.76rem;
      color:var(--muted);
      margin-top:2px;
    }
    .result-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .gate-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .gate-box{
      width:100%;
      max-width:340px;
      background:#020617;
      border-radius:16px;
      border:1px solid rgba(75,85,99,0.9);
      padding:14px 14px 12px;
      box-shadow:0 18px 45px rgba(0,0,0,0.85);
      font-size:0.82rem;
    }
    .gate-box h2{
      margin:0 0 6px;
      font-size:1rem;
    }
    .gate-box p{
      margin:0 0 8px;
      color:var(--muted);
      font-size:0.78rem;
    }
    .gate-actions{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:8px;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.92);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal{
      width:100%;
      max-width:880px;
      max-height:90vh;
      background:#020617;
      border-radius:18px;
      border:1px solid rgba(75,85,99,0.9);
      box-shadow:0 24px 60px rgba(0,0,0,0.9);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      font-size:0.82rem;
    }
    .modal-header{
      padding:10px 12px 8px;
      border-bottom:1px solid #1f2937;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .modal-header h2{
      margin:0;
      font-size:0.98rem;
    }
    .modal-header small{
      font-size:0.76rem;
      color:var(--muted);
      display:block;
    }
    .modal-body{
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }
    .tab-nav{
      display:flex;
      gap:6px;
      padding:6px 8px;
      border-bottom:1px solid #1f2937;
      background:#020617;
      flex-wrap:wrap;
    }
    .tab-btn{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:#020617;
      color:var(--muted);
      padding:5px 6px;
      font-size:0.78rem;
      cursor:pointer;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tab-btn.active{
      color:#e5e7eb;
      border-color:#38bdf8;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,0.25),#020617);
    }
    .tab-content{
      flex:1;
      min-height:0;
      padding:9px 10px 10px;
      overflow-y:auto;
    }

    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
    }

    .card{
      border-radius:12px;
      border:1px solid rgba(55,65,81,0.9);
      padding:8px 9px 8px;
      background:#020617;
    }
    .card h3{
      margin:0 0 4px;
      font-size:0.86rem;
    }
    .card p{
      margin:0 0 6px;
      font-size:0.76rem;
      color:var(--muted);
    }
    .card-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
    }
    .card-row .field{
      flex:1 1 auto;
      min-width:0;
    }

    .small-label{
      font-size:0.74rem;
      color:var(--muted);
      display:block;
      margin-bottom:2px;
    }
    .input-number{
      width:100%;
      padding:5px 7px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.8rem;
    }

    .list{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:5px;
    }
    .list-item{
      border-radius:9px;
      border:1px solid #1f2937;
      background:#020617;
      padding:6px 7px 5px;
      display:flex;
      justify-content:space-between;
      gap:6px;
      font-size:0.78rem;
    }
    .list-main{
      flex:1;
      min-width:0;
    }
    .list-main .q-text{
      font-weight:600;
      margin-bottom:2px;
    }
    .list-main .q-meta{
      font-size:0.72rem;
      color:var(--muted);
    }
    .level-tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0 6px;
      border-radius:999px;
      font-size:0.7rem;
      margin-left:4px;
      border:1px solid rgba(148,163,184,0.6);
    }
    .level-tag.level-e{
      border-color:var(--accent-e);
      color:#fed7aa;
      background:rgba(180,83,9,0.18);
    }
    .level-tag.level-c{
      border-color:var(--accent-c);
      color:#bfdbfe;
      background:rgba(37,99,235,0.14);
    }
    .level-tag.level-a{
      border-color:var(--accent-a);
      color:#ddd6fe;
      background:rgba(124,58,237,0.18);
    }

    select{
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:0.78rem;
      padding:4px 7px;
    }

    .hidden{
      display:none;
    }

    .sub-tab-nav{
      display:flex;
      gap:6px;
      margin-bottom:6px;
    }
    .sub-tab-btn{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:#020617;
      color:var(--muted);
      padding:4px 6px;
      font-size:0.78rem;
      cursor:pointer;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub-tab-btn.active{
      color:#e5e7eb;
      border-color:#38bdf8;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,0.25),#020617);
    }
    .sub-tab-panel.hidden{
      display:none;
    }

    .textarea{
      width:100%;
      min-height:120px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.8rem;
      padding:6px 8px;
      resize:vertical;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .img-preview-box{
      border-radius:10px;
      border:1px dashed #1f2937;
      padding:6px 8px;
      min-height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Enkel layout f√∂r drag & drop-fr√•gor */
    .drag-wrapper{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:6px;
    }
    .drag-source{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      padding:6px;
      border-radius:8px;
      border:1px dashed #1f2937;
      min-height:38px;
    }
    .drag-columns{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .drag-column{
      flex:1 1 120px;
    }
    .drag-column-title{
      font-size:0.75rem;
      color:var(--muted);
      margin-bottom:2px;
    }
    .drag-dropzone{
      min-height:40px;
      border-radius:8px;
      border:1px dashed #1f2937;
      padding:6px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .drag-chip{
      cursor:grab;
      margin:2px;
    }

    @keyframes badgePop{
      0%{
        transform:scale(0.7);
        opacity:0;
        box-shadow:0 0 0 0 rgba(34,197,94,0.9);
      }
      60%{
        transform:scale(1.08);
        opacity:1;
        box-shadow:0 0 0 10px rgba(34,197,94,0);
      }
      100%{
        transform:scale(1);
        opacity:1;
        box-shadow:0 0 20px rgba(34,197,94,0.4);
      }
    }
  </style>
</head>
<!-- slut SEKTION 1: HEAD & STIL -->



<!-- start SEKTION 2: FIREBASE-BIBLIOTEK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<!-- slut SEKTION 2: FIREBASE-BIBLIOTEK -->


<!-- start SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->
<body>
  <style>
    /* D√∂lj gamla po√§ng-texten om progressionNotice finns */
    #progressionNotice {
      display: none !important;
    }

    /* Glittrande rutor f√∂r po√§ng & highscore ‚Äì nedtonat (ca halva styrkan) */
    .glow-box {
      border-radius: 18px;
      color: #fff;
      box-shadow:
        0 0 1px #fff,
        0 0 5px #fff,
        0 0 10px #0ba9ca,
        0 0 15px #0ba9ca,
        0 0 20px #0ba9ca,
        0 0 25px #0ba9ca;
      -webkit-animation: blink 0.7s infinite alternate;
      animation: blink 0.7s infinite alternate;
      position: relative;
    }
    @-webkit-keyframes blink {
      100% {
        box-shadow:
          0 0 1.5px #fff,
          0 0 5px #fff,
          0 0 10px #fff,
          0 0 20px #0ba9ca,
          0 0 35px #0ba9ca,
          0 0 40px #0ba9ca;
      }
    }
    @keyframes blink {
      100% {
        box-shadow:
          0 0 1.5px #fff,
          0 0 5px #fff,
          0 0 10px #fff,
          0 0 20px #0ba9ca,
          0 0 35px #0ba9ca,
          0 0 40px #0ba9ca;
      }
    }

    /* Kompakt huvudruta f√∂r elev + stats ‚Äì po√§ng & highscore direkt under spara-knappen */
    .student-card-main {
      margin: 6px 12px 8px;
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .student-main-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }
    .student-status-line {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-top: 2px;
    }
    .student-stats-row {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .student-stats-row .stat-box {
      flex: 1 1 160px;
    }
    @media (max-width: 720px) {
      .student-stats-row {
        flex-direction: column;
      }
    }

    /* Elevprogression ‚Äì 4 rutor layout */
    .progress-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 900px) {
      .progress-grid {
        grid-template-columns: 1fr;
      }
    }
    .progress-list {
      list-style: none;
      padding-left: 0;
      margin: 6px 0 0;
      max-height: 220px;
      overflow-y: auto;
      font-size: 0.85rem;
    }
    .progress-list li {
      margin-bottom: 4px;
    }
    .progress-json-area {
      width: 100%;
      min-height: 120px;
      max-height: 220px;
      resize: vertical;
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      border: 1px solid #1f2937;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      padding: 6px 8px;
    }
  </style>

  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <h1><span class="logo">F</span>F√•ngvaktaren</h1>
      </div>
      <button id="btnTeacherMode" class="btn btn-sm btn-primary">üîë L√§rarl√§ge</button>
    </header>

    <section id="studentCard" class="student-card student-card-main">
      <div class="student-main-row">
        <div class="field">
          <label for="studentName">Namn</label>
          <input
            id="studentName"
            class="input"
            placeholder="Elevens namn..."
            autocomplete="off"
          />
        </div>
        <div class="field">
          <label for="studentClass">Klass</label>
          <input
            id="studentClass"
            class="input"
            placeholder="Klass..."
            autocomplete="off"
          />
        </div>
        <div class="field" style="flex:0 0 140px;min-width:140px;">
          <label>&nbsp;</label>
          <button
            id="btnSaveStudent"
            class="btn btn-sm btn-primary"
            style="width:100%;"
          >
            üíæ Spara elev
          </button>
        </div>
      </div>

      <div class="student-status-line">
        <span id="studentSaved">Ej sparad elev</span>
      </div>

      <div class="student-stats-row">
        <div
          class="stat-box glow-box"
          style="
            padding:10px 18px;
            display:flex;
            flex-direction:column;
            align-items:center;
            text-align:center;
            background:
              radial-gradient(circle at 0% 0%, rgba(74,222,128,0.55), transparent 55%),
              radial-gradient(circle at 100% 100%, rgba(34,197,94,0.35), transparent 60%),
              linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.7));
          "
        >
          <span
            class="stat-label mini"
            style="text-transform:uppercase;letter-spacing:0.08em;opacity:0.9;font-size:0.7rem;"
          >
            ‚≠ê Po√§ng
          </span>
          <span
            id="studentPointsValue"
            class="stat-value"
            style="font-weight:800;font-size:1.8rem;line-height:1.1;margin-top:3px;"
          >
            0 p
          </span>
        </div>

        <div
          class="stat-box glow-box"
          style="
            padding:10px 18px;
            display:flex;
            flex-direction:column;
            align-items:center;
            text-align:center;
            background:
              radial-gradient(circle at 0% 0%, rgba(129,140,248,0.6), transparent 55%),
              radial-gradient(circle at 100% 100%, rgba(59,130,246,0.4), transparent 60%),
              linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.7));
          "
        >
          <span
            class="stat-label mini"
            style="text-transform:uppercase;letter-spacing:0.08em;opacity:0.9;font-size:0.7rem;"
          >
            üèÜ Highscore
          </span>
          <div
            id="studentHighscoreSummary"
            class="stat-value"
            style="font-weight:700;font-size:0.85rem;line-height:1.3;margin-top:4px;display:flex;flex-direction:column;gap:1px;"
          >
            <span id="hsTop1">Plats 1: ‚Äì</span>
            <span id="hsTop2">Plats 2: ‚Äì</span>
            <span id="hsTop3">Plats 3: ‚Äì</span>
            <span id="hsSelf">Din plats: ‚Äì</span>
          </div>
        </div>
      </div>
    </section>

    <section class="levels-grid">
      <article id="card-levelE" class="level-card level-e locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 1</span>
            <small>Grundniv√• ‚Äì E</small>
          </div>
          <span id="badge-levelE" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelE">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelE">70</span>%</span>
          <span class="mini">L√•ses upp n√§r eleven sparat namn & klass.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• E-niv√•.</div>
          <button id="start-levelE" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 1</button>
        </div>
      </article>

      <article id="card-levelC" class="level-card level-c locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 2</span>
            <small>Mellanniv√• ‚Äì C</small>
          </div>
          <span id="badge-levelC" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelC">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelC">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 1 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• C-niv√•.</div>
          <button id="start-levelC" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 2</button>
        </div>
      </article>

      <article id="card-levelA" class="level-card level-a locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 3</span>
            <small>Avancerad ‚Äì A</small>
          </div>
          <span id="badge-levelA" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelA">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelA">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 2 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• A-niv√•.</div>
          <button id="start-levelA" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 3</button>
        </div>
      </article>
    </section>

    <section id="play" class="play-panel hidden">
      <header class="play-header">
        <div>
          <h2 id="play-title">Aktiv niv√•</h2>
          <small id="whoPlays">Ingen elev vald.</small>
        </div>
        <button id="btnCancel" class="btn btn-sm">‚¨ÖÔ∏è Avsluta utan att l√§mna in</button>
      </header>
      <div id="questions" class="questions">
        <div class="question mini">V√§lj en niv√• f√∂r att b√∂rja.</div>
      </div>
      <footer class="play-footer">
        <div class="mini">Svar registreras n√§r du klickar i alternativen eller sl√§pper kort i r√§tt ruta.</div>
        <div class="play-actions">
          <button id="btnFinish" class="btn btn-sm btn-primary">‚úÖ L√§mna in niv√•</button>
        </div>
      </footer>
    </section>

    <section id="result" class="result-panel hidden">
      <header class="result-header">
        <div>
          <div class="score" id="scoreText">0%<span> resultat</span></div>
          <div id="scoreDetail" class="result-meta">0/0 po√§ng</div>
          <div class="result-meta">
            Elev: <span id="resName">-</span> (<span id="resClass">-</span>)
          </div>
        </div>
        <div>
          <div id="passBadge" class="badge-fail">Resultat</div>
          <div id="unlockText" class="result-meta"></div>
        </div>
      </header>

      <div class="result-actions" id="resultActionsNormal">
        <button id="btnBack" class="btn btn-sm">‚¨ÖÔ∏è Tillbaka till niv√•er</button>
        <button id="btnSubmitGame" class="btn btn-sm btn-primary">‚úâÔ∏è L√§mna in spel f√∂r po√§ng</button>
      </div>
    </section>
  </div>

  <script id="embedded-data" type="application/json">
  {
    "bank": {
      "mcq": [
        {
          "level": "E",
          "type": "mcq",
          "q": "Vad √§r viktigast f√∂rst n√§r du kommer till k√∂ket?",
          "options": ["Ta p√• f√∂rkl√§de", "Tv√§tta h√§nderna", "S√§tta p√• ugnen", "Smaka p√• maten"],
          "answer": 1
        },
        {
          "level": "C",
          "type": "mcq",
          "q": "En g√§st klagar p√• kall mat. Vad √§r ett bra f√∂rsta steg?",
          "options": ["Ignorera g√§sten", "Skylla p√• k√∂ket", "Be om urs√§kt och erbjuda l√∂sning", "S√§ga att det inte √§r ditt fel"],
          "answer": 2
        },
        {
          "level": "A",
          "type": "mcq",
          "q": "Du planerar en buff√©. Vad √§r viktigast f√∂r s√§ker livsmedelshantering?",
          "options": ["Att det ser fint ut", "Att alla r√§tter √§r varma samtidigt", "R√§tt temperaturer och tidsgr√§nser", "Att det finns m√•nga olika r√§tter"],
          "answer": 2
        }
      ]
    }
  }
  </script>

  <div id="teacherGate" class="gate-backdrop hidden">
    <div class="gate-box">
      <h2>üîë L√§rarl√§ge</h2>
      <p id="teacherGateText">
        Ange l√§rarl√∂senord. F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.
      </p>
      <input id="teacherPasswordInput" class="input" type="password" placeholder="L√∂senord..." />
      <div class="gate-actions">
        <button id="btnTeacherCancel" class="btn btn-sm">Avbryt</button>
        <button id="btnTeacherConfirm" class="btn btn-sm btn-primary">Forts√§tt</button>
      </div>
    </div>
  </div>

  <div id="teacherModal" class="modal-backdrop hidden">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h2>L√§rarl√§ge ‚Äì F√•ngvaktaren</h2>
          <small>Hantera inst√§llningar, fr√•gebank, bildfr√•gor, drag & drop, export och elevprogression.</small>
        </div>
        <button id="btnCloseTeacher" class="btn btn-sm">St√§ng</button>
      </header>
      <div class="modal-body">
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="settings" id="tab-settings">‚öôÔ∏è Inst√§llningar</button>
          <button class="tab-btn" data-tab="questions" id="tab-questions">üÖ∞Ô∏è Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="images" id="tab-images">üñºÔ∏è Bildfr√•gor</button>
          <button class="tab-btn" data-tab="dragdrop" id="tab-dragdrop">üéØ Drag & Drop</button>
          <button class="tab-btn" data-tab="progress" id="tab-progress">üìà Elevprogression</button>
          <button class="tab-btn" data-tab="bank" id="tab-bank">üóÇÔ∏è Fr√•gebank</button>
        </nav>
        <div class="tab-content">
          <section class="tab-panel" data-panel="settings">
            <div class="settings-grid">
              <div class="card">
                <h3>L√§rarl√∂senord</h3>
                <p>Det l√∂senord du anv√§nder f√∂r att √∂ppna l√§rarl√§get. H√§r kan du byta det.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputOldPassword">Nuvarande l√∂senord</label>
                    <input id="inputOldPassword" class="input" type="password" placeholder="L√§mna tomt om inget satt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPassword">Nytt l√∂senord</label>
                    <input id="inputNewPassword" class="input" type="password" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPasswordRepeat">Upprepa nytt l√∂senord</label>
                    <input id="inputNewPasswordRepeat" class="input" type="password" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnChangeTeacherPassword" class="btn btn-sm">üîê Spara nytt l√∂senord</button>
                </div>
                <p id="passwordStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Google-inloggning & uppladdning (l√§rare)</h3>
                <p>
                  Logga in med ditt Google-konto f√∂r att spara och ladda fr√•gebanker via Firebase.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label">Status</label>
                    <p id="googleStatus" class="mini">‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.</p>
                  </div>
                  <div class="field">
                    <button id="btnGooglePlaceholder" class="btn btn-sm" type="button">
                      üîó Logga in med Google
                    </button>
                  </div>
                  <div class="field">
                    <button id="btnGoogleLogout" class="btn btn-sm hidden" type="button">
                      üö™ Logga ut fr√•n Google
                    </button>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Gr√§ns f√∂r godk√§nt per niv√•</h3>
                <p>Justera procentgr√§ns f√∂r E, C och A. Anv√§nds som riktm√§rke f√∂r ‚ÄùGodk√§nd niv√•‚Äù.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputThresE">Niv√• 1 (E)</label>
                    <input id="inputThresE" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresC">Niv√• 2 (C)</label>
                    <input id="inputThresC" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresA">Niv√• 3 (A)</label>
                    <input id="inputThresA" type="number" min="0" max="100" class="input-number" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveThresholds" class="btn btn-sm btn-primary">üíæ Spara niv√•-gr√§nser</button>
                </div>
              </div>

              <div class="card">
                <h3>L√§rarens e-post</h3>
                <p>
                  Anv√§nds som mottagare n√§r eleven l√§mnar in resultat via e-post
                  (‚ÄùSkapa e-post‚Äù p√• Elevresultat/JSON).
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputTeacherEmail">E-postadress</label>
                    <input id="inputTeacherEmail" class="input" placeholder="namn@skola.se" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveTeacherEmail" class="btn btn-sm">üíæ Spara e-postadress</button>
                </div>
                <p id="teacherEmailStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Rensa elevdata & speldata</h3>
                <p class="mini">
                  H√§r kan du rensa aktuell elevs uppgifter eller nollst√§lla hela spelet p√• denna enhet
                  (alla lokala resultat och inst√§llningar tas bort).
                </p>
                <div class="card-row" style="margin-top:6px;gap:8px;flex-wrap:wrap;">
                  <button id="btnResetStudentData" class="btn btn-sm">
                    üßπ Rensa elevdata
                  </button>
                  <button id="btnResetGameData" class="btn btn-sm btn-danger">
                    üóëÔ∏è Nollst√§ll spelet
                  </button>
                </div>
                <p id="resetStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Koppling: delm√•l & delbitar</h3>
                <p>
                  Skriv ett delm√•l och en delbit i taget. Klicka p√• ‚ÄùL√§gg till delbit‚Äù
                  f√∂r att l√§gga till i listan. ‚ÄùSpara‚Äù skriver listan
                  till spelets minne
                  (localStorage). ‚ÄùTa bort alla‚Äù rensar listan.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputGoalSingle">Delm√•l</label>
                    <input id="inputGoalSingle" class="input" placeholder="t.ex. Delm√•l 5 ‚Äì Hygien i k√∂ket" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputPartSingle">Delbit</label>
                    <input id="inputPartSingle" class="input" placeholder="t.ex. 51‚Äì60 eller 51,52,53" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnAddGoalPart" class="btn btn-sm">‚ûï L√§gg till delbit</button>
                  <button id="btnSaveGoalsMap" class="btn btn-sm btn-primary">üíæ Spara</button>
                  <button id="btnClearGoalsMap" class="btn btn-sm btn-danger">üóëÔ∏è Ta bort alla</button>
                </div>
                <p id="goalsStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card card-full-width">
                <h3>Aktuella delm√•l och delbitar</h3>
                <p class="mini">Nedan visas de delm√•l och delbitar som √§r sparade i spelet just nu.</p>
                <ul id="goalsList" class="goals-list">
                </ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="questions">
            <div class="questions-editor">
              <h3>Hantera flervalsfr√•gor (MCQ)</h3>
              <p class="mini">L√§gg till nya flervalsfr√•gor, redigera eller ta bort befintliga. Varje fr√•ga m√•ste ha ett svar (index 0-3).</p>
              <div class="card" style="margin-top: 15px;">
                <h4>L√§gg till/Redigera fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex: 0 0 100px;">
                    <label class="small-label" for="mcqLevel">Niv√•</label>
                    <select id="mcqLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqQuestion">Fr√•getext</label>
                    <input id="mcqQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>
                <div class="card-row" style="margin-top: 10px;">
                  <div class="field">
                    <label class="small-label" for="mcqOption0">Alternativ 1 (Index 0)</label>
                    <input id="mcqOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqOption1">Alternativ 2 (Index 1)</label>
                    <input id="mcqOption1" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top: 10px%;">
                  <div class="field">
                    <label class="small-label" for="mcqOption2">Alternativ 3 (Index 2)</label>
                    <input id="mcqOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqOption3">Alternativ 4 (Index 3)</label>
                    <input id="mcqOption3" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top: 10px;">
                  <div class="field" style="flex: 0 0 100px;">
                    <label class="small-label" for="mcqAnswer">Korrekt Svar (Index)</label>
                    <input id="mcqAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqGoalPart">Kopplad Delbit (valfritt)</label>
                    <select id="mcqGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>
                <div class="card-row" style="margin-top: 15px; justify-content: space-between;">
                  <div>
                    <button id="btnMcqAdd" class="btn btn-sm btn-primary">‚ûï L√§gg till fr√•ga</button>
                    <button id="btnMcqUpdate" class="btn btn-sm hidden">üíæ Spara √§ndring</button>
                  </div>
                  <button id="btnMcqClear" class="btn btn-sm btn-secondary">Avbryt/Rensa formul√§r</button>
                </div>
              </div>
              <div class="card card-full-width" style="margin-top: 15px;">
                <h3>Aktuella flervalsfr√•gor (<span id="mcqCount">0</span> st)</h3>
                <ul id="mcqList" class="question-list">
                </ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="images">
            <div class="questions-editor">
              <h3>Hantera bildfr√•gor (IMG)</h3>
              <p class="mini">L√§gg till fr√•gor d√§r en bild visas tillsammans med flervalsalternativ.</p>
              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera bildfr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgLevel">Niv√•</label>
                    <select id="imgLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgQuestion">Fr√•getext</label>
                    <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgFile">Bildfil</label>
                    <input id="imgFile" type="file" accept="image/*" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">F√∂rhandsvisning</label>
                    <div id="imgPreview" class="img-preview-box mini">Ingen bild vald √§nnu.</div>
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgOption0">Alternativ 1 (Index 0)</label>
                    <input id="imgOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgOption1">Alternativ 2 (Index 1)</label>
                    <input id="imgOption1" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgOption2">Alternativ 3 (Index 2)</label>
                    <input id="imgOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgOption3">Alternativ 4 (Index 3)</label>
                    <input id="imgOption3" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgAnswer">Korrekt Svar (Index)</label>
                    <input id="imgAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgGoalPart">Kopplad Delbit (valfritt)</label>
                    <select id="imgGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>
                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnImgAdd" class="btn btn-sm btn-primary">‚ûï L√§gg till bildfr√•ga</button>
                  </div>
                  <button id="btnImgClear" class="btn btn-sm btn-secondary">Avbryt/Rensa formul√§r</button>
                </div>
              </div>
              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
                <ul id="imgList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="dragdrop">
            <div class="questions-editor">
              <h3>Hantera Drag &amp; Drop-fr√•gor</h3>
              <p class="mini">Skapa fr√•gor d√§r eleverna drar ord eller begrepp till r√§tt kategori.</p>
              <div class="card" style="margin-top:15px;">
                <h4>Bygg fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="dragLevel">Niv√•</label>
                    <select id="dragLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragQuestion">Instruktion / fr√•getext</label>
                    <input id="dragQuestion" class="input" placeholder="Ex: Dra r√§tt livsmedel till 'Kylvara'." />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="dragColumn1">Kolumn 1</label>
                    <input id="dragColumn1" class="input" placeholder="t.ex. R√§tt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragColumn2">Kolumn 2</label>
                    <input id="dragColumn2" class="input" placeholder="t.ex. Fel" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="dragItemText">Objekt att dra</label>
                    <input id="dragItemText" class="input" placeholder="t.ex. 'R√• kyckling'" />
                  </div>
                  <div class="field" style="flex:0 0 150px;">
                    <label class="small-label" for="dragItemCorrect">Korrekt kolumn</label>
                    <select id="dragItemCorrect" class="input">
                      <option value="0">Kolumn 1</option>
                      <option value="1">Kolumn 2</option>
                    </select>
                  </div>
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label">&nbsp;</label>
                    <button id="btnDragAddItem" class="btn btn-sm btn-primary" style="width:100%;">‚ûï L√§gg till objekt</button>
                  </div>
                </div>
                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">Objekt i denna fr√•ga</label>
                    <ul id="dragItemsPreview" class="question-list"></ul>
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="dragGoalPart">Kopplad Delbit (valfritt)</label>
                    <select id="dragGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>
                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnDragAddQuestion" class="btn btn-sm btn-primary">üíæ Spara fr√•ga</button>
                  </div>
                  <button id="btnDragClearForm" class="btn btn-sm btn-secondary">Rensa formul√§r</button>
                </div>
              </div>
              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella Drag &amp; Drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
                <ul id="dragList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <!-- üîÅ NY: Elevprogression med 4 rutor -->
          <section class="tab-panel hidden" data-panel="progress">
            <div class="progress-grid">
              <!-- Ruta 1: Po√§ng√∂versikt -->
              <div class="card">
                <h3>Po√§ng√∂versikt</h3>
                <p class="mini">
                  Sammanfattning av elevens totala progressionpo√§ng fr√•n spelet.
                </p>
                <p style="margin-top:6px;font-size:0.9rem;">
                  Totala progressionpo√§ng:
                  <strong><span id="progressTotalPoints">0 p</span></strong>
                </p>
                <p style="margin-top:2px;" class="mini">
                  B√§sta niv√•resultat:
                </p>
                <ul class="progress-list" id="progressBestLevels">
                  <li>Niv√• 1 (E): <span id="progressBestE">0%</span></li>
                  <li>Niv√• 2 (C): <span id="progressBestC">0%</span></li>
                  <li>Niv√• 3 (A): <span id="progressBestA">0%</span></li>
                </ul>
              </div>

              <!-- Ruta 2: Starka delbitar -->
              <div class="card">
                <h3>Starka delbitar</h3>
                <p class="mini">
                  Delbitar d√§r eleven oftast svarat r√§tt (√∂ver tr√∂skelv√§rdet).
                </p>
                <ul class="progress-list" id="progressStrongParts">
                  <li class="mini">Ingen data √§nnu ‚Äì l√•t eleven spela minst en niv√•.</li>
                </ul>
              </div>

              <!-- Ruta 3: Delbitar att √∂va p√• -->
              <div class="card">
                <h3>Delbitar att √∂va p√•</h3>
                <p class="mini">
                  Delbitar d√§r eleven haft flest fel eller precis klarat gr√§nsen.
                </p>
                <ul class="progress-list" id="progressWeakParts">
                  <li class="mini">Ingen data √§nnu ‚Äì l√•t eleven spela minst en niv√•.</li>
                </ul>
              </div>

              <!-- Ruta 4: Export till elevkort -->
              <div class="card">
                <h3>Export till elevkort (JSON)</h3>
                <p class="mini">
                  Generera JSON-kod fr√•n senaste resultatet. Klistra sedan in i elevkortet
                  eller dokumentation.
                </p>
                <textarea
                  id="progressExportJson"
                  class="progress-json-area"
                  readonly
                  placeholder="Klicka p√• ‚ÄùGenerera JSON‚Äù efter att eleven spelat klart en niv√•."
                ></textarea>
                <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
                  <button id="btnGenerateProgressJson" class="btn btn-sm btn-primary">
                    üîÅ Generera JSON
                  </button>
                  <button id="btnCopyProgressJson" class="btn btn-sm">
                    üìã Kopiera kod
                  </button>
                  <span id="progressExportStatus" class="mini"></span>
                </div>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="bank">
            <div class="settings-grid">
              <div class="card">
                <h3>Ladda fr√•gebank fr√•n molnet (Firebase)</h3>
                <p class="mini">
                  Visar bankar som har sparats p√• ditt Google-konto. Aktivera bankarna nedan f√∂r att l√§gga till fr√•gorna i spelet.
                </p>
                <ul id="cloudBankList" class="goals-list" style="margin-top: 10px;">
                </ul>
                <div style="margin-top: 10px;">
                  <button id="btnLoadCloudBanks" class="btn btn-sm">‚òÅÔ∏è Ladda moln-bankar</button>
                </div>
              </div>
              
              <div class="card">
                <h3>Spara aktuell fr√•gebank till molnet</h3>
                <p class="mini">
                  Namnge din fr√•gebank. Sparar *alla* fr√•gor du skapat i flervals-, bild- och drag/drop-flikarna.
                </p>
                <div class="card-row" style="margin-top: 10px;">
                  <div class="field">
                    <label class="small-label" for="inputBankName">Namn p√• fr√•gebank</label>
                    <input id="inputBankName" class="input" placeholder="T.ex. Min Skolans Bank HT25" />
                  </div>
                </div>
                <div style="margin-top: 10px;">
                  <button id="btnSaveToCloud" class="btn btn-sm btn-primary">üíæ Spara bank till molnet</button>
                </div>
              </div>

              <div class="card card-full-width">
                <h3>Export / Import av fr√•gebank (JSON)</h3>
                <p class="mini">
                  Exportera hela din nuvarande fr√•gebank som en JSON-fil (s√§kerhetskopia) eller importera en befintlig bank fr√•n fil.
                </p>
                <div class="card-row" style="margin-top: 10px;">
                  <button id="btnExportBank" class="btn btn-sm">‚¨áÔ∏è Exportera till JSON</button>
                  <label class="btn btn-sm" for="fileImport">‚¨ÜÔ∏è Importera fr√•n JSON</label>
                  <input type="file" id="fileImport" accept=".json" style="display:none;" />
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
<!-- slut SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->











<!-- start SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (state, l√§rare, Firebase) -->
<script>
"use strict";

/* =========================
   3a ‚Äì Grundutils & state
   ========================= */

const STORAGE_KEY = "fangvaktaren-v17";

function $(id) {
  return document.getElementById(id);
}

function createInitialState() {
  return {
    student: { name: "", klass: "" },
    teacherEmail: "",
    teacherPassword: "",
    thres: { E: 70, C: 70, A: 70 },
    best: { E: 0, C: 0, A: 0 },
    unlocked: { E: false, C: false, A: false },
    bank: { mcq: [], img: [], drag: [] },
    goalsMap: [],
    progression: {
      totalPoints: 0,
      wrongByGoalId: {},
      correctByGoalId: {}
    },
    activeCloudBankId: null
  };
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return createInitialState();
    const parsed = JSON.parse(raw);

    const base = createInitialState();
    const merged = Object.assign(base, parsed || {});

    merged.student = Object.assign({ name: "", klass: "" }, merged.student || {});
    merged.thres = Object.assign({ E: 70, C: 70, A: 70 }, merged.thres || {});
    merged.best = Object.assign({ E: 0, C: 0, A: 0 }, merged.best || {});
    merged.unlocked = Object.assign({ E: false, C: false, A: false }, merged.unlocked || {});
    merged.bank = Object.assign({ mcq: [], img: [], drag: [] }, merged.bank || {});
    merged.progression = Object.assign(
      { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {} },
      merged.progression || {}
    );
    if (!Array.isArray(merged.bank.mcq)) merged.bank.mcq = [];
    if (!Array.isArray(merged.bank.img)) merged.bank.img = [];
    if (!Array.isArray(merged.bank.drag)) merged.bank.drag = [];
    if (!Array.isArray(merged.goalsMap)) merged.goalsMap = [];
    if (!merged.activeCloudBankId) merged.activeCloudBankId = null;

    return merged;
  } catch (e) {
    console.warn("Kunde inte l√§sa state, skapar nytt:", e);
    return createInitialState();
  }
}

function saveState(state) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.error("Kunde inte spara state:", e);
  }
}

function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// anv√§nds i progression f√∂r att koppla fr√•ga -> delbit
function getLinksForQuestion(q, goalsMap) {
  const links = [];

  if (Array.isArray(q.parts) && q.parts.length) {
    q.parts.forEach((id) => {
      if (id != null) links.push({ id });
    });
  } else if (q.goal != null) {
    links.push({ id: q.goal });
  }

  return links;
}

// Sl√•r ihop ev. inb√§ddad grundbank om ingen lokal bank finns
function mergeEmbeddedBank() {
  const s = loadState();
  if (!s.bank) {
    s.bank = { mcq: [], img: [], drag: [] };
  }

  const hasLocalQuestions =
    (s.bank.mcq && s.bank.mcq.length) ||
    (s.bank.img && s.bank.img.length) ||
    (s.bank.drag && s.bank.drag.length);

  if (!hasLocalQuestions && window.EMBEDDED_BANK) {
    if (Array.isArray(window.EMBEDDED_BANK.mcq)) {
      s.bank.mcq = window.EMBEDDED_BANK.mcq.slice();
    }
    if (Array.isArray(window.EMBEDDED_BANK.img)) {
      s.bank.img = window.EMBEDDED_BANK.img.slice();
    }
    if (Array.isArray(window.EMBEDDED_BANK.drag)) {
      s.bank.drag = window.EMBEDDED_BANK.drag.slice();
    }
  }

  saveState(s);
  return s;
}

// Globala spelvariabler (anv√§nds i SEKTION 4)
let currentLevel = null;
let currentQuestions = [];
let currentAnswers = [];
let lastSubmission = null;

/* =========================
   3b ‚Äì L√§rarinst√§llningar (lokalt)
   ========================= */

function initTeacherEmailSettings() {
  const s = loadState();
  const input = $("#inputTeacherEmail");
  const status = $("#teacherEmailStatus");

  if (input) {
    input.value = s.teacherEmail || "";
  }
  if (status) {
    status.textContent = s.teacherEmail
      ? `Sparad e-post: ${s.teacherEmail}`
      : "Ingen e-post sparad √§nnu.";
  }
}

function handleSaveTeacherEmail() {
  const input = $("#inputTeacherEmail");
  const status = $("#teacherEmailStatus");
  if (!input) return;

  const value = (input.value || "").trim();
  const s = loadState();
  s.teacherEmail = value;
  saveState(s);

  if (status) {
    status.textContent = value
      ? `Sparad e-post: ${value}`
      : "Ingen e-post sparad.";
  }
}

function initThresholdSettings() {
  const s = loadState();
  const inE = $("#inputThresE");
  const inC = $("#inputThresC");
  const inA = $("#inputThresA");

  if (inE) inE.value = String(s.thres.E ?? 70);
  if (inC) inC.value = String(s.thres.C ?? 70);
  if (inA) inA.value = String(s.thres.A ?? 70);
}

function handleSaveThresholds() {
  const s = loadState();
  const inE = $("#inputThresE");
  const inC = $("#inputThresC");
  const inA = $("#inputThresA");

  const eVal = inE ? parseInt(inE.value, 10) : NaN;
  const cVal = inC ? parseInt(inC.value, 10) : NaN;
  const aVal = inA ? parseInt(inA.value, 10) : NaN;

  if (!isNaN(eVal)) s.thres.E = eVal;
  if (!isNaN(cVal)) s.thres.C = cVal;
  if (!isNaN(aVal)) s.thres.A = aVal;

  saveState(s);
}

function initTeacherPasswordSettings() {
  const s = loadState();
  if (typeof s.teacherPassword !== "string") {
    s.teacherPassword = s.teacherPassword ? String(s.teacherPassword) : "";
    saveState(s);
  }
}

function handleChangeTeacherPassword() {
  const s = loadState();
  const oldInput = $("#inputOldPassword");
  const newInput = $("#inputNewPassword");
  const repeatInput = $("#inputNewPasswordRepeat");
  const status = $("#passwordStatus");

  if (!newInput || !repeatInput) return;

  const oldVal = (oldInput && oldInput.value.trim()) || "";
  const newVal = newInput.value.trim();
  const repVal = repeatInput.value.trim();

  if (!newVal) {
    alert("Nytt l√∂senord f√•r inte vara tomt.");
    return;
  }
  if (newVal !== repVal) {
    alert("Det nya l√∂senordet st√§mmer inte √∂verens i b√•da f√§lten.");
    return;
  }

  if (s.teacherPassword) {
    if (oldVal !== s.teacherPassword) {
      alert("Nuvarande l√∂senord √§r fel.");
      return;
    }
  }

  s.teacherPassword = newVal;
  saveState(s);

  if (status) {
    status.textContent = `Aktuellt l√§rarl√∂senord: ${s.teacherPassword}`;
  }
  if (oldInput) oldInput.value = "";
  newInput.value = "";
  repeatInput.value = "";
  alert("L√§rarl√∂senord uppdaterat.");
}

/* =========================
   3c ‚Äì Delm√•l/delbitar & fr√•geeditor
   ========================= */

function parsePartString(str) {
  if (!str) return [];
  const result = [];
  str.split(",").forEach((chunk) => {
    const trimmed = chunk.trim();
    if (!trimmed) return;
    if (trimmed.includes("-")) {
      const [startStr, endStr] = trimmed.split("-");
      const start = parseInt(startStr, 10);
      const end = parseInt(endStr, 10);
      if (!isNaN(start) && !isNaN(end) && end >= start) {
        for (let n = start; n <= end; n++) result.push(n);
      }
    } else {
      const n = parseInt(trimmed, 10);
      if (!isNaN(n)) result.push(n);
    }
  });
  return Array.from(new Set(result));
}

function fillGoalPartSelects() {
  const s = loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];

  const selectIds = ["mcqGoalPart", "imgGoalPart", "dragGoalPart"];
  selectIds.forEach((id) => {
    const sel = $("#" + id);
    if (!sel) return;

    const current = sel.value;
    sel.innerHTML = "";

    const optNone = document.createElement("option");
    optNone.value = "";
    optNone.textContent = "Ingen koppling";
    sel.appendChild(optNone);

    s.goalsMap.forEach((item) => {
      const opt = document.createElement("option");
      opt.value = String(item.id);
      opt.textContent = `Delbit ${item.id} ‚Äì ${item.label || ""}`;
      sel.appendChild(opt);
    });

    if (current) {
      sel.value = current;
    }
  });
}

function renderGoalsMapUI() {
  const s = loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];

  const list = $("#goalsList");
  const status = $("#goalsStatus");
  if (list) {
    list.innerHTML = "";
    if (!s.goalsMap.length) {
      const li = document.createElement("li");
      li.className = "mini";
      li.textContent = "Inga delbitar sparade √§nnu.";
      list.appendChild(li);
    } else {
      s.goalsMap
        .slice()
        .sort((a, b) => (a.id || 0) - (b.id || 0))
        .forEach((item) => {
          const li = document.createElement("li");
          li.textContent = `Delbit ${item.id}: ${item.label || ""}`;
          list.appendChild(li);
        });
    }
  }
  if (status) {
    status.textContent = s.goalsMap.length
      ? `Sparade delbitar: ${s.goalsMap.length} st.`
      : "Inga delbitar sparade.";
  }

  fillGoalPartSelects();
}

function initGoalsMap() {
  const s = loadState();
  if (!Array.isArray(s.goalsMap)) {
    s.goalsMap = [];
    saveState(s);
  }
  renderGoalsMapUI();
}

function handleAddGoalPart() {
  const goalInput = $("#inputGoalSingle");
  const partInput = $("#inputPartSingle");
  if (!goalInput || !partInput) return;

  const goalText = goalInput.value.trim();
  const partStr = partInput.value.trim();

  if (!goalText || !partStr) {
    alert("Skriv b√•de delm√•ltext och delbit/delbitar.");
    return;
  }

  const parts = parsePartString(partStr);
  if (!parts.length) {
    alert("Kunde inte tolka delbitarna. Exempel: 51-60 eller 51,52,53");
    return;
  }

  const s = loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];

  parts.forEach((id) => {
    const existingIndex = s.goalsMap.findIndex((item) => item.id === id);
    if (existingIndex >= 0) {
      s.goalsMap[existingIndex].label = goalText;
    } else {
      s.goalsMap.push({ id, label: goalText });
    }
  });

  saveState(s);
  goalInput.value = "";
  partInput.value = "";
  renderGoalsMapUI();
}

function handleSaveGoalsMap() {
  renderGoalsMapUI();
  const status = $("#goalsStatus");
  if (status) {
    status.textContent += " (sparat).";
  }
}

function handleClearGoalsMap() {
  if (!confirm("Ta bort alla sparade delbitar?")) return;
  const s = loadState();
  s.goalsMap = [];
  saveState(s);
  renderGoalsMapUI();
}

function initQuestionForms() {
  const list = $("#mcqList");
  const countEl = $("#mcqCount");
  const btnAdd = $("#btnMcqAdd");
  const btnClear = $("#btnMcqClear");
  if (!list || !btnAdd || !btnClear) return;

  function render() {
    const s = loadState();
    const questions = Array.isArray(s.bank.mcq) ? s.bank.mcq : [];
    list.innerHTML = "";
    if (!questions.length) {
      const li = document.createElement("li");
      li.className = "mini";
      li.textContent = "Inga flervalsfr√•gor √§nnu.";
      list.appendChild(li);
    } else {
      questions.forEach((q, index) => {
        const li = document.createElement("li");
        li.className = "mini";
        li.textContent = `${index + 1}. [${q.level || "E"}] ${q.q || q.text || ""}`;
        list.appendChild(li);
      });
    }
    if (countEl) countEl.textContent = String(questions.length);
  }

  btnAdd.addEventListener("click", (ev) => {
    ev.preventDefault();
    const levelSel = $("#mcqLevel");
    const qInput = $("#mcqQuestion");
    const opt0 = $("#mcqOption0");
    const opt1 = $("#mcqOption1");
    const opt2 = $("#mcqOption2");
    const opt3 = $("#mcqOption3");
    const ansInput = $("#mcqAnswer");
    const partSel = $("#mcqGoalPart");

    if (!qInput || !opt0 || !opt1 || !ansInput || !levelSel) return;

    const qText = qInput.value.trim();
    const options = [opt0, opt1, opt2, opt3]
      .filter(Boolean)
      .map((el) => el.value.trim())
      .filter((txt) => txt.length > 0);

    if (!qText) {
      alert("Skriv en fr√•getext.");
      return;
    }
    if (options.length < 2) {
      alert("Minst tv√• svarsalternativ beh√∂vs.");
      return;
    }
    const ansIndex = parseInt(ansInput.value, 10);
    if (isNaN(ansIndex) || ansIndex < 0 || ansIndex >= options.length) {
      alert("Korrekt svar m√•ste vara ett index mellan 0 och " + (options.length - 1) + ".");
      return;
    }

    const level = levelSel.value || "E";

    const s = loadState();
    if (!s.bank) s.bank = { mcq: [], img: [], drag: [] };
    if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];

    const qObj = {
      type: "mcq",
      level,
      q: qText,
      options,
      answer: ansIndex
    };

    if (partSel && partSel.value) {
      const partId = parseInt(partSel.value, 10);
      if (!isNaN(partId)) {
        qObj.parts = [partId];
      }
    }

    s.bank.mcq.push(qObj);
    saveState(s);

    qInput.value = "";
    [opt0, opt1, opt2, opt3, ansInput].forEach((el) => {
      if (el) el.value = "";
    });
    if (partSel) partSel.value = "";

    render();
  });

  btnClear.addEventListener("click", (ev) => {
    ev.preventDefault();
    const qInput = $("#mcqQuestion");
    const opt0 = $("#mcqOption0");
    const opt1 = $("#mcqOption1");
    const opt2 = $("#mcqOption2");
    const opt3 = $("#mcqOption3");
    const ansInput = $("#mcqAnswer");
    const partSel = $("#mcqGoalPart");
    if (qInput) qInput.value = "";
    [opt0, opt1, opt2, opt3, ansInput].forEach((el) => {
      if (el) el.value = "";
    });
    if (partSel) partSel.value = "";
  });

  render();
}

function initImageQuestionsEditor() {
  const list = $("#imgList");
  const countEl = $("#imgCount");
  const btnAdd = $("#btnImgAdd");
  const btnClear = $("#btnImgClear");
  const fileInput = $("#imgFile");
  const preview = $("#imgPreview");
  if (!list || !btnAdd || !btnClear) return;

  let currentImageDataUrl = "";

  if (fileInput) {
    fileInput.addEventListener("change", (ev) => {
      const file = ev.target.files && ev.target.files[0];
      if (!file) {
        currentImageDataUrl = "";
        if (preview) preview.textContent = "Ingen bild vald √§nnu.";
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        currentImageDataUrl = e.target.result;
        if (preview) {
          const img = document.createElement("img");
          img.src = currentImageDataUrl;
          img.alt = "F√∂rhandsvisning";
          img.style.maxWidth = "100%";
          img.style.borderRadius = "8px";
          preview.innerHTML = "";
          preview.appendChild(img);
        }
      };
      reader.readAsDataURL(file);
    });
  }

  function render() {
    const s = loadState();
    const questions = Array.isArray(s.bank.img) ? s.bank.img : [];
    list.innerHTML = "";
    if (!questions.length) {
      const li = document.createElement("li");
      li.className = "mini";
      li.textContent = "Inga bildfr√•gor √§nnu.";
      list.appendChild(li);
    } else {
      questions.forEach((q, index) => {
        const li = document.createElement("li");
        li.className = "mini";
        li.textContent = `${index + 1}. [${q.level || "E"}] ${q.q || ""}`;
        list.appendChild(li);
      });
    }
    if (countEl) countEl.textContent = String(questions.length);
  }

  btnAdd.addEventListener("click", (ev) => {
    ev.preventDefault();
    const levelSel = $("#imgLevel");
    const qInput = $("#imgQuestion");
    const opt0 = $("#imgOption0");
    const opt1 = $("#imgOption1");
    const opt2 = $("#imgOption2");
    const opt3 = $("#imgOption3");
    const ansInput = $("#imgAnswer");
    const partSel = $("#imgGoalPart");

    if (!qInput || !levelSel || !ansInput) return;

    const qText = qInput.value.trim();
    if (!qText) {
      alert("Skriv en fr√•getext.");
      return;
    }
    if (!currentImageDataUrl) {
      alert("V√§lj en bild.");
      return;
    }

    const options = [opt0, opt1, opt2, opt3]
      .filter(Boolean)
      .map((el) => el.value.trim())
      .filter((txt) => txt.length > 0);

    if (options.length < 2) {
      alert("Minst tv√• svarsalternativ beh√∂vs.");
      return;
    }

    const ansIndex = parseInt(ansInput.value, 10);
    if (isNaN(ansIndex) || ansIndex < 0 || ansIndex >= options.length) {
      alert("Korrekt svar m√•ste vara ett index mellan 0 och " + (options.length - 1) + ".");
      return;
    }

    const level = levelSel.value || "E";

    const s = loadState();
    if (!s.bank) s.bank = { mcq: [], img: [], drag: [] };
    if (!Array.isArray(s.bank.img)) s.bank.img = [];

    const qObj = {
      type: "img",
      level,
      q: qText,
      imgDataUrl: currentImageDataUrl,
      options,
      answer: ansIndex
    };

    if (partSel && partSel.value) {
      const partId = parseInt(partSel.value, 10);
      if (!isNaN(partId)) {
        qObj.parts = [partId];
      }
    }

    s.bank.img.push(qObj);
    saveState(s);

    qInput.value = "";
    [opt0, opt1, opt2, opt3, ansInput].forEach((el) => {
      if (el) el.value = "";
    });
    if (partSel) partSel.value = "";
    currentImageDataUrl = "";
    if (preview) {
      preview.textContent = "Ingen bild vald √§nnu.";
    }
    if (fileInput) fileInput.value = "";

    render();
  });

  btnClear.addEventListener("click", (ev) => {
    ev.preventDefault();
    const qInput = $("#imgQuestion");
    const opt0 = $("#imgOption0");
    const opt1 = $("#imgOption1");
    const opt2 = $("#imgOption2");
    const opt3 = $("#imgOption3");
    const ansInput = $("#imgAnswer");
    const partSel = $("#imgGoalPart");
    if (qInput) qInput.value = "";
    [opt0, opt1, opt2, opt3, ansInput].forEach((el) => {
      if (el) el.value = "";
    });
    if (partSel) partSel.value = "";
  });

  render();
}

function initDragDropQuestionsEditor() {
  const list = $("#dragList");
  const countEl = $("#dragCount");
  const btnAddItem = $("#btnDragAddItem");
  const btnAddQuestion = $("#btnDragAddQuestion");
  const btnClearForm = $("#btnDragClearForm");
  const itemsPreview = $("#dragItemsPreview");

  if (!list || !btnAddItem || !btnAddQuestion || !btnClearForm || !itemsPreview) return;

  let draftItems = [];

  function renderItemsPreview() {
    itemsPreview.innerHTML = "";
    if (!draftItems.length) {
      const li = document.createElement("li");
      li.className = "mini";
      li.textContent = "Inga objekt √§nnu.";
      itemsPreview.appendChild(li);
      return;
    }
    draftItems.forEach((item, index) => {
      const li = document.createElement("li");
      li.className = "mini";
      const colText = item.col === 0 ? "Kolumn 1" : "Kolumn 2";
      li.textContent = `${index + 1}. ${item.text} (${colText})`;
      itemsPreview.appendChild(li);
    });
  }

  function renderQuestions() {
    const s = loadState();
    const questions = Array.isArray(s.bank.drag) ? s.bank.drag : [];
    list.innerHTML = "";
    if (!questions.length) {
      const li = document.createElement("li");
      li.className = "mini";
      li.textContent = "Inga Drag & Drop-fr√•gor √§nnu.";
      list.appendChild(li);
    } else {
      questions.forEach((q, index) => {
        const li = document.createElement("li");
        li.className = "mini";
        li.textContent = `${index + 1}. [${q.level || "E"}] ${q.q || q.text || ""}`;
        list.appendChild(li);
      });
    }
    if (countEl) countEl.textContent = String(questions.length);
  }

  btnAddItem.addEventListener("click", (ev) => {
    ev.preventDefault();
    const itemTextInput = $("#dragItemText");
    const itemCorrectSel = $("#dragItemCorrect");
    if (!itemTextInput || !itemCorrectSel) return;

    const text = itemTextInput.value.trim();
    if (!text) {
      alert("Skriv ett objekt att dra.");
      return;
    }
    const col = parseInt(itemCorrectSel.value, 10) || 0;

    draftItems.push({ text, col });
    itemTextInput.value = "";
    renderItemsPreview();
  });

  btnAddQuestion.addEventListener("click", (ev) => {
    ev.preventDefault();
    const levelSel = $("#dragLevel");
    const qInput = $("#dragQuestion");
    const col1Input = $("#dragColumn1");
    const col2Input = $("#dragColumn2");
    const partSel = $("#dragGoalPart");

    if (!levelSel || !qInput || !col1Input || !col2Input) return;

    const qText = qInput.value.trim();
    const col1Label = col1Input.value.trim();
    const col2Label = col2Input.value.trim();

    if (!qText) {
      alert("Skriv en fr√•getext / instruktion.");
      return;
    }
    if (!col1Label || !col2Label) {
      alert("Skriv etiketter f√∂r b√•da kolumnerna.");
      return;
    }
    if (!draftItems.length) {
      alert("L√§gg till minst ett objekt att dra.");
      return;
    }

    const level = levelSel.value || "E";

    const sources = [];
    const targets = [
      { id: "col0", label: col1Label },
      { id: "col1", label: col2Label }
    ];
    const correctMap = {};

    draftItems.forEach((item, index) => {
      const id = "item" + index;
      sources.push({ id, label: item.text });
      const targetId = item.col === 1 ? "col1" : "col0";
      correctMap[id] = targetId;
    });

    const s = loadState();
    if (!s.bank) s.bank = { mcq: [], img: [], drag: [] };
    if (!Array.isArray(s.bank.drag)) s.bank.drag = [];

    const qObj = {
      type: "drag",
      level,
      q: qText,
      dragSources: sources,
      dragTargets: targets,
      correctMap
    };

    if (partSel && partSel.value) {
      const partId = parseInt(partSel.value, 10);
      if (!isNaN(partId)) {
        qObj.parts = [partId];
      }
    }

    s.bank.drag.push(qObj);
    saveState(s);

    // Rensa formul√§r
    qInput.value = "";
    col1Input.value = "";
    col2Input.value = "";
    if (partSel) partSel.value = "";
    draftItems = [];
    renderItemsPreview();
    renderQuestions();
  });

  btnClearForm.addEventListener("click", (ev) => {
    ev.preventDefault();
    const qInput = $("#dragQuestion");
    const col1Input = $("#dragColumn1");
    const col2Input = $("#dragColumn2");
    const itemTextInput = $("#dragItemText");
    const partSel = $("#dragGoalPart");
    if (qInput) qInput.value = "";
    if (col1Input) col1Input.value = "";
    if (col2Input) col2Input.value = "";
    if (itemTextInput) itemTextInput.value = "";
    if (partSel) partSel.value = "";
    draftItems = [];
    renderItemsPreview();
  });

  renderItemsPreview();
  renderQuestions();
}

/* =========================
   3d ‚Äì Firebase & moln-banker
   ========================= */

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
  authDomain: "fangvaktaren-904db.firebaseapp.com",
  projectId: "fangvaktaren-904db",
  storageBucket: "fangvaktaren-904db.firebasestorage.app",
  messagingSenderId: "105301219768",
  appId: "1:105301219768:web:66b131fba86a541b78174d",
  measurementId: "G-NXL9GSFZ77"
};

const CLOUD_ROOT_COLLECTION = "teachers";

let firebaseAppInstance = null;
let firebaseAuthInstance = null;
let firebaseDbInstance = null;
let currentTeacherUser = null;

let cloudBanks = [];
let isLoadingCloudBanks = false;

function initFirebase() {
  if (firebaseAppInstance || !window.firebase) {
    if (firebaseAppInstance) {
      console.log("Firebase redan initierat.");
    }
    return;
  }
  try {
    firebaseAppInstance = firebase.initializeApp(FIREBASE_CONFIG);
    firebaseAuthInstance = firebase.auth();
    firebaseDbInstance = firebase.firestore();
    console.log("Firebase init OK");

    const status = $("#googleStatus");
    if (status) {
      status.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.";
    }

    firebaseAuthInstance.onAuthStateChanged((user) => {
      console.log("onAuthStateChanged:", user ? user.email : "ingen anv√§ndare");
      currentTeacherUser = user || null;
      const sEl = $("#googleStatus");
      const loginBtn = $("#btnGooglePlaceholder");
      const logoutBtn = $("#btnGoogleLogout");

      if (loginBtn) loginBtn.classList.toggle("hidden", !!user);
      if (logoutBtn) logoutBtn.classList.toggle("hidden", !user);

      if (sEl) {
        if (user) {
          sEl.textContent = `‚òÅÔ∏è Inloggad som ${user.email || "l√§rare"}.`;
        } else {
          sEl.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.";
        }
      }

      if (user) {
        fetchCloudBanksForTeacher(user.uid);
      } else {
        cloudBanks = [];
        renderCloudBanksList();
      }
    });
  } catch (e) {
    console.error("Firebase init-fel:", e);
    const sEl = $("#googleStatus");
    if (sEl) sEl.textContent = "Fel vid initiering av Firebase. Se konsolen.";
  }
}

function fetchCloudBanksForTeacher(uid) {
  if (!firebaseDbInstance || !uid) return;

  isLoadingCloudBanks = true;
  const status = $("#googleStatus");
  if (status) status.textContent = "Laddar fr√•gebanker fr√•n molnet‚Ä¶";

  firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION)
    .doc(uid)
    .collection("banks")
    .orderBy("createdAt", "desc")
    .get()
    .then((snap) => {
      cloudBanks = [];
      snap.forEach((doc) => {
        const data = doc.data() || {};
        const mcq = Array.isArray(data.mcq) ? data.mcq : [];
        const img = Array.isArray(data.img) ? data.img : [];
        const drag = Array.isArray(data.drag) ? data.drag : [];

        cloudBanks.push({
          id: doc.id,
          name: data.name || "Namnl√∂s bank",
          createdAt: data.createdAt || null,
          mcqCount: mcq.length,
          imgCount: img.length,
          dragCount: drag.length,
          data: { mcq, img, drag }
        });
      });

      renderCloudBanksList();

      const s = loadState();
      if (s.activeCloudBankId) {
        const active = cloudBanks.find((b) => b.id === s.activeCloudBankId);
        if (active) {
          applyCloudBank(active);
        }
      }

      const sEl = $("#googleStatus");
      if (sEl) {
        if (!cloudBanks.length) {
          sEl.textContent = "Inga moln-banker hittades f√∂r detta konto.";
        } else {
          sEl.textContent = "Moln-banker laddade. V√§lj en bank att aktivera.";
        }
      }
    })
    .catch((err) => {
      console.error("Fel vid laddning av moln-banker:", err);
      const sEl = $("#googleStatus");
      if (sEl) sEl.textContent = "Fel vid laddning av moln-banker. Se konsolen f√∂r detaljer.";
    })
    .finally(() => {
      isLoadingCloudBanks = false;
    });
}

function applyCloudBank(bank) {
  if (!bank || !bank.data) return;

  const s = loadState();
  s.bank = {
    mcq: Array.isArray(bank.data.mcq) ? bank.data.mcq.slice() : [],
    img: Array.isArray(bank.data.img) ? bank.data.img.slice() : [],
    drag: Array.isArray(bank.data.drag) ? bank.data.drag.slice() : []
  };
  s.activeCloudBankId = bank.id;
  saveState(s);

  if (typeof syncUI === "function") {
    syncUI();
  }

  const status = $("#googleStatus");
  if (status) {
    status.textContent = `Aktiv bank: ${bank.name} (${bank.mcqCount} MCQ, ${bank.imgCount} bild, ${bank.dragCount} drag).`;
  }
}

function renderCloudBanksList() {
  const host = $("#cloudBankList");
  if (!host) return;

  host.innerHTML = "";

  const s = loadState();
  const activeId = s.activeCloudBankId || null;

  if (!cloudBanks.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga moln-banker att visa.";
    host.appendChild(li);
    return;
  }

  cloudBanks.forEach((bank) => {
    const li = document.createElement("li");
    li.className = "mini";

    const title = document.createElement("div");
    title.style.fontWeight = "600";
    title.textContent = bank.name;
    li.appendChild(title);

    const meta = document.createElement("div");
    meta.className = "mini";
    const createdText = bank.createdAt
      ? `Skapad: ${new Date(bank.createdAt).toLocaleString("sv-SE")}`
      : "Skapad: ok√§nt datum";
    meta.textContent = `${createdText} ¬∑ MCQ: ${bank.mcqCount}, Bild: ${bank.imgCount}, Drag: ${bank.dragCount}`;
    li.appendChild(meta);

    const btnRow = document.createElement("div");
    btnRow.style.marginTop = "6px";

    const activateBtn = document.createElement("button");
    activateBtn.type = "button";
    activateBtn.className = "btn btn-sm";

    const isActive = activeId === bank.id;
    activateBtn.textContent = isActive ? "‚úÖ Aktiv bank" : "Aktivera denna bank";
    if (isActive) activateBtn.disabled = true;

    activateBtn.addEventListener("click", () => {
      applyCloudBank(bank);
      renderCloudBanksList();
    });

    btnRow.appendChild(activateBtn);
    li.appendChild(btnRow);

    host.appendChild(li);
  });
}

function handleGoogleLogin() {
  if (!firebaseAuthInstance) {
    alert("Firebase √§r inte initierat √§nnu.");
    return;
  }
  const status = $("#googleStatus");
  if (status) status.textContent = "√ñppnar Google-inloggning‚Ä¶";

  const provider = new firebase.auth.GoogleAuthProvider();
  firebaseAuthInstance
    .signInWithPopup(provider)
    .then((result) => {
      const user = result && result.user;
      console.log("signInWithPopup result:", user ? user.email : "ingen anv√§ndare");

      const loginBtn = $("#btnGooglePlaceholder");
      const logoutBtn = $("#btnGoogleLogout");

      if (loginBtn) loginBtn.classList.add("hidden");
      if (logoutBtn) logoutBtn.classList.remove("hidden");

      if (user) {
        if (status) status.textContent = `‚òÅÔ∏è Inloggad som ${user.email || "l√§rare"}. Laddar fr√•gebanker‚Ä¶`;
        fetchCloudBanksForTeacher(user.uid);
      } else {
        if (status) status.textContent = "Inloggning klar, men ingen anv√§ndare returnerades.";
      }
    })
    .catch((err) => {
      console.error("Google-inloggning misslyckades:", err);
      const sEl = $("#googleStatus");
      if (sEl) {
        sEl.textContent = `Inloggning misslyckades: ${err.code || ""} ${err.message || ""}`;
      }
      alert("Google-inloggning misslyckades. Se statusraden i rutan f√∂r mer info.");
    });
}

function handleGoogleLogout() {
  if (!firebaseAuthInstance) return;
  firebaseAuthInstance
    .signOut()
    .then(() => {
      const sEl = $("#googleStatus");
      if (sEl) sEl.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.";
      const loginBtn = $("#btnGooglePlaceholder");
      const logoutBtn = $("#btnGoogleLogout");
      if (loginBtn) loginBtn.classList.remove("hidden");
      if (logoutBtn) logoutBtn.classList.add("hidden");
      cloudBanks = [];
      renderCloudBanksList();
    })
    .catch((err) => {
      console.error("Utloggning misslyckades:", err);
    });
}

function handleLoadCloudBanks() {
  if (!firebaseAuthInstance) {
    alert("Firebase √§r inte initierat √§nnu.");
    return;
  }
  const user = firebaseAuthInstance.currentUser;
  if (!user) {
    alert("Logga in med Google f√∂rst f√∂r att h√§mta fr√•gebanker.");
    return;
  }
  fetchCloudBanksForTeacher(user.uid);
}

function handleSaveToCloud() {
  if (!firebaseDbInstance || !firebaseAuthInstance) {
    alert("Firebase √§r inte initierat √§nnu.");
    return;
  }
  const user = firebaseAuthInstance.currentUser;
  if (!user) {
    alert("Logga in med Google f√∂rst f√∂r att spara till molnet.");
    return;
  }

  const nameInput = $("#inputBankName");
  const status = $("#googleStatus");
  const s = loadState();

  const bankName = (nameInput && nameInput.value.trim()) || "Namnl√∂s bank";

  const payload = {
    name: bankName,
    mcq: Array.isArray(s.bank.mcq) ? s.bank.mcq : [],
    img: Array.isArray(s.bank.img) ? s.bank.img : [],
    drag: Array.isArray(s.bank.drag) ? s.bank.drag : [],
    createdAt: Date.now()
  };

  firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION)
    .doc(user.uid)
    .collection("banks")
    .add(payload)
    .then(() => {
      if (status) status.textContent = "Fr√•gebank sparad i molnet.";
      if (nameInput) nameInput.value = "";
      fetchCloudBanksForTeacher(user.uid);
    })
    .catch((err) => {
      console.error("Fel vid sparande av bank:", err);
      if (status) status.textContent = "Fel vid sparande av bank. Se konsolen.";
    });
}

function handleExportBank() {
  const s = loadState();
  const bank = s.bank || { mcq: [], img: [], drag: [] };
  const exportData = {
    name: "F√•ngvaktaren-fr√•gebank",
    createdAt: new Date().toISOString(),
    mcq: Array.isArray(bank.mcq) ? bank.mcq : [],
    img: Array.isArray(bank.img) ? bank.img : [],
    drag: Array.isArray(bank.drag) ? bank.drag : []
  };

  const json = JSON.stringify(exportData, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "fangvaktaren_bank.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function handleImportBank(event) {
  const file = event && event.target && event.target.files && event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const text = e.target.result;
      const parsed = JSON.parse(text);

      const bankData = parsed.bank || parsed;
      const mcq = Array.isArray(bankData.mcq) ? bankData.mcq : [];
      const img = Array.isArray(bankData.img) ? bankData.img : [];
      const drag = Array.isArray(bankData.drag) ? bankData.drag : [];

      const s = loadState();
      s.bank = { mcq, img, drag };
      s.activeCloudBankId = null;
      saveState(s);

      if (typeof syncUI === "function") {
        syncUI();
      }

      const status = $("#googleStatus");
      if (status) status.textContent = "Fr√•gebank importerad fr√•n fil.";
    } catch (err) {
      console.error("Fel vid import av bank:", err);
      const status = $("#googleStatus");
      if (status) status.textContent = "Fel vid import av bank. Se konsolen.";
    }
  };
  reader.readAsText(file);

  if (event && event.target) {
    event.target.value = "";
  }
}

function setupCloudBankUI() {
  const loginBtn = $("#btnGooglePlaceholder");
  const logoutBtn = $("#btnGoogleLogout");
  const status = $("#googleStatus");

  const user = firebaseAuthInstance && firebaseAuthInstance.currentUser;
  const isLoggedIn = !!user;

  if (loginBtn) loginBtn.classList.toggle("hidden", isLoggedIn);
  if (logoutBtn) logoutBtn.classList.toggle("hidden", !isLoggedIn);

  if (status) {
    status.textContent = isLoggedIn
      ? `‚òÅÔ∏è Inloggad som ${user.email || "l√§rare"}.`
      : "‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.";
  }

  renderCloudBanksList();
}
</script>
<!-- slut SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (state, l√§rare, Firebase) -->



<!-- start SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->
<script>
"use strict";

/* =========================
   4a ‚Äì Elevdata & UI-sync
   ========================= */

function ensureStudentSet() {
  const s = loadState();
  if (!s.student.name || !s.student.klass) {
    alert("Skriv in namn och klass och spara eleven f√∂rst.");
    return false;
  }
  return true;
}

function handleSaveStudent() {
  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  const s = loadState();

  s.student.name = (nameInput && nameInput.value.trim()) || "";
  s.student.klass = (classInput && classInput.value.trim()) || "";
  saveState(s);
  syncUI();
}

// Kort notis under elevkortet med totalpo√§ng
function updateProgressionNotice() {
  const host = getEl("studentCard") || document.body;
  if (!host) return;

  let notice = getEl("progressionNotice");
  if (!notice) {
    notice = document.createElement("p");
    notice.id = "progressionNotice";
    notice.className = "mini";
    notice.style.marginTop = "4px"; // lite kompaktare
    host.appendChild(notice);
  }

  const s = loadState();
  const prog = s.progression || {};
  const totalPoints = prog.totalPoints || 0;

  notice.textContent = `Po√§ng: ${totalPoints} p.`;
}

// Highscore + delbitar + JSON i l√§rarfliken
function updateProgressionPanel() {
  const s = loadState();
  const prog = s.progression || {};
  const best = s.best || {};
  const thres = s.thres || {};

  // ---- Elevens po√§ngruta ----
  const totalPointsEl = getEl("progressTotalPoints");
  const bestEEl = getEl("progressBestE");
  const bestCEl = getEl("progressBestC");
  const bestAEl = getEl("progressBestA");
  const lastLevelEl = getEl("progressLastLevel");
  const lastSummaryEl = getEl("progressLastSummary");

  const lastResult = prog.lastResult || null;

  if (totalPointsEl) {
    totalPointsEl.textContent = `${prog.totalPoints || 0} p`;
  }
  if (bestEEl) bestEEl.textContent = (best.E || 0) + "%";
  if (bestCEl) bestCEl.textContent = (best.C || 0) + "%";
  if (bestAEl) bestAEl.textContent = (best.A || 0) + "%";

  if (lastLevelEl) {
    lastLevelEl.textContent = lastResult ? (lastResult.level || "-") : "-";
  }
  if (lastSummaryEl) {
    if (!lastResult) {
      lastSummaryEl.textContent = "Ingen spelad omg√•ng √§nnu.";
    } else {
      const txt = `${lastResult.score || 0}% (${lastResult.correct || 0}/${lastResult.total || 0} r√§tt) ‚Äì +${lastResult.pointsGained || 0}p`;
      lastSummaryEl.textContent = txt;
    }
  }

  // ---- Lokal highscore ----
  const summaryEl = getEl("localHighscoreSummary");
  const listEl = getEl("localHighscoreList");

  if (summaryEl && listEl) {
    listEl.innerHTML = "";
    const hs = Array.isArray(s.highscores) ? s.highscores.slice() : [];

    if (!hs.length) {
      summaryEl.textContent = "Ingen highscore sparad √§nnu.";
    } else {
      hs.sort((a, b) => (b.points || 0) - (a.points || 0));

      const studentId = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
      const totalPlayers = hs.length;
      const currentIndex = hs.findIndex((entry) => entry.id === studentId);
      const currentEntry = currentIndex >= 0 ? hs[currentIndex] : null;
      const rank = currentIndex >= 0 ? currentIndex + 1 : null;

      if (currentEntry && rank != null) {
        summaryEl.textContent =
          `üèÜ Highscore: plats ${rank} av ${totalPlayers} (${currentEntry.points || 0} po√§ng)`;
      } else {
        summaryEl.textContent =
          `üèÜ Highscorelista: ${totalPlayers} elever p√• denna enhet.`;
      }

      const top3 = hs.slice(0, 3);
      top3.forEach((entry) => {
        const li = document.createElement("li");
        const name = entry.name || "Elev";
        const klass = entry.klass || "-";
        const pts = entry.points || 0;
        li.textContent = `${name} (${klass}) ‚Äì ${pts} p`;
        listEl.appendChild(li);
      });
    }
  }

  // ---- Starka delbitar / delbitar att √∂va p√• ----
  const strongEl = getEl("strongPartsList");
  const weakEl = getEl("weakPartsList");

  if (strongEl && weakEl) {
    strongEl.innerHTML = "";
    weakEl.innerHTML = "";

    const wrongByGoal = prog.wrongByGoalId || {};
    const correctByGoal = prog.correctByGoalId || {};

    const allIds = new Set([
      ...Object.keys(wrongByGoal),
      ...Object.keys(correctByGoal)
    ]);

    if (!allIds.size) {
      const li1 = document.createElement("li");
      li1.textContent = "Inga delbitar kopplade √§nnu.";
      strongEl.appendChild(li1);

      const li2 = document.createElement("li");
      li2.textContent = "Spela niv√•er med delbit-koppling f√∂r att se statistik.";
      weakEl.appendChild(li2);
    } else {
      const baseThres =
        typeof thres.E === "number" ? thres.E :
        typeof thres.C === "number" ? thres.C :
        typeof thres.A === "number" ? thres.A : 70;

      const stats = [];

      allIds.forEach((id) => {
        const c = correctByGoal[id] || 0;
        const w = wrongByGoal[id] || 0;
        const total = c + w;
        if (!total) return;
        const acc = Math.round((c / total) * 100);
        stats.push({ id, correct: c, wrong: w, total, acc });
      });

      const strong = stats
        .filter((st) => st.acc >= baseThres && st.correct > 0)
        .sort((a, b) => b.acc - a.acc || b.correct - a.correct)
        .slice(0, 10);

      const weak = stats
        .filter((st) => st.acc < baseThres || st.wrong > 0)
        .sort((a, b) => b.wrong - a.wrong || a.acc - b.acc)
        .slice(0, 10);

      if (!strong.length) {
        const li = document.createElement("li");
        li.textContent = "Inga tydliga styrkor √§nnu ‚Äì forts√§tt spela.";
        strongEl.appendChild(li);
      } else {
        strong.forEach((st) => {
          const li = document.createElement("li");
          li.textContent =
            `Delbit ${st.id} ‚Äì ${st.acc}% r√§tt (${st.correct}/${st.total})`;
          strongEl.appendChild(li);
        });
      }

      if (!weak.length) {
        const li = document.createElement("li");
        li.textContent = "Inga tydliga svagheter ‚Äì bra jobbat!";
        weakEl.appendChild(li);
      } else {
        weak.forEach((st) => {
          const li = document.createElement("li");
          li.textContent =
            `Delbit ${st.id} ‚Äì ${st.wrong} fel (${st.correct}/${st.total} r√§tt, ${st.acc}%)`;
          weakEl.appendChild(li);
        });
      }
    }
  }
}

// Skapa JSON-snutt f√∂r elevkortet utifr√•n senaste resultat
function handleGenerateProgressJson() {
  const output = getEl("progressJsonOutput");
  const status = getEl("progressJsonStatus");
  const s = loadState();
  const prog = s.progression || {};

  if (!output) return;

  const last = prog.lastResult || null;
  if (!last) {
    output.value = "";
    if (status) status.textContent = "Ingen spelomg√•ng hittades. Spela en niv√• f√∂rst.";
    return;
  }

  const payload = {
    source: "fangvaktaren",
    version: "v17",
    student: {
      name: s.student.name || "",
      klass: s.student.klass || ""
    },
    result: {
      level: last.level,
      scorePercent: last.score,
      correct: last.correct,
      total: last.total,
      pointsGained: last.pointsGained,
      totalPointsAfter: last.totalPointsAfter,
      timestamp: last.timestamp
    },
    progression: {
      totalPoints: prog.totalPoints || 0,
      best: s.best || {},
      wrongByGoalId: prog.wrongByGoalId || {},
      correctByGoalId: prog.correctByGoalId || {}
    }
  };

  output.value = JSON.stringify(payload, null, 2);
  if (status) status.textContent = "JSON skapad ‚Äì kopiera och klistra in i elevkortet.";
}

function handleCopyProgressJson() {
  const output = getEl("progressJsonOutput");
  const status = getEl("progressJsonStatus");
  if (!output) return;

  const text = output.value || "";
  if (!text.trim()) {
    if (status) status.textContent = "Ingen JSON att kopiera.";
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(
      () => {
        if (status) status.textContent = "Kopierat till urklipp.";
      },
      () => {
        if (status) status.textContent = "Kunde inte kopiera automatiskt ‚Äì markera och kopiera manuellt.";
      }
    );
  } else {
    if (status) status.textContent = "Kunde inte kopiera automatiskt ‚Äì markera och kopiera manuellt.";
  }
}

// Hj√§lpare: uppdatera allt progression-relaterat UI
function updateAllProgressionUI() {
  updateProgressionNotice();
  updateProgressionPanel();
}

// Rensa all elevdata (p√• den h√§r enheten)
function handleClearStudentData() {
  const s = loadState();
  if (!confirm("Detta rensar alla sparade elevuppgifter, highscore och progression p√• DENNA dator. Forts√§tt?")) {
    return;
  }

  s.student = { name: "", klass: "" };
  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];
  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Elevdata rensad p√• denna enhet.";
}

// Nollst√§ll spelpo√§ng & progression men beh√•ll elevnamn / klass
function handleResetGameData() {
  const s = loadState();
  if (!confirm("Detta nollst√§ller po√§ng, progression och highscore men beh√•ller nuvarande elevnamn/klass. Forts√§tt?")) {
    return;
  }

  s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  s.highscores = [];
  saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = getEl("resetStatus");
  if (status) status.textContent = "Spelpo√§ng och progression nollst√§lld.";
}

function syncUI() {
  const s = loadState();
  const hasStudent = !!(s.student.name && s.student.klass);

  const nameInput = getEl("studentName");
  const classInput = getEl("studentClass");
  if (nameInput) nameInput.value = s.student.name || "";
  if (classInput) classInput.value = s.student.klass || "";

  const studentSaved = getEl("studentSaved");
  if (studentSaved) {
    if (hasStudent) {
      studentSaved.textContent = `Sparad: ${s.student.name} (${s.student.klass})`;
    } else {
      studentSaved.textContent = "Ej sparad elev";
    }
  }

  const bestE = getEl("best-levelE");
  const bestC = getEl("best-levelC");
  const bestA = getEl("best-levelA");
  if (bestE) bestE.textContent = (s.best && s.best.E) || 0;
  if (bestC) bestC.textContent = (s.best && s.best.C) || 0;
  if (bestA) bestA.textContent = (s.best && s.best.A) || 0;

  const thresE = getEl("thres-levelE");
  const thresC = getEl("thres-levelC");
  const thresA = getEl("thres-levelA");
  if (thresE && s.thres && typeof s.thres.E === "number") thresE.textContent = s.thres.E;
  if (thresC && s.thres && typeof s.thres.C === "number") thresC.textContent = s.thres.C;
  if (thresA && s.thres && typeof s.thres.A === "number") thresA.textContent = s.thres.A;

  const cardE = getEl("card-levelE");
  const cardC = getEl("card-levelC");
  const cardA = getEl("card-levelA");
  const btnE = getEl("start-levelE");
  const btnC = getEl("start-levelC");
  const btnA = getEl("start-levelA");
  const badgeE = getEl("badge-levelE");
  const badgeC = getEl("badge-levelC");
  const badgeA = getEl("badge-levelA");

  // Niv√• 1 (E)
  if (cardE && btnE && badgeE) {
    if (hasStudent) {
      cardE.classList.remove("locked");
      btnE.disabled = false;
      badgeE.textContent = "Starta";
      badgeE.classList.remove("badge-lock");
      badgeE.classList.add("badge-ok");
    } else {
      cardE.classList.add("locked");
      btnE.disabled = true;
      badgeE.textContent = "L√•st";
      badgeE.classList.remove("badge-ok");
      badgeE.classList.add("badge-lock");
    }
  }

  // Niv√• 2 (C)
  if (cardC && btnC && badgeC) {
    if (s.unlocked && s.unlocked.C) {
      cardC.classList.remove("locked");
      btnC.disabled = false;
      badgeC.textContent = "Uppl√•st";
      badgeC.classList.remove("badge-lock");
      badgeC.classList.add("badge-ok");
    } else {
      cardC.classList.add("locked");
      btnC.disabled = true;
      badgeC.textContent = "L√•st";
      badgeC.classList.remove("badge-ok");
      badgeC.classList.add("badge-lock");
    }
  }

  // Niv√• 3 (A)
  if (cardA && btnA && badgeA) {
    if (s.unlocked && s.unlocked.A) {
      cardA.classList.remove("locked");
      btnA.disabled = false;
      badgeA.textContent = "Uppl√•st";
      badgeA.classList.remove("badge-lock");
      badgeA.classList.add("badge-ok");
    } else {
      cardA.classList.add("locked");
      btnA.disabled = true;
      badgeA.textContent = "L√•st";
      badgeA.classList.remove("badge-ok");
      badgeA.classList.add("badge-lock");
    }
  }

  const who = getEl("whoPlays");
  if (who) {
    who.textContent = hasStudent
      ? `${s.student.name} (${s.student.klass})`
      : "Ingen elev vald.";
  }

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const studentCard = getEl("studentCard");

  const isPlaying = typeof currentLevel !== "undefined" && !!currentLevel;
  const isResultVisible = resultSection && !resultSection.classList.contains("hidden");

  if (studentCard) {
    studentCard.classList.toggle("hidden", isPlaying || isResultVisible);
  }

  updateAllProgressionUI();
}

/* =========================
   4b ‚Äì Spel-logik (fr√•gerendering & niv√•er)
   ========================= */

function renderDragQuestion(q, index, host) {
  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"}) ‚Äì Drag & Drop`;
  container.appendChild(header);

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.flexWrap = "wrap";
  wrapper.style.gap = "12px";
  wrapper.style.marginTop = "6px";

  const sourcesCol = document.createElement("div");
  sourcesCol.style.flex = "1 1 180px";

  const targetsCol = document.createElement("div");
  targetsCol.style.flex = "2 1 260px";

  const srcTitle = document.createElement("div");
  srcTitle.className = "mini";
  srcTitle.textContent = "Kort att dra:";
  sourcesCol.appendChild(srcTitle);

  const srcZone = document.createElement("div");
  srcZone.style.border = "1px dashed #1f2937";
  srcZone.style.borderRadius = "8px";
  srcZone.style.padding = "6px";
  srcZone.style.minHeight = "40px";
  srcZone.style.display = "flex";
  srcZone.style.flexWrap = "wrap";
  srcZone.style.gap = "4px";
  sourcesCol.appendChild(srcZone);

  const tgtTitle = document.createElement("div");
  tgtTitle.className = "mini";
  tgtTitle.textContent = "Kategori-rutor:";
  targetsCol.appendChild(tgtTitle);

  const tgtZone = document.createElement("div");
  tgtZone.style.display = "flex";
  tgtZone.style.flexWrap = "wrap";
  tgtZone.style.gap = "8px";
  targetsCol.appendChild(tgtZone);

  wrapper.appendChild(sourcesCol);
  wrapper.appendChild(targetsCol);
  container.appendChild(wrapper);

  const sources = Array.isArray(q.dragSources) ? q.dragSources : [];
  const targets = Array.isArray(q.dragTargets) ? q.dragTargets : [];
  const answers = {};
  currentAnswers[index] = answers;

  function makeDraggableChip(src) {
    const chip = document.createElement("div");
    chip.textContent = src.label;
    chip.draggable = true;
    chip.dataset.itemId = src.id;
    chip.className = "chip";
    chip.style.cursor = "grab";
    chip.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", src.id);
    });
    return chip;
  }

  function setupDropTarget(el, targetId) {
    el.addEventListener("dragover", (ev) => {
      ev.preventDefault();
    });
    el.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      el.appendChild(existing);

      if (targetId === null) {
        delete answers[itemId];
      } else {
        answers[itemId] = targetId;
      }
    });
  }

  setupDropTarget(srcZone, null);

  sources.forEach((src) => {
    const chip = makeDraggableChip(src);
    srcZone.appendChild(chip);
  });

  targets.forEach((tgt) => {
    const box = document.createElement("div");
    box.style.border = "1px solid #1f2937";
    box.style.borderRadius = "8px";
    box.style.padding = "6px";
    box.style.minHeight = "46px";
    box.style.minWidth = "110px";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "4px";

    const cap = document.createElement("div");
    cap.className = "mini";
    cap.textContent = tgt.label;
    box.appendChild(cap);

    const slot = document.createElement("div");
    slot.style.display = "flex";
    slot.style.flexWrap = "wrap";
    slot.style.gap = "4px";
    box.appendChild(slot);

    box.addEventListener("dragover", (ev) => {
      ev.preventDefault();
    });
    box.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;
      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;
      slot.appendChild(existing);
      answers[itemId] = tgt.id;
    });

    tgtZone.appendChild(box);
  });

  host.appendChild(container);
}

function renderQuestionItem(q, index, host) {
  if (q.type === "drag") {
    renderDragQuestion(q, index, host);
    return;
  }

  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"})`;
  container.appendChild(header);

  if (q.type === "img" && q.imgDataUrl) {
    const img = document.createElement("img");
    img.src = q.imgDataUrl;
    img.alt = "Bildfr√•ga";
    container.appendChild(img);
  }

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const optionsList = document.createElement("div");
  optionsList.className = "options-list";
  (q.options || []).forEach((opt, optIndex) => {
    const label = document.createElement("label");
    label.className = "option-label";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = `q-${index}`;
    input.value = String(optIndex);
    input.addEventListener("change", () => {
      currentAnswers[index] = optIndex;
    });

    const span = document.createElement("span");
    span.textContent = opt;

    label.appendChild(input);
    label.appendChild(span);
    optionsList.appendChild(label);
  });
  container.appendChild(optionsList);

  host.appendChild(container);
}

function startLevel(level) {
  if (!ensureStudentSet()) return;

  const s = loadState();
  const allQuestions = []
    .concat(s.bank.mcq || [])
    .concat(s.bank.img || [])
    .concat(s.bank.drag || []);

  const pool = allQuestions.filter((q) => (q.level || "E") === level);
  if (!pool.length) {
    alert("Det finns inga fr√•gor p√• denna niv√• √§nnu.");
    return;
  }

  currentLevel = level;
  currentQuestions = shuffle(pool);
  currentAnswers = new Array(currentQuestions.length).fill(null);

  const playSection = getEl("play");
  const resultSection = getEl("result");
  const questionsHost = getEl("questions");

  if (resultSection) resultSection.classList.add("hidden");
  if (playSection) playSection.classList.remove("hidden");
  if (questionsHost) {
    questionsHost.innerHTML = "";
    currentQuestions.forEach((q, idx) => renderQuestionItem(q, idx, questionsHost));
  }

  const title = getEl("play-title");
  const who = getEl("whoPlays");
  if (title) {
    if (level === "E") title.textContent = "Niv√• 1 ‚Äì Grundniv√• (E)";
    else if (level === "C") title.textContent = "Niv√• 2 ‚Äì Mellanniv√• (C)";
    else title.textContent = "Niv√• 3 ‚Äì Avancerad (A)";
  }
  if (who) {
    who.textContent = `${s.student.name} (${s.student.klass})`;
  }

  syncUI();
}

function finishLevel() {
  if (!currentLevel || !currentQuestions.length) {
    alert("Ingen niv√• √§r aktiv.");
    return;
  }

  const s = loadState();
  const goals = s.goalsMap || [];
  let correctCount = 0;
  let pointsGained = 0;
  let allCorrect = true;

  if (!s.progression || typeof s.progression !== "object") {
    s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {}, lastResult: null };
  }
  s.progression.totalPoints = s.progression.totalPoints || 0;
  s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
  s.progression.correctByGoalId = s.progression.correctByGoalId || {};

  const wrongByGoal = s.progression.wrongByGoalId;
  const correctByGoal = s.progression.correctByGoalId;

  const lvl = currentLevel;
  const basePointsPerQuestion =
    lvl === "A" ? 3 :
    lvl === "C" ? 2 : 1;

  currentQuestions.forEach((q, index) => {
    const ansVal = currentAnswers[index];
    let isCorrect = false;

    if (q.type === "drag") {
      const correctMap = q.correctMap || {};
      const keys = Object.keys(correctMap);
      if (!keys.length) {
        isCorrect = false;
      } else if (!ansVal || typeof ansVal !== "object") {
        isCorrect = false;
      } else {
        let allOk = true;
        for (const itemId of keys) {
          if (!ansVal[itemId] || ansVal[itemId] !== correctMap[itemId]) {
            allOk = false;
            break;
          }
        }
        isCorrect = allOk;
      }
    } else {
      if (ansVal != null) {
        const correctIndex = typeof q.answer === "number" ? q.answer : q.correct;
        isCorrect = ansVal === correctIndex;
      } else {
        isCorrect = false;
      }
    }

    if (isCorrect) {
      correctCount++;
      pointsGained += basePointsPerQuestion;
    } else {
      allCorrect = false;
    }

    const links = getLinksForQuestion(q, goals);
    if (links && links.length) {
      links.forEach((lnk) => {
        const key = String(lnk.id);
        if (isCorrect) {
          correctByGoal[key] = (correctByGoal[key] || 0) + 1;
        } else {
          wrongByGoal[key] = (wrongByGoal[key] || 0) + 1;
        }
      });
    }
  });

  const total = currentQuestions.length;
  const percentage = total ? Math.round((correctCount / total) * 100) : 0;
  const threshold = (s.thres && s.thres[lvl] != null) ? s.thres[lvl] : 70;

  if (!s.best) s.best = { E: 0, C: 0, A: 0 };
  if (percentage > (s.best[lvl] || 0)) {
    s.best[lvl] = percentage;
  }

  if (!s.unlocked) s.unlocked = { C: false, A: false };
  if (lvl === "E" && percentage >= threshold) s.unlocked.C = true;
  if (lvl === "C" && percentage >= threshold) s.unlocked.A = true;

  // Bonus +5p om alla r√§tt p√• niv√•n
  if (total > 0 && allCorrect) {
    pointsGained += 5;
  }

  s.progression.totalPoints += pointsGained;
  const totalPointsAfter = s.progression.totalPoints;

  const nowIso = new Date().toISOString();
  const lastResult = {
    level: lvl,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    timestamp: nowIso
  };
  s.progression.lastResult = lastResult;

  // Uppdatera lokal highscore f√∂r denna elev
  if (!Array.isArray(s.highscores)) s.highscores = [];
  const id = (s.student.name || "Elev") + "||" + (s.student.klass || "-");
  const newEntry = {
    id,
    name: s.student.name || "Elev",
    klass: s.student.klass || "-",
    points: totalPointsAfter,
    level: lvl,
    score: percentage,
    updatedAt: nowIso
  };
  const idx = s.highscores.findIndex((e) => e.id === id);
  if (idx >= 0) {
    if ((newEntry.points || 0) >= (s.highscores[idx].points || 0)) {
      s.highscores[idx] = newEntry;
    }
  } else {
    s.highscores.push(newEntry);
  }

  saveState(s);

  // Global lastSubmission f√∂r e-postfunktionen
  lastSubmission = {
    level: lvl,
    studentName: s.student.name,
    studentClass: s.student.klass,
    timestamp: nowIso,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    answers: currentAnswers.slice(),
    questions: currentQuestions.map((q) => ({
      q: q.q || q.text || "",
      type: q.type || "mcq",
      level: q.level || lvl,
      answer: typeof q.answer === "number" ? q.answer : q.correct,
      goal: q.goal || null,
      parts: q.parts || null
    }))
  };

  const playSection = getEl("play");
  const resultSection = getEl("result");
  if (playSection) playSection.classList.add("hidden");
  if (resultSection) resultSection.classList.remove("hidden");

  const scoreText = getEl("scoreText");
  const scoreDetail = getEl("scoreDetail");
  const resName = getEl("resName");
  const resClass = getEl("resClass");
  const passBadge = getEl("passBadge");
  const unlockText = getEl("unlockText");

  if (scoreText) scoreText.innerHTML = `${percentage}%<span> resultat</span>`;
  if (scoreDetail) {
    scoreDetail.textContent =
      `${correctCount}/${total} r√§tt ‚Äì niv√•po√§ng: +${pointsGained}p, totalt: ${totalPointsAfter}p`;
  }
  if (resName) resName.textContent = s.student.name || "-";
  if (resClass) resClass.textContent = s.student.klass || "-";

  if (passBadge) {
    const passed = percentage >= threshold;
    if (passed) {
      passBadge.className = "badge-pass";
      passBadge.textContent = "Godk√§nd niv√•";
    } else {
      passBadge.className = "badge-fail";
      passBadge.textContent = "Inte godk√§nd √§nnu";
    }
  }

  if (unlockText) {
    let txt = "";
    if (lvl === "E" && s.unlocked.C) txt = "Niv√• 2 (C) √§r nu uppl√•st.";
    else if (lvl === "C" && s.unlocked.A) txt = "Niv√• 3 (A) √§r nu uppl√•st.";
    unlockText.textContent = txt;
  }

  currentLevel = null;
  currentQuestions = [];
  currentAnswers = [];

  updateAllProgressionUI();
  syncUI();
}
</script>
<!-- slut SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->






<!-- start SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post, l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->
<script>
"use strict";

/* Hj√§lpfunktion f√∂r att slippa getElementById √∂verallt */
function getEl(id) {
  return document.getElementById(id);
}

/* =========================
   5a ‚Äì E-postinl√§mning
   ========================= */

function emailResultToTeacher() {
  if (!lastSubmission) {
    alert("Det finns inget resultat att skicka. Spela en niv√• f√∂rst.");
    return;
  }
  const s = loadState();
  const inputEmail = getEl("inputTeacherEmail");
  const teacherEmail =
    s.teacherEmail ||
    (inputEmail && inputEmail.value.trim()) ||
    "";

  if (!teacherEmail) {
    alert("Ingen l√§rar-e-post √§r sparad. G√• till Inst√§llningar och fyll i 'L√§rarens e-post'.");
    return;
  }

  const jsonText = JSON.stringify(lastSubmission, null, 2);
  const subject = `F√•ngvaktaren ‚Äì resultat ${lastSubmission.studentName || "Elev"} (${lastSubmission.studentClass || ""})`;
  const body =
    `Hej!\n\n` +
    `H√§r kommer resultat fr√•n F√•ngvaktaren.\n\n` +
    `Elev: ${lastSubmission.studentName || "-"} (${lastSubmission.studentClass || "-"})\n` +
    `Niv√•: ${lastSubmission.level}\n` +
    `Resultat: ${lastSubmission.score}% (${lastSubmission.correct}/${lastSubmission.total} r√§tt)\n` +
    `Po√§ng denna niv√•: ${lastSubmission.pointsGained || 0}p\n` +
    `Totala progressionpo√§ng efter denna omg√•ng: ${lastSubmission.totalPointsAfter || 0}p\n` +
    `Datum: ${new Date(lastSubmission.timestamp).toLocaleString("sv-SE")}\n\n` +
    `JSON-data (f√∂r elevkort / dokumentation):\n` +
    `${jsonText}\n\n` +
    `V√§nliga h√§lsningar\n` +
    `${lastSubmission.studentName || "Elev"}`;

  const mailtoLink =
    `mailto:${encodeURIComponent(teacherEmail)}` +
    `?subject=${encodeURIComponent(subject)}` +
    `&body=${encodeURIComponent(body)}`;

  window.location.href = mailtoLink;
}

/* =========================
   5b ‚Äì L√§rarl√∂senord & status
   ========================= */

function showTeacherPasswordInStatus() {
  const s = loadState();
  const statusEl = getEl("passwordStatus");
  if (statusEl && s.teacherPassword) {
    statusEl.textContent = `Aktuellt l√§rarl√∂senord: ${s.teacherPassword}`;
  } else if (statusEl) {
    statusEl.textContent = "";
  }
}

/* =========================
   5c ‚Äì L√§rarl√§ge: gate + modal
   ========================= */

function openTeacherGate() {
  const gate = getEl("teacherGate");
  const input = getEl("teacherPasswordInput");
  const text = getEl("teacherGateText");
  const s = loadState();

  if (gate) gate.classList.remove("hidden");
  if (input) {
    input.value = "";
    input.type = "password";
    input.focus();
  }

  if (text) {
    if (s.teacherPassword) {
      text.textContent = "Ange l√§rarl√∂senord f√∂r att √∂ppna l√§rarl√§get.";
    } else {
      text.textContent = "F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.";
    }
  }
}

function closeTeacherGate() {
  const gate = getEl("teacherGate");
  if (gate) gate.classList.add("hidden");
}

function openTeacherModal() {
  const modal = getEl("teacherModal");
  if (modal) modal.classList.remove("hidden");
}

function closeTeacherModal() {
  const modal = getEl("teacherModal");
  if (modal) modal.classList.add("hidden");
}

function handleTeacherConfirm() {
  const input = getEl("teacherPasswordInput");
  const text = getEl("teacherGateText");
  if (!input) return;

  const entered = input.value.trim();
  if (!entered) {
    alert("Skriv in ett l√∂senord.");
    return;
  }

  const s = loadState();

  // F√∂rsta g√•ngen: s√§tt l√∂senordet
  if (!s.teacherPassword) {
    s.teacherPassword = entered;
    saveState(s);
    showTeacherPasswordInStatus();
    if (text) text.textContent = "L√∂senord sparat. √ñppnar l√§rarl√§ge.";
    closeTeacherGate();
    openTeacherModal();
    return;
  }

  // Efter√•t: kontrollera l√∂senordet
  if (s.teacherPassword === entered) {
    if (text) text.textContent = "L√∂senord OK. √ñppnar l√§rarl√§ge.";
    closeTeacherGate();
    openTeacherModal();
  } else {
    if (text) text.textContent = "Fel l√∂senord. F√∂rs√∂k igen.";
    input.value = "";
    input.focus();
  }
}

/* =========================
   5d ‚Äì Fliknavigering i l√§rarmodal
   ========================= */

function setupTabNavigation() {
  const tabButtons = document.querySelectorAll(".tab-btn");
  const panels = document.querySelectorAll(".tab-panel");

  if (!tabButtons.length || !panels.length) return;

  function activateTab(tabId) {
    tabButtons.forEach((btn) => {
      const isActive = btn.getAttribute("data-tab") === tabId;
      if (isActive) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    });

    panels.forEach((panel) => {
      const panelId = panel.getAttribute("data-panel");
      const shouldShow = panelId === tabId;
      panel.classList.toggle("hidden", !shouldShow);
    });
  }

  tabButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tabId = btn.getAttribute("data-tab");
      if (!tabId) return;
      activateTab(tabId);
    });
  });

  // S√§kerst√§ll att "settings" √§r aktiv som start (om den finns)
  const defaultTab = document.querySelector('.tab-btn[data-tab="settings"]');
  if (defaultTab) {
    activateTab("settings");
  }
}

/* =========================
   5e ‚Äì Bankstatus (UI)
   ========================= */

function updateBankStatusUI() {
  const listEl = getEl("cloudBankList");
  if (!listEl) return;

  // Hitta kortet runt "Ladda fr√•gebank fr√•n molnet"
  const hostCard = listEl.closest(".card");
  if (!hostCard) return;

  let statusEl = getEl("bankStatus");
  if (!statusEl) {
    statusEl = document.createElement("p");
    statusEl.id = "bankStatus";
    statusEl.className = "mini";
    statusEl.style.marginTop = "6px";
    // L√§gg status-raden precis ovanf√∂r listan med moln-bankar
    hostCard.insertBefore(statusEl, listEl);
  }

  const s = loadState();
  const bank = s.bank || {};
  const mcqCount = Array.isArray(bank.mcq) ? bank.mcq.length : 0;
  const imgCount = Array.isArray(bank.img) ? bank.img.length : 0;
  const dragCount = Array.isArray(bank.drag) ? bank.drag.length : 0;
  const total = mcqCount + imgCount + dragCount;

  if (!total) {
    statusEl.textContent = "Status: Ingen fr√•gebank laddad.";
  } else {
    statusEl.textContent =
      `Status: Aktiv bank med ${total} fr√•gor ` +
      `(MCQ: ${mcqCount}, bild: ${imgCount}, drag & drop: ${dragCount}).`;
  }
}

/* =========================
   5f ‚Äì Initiering & knappar
   ========================= */

function initApp() {
  console.log("initApp start");

  // 1. S√§kerst√§ll fr√•gebank (merga embedded-data om tom)
  let s = loadState();
  const hasBank =
    s.bank &&
    (
      (Array.isArray(s.bank.mcq) && s.bank.mcq.length) ||
      (Array.isArray(s.bank.img) && s.bank.img.length) ||
      (Array.isArray(s.bank.drag) && s.bank.drag.length)
    );

  if (!hasBank && typeof mergeEmbeddedBank === "function") {
    console.log("Ingen lokal bank ‚Äì mergar embedded-data");
    s = mergeEmbeddedBank(s);
    saveState(s);
  }

  // 2. Initiera inst√§llningsdelar om de finns
  if (typeof initTeacherEmailSettings === "function") initTeacherEmailSettings();
  if (typeof initThresholdSettings === "function") initThresholdSettings();
  if (typeof initTeacherPasswordSettings === "function") initTeacherPasswordSettings();
  showTeacherPasswordInStatus();

  if (typeof initGoalsMap === "function") initGoalsMap();
  if (typeof initQuestionForms === "function") initQuestionForms();
  if (typeof initImageQuestionsEditor === "function") initImageQuestionsEditor();
  if (typeof initDragDropQuestionsEditor === "function") initDragDropQuestionsEditor();

  // Fliknavigering
  setupTabNavigation();

  if (typeof setupCloudBankUI === "function") setupCloudBankUI();
  if (typeof syncUI === "function") syncUI();

  // Uppdatera visuell bankstatus
  updateBankStatusUI();

  /* ---------- Elevyta: knappar ---------- */

  const btnSaveStudent = getEl("btnSaveStudent");
  if (btnSaveStudent) {
    btnSaveStudent.addEventListener("click", handleSaveStudent);
  }

  const btnStartE = getEl("start-levelE");
  const btnStartC = getEl("start-levelC");
  const btnStartA = getEl("start-levelA");
  if (btnStartE) btnStartE.addEventListener("click", () => startLevel("E"));
  if (btnStartC) btnStartC.addEventListener("click", () => startLevel("C"));
  if (btnStartA) btnStartA.addEventListener("click", () => startLevel("A"));

  const btnFinish = getEl("btnFinish");
  if (btnFinish) btnFinish.addEventListener("click", finishLevel);

  const btnBack = getEl("btnBack");
  if (btnBack) {
    btnBack.addEventListener("click", () => {
      const result = getEl("result");
      const play = getEl("play");
      if (result) result.classList.add("hidden");
      if (play) play.classList.add("hidden");
      const studentCard = getEl("studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      if (typeof syncUI === "function") syncUI();
    });
  }

  const btnCancel = getEl("btnCancel");
  if (btnCancel) {
    btnCancel.addEventListener("click", () => {
      if (typeof currentLevel !== "undefined") currentLevel = null;
      if (typeof currentQuestions !== "undefined") currentQuestions = [];
      if (typeof currentAnswers !== "undefined") currentAnswers = [];
      const play = getEl("play");
      const result = getEl("result");
      if (play) play.classList.add("hidden");
      if (result) result.classList.add("hidden");
      const studentCard = getEl("studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      if (typeof syncUI === "function") syncUI();
    });
  }

  const btnSubmitGame = getEl("btnSubmitGame");
  if (btnSubmitGame) {
    btnSubmitGame.addEventListener("click", emailResultToTeacher);
  }

  /* ---------- L√§rarl√§ge: knappar ---------- */

  const btnTeacherMode = getEl("btnTeacherMode");
  if (btnTeacherMode) {
    btnTeacherMode.addEventListener("click", openTeacherGate);
  }

  const btnTeacherCancel = getEl("btnTeacherCancel");
  if (btnTeacherCancel) {
    btnTeacherCancel.addEventListener("click", closeTeacherGate);
  }

  const btnTeacherConfirm = getEl("btnTeacherConfirm");
  if (btnTeacherConfirm) {
    btnTeacherConfirm.addEventListener("click", handleTeacherConfirm);
  }

  const btnCloseTeacher = getEl("btnCloseTeacher");
  if (btnCloseTeacher) {
    btnCloseTeacher.addEventListener("click", closeTeacherModal);
  }

  /* ---------- Inst√§llningar: tr√∂sklar, e-post, l√∂sen ---------- */

  const btnSaveThresholds = getEl("btnSaveThresholds");
  if (btnSaveThresholds && typeof handleSaveThresholds === "function") {
    btnSaveThresholds.addEventListener("click", handleSaveThresholds);
  }

  const btnSaveTeacherEmail = getEl("btnSaveTeacherEmail");
  if (btnSaveTeacherEmail && typeof handleSaveTeacherEmail === "function") {
    btnSaveTeacherEmail.addEventListener("click", handleSaveTeacherEmail);
  }

  const btnChangeTeacherPassword = getEl("btnChangeTeacherPassword");
  if (btnChangeTeacherPassword && typeof handleChangeTeacherPassword === "function") {
    btnChangeTeacherPassword.addEventListener("click", handleChangeTeacherPassword);
  }

  /* ---------- Delm√•l/delbitar ---------- */

  const btnAddGoalPart = getEl("btnAddGoalPart");
  if (btnAddGoalPart && typeof handleAddGoalPart === "function") {
    btnAddGoalPart.addEventListener("click", handleAddGoalPart);
  }

  const btnSaveGoalsMap = getEl("btnSaveGoalsMap");
  if (btnSaveGoalsMap && typeof handleSaveGoalsMap === "function") {
    btnSaveGoalsMap.addEventListener("click", handleSaveGoalsMap);
  }

  const btnClearGoalsMap = getEl("btnClearGoalsMap");
  if (btnClearGoalsMap && typeof handleClearGoalsMap === "function") {
    btnClearGoalsMap.addEventListener("click", handleClearGoalsMap);
  }

  /* ---------- Fr√•gebank & Firebase ---------- */

  const btnLoadCloudBanks = getEl("btnLoadCloudBanks");
  if (btnLoadCloudBanks && typeof handleLoadCloudBanks === "function") {
    btnLoadCloudBanks.addEventListener("click", () => {
      handleLoadCloudBanks();
      updateBankStatusUI();
    });
  }

  const btnSaveToCloud = getEl("btnSaveToCloud");
  if (btnSaveToCloud && typeof handleSaveToCloud === "function") {
    btnSaveToCloud.addEventListener("click", () => {
      handleSaveToCloud();
      // Efter ev. √§ndringar i bank ‚Äì uppdatera status
      updateBankStatusUI();
    });
  }

  const btnExportBank = getEl("btnExportBank");
  if (btnExportBank && typeof handleExportBank === "function") {
    btnExportBank.addEventListener("click", () => {
      handleExportBank();
      // Export √§ndrar inte banken, men det √§r ofarligt att fr√§scha status
      updateBankStatusUI();
    });
  }

  const fileImport = getEl("fileImport");
  if (fileImport && typeof handleImportBank === "function") {
    fileImport.addEventListener("change", (evt) => {
      handleImportBank(evt);
      updateBankStatusUI();
    });
  }

  const btnGoogleLogin = getEl("btnGooglePlaceholder");
  if (btnGoogleLogin && typeof handleGoogleLogin === "function") {
    btnGoogleLogin.addEventListener("click", handleGoogleLogin);
  }

  const btnGoogleLogout = getEl("btnGoogleLogout");
  if (btnGoogleLogout && typeof handleGoogleLogout === "function") {
    btnGoogleLogout.addEventListener("click", handleGoogleLogout);
  }

  console.log("initApp klar ‚Äì knappar kopplade");
}

/* =========================
   5g ‚Äì DOMContentLoaded
   ========================= */

document.addEventListener("DOMContentLoaded", function () {
  if (typeof initFirebase === "function") {
    try {
      initFirebase();
      console.log("Firebase init OK");
    } catch (e) {
      console.error("Fel vid initFirebase:", e);
    }
  }

  try {
    initApp();
  } catch (e) {
    console.error("Fel vid initApp:", e);
  }
});
</script>
<!-- slut SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post, l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->




<!-- start SEKTION 6: AVSLUTANDE TAGGAR -->
</body>
</html>
<!-- slut SEKTION 6: AVSLUTANDE TAGGAR -->
