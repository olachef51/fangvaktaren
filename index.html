<!-- start SEKTION 1: HEAD & STIL -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>F√•ngvaktaren ‚Äì Progressionsspel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --accent-e:#b45309;
      --accent-c:#2563eb;
      --accent-a:#7c3aed;
      --accent-danger:#ef4444;
      --accent-info:#38bdf8;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --chip:#020617;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#0b1120 0,#020617 60%,#020617 100%);
      color:var(--text);
    }
    body{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:960px;
      background:rgba(15,23,42,0.96);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 18px 45px rgba(0,0,0,0.7);
      padding:18px 18px 22px;
      position:relative;
      overflow:hidden;
    }
    .app::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0 0,rgba(180,83,9,0.18),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(37,99,235,0.20),transparent 55%),
        radial-gradient(circle at 50% 100%,rgba(124,58,237,0.18),transparent 60%);
      opacity:0.9;
      pointer-events:none;
      z-index:-1;
    }

    .goal-tag{
  display:inline-block;
  padding:2px 6px;
  border-radius:999px;
  background:var(--card,#020617);
  color:var(--text,#e5e7eb);
  border:1px solid var(--border,#1f2937);
  font-size:0.75rem;
  margin:1px 3px 0 0;
  white-space:normal;
}

.chip{
  display:inline-flex;
  align-items:center;
  padding:2px 8px;
  border-radius:999px;
  background:var(--card,#020617);   /* m√∂rk bakgrund som resten av spelet */
  color:var(--text,#e5e7eb);        /* ljus text */
  border:1px solid var(--border,#1f2937);
  font-size:0.75rem;
  margin:2px 4px 0 0;
  cursor:pointer;
  white-space:nowrap;
}

.chip:hover{
  background:#111827;
}

.goal-tag.goal-tag-none{
  opacity:0.7;
  font-style:italic;
}

    .app-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .title-block h1{
      margin:0;
      font-size:1.4rem;
      letter-spacing:0.04em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .title-block h1 span.logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:26px;
      height:26px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0,var(--accent-e),#92400e);
      box-shadow:0 0 18px rgba(180,83,9,0.6);
      font-size:1.1rem;
    }
    .subtitle{
      margin:4px 0 0;
      font-size:0.82rem;
      color:var(--muted);
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      color:var(--text);
      font-size:0.8rem;
      padding:6px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      line-height:1.3;
      white-space:nowrap;
    }
    .btn:hover{
      border-color:var(--accent-info);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .btn-primary{
      border-color:var(--accent-info);
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#0b1120;
      font-weight:600;
    }
    .btn-danger{
      border-color:var(--accent-danger);
      color:#fecaca;
    }
    .btn-sm{padding:4px 9px;font-size:0.75rem;}

    .student-card{
      margin-bottom:16px;
      padding:12px 12px 10px;
      border-radius:14px;
      background:radial-gradient(circle at 0 0,#111827,#020617);
      border:1px solid rgba(148,163,184,0.35);
    }
    .student-card .row{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:6px;
    }
    .student-card label{
      font-size:0.78rem;
      color:var(--muted);
      display:block;
      margin-bottom:2px;
    }
    .student-card .field{
      flex:1 1 auto;
      min-width:0;
    }
    .input{
      width:100%;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.82rem;
    }
    .input:focus{
      outline:none;
      border-color:var(--accent-info);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .student-status{
      font-size:0.78rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:2px;
      flex-wrap:wrap;
    }

    .levels-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      margin-bottom:16px;
      transition:opacity 0.15s ease;
    }
    @media (max-width:780px){
      .levels-grid{
        grid-template-columns:1fr;
      }
      .app-header{
        flex-direction:column;
        align-items:flex-start;
      }
    }
    .level-card{
      border-radius:14px;
      padding:11px 11px 10px;
      background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(15,23,42,0.96));
      border:1px solid rgba(31,41,55,0.9);
      position:relative;
      overflow:hidden;
      transform:translateY(0);
      transition:transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }
    .level-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      opacity:0.7;
      pointer-events:none;
      z-index:-1;
    }
    .level-card:hover{
      transform:translateY(-2px);
      box-shadow:0 0 18px rgba(15,23,42,0.9);
    }
    .level-card.level-e{
      border-color:rgba(180,83,9,0.8);
      background:radial-gradient(circle at 0 0,rgba(180,83,9,0.35),rgba(15,23,42,0.96));
      box-shadow:0 0 18px rgba(180,83,9,0.35);
    }
    .level-card.level-c{
      border-color:rgba(37,99,235,0.9);
      background:radial-gradient(circle at 0 0,rgba(37,99,235,0.40),rgba(15,23,42,0.96));
      box-shadow:0 0 18px rgba(37,99,235,0.45);
    }
    .level-card.level-a{
      border-color:rgba(124,58,237,0.9);
      background:radial-gradient(circle at 0 0,rgba(124,58,237,0.45),rgba(15,23,42,0.96));
      box-shadow:0 0 18px rgba(124,58,237,0.55);
    }
    .level-e::before{
      background:radial-gradient(circle at 0 0,rgba(180,83,9,0.45),transparent 60%);
    }
    .level-c::before{
      background:radial-gradient(circle at 0 0,rgba(37,99,235,0.50),transparent 60%);
    }
    .level-a::before{
      background:radial-gradient(circle at 0 0,rgba(124,58,237,0.55),transparent 60%);
    }
    .level-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:4px;
      margin-bottom:4px;
    }
    .level-title{
      font-size:0.9rem;
      font-weight:600;
      display:flex;
      flex-direction:column;
      gap:0;
    }
    .level-title small{
      font-size:0.72rem;
      color:var(--muted);
      font-weight:400;
    }
    .badge{
      font-size:0.7rem;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.9);
      white-space:nowrap;
    }
    .badge-ok{
      border-color:var(--accent-e);
      color:#fed7aa;
      background:rgba(180,83,9,0.35);
      box-shadow:0 0 10px rgba(180,83,9,0.5);
    }
    .badge-warn{
      border-color:var(--accent-c);
      color:#bfdbfe;
      background:rgba(37,99,235,0.25);
    }
    .badge-lock{
      border-color:var(--accent-danger);
      color:#fecaca;
      background:rgba(248,113,113,0.18);
    }
    .level-body{
      font-size:0.78rem;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:6px;
    }
    .level-body strong{color:var(--text);}
    .level-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .level-footer .hint{
      font-size:0.7rem;
      color:var(--muted);
    }
    .level-card.locked{
      opacity:0.55;
      box-shadow:none;
    }

    .play-panel{
      margin-top:6px;
      padding:10px 10px 10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.8);
      background:radial-gradient(circle at 0 0,#020617,#020617);
    }
    .play-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .play-header h2{
      margin:0;
      font-size:0.98rem;
    }
    .play-header small{
      font-size:0.74rem;
      color:var(--muted);
    }
    .questions{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:360px;
      overflow-y:auto;
      padding-right:4px;
      margin-bottom:6px;
    }
    .question{
      border-radius:10px;
      border:1px solid rgba(55,65,81,0.9);
      padding:8px 9px 7px;
      background:#020617;
      font-size:0.8rem;
    }
    .question > div:first-child{
      margin-bottom:4px;
    }
    .question img{
      max-width:100%;
      max-height:200px;
      border-radius:10px;
      display:block;
      margin-bottom:6px;
    }
    .options-list{
      display:flex;
      flex-direction:column;
      gap:3px;
      margin-top:2px;
    }
    .option-label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.78rem;
      cursor:pointer;
    }
    .option-label input{
      accent-color:#38bdf8;
    }
    .mini{
      font-size:0.72rem;
      color:var(--muted);
    }

    .play-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .play-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .result-panel{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.8);
      background:radial-gradient(circle at 100% 0,#020617,#020617);
      font-size:0.82rem;
    }
    .result-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
      margin-bottom:6px;
    }
    .score{
      font-size:1.3rem;
      font-weight:700;
    }
    .score span{
      font-size:0.8rem;
      color:var(--muted);
      font-weight:400;
      margin-left:4px;
    }
    .badge-pass{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:8px 18px;
      font-size:0.9rem;
      font-weight:700;
      border:none;
      background:linear-gradient(135deg,#22c55e,#0ea5e9);
      color:#022c22;
      gap:6px;
      box-shadow:0 0 20px rgba(34,197,94,0.6);
      text-transform:uppercase;
      letter-spacing:0.03em;
      animation:badgePop 0.7s ease-out;
    }
    .badge-pass::before{
      content:"‚úÖ";
      font-size:1rem;
    }
    .badge-fail{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:4px 9px;
      font-size:0.76rem;
      border:1px solid var(--accent-danger);
      color:#fecaca;
      background:rgba(248,113,113,0.12);
      gap:4px;
    }
    .result-meta{
      font-size:0.76rem;
      color:var(--muted);
      margin-top:2px;
    }
    .result-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .gate-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .gate-box{
      width:100%;
      max-width:340px;
      background:#020617;
      border-radius:16px;
      border:1px solid rgba(75,85,99,0.9);
      padding:14px 14px 12px;
      box-shadow:0 18px 45px rgba(0,0,0,0.85);
      font-size:0.82rem;
    }
    .gate-box h2{
      margin:0 0 6px;
      font-size:1rem;
    }
    .gate-box p{
      margin:0 0 8px;
      color:var(--muted);
      font-size:0.78rem;
    }
    .gate-actions{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:8px;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.92);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal{
      width:100%;
      max-width:880px;
      max-height:90vh;
      background:#020617;
      border-radius:18px;
      border:1px solid rgba(75,85,99,0.9);
      box-shadow:0 24px 60px rgba(0,0,0,0.9);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      font-size:0.82rem;
    }
    .modal-header{
      padding:10px 12px 8px;
      border-bottom:1px solid #1f2937;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .modal-header h2{
      margin:0;
      font-size:0.98rem;
    }
    .modal-header small{
      font-size:0.76rem;
      color:var(--muted);
      display:block;
    }
    .modal-body{
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }
    .tab-nav{
      display:flex;
      gap:6px;
      padding:6px 8px;
      border-bottom:1px solid #1f2937;
      background:#020617;
      flex-wrap:wrap;
    }
    .tab-btn{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:#020617;
      color:var(--muted);
      padding:5px 6px;
      font-size:0.78rem;
      cursor:pointer;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tab-btn.active{
      color:#e5e7eb;
      border-color:#38bdf8;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,0.25),#020617);
    }
    .tab-content{
      flex:1;
      min-height:0;
      padding:9px 10px 10px;
      overflow-y:auto;
    }

    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
    }

    .card{
      border-radius:12px;
      border:1px solid rgba(55,65,81,0.9);
      padding:8px 9px 8px;
      background:#020617;
    }
    .card h3{
      margin:0 0 4px;
      font-size:0.86rem;
    }
    .card p{
      margin:0 0 6px;
      font-size:0.76rem;
      color:var(--muted);
    }
    .card-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
    }
    .card-row .field{
      flex:1 1 auto;
      min-width:0;
    }

    .small-label{
      font-size:0.74rem;
      color:var(--muted);
      display:block;
      margin-bottom:2px;
    }
    .input-number{
      width:100%;
      padding:5px 7px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.8rem;
    }

    .list{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:5px;
    }
    .list-item{
      border-radius:9px;
      border:1px solid #1f2937;
      background:#020617;
      padding:6px 7px 5px;
      display:flex;
      justify-content:space-between;
      gap:6px;
      font-size:0.78rem;
    }
    .list-main{
      flex:1;
      min-width:0;
    }
    .list-main .q-text{
      font-weight:600;
      margin-bottom:2px;
    }
    .list-main .q-meta{
      font-size:0.72rem;
      color:var(--muted);
    }
    .level-tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0 6px;
      border-radius:999px;
      font-size:0.7rem;
      margin-left:4px;
      border:1px solid rgba(148,163,184,0.6);
    }
    .level-tag.level-e{
      border-color:var(--accent-e);
      color:#fed7aa;
      background:rgba(180,83,9,0.18);
    }
    .level-tag.level-c{
      border-color:var(--accent-c);
      color:#bfdbfe;
      background:rgba(37,99,235,0.14);
    }
    .level-tag.level-a{
      border-color:var(--accent-a);
      color:#ddd6fe;
      background:rgba(124,58,237,0.18);
    }

    select{
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:0.78rem;
      padding:4px 7px;
    }

    .hidden{
      display:none;
    }

    .modal-backdrop.hidden{
      display:none;
    }

    .gate-backdrop.hidden{
      display:none;
    }

    .sub-tab-nav{
      display:flex;
      gap:6px;
      margin-bottom:6px;
    }
    .sub-tab-btn{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:#020617;
      color:var(--muted);
      padding:4px 6px;
      font-size:0.78rem;
      cursor:pointer;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub-tab-btn.active{
      color:#e5e7eb;
      border-color:#38bdf8;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,0.25),#020617);
    }
    .sub-tab-panel.hidden{
      display:none;
    }

    .textarea{
      width:100%;
      min-height:120px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.8rem;
      padding:6px 8px;
      resize:vertical;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .img-preview-box{
      border-radius:10px;
      border:1px dashed #1f2937;
      padding:6px 8px;
      min-height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    @keyframes badgePop{
      0%{
        transform:scale(0.7);
        opacity:0;
        box-shadow:0 0 0 0 rgba(34,197,94,0.9);
      }
      60%{
        transform:scale(1.08);
        opacity:1;
        box-shadow:0 0 0 10px rgba(34,197,94,0);
      }
      100%{
        transform:scale(1);
        opacity:1;
        box-shadow:0 0 20px rgba(34,197,94,0.4);
      }
    }
  </style>
</head>
<!-- slut SEKTION 1: HEAD & STIL -->


<!-- start SEKTION 2: FIREBASE-BIBLIOTEK -->
<!-- Firebase-bibliotek (v8) ‚Äì l√§ggs i HEAD f√∂re spelets script -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<!-- slut SEKTION 2: FIREBASE-BIBLIOTEK -->


<!-- start SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <h1><span class="logo">F</span>F√•ngvaktaren</h1>
        <p class="subtitle">Spelbaserad tr√§ning i tre niv√•er (E, C, A).</p>
      </div>
      <button id="btnTeacherMode" class="btn btn-sm btn-primary">üîë L√§rarl√§ge</button>
    </header>

    <!-- Elevkort -->
    <section id="studentCard" class="student-card">
      <div class="row">
        <div class="field">
          <label for="studentName">Namn</label>
          <input id="studentName" class="input" placeholder="Elevens namn..." autocomplete="off" />
        </div>
        <div class="field">
          <label for="studentClass">Klass</label>
          <input id="studentClass" class="input" placeholder="Klass..." autocomplete="off" />
        </div>
        <div class="field" style="flex:0 0 140px;min-width:140px;">
          <label>&nbsp;</label>
          <button id="btnSaveStudent" class="btn btn-sm btn-primary" style="width:100%;">üíæ Spara elev</button>
        </div>
      </div>
      <div class="student-status">
        <span id="studentSaved">Ej sparad elev</span>
      </div>
    </section>

    <!-- Niv√•kort -->
    <section class="levels-grid">
      <!-- Niv√• 1 / E -->
      <article id="card-levelE" class="level-card level-e locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 1</span>
            <small>Grundniv√• ‚Äì E</small>
          </div>
          <span id="badge-levelE" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelE">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelE">70</span>%</span>
          <span class="mini">L√•ses upp n√§r eleven sparat namn & klass.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• E-niv√•.</div>
          <button id="start-levelE" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 1</button>
        </div>
      </article>

      <!-- Niv√• 2 / C -->
      <article id="card-levelC" class="level-card level-c locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 2</span>
            <small>Mellanniv√• ‚Äì C</small>
          </div>
          <span id="badge-levelC" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelC">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelC">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 1 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• C-niv√•.</div>
          <button id="start-levelC" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 2</button>
        </div>
      </article>

      <!-- Niv√• 3 / A -->
      <article id="card-levelA" class="level-card level-a locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 3</span>
            <small>Avancerad ‚Äì A</small>
          </div>
          <span id="badge-levelA" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelA">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelA">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 2 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• A-niv√•.</div>
          <button id="start-levelA" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 3</button>
        </div>
      </article>
    </section>

    <!-- Spelpanel -->
    <section id="play" class="play-panel hidden">
      <header class="play-header">
        <div>
          <h2 id="play-title">Aktiv niv√•</h2>
          <small id="whoPlays">Ingen elev vald.</small>
        </div>
        <button id="btnCancel" class="btn btn-sm">‚¨ÖÔ∏è Avsluta utan att l√§mna in</button>
      </header>
      <div id="questions" class="questions">
        <div class="question mini">V√§lj en niv√• f√∂r att b√∂rja.</div>
      </div>
      <footer class="play-footer">
        <div class="mini">Svar registreras n√§r du klickar i alternativen eller sl√§pper kort i r√§tt ruta.</div>
        <div class="play-actions">
          <button id="btnFinish" class="btn btn-sm btn-primary">‚úÖ L√§mna in niv√•</button>
        </div>
      </footer>
    </section>

    <!-- Resultatpanel -->
    <section id="result" class="result-panel hidden">
      <header class="result-header">
        <div>
          <div class="score" id="scoreText">0%<span> resultat</span></div>
          <div id="scoreDetail" class="result-meta">0/0 po√§ng</div>
          <div class="result-meta">
            Elev: <span id="resName">-</span> (<span id="resClass">-</span>)
          </div>
        </div>
        <div>
          <div id="passBadge" class="badge-fail">Resultat</div>
          <div id="unlockText" class="result-meta"></div>
        </div>
      </header>

      <div class="result-actions" id="resultActionsNormal">
        <button id="btnBack" class="btn btn-sm">‚¨ÖÔ∏è Tillbaka till niv√•er</button>
      </div>
    </section>
  </div>

  <!-- Embedded grundfr√•gor -->
  <script id="embedded-data" type="application/json">
  {
    "bank": {
      "mcq": [
        {
          "level": "E",
          "type": "mcq",
          "q": "Vad √§r viktigast f√∂rst n√§r du kommer till k√∂ket?",
          "options": ["Ta p√• f√∂rkl√§de", "Tv√§tta h√§nderna", "S√§tta p√• ugnen", "Smaka p√• maten"],
          "answer": 1
        },
        {
          "level": "C",
          "type": "mcq",
          "q": "En g√§st klagar p√• kall mat. Vad √§r ett bra f√∂rsta steg?",
          "options": ["Ignorera g√§sten", "Skylla p√• k√∂ket", "Be om urs√§kt och erbjuda l√∂sning", "S√§ga att det inte √§r ditt fel"],
          "answer": 2
        },
        {
          "level": "A",
          "type": "mcq",
          "q": "Du planerar en buff√©. Vad √§r viktigast f√∂r s√§ker livsmedelshantering?",
          "options": ["Att det ser fint ut", "Att alla r√§tter √§r varma samtidigt", "R√§tt temperaturer och tidsgr√§nser", "Att det finns m√•nga olika r√§tter"],
          "answer": 2
        }
      ]
    }
  }
  </script>

  <!-- L√§rar-gate -->
  <div id="teacherGate" class="gate-backdrop hidden">
    <div class="gate-box">
      <h2>üîë L√§rarl√§ge</h2>
      <p id="teacherGateText">
        Ange l√§rarl√∂senord. F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.
      </p>
      <input id="teacherPasswordInput" class="input" type="password" placeholder="L√∂senord..." />
      <div class="gate-actions">
        <button id="btnTeacherCancel" class="btn btn-sm">Avbryt</button>
        <button id="btnTeacherConfirm" class="btn btn-sm btn-primary">Forts√§tt</button>
      </div>
    </div>
  </div>

  <!-- L√§rarmodal -->
  <div id="teacherModal" class="modal-backdrop hidden">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h2>L√§rarl√§ge ‚Äì F√•ngvaktaren</h2>
          <small>Hantera inst√§llningar, fr√•gebank, bildfr√•gor, drag & drop, export och elevprogression.</small>
        </div>
        <button id="btnCloseTeacher" class="btn btn-sm">St√§ng</button>
      </header>
      <div class="modal-body">
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="settings" id="tab-settings">‚öôÔ∏è Inst√§llningar</button>
          <button class="tab-btn" data-tab="questions" id="tab-questions">üÖ∞Ô∏è Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="images" id="tab-images">üñºÔ∏è Bildfr√•gor</button>
          <button class="tab-btn" data-tab="dragdrop" id="tab-dragdrop">üéØ Drag & Drop</button>
          <button class="tab-btn" data-tab="progress" id="tab-progress">üìà Elevprogression</button>
          <button class="tab-btn" data-tab="bank" id="tab-bank">üóÇÔ∏è Fr√•gebank</button>
        </nav>
        <div class="tab-content">
          <!-- INST√ÑLLNINGAR -->
          <section class="tab-panel" data-panel="settings">
            <div class="settings-grid">
              <!-- 1. L√ñSENORD -->
              <div class="card">
                <h3>L√§rarl√∂senord</h3>
                <p>Det l√∂senord du anv√§nder f√∂r att √∂ppna l√§rarl√§get. H√§r kan du byta det.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputOldPassword">Nuvarande l√∂senord</label>
                    <input id="inputOldPassword" class="input" type="password" placeholder="L√§mna tomt om inget satt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPassword">Nytt l√∂senord</label>
                    <input id="inputNewPassword" class="input" type="password" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPasswordRepeat">Upprepa nytt l√∂senord</label>
                    <input id="inputNewPasswordRepeat" class="input" type="password" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnChangeTeacherPassword" class="btn btn-sm">üîê Spara nytt l√∂senord</button>
                </div>
                <p id="passwordStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <!-- 2. GOOGLE-INLOGGNING -->
              <div class="card">
                <h3>Google-inloggning & uppladdning (l√§rare)</h3>
                <p>
                  Logga in med ditt Google-konto f√∂r att spara och ladda fr√•gebanker via Firebase.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label">Status</label>
                    <p id="googleStatus" class="mini">‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.</p>
                  </div>
                  <div class="field">
                    <button id="btnGooglePlaceholder" class="btn btn-sm" type="button">
                      üîó Logga in med Google
                    </button>
                  </div>
                </div>
              </div>

              <!-- 3. NIV√Ö % -->
              <div class="card">
                <h3>Gr√§ns f√∂r godk√§nt per niv√•</h3>
                <p>Justera procentgr√§ns f√∂r E, C och A. Anv√§nds som riktm√§rke f√∂r ‚ÄùGodk√§nd niv√•‚Äù.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputThresE">Niv√• 1 (E)</label>
                    <input id="inputThresE" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresC">Niv√• 2 (C)</label>
                    <input id="inputThresC" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresA">Niv√• 3 (A)</label>
                    <input id="inputThresA" type="number" min="0" max="100" class="input-number" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveThresholds" class="btn btn-sm btn-primary">üíæ Spara niv√•-gr√§nser</button>
                </div>
              </div>

              <!-- 4. L√ÑRARENS E-POST -->
              <div class="card">
                <h3>L√§rarens e-post</h3>
                <p>
                  Anv√§nds som mottagare n√§r eleven l√§mnar in resultat via e-post
                  (‚ÄùSkapa e-post‚Äù p√• Elevresultat/JSON).
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputTeacherEmail">E-postadress</label>
                    <input id="inputTeacherEmail" class="input" placeholder="namn@skola.se" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveTeacherEmail" class="btn btn-sm">üíæ Spara e-postadress</button>
                </div>
                <p id="teacherEmailStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <!-- 5. KOPPLING DELM√ÖL & DELBITAR -->
              <div class="card">
                <h3>Koppling: delm√•l & delbitar</h3>
                <p>
                  Skriv ett delm√•l och en delbit i taget. Klicka p√• ‚ÄùL√§gg till delbit‚Äù
                  f√∂r att l√§gga till i listan. ‚ÄùSpara‚Äù skriver listan till spelets minne
                  (localStorage). ‚ÄùTa bort alla‚Äù rensar listan.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputGoalSingle">Delm√•l</label>
                    <input id="inputGoalSingle" class="input" placeholder="t.ex. Delm√•l 5 ‚Äì Hygien i k√∂ket" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputPartSingle">Delbit</label>
                    <input id="inputPartSingle" class="input" placeholder="t.ex. 51‚Äì60 eller 51,52,53" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnAddGoalPart" class="btn btn-sm">‚ûï L√§gg till delbit</button>
                  <button id="btnSaveGoalsMap" class="btn btn-sm btn-primary">üíæ Spara</button>
                  <button id="btnClearGoalsMap" class="btn btn-sm btn-danger">üóëÔ∏è Ta bort alla</button>
                </div>
                <p id="goalsStatus" class="mini" style="margin-top:6px;"></p>
                <div id="goalsList" class="list"></div>
              </div>

              <!-- 6. RENSA ELEVDATA / SPELDATA -->
              <div class="card">
                <h3>Elevdata & speldata</h3>
                <p>Dessa inst√§llningar g√§ller bara denna dator/webbl√§sare (localStorage).</p>
                <div class="card-row">
                  <button id="btnClearStudent" class="btn btn-sm">‚ôªÔ∏è Rensa elevdata</button>
                  <button id="btnResetGame" class="btn btn-sm btn-danger">üß® Rensa all speldata</button>
                </div>
                <p id="settingsStatus" class="mini" style="margin-top:6px;"></p>
              </div>
            </div>
          </section>

          <!-- FLERVALSFR√ÖGOR -->
          <section class="tab-panel hidden" data-panel="questions">
            <!-- GEMENSAM NIV√Ö + DELBIT -->
            <div class="card">
              <h3>Niv√• & delbit f√∂r nya fr√•gor</h3>
              <p class="mini">
                V√§lj <strong>niv√•</strong> (E/C/A) och <strong>delbit</strong> h√§r. Dessa anv√§nds b√•de n√§r du
                l√§gger till <strong>enstaka fr√•ga</strong> och n√§r du l√§gger till
                <strong>flera fr√•gor i textformat</strong>.
              </p>
              <div class="card-row">
                <div class="field">
                  <label class="small-label" for="newMcqLevel">Niv√•</label>
                  <select id="newMcqLevel">
                    <option value="E">Niv√• 1 ‚Äì E</option>
                    <option value="C">Niv√• 2 ‚Äì C</option>
                    <option value="A">Niv√• 3 ‚Äì A</option>
                  </select>
                </div>
                <div class="field">
                  <label class="small-label" for="newMcqGoal">Koppla till delbit (huvudkoppling)</label>
                  <select id="newMcqGoal">
                    <option value="">Ingen koppling</option>
                    <!-- Fylls dynamiskt fr√•n delm√•l/delbit-listan -->
                  </select>
                </div>
              </div>

              <!-- EXTRA DELM√ÖL/DELBIT MED SAMMA RULLISTA -->
              <div class="card-row" style="margin-top:6px;">
                <div class="field">
                  <label class="small-label">Extra delm√•l/delbit (valfritt)</label>
                  <p class="mini">
                    V√§lj ett delm√•l/delbit i rullistan ovan och klicka p√• knappen f√∂r att l√§gga till
                    <strong>fler kopplingar</strong> till samma fr√•ga.
                  </p>
                </div>
                <div class="field" style="flex:0 0 200px;min-width:180px;">
                  <label class="small-label">&nbsp;</label>
                </div>
              </div>

              <div id="extraGoalsChips" style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px;"></div>
            </div>

            <!-- ENSTAKA FR√ÖGA -->
            <div class="card" style="margin-top:8px;">
              <h3>Ny flervalsfr√•ga</h3>
              <p>
                Skriv en fr√•ga med fyra svarsalternativ. Niv√• och delbit h√§mtas fr√•n rutan
                <strong>‚ÄùNiv√• & delbit f√∂r nya fr√•gor‚Äù</strong> ovan.
              </p>

              <div class="card-row" style="margin-top:6px;">
                <div class="field">
                  <label class="small-label" for="newMcqText">Fr√•getext</label>
                  <input id="newMcqText" class="input" placeholder="Skriv sj√§lva fr√•gan h√§r..." />
                </div>
              </div>

              <div class="card-row" style="margin-top:6px;">
                <div class="field">
                  <label class="small-label" for="newMcqOpt0">Alternativ A</label>
                  <input id="newMcqOpt0" class="input" />
                </div>
                <div class="field">
                  <label class="small-label" for="newMcqOpt1">Alternativ B</label>
                  <input id="newMcqOpt1" class="input" />
                </div>
                <div class="field">
                  <label class="small-label" for="newMcqOpt2">Alternativ C</label>
                  <input id="newMcqOpt2" class="input" />
                </div>
                <div class="field">
                  <label class="small-label" for="newMcqOpt3">Alternativ D</label>
                  <input id="newMcqOpt3" class="input" />
                </div>
              </div>

              <div class="card-row" style="margin-top:6px;">
                <div class="field">
                  <label class="small-label" for="newMcqCorrect">R√§tt alternativ</label>
                  <select id="newMcqCorrect">
                    <option value="0">A</option>
                    <option value="1">B</option>
                    <option value="2">C</option>
                    <option value="3">D</option>
                  </select>
                </div>
                <div class="field">
                  <button id="btnAddMcq" class="btn btn-sm btn-primary" style="width:100%;">‚ûï L√§gg till fr√•ga</button>
                </div>
              </div>

              <p id="mcqStatus" class="mini" style="margin-top:6px;"></p>
            </div>

            <!-- FLERA FR√ÖGOR (TEXTFORMAT) -->
            <div class="card" style="margin-top:8px;">
              <h3>L√§gg till flera flervalsfr√•gor (textformat)</h3>
              <p class="mini">
                Fr√•gorna som klistras in nedan sparas med den
                <strong>niv√•</strong> och den <strong>delbit</strong> du valt i rutan
                <strong>‚ÄùNiv√• & delbit f√∂r nya fr√•gor‚Äù</strong> ovan.
              </p>
              <p class="mini">
                Varje fr√•ga ska ha:
              </p>
              <ul class="mini">
                <li>1 rad med fr√•getext</li>
                <li>4 rader med svarsalternativ</li>
                <li><strong>*</strong> framf√∂r det alternativ som √§r r√§tt</li>
                <li>En tom rad mellan varje fr√•ga</li>
              </ul>

              <p class="mini" style="margin-top:6px;"><strong>Exempel (textformat):</strong></p>
              <pre class="mini" style="white-space:pre-wrap;border:1px solid var(--border, #1f2937);border-radius:6px;padding:6px;margin-top:4px;">
Vilken matlagningsmetod anv√§nder du n√§r du kokar potatis?
Steka
Grilla
*Koka
√Önga

Vilken metod √§r b√§st n√§r du steker ett √§gg?
I ugnen
I kastrull med vatten
I mikron
*I stekpanna p√• spisen
              </pre>

              <label class="small-label" for="mcqJsonInput" style="margin-top:8px;">Fr√•gor (text)</label>
              <textarea id="mcqJsonInput" class="textarea" rows="10"></textarea>

              <div class="card-row" style="margin-top:8px;">
                <div class="field">
                  <button id="btnAddMcqFromJson" class="btn btn-sm">‚ûï L√§gg till fr√•gor fr√•n text</button>
                </div>
                <div class="field" style="display:flex;align-items:center;justify-content:flex-end;">
                  <span id="mcqJsonStatus" class="mini"></span>
                </div>
              </div>
            </div>

            <!-- √ñVERSIKT -->
            <div class="card" style="margin-top:8px;">
              <h3>√ñversikt befintliga flervalsfr√•gor</h3>
              <p>
                H√§r visas alla sparade fr√•gor. Klicka p√• üóëÔ∏è f√∂r att ta bort en fr√•ga.
              </p>
              <div id="mcqOverview" class="list"></div>
            </div>
          </section>

          <!-- BILDFR√ÖGOR -->
          <section class="tab-panel hidden" data-panel="images">
            <div class="card">
              <h3>‚ûï Skapa bildfr√•ga</h3>
              <p>
                1) V√§lj bildfil ‚Üí 2) Skriv fr√•ga & alternativ ‚Üí 3) Koppla till delm√•l/delbit (valfritt) ‚Üí 4) L√§gg till.
              </p>

              <div class="card-row">
                <div class="field">
                  <label class="small-label" for="imgQuestionFile">Bild</label>
                  <input id="imgQuestionFile" type="file" accept="image/*" class="input" />
                </div>
              </div>

              <div class="card-row" style="margin-top:6px;">
                <div class="field">
                  <label class="small-label">F√∂rhandsvisning</label>
                  <div id="imgQuestionPreview" class="img-preview-box">
                    <span class="mini">Ingen bild vald √§nnu.</span>
                  </div>
                </div>
              </div>

              <div class="card-row" style="margin-top:6px;">
                <div class="field">
                  <label class="small-label" for="imgQuestionLevel">Niv√•</label>
                  <select id="imgQuestionLevel">
                    <option value="E">Niv√• 1 ‚Äì E</option>
                    <option value="C">Niv√• 2 ‚Äì C</option>
                    <option value="A">Niv√• 3 ‚Äì A</option>
                  </select>
                </div>
                <div class="field">
                  <label class="small-label" for="imgQuestionGoal">Koppla till delm√•l (valfritt)</label>
                  <select id="imgQuestionGoal">
                    <option value="">Ingen koppling</option>
                  </select>
                </div>
              </div>

              <div class="card-row" style="margin-top:6px;">
                <div class="field">
                  <label class="small-label" for="imgQuestionText">Fr√•ga</label>
                  <input id="imgQuestionText" class="input" placeholder="Vad visar bilden?" />
                </div>
              </div>

              <div class="card-row" style="margin-top:6px;">
                <div class="field">
                  <label class="small-label">Alternativ</label>
                  <div id="imgOptionsContainer"></div>
                </div>
              </div>

              <div class="card-row" style="margin-top:6px;">
                <button id="btnImgAddOption" class="btn btn-sm">‚ûï Alternativ</button>
                <button id="btnAddImgQuestion" class="btn btn-sm btn-primary">üíæ L√§gg till bildfr√•ga</button>
              </div>

              <p id="imgQuestionStatus" class="mini" style="margin-top:6px;"></p>
            </div>

            <div class="card" style="margin-top:8px;">
              <h3>√ñversikt bildfr√•gor</h3>
              <p>
                H√§r visas alla sparade bildfr√•gor. Du ser en liten miniatyr och kan ta bort fr√•gor.
              </p>
              <div id="imgOverview" class="list"></div>
            </div>
          </section>

          <!-- DRAG & DROP -->
          <section class="tab-panel hidden" data-panel="dragdrop">
            <div class="card">
              <h3>Skapa drag & drop-√∂vning (kategorier)</h3>
              <p>
                Bygg en uppgift d√§r eleven ska dra kort (t.ex. matr√§tter) till r√§tt kategori
                (t.ex. Amerikansk/Engelsk/Japansk frukost).
              </p>

              <div class="card-row">
                <div class="field">
                  <label class="small-label" for="dragLevel">Niv√•</label>
                  <select id="dragLevel">
                    <option value="E">Niv√• 1 ‚Äì E</option>
                    <option value="C">Niv√• 2 ‚Äì C</option>
                    <option value="A">Niv√• 3 ‚Äì A</option>
                  </select>
                </div>
                <div class="field">
                  <label class="small-label" for="dragGoal">Koppla till delm√•l (valfritt)</label>
                  <select id="dragGoal">
                    <option value="">Ingen koppling</option>
                  </select>
                </div>
              </div>

              <div class="card-row" style="margin-top:6px;">
                <div class="field">
                  <label class="small-label" for="dragQuestionText">Instruktion / rubrik</label>
                  <input id="dragQuestionText" class="input" placeholder="T.ex. Dra frukostr√§tter till r√§tt buff√©-kategori..." />
                </div>
              </div>

              <div class="card-row" style="margin-top:8px;">
                <div class="field">
                  <label class="small-label">Kategorier</label>
                  <div id="dragCategoriesContainer" class="list"></div>
                  <button id="btnAddDragCategory" class="btn btn-sm" type="button" style="margin-top:6px;">
                    ‚ûï L√§gg till kategori
                  </button>
                  <p class="mini" style="margin-top:4px;">
                    Exempel: Amerikansk frukost ¬∑ Engelsk frukost ¬∑ Japansk frukost
                  </p>
                </div>
              </div>

              <div class="card-row" style="margin-top:8px;">
                <div class="field">
                  <label class="small-label">Objekt att dra</label>
                  <div id="dragItemsContainer" class="list"></div>
                  <button id="btnAddDragItem" class="btn btn-sm" type="button" style="margin-top:6px;">
                    ‚ûï L√§gg till objekt
                  </button>
                  <p class="mini" style="margin-top:4px;">
                    Exempel: pannkakor ‚Üí Amerikansk, korv ‚Üí Engelsk, sushi ‚Üí Japansk.
                  </p>
                </div>
              </div>

              <div class="card-row" style="margin-top:8px;">
                <button id="btnAddDragQuestion" class="btn btn-sm btn-primary" type="button">
                  üíæ L√§gg till drag & drop-√∂vning
                </button>
              </div>
              <p id="dragStatus" class="mini" style="margin-top:6px;"></p>
            </div>

            <div class="card" style="margin-top:8px;">
              <h3>√ñversikt drag & drop-√∂vningar</h3>
              <p>H√§r visas alla sparade drag & drop-uppgifter. Klicka p√• üóëÔ∏è f√∂r att ta bort en uppgift.</p>
              <div id="dragOverview" class="list"></div>
            </div>
          </section>

          <!-- PROGRESSION + ELEVRESULTAT(JSON) -->
          <section class="tab-panel hidden" data-panel="progress">
            <div class="card">
              <h3>Sammanfattning per niv√•</h3>
              <p>Visar b√§sta uppn√•dda resultat per niv√• p√• denna dator.</p>
              <div class="list">
                <div class="list-item">
                  <div class="list-main">
                    <div class="q-text">
                      Niv√• 1 ‚Äì E
                      <span class="level-tag level-e">E</span>
                    </div>
                    <div class="q-meta">
                      B√§sta resultat: <span id="progBestE">0</span>%<br/>
                      Status: <span id="progStatusE">L√•st</span>
                    </div>
                  </div>
                </div>
                <div class="list-item">
                  <div class="list-main">
                    <div class="q-text">
                      Niv√• 2 ‚Äì C
                      <span class="level-tag level-c">C</span>
                    </div>
                    <div class="q-meta">
                      B√§sta resultat: <span id="progBestC">0</span>%<br/>
                      Status: <span id="progStatusC">L√•st</span>
                    </div>
                  </div>
                </div>
                <div class="list-item">
                  <div class="list-main">
                    <div class="q-text">
                      Niv√• 3 ‚Äì A
                      <span class="level-tag level-a">A</span>
                    </div>
                    <div class="q-meta">
                      B√§sta resultat: <span id="progBestA">0</span>%<br/>
                      Status: <span id="progStatusA">L√•st</span>
                    </div>
                  </div>
                </div>
              </div>
              <p class="mini" style="margin-top:6px;">P√• sikt kan denna flik byggas vidare med fler detaljer per elev/resultat.</p>
            </div>

            <div class="card" style="margin-top:8px;">
              <h3>Senaste elevresultat (JSON)</h3>
              <p>Resultatet kan klistras in i elevkortet eller skickas via e-post.</p>
              <div id="exportSection">
                <label class="small-label" for="exportJson">JSON-resultat</label>
                <textarea id="exportJson" class="textarea" readonly></textarea>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnCopyExportJson" class="btn btn-sm">üìã Kopiera JSON</button>
                  <button id="btnEmailExportJson" class="btn btn-sm">‚úâÔ∏è Skapa e-post</button>
                </div>
                <p class="mini" id="exportStatus" style="margin-top:6px;"></p>
              </div>
            </div>
          </section>

          <!-- FR√ÖGEBANK (endast moln-banker) -->
          <section class="tab-panel hidden" data-panel="bank">
            <!-- Moln-banker-kortet injiceras dynamiskt av ensureCloudBankUi() -->
          </section>
        </div>
      </div>
    </div>
  </div>
<!-- slut SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->





<!-- start SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN -->
<script>
"use strict";

/* =========================
   3a ‚Äì Firebase init & moln-banker
   ========================= */

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
  authDomain: "fangvaktaren-904db.firebaseapp.com",
  projectId: "fangvaktaren-904db",
  storageBucket: "fangvaktaren-904db.firebasestorage.app",
  messagingSenderId: "105301219768",
  appId: "1:105301219768:web:66b131fba86a541b78174d",
  measurementId: "G-NXL9GSFZ77"
};

let firebaseAppInstance = null;
let firebaseAuthInstance = null;
let firebaseDbInstance = null;
let currentTeacherUser = null;

// Lista √∂ver moln-banker f√∂r aktuell l√§rare
let cloudBanks = [];
let activeCloudBankId = null;

function initFirebase() {
  if (!window.firebase) {
    console.warn("Firebase SDK saknas p√• sidan.");
    return;
  }
  try {
    if (!firebaseAppInstance) {
      if (firebase.apps && firebase.apps.length > 0) {
        firebaseAppInstance = firebase.apps[0];
      } else {
        firebaseAppInstance = firebase.initializeApp(FIREBASE_CONFIG);
      }
    }
    if (!firebaseDbInstance && firebase.firestore) {
      firebaseDbInstance = firebase.firestore();
    }
    if (!firebaseAuthInstance && firebase.auth) {
      firebaseAuthInstance = firebase.auth();
    }
  } catch (e) {
    console.error("Fel vid initFirebase:", e);
  }
}

function updateGoogleUi() {
  const statusEl = document.getElementById("googleStatus");
  const btn = document.getElementById("btnGooglePlaceholder");
  if (!statusEl || !btn) return;

  if (currentTeacherUser) {
    const nameOrMail = currentTeacherUser.email || currentTeacherUser.displayName || "l√§rare";
    statusEl.textContent = "‚úÖ Inloggad som " + nameOrMail + ".";
    btn.textContent = "üîì Logga ut fr√•n Google";
  } else {
    statusEl.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.";
    btn.textContent = "üîó Logga in med Google";
  }
}

function handleGoogleClick() {
  initFirebase();
  if (!firebaseAuthInstance) {
    alert("Firebase Auth √§r inte korrekt konfigurerat. Kontrollera FIREBASE_CONFIG och script-taggarna.");
    return;
  }
  if (currentTeacherUser) {
    firebaseAuthInstance
      .signOut()
      .then(() => {
        currentTeacherUser = null;
        updateGoogleUi();
      })
      .catch(err => {
        console.error("Sign-out fel:", err);
        alert("Kunde inte logga ut just nu.");
      });
  } else {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebaseAuthInstance
      .signInWithPopup(provider)
      .then(result => {
        currentTeacherUser = result.user || null;
        updateGoogleUi();
        loadCloudBanksList();
      })
      .catch(err => {
        console.error("Google-inloggning misslyckades:", err);
        alert("Inloggning misslyckades. F√∂rs√∂k igen eller kontakta administrat√∂r.");
      });
  }
}

// Skapar UI f√∂r moln-banker i bank-fliken om det inte redan finns
function ensureCloudBankUi() {
  const panel = document.querySelector('.tab-panel[data-panel="bank"]');
  if (!panel) return;
  if (document.getElementById("cloudBankControls")) return;

  const wrapper = document.createElement("div");
  wrapper.id = "cloudBankControls";
  wrapper.className = "card";
  wrapper.style.marginBottom = "8px";

  wrapper.innerHTML = `
    <h3>‚òÅÔ∏è Moln-banker (Firebase)</h3>
    <p class="mini">
      V√§lj, skapa, spara och ladda fr√•gebanker (inkl. delm√•l/delbitar) kopplade till ditt Google-konto.
    </p>
    <div class="card-row">
      <div class="field">
        <label class="small-label" for="cloudBankSelect">Aktiv bank</label>
        <select id="cloudBankSelect">
          <option value="">Ingen bank vald</option>
        </select>
      </div>
    </div>
    <div class="card-row" style="margin-top:6px;">
      <button id="btnCloudCreateBank" class="btn btn-sm">‚ûï Ny bank</button>
      <button id="btnCloudLoadBank" class="btn btn-sm">‚¨áÔ∏è Ladda bank fr√•n molnet</button>
      <button id="btnCloudSaveBank" class="btn btn-sm btn-primary">üíæ Spara nuvarande bank till molnet</button>
    </div>
    <p id="cloudBankStatus" class="mini" style="margin-top:6px;"></p>
  `;

  panel.insertBefore(wrapper, panel.firstChild);

  const btnCreate = document.getElementById("btnCloudCreateBank");
  const btnLoad = document.getElementById("btnCloudLoadBank");
  const btnSave = document.getElementById("btnCloudSaveBank");

  if (btnCreate) btnCreate.addEventListener("click", createCloudBank);
  if (btnLoad) btnLoad.addEventListener("click", loadCloudBankToLocal);
  if (btnSave) btnSave.addEventListener("click", saveCloudBank);
}

function setCloudBankStatus(msg) {
  const el = document.getElementById("cloudBankStatus");
  if (!el) return;
  el.textContent = msg || "";
}

// Laddar listan med banker fr√•n Firestore
function loadCloudBanksList() {
  initFirebase();
  ensureCloudBankUi();
  if (!firebaseDbInstance || !currentTeacherUser) {
    setCloudBankStatus("Logga in med Google f√∂r att anv√§nda moln-banker.");
    return;
  }

  const select = document.getElementById("cloudBankSelect");
  setCloudBankStatus("Laddar banker fr√•n molnet...");

  firebaseDbInstance
    .collection("teachers")
    .doc(currentTeacherUser.uid)
    .collection("banks")
    .orderBy("name")
    .get()
    .then(snapshot => {
      cloudBanks = [];
      if (select) {
        select.innerHTML = '<option value="">Ingen bank vald</option>';
      }
      snapshot.forEach(doc => {
        const data = doc.data() || {};
        const bank = {
          id: doc.id,
          name: data.name || "(namnl√∂s bank)",
          data: data.data || { mcq: [], img: [], drag: [], goalsMap: [] }
        };
        cloudBanks.push(bank);
        if (select) {
          const opt = document.createElement("option");
          opt.value = bank.id;
          opt.textContent = bank.name;
          select.appendChild(opt);
        }
      });
      if (cloudBanks.length === 0) {
        setCloudBankStatus("Inga banker i molnet √§nnu. Skapa en ny bank.");
      } else {
        setCloudBankStatus("Hittade " + cloudBanks.length + " bank(er) i molnet.");
      }
    })
    .catch(err => {
      console.error("loadCloudBanksList fel:", err);
      setCloudBankStatus("Kunde inte ladda banker fr√•n molnet.");
    });
}

function createCloudBank() {
  initFirebase();
  if (!firebaseDbInstance || !currentTeacherUser) {
    alert("Logga in med Google f√∂rst.");
    return;
  }

  const name = prompt("Namn p√• ny bank (t.ex. HRHOT25 ‚Äì Frukost & buff√©):");
  if (!name) return;

  const s = loadState();
  const bankData = {
    mcq: s.bank && Array.isArray(s.bank.mcq) ? s.bank.mcq : [],
    img: s.bank && Array.isArray(s.bank.img) ? s.bank.img : [],
    drag: s.bank && Array.isArray(s.bank.drag) ? s.bank.drag : [],
    goalsMap: Array.isArray(s.goalsMap) ? s.goalsMap : []
  };

  const ref = firebaseDbInstance
    .collection("teachers")
    .doc(currentTeacherUser.uid)
    .collection("banks")
    .doc();

  const payload = {
    name: name,
    data: bankData,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  setCloudBankStatus("Skapar ny bank i molnet...");

  ref.set(payload)
    .then(() => {
      activeCloudBankId = ref.id;
      setCloudBankStatus("Ny bank skapad och sparad i molnet.");
      loadCloudBanksList();
    })
    .catch(err => {
      console.error("createCloudBank fel:", err);
      setCloudBankStatus("Kunde inte skapa bank i molnet.");
    });
}

function saveCloudBank() {
  initFirebase();
  if (!firebaseDbInstance || !currentTeacherUser) {
    alert("Logga in med Google f√∂rst.");
    return;
  }

  const select = document.getElementById("cloudBankSelect");
  if (!select || (!select.value && !activeCloudBankId)) {
    alert("V√§lj en bank i listan eller skapa en ny f√∂rst.");
    return;
  }

  const bankId = select.value || activeCloudBankId;
  const s = loadState();
  const bankData = {
    mcq: s.bank && Array.isArray(s.bank.mcq) ? s.bank.mcq : [],
    img: s.bank && Array.isArray(s.bank.img) ? s.bank.img : [],
    drag: s.bank && Array.isArray(s.bank.drag) ? s.bank.drag : [],
    goalsMap: Array.isArray(s.goalsMap) ? s.goalsMap : []
  };

  const ref = firebaseDbInstance
    .collection("teachers")
    .doc(currentTeacherUser.uid)
    .collection("banks")
    .doc(bankId);

  const existing = cloudBanks.find(b => b.id === bankId);
  const name =
    existing ? existing.name : (select.options[select.selectedIndex] || {}).text || "Namnl√∂s bank";

  const payload = {
    name: name,
    data: bankData,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  setCloudBankStatus("Sparar bank till molnet...");

  ref.set(payload, { merge: true })
    .then(() => {
      activeCloudBankId = bankId;
      setCloudBankStatus("Banken √§r sparad i molnet.");
    })
    .catch(err => {
      console.error("saveCloudBank fel:", err);
      setCloudBankStatus("Kunde inte spara bank i molnet.");
    });
}

function loadCloudBankToLocal() {
  initFirebase();
  if (!firebaseDbInstance || !currentTeacherUser) {
    alert("Logga in med Google f√∂rst.");
    return;
  }

  const select = document.getElementById("cloudBankSelect");
  if (!select || !select.value) {
    alert("V√§lj en bank i listan att ladda.");
    return;
  }

  const bankId = select.value;
  const ref = firebaseDbInstance
    .collection("teachers")
    .doc(currentTeacherUser.uid)
    .collection("banks")
    .doc(bankId);

  setCloudBankStatus("Laddar vald bank fr√•n molnet...");

  ref.get()
    .then(doc => {
      if (!doc.exists) {
        setCloudBankStatus("Den valda banken finns inte l√§ngre i molnet.");
        return;
      }
      const data = doc.data() || {};
      const bankData = data.data || {};
      const s = loadState();

      const mcq = Array.isArray(bankData.mcq) ? bankData.mcq : [];
      const img = Array.isArray(bankData.img) ? bankData.img : [];
      const drag = Array.isArray(bankData.drag) ? bankData.drag : [];
      const goalsMap = Array.isArray(bankData.goalsMap) ? bankData.goalsMap : [];

      s.bank = { mcq: mcq, img: img, drag: drag };
      s.goalsMap = goalsMap.length ? goalsMap : (s.goalsMap || []);
      saveState(s);

      renderGoalsList();
      refreshMcqGoalSelect();
      renderMcqOverview();
      renderImgOverview();
      renderDragOverview();
      setCloudBankStatus('Banken "' + (data.name || "utan namn") + '" √§r laddad i spelet.');
      activeCloudBankId = bankId;
      syncUI();
    })
    .catch(err => {
      console.error("loadCloudBankToLocal fel:", err);
      setCloudBankStatus("Kunde inte ladda bank fr√•n molnet.");
    });
}

/* =========================
   3b ‚Äì State & utilities
   ========================= */

const STORAGE_KEY = "fangvaktaren_v2_state";

const DEFAULT_STATE = {
  student: { name: "", klass: "" },
  thresholds: { E: 70, C: 70, A: 70 },
  best: { E: 0, C: 0, A: 0 },
  unlocked: { C: false, A: false },
  bank: {
    mcq: [],
    img: [],
    drag: []
  },
  teacherPassword: "",
  teacherEmail: "",
  goalsMap: [],
  history: {
    mcq: []
  }
};

function deepCloneDefault() {
  return JSON.parse(JSON.stringify(DEFAULT_STATE));
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return deepCloneDefault();
    const parsed = JSON.parse(raw);
    const s = deepCloneDefault();

    if (parsed.student) s.student = Object.assign({}, s.student, parsed.student);
    if (parsed.thresholds) s.thresholds = Object.assign({}, s.thresholds, parsed.thresholds);
    if (parsed.best) s.best = Object.assign({}, s.best, parsed.best);
    if (parsed.unlocked) s.unlocked = Object.assign({}, s.unlocked, parsed.unlocked);
    if (parsed.bank && Array.isArray(parsed.bank.mcq)) s.bank.mcq = parsed.bank.mcq.slice();
    if (parsed.bank && Array.isArray(parsed.bank.img)) s.bank.img = parsed.bank.img.slice();
    if (parsed.bank && Array.isArray(parsed.bank.drag)) s.bank.drag = parsed.bank.drag.slice();
    if (typeof parsed.teacherPassword === "string") s.teacherPassword = parsed.teacherPassword;
    if (typeof parsed.teacherEmail === "string") s.teacherEmail = parsed.teacherEmail;
    if (Array.isArray(parsed.goalsMap)) s.goalsMap = parsed.goalsMap.slice();
    if (parsed.history && Array.isArray(parsed.history.mcq)) {
      s.history = { mcq: parsed.history.mcq.slice() };
    }
    return s;
  } catch (e) {
    console.error("loadState fail", e);
    return deepCloneDefault();
  }
}

function saveState(state) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.error("saveState fail", e);
  }
}

function $(sel) {
  return document.querySelector(sel);
}
function $all(sel) {
  return Array.from(document.querySelectorAll(sel));
}

function clampInt(val, min, max, fallback) {
  const n = Number(val);
  if (Number.isNaN(n)) return fallback;
  return Math.min(max, Math.max(min, Math.round(n)));
}

function shuffleArray(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    const tmp = a[i];
    a[i] = a[j];
    a[j] = tmp;
  }
  return a;
}

/* =========================
   3c ‚Äì Embedded fr√•gebank
   ========================= */

function mergeEmbeddedBank() {
  const el = document.getElementById("embedded-data");
  if (!el) return;
  let s = loadState();
  try {
    const payload = JSON.parse(el.textContent || "null");
    if (!payload || !payload.bank || !Array.isArray(payload.bank.mcq)) return;
    if (s.bank.mcq && s.bank.mcq.length > 0) return;
    s.bank.mcq = payload.bank.mcq.slice();
    saveState(s);
  } catch (e) {
    console.error("mergeEmbeddedBank fail", e);
  }
}

/* =========================
   3d ‚Äì Global spelvariabler
   ========================= */

let currentLevel = null;
let currentQuestions = [];
let currentAnswers = [];
let lastSubmission = null;
let currentImageDataUrl = null;

// Extra delbitsval per fr√•getyp (f√∂r chips)
const extraGoalSelections = {
  mcq: [],
  img: [],
  drag: []
};

/* =========================
   3e ‚Äì Hj√§lpfunktioner UI (inkl. extra delbitar/chips)
   ========================= */

function ensureStudentSet() {
  const s = loadState();
  const has =
    s.student.name &&
    s.student.name.trim() &&
    s.student.klass &&
    s.student.klass.trim();
  if (!has) {
    alert('Fyll i Namn & Klass och klicka p√• "Spara elev" innan du b√∂rjar.');
  }
  return !!has;
}

// Skapa chips-UI under m√•lv√§ljaren f√∂r MCQ/Bild/Drag
function ensureExtraGoalChips() {
  const configs = [
    { baseId: "newMcqGoal", type: "mcq", labelText: "‚ûï L√§gg till ny delbit" },
    { baseId: "imgQuestionGoal", type: "img", labelText: "‚ûï L√§gg till ny delbit" },
    { baseId: "dragGoal", type: "drag", labelText: "‚ûï L√§gg till ny delbit" }
  ];

  configs.forEach(cfg => {
    const base = document.getElementById(cfg.baseId);
    if (!base) return;

    const wrapperId = cfg.baseId + "ExtraWrapper";
    if (document.getElementById(wrapperId)) return;

    const parent = base.parentElement || base;
    const wrapper = document.createElement("div");
    wrapper.id = wrapperId;
    wrapper.className = "extra-goal-wrapper";
    wrapper.style.marginTop = "4px";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn btn-sm";
    btn.textContent = cfg.labelText;
    btn.style.marginRight = "6px";

    const chips = document.createElement("div");
    chips.id = cfg.baseId + "ExtraChips";
    chips.className = "chips-row mini";
    chips.textContent = "Inga extra delbitar valda.";

    btn.addEventListener("click", () => {
      addExtraGoalFromSelect(cfg.type, cfg.baseId);
    });

    wrapper.appendChild(btn);
    wrapper.appendChild(chips);
    parent.appendChild(wrapper);

    renderExtraGoalChips(cfg.type);
  });
}

function getBaseIdForType(type) {
  if (type === "mcq") return "newMcqGoal";
  if (type === "img") return "imgQuestionGoal";
  if (type === "drag") return "dragGoal";
  return "newMcqGoal";
}

function addExtraGoalFromSelect(type, baseId) {
  const sel = document.getElementById(baseId);
  if (!sel) return;
  const val = (sel.value || "").trim();
  if (!val) return;

  if (!extraGoalSelections[type]) {
    extraGoalSelections[type] = [];
  }
  if (!extraGoalSelections[type].includes(val)) {
    extraGoalSelections[type].push(val);
  }
  renderExtraGoalChips(type);
}

function renderExtraGoalChips(type) {
  const baseId = getBaseIdForType(type);
  const chipsId = baseId + "ExtraChips";
  const host = document.getElementById(chipsId);
  if (!host) return;

  const s = loadState();
  const arrIds = extraGoalSelections[type] || [];
  host.innerHTML = "";

  if (!arrIds.length) {
    host.className = "chips-row mini";
    host.textContent = "Inga extra delbitar valda.";
    return;
  }

  arrIds.forEach(id => {
    const gp = (s.goalsMap || []).find(g => String(g.id) === String(id));
    const label =
      gp && (gp.parts || gp.goal)
        ? (gp.parts ? gp.parts : gp.goal)
        : "Delbit";

    const chip = document.createElement("button");
    chip.type = "button";
    chip.className = "chip";
    chip.style.marginBottom = "4px";
    chip.textContent = label + " ‚úï";
    chip.addEventListener("click", () => {
      extraGoalSelections[type] = extraGoalSelections[type].filter(x => x !== id);
      renderExtraGoalChips(type);
    });
    host.appendChild(chip);
  });
}

// Fyller alla m√•lv√§ljare (MCQ/Bild/Drag) fr√•n goalsMap
function refreshMcqGoalSelect() {
  const s = loadState();
  const selects = [
    $("#newMcqGoal"),
    $("#imgQuestionGoal"),
    $("#dragGoal")
  ].filter(Boolean);

  if (!selects.length) {
    ensureExtraGoalChips();
    return;
  }

  selects.forEach(sel => {
    const prev = sel.value;
    sel.innerHTML = "";
    const optNone = document.createElement("option");
    optNone.value = "";
    optNone.textContent = "Ingen koppling";
    sel.appendChild(optNone);

    (s.goalsMap || []).forEach(gp => {
      const opt = document.createElement("option");
      opt.value = String(gp.id);
      opt.textContent = gp.goal + (gp.parts ? " ‚Äì " + gp.parts : "");
      sel.appendChild(opt);
    });

    if (prev) sel.value = prev;
  });

  ensureExtraGoalChips();
}

function renderGoalsList() {
  const host = $("#goalsList");
  if (!host) return;
  const s = loadState();
  const arr = s.goalsMap || [];
  host.innerHTML = "";

  if (!arr.length) {
    host.innerHTML = '<div class="mini">Inga sparade delm√•l/delbitskopplingar √§nnu.</div>';
    refreshMcqGoalSelect();
    return;
  }

  arr.forEach((gp, idx) => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <div class="list-main">
        <div class="q-text">[${idx + 1}] ${gp.goal || ""}</div>
        <div class="q-meta">Delbitar: ${gp.parts || "-"}</div>
      </div>
      <div>
        <button class="btn btn-sm btn-danger" data-del-goal="${gp.id}">üóëÔ∏è Ta bort</button>
      </div>
    `;
    host.appendChild(div);
  });

  host.querySelectorAll("button[data-del-goal]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del-goal");
      const s2 = loadState();
      s2.goalsMap = (s2.goalsMap || []).filter(g => String(g.id) !== String(id));
      saveState(s2);
      renderGoalsList();
      refreshMcqGoalSelect();
    });
  });

  refreshMcqGoalSelect();
}

function syncUI() {
  const s = loadState();

  // Elevkort
  const nameInp = $("#studentName");
  const classInp = $("#studentClass");
  const savedLbl = $("#studentSaved");
  if (nameInp) nameInp.value = s.student.name || "";
  if (classInp) classInp.value = s.student.klass || "";
  const hasStudent =
    !!(s.student.name && s.student.name.trim() && s.student.klass && s.student.klass.trim());
  if (savedLbl) {
    savedLbl.textContent = hasStudent
      ? `Sparad: ${s.student.name} (${s.student.klass})`
      : "Ej sparad elev";
  }

  // Gr√§nser + b√§sta resultat
  const thE = $("#thres-levelE");
  const thC = $("#thres-levelC");
  const thA = $("#thres-levelA");
  if (thE) thE.textContent = s.thresholds.E;
  if (thC) thC.textContent = s.thresholds.C;
  if (thA) thA.textContent = s.thresholds.A;

  const be = $("#best-levelE");
  const bc = $("#best-levelC");
  const ba = $("#best-levelA");
  if (be) be.textContent = s.best.E || 0;
  if (bc) bc.textContent = s.best.C || 0;
  if (ba) ba.textContent = s.best.A || 0;

  // Uppl√•sning
  const cardE = $("#card-levelE");
  const cardC = $("#card-levelC");
  const cardA = $("#card-levelA");
  const btnE = $("#start-levelE");
  const btnC = $("#start-levelC");
  const btnA = $("#start-levelA");

  const levelEUnlocked = hasStudent;
  const levelCUnlocked = !!s.unlocked.C;
  const levelAUnlocked = !!s.unlocked.A;

  if (cardE) cardE.classList.toggle("locked", !levelEUnlocked);
  if (cardC) cardC.classList.toggle("locked", !levelCUnlocked);
  if (cardA) cardA.classList.toggle("locked", !levelAUnlocked);

  if (btnE) btnE.disabled = !levelEUnlocked;
  if (btnC) btnC.disabled = !levelCUnlocked;
  if (btnA) btnA.disabled = !levelAUnlocked;

  const bE = $("#badge-levelE");
  const bC = $("#badge-levelC");
  const bA = $("#badge-levelA");

  function updateBadge(el, unlocked, best, thres) {
    if (!el) return;
    if (!unlocked) {
      el.className = "badge badge-lock";
      el.textContent = "L√•st";
    } else if (best >= thres) {
      el.className = "badge badge-ok";
      el.textContent = "Godk√§nd";
    } else if (best > 0) {
      el.className = "badge badge-warn";
      el.textContent = `${best}% (beh√∂ver ${thres}%)`;
    } else {
      el.className = "badge badge-warn";
      el.textContent = `Beh√∂ver ${thres}%`;
    }
  }

  updateBadge(bE, levelEUnlocked, s.best.E, s.thresholds.E);
  updateBadge(bC, levelCUnlocked, s.best.C, s.thresholds.C);
  updateBadge(bA, levelAUnlocked, s.best.A, s.thresholds.A);

  // Progressionsflik (niv√•-sammanfattning)
  const progBestE = $("#progBestE");
  const progBestC = $("#progBestC");
  const progBestA = $("#progBestA");
  const progStatusE = $("#progStatusE");
  const progStatusC = $("#progStatusC");
  const progStatusA = $("#progStatusA");
  if (progBestE) progBestE.textContent = s.best.E || 0;
  if (progBestC) progBestC.textContent = s.best.C || 0;
  if (progBestA) progBestA.textContent = s.best.A || 0;
  if (progStatusE) progStatusE.textContent = levelEUnlocked ? "Uppl√•st" : "L√•st";
  if (progStatusC) progStatusC.textContent = levelCUnlocked ? "Uppl√•st" : "L√•st";
  if (progStatusA) progStatusA.textContent = levelAUnlocked ? "Uppl√•st" : "L√•st";

  renderMcqOverview();
  renderImgOverview();
  renderDragOverview();
  renderGoalsList();
  renderProgressDetails();
}

/* =========================
   3f ‚Äì MCQ / bild / drag ‚Äì render & admin
   ========================= */

function renderDragPairsQuestionPlay(q, index, host) {
  const div = document.createElement("div");
  div.className = "question";

  const titleText = q.text || q.q || "";
  div.innerHTML = `
    <div><strong>${index + 1}. Matchningsfr√•ga:</strong> ${titleText}</div>
    <div class="mini">Matcha v√§nstersidan mot r√§tt svar i rullistorna.</div>
  `;

  const pairsHost = document.createElement("div");
  pairsHost.style.marginTop = "8px";

  const rights = shuffleArray((q.pairs || []).map(p => String(p.right || "")));

  currentAnswers[index] = { type: "dragpairs", selected: {} };

  (q.pairs || []).forEach((pair, pairIndex) => {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "8px";
    row.style.alignItems = "center";
    row.style.marginBottom = "4px";

    const leftSpan = document.createElement("div");
    leftSpan.style.flex = "0 0 40%";
    leftSpan.textContent = pair.left || "";
    row.appendChild(leftSpan);

    const sel = document.createElement("select");
    sel.className = "input";
    const placeholderOpt = document.createElement("option");
    placeholderOpt.value = "";
    placeholderOpt.textContent = "V√§lj...";
    sel.appendChild(placeholderOpt);

    rights.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      sel.appendChild(opt);
    });

    sel.addEventListener("change", () => {
      if (!currentAnswers[index] || typeof currentAnswers[index] !== "object") {
        currentAnswers[index] = { type: "dragpairs", selected: {} };
      }
      currentAnswers[index].selected[pairIndex] = sel.value || null;
    });

    row.appendChild(sel);
    pairsHost.appendChild(row);
  });

  div.appendChild(pairsHost);
  host.appendChild(div);
}

function renderDragCategoryQuestionPlay(q, index, host) {
  const div = document.createElement("div");
  div.className = "question";

  const text = q.text || q.q || "";
  div.innerHTML = `
    <div><strong>${index + 1}. Drag & drop:</strong> ${text}</div>
    <div class="mini">Dra varje kort till r√§tt kategori.</div>
  `;

  const wrap = document.createElement("div");
  wrap.style.display = "flex";
  wrap.style.flexWrap = "wrap";
  wrap.style.gap = "8px";
  wrap.style.marginTop = "8px";

  const categories = Array.isArray(q.categories) ? q.categories : [];
  const items = Array.isArray(q.items) ? q.items : [];

  currentAnswers[index] = { type: "dragcat", mapping: {} };

  categories.forEach((cat, catIndex) => {
    const col = document.createElement("div");
    col.className = "dragcat-column";
    col.style.flex = "1 1 160px";
    col.style.minWidth = "140px";
    col.style.border = "1px dashed var(--border,#1f2937)";
    col.style.borderRadius = "6px";
    col.style.padding = "6px";
    col.style.minHeight = "80px";
    col.dataset.categoryIndex = String(catIndex);

    const title = document.createElement("div");
    title.textContent = cat.name || cat.label || "Kategori " + (catIndex + 1);
    title.style.fontWeight = "600";
    title.style.fontSize = "0.85rem";
    title.style.marginBottom = "4px";
    col.appendChild(title);

    const dropArea = document.createElement("div");
    dropArea.className = "dragcat-droparea";
    dropArea.style.minHeight = "40px";
    dropArea.style.display = "flex";
    dropArea.style.flexWrap = "wrap";
    dropArea.style.gap = "4px";
    col.appendChild(dropArea);

    wrap.appendChild(col);
  });

  const poolLabel = document.createElement("div");
  poolLabel.className = "mini";
  poolLabel.style.marginTop = "8px";
  poolLabel.textContent = "Kort att dra:";

  const pool = document.createElement("div");
  pool.className = "dragcat-pool";
  pool.style.display = "flex";
  pool.style.flexWrap = "wrap";
  pool.style.gap = "4px";
  pool.style.marginTop = "4px";
  pool.style.borderTop = "1px solid var(--border,#1f2937)";
  pool.style.paddingTop = "4px";

  items.forEach((item, itemIndex) => {
    const chip = document.createElement("div");
    chip.className = "dragcat-item";
    chip.textContent = item.label || item.text || "";
    chip.draggable = true;
    chip.dataset.itemIndex = String(itemIndex);
    chip.style.padding = "4px 8px";
    chip.style.borderRadius = "999px";
    chip.style.border = "1px solid var(--border,#1f2937)";
    chip.style.fontSize = "0.8rem";
    chip.style.cursor = "grab";
    pool.appendChild(chip);
  });

  function handleDragStart(e) {
    const target = e.target;
    if (!target.classList.contains("dragcat-item")) return;
    e.dataTransfer.setData("text/plain", target.dataset.itemIndex || "");
    e.dataTransfer.effectAllowed = "move";
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  }

  function handleDropOnColumn(e) {
    e.preventDefault();
    const itemIndexStr = e.dataTransfer.getData("text/plain");
    if (!itemIndexStr) return;
    const itemIndex = Number(itemIndexStr);
    if (Number.isNaN(itemIndex)) return;

    const column = e.currentTarget.closest(".dragcat-column");
    if (!column) return;
    const dropArea = column.querySelector(".dragcat-droparea");
    if (!dropArea) return;

    const itemEl = div.querySelector(
      '.dragcat-item[data-item-index="' + itemIndex + '"]'
    );
    if (!itemEl) return;

    dropArea.appendChild(itemEl);

    const catIdx = Number(column.dataset.categoryIndex || "-1");
    if (!currentAnswers[index] || currentAnswers[index].type !== "dragcat") {
      currentAnswers[index] = { type: "dragcat", mapping: {} };
    }
    currentAnswers[index].mapping[itemIndex] = catIdx;
  }

  function handleDropOnPool(e) {
    e.preventDefault();
    const itemIndexStr = e.dataTransfer.getData("text/plain");
    if (!itemIndexStr) return;
    const itemIndex = Number(itemIndexStr);
    if (Number.isNaN(itemIndex)) return;

    const itemEl = div.querySelector(
      '.dragcat-item[data-item-index="' + itemIndex + '"]'
    );
    if (!itemEl) return;
    pool.appendChild(itemEl);

    if (!currentAnswers[index] || currentAnswers[index].type !== "dragcat") {
      currentAnswers[index] = { type: "dragcat", mapping: {} };
    }
    currentAnswers[index].mapping[itemIndex] = null;
  }

  div.addEventListener("dragstart", handleDragStart);

  wrap.querySelectorAll(".dragcat-column").forEach(col => {
    col.addEventListener("dragover", handleDragOver);
    col.addEventListener("drop", handleDropOnColumn);
  });

  pool.addEventListener("dragover", handleDragOver);
  pool.addEventListener("drop", handleDropOnPool);

  div.appendChild(wrap);
  div.appendChild(poolLabel);
  div.appendChild(pool);
  host.appendChild(div);
}

function renderQuestion(q, index, host) {
  const type = q.type || "mcq";

  if (
    type === "drag" &&
    Array.isArray(q.categories) &&
    Array.isArray(q.items) &&
    q.categories.length &&
    q.items.length
  ) {
    renderDragCategoryQuestionPlay(q, index, host);
    return;
  }

  if (type === "drag" && Array.isArray(q.pairs) && q.pairs.length > 0) {
    renderDragPairsQuestionPlay(q, index, host);
    return;
  }

  const div = document.createElement("div");
  div.className = "question";

  const label = type === "img" ? "Bildfr√•ga" : "Flervalsfr√•ga";
  let headerHtml = `<div><strong>${index + 1}. ${label}:</strong> ${q.q || ""}</div>`;

  let imageHtml = "";
  if (type === "img" && q.imgDataUrl) {
    imageHtml = `
      <div style="margin:8px 0;text-align:center;">
        <img src="${q.imgDataUrl}" alt="Fr√•gebild"
          style="max-width:100%;max-height:200px;border-radius:8px;display:inline-block;" />
      </div>
    `;
  }

  const optsHTML = (q.options || [])
    .map((opt, i) => {
      const id = `q${index}_opt${i}`;
      return `
      <label class="option-label" for="${id}">
        <input type="radio" name="q${index}" id="${id}" value="${i}">
        <span>${opt}</span>
      </label>`;
    })
    .join("");

  div.innerHTML =
    headerHtml +
    imageHtml +
    `
    <div class="options-list">${optsHTML}</div>
    <div class="mini">V√§lj ett alternativ.</div>
  `;

  host.appendChild(div);

  currentAnswers[index] = null;
  div.querySelectorAll("input[type=radio]").forEach(input => {
    input.addEventListener("change", () => {
      currentAnswers[index] = Number(input.value);
    });
  });
}

function buildGoalInfoText(q) {
  const chunks = [];

  // Huvud-delm√•l
  if (q.goal || q.parts) {
    let txt = "Delm√•l: " + (q.goal || "-");
    if (q.parts) {
      txt += " (Delbitar: " + q.parts + ")";
    }
    chunks.push(txt);
  }

  // Extra delm√•l (fr√•n Extra delm√•l/delbit)
  if (q.goalExtra || q.partsExtra) {
    let txt = "Delm√•l: " + (q.goalExtra || "-");
    if (q.partsExtra) {
      txt += " (Delbitar: " + q.partsExtra + ")";
    }
    chunks.push(txt);
  }

  // Ingen koppling alls
  if (!chunks.length) {
    return '<span class="goal-tag goal-tag-none">Ingen koppling till delm√•l</span>';
  }

  // G√∂r om varje textbit till en snygg ‚Äútag‚Äù
  return chunks
    .map(t => '<span class="goal-tag">' + t.replace(/</g,"&lt;").replace(/>/g,"&gt;") + '</span>')
    .join(" ");
}


function renderMcqOverview() {
  const s = loadState();
  const host = $("#mcqOverview");
  if (!host) return;
  host.innerHTML = "";

  const all = s.bank.mcq || [];
  if (all.length === 0) {
    host.innerHTML = '<div class="mini">Inga sparade fr√•gor √§nnu.</div>';
    return;
  }

  all.forEach((q, idx) => {
    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    if (lvl === "A") tagClass = "level-a";

    const goalInfo = buildGoalInfoText(q);

    const item = document.createElement("div");
    item.className = "list-item";
    item.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          [${idx + 1}] ${q.q || ""}
          <span class="level-tag ${tagClass}">${lvl}</span>
        </div>
        <div class="q-meta">
          ${goalInfo}
        </div>
      </div>
      <div>
        <button class="btn btn-sm btn-danger" data-del-index="${idx}">üóëÔ∏è Ta bort</button>
      </div>
    `;
    host.appendChild(item);
  });

  host.querySelectorAll("button[data-del-index]").forEach(btn => {
    btn.addEventListener("click", () => {
      const index = Number(btn.getAttribute("data-del-index"));
      const s2 = loadState();
      if (!s2.bank.mcq || index < 0 || index >= s2.bank.mcq.length) return;
      s2.bank.mcq.splice(index, 1);
      saveState(s2);
      renderMcqOverview();
    });
  });
}

function renderImgOverview() {
  const host = $("#imgOverview");
  if (!host) return;
  const s = loadState();
  const all = s.bank && Array.isArray(s.bank.img) ? s.bank.img : [];
  host.innerHTML = "";

  if (!all.length) {
    host.innerHTML = '<div class="mini">Inga sparade bildfr√•gor √§nnu.</div>';
    return;
  }

  all.forEach((q, idx) => {
    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    if (lvl === "A") tagClass = "level-a";

    const goalInfo = buildGoalInfoText(q);

    const thumbHtml = q.imgDataUrl
      ? `<div class="q-meta">
           <img src="${q.imgDataUrl}"
                alt="Miniatyr"
                style="max-height:40px;max-width:80px;border-radius:4px;display:block;" />
         </div>`
      : "";

    const item = document.createElement("div");
    item.className = "list-item";
    item.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          [${idx + 1}] ${q.q || ""} <span class="level-tag ${tagClass}">${lvl}</span> üñºÔ∏è
        </div>
        ${thumbHtml}
        <div class="q-meta">
          ${goalInfo}
        </div>
      </div>
      <div>
        <button class="btn btn-sm btn-danger" data-del-img-index="${idx}">üóëÔ∏è Ta bort</button>
      </div>
    `;
    host.appendChild(item);
  });

  host.querySelectorAll("button[data-del-img-index]").forEach(btn => {
    btn.addEventListener("click", () => {
      const index = Number(btn.getAttribute("data-del-img-index"));
      const s2 = loadState();
      if (!s2.bank.img || index < 0 || index >= s2.bank.img.length) return;
      s2.bank.img.splice(index, 1);
      saveState(s2);
      renderImgOverview();
    });
  });
}

function renderDragOverview() {
  const host = $("#dragOverview");
  if (!host) return;
  const s = loadState();
  const all = s.bank && Array.isArray(s.bank.drag) ? s.bank.drag : [];
  host.innerHTML = "";

  if (!all.length) {
    host.innerHTML = '<div class="mini">Inga sparade drag & drop-fr√•gor √§nnu.</div>';
    return;
  }

  all.forEach((q, idx) => {
    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    if (lvl === "A") tagClass = "level-a";

    const goalInfo = buildGoalInfoText(q);

    let itemsText = "";
    if (
      Array.isArray(q.categories) &&
      Array.isArray(q.items) &&
      q.categories.length &&
      q.items.length
    ) {
      itemsText = q.items
        .map(it => {
          const label = it.label || it.text || "";
          const cIdx =
            typeof it.categoryIndex === "number"
              ? it.categoryIndex
              : Number(it.categoryIndex);
          const cat = q.categories[cIdx] || {};
          const catName = cat.name || cat.label || "?";
          return label + " ‚Üí " + catName;
        })
        .join(" ¬∑ ");
    } else if (Array.isArray(q.pairs) && q.pairs.length) {
      itemsText = q.pairs
        .map(p => (p.left || "") + " ‚Üí " + (p.right || ""))
        .join(" ¬∑ ");
    } else if (Array.isArray(q.items)) {
      itemsText = q.items.join(" ¬∑ ");
    }

    const item = document.createElement("div");
    item.className = "list-item";
    item.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          [${idx + 1}] ${q.text || q.q || ""} <span class="level-tag ${tagClass}">${lvl}</span> üéØ
        </div>
        <div class="q-meta">
          ${goalInfo}
        </div>
        <div class="q-meta">
          Par/objekt: ${itemsText}
        </div>
      </div>
      <div>
        <button class="btn btn-sm btn-danger" data-del-drag-index="${idx}">üóëÔ∏è Ta bort</button>
      </div>
    `;
    host.appendChild(item);
  });

  host.querySelectorAll("button[data-del-drag-index]").forEach(btn => {
    btn.addEventListener("click", () => {
      const index = Number(btn.getAttribute("data-del-drag-index"));
      const s2 = loadState();
      if (!s2.bank.drag || index < 0 || index >= s2.bank.drag.length) return;
      s2.bank.drag.splice(index, 1);
      saveState(s2);
      renderDragOverview();
    });
  });
}

function ensureImgOptionsInitial() {
  const container = $("#imgOptionsContainer");
  if (!container) return;
  const existing = container.querySelectorAll(".field").length;
  if (existing > 0) return;
  for (let i = 0; i < 4; i++) {
    addImgOptionRow();
  }
}

function addImgOptionRow() {
  const container = $("#imgOptionsContainer");
  if (!container) return;
  const idx = container.querySelectorAll(".field").length;

  const row = document.createElement("div");
  row.className = "card-row";
  row.style.marginTop = "4px";

  const field = document.createElement("div");
  field.className = "field";
  field.style.display = "flex";
  field.style.alignItems = "center";
  field.style.gap = "6px";

  const radio = document.createElement("input");
  radio.type = "radio";
  radio.name = "imgCorrectOption";
  radio.value = String(idx);
  if (idx === 0) {
    radio.checked = true;
  }

  const input = document.createElement("input");
  input.className = "input";
  input.setAttribute("data-img-opt-index", String(idx));
  input.placeholder = "Alternativ " + (idx + 1);

  field.appendChild(radio);
  field.appendChild(input);
  row.appendChild(field);
  container.appendChild(row);
}

function addImgQuestion() {
  const levelSel = $("#imgQuestionLevel");
  const goalSel = $("#imgQuestionGoal");
  const textInp = $("#imgQuestionText");
  const status = $("#imgQuestionStatus");
  const container = $("#imgOptionsContainer");
  if (!levelSel || !textInp || !container) return;

  const level = levelSel.value || "E";
  const text = textInp.value.trim();

  const fields = Array.from(container.querySelectorAll(".field"));
  const options = [];
  let correctIdx = -1;

  fields.forEach(field => {
    const inp = field.querySelector("input[data-img-opt-index]");
    const radio = field.querySelector('input[type="radio"]');
    if (!inp || !radio) return;
    const val = inp.value.trim();
    if (!val) return;
    const newIndex = options.length;
    options.push(val);
    if (radio.checked) {
      correctIdx = newIndex;
    }
  });

  if (!text || options.length < 2) {
    if (status) {
      status.textContent = "Skriv fr√•getext och minst tv√• alternativ.";
      setTimeout(() => {
        status.textContent = "";
      }, 2000);
    }
    return;
  }

  if (!currentImageDataUrl) {
    if (status) {
      status.textContent = "V√§lj en bild till fr√•gan.";
      setTimeout(() => {
        status.textContent = "";
      }, 2000);
    }
    return;
  }

  if (correctIdx < 0) correctIdx = 0;
  if (correctIdx >= options.length) correctIdx = 0;

  const s = loadState();

  let goalText = null;
  let partsText = null;
  let goalExtraText = null;
  let partsExtraText = null;

  const goalId = goalSel && goalSel.value ? String(goalSel.value) : null;
  if (goalId) {
    const match = (s.goalsMap || []).find(g => String(g.id) === goalId);
    if (match) {
      goalText = match.goal || null;
      partsText = match.parts || null;
    }
  }

  const extraIds = (extraGoalSelections.img || []).filter(id => id !== goalId);
  if (extraIds.length) {
    const extraObjs = extraIds
      .map(id => (s.goalsMap || []).find(g => String(g.id) === String(id)))
      .filter(Boolean);
    const allGoals = Array.from(
      new Set(extraObjs.map(o => o.goal || "").filter(Boolean))
    );
    const allParts = Array.from(
      new Set(extraObjs.map(o => o.parts || "").filter(Boolean))
    );
    goalExtraText = allGoals.join(" | ") || null;
    partsExtraText = allParts.join(", ") || null;
  }

  if (!Array.isArray(s.bank.img)) s.bank.img = [];
  s.bank.img.push({
    level,
    type: "img",
    imgDataUrl: currentImageDataUrl,
    q: text,
    options,
    answer: correctIdx,
    goal: goalText,
    parts: partsText,
    goalExtra: goalExtraText,
    partsExtra: partsExtraText
  });

  saveState(s);
  renderImgOverview();

  // Nollst√§ll
  textInp.value = "";
  fields.forEach(field => {
    const inp = field.querySelector("input[data-img-opt-index]");
    if (inp) inp.value = "";
  });
  const imgPreview = $("#imgQuestionPreview");
  if (imgPreview) {
    imgPreview.innerHTML = '<span class="mini">Ingen bild vald √§nnu.</span>';
  }
  const fileInput = $("#imgQuestionFile");
  if (fileInput) fileInput.value = "";
  currentImageDataUrl = null;

  extraGoalSelections.img = [];
  renderExtraGoalChips("img");

  if (status) {
    status.textContent = "Bildfr√•ga sparad.";
    setTimeout(() => {
      status.textContent = "";
    }, 2000);
  }
}

/* === Ny drag & drop ‚Äì kategorier === */

function ensureDragCategoriesInitial() {
  const container = $("#dragCategoriesContainer");
  if (!container) return;
  if (container.querySelectorAll(".drag-category-row").length > 0) return;
  for (let i = 0; i < 3; i++) {
    addDragCategoryRow();
  }
  updateDragItemCategoryOptions();
}

function addDragCategoryRow() {
  const container = $("#dragCategoriesContainer");
  if (!container) return;

  const row = document.createElement("div");
  row.className = "card-row drag-category-row";
  row.style.marginTop = "4px";

  const fieldName = document.createElement("div");
  fieldName.className = "field";
  const input = document.createElement("input");
  input.className = "input";
  input.placeholder = "Kategori (t.ex. Amerikansk frukost)";
  input.setAttribute("data-drag-cat-name", "1");
  input.addEventListener("input", () => updateDragItemCategoryOptions());
  fieldName.appendChild(input);

  const fieldRemove = document.createElement("div");
  fieldRemove.className = "field";
  fieldRemove.style.flex = "0 0 auto";
  const btnRemove = document.createElement("button");
  btnRemove.className = "btn btn-sm btn-danger";
  btnRemove.type = "button";
  btnRemove.textContent = "üóëÔ∏è";
  btnRemove.addEventListener("click", () => {
    container.removeChild(row);
    updateDragItemCategoryOptions();
  });
  fieldRemove.appendChild(btnRemove);

  row.appendChild(fieldName);
  row.appendChild(fieldRemove);
  container.appendChild(row);

  updateDragItemCategoryOptions();
}

function ensureDragItemsInitial() {
  const container = $("#dragItemsContainer");
  if (!container) return;
  if (container.querySelectorAll(".drag-item-row").length > 0) return;
  for (let i = 0; i < 4; i++) {
    addDragItemRow();
  }
}

function addDragItemRow() {
  const container = $("#dragItemsContainer");
  if (!container) return;

  const row = document.createElement("div");
  row.className = "card-row drag-item-row";
  row.style.marginTop = "4px";

  const fieldLabel = document.createElement("div");
  fieldLabel.className = "field";
  const input = document.createElement("input");
  input.className = "input";
  input.placeholder = "Objekt (t.ex. pannkakor)";
  input.setAttribute("data-drag-item-label", "1");
  fieldLabel.appendChild(input);

  const fieldCat = document.createElement("div");
  fieldCat.className = "field";
  const sel = document.createElement("select");
  sel.className = "input";
  sel.setAttribute("data-drag-item-category", "1");
  fieldCat.appendChild(sel);

  const fieldRemove = document.createElement("div");
  fieldRemove.className = "field";
  fieldRemove.style.flex = "0 0 auto";
  const btnRemove = document.createElement("button");
  btnRemove.className = "btn btn-sm btn-danger";
  btnRemove.type = "button";
  btnRemove.textContent = "üóëÔ∏è";
  btnRemove.addEventListener("click", () => {
    container.removeChild(row);
  });
  fieldRemove.appendChild(btnRemove);

  row.appendChild(fieldLabel);
  row.appendChild(fieldCat);
  row.appendChild(fieldRemove);

  container.appendChild(row);

  updateDragItemCategoryOptions();
}

function updateDragItemCategoryOptions() {
  const catRows = Array.from(document.querySelectorAll(".drag-category-row"));
  const cats = catRows.map((row, idx) => {
    const inp = row.querySelector("input[data-drag-cat-name]");
    const name = (inp && inp.value.trim()) || "Kategori " + (idx + 1);
    return { index: idx, name };
  });

  const itemRows = Array.from(document.querySelectorAll(".drag-item-row"));
  itemRows.forEach(row => {
    const sel = row.querySelector("select[data-drag-item-category]");
    if (!sel) return;
    const prev = sel.value;
    sel.innerHTML = "";
    const optEmpty = document.createElement("option");
    optEmpty.value = "";
    optEmpty.textContent = "V√§lj kategori...";
    sel.appendChild(optEmpty);
    cats.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = String(cat.index);
      opt.textContent = cat.name;
      sel.appendChild(opt);
    });
    if (prev) sel.value = prev;
  });
}

function addDragQuestion() {
  const levelSel = $("#dragLevel");
  const goalSel = $("#dragGoal");
  const textInp = $("#dragQuestionText");
  const catContainer = $("#dragCategoriesContainer");
  const itemContainer = $("#dragItemsContainer");
  const status = $("#dragStatus");
  if (!levelSel || !textInp || !catContainer || !itemContainer) return;

  const level = levelSel.value || "E";
  const text = textInp.value.trim();

  const catRows = Array.from(catContainer.querySelectorAll(".drag-category-row"));
  const categories = [];
  catRows.forEach((row, idx) => {
    const inp = row.querySelector("input[data-drag-cat-name]");
    const name = inp ? inp.value.trim() : "";
    if (name) {
      categories.push({ name, index: idx });
    }
  });

  const itemRows = Array.from(itemContainer.querySelectorAll(".drag-item-row"));
  const items = [];
  itemRows.forEach(row => {
    const labelInp = row.querySelector("input[data-drag-item-label]");
    const catSel = row.querySelector("select[data-drag-item-category]");
    const label = labelInp ? labelInp.value.trim() : "";
    const catIdxStr = catSel ? catSel.value : "";
    if (label && catIdxStr !== "") {
      const catIndex = Number(catIdxStr);
      items.push({ label, categoryIndex: catIndex });
    }
  });

  if (!text || categories.length < 2 || items.length < 2) {
    if (status) {
      status.textContent =
        "Skriv instruktion, minst tv√• kategorier och minst tv√• objekt med vald kategori.";
      setTimeout(() => {
        status.textContent = "";
      }, 2500);
    }
    return;
  }

  const s = loadState();

  let goalText = null;
  let partsText = null;
  let goalExtraText = null;
  let partsExtraText = null;

  const goalId = goalSel && goalSel.value ? String(goalSel.value) : null;
  if (goalId) {
    const match = (s.goalsMap || []).find(g => String(g.id) === goalId);
    if (match) {
      goalText = match.goal || null;
      partsText = match.parts || null;
    }
  }

  const extraIds = (extraGoalSelections.drag || []).filter(id => id !== goalId);
  if (extraIds.length) {
    const extraObjs = extraIds
      .map(id => (s.goalsMap || []).find(g => String(g.id) === String(id)))
      .filter(Boolean);
    const allGoals = Array.from(
      new Set(extraObjs.map(o => o.goal || "").filter(Boolean))
    );
    const allParts = Array.from(
      new Set(extraObjs.map(o => o.parts || "").filter(Boolean))
    );
    goalExtraText = allGoals.join(" | ") || null;
    partsExtraText = allParts.join(", ") || null;
  }

  if (!Array.isArray(s.bank.drag)) s.bank.drag = [];
  s.bank.drag.push({
    level,
    type: "drag",
    text,
    categories: categories.map(c => ({ name: c.name })),
    items,
    goal: goalText,
    parts: partsText,
    goalExtra: goalExtraText,
    partsExtra: partsExtraText
  });

  saveState(s);
  renderDragOverview();

  textInp.value = "";
  catRows.forEach(row => {
    const inp = row.querySelector("input[data-drag-cat-name]");
    if (inp) inp.value = "";
  });
  itemRows.forEach(row => {
    const labelInp = row.querySelector("input[data-drag-item-label]");
    const catSel = row.querySelector("select[data-drag-item-category]");
    if (labelInp) labelInp.value = "";
    if (catSel) catSel.value = "";
  });

  updateDragItemCategoryOptions();

  extraGoalSelections.drag = [];
  renderExtraGoalChips("drag");

  if (status) {
    status.textContent = "Drag & drop-√∂vning sparad.";
    setTimeout(() => {
      status.textContent = "";
    }, 2500);
  }
}

/* =========================
   3g ‚Äì Progression per delm√•l (formativt)
   ========================= */

function ensureProgressLayout() {
  const panel = document.querySelector('.tab-panel[data-panel="progress"]');
  if (!panel) return;

  if (document.getElementById("progressDetailsContainer")) return;

  const card = panel.querySelector(".card");
  if (!card) return;

  const h3Details = document.createElement("h3");
  h3Details.textContent = "Detaljer per delm√•l";
  h3Details.style.marginTop = "10px";
  card.appendChild(h3Details);

  const pDetails = document.createElement("p");
  pDetails.className = "mini";
  pDetails.textContent =
    "Sammanfattning av hur eleven har svarat p√• fr√•gor kopplade till varje delm√•l.";
  card.appendChild(pDetails);

  const detailsList = document.createElement("div");
  detailsList.id = "progressDetailsContainer";
  detailsList.className = "list";
  card.appendChild(detailsList);

  const h3Next = document.createElement("h3");
  h3Next.textContent = "F√∂rslag p√• n√§sta steg";
  h3Next.style.marginTop = "10px";
  card.appendChild(h3Next);

  const nextList = document.createElement("div");
  nextList.id = "progressNextSteps";
  nextList.className = "list";
  card.appendChild(nextList);

  const h3Q = document.createElement("h3");
  h3Q.textContent = "Fr√•gor ‚Äì r√§tt och fel";
  h3Q.style.marginTop = "10px";
  card.appendChild(h3Q);

  const qList = document.createElement("div");
  qList.id = "progressQuestionsContainer";
  qList.className = "list";
  card.appendChild(qList);
}

function buildProgressStatsForCurrentStudent() {
  const s = loadState();
  const student = s.student || {};
  const name = student.name && student.name.trim();
  const klass = student.klass && student.klass.trim();
  if (!name || !klass || !s.history || !Array.isArray(s.history.mcq)) {
    return null;
  }

  const list = s.history.mcq.filter(
    e => e.studentName === name && e.studentClass === klass
  );
  if (!list.length) {
    return {
      byGoal: [],
      hardQuestions: [],
      easyQuestions: [],
      weakGoals: []
    };
  }

  const byGoalMap = new Map();
  const byQuestionMap = new Map();

  list.forEach(entry => {
    const qText = entry.q || "";
    const level = entry.level || "E";

    const combos = [];
    combos.push({ goal: entry.goal || null, parts: entry.parts || null });
    if (entry.goalExtra || entry.partsExtra) {
      combos.push({ goal: entry.goalExtra || null, parts: entry.partsExtra || null });
    }

    combos.forEach(({ goal, parts }) => {
      const keyGoal = (goal || "Okopplat delm√•l") + "||" + (parts || "-");
      let aggG = byGoalMap.get(keyGoal);
      if (!aggG) {
        aggG = {
          key: keyGoal,
          goal,
          parts,
          correct: 0,
          total: 0,
          wrongQuestionsSet: new Set()
        };
        byGoalMap.set(keyGoal, aggG);
      }
      aggG.total++;
      if (entry.correct) {
        aggG.correct++;
      } else if (qText) {
        aggG.wrongQuestionsSet.add(qText);
      }
    });

    const keyQ = qText + "||" + level;
    let aggQ = byQuestionMap.get(keyQ);
    if (!aggQ) {
      aggQ = {
        key: keyQ,
        q: qText,
        level,
        correct: 0,
        total: 0,
        goal: entry.goal || null,
        parts: entry.parts || null
      };
      byQuestionMap.set(keyQ, aggQ);
    }
    aggQ.total++;
    if (entry.correct) aggQ.correct++;
  });

  const byGoal = Array.from(byGoalMap.values()).map(g => {
    const percent = g.total > 0 ? Math.round((g.correct / g.total) * 100) : 0;
    let statusLabel = "";
    if (g.total < 3) {
      statusLabel = "F√∂r f√• fr√•gor";
    } else if (percent >= 80) {
      statusLabel = "Starkt (üü¢)";
    } else if (percent >= 40) {
      statusLabel = "P√• v√§g (üü°)";
    } else {
      statusLabel = "Beh√∂ver st√∂d (üî¥)";
    }
    return {
      key: g.key,
      goal: g.goal,
      parts: g.parts,
      correct: g.correct,
      total: g.total,
      percent,
      statusLabel,
      wrongExamples: Array.from(g.wrongQuestionsSet).slice(0, 3)
    };
  });

  const questions = Array.from(byQuestionMap.values()).map(q => {
    const percent = q.total > 0 ? Math.round((q.correct / q.total) * 100) : 0;
    return Object.assign({}, q, { percent });
  });

  const hardQuestions = questions
    .filter(q => q.total >= 1 && q.percent < 80)
    .sort((a, b) => a.percent - b.percent)
    .slice(0, 5);

  const easyQuestions = questions
    .filter(q => q.total >= 1 && q.percent >= 80)
    .sort((a, b) => b.percent - a.percent)
    .slice(0, 5);

  const weakGoals = byGoal
    .filter(g => g.total >= 2 && (g.goal || g.parts))
    .sort((a, b) => a.percent - b.percent)
    .slice(0, 3);

  return { byGoal, hardQuestions, easyQuestions, weakGoals };
}

function renderProgressDetails() {
  ensureProgressLayout();

  const detailsHost = $("#progressDetailsContainer");
  const nextHost = $("#progressNextSteps");
  const qHost = $("#progressQuestionsContainer");
  if (!detailsHost || !nextHost || !qHost) return;

  detailsHost.innerHTML = "";
  nextHost.innerHTML = "";
  qHost.innerHTML = "";

  const stats = buildProgressStatsForCurrentStudent();

  if (!stats || !stats.byGoal.length) {
    const d1 = document.createElement("div");
    d1.className = "mini";
    d1.textContent = "Inga svar kopplade till delm√•l √§nnu.";
    detailsHost.appendChild(d1);

    const d2 = document.createElement("div");
    d2.className = "mini";
    d2.textContent =
      "Spela F√•ngvaktaren med fr√•gor som √§r kopplade till delm√•l f√∂r att f√• konkreta f√∂rslag.";
    nextHost.appendChild(d2);

    const d3 = document.createElement("div");
    d3.className = "mini";
    d3.textContent = "Inga sparade fr√•geresultat f√∂r aktuell elev √§nnu.";
    qHost.appendChild(d3);
    return;
  }

  stats.byGoal.forEach(g => {
    const item = document.createElement("div");
    item.className = "list-item";

    const main = document.createElement("div");
    main.className = "list-main";

    const title = document.createElement("div");
    title.className = "q-text";
    title.textContent = g.goal || "Okopplat delm√•l";
    main.appendChild(title);

    const metaParts = document.createElement("div");
    metaParts.className = "q-meta";
    metaParts.textContent = "Delbitar: " + (g.parts || "-");
    main.appendChild(metaParts);

    const metaStatus = document.createElement("div");
    metaStatus.className = "q-meta";
    metaStatus.textContent = `Status: ${g.statusLabel} ‚Äì ${g.percent}% r√§tt (${g.correct}/${g.total} f√∂rs√∂k)`;
    main.appendChild(metaStatus);

    if (g.wrongExamples && g.wrongExamples.length) {
      const metaWrong = document.createElement("div");
      metaWrong.className = "q-meta";
      metaWrong.textContent =
        "Vanliga missf√∂rst√•nd: " + g.wrongExamples.join(" ¬∑ ");
      main.appendChild(metaWrong);
    }

    item.appendChild(main);
    detailsHost.appendChild(item);
  });

  if (!stats.weakGoals.length) {
    const no = document.createElement("div");
    no.className = "mini";
    no.textContent =
      "Inga tydliga svaga delm√•l √§nnu ‚Äì forts√§tt spela f√∂r mer underlag.";
    nextHost.appendChild(no);
  } else {
    stats.weakGoals.forEach(g => {
      const item = document.createElement("div");
      item.className = "list-item";
      const main = document.createElement("div");
      main.className = "list-main";

      const title = document.createElement("div");
      title.className = "q-text";
      title.textContent =
        (g.goal || "Delm√•l") + (g.parts ? " (" + g.parts + ")" : "");
      main.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "q-meta";
      meta.textContent =
        `Elevens resultat: ${g.percent}% (${g.correct}/${g.total} f√∂rs√∂k). ` +
        `F√∂rslag: repetera detta delm√•l och l√•t eleven spela om med fokus p√• dessa delbitar.`;
      main.appendChild(meta);

      item.appendChild(main);
      nextHost.appendChild(item);
    });
  }

  const hardTitle = document.createElement("div");
  hardTitle.className = "mini";
  hardTitle.textContent = "Fr√•gor eleven oftast svarar fel p√•:";
  qHost.appendChild(hardTitle);

  if (!stats.hardQuestions.length) {
    const noHard = document.createElement("div");
    noHard.className = "mini";
    noHard.textContent = "Inga tydliga sv√•ra fr√•gor √§nnu.";
    qHost.appendChild(noHard);
  } else {
    stats.hardQuestions.forEach(q => {
      const item = document.createElement("div");
      item.className = "list-item";
      const main = document.createElement("div");
      main.className = "list-main";

      const title = document.createElement("div");
      title.className = "q-text";
      title.textContent = q.q || "(fr√•getext saknas)";
      main.appendChild(title);

      const meta1 = document.createElement("div");
      meta1.className = "q-meta";
      meta1.textContent = `Niv√•: ${q.level} ¬∑ R√§tt: ${q.correct}/${q.total} (${q.percent}%)`;
      main.appendChild(meta1);

      if (q.goal || q.parts) {
        const meta2 = document.createElement("div");
        meta2.className = "q-meta";
        meta2.textContent =
          "Delm√•l: " +
          (q.goal || "-") +
          (q.parts ? " ¬∑ Delbitar: " + q.parts : "");
        main.appendChild(meta2);
      }

      item.appendChild(main);
      qHost.appendChild(item);
    });
  }

  const easyTitle = document.createElement("div");
  easyTitle.className = "mini";
  easyTitle.style.marginTop = "4px";
  easyTitle.textContent = "Fr√•gor eleven verkar s√§ker p√•:";
  qHost.appendChild(easyTitle);

  if (!stats.easyQuestions.length) {
    const noEasy = document.createElement("div");
    noEasy.className = "mini";
    noEasy.textContent = "Inga fr√•gor sticker ut som s√§rskilt s√§kra √§nnu.";
    qHost.appendChild(noEasy);
  } else {
    stats.easyQuestions.forEach(q => {
      const item = document.createElement("div");
      item.className = "list-item";
      const main = document.createElement("div");
      main.className = "list-main";

      const title = document.createElement("div");
      title.className = "q-text";
      title.textContent = q.q || "(fr√•getext saknas)";
      main.appendChild(title);

      const meta1 = document.createElement("div");
      meta1.className = "q-meta";
      meta1.textContent = `Niv√•: ${q.level} ¬∑ R√§tt: ${q.correct}/${q.total} (${q.percent}%)`;
      main.appendChild(meta1);

      if (q.goal || q.parts) {
        const meta2 = document.createElement("div");
        meta2.className = "q-meta";
        meta2.textContent =
          "Delm√•l: " +
          (q.goal || "-") +
          (q.parts ? " ¬∑ Delbitar: " + q.parts : "");
        main.appendChild(meta2);
      }

      item.appendChild(main);
      qHost.appendChild(item);
    });
  }
}

/* =========================
   3h ‚Äì Spelstart & avslut
   ========================= */

function startLevel(levelChar) {
  if (!ensureStudentSet()) return;
  const s = loadState();
  let unlocked = false;
  if (levelChar === "E") unlocked = !!(s.student.name && s.student.klass);
  if (levelChar === "C") unlocked = !!s.unlocked.C;
  if (levelChar === "A") unlocked = !!s.unlocked.A;
  if (!unlocked) {
    alert("Denna niv√• √§r l√•st.");
    return;
  }

  currentLevel = levelChar;
  const play = $("#play");
  const result = $("#result");
  const grid = $(".levels-grid");
  const studentCard = $("#studentCard");
  if (play) play.classList.remove("hidden");
  if (result) result.classList.add("hidden");
  if (grid) grid.style.opacity = "0.25";
  if (studentCard) studentCard.classList.add("hidden");

  const who = $("#whoPlays");
  if (who) who.textContent = `${s.student.name} (${s.student.klass})`;

  const title = $("#play-title");
  if (title) {
    if (levelChar === "E") title.textContent = "Niv√• 1 ‚Äì E";
    else if (levelChar === "C") title.textContent = "Niv√• 2 ‚Äì C";
    else title.textContent = "Niv√• 3 ‚Äì A";
  }

  const host = $("#questions");
  if (!host) return;
  host.innerHTML = '<div class="question mini">Laddar fr√•gor...</div>';

  const mcqList = (s.bank.mcq || []).filter(
    q => (q.level || "E") === levelChar && (q.type || "mcq") === "mcq"
  );
  const imgList = (s.bank.img || []).filter(
    q => (q.level || "E") === levelChar && q.type === "img"
  );
  const dragList = (s.bank.drag || []).filter(
    q => (q.level || "E") === levelChar && q.type === "drag"
  );

  currentQuestions = mcqList.concat(imgList, dragList);
  currentAnswers = new Array(currentQuestions.length).fill(null);

  if (currentQuestions.length === 0) {
    host.innerHTML = '<div class="question mini">Inga fr√•gor p√• denna niv√• √§nnu.</div>';
    return;
  }

  host.innerHTML = "";
  currentQuestions.forEach((q, idx) => renderQuestion(q, idx, host));
}

function cancelPlay() {
  const play = $("#play");
  const grid = $(".levels-grid");
  const studentCard = $("#studentCard");
  const result = $("#result");
  if (play) play.classList.add("hidden");
  if (result) result.classList.add("hidden");
  if (grid) grid.style.opacity = "1";
  if (studentCard) studentCard.classList.remove("hidden");
  currentLevel = null;
}

function finishLevel() {
  if (!currentLevel || currentQuestions.length === 0) {
    alert("Ingen aktiv niv√•.");
    return;
  }
  const s = loadState();
  const nowIso = new Date().toISOString();

  let total = currentQuestions.length;
  let correct = 0;

  const detailsByGoalMap = {};
  const playedQuestions = [];

  if (!s.history || !Array.isArray(s.history.mcq)) {
    s.history = { mcq: [] };
  }

  currentQuestions.forEach((q, idx) => {
    const type = q.type || "mcq";
    const goal = q.goal || null;
    const parts = q.parts || null;
    const goalExtra = q.goalExtra || null;
    const partsExtra = q.partsExtra || null;

    let ans = currentAnswers[idx];
    let isCorrect = false;

    if (
      type === "drag" &&
      Array.isArray(q.categories) &&
      Array.isArray(q.items) &&
      q.categories.length &&
      q.items.length
    ) {
      const mapping = ans && ans.mapping ? ans.mapping : {};
      let allGood = true;
      for (let i = 0; i < q.items.length; i++) {
        const expected = Number(
          typeof q.items[i].categoryIndex === "number"
            ? q.items[i].categoryIndex
            : Number(q.items[i].categoryIndex)
        );
        const got = mapping[i];
        if (got === undefined || got === null || Number(got) !== expected) {
          allGood = false;
          break;
        }
      }
      isCorrect = allGood;
    } else if (type === "drag" && Array.isArray(q.pairs) && q.pairs.length > 0) {
      const selObj = ans && ans.selected ? ans.selected : {};
      let allGood = true;
      for (let i = 0; i < q.pairs.length; i++) {
        const expected = String(q.pairs[i].right || "");
        const got = selObj[i] ? String(selObj[i]) : "";
        if (!got || got !== expected) {
          allGood = false;
          break;
        }
      }
      isCorrect = allGood;
    } else {
      isCorrect = ans === q.answer;
    }

    if (isCorrect) correct++;

    const baseKey = (goal || "Okopplat delm√•l") + "||" + (parts || "-");
    if (!detailsByGoalMap[baseKey]) {
      detailsByGoalMap[baseKey] = {
        goal,
        parts,
        correct: 0,
        total: 0
      };
    }
    detailsByGoalMap[baseKey].total++;
    if (isCorrect) detailsByGoalMap[baseKey].correct++;

    if (goalExtra || partsExtra) {
      const extraKey =
        (goalExtra || "Okopplat delm√•l") + "||" + (partsExtra || "-");
      if (!detailsByGoalMap[extraKey]) {
        detailsByGoalMap[extraKey] = {
          goal: goalExtra,
          parts: partsExtra,
          correct: 0,
          total: 0
        };
      }
      detailsByGoalMap[extraKey].total++;
      if (isCorrect) detailsByGoalMap[extraKey].correct++;
    }

    s.history.mcq.push({
      studentName: s.student.name || "",
      studentClass: s.student.klass || "",
      level: currentLevel,
      type,
      q: q.q || q.text || "",
      correct: isCorrect,
      goal,
      parts,
      goalExtra,
      partsExtra,
      timestamp: nowIso
    });

    if (
      type === "drag" &&
      Array.isArray(q.categories) &&
      Array.isArray(q.items) &&
      q.categories.length &&
      q.items.length
    ) {
      playedQuestions.push({
        type: "dragcat",
        level: currentLevel,
        text: q.text || q.q || "",
        categories: q.categories.map(c => ({
          name: c.name || c.label || ""
        })),
        items: q.items.map(it => ({
          label: it.label || it.text || "",
          categoryIndex:
            typeof it.categoryIndex === "number"
              ? it.categoryIndex
              : Number(it.categoryIndex) || 0
        })),
        mapping: ans && ans.mapping ? ans.mapping : {},
        isCorrect,
        goal,
        parts,
        goalExtra,
        partsExtra
      });
    } else if (type === "drag") {
      playedQuestions.push({
        type: "drag",
        level: currentLevel,
        text: q.text || q.q || "",
        pairs: Array.isArray(q.pairs) ? q.pairs : [],
        selected: ans && ans.selected ? ans.selected : {},
        isCorrect,
        goal,
        parts,
        goalExtra,
        partsExtra
      });
    } else {
      playedQuestions.push({
        type: type,
        level: currentLevel,
        q: q.q || "",
        options: Array.isArray(q.options) ? q.options.slice() : [],
        correctOptionIndex: q.answer,
        chosenOptionIndex: ans != null ? ans : null,
        isCorrect,
        goal,
        parts,
        goalExtra,
        partsExtra
      });
    }
  });

  const percent = total > 0 ? Math.round((correct / total) * 100) : 0;

  if (currentLevel === "E") s.best.E = Math.max(s.best.E || 0, percent);
  if (currentLevel === "C") s.best.C = Math.max(s.best.C || 0, percent);
  if (currentLevel === "A") s.best.A = Math.max(s.best.A || 0, percent);

  if (currentLevel === "E") s.unlocked.C = true;
  if (currentLevel === "C") s.unlocked.A = true;

  const progressByGoal = {};
  Object.keys(detailsByGoalMap).forEach(key => {
    const g = detailsByGoalMap[key];
    const pct = g.total > 0 ? Math.round((g.correct / g.total) * 100) : 0;
    progressByGoal[key] = {
      goal: g.goal,
      parts: g.parts,
      correct: g.correct,
      total: g.total,
      percent: pct
    };
  });

  const weakGoalsSuggestions = Object.values(progressByGoal)
    .filter(g => (g.goal || g.parts) && g.total >= 1)
    .sort((a, b) => a.percent - b.percent)
    .slice(0, 3);

  lastSubmission = {
    studentName: s.student.name,
    studentClass: s.student.klass,
    level: currentLevel,
    scorePercent: percent,
    correct,
    total,
    timestamp: nowIso,
    progressByGoal,
    suggestedFocusGoals: weakGoalsSuggestions,
    playedQuestions
  };

  saveState(s);

  const play = $("#play");
  const result = $("#result");
  const grid = $(".levels-grid");
  const studentCard = $("#studentCard");
  if (play) play.classList.add("hidden");
  if (grid) grid.style.opacity = "1";
  if (studentCard) studentCard.classList.add("hidden");
  if (result) result.classList.remove("hidden");

  const scoreText = $("#scoreText");
  const scoreDetail = $("#scoreDetail");
  const resName = $("#resName");
  const resClass = $("#resClass");
  const passBadge = $("#passBadge");
  const unlockText = $("#unlockText");

  if (scoreText) scoreText.textContent = percent + "%";
  if (scoreDetail) scoreDetail.textContent = `${correct}/${total} po√§ng`;
  if (resName) resName.textContent = s.student.name || "-";
  if (resClass) resClass.textContent = s.student.klass || "-";

  const thres = s.thresholds[currentLevel];
  const passed = percent >= thres;
  if (passBadge) {
    if (passed) {
      passBadge.className = "badge-pass";
      passBadge.textContent =
        currentLevel === "A" ? "üèÅ Godk√§nd niv√•!" : "‚úÖ Godk√§nd niv√•!";
    } else {
      passBadge.className = "badge-fail";
      passBadge.textContent = "‚ùå Ej godk√§nd, men niv√•n √§r spelad.";
    }
  }

  if (unlockText) {
    let msg = "";
    if (currentLevel === "E" && s.unlocked.C) msg = "Niv√• 2 √§r nu uppl√•st.";
    if (currentLevel === "C" && s.unlocked.A) msg = "Niv√• 3 √§r nu uppl√•st.";
    if (currentLevel === "A") msg = "Alla niv√•er har spelats minst en g√•ng.";
    unlockText.textContent = msg;
  }

  const exportSection = $("#exportSection");
  const exportJson = $("#exportJson");
  if (exportSection && exportJson) {
    const json = JSON.stringify(lastSubmission, null, 2);
    exportJson.value = json;
  }

  renderProgressDetails();
  syncUI();
}

/* =========================
   3i ‚Äì L√§rarl√§ge: gate & flikar
   ========================= */

function openTeacherGate() {
  const gate = $("#teacherGate");
  const inp = $("#teacherPasswordInput");
  const txt = $("#teacherGateText");
  const s = loadState();
  if (txt) {
    txt.textContent = s.teacherPassword
      ? "Ange ditt l√§rarl√∂senord."
      : "F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.";
  }
  if (gate) gate.classList.remove("hidden");
  if (inp) {
    inp.value = "";
    inp.focus();
  }
}

function closeTeacherGate() {
  const gate = $("#teacherGate");
  if (gate) gate.classList.add("hidden");
}

function openTeacherModal() {
  const modal = $("#teacherModal");
  if (modal) modal.classList.remove("hidden");
  setActiveTeacherTab("settings");
  refreshMcqGoalSelect();
  fillTeacherSettings();
  syncUI();
}

function closeTeacherModal() {
  const modal = $("#teacherModal");
  if (modal) modal.classList.add("hidden");
}

function handleTeacherConfirm() {
  const inp = $("#teacherPasswordInput");
  if (!inp) return;
  const pw = inp.value.trim();
  if (!pw) {
    alert("Ange ett l√∂senord.");
    return;
  }
  const s = loadState();
  if (!s.teacherPassword) {
    s.teacherPassword = pw;
    saveState(s);
    closeTeacherGate();
    openTeacherModal();
  } else {
    if (pw === s.teacherPassword) {
      closeTeacherGate();
      openTeacherModal();
    } else {
      alert("Fel l√∂senord.");
    }
  }
}

function setActiveTeacherTab(tabName) {
  $all(".tab-btn").forEach(btn => {
    const tn = btn.getAttribute("data-tab");
    btn.classList.toggle("active", tn === tabName);
  });
  $all(".tab-panel").forEach(panel => {
    const pn = panel.getAttribute("data-panel");
    panel.classList.toggle("hidden", pn !== tabName);
  });
}

function fillTeacherSettings() {
  const s = loadState();
  const tE = $("#inputThresE");
  const tC = $("#inputThresC");
  const tA = $("#inputThresA");
  const mail = $("#inputTeacherEmail");
  if (tE) tE.value = s.thresholds.E;
  if (tC) tC.value = s.thresholds.C;
  if (tA) tA.value = s.thresholds.A;
  if (mail) mail.value = s.teacherEmail || "";
}

/* =========================
   3j ‚Äì Settings-h√§ndelser
   ========================= */

function saveThresholds() {
  const s = loadState();
  const tE = $("#inputThresE");
  const tC = $("#inputThresC");
  const tA = $("#inputThresA");
  const status = $("#settingsStatus");

  s.thresholds.E = clampInt(
    tE ? tE.value : s.thresholds.E,
    0,
    100,
    s.thresholds.E
  );
  s.thresholds.C = clampInt(
    tC ? tC.value : s.thresholds.C,
    0,
    100,
    s.thresholds.C
  );
  s.thresholds.A = clampInt(
    tA ? tA.value : s.thresholds.A,
    0,
    100,
    s.thresholds.A
  );

  saveState(s);
  syncUI();
  if (status) {
    status.textContent = "Niv√•-gr√§nser sparade.";
    setTimeout(() => {
      status.textContent = "";
    }, 2000);
  }
}

function saveTeacherEmailOnly() {
  const s = loadState();
  const mail = $("#inputTeacherEmail");
  const status = $("#teacherEmailStatus");
  if (mail) s.teacherEmail = mail.value.trim();
  saveState(s);
  if (status) {
    status.textContent = "E-postadress sparad.";
    setTimeout(() => {
      status.textContent = "";
    }, 2000);
  }
}

function clearStudent() {
  const s = loadState();
  s.student = { name: "", klass: "" };
  s.best = { E: 0, C: 0, A: 0 };
  s.unlocked = { C: false, A: false };
  saveState(s);
  syncUI();
  const status = $("#settingsStatus");
  if (status) {
    status.textContent = "Elevdata rensad (g√§ller bara denna dator).";
    setTimeout(() => {
      status.textContent = "";
    }, 2500);
  }
}

function resetGame() {
  if (
    !confirm(
      "√Ñr du s√§ker p√• att du vill nollst√§lla allt (fr√•gor, elev, resultat)?"
    )
  )
    return;
  const sOld = loadState();
  const fresh = deepCloneDefault();
  fresh.teacherPassword = sOld.teacherPassword || "";
  fresh.teacherEmail = sOld.teacherEmail || "";
  saveState(fresh);
  syncUI();
  const status = $("#settingsStatus");
  if (status) {
    status.textContent = "Spelet √§r nollst√§llt.";
    setTimeout(() => {
      status.textContent = "";
    }, 2500);
  }
}

function addGoalPart() {
  const goalInp = $("#inputGoalSingle");
  const partInp = $("#inputPartSingle");
  const status = $("#goalsStatus");
  if (!goalInp || !partInp) return;
  const goal = goalInp.value.trim();
  const parts = partInp.value.trim();
  if (!goal || !parts) {
    if (status) {
      status.textContent = "Skriv b√•de delm√•l och delbit.";
      setTimeout(() => {
        status.textContent = "";
      }, 2000);
    }
    return;
  }
  const s = loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];
  s.goalsMap.push({
    id: Date.now().toString(16) + Math.random().toString(16).slice(2),
    goal,
    parts
  });
  saveState(s);
  renderGoalsList();
  partInp.value = "";
  if (status) {
    status.textContent = "Delm√•l/delbit tillagd.";
    setTimeout(() => {
      status.textContent = "";
    }, 2000);
  }
}

function saveGoalsMap() {
  const status = $("#goalsStatus");
  if (status) {
    status.textContent =
      "Kopplingar √§r sparade i denna webbl√§sare (och f√∂ljer med till moln-banker).";
    setTimeout(() => {
      status.textContent = "";
    }, 2000);
  }
}

function clearGoalsMap() {
  if (!confirm("Ta bort alla sparade kopplingar (delm√•l/delbit)?")) return;
  const s = loadState();
  s.goalsMap = [];
  saveState(s);
  renderGoalsList();
  const status = $("#goalsStatus");
  if (status) {
    status.textContent = "Alla kopplingar borttagna.";
    setTimeout(() => {
      status.textContent = "";
    }, 2500);
  }
}

function changeTeacherPassword() {
  const s = loadState();
  const oldInp = $("#inputOldPassword");
  const newInp = $("#inputNewPassword");
  const repInp = $("#inputNewPasswordRepeat");
  const status = $("#passwordStatus");

  const oldVal = oldInp ? oldInp.value.trim() : "";
  const newVal = newInp ? newInp.value.trim() : "";
  const repVal = repInp ? repInp.value.trim() : "";

  if (!newVal || newVal.length < 3) {
    if (status) status.textContent = "Nytt l√∂senord m√•ste vara minst 3 tecken.";
    return;
  }
  if (newVal !== repVal) {
    if (status) status.textContent = "Nytt l√∂senord och upprepning matchar inte.";
    return;
  }
  if (s.teacherPassword && oldVal !== s.teacherPassword) {
    if (status) status.textContent = "Nuvarande l√∂senord st√§mmer inte.";
    return;
  }

  s.teacherPassword = newVal;
  saveState(s);
  if (status) {
    status.textContent = "L√∂senord uppdaterat.";
    setTimeout(() => {
      status.textContent = "";
    }, 2000);
  }
  if (oldInp) oldInp.value = "";
  if (newInp) newInp.value = "";
  if (repInp) repInp.value = "";
}

/* =========================
   3k ‚Äì Fr√•gebank: l√§gga till MCQ / textimport
   ========================= */

function addMcq() {
  const s = loadState();
  const lvlSel = $("#newMcqLevel");
  const textInp = $("#newMcqText");
  const o0 = $("#newMcqOpt0");
  const o1 = $("#newMcqOpt1");
  const o2 = $("#newMcqOpt2");
  const o3 = $("#newMcqOpt3");
  const corrSel = $("#newMcqCorrect");
  const goalSel = $("#newMcqGoal");
  const status = $("#mcqStatus");

  if (!lvlSel || !textInp || !o0 || !o1 || !o2 || !o3 || !corrSel) return;

  const level = lvlSel.value || "E";
  const text = textInp.value.trim();
  const opts = [
    o0.value.trim(),
    o1.value.trim(),
    o2.value.trim(),
    o3.value.trim()
  ];
  const correctIdx = Number(corrSel.value);

  if (!text || opts.some(o => !o)) {
    if (status) status.textContent = "Fyll i fr√•ga och alla alternativ.";
    return;
  }

  let goalText = null;
  let partsText = null;
  let goalExtraText = null;
  let partsExtraText = null;

  const goalId = goalSel && goalSel.value ? String(goalSel.value) : null;
  if (goalId) {
    const match = (s.goalsMap || []).find(g => String(g.id) === goalId);
    if (match) {
      goalText = match.goal || null;
      partsText = match.parts || null;
    }
  }

  const extraIds = (extraGoalSelections.mcq || []).filter(id => id !== goalId);
  if (extraIds.length) {
    const extraObjs = extraIds
      .map(id => (s.goalsMap || []).find(g => String(g.id) === String(id)))
      .filter(Boolean);
    const allGoals = Array.from(
      new Set(extraObjs.map(o => o.goal || "").filter(Boolean))
    );
    const allParts = Array.from(
      new Set(extraObjs.map(o => o.parts || "").filter(Boolean))
    );
    goalExtraText = allGoals.join(" | ") || null;
    partsExtraText = allParts.join(", ") || null;
  }

  if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
  s.bank.mcq.push({
    level,
    type: "mcq",
    q: text,
    options: opts,
    answer: correctIdx,
    goal: goalText,
    parts: partsText,
    goalExtra: goalExtraText,
    partsExtra: partsExtraText
  });

  saveState(s);
  renderMcqOverview();

  textInp.value = "";
  o0.value = "";
  o1.value = "";
  o2.value = "";
  o3.value = "";

  extraGoalSelections.mcq = [];
  renderExtraGoalChips("mcq");

  if (status) {
    status.textContent = "Fr√•ga sparad.";
    setTimeout(() => {
      status.textContent = "";
    }, 2000);
  }
}

function addMcqFromJson() {
  const ta = $("#mcqJsonInput");
  const status = $("#mcqJsonStatus");
  if (!ta) return;

  const raw = ta.value;
  if (!raw.trim()) {
    if (status) {
      status.textContent = "F√§ltet √§r tomt.";
      setTimeout(() => {
        status.textContent = "";
      }, 2000);
    }
    return;
  }

  const lvlSel = $("#newMcqLevel");
  const goalSel = $("#newMcqGoal");
  const level = (lvlSel && lvlSel.value) ? lvlSel.value : "E";

  const s = loadState();

  let goalText = null;
  let partsText = null;
  let goalExtraText = null;
  let partsExtraText = null;

  const goalId = goalSel && goalSel.value ? String(goalSel.value) : null;
  if (goalId) {
    const match = (s.goalsMap || []).find(g => String(g.id) === goalId);
    if (match) {
      goalText = match.goal || null;
      partsText = match.parts || null;
    }
  }

  const extraIds = (extraGoalSelections.mcq || []).filter(id => id !== goalId);
  if (extraIds.length) {
    const extraObjs = extraIds
      .map(id => (s.goalsMap || []).find(g => String(g.id) === String(id)))
      .filter(Boolean);
    const allGoals = Array.from(
      new Set(extraObjs.map(o => o.goal || "").filter(Boolean))
    );
    const allParts = Array.from(
      new Set(extraObjs.map(o => o.parts || "").filter(Boolean))
    );
    goalExtraText = allGoals.join(" | ") || null;
    partsExtraText = allParts.join(", ") || null;
  }

  const blocks = raw.split(/\n\s*\n+/);
  let added = 0;

  blocks.forEach(block => {
    const lines = block
      .split("\n")
      .map(l => l.trim())
      .filter(l => l.length > 0);

    if (lines.length !== 5) return;

    const qText = lines[0];
    const answerLines = lines.slice(1);

    const correctIdx = answerLines.findIndex(line => line.startsWith("*"));
    if (!qText || correctIdx === -1) return;

    const options = answerLines.map(line => line.replace(/^\*/, "").trim());

    if (options.some(o => !o)) return;

    if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
    s.bank.mcq.push({
      level,
      type: "mcq",
      q: qText,
      options,
      answer: correctIdx,
      goal: goalText,
      parts: partsText,
      goalExtra: goalExtraText,
      partsExtra: partsExtraText
    });
    added++;
  });

  saveState(s);
  renderMcqOverview();

  extraGoalSelections.mcq = [];
  renderExtraGoalChips("mcq");

  if (status) {
    status.textContent = `${added} fr√•ga/fr√•gor inlagda fr√•n text.`;
    setTimeout(() => {
      status.textContent = "";
    }, 2500);
  }
}

/* =========================
   3l ‚Äì Fr√•gebank JSON (export/import ‚Äì kompatibilitet)
   ========================= */

function refreshBankExport() {
  const s = loadState();
  const ta = $("#bankExportJson");
  if (!ta) return;
  const bankOut = {
    mcq: s.bank && Array.isArray(s.bank.mcq) ? s.bank.mcq : [],
    img: s.bank && Array.isArray(s.bank.img) ? s.bank.img : [],
    drag: s.bank && Array.isArray(s.bank.drag) ? s.bank.drag : [],
    goalsMap: Array.isArray(s.goalsMap) ? s.goalsMap : []
  };
  ta.value = JSON.stringify(bankOut, null, 2);
}

function copyToClipboardFromElement(el, statusEl) {
  if (!el) return;
  try {
    el.select();
    document.execCommand("copy");
    if (statusEl) {
      statusEl.textContent = "Kopierat till urklipp.";
      setTimeout(() => {
        statusEl.textContent = "";
      }, 2000);
    }
  } catch (e) {
    console.error("copy failed", e);
  }
}

function copyBankJson() {
  const ta = $("#bankExportJson");
  const status = $("#bankExportStatus");
  copyToClipboardFromElement(ta, status);
}

function importBankJson() {
  const ta = $("#bankImportJson");
  const status = $("#bankImportStatus");
  if (!ta) return;
  let data;
  try {
    data = JSON.parse(ta.value);
  } catch (e) {
    if (status) {
      status.textContent = "Ogiltig JSON ‚Äì kunde inte tolkas.";
      setTimeout(() => {
        status.textContent = "";
      }, 2500);
    }
    return;
  }
  const s = loadState();

  let mcqArr = [];
  let imgArr = [];
  let dragArr = [];
  let goalsMapArr = [];

  if (Array.isArray(data)) {
    mcqArr = data;
  } else if (data && typeof data === "object") {
    if (Array.isArray(data.mcq)) mcqArr = data.mcq;
    if (Array.isArray(data.img)) imgArr = data.img;
    if (Array.isArray(data.drag)) dragArr = data.drag;
    if (Array.isArray(data.goalsMap)) goalsMapArr = data.goalsMap;
  } else {
    if (status) {
      status.textContent =
        "Ogiltigt format ‚Äì f√∂rv√§ntar en array eller ett objekt med mcq/img/drag/goalsMap.";
      setTimeout(() => {
        status.textContent = "";
      }, 2500);
    }
    return;
  }

  const normMcq = mcqArr.map(item => ({
    level: item.level || "E",
    type: "mcq",
    q: item.q || "",
    options: Array.isArray(item.options)
      ? item.options.map(o => String(o))
      : [],
    answer: clampInt(
      item.answer,
      0,
      (item.options || []).length - 1,
      0
    ),
    goal: item.goal || null,
    parts: item.parts || null,
    goalExtra: item.goalExtra || null,
    partsExtra: item.partsExtra || null
  }));

  const normImg = imgArr.map(item => ({
    level: item.level || "E",
    type: "img",
    imgDataUrl: item.imgDataUrl || item.image || "",
    q: item.q || "",
    options: Array.isArray(item.options)
      ? item.options.map(o => String(o))
      : [],
    answer: clampInt(
      item.answer,
      0,
      (item.options || []).length - 1,
      0
    ),
    goal: item.goal || null,
    parts: item.parts || null,
    goalExtra: item.goalExtra || null,
    partsExtra: item.partsExtra || null
  }));

  const normDrag = dragArr.map(item => {
    const out = {
      level: item.level || "E",
      type: item.type || "drag",
      text: item.text || item.q || "",
      goal: item.goal || null,
      parts: item.parts || null,
      goalExtra: item.goalExtra || null,
      partsExtra: item.partsExtra || null
    };
    if (Array.isArray(item.categories) && Array.isArray(item.items)) {
      out.categories = item.categories.map(c => ({
        name: c.name || c.label || ""
      }));
      out.items = item.items.map(it => ({
        label: it.label || it.text || "",
        categoryIndex:
          typeof it.categoryIndex === "number"
            ? it.categoryIndex
            : Number(it.categoryIndex) || 0
      }));
    } else if (Array.isArray(item.pairs)) {
      out.pairs = item.pairs.map(p => ({ left: p.left, right: p.right }));
    }
    return out;
  });

  s.bank = {
    mcq: normMcq,
    img: normImg,
    drag: normDrag
  };
  if (goalsMapArr.length) {
    s.goalsMap = goalsMapArr;
  }

  saveState(s);
  renderMcqOverview();
  renderImgOverview();
  renderDragOverview();
  renderGoalsList();

  if (status) {
    status.textContent = "Fr√•gebank importerad och sparad.";
    setTimeout(() => {
      status.textContent = "";
    }, 2500);
  }
}

/* =========================
   3m ‚Äì Exportresultat (JSON/e-post)
   ========================= */

function copyExportJson() {
  const ta = $("#exportJson");
  const status = $("#exportStatus");
  copyToClipboardFromElement(ta, status);
}

function emailExportJson() {
  const s = loadState();
  const status = $("#exportStatus");
  if (!lastSubmission) {
    if (status) {
      status.textContent = "Inget resultat att skicka √§nnu.";
      setTimeout(() => {
        status.textContent = "";
      }, 2500);
    }
    return;
  }
  const to = s.teacherEmail || "";
  const subject = encodeURIComponent("F√•ngvaktaren ‚Äì elevresultat");
  const body = encodeURIComponent(JSON.stringify(lastSubmission, null, 2));
  const mailto = "mailto:" + to + "?subject=" + subject + "&body=" + body;
  window.location.href = mailto;
  if (status) {
    status.textContent = "E-postkladd √∂ppnad (i din e-postklient).";
    setTimeout(() => {
      status.textContent = "";
    }, 2500);
  }
}

/* =========================
   3n ‚Äì Init
   ========================= */

document.addEventListener("DOMContentLoaded", () => {
  mergeEmbeddedBank();
  syncUI();

  // Firebase init (ingen inloggning f√∂rr√§n knapp trycks)
  initFirebase();
  if (firebaseAuthInstance) {
    firebaseAuthInstance.onAuthStateChanged(user => {
      currentTeacherUser = user || null;
      updateGoogleUi();
      if (user) {
        loadCloudBanksList();
      } else {
        setCloudBankStatus("Logga in med Google f√∂r att anv√§nda moln-banker.");
      }
    });
  } else {
    updateGoogleUi();
  }

  // Elevknappar
  const btnSaveStudent = $("#btnSaveStudent");
  if (btnSaveStudent) {
    btnSaveStudent.addEventListener("click", () => {
      const s = loadState();
      const n = $("#studentName");
      const k = $("#studentClass");
      s.student.name = n ? n.value.trim() : "";
      s.student.klass = k ? k.value.trim() : "";
      saveState(s);
      syncUI();
    });
  }

  const btnE = $("#start-levelE");
  const btnC = $("#start-levelC");
  const btnA = $("#start-levelA");
  if (btnE) btnE.addEventListener("click", () => startLevel("E"));
  if (btnC) btnC.addEventListener("click", () => startLevel("C"));
  if (btnA) btnA.addEventListener("click", () => startLevel("A"));

  const btnCancel = $("#btnCancel");
  const btnFinish = $("#btnFinish");
  const btnBack = $("#btnBack");
  if (btnCancel) btnCancel.addEventListener("click", cancelPlay);
  if (btnFinish) btnFinish.addEventListener("click", finishLevel);
  if (btnBack) {
    btnBack.addEventListener("click", () => {
      const result = $("#result");
      const studentCard = $("#studentCard");
      if (result) result.classList.add("hidden");
      if (studentCard) studentCard.classList.remove("hidden");
      syncUI();
    });
  }

  // L√§rarl√§ge-knapp
  const teacherModeBtn = $("#btnTeacherMode");
  if (teacherModeBtn) teacherModeBtn.addEventListener("click", openTeacherGate);

  const gateCancel = $("#btnTeacherCancel");
  const gateConfirm = $("#btnTeacherConfirm");
  if (gateCancel) gateCancel.addEventListener("click", closeTeacherGate);
  if (gateConfirm) gateConfirm.addEventListener("click", handleTeacherConfirm);

  const btnCloseTeacher = $("#btnCloseTeacher");
  if (btnCloseTeacher) btnCloseTeacher.addEventListener("click", closeTeacherModal);

  // Flikar (huvudflikar)
  $all(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.getAttribute("data-tab");
      if (tab) {
        setActiveTeacherTab(tab);
      }
      if (tab === "questions" || tab === "images" || tab === "dragdrop") {
        refreshMcqGoalSelect();
      }
      if (tab === "images") {
        ensureImgOptionsInitial();
      }
      if (tab === "dragdrop") {
        ensureDragCategoriesInitial();
        ensureDragItemsInitial();
        updateDragItemCategoryOptions();
      }
      if (tab === "bank") {
        refreshBankExport();
        ensureCloudBankUi();
        if (currentTeacherUser) {
          loadCloudBanksList();
        }
      }
    });
  });

  // Inst√§llningar
  const btnSaveThresholds = $("#btnSaveThresholds");
  const btnClearStudent = $("#btnClearStudent");
  const btnResetGameBtn = $("#btnResetGame");
  const btnSaveTeacherEmail = $("#btnSaveTeacherEmail");
  const btnAddGoalPartEl = $("#btnAddGoalPart");
  const btnSaveGoalsMapEl = $("#btnSaveGoalsMap");
  const btnClearGoalsMapEl = $("#btnClearGoalsMap");
  const btnChangePw = $("#btnChangeTeacherPassword");

  if (btnSaveThresholds) btnSaveThresholds.addEventListener("click", saveThresholds);
  if (btnClearStudent) btnClearStudent.addEventListener("click", clearStudent);
  if (btnResetGameBtn) btnResetGameBtn.addEventListener("click", resetGame);
  if (btnSaveTeacherEmail) btnSaveTeacherEmail.addEventListener("click", saveTeacherEmailOnly);
  if (btnAddGoalPartEl) btnAddGoalPartEl.addEventListener("click", addGoalPart);
  if (btnSaveGoalsMapEl) btnSaveGoalsMapEl.addEventListener("click", saveGoalsMap);
  if (btnClearGoalsMapEl) btnClearGoalsMapEl.addEventListener("click", clearGoalsMap);
  if (btnChangePw) btnChangePw.addEventListener("click", changeTeacherPassword);

  // Fr√•gebank ‚Äì flervals
  const btnAddMcqEl = $("#btnAddMcq");
  const btnAddMcqJsonEl = $("#btnAddMcqFromJson");
  if (btnAddMcqEl) btnAddMcqEl.addEventListener("click", addMcq);
  if (btnAddMcqJsonEl) btnAddMcqJsonEl.addEventListener("click", addMcqFromJson);

  // Bildfr√•gor ‚Äì f√∂rhandsvisning + alternativ
  const imgFileInput = $("#imgQuestionFile");
  const imgPreview = $("#imgQuestionPreview");
  if (imgFileInput && imgPreview) {
    imgFileInput.addEventListener("change", () => {
      const file = imgFileInput.files && imgFileInput.files[0];
      if (!file) {
        imgPreview.innerHTML =
          '<span class="mini">Ingen bild vald √§nnu.</span>';
        currentImageDataUrl = null;
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        currentImageDataUrl = e.target.result;
        imgPreview.innerHTML =
          '<img src="' +
          currentImageDataUrl +
          '" alt="F√∂rhandsvisning" ' +
          'style="max-width:100%;max-height:180px;border-radius:8px;display:block;" />';
      };
      reader.readAsDataURL(file);
    });
  }

  ensureImgOptionsInitial();
  ensureDragCategoriesInitial();
  ensureDragItemsInitial();

  const btnImgAddOption = $("#btnImgAddOption");
  const btnAddImgQuestionEl = $("#btnAddImgQuestion");
  if (btnImgAddOption) {
    btnImgAddOption.addEventListener("click", () => {
      addImgOptionRow();
    });
  }
  if (btnAddImgQuestionEl) {
    btnAddImgQuestionEl.addEventListener("click", addImgQuestion);
  }

  // Drag & drop ‚Äì l√§gga till fr√•ga
  const btnAddDragCategoryEl = $("#btnAddDragCategory");
  const btnAddDragItemEl = $("#btnAddDragItem");
  const btnAddDragQuestionEl = $("#btnAddDragQuestion");
  if (btnAddDragCategoryEl) {
    btnAddDragCategoryEl.addEventListener("click", addDragCategoryRow);
  }
  if (btnAddDragItemEl) {
    btnAddDragItemEl.addEventListener("click", addDragItemRow);
  }
  if (btnAddDragQuestionEl) {
    btnAddDragQuestionEl.addEventListener("click", addDragQuestion);
  }

  // Fr√•gebank JSON
  const btnRefreshBankExportEl = $("#btnRefreshBankExport");
  const btnCopyBankJsonEl = $("#btnCopyBankJson");
  const btnImportBankJsonEl = $("#btnImportBankJson");
  if (btnRefreshBankExportEl)
    btnRefreshBankExportEl.addEventListener("click", refreshBankExport);
  if (btnCopyBankJsonEl) btnCopyBankJsonEl.addEventListener("click", copyBankJson);
  if (btnImportBankJsonEl)
    btnImportBankJsonEl.addEventListener("click", importBankJson);

  // Exportresultat
  const btnCopyExportJsonEl = $("#btnCopyExportJson");
  const btnEmailExportJsonEl = $("#btnEmailExportJson");
  if (btnCopyExportJsonEl)
    btnCopyExportJsonEl.addEventListener("click", copyExportJson);
  if (btnEmailExportJsonEl)
    btnEmailExportJsonEl.addEventListener("click", emailExportJson);

  // Google-inloggningsknapp
  const btnGooglePlaceholder = $("#btnGooglePlaceholder");
  if (btnGooglePlaceholder) {
    btnGooglePlaceholder.addEventListener("click", handleGoogleClick);
  }

  // F√∂rsta laddning
  renderGoalsList();
  renderMcqOverview();
  renderImgOverview();
  renderDragOverview();
  renderProgressDetails();
  ensureCloudBankUi();
  refreshMcqGoalSelect();
});
</script>
<!-- slut SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN -->










<!-- start SEKTION 4: AVSLUTANDE TAGGAR -->
</body>
</html>
<!-- slut SEKTION 4: AVSLUTANDE TAGGAR -->
