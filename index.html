<!-- start SEKTION 1: HEAD & STIL --> 
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>F√•ngvaktaren ‚Äì Progressionsspel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --accent-e:#b45309;
      --accent-c:#2563eb;
      --accent-a:#7c3aed;
      --accent-danger:#ef4444;
      --accent-info:#38bdf8;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --chip:#020617;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#0b1120 0,#020617 60%,#020617 100%);
      color:var(--text);
    }
    body{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:960px;
      background:rgba(15,23,42,0.96);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 18px 45px rgba(0,0,0,0.7);
      padding:18px 18px 22px;
      position:relative;
      overflow:hidden;
    }
    .app::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0 0,rgba(180,83,9,0.18),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(37,99,235,0.20),transparent 55%),
        radial-gradient(circle at 50% 100%,rgba(124,58,237,0.18),transparent 60%);
      opacity:0.9;
      pointer-events:none;
      z-index:-1;
    }

    .goal-tag{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:var(--card,#020617);
      color:var(--text,#e5e7eb);
      border:1px solid var(--border,#1f2937);
      font-size:0.75rem;
      margin:1px 3px 0 0;
      white-space:normal;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      background:var(--card,#020617);
      color:var(--text,#e5e7eb);
      border:1px solid var(--border,#1f2937);
      font-size:0.75rem;
      margin:2px 4px 0 0;
      cursor:pointer;
      white-space:nowrap;
    }

    .chip:hover{
      background:#111827;
    }

    .goal-tag.goal-tag-none{
      opacity:0.7;
      font-style:italic;
    }

    .app-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .title-block h1{
      margin:0;
      font-size:1.4rem;
      letter-spacing:0.04em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .title-block h1 span.logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:26px;
      height:26px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0,var(--accent-e),#92400e);
      box-shadow:0 0 18px rgba(180,83,9,0.6);
      font-size:1.1rem;
    }
    .subtitle{
      margin:4px 0 0;
      font-size:0.82rem;
      color:var(--muted);
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      color:var(--text);
      font-size:0.8rem;
      padding:6px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      line-height:1.3;
      white-space:nowrap;
    }
    .btn:hover{
      border-color:var(--accent-info);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .btn-primary{
      border-color:var(--accent-info);
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#0b1120;
      font-weight:600;
    }
    .btn-danger{
      border-color:var(--accent-danger);
      color:#fecaca;
    }
    .btn-sm{padding:4px 9px;font-size:0.75rem;}

    .student-card{
      margin-bottom:16px;
      padding:12px 12px 10px;
      border-radius:14px;
      background:radial-gradient(circle at 0 0,#111827,#020617);
      border:1px solid rgba(148,163,184,0.35);
    }
    .student-card .row{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:6px;
    }
    .student-card label{
      font-size:0.78rem;
      color:var(--muted);
      display:block;
      margin-bottom:2px;
    }
    .student-card .field{
      flex:1 1 auto;
      min-width:0;
    }
    .input{
      width:100%;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.82rem;
    }
    .input:focus{
      outline:none;
      border-color:var(--accent-info);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .student-status{
      font-size:0.78rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:2px;
      flex-wrap:wrap;
    }

    .levels-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      margin-bottom:16px;
      transition:opacity 0.15s ease;
    }
    @media (max-width:780px){
      .levels-grid{
        grid-template-columns:1fr;
      }
      .app-header{
        flex-direction:column;
        align-items:flex-start;
      }
    }
    .level-card{
      border-radius:14px;
      padding:11px 11px 10px;
      background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(15,23,42,0.96));
      border:1px solid rgba(31,41,55,0.9);
      position:relative;
      overflow:hidden;
      transform:translateY(0);
      transition:transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }
    .level-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      opacity:0.7;
      pointer-events:none;
      z-index:-1;
    }
    .level-card:hover{
      transform:translateY(-2px);
      box-shadow:0 0 18px rgba(15,23,42,0.9);
    }
    .level-card.level-e{
      border-color:rgba(180,83,9,0.8);
      background:radial-gradient(circle at 0 0,rgba(180,83,9,0.35),rgba(15,23,42,0.96));
      box-shadow:0 0 18px rgba(180,83,9,0.35);
    }
    .level-card.level-c{
      border-color:rgba(37,99,235,0.9);
      background:radial-gradient(circle at 0 0,rgba(37,99,235,0.40),rgba(15,23,42,0.96));
      box-shadow:0 0 18px rgba(37,99,235,0.45);
    }
    .level-card.level-a{
      border-color:rgba(124,58,237,0.9);
      background:radial-gradient(circle at 0 0,rgba(124,58,237,0.45),rgba(15,23,42,0.96));
      box-shadow:0 0 18px rgba(124,58,237,0.55);
    }
    .level-e::before{
      background:radial-gradient(circle at 0 0,rgba(180,83,9,0.45),transparent 60%);
    }
    .level-c::before{
      background:radial-gradient(circle at 0 0,rgba(37,99,235,0.50),transparent 60%);
    }
    .level-a::before{
      background:radial-gradient(circle at 0 0,rgba(124,58,237,0.55),transparent 60%);
    }
    .level-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:4px;
      margin-bottom:4px;
    }
    .level-title{
      font-size:0.9rem;
      font-weight:600;
      display:flex;
      flex-direction:column;
      gap:0;
    }
    .level-title small{
      font-size:0.72rem;
      color:var(--muted);
      font-weight:400;
    }
    .badge{
      font-size:0.7rem;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.9);
      white-space:nowrap;
    }
    .badge-ok{
      border-color:var(--accent-e);
      color:#fed7aa;
      background:rgba(180,83,9,0.35);
      box-shadow:0 0 10px rgba(180,83,9,0.5);
    }
    .badge-warn{
      border-color:var(--accent-c);
      color:#bfdbfe;
      background:rgba(37,99,235,0.25);
    }
    .badge-lock{
      border-color:var(--accent-danger);
      color:#fecaca;
      background:rgba(248,113,113,0.18);
    }
    .level-body{
      font-size:0.78rem;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:6px;
    }
    .level-body strong{color:var(--text);}
    .level-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .level-footer .hint{
      font-size:0.7rem;
      color:var(--muted);
    }
    .level-card.locked{
      opacity:0.55;
      box-shadow:none;
    }

    .play-panel{
      margin-top:6px;
      padding:10px 10px 10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.8);
      background:radial-gradient(circle at 0 0,#020617,#020617);
    }
    .play-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .play-header h2{
      margin:0;
      font-size:0.98rem;
    }
    .play-header small{
      font-size:0.74rem;
      color:var(--muted);
    }
    .questions{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:360px;
      overflow-y:auto;
      padding-right:4px;
      margin-bottom:6px;
    }
    .question{
      border-radius:10px;
      border:1px solid rgba(55,65,81,0.9);
      padding:8px 9px 7px;
      background:#020617;
      font-size:0.8rem;
    }
    .question > div:first-child{
      margin-bottom:4px;
    }
    .question img{
      max-width:100%;
      max-height:200px;
      border-radius:10px;
      display:block;
      margin-bottom:6px;
    }
    .options-list{
      display:flex;
      flex-direction:column;
      gap:3px;
      margin-top:2px;
    }
    .option-label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.78rem;
      cursor:pointer;
    }
    .option-label input{
      accent-color:#38bdf8;
    }
    .mini{
      font-size:0.72rem;
      color:var(--muted);
    }

    .play-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .play-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .result-panel{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.8);
      background:radial-gradient(circle at 100% 0,#020617,#020617);
      font-size:0.82rem;
    }
    .result-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
      margin-bottom:6px;
    }
    .score{
      font-size:1.3rem;
      font-weight:700;
    }
    .score span{
      font-size:0.8rem;
      color:var(--muted);
      font-weight:400;
      margin-left:4px;
    }
    .badge-pass{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:8px 18px;
      font-size:0.9rem;
      font-weight:700;
      border:none;
      background:linear-gradient(135deg,#22c55e,#0ea5e9);
      color:#022c22;
      gap:6px;
      box-shadow:0 0 20px rgba(34,197,94,0.6);
      text-transform:uppercase;
      letter-spacing:0.03em;
      animation:badgePop 0.7s ease-out;
    }
    .badge-pass::before{
      content:"‚úÖ";
      font-size:1rem;
    }
    .badge-fail{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:4px 9px;
      font-size:0.76rem;
      border:1px solid var(--accent-danger);
      color:#fecaca;
      background:rgba(248,113,113,0.12);
      gap:4px;
    }
    .result-meta{
      font-size:0.76rem;
      color:var(--muted);
      margin-top:2px;
    }
    .result-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .gate-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .gate-box{
      width:100%;
      max-width:340px;
      background:#020617;
      border-radius:16px;
      border:1px solid rgba(75,85,99,0.9);
      padding:14px 14px 12px;
      box-shadow:0 18px 45px rgba(0,0,0,0.85);
      font-size:0.82rem;
    }
    .gate-box h2{
      margin:0 0 6px;
      font-size:1rem;
    }
    .gate-box p{
      margin:0 0 8px;
      color:var(--muted);
      font-size:0.78rem;
    }
    .gate-actions{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:8px;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.92);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal{
      width:100%;
      max-width:880px;
      max-height:90vh;
      background:#020617;
      border-radius:18px;
      border:1px solid rgba(75,85,99,0.9);
      box-shadow:0 24px 60px rgba(0,0,0,0.9);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      font-size:0.82rem;
    }
    .modal-header{
      padding:10px 12px 8px;
      border-bottom:1px solid #1f2937;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .modal-header h2{
      margin:0;
      font-size:0.98rem;
    }
    .modal-header small{
      font-size:0.76rem;
      color:var(--muted);
      display:block;
    }
    .modal-body{
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }
    .tab-nav{
      display:flex;
      gap:6px;
      padding:6px 8px;
      border-bottom:1px solid #1f2937;
      background:#020617;
      flex-wrap:wrap;
    }
    .tab-btn{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:#020617;
      color:var(--muted);
      padding:5px 6px;
      font-size:0.78rem;
      cursor:pointer;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tab-btn.active{
      color:#e5e7eb;
      border-color:#38bdf8;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,0.25),#020617);
    }
    .tab-content{
      flex:1;
      min-height:0;
      padding:9px 10px 10px;
      overflow-y:auto;
    }

    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
    }

    .card{
      border-radius:12px;
      border:1px solid rgba(55,65,81,0.9);
      padding:8px 9px 8px;
      background:#020617;
    }
    .card h3{
      margin:0 0 4px;
      font-size:0.86rem;
    }
    .card p{
      margin:0 0 6px;
      font-size:0.76rem;
      color:var(--muted);
    }
    .card-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
    }
    .card-row .field{
      flex:1 1 auto;
      min-width:0;
    }

    .small-label{
      font-size:0.74rem;
      color:var(--muted);
      display:block;
      margin-bottom:2px;
    }
    .input-number{
      width:100%;
      padding:5px 7px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.8rem;
    }

    .list{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:5px;
    }
    .list-item{
      border-radius:9px;
      border:1px solid #1f2937;
      background:#020617;
      padding:6px 7px 5px;
      display:flex;
      justify-content:space-between;
      gap:6px;
      font-size:0.78rem;
    }
    .list-main{
      flex:1;
      min-width:0;
    }
    .list-main .q-text{
      font-weight:600;
      margin-bottom:2px;
    }
    .list-main .q-meta{
      font-size:0.72rem;
      color:var(--muted);
    }
    .level-tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0 6px;
      border-radius:999px;
      font-size:0.7rem;
      margin-left:4px;
      border:1px solid rgba(148,163,184,0.6);
    }
    .level-tag.level-e{
      border-color:var(--accent-e);
      color:#fed7aa;
      background:rgba(180,83,9,0.18);
    }
    .level-tag.level-c{
      border-color:var(--accent-c);
      color:#bfdbfe;
      background:rgba(37,99,235,0.14);
    }
    .level-tag.level-a{
      border-color:var(--accent-a);
      color:#ddd6fe;
      background:rgba(124,58,237,0.18);
    }

    select{
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:0.78rem;
      padding:4px 7px;
    }

    .hidden{
      display:none;
    }

    .sub-tab-nav{
      display:flex;
      gap:6px;
      margin-bottom:6px;
    }
    .sub-tab-btn{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:#020617;
      color:var(--muted);
      padding:4px 6px;
      font-size:0.78rem;
      cursor:pointer;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub-tab-btn.active{
      color:#e5e7eb;
      border-color:#38bdf8;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,0.25),#020617);
    }
    .sub-tab-panel.hidden{
      display:none;
    }

    .textarea{
      width:100%;
      min-height:120px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.95);
      color:var(--text);
      font-size:0.8rem;
      padding:6px 8px;
      resize:vertical;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .img-preview-box{
      border-radius:10px;
      border:1px dashed #1f2937;
      padding:6px 8px;
      min-height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Enkel layout f√∂r drag & drop-fr√•gor */
    .drag-wrapper{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:6px;
    }
    .drag-source{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      padding:6px;
      border-radius:8px;
      border:1px dashed #1f2937;
      min-height:38px;
    }
    .drag-columns{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .drag-column{
      flex:1 1 120px;
    }
    .drag-column-title{
      font-size:0.75rem;
      color:var(--muted);
      margin-bottom:2px;
    }
    .drag-dropzone{
      min-height:40px;
      border-radius:8px;
      border:1px dashed #1f2937;
      padding:6px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .drag-chip{
      cursor:grab;
      margin:2px;
    }

    @keyframes badgePop{
      0%{
        transform:scale(0.7);
        opacity:0;
        box-shadow:0 0 0 0 rgba(34,197,94,0.9);
      }
      60%{
        transform:scale(1.08);
        opacity:1;
        box-shadow:0 0 0 10px rgba(34,197,94,0);
      }
      100%{
        transform:scale(1);
        opacity:1;
        box-shadow:0 0 20px rgba(34,197,94,0.4);
      }
    }
  </style>
</head>
<!-- slut SEKTION 1: HEAD & STIL -->



<!-- start SEKTION 2: FIREBASE-BIBLIOTEK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<!-- slut SEKTION 2: FIREBASE-BIBLIOTEK -->


<!-- start SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <h1><span class="logo">F</span>F√•ngvaktaren</h1>
        <p class="subtitle">Spelbaserad tr√§ning i tre niv√•er (E, C, A).</p>
      </div>
      <button id="btnTeacherMode" class="btn btn-sm btn-primary">üîë L√§rarl√§ge</button>
    </header>

    <section id="studentCard" class="student-card">
      <div class="row">
        <div class="field">
          <label for="studentName">Namn</label>
          <input id="studentName" class="input" placeholder="Elevens namn..." autocomplete="off" />
        </div>
        <div class="field">
          <label for="studentClass">Klass</label>
          <input id="studentClass" class="input" placeholder="Klass..." autocomplete="off" />
        </div>
        <div class="field" style="flex:0 0 140px;min-width:140px;">
          <label>&nbsp;</label>
          <button id="btnSaveStudent" class="btn btn-sm btn-primary" style="width:100%;">üíæ Spara elev</button>
        </div>
      </div>
      <div class="student-status">
        <span id="studentSaved">Ej sparad elev</span>
      </div>
    </section>

    <section class="levels-grid">
      <article id="card-levelE" class="level-card level-e locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 1</span>
            <small>Grundniv√• ‚Äì E</small>
          </div>
          <span id="badge-levelE" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelE">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelE">70</span>%</span>
          <span class="mini">L√•ses upp n√§r eleven sparat namn & klass.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• E-niv√•.</div>
          <button id="start-levelE" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 1</button>
        </div>
      </article>

      <article id="card-levelC" class="level-card level-c locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 2</span>
            <small>Mellanniv√• ‚Äì C</small>
          </div>
          <span id="badge-levelC" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelC">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelC">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 1 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• C-niv√•.</div>
          <button id="start-levelC" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 2</button>
        </div>
      </article>

      <article id="card-levelA" class="level-card level-a locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 3</span>
            <small>Avancerad ‚Äì A</small>
          </div>
          <span id="badge-levelA" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelA">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelA">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 2 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• A-niv√•.</div>
          <button id="start-levelA" class="btn btn-sm" disabled>‚ñ∂Ô∏è Starta niv√• 3</button>
        </div>
      </article>
    </section>

    <section id="play" class="play-panel hidden">
      <header class="play-header">
        <div>
          <h2 id="play-title">Aktiv niv√•</h2>
          <small id="whoPlays">Ingen elev vald.</small>
        </div>
        <button id="btnCancel" class="btn btn-sm">‚¨ÖÔ∏è Avsluta utan att l√§mna in</button>
      </header>
      <div id="questions" class="questions">
        <div class="question mini">V√§lj en niv√• f√∂r att b√∂rja.</div>
      </div>
      <footer class="play-footer">
        <div class="mini">Svar registreras n√§r du klickar i alternativen eller sl√§pper kort i r√§tt ruta.</div>
        <div class="play-actions">
          <button id="btnFinish" class="btn btn-sm btn-primary">‚úÖ L√§mna in niv√•</button>
        </div>
      </footer>
    </section>

    <section id="result" class="result-panel hidden">
      <header class="result-header">
        <div>
          <div class="score" id="scoreText">0%<span> resultat</span></div>
          <div id="scoreDetail" class="result-meta">0/0 po√§ng</div>
          <div class="result-meta">
            Elev: <span id="resName">-</span> (<span id="resClass">-</span>)
          </div>
        </div>
        <div>
          <div id="passBadge" class="badge-fail">Resultat</div>
          <div id="unlockText" class="result-meta"></div>
        </div>
      </header>

      <div class="result-actions" id="resultActionsNormal">
        <button id="btnBack" class="btn btn-sm">‚¨ÖÔ∏è Tillbaka till niv√•er</button>
        <button id="btnSubmitGame" class="btn btn-sm btn-primary">‚úâÔ∏è L√§mna in spel f√∂r po√§ng</button>
      </div>
    </section>
  </div>

  <script id="embedded-data" type="application/json">
  {
    "bank": {
      "mcq": [
        {
          "level": "E",
          "type": "mcq",
          "q": "Vad √§r viktigast f√∂rst n√§r du kommer till k√∂ket?",
          "options": ["Ta p√• f√∂rkl√§de", "Tv√§tta h√§nderna", "S√§tta p√• ugnen", "Smaka p√• maten"],
          "answer": 1
        },
        {
          "level": "C",
          "type": "mcq",
          "q": "En g√§st klagar p√• kall mat. Vad √§r ett bra f√∂rsta steg?",
          "options": ["Ignorera g√§sten", "Skylla p√• k√∂ket", "Be om urs√§kt och erbjuda l√∂sning", "S√§ga att det inte √§r ditt fel"],
          "answer": 2
        },
        {
          "level": "A",
          "type": "mcq",
          "q": "Du planerar en buff√©. Vad √§r viktigast f√∂r s√§ker livsmedelshantering?",
          "options": ["Att det ser fint ut", "Att alla r√§tter √§r varma samtidigt", "R√§tt temperaturer och tidsgr√§nser", "Att det finns m√•nga olika r√§tter"],
          "answer": 2
        }
      ]
    }
  }
  </script>

  <div id="teacherGate" class="gate-backdrop hidden">
    <div class="gate-box">
      <h2>üîë L√§rarl√§ge</h2>
      <p id="teacherGateText">
        Ange l√§rarl√∂senord. F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.
      </p>
      <input id="teacherPasswordInput" class="input" type="password" placeholder="L√∂senord..." />
      <div class="gate-actions">
        <button id="btnTeacherCancel" class="btn btn-sm">Avbryt</button>
        <button id="btnTeacherConfirm" class="btn btn-sm btn-primary">Forts√§tt</button>
      </div>
    </div>
  </div>

  <div id="teacherModal" class="modal-backdrop hidden">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h2>L√§rarl√§ge ‚Äì F√•ngvaktaren</h2>
          <small>Hantera inst√§llningar, fr√•gebank, bildfr√•gor, drag & drop, export och elevprogression.</small>
        </div>
        <button id="btnCloseTeacher" class="btn btn-sm">St√§ng</button>
      </header>
      <div class="modal-body">
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="settings" id="tab-settings">‚öôÔ∏è Inst√§llningar</button>
          <button class="tab-btn" data-tab="questions" id="tab-questions">üÖ∞Ô∏è Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="images" id="tab-images">üñºÔ∏è Bildfr√•gor</button>
          <button class="tab-btn" data-tab="dragdrop" id="tab-dragdrop">üéØ Drag & Drop</button>
          <button class="tab-btn" data-tab="progress" id="tab-progress">üìà Elevprogression</button>
          <button class="tab-btn" data-tab="bank" id="tab-bank">üóÇÔ∏è Fr√•gebank</button>
        </nav>
        <div class="tab-content">
          <section class="tab-panel" data-panel="settings">
            <div class="settings-grid">
              <div class="card">
                <h3>L√§rarl√∂senord</h3>
                <p>Det l√∂senord du anv√§nder f√∂r att √∂ppna l√§rarl√§get. H√§r kan du byta det.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputOldPassword">Nuvarande l√∂senord</label>
                    <input id="inputOldPassword" class="input" type="password" placeholder="L√§mna tomt om inget satt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPassword">Nytt l√∂senord</label>
                    <input id="inputNewPassword" class="input" type="password" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPasswordRepeat">Upprepa nytt l√∂senord</label>
                    <input id="inputNewPasswordRepeat" class="input" type="password" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnChangeTeacherPassword" class="btn btn-sm">üîê Spara nytt l√∂senord</button>
                </div>
                <p id="passwordStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Google-inloggning & uppladdning (l√§rare)</h3>
                <p>
                  Logga in med ditt Google-konto f√∂r att spara och ladda fr√•gebanker via Firebase.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label">Status</label>
                    <p id="googleStatus" class="mini">‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.</p>
                  </div>
                  <div class="field">
                    <button id="btnGooglePlaceholder" class="btn btn-sm" type="button">
                      üîó Logga in med Google
                    </button>
                  </div>
                  <div class="field">
                    <button id="btnGoogleLogout" class="btn btn-sm hidden" type="button">
                      üö™ Logga ut fr√•n Google
                    </button>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Gr√§ns f√∂r godk√§nt per niv√•</h3>
                <p>Justera procentgr√§ns f√∂r E, C och A. Anv√§nds som riktm√§rke f√∂r ‚ÄùGodk√§nd niv√•‚Äù.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputThresE">Niv√• 1 (E)</label>
                    <input id="inputThresE" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresC">Niv√• 2 (C)</label>
                    <input id="inputThresC" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresA">Niv√• 3 (A)</label>
                    <input id="inputThresA" type="number" min="0" max="100" class="input-number" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveThresholds" class="btn btn-sm btn-primary">üíæ Spara niv√•-gr√§nser</button>
                </div>
              </div>

              <div class="card">
                <h3>L√§rarens e-post</h3>
                <p>
                  Anv√§nds som mottagare n√§r eleven l√§mnar in resultat via e-post
                  (‚ÄùSkapa e-post‚Äù p√• Elevresultat/JSON).
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputTeacherEmail">E-postadress</label>
                    <input id="inputTeacherEmail" class="input" placeholder="namn@skola.se" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveTeacherEmail" class="btn btn-sm">üíæ Spara e-postadress</button>
                </div>
                <p id="teacherEmailStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Koppling: delm√•l & delbitar</h3>
                <p>
                  Skriv ett delm√•l och en delbit i taget. Klicka p√• ‚ÄùL√§gg till delbit‚Äù
                  f√∂r att l√§gga till i listan. ‚ÄùSpara‚Äù skriver listan till spelets minne
                  (localStorage). ‚ÄùTa bort alla‚Äù rensar listan.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputGoalSingle">Delm√•l</label>
                    <input id="inputGoalSingle" class="input" placeholder="t.ex. Delm√•l 5 ‚Äì Hygien i k√∂ket" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputPartSingle">Delbit</label>
                    <input id="inputPartSingle" class="input" placeholder="t.ex. 51‚Äì60 eller 51,52,53" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnAddGoalPart" class="btn btn-sm">‚ûï L√§gg till delbit</button>
                  <button id="btnSaveGoalsMap" class="btn btn-sm btn-primary">üíæ Spara</button>
                  <button id="btnClearGoalsMap" class="btn btn-sm btn-danger">üóëÔ∏è Ta bort alla</button>
                </div>
                <p id="goalsStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card card-full-width">
                <h3>Aktuella delm√•l och delbitar</h3>
                <p class="mini">Nedan visas de delm√•l och delbitar som √§r sparade i spelet just nu.</p>
                <ul id="goalsList" class="goals-list">
                </ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="questions">
            <div class="questions-editor">
              <h3>Hantera flervalsfr√•gor (MCQ)</h3>
              <p class="mini">L√§gg till nya flervalsfr√•gor, redigera eller ta bort befintliga. Varje fr√•ga m√•ste ha ett svar (index 0-3).</p>
              <div class="card" style="margin-top: 15px;">
                <h4>L√§gg till/Redigera fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex: 0 0 100px;">
                    <label class="small-label" for="mcqLevel">Niv√•</label>
                    <select id="mcqLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqQuestion">Fr√•getext</label>
                    <input id="mcqQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>
                <div class="card-row" style="margin-top: 10px;">
                  <div class="field">
                    <label class="small-label" for="mcqOption0">Alternativ 1 (Index 0)</label>
                    <input id="mcqOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqOption1">Alternativ 2 (Index 1)</label>
                    <input id="mcqOption1" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top: 10px;">
                  <div class="field">
                    <label class="small-label" for="mcqOption2">Alternativ 3 (Index 2)</label>
                    <input id="mcqOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqOption3">Alternativ 4 (Index 3)</label>
                    <input id="mcqOption3" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top: 10px;">
                  <div class="field" style="flex: 0 0 100px;">
                    <label class="small-label" for="mcqAnswer">Korrekt Svar (Index)</label>
                    <input id="mcqAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqGoalPart">Kopplad Delbit (valfritt)</label>
                    <select id="mcqGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>
                <div class="card-row" style="margin-top: 15px; justify-content: space-between;">
                  <div>
                    <button id="btnMcqAdd" class="btn btn-sm btn-primary">‚ûï L√§gg till fr√•ga</button>
                    <button id="btnMcqUpdate" class="btn btn-sm hidden">üíæ Spara √§ndring</button>
                  </div>
                  <button id="btnMcqClear" class="btn btn-sm btn-secondary">Avbryt/Rensa formul√§r</button>
                </div>
              </div>
              <div class="card card-full-width" style="margin-top: 15px;">
                <h3>Aktuella flervalsfr√•gor (<span id="mcqCount">0</span> st)</h3>
                <ul id="mcqList" class="question-list">
                </ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="images">
            <div class="questions-editor">
              <h3>Hantera bildfr√•gor (IMG)</h3>
              <p class="mini">L√§gg till fr√•gor d√§r en bild visas tillsammans med flervalsalternativ.</p>
              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera bildfr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgLevel">Niv√•</label>
                    <select id="imgLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgQuestion">Fr√•getext</label>
                    <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgFile">Bildfil</label>
                    <input id="imgFile" type="file" accept="image/*" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">F√∂rhandsvisning</label>
                    <div id="imgPreview" class="img-preview-box mini">Ingen bild vald √§nnu.</div>
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgOption0">Alternativ 1 (Index 0)</label>
                    <input id="imgOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgOption1">Alternativ 2 (Index 1)</label>
                    <input id="imgOption1" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgOption2">Alternativ 3 (Index 2)</label>
                    <input id="imgOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgOption3">Alternativ 4 (Index 3)</label>
                    <input id="imgOption3" class="input" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgAnswer">Korrekt Svar (Index)</label>
                    <input id="imgAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgGoalPart">Kopplad Delbit (valfritt)</label>
                    <select id="imgGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>
                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnImgAdd" class="btn btn-sm btn-primary">‚ûï L√§gg till bildfr√•ga</button>
                  </div>
                  <button id="btnImgClear" class="btn btn-sm btn-secondary">Avbryt/Rensa formul√§r</button>
                </div>
              </div>
              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
                <ul id="imgList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="dragdrop">
            <div class="questions-editor">
              <h3>Hantera Drag &amp; Drop-fr√•gor</h3>
              <p class="mini">Skapa fr√•gor d√§r eleverna drar ord eller begrepp till r√§tt kategori.</p>
              <div class="card" style="margin-top:15px;">
                <h4>Bygg fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="dragLevel">Niv√•</label>
                    <select id="dragLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragQuestion">Instruktion / fr√•getext</label>
                    <input id="dragQuestion" class="input" placeholder="Ex: Dra r√§tt livsmedel till 'Kylvara'." />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="dragColumn1">Kolumn 1</label>
                    <input id="dragColumn1" class="input" placeholder="t.ex. R√§tt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragColumn2">Kolumn 2</label>
                    <input id="dragColumn2" class="input" placeholder="t.ex. Fel" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="dragItemText">Objekt att dra</label>
                    <input id="dragItemText" class="input" placeholder="t.ex. 'R√• kyckling'" />
                  </div>
                  <div class="field" style="flex:0 0 150px;">
                    <label class="small-label" for="dragItemCorrect">Korrekt kolumn</label>
                    <select id="dragItemCorrect" class="input">
                      <option value="0">Kolumn 1</option>
                      <option value="1">Kolumn 2</option>
                    </select>
                  </div>
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label">&nbsp;</label>
                    <button id="btnDragAddItem" class="btn btn-sm btn-primary" style="width:100%;">‚ûï L√§gg till objekt</button>
                  </div>
                </div>
                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">Objekt i denna fr√•ga</label>
                    <ul id="dragItemsPreview" class="question-list"></ul>
                  </div>
                </div>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="dragGoalPart">Kopplad Delbit (valfritt)</label>
                    <select id="dragGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>
                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnDragAddQuestion" class="btn btn-sm btn-primary">üíæ Spara fr√•ga</button>
                  </div>
                  <button id="btnDragClearForm" class="btn btn-sm btn-secondary">Rensa formul√§r</button>
                </div>
              </div>
              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella Drag &amp; Drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
                <ul id="dragList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="progress">
            <div class="card">
              <h3>Elevprogression</h3>
              <p class="mini">
                H√§r kan du anv√§nda resultaten fr√•n ‚ÄùL√§mna in spel f√∂r po√§ng‚Äù tillsammans med elevkortet
                f√∂r att f√∂lja elevernas niv√•er √∂ver tid. Automatisk ber√§kning av progression √§r inte aktiverad
                i denna version.
              </p>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="bank">
            <div class="settings-grid">
              <div class="card">
                <h3>Ladda fr√•gebank fr√•n molnet (Firebase)</h3>
                <p class="mini">
                  Visar bankar som har sparats p√• ditt Google-konto. Aktivera bankarna nedan f√∂r att l√§gga till fr√•gorna i spelet.
                </p>
                <ul id="cloudBankList" class="goals-list" style="margin-top: 10px;">
                </ul>
                <div style="margin-top: 10px;">
                  <button id="btnLoadCloudBanks" class="btn btn-sm">‚òÅÔ∏è Ladda moln-bankar</button>
                </div>
              </div>
              
              <div class="card">
                <h3>Spara aktuell fr√•gebank till molnet</h3>
                <p class="mini">
                  Namnge din fr√•gebank. Sparar *alla* fr√•gor du skapat i flervals-, bild- och drag/drop-flikarna.
                </p>
                <div class="card-row" style="margin-top: 10px;">
                  <div class="field">
                    <label class="small-label" for="inputBankName">Namn p√• fr√•gebank</label>
                    <input id="inputBankName" class="input" placeholder="T.ex. Min Skolans Bank HT25" />
                  </div>
                </div>
                <div style="margin-top: 10px;">
                  <button id="btnSaveToCloud" class="btn btn-sm btn-primary">üíæ Spara bank till molnet</button>
                </div>
              </div>

              <div class="card card-full-width">
                <h3>Export / Import av fr√•gebank (JSON)</h3>
                <p class="mini">
                  Exportera hela din nuvarande fr√•gebank som en JSON-fil (s√§kerhetskopia) eller importera en befintlig bank fr√•n fil.
                </p>
                <div class="card-row" style="margin-top: 10px;">
                  <button id="btnExportBank" class="btn btn-sm">‚¨áÔ∏è Exportera till JSON</button>
                  <label class="btn btn-sm" for="fileImport">‚¨ÜÔ∏è Importera fr√•n JSON</label>
                  <input type="file" id="fileImport" accept=".json" style="display:none;" />
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
<!-- slut SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->



<!-- start SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker & editorer) -->
<script>
"use strict";

/* =========================
   3a ‚Äì Konstanter & grundstate
   ========================= */

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
  authDomain: "fangvaktaren-904db.firebaseapp.com",
  projectId: "fangvaktaren-904db",
  storageBucket: "fangvaktaren-904db.firebasestorage.app",
  messagingSenderId: "105301219768",
  appId: "1:105301219768:web:66b131fba86a541b78174d",
  measurementId: "G-NXL9GSFZ77"
};

const STORAGE_KEY = "fangvaktaren-v17";

// üîÅ anv√§nder teachers/{uid}/banks
const CLOUD_ROOT_COLLECTION = "teachers";
const CLOUD_BANKS_SUBCOLLECTION = "banks";

const $ = (sel) => document.querySelector(sel);
const $all = (sel) => document.querySelectorAll(sel);

let firebaseAppInstance = null;
let firebaseAuthInstance = null;
let firebaseDbInstance = null;
let currentTeacherUser = null;

let currentLevel = null;
let currentQuestions = [];
let currentAnswers = [];
let lastSubmission = null;

// editor-state
let currentMcqLinks = [];
let currentImgLinks = [];
let currentDragLinks = [];
let currentMcqCorrectIndex = 0;
let currentImgCorrectIndex = 0;
let currentImgDataUrl = null;

// drag & drop-editor ‚Äì tempor√§r state f√∂r nya fr√•gor
let currentDragSourcesTmp = [];
let currentDragTargetsTmp = [];
let currentDragCorrectMapTmp = {};

const defaultState = {
  student: { name: "", klass: "" },
  best: { E: 0, C: 0, A: 0 },
  unlocked: { E: false, C: false, A: false },
  thres: { E: 70, C: 70, A: 70 },
  teacherPassword: null,
  teacherEmail: "",
  goalsMap: [],
  bank: {
    mcq: [],
    img: [],
    drag: []
  },
  progression: {
    totalPoints: 0,
    wrongByGoalId: {},
    correctByGoalId: {}
  }
};

function deepCloneDefault() {
  return JSON.parse(JSON.stringify(defaultState));
}

function clampInt(val, min, max) {
  const n = parseInt(val, 10);
  if (isNaN(n)) return min;
  return Math.max(min, Math.min(max, n));
}

function shuffle(arr) {
  return arr.slice().sort(() => Math.random() - 0.5);
}

function escapeHtml(str) {
  if (!str && str !== 0) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

/* =========================
   3b ‚Äì State-hantering & embedded-data
   ========================= */

function mergeEmbeddedBank(state) {
  const el = document.getElementById("embedded-data");
  if (!el) return state;
  try {
    const raw = el.textContent || el.innerHTML || "{}";
    const data = JSON.parse(raw);
    if (data && data.bank) {
      state.bank = Object.assign({ mcq: [], img: [], drag: [] }, state.bank || {});
      state.bank.mcq = (state.bank.mcq || []).concat(data.bank.mcq || []);
      state.bank.img = (state.bank.img || []).concat(data.bank.img || []);
      state.bank.drag = (state.bank.drag || []).concat(data.bank.drag || []);
    }
  } catch (e) {
    console.warn("Kunde inte l√§sa embedded-data:", e);
  }
  return state;
}

function loadState() {
  let s = null;
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      s = JSON.parse(raw);
    }
  } catch (e) {
    console.warn("Kunde inte l√§sa state, √•terst√§ller:", e);
  }
  if (!s) {
    s = deepCloneDefault();
    s = mergeEmbeddedBank(s);
    saveState(s);
  }

  s.student = Object.assign({ name: "", klass: "" }, s.student || {});
  s.best = Object.assign({ E: 0, C: 0, A: 0 }, s.best || {});
  s.unlocked = Object.assign({ E: false, C: false, A: false }, s.unlocked || {});
  s.thres = Object.assign({ E: 70, C: 70, A: 70 }, s.thres || {});
  s.bank = Object.assign({ mcq: [], img: [], drag: [] }, s.bank || {});
  if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
  if (!Array.isArray(s.bank.img)) s.bank.img = [];
  if (!Array.isArray(s.bank.drag)) s.bank.drag = [];
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];
  if (!s.progression || typeof s.progression !== "object") {
    s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {} };
  } else {
    s.progression.totalPoints = s.progression.totalPoints || 0;
    s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
    s.progression.correctByGoalId = s.progression.correctByGoalId || {};
  }
  return s;
}

function saveState(state) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn("Kunde inte spara state:", e);
  }
}

/* =========================
   3c ‚Äì Firebase init & Google-inloggning
   ========================= */

function initFirebase() {
  const statusEl = $("#googleStatus");
  try {
    if (!window.firebase) {
      console.warn("Firebase-bibliotek kunde inte hittas.");
      if (statusEl) {
        statusEl.textContent = "‚ö†Ô∏è Tekniskt fel: Firebase-bibliotek kunde inte laddas.";
      }
      return;
    }
    if (!firebase.apps.length) {
      firebase.initializeApp(FIREBASE_CONFIG);
    }
    firebaseAppInstance = firebase.app();
    firebaseAuthInstance = firebase.auth();
    firebaseDbInstance = firebase.firestore();
    console.log("Firebase init OK");
    setupGoogleLogin();
  } catch (e) {
    console.error("Firebase init misslyckades:", e);
    if (statusEl) {
      statusEl.textContent = "‚ö†Ô∏è Tekniskt fel: kunde inte starta Firebase.";
    }
  }
}

function setupGoogleLogin() {
  const btnLogin = $("#btnGooglePlaceholder");
  const btnLogout = $("#btnGoogleLogout");
  const statusEl = $("#googleStatus");
  if (!btnLogin || !statusEl) return;

  if (!firebaseAuthInstance) {
    console.warn("Firebase Auth saknas vid setupGoogleLogin.");
    statusEl.textContent = "‚ö†Ô∏è Tekniskt fel: Firebase Auth saknas.";
    return;
  }

  firebaseAuthInstance.onAuthStateChanged((user) => {
    currentTeacherUser = user || null;
    if (!statusEl) return;
    if (user) {
      statusEl.textContent = `‚òÅÔ∏è Inloggad som ${user.email || "l√§rare"} ‚Äì moln-banker aktiverade.`;
      if (btnLogout) btnLogout.classList.remove("hidden");
    } else {
      statusEl.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.";
      if (btnLogout) btnLogout.classList.add("hidden");
    }
  });

  btnLogin.addEventListener("click", async () => {
    if (!firebaseAuthInstance) {
      alert("Tekniskt fel: Firebase Auth saknas.");
      return;
    }
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      await firebaseAuthInstance.signInWithPopup(provider);
    } catch (err) {
      console.error("Google-inloggning misslyckades:", err);
      statusEl.textContent = "‚ö†Ô∏è Kunde inte logga in med Google. F√∂rs√∂k igen.";
    }
  });

  if (btnLogout) {
    btnLogout.addEventListener("click", async () => {
      try {
        await firebaseAuthInstance.signOut();
      } catch (err) {
        console.error("Kunde inte logga ut:", err);
      }
    });
  }
}

/* =========================
   3d ‚Äì Moln-banker (Firestore)
   ========================= */

function getBankFromState() {
  const s = loadState();
  return Object.assign({ mcq: [], img: [], drag: [] }, s.bank || {});
}

// Normalisera bank-data fr√•n Firestore
function normalizeBankFromDoc(data) {
  if (!data || typeof data !== "object") {
    return { mcq: [], img: [], drag: [] };
  }

  // 1) Nytt format: data.bank.mcq/img/drag
  if (
    data.bank &&
    (Array.isArray(data.bank.mcq) || Array.isArray(data.bank.img) || Array.isArray(data.bank.drag))
  ) {
    return {
      mcq: data.bank.mcq || [],
      img: data.bank.img || [],
      drag: data.bank.drag || []
    };
  }

  // 2) Bank direkt i roten: data.mcq/img/drag
  if (
    Array.isArray(data.mcq) ||
    Array.isArray(data.img) ||
    Array.isArray(data.drag)
  ) {
    return {
      mcq: data.mcq || [],
      img: data.img || [],
      drag: data.drag || []
    };
  }

  // 3) Gamla format med "questions" ‚Äì behandla som mcq
  if (Array.isArray(data.questions)) {
    return {
      mcq: data.questions,
      img: [],
      drag: []
    };
  }

  return { mcq: [], img: [], drag: [] };
}

function setBankAndGoalsInState(bank, goalsMap) {
  const s = loadState();
  s.bank = Object.assign({ mcq: [], img: [], drag: [] }, bank || {});
  if (Array.isArray(goalsMap)) {
    s.goalsMap = goalsMap.slice();
  }
  saveState(s);
  console.log("[DEBUG] State efter setBankAndGoalsInState:", {
    mcq: s.bank.mcq.length,
    img: s.bank.img.length,
    drag: s.bank.drag.length,
    goalsMap: s.goalsMap.length
  });
}

function setBankInState(bank) {
  setBankAndGoalsInState(bank, null);
}

// L√§s banker fr√•n teachers/{uid}/banks
async function loadCloudBanksList() {
  const listEl = $("#cloudBankList");
  if (!listEl) return;
  listEl.innerHTML = "";

  if (!firebaseDbInstance || !currentTeacherUser) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Du m√•ste vara inloggad med Google f√∂r att se dina moln-banker.";
    listEl.appendChild(li);
    return;
  }

  try {
    const snap = await firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION)
      .doc(currentTeacherUser.uid)
      .collection(CLOUD_BANKS_SUBCOLLECTION)
      .orderBy("createdAt", "desc")
      .get();

    if (snap.empty) {
      const li = document.createElement("li");
      li.className = "mini";
      li.textContent = "Inga moln-banker hittades √§nnu.";
      listEl.appendChild(li);
      return;
    }

    snap.forEach((docSnap) => {
      const data = docSnap.data() || {};
      const normalizedBank = normalizeBankFromDoc(data);
      const goalsFromDoc = Array.isArray(data.goalsMap)
        ? data.goalsMap
        : (data.bank && Array.isArray(data.bank.goalsMap) ? data.bank.goalsMap : []);

      const li = document.createElement("li");
      li.className = "list-item";

      const main = document.createElement("div");
      main.className = "list-main";

      const title = document.createElement("div");
      title.className = "q-text";
      title.textContent = data.name || "Namnl√∂s bank";

      const meta = document.createElement("div");
      meta.className = "q-meta";
      const ts = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
      const countMcq = Array.isArray(normalizedBank.mcq) ? normalizedBank.mcq.length : 0;
      meta.textContent = (ts
        ? `Skapad: ${ts.toLocaleString("sv-SE")}`
        : "Skapad: ok√§nt datum") + ` ¬∑ MCQ: ${countMcq}`;

      main.appendChild(title);
      main.appendChild(meta);

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.flexDirection = "column";
      actions.style.gap = "4px";

      const btnActivate = document.createElement("button");
      btnActivate.className = "btn btn-sm";
      btnActivate.textContent = "Aktivera denna bank";
      btnActivate.addEventListener("click", () => {
        setBankAndGoalsInState(normalizedBank, goalsFromDoc);
        renderMcqList();
        renderImgList();
        renderDragList();
        renderGoalsList();
        syncUI();
        alert("Moln-bank aktiverad. Dina fr√•gor √§r nu laddade i spelet.");
      });
      actions.appendChild(btnActivate);

      const btnDelete = document.createElement("button");
      btnDelete.className = "btn btn-sm btn-danger";
      btnDelete.textContent = "üóëÔ∏è Ta bort";
      btnDelete.addEventListener("click", async () => {
        if (!confirm("Ta bort denna moln-bank permanent?")) return;
        try {
          await firebaseDbInstance
            .collection(CLOUD_ROOT_COLLECTION)
            .doc(currentTeacherUser.uid)
            .collection(CLOUD_BANKS_SUBCOLLECTION)
            .doc(docSnap.id)
            .delete();
          alert("Moln-bank borttagen.");
          loadCloudBanksList();
        } catch (err) {
          console.error("Kunde inte ta bort bank:", err);
          alert("Kunde inte ta bort bank. Se konsolen f√∂r detaljer.");
        }
      });
      actions.appendChild(btnDelete);

      li.appendChild(main);
      li.appendChild(actions);
      listEl.appendChild(li);
    });
  } catch (e) {
    console.error("Kunde inte ladda moln-banker:", e);
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Fel vid laddning av moln-banker. Se konsolen f√∂r detaljer.";
    listEl.appendChild(li);
  }
}

function setupCloudBankUI() {
  const btnLoad = $("#btnLoadCloudBanks");
  const btnSave = $("#btnSaveToCloud");
  const btnExport = $("#btnExportBank");
  const fileImport = $("#fileImport");

  if (btnLoad) {
    btnLoad.addEventListener("click", () => {
      loadCloudBanksList();
    });
  }

  if (btnSave) {
    btnSave.addEventListener("click", async () => {
      if (!firebaseDbInstance || !currentTeacherUser) {
        alert("Du m√•ste vara inloggad med Google f√∂r att spara till molnet.");
        return;
      }
      const nameInput = $("#inputBankName");
      const name = (nameInput && nameInput.value.trim()) || "Min fr√•gebank";
      const bank = getBankFromState();
      const sFull = loadState();

      try {
        await firebaseDbInstance
          .collection(CLOUD_ROOT_COLLECTION)
          .doc(currentTeacherUser.uid)
          .collection(CLOUD_BANKS_SUBCOLLECTION)
          .add({
            ownerUid: currentTeacherUser.uid,
            ownerEmail: currentTeacherUser.email || null,
            name,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            bank,
            goalsMap: sFull.goalsMap || []
          });
        alert("Fr√•gebank sparad till molnet.");
        if (nameInput) nameInput.value = name;
      } catch (e) {
        console.error("Kunde inte spara bank till molnet:", e);
        alert("Det gick inte att spara bank till molnet. Se konsolen f√∂r detaljer.");
      }
    });
  }

  if (btnExport) {
    btnExport.addEventListener("click", () => {
      const bank = getBankFromState();
      const blob = new Blob([JSON.stringify(bank, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "fangvaktaren_bank.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  if (fileImport) {
    fileImport.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function () {
        try {
          const imported = JSON.parse(reader.result);
          setBankInState(imported);
          renderMcqList();
          renderImgList();
          renderDragList();
          syncUI();
          alert("Fr√•gebank importerad.");
        } catch (err) {
          console.error("Fel vid import av JSON-bank:", err);
          alert("Kunde inte l√§sa JSON-filen. Kontrollera formatet.");
        }
      };
      reader.readAsText(file, "utf-8");
    });
  }
}

/* =========================
   3e ‚Äì Delm√•l & delbitar (goalsMap)
   ========================= */

function populateGoalSelect(selectElId) {
  const sel = typeof selectElId === "string" ? $(selectElId) : $("#mcqGoalPart");
  if (!sel) return;
  const s = loadState();
  const goals = s.goalsMap || [];

  sel.innerHTML = "";
  const def = document.createElement("option");
  def.value = "";
  def.textContent = "Ingen koppling";
  sel.appendChild(def);

  goals.forEach((g) => {
    const opt = document.createElement("option");
    opt.value = String(g.id);
    opt.textContent = `${g.goal || "-"} (Delbitar: ${g.parts || "-"})`;
    sel.appendChild(opt);
  });
}

function renderGoalsList() {
  const host = $("#goalsList");
  if (!host) return;

  const s = loadState();
  const list = s.goalsMap || [];

  host.innerHTML = "";
  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga sparade delm√•l √§nnu.";
    host.appendChild(li);
    populateGoalSelect("#mcqGoalPart");
    populateGoalSelect("#imgGoalPart");
    populateGoalSelect("#dragGoalPart");
    populateGoalSelect("#mcqJsonGoalPart");
    return;
  }

  list.forEach((g) => {
    const li = document.createElement("li");
    li.className = "list-item";
    li.innerHTML = `
      <div class="list-main">
        <div class="q-text">${escapeHtml(g.goal || "-")}</div>
        <div class="q-meta">Delbitar: ${escapeHtml(g.parts || "-")}</div>
      </div>
      <div>
        <button class="btn btn-sm btn-danger" data-del-goal-id="${g.id}">üóëÔ∏è</button>
      </div>
    `;
    host.appendChild(li);
  });

  host.querySelectorAll("button[data-del-goal-id]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del-goal-id");
      const s2 = loadState();
      s2.goalsMap = (s2.goalsMap || []).filter((g) => String(g.id) !== id);
      saveState(s2);
      renderGoalsList();
    });
  });

  populateGoalSelect("#mcqGoalPart");
  populateGoalSelect("#imgGoalPart");
  populateGoalSelect("#dragGoalPart");
  populateGoalSelect("#mcqJsonGoalPart");
}

function initGoalsMap() {
  const inputGoal = $("#inputGoalSingle");
  const inputPart = $("#inputPartSingle");
  const btnAdd = $("#btnAddGoalPart");
  const btnSave = $("#btnSaveGoalsMap");
  const btnClear = $("#btnClearGoalsMap");
  const statusEl = $("#goalsStatus");

  if (btnAdd) {
    btnAdd.addEventListener("click", () => {
      const goalText = (inputGoal && inputGoal.value.trim()) || "";
      const partsText = (inputPart && inputPart.value.trim()) || "";
      if (!goalText || !partsText) {
        if (statusEl) statusEl.textContent = "Skriv b√•de delm√•l och delbit.";
        return;
      }
      const s = loadState();
      if (!Array.isArray(s.goalsMap)) s.goalsMap = [];
      s.goalsMap.push({
        id: Date.now(),
        goal: goalText,
        parts: partsText
      });
      saveState(s);
      if (inputGoal) inputGoal.value = "";
      if (inputPart) inputPart.value = "";
      if (statusEl) statusEl.textContent = "Delbit tillagd (gl√∂m inte att spara).";
      renderGoalsList();
    });
  }

  if (btnSave) {
    btnSave.addEventListener("click", () => {
      const s = loadState();
      saveState(s);
      if (statusEl) statusEl.textContent = "Delm√•l & delbitar sparade.";
    });
  }

  if (btnClear) {
    btnClear.addEventListener("click", () => {
      if (!confirm("Ta bort alla delm√•l och delbitar?")) return;
      const s = loadState();
      s.goalsMap = [];
      saveState(s);
      if (statusEl) statusEl.textContent = "Alla delm√•l borttagna.";
      renderGoalsList();
    });
  }

  renderGoalsList();
}

/* =========================
   3f ‚Äì Hj√§lp: delm√•ls-taggar & kopplingar
   ========================= */

function buildGoalInfoText(q) {
  const tags = [];

  if (Array.isArray(q.links) && q.links.length) {
    q.links.forEach((lnk) => {
      const goal = escapeHtml(lnk.goal || "-");
      const parts = escapeHtml(lnk.parts || "-");
      tags.push(`<span class="goal-tag">${goal} (Delbitar: ${parts})</span>`);
    });
  } else {
    // bak√•tkompatibelt mot gamla f√§lt
    if (q.goal || q.parts) {
      let txt = "Delm√•l: " + (q.goal || "-");
      if (q.parts) txt += " (Delbitar: " + q.parts + ")";
      tags.push(`<span class="goal-tag">${escapeHtml(txt)}</span>`);
    }
    if (q.goalExtra || q.partsExtra) {
      let txt2 = "Delm√•l: " + (q.goalExtra || "-");
      if (q.partsExtra) txt2 += " (Delbitar: " + q.partsExtra + ")";
      tags.push(`<span class="goal-tag">${escapeHtml(txt2)}</span>`);
    }
  }

  if (!tags.length) {
    return '<span class="goal-tag goal-tag-none">Ingen koppling till delm√•l</span>';
  }
  return tags.join(" ");
}

function getLinksFromIds(idArray) {
  const s = loadState();
  const goals = s.goalsMap || [];
  return idArray
    .map((id) => goals.find((g) => String(g.id) === String(id)))
    .filter(Boolean)
    .map((g) => ({ id: g.id, goal: g.goal, parts: g.parts }));
}

// H√§mta l√§nk-objekt (id, goal, parts) f√∂r en fr√•ga, √§ven om den bara har goal/parts-str√§ngar
function getLinksForQuestion(q, goals) {
  if (Array.isArray(q.links) && q.links.length) {
    return q.links
      .filter((lnk) => lnk && (lnk.id != null || lnk.goal || lnk.parts))
      .map((lnk) => ({
        id: lnk.id != null ? lnk.id : (goals.find((g) => g.goal === lnk.goal && g.parts === lnk.parts)?.id),
        goal: lnk.goal || (goals.find((g) => g.id === lnk.id)?.goal),
        parts: lnk.parts || (goals.find((g) => g.id === lnk.id)?.parts)
      }))
      .filter((lnk) => lnk.id != null);
  }

  const results = [];
  if (q.goal || q.parts) {
    const match = goals.find((g) =>
      (q.goal && g.goal === q.goal) ||
      (q.parts && g.parts === q.parts)
    );
    if (match) {
      results.push({ id: match.id, goal: match.goal, parts: match.parts });
    }
  }
  if (q.goalExtra || q.partsExtra) {
    const match2 = goals.find((g) =>
      (q.goalExtra && g.goal === q.goalExtra) ||
      (q.partsExtra && g.parts === q.partsExtra)
    );
    if (match2 && !results.some((r) => r.id === match2.id)) {
      results.push({ id: match2.id, goal: match2.goal, parts: match2.parts });
    }
  }
  return results;
}

/* =========================
   3g ‚Äì Flervalsfr√•gor (MCQ) ‚Äì lista & editor
   ========================= */

function renderMcqList() {
  const listEl = $("#mcqList");
  const countEl = $("#mcqCount");
  if (!listEl) return;

  const s = loadState();
  const list = (s.bank && s.bank.mcq) || [];

  listEl.innerHTML = "";
  if (countEl) countEl.textContent = String(list.length);

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga fr√•gor i banken √§nnu.";
    listEl.appendChild(li);
    return;
  }

  list.forEach((q, idx) => {
    const li = document.createElement("li");
    li.className = "list-item";

    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    else if (lvl === "A") tagClass = "level-a";

    const goalInfo = buildGoalInfoText(q);

    li.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          [${idx + 1}] ${escapeHtml(q.q || "")}
          <span class="level-tag ${tagClass}">${lvl}</span>
        </div>
        <div class="q-meta">${goalInfo}</div>
      </div>
      <div>
        <button class="btn btn-sm btn-danger" data-del-index="${idx}">üóëÔ∏è</button>
      </div>
    `;
    listEl.appendChild(li);
  });

  listEl.querySelectorAll("button[data-del-index]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const index = Number(btn.getAttribute("data-del-index"));
      const s2 = loadState();
      if (!Array.isArray(s2.bank.mcq) || index < 0 || index >= s2.bank.mcq.length) return;
      s2.bank.mcq.splice(index, 1);
      saveState(s2);
      renderMcqList();
      syncUI();
    });
  });
}

function initQuestionForms() {
  const mcqLevel = $("#mcqLevel");
  const mcqQuestion = $("#mcqQuestion");
  const mcqOpt0 = $("#mcqOption0");
  const mcqOpt1 = $("#mcqOption1");
  const mcqOpt2 = $("#mcqOption2");
  const mcqOpt3 = $("#mcqOption3");
  const mcqAnswerNumber = $("#mcqAnswer");
  const mcqGoalPart = $("#mcqGoalPart");
  const btnAdd = $("#btnMcqAdd");
  const btnClear = $("#btnMcqClear");

  if (!btnAdd || !mcqLevel || !mcqQuestion || !mcqOpt0 || !mcqOpt1) {
    return;
  }

  // d√∂lj gamla "index"-f√§ltet
  if (mcqAnswerNumber) {
    const label = document.querySelector('label[for="mcqAnswer"]');
    mcqAnswerNumber.style.display = "none";
    if (label) label.style.display = "none";
  }

  // radioknappar f√∂r korrekt svar
  currentMcqCorrectIndex = 0;
  if (mcqAnswerNumber && mcqAnswerNumber.parentElement) {
    const container = document.createElement("div");
    container.className = "mini";
    container.style.marginTop = "4px";
    container.textContent = "V√§lj vilket alternativ som √§r r√§tt:";

    const row = document.createElement("div");
    ["1", "2", "3", "4"].forEach((lbl, idx) => {
      const lab = document.createElement("label");
      lab.style.marginRight = "8px";
      lab.style.cursor = "pointer";
      const r = document.createElement("input");
      r.type = "radio";
      r.name = "mcqCorrectRadio";
      r.value = String(idx);
      if (idx === 0) {
        r.checked = true;
        currentMcqCorrectIndex = 0;
      }
      r.addEventListener("change", () => {
        currentMcqCorrectIndex = idx;
      });
      lab.appendChild(r);
      lab.appendChild(document.createTextNode(" " + lbl));
      row.appendChild(lab);
    });

    container.appendChild(row);
    mcqAnswerNumber.parentElement.appendChild(container);
  }

  // flera delm√•l ‚Äì koppling (manuellt skapade MCQ)
  currentMcqLinks = [];
  let mcqLinksPreview = null;
  if (mcqGoalPart && mcqGoalPart.parentElement) {
    const btnLink = document.createElement("button");
    btnLink.type = "button";
    btnLink.className = "btn btn-sm";
    btnLink.id = "btnMcqAddGoalLink";
    btnLink.textContent = "‚ûï L√§gg till delm√•ls-koppling";

    mcqLinksPreview = document.createElement("div");
    mcqLinksPreview.id = "mcqGoalLinksPreview";
    mcqLinksPreview.className = "mini";
    mcqLinksPreview.style.marginTop = "6px";
    mcqLinksPreview.textContent = "Inga kopplingar √§nnu.";

    mcqGoalPart.parentElement.appendChild(btnLink);
    mcqGoalPart.parentElement.appendChild(mcqLinksPreview);

    btnLink.addEventListener("click", () => {
      const val = mcqGoalPart.value;
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!currentMcqLinks.some((x) => String(x.id) === String(link.id))) {
        currentMcqLinks.push(link);
      }
      if (mcqLinksPreview) {
        mcqLinksPreview.innerHTML = currentMcqLinks
          .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
          .join(" ");
      }
    });
  }

  btnAdd.addEventListener("click", () => {
    const s = loadState();
    const level = mcqLevel.value || "E";
    const text = mcqQuestion.value.trim();
    const opts = [
      mcqOpt0.value.trim(),
      mcqOpt1.value.trim(),
      mcqOpt2 ? mcqOpt2.value.trim() : "",
      mcqOpt3 ? mcqOpt3.value.trim() : ""
    ].filter((o) => o.length > 0);

    if (!text || opts.length < 2) {
      alert("Skriv en fr√•ga och minst tv√• svarsalternativ.");
      return;
    }

    let answerIndex = currentMcqCorrectIndex || 0;
    if (answerIndex >= opts.length) answerIndex = 0;

    const links = currentMcqLinks.slice();

    const newQ = {
      type: "mcq",
      level,
      q: text,
      options: opts,
      answer: answerIndex,
      links: links
    };

    if (links.length) {
      newQ.goal = links[0].goal;
      newQ.parts = links[0].parts;
    }

    if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
    s.bank.mcq.push(newQ);
    saveState(s);

    mcqQuestion.value = "";
    mcqOpt0.value = "";
    mcqOpt1.value = "";
    if (mcqOpt2) mcqOpt2.value = "";
    if (mcqOpt3) mcqOpt3.value = "";
    if (mcqGoalPart) mcqGoalPart.value = "";
    currentMcqLinks = [];
    if (mcqLinksPreview) mcqLinksPreview.textContent = "Inga kopplingar √§nnu.";
    currentMcqCorrectIndex = 0;
    const firstRadio = document.querySelector('input[name="mcqCorrectRadio"][value="0"]');
    if (firstRadio) firstRadio.checked = true;

    renderMcqList();
    syncUI();
  });

  if (btnClear) {
    btnClear.addEventListener("click", () => {
      mcqQuestion.value = "";
      mcqOpt0.value = "";
      mcqOpt1.value = "";
      if (mcqOpt2) mcqOpt2.value = "";
      if (mcqOpt3) mcqOpt3.value = "";
      if (mcqGoalPart) mcqGoalPart.value = "";
      currentMcqLinks = [];
      const preview = $("#mcqGoalLinksPreview");
      if (preview) preview.textContent = "Inga kopplingar √§nnu.";
    });
  }

  // =========================
  // Snabbimport (text-format) med egen niv√• + delm√•l
  // =========================

  let mcqJsonLinks = [];

  const questionsPanel = document.querySelector('.tab-panel[data-panel="questions"]');
  if (questionsPanel && !document.getElementById("mcqJsonImportCard")) {
    const card = document.createElement("div");
    card.className = "card card-full-width";
    card.id = "mcqJsonImportCard";
    card.style.marginBottom = "15px";
    card.innerHTML = `
      <h3>Snabbimport av flervalsfr√•gor (text)</h3>
      <p class="mini">
        Format per fr√•ga:<br>
        F√∂rsta raden = fr√•ga, f√∂ljande rader = svarsalternativ.<br>
        Markera r√§tt svar med <code>*</code> i b√∂rjan av raden.<br>
        Separera fr√•gor med en tom rad.<br><br>
        Exempel:<br>
        Vad heter Sveriges huvudstad?<br>
        Olso<br>
        *Stockholm<br>
        Norge<br>
        Helsinki
      </p>
      <textarea id="mcqJsonTextarea" class="textarea" placeholder="Klistra in dina fr√•gor h√§r..."></textarea>
      <div class="card-row" style="margin-top:8px;gap:8px;flex-wrap:wrap;">
        <div class="field" style="max-width:140px;">
          <label class="small-label" for="mcqJsonLevel">Niv√• f√∂r import</label>
          <select id="mcqJsonLevel" class="input">
            <option value="E">E</option>
            <option value="C">C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div class="field">
          <label class="small-label" for="mcqJsonGoalPart">Kopplad delbit (valfritt ‚Äì g√§ller alla importerade fr√•gor)</label>
          <select id="mcqJsonGoalPart" class="input">
            <option value="">Ingen koppling</option>
          </select>
          <button id="btnMcqJsonAddGoalLink" class="btn btn-sm" type="button" style="margin-top:4px;">
            ‚ûï L√§gg till delm√•ls-koppling
          </button>
          <div id="mcqJsonGoalLinksPreview" class="mini" style="margin-top:4px;">Inga kopplingar √§nnu.</div>
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
        <button id="btnMcqImportJson" class="btn btn-sm">‚¨ÜÔ∏è Importera flervalsfr√•gor</button>
      </div>
      <p class="mini" id="mcqJsonStatus" style="margin-top:4px;"></p>
    `;

    const firstChild = questionsPanel.firstElementChild || questionsPanel.firstChild;
    if (firstChild) {
      questionsPanel.insertBefore(card, firstChild);
    } else {
      questionsPanel.appendChild(card);
    }

    const btnImport = $("#btnMcqImportJson");
    const txt = $("#mcqJsonTextarea");
    const status = $("#mcqJsonStatus");
    const jsonGoalPart = $("#mcqJsonGoalPart");
    const jsonLinksPreview = $("#mcqJsonGoalLinksPreview");
    const btnJsonAddLink = $("#btnMcqJsonAddGoalLink");
    const jsonLevelSelect = $("#mcqJsonLevel");

    // fyll drop-down f√∂r delm√•l
    populateGoalSelect("#mcqJsonGoalPart");

    if (btnJsonAddLink && jsonGoalPart && jsonLinksPreview) {
      btnJsonAddLink.addEventListener("click", () => {
        const val = jsonGoalPart.value;
        if (!val) return;
        const links = getLinksFromIds([val]);
        if (!links.length) return;
        const link = links[0];
        if (!mcqJsonLinks.some((x) => String(x.id) === String(link.id))) {
          mcqJsonLinks.push(link);
        }
        jsonLinksPreview.innerHTML = mcqJsonLinks
          .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
          .join(" ");
      });
    }

    if (btnImport && txt) {
      btnImport.addEventListener("click", () => {
        const raw = txt.value.trim();
        if (!raw) return;

        const blocks = raw
          .split(/\n\s*\n/)
          .map((b) => b.trim())
          .filter((b) => b.length);

        const s2 = loadState();
        if (!Array.isArray(s2.bank.mcq)) s2.bank.mcq = [];
        let added = 0;
        const levelForImport =
          (jsonLevelSelect && jsonLevelSelect.value) ||
          (mcqLevel && mcqLevel.value) ||
          "E";
        const linksForImport = mcqJsonLinks.slice();

        blocks.forEach((block) => {
          const lines = block
            .split("\n")
            .map((l) => l.trim())
            .filter((l) => l.length);

          if (lines.length < 3) return; // minst 1 fr√•ga + 2 svar

          const question = lines[0];
          const answerLines = lines.slice(1);
          const opts = [];
          let correctIdx = 0;

          answerLines.forEach((line, idx) => {
            let text = line;
            if (text.startsWith("*")) {
              text = text.replace(/^\*\s*/, "");
              correctIdx = idx;
            }
            opts.push(text);
          });

          if (!question || opts.length < 2) return;

          const qObj = {
            type: "mcq",
            level: levelForImport,
            q: question,
            options: opts,
            answer: correctIdx
          };

          if (linksForImport.length) {
            qObj.links = linksForImport;
            qObj.goal = linksForImport[0].goal;
            qObj.parts = linksForImport[0].parts;
          }

          s2.bank.mcq.push(qObj);
          added++;
        });

        saveState(s2);
        renderMcqList();
        syncUI();
        if (status) status.textContent = `Importerade ${added} fr√•gor.`;
      });
    }
  }

  renderMcqList();
  populateGoalSelect("#mcqGoalPart");
}

/* =========================
   3h ‚Äì Bildfr√•gor (IMG) ‚Äì lista & editor
   ========================= */

function renderImgList() {
  const host = $("#imgList");
  const countEl = $("#imgCount");
  if (!host) return;

  const s = loadState();
  const list = (s.bank && s.bank.img) || [];

  host.innerHTML = "";
  if (countEl) countEl.textContent = String(list.length);

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga bildfr√•gor i banken √§nnu.";
    host.appendChild(li);
    return;
  }

  list.forEach((q, idx) => {
    const li = document.createElement("li");
    li.className = "list-item";
    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    else if (lvl === "A") tagClass = "level-a";

    const goalInfo = buildGoalInfoText(q);
    const hasThumb = !!q.imgDataUrl;

    li.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          [${idx + 1}] ${escapeHtml(q.q || "")}
          <span class="level-tag ${tagClass}">${lvl}</span>
        </div>
        <div class="q-meta">${goalInfo}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
        ${hasThumb ? `<img src="${q.imgDataUrl}" alt="Miniatyr" style="max-width:80px;max-height:60px;border-radius:4px;object-fit:cover;">` : ""}
        <button class="btn btn-sm btn-danger" data-del-img-index="${idx}">üóëÔ∏è</button>
      </div>
    `;
    host.appendChild(li);
  });

  host.querySelectorAll("button[data-del-img-index]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.getAttribute("data-del-img-index"));
      const s2 = loadState();
      if (!Array.isArray(s2.bank.img) || idx < 0 || idx >= s2.bank.img.length) return;
      s2.bank.img.splice(idx, 1);
      saveState(s2);
      renderImgList();
      syncUI();
    });
  });
}

function initImageQuestionsEditor() {
  const panel = document.querySelector('.tab-panel[data-panel="images"]');
  if (!panel) return;

  panel.innerHTML = `
    <div class="card">
      <h3>Bildfr√•gor</h3>
      <p class="mini">
        Skapa fr√•gor med bild och 2‚Äì4 svarsalternativ. V√§lj r√§tt svar genom att klicka i en cirkel.
      </p>
      <div class="card-row">
        <div class="field" style="flex:0 0 100px;">
          <label class="small-label" for="imgLevel">Niv√•</label>
          <select id="imgLevel" class="input">
            <option value="E">E</option>
            <option value="C">C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div class="field">
          <label class="small-label" for="imgQuestion">Fr√•getext</label>
          <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
        </div>
      </div>
      <div class="card-row" style="margin-top:8px;">
        <div class="field">
          <label class="small-label" for="imgFileInput">Bildfil</label>
          <input type="file" id="imgFileInput" accept="image/*" />
        </div>
        <div class="field">
          <label class="small-label">F√∂rhandsgranskning</label>
          <div id="imgPreviewBox" class="img-preview-box">
            Ingen bild vald √§nnu.
          </div>
        </div>
      </div>
      <div class="card-row" style="margin-top:8px;">
        <div class="field">
          <label class="small-label" for="imgOption0">Alternativ 1</label>
          <input id="imgOption0" class="input" />
        </div>
        <div class="field">
          <label class="small-label" for="imgOption1">Alternativ 2</label>
          <input id="imgOption1" class="input" />
        </div>
      </div>
      <div class="card-row" style="margin-top:8px;">
        <div class="field">
          <label class="small-label" for="imgOption2">Alternativ 3 (valfritt)</label>
          <input id="imgOption2" class="input" />
        </div>
        <div class="field">
          <label class="small-label" for="imgOption3">Alternativ 4 (valfritt)</label>
          <input id="imgOption3" class="input" />
        </div>
      </div>
      <div class="card-row" style="margin-top:8px;">
        <div class="field" id="imgCorrectContainer">
          <label class="small-label">R√§tt svar</label>
        </div>
        <div class="field">
          <label class="small-label" for="imgGoalPart">Kopplad delbit (valfritt)</label>
          <select id="imgGoalPart" class="input">
            <option value="">Ingen koppling</option>
          </select>
          <button id="btnImgAddGoalLink" class="btn btn-sm" type="button" style="margin-top:4px;">
            ‚ûï L√§gg till delm√•ls-koppling
          </button>
          <div id="imgGoalLinksPreview" class="mini" style="margin-top:4px;">Inga kopplingar √§nnu.</div>
        </div>
      </div>
      <div class="card-row" style="margin-top:12px;justify-content:space-between;">
        <div>
          <button id="btnImgAdd" class="btn btn-sm btn-primary">‚ûï L√§gg till bildfr√•ga</button>
        </div>
        <button id="btnImgClear" class="btn btn-sm">Avbryt/Rensa formul√§r</button>
      </div>
    </div>

    <div class="card card-full-width" style="margin-top:15px;">
      <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
      <ul id="imgList" class="question-list"></ul>
    </div>
  `;

  const imgLevel = $("#imgLevel");
  const imgQuestion = $("#imgQuestion");
  const imgOpt0 = $("#imgOption0");
  const imgOpt1 = $("#imgOption1");
  const imgOpt2 = $("#imgOption2");
  const imgOpt3 = $("#imgOption3");
  const imgFileInput = $("#imgFileInput");
  const imgPreviewBox = $("#imgPreviewBox");
  const imgGoalPart = $("#imgGoalPart");
  const btnAdd = $("#btnImgAdd");
  const btnClear = $("#btnImgClear");
  const btnAddGoalLink = $("#btnImgAddGoalLink");
  const imgCorrectContainer = $("#imgCorrectContainer");
  const imgGoalLinksPreview = $("#imgGoalLinksPreview");

  currentImgDataUrl = null;
  currentImgLinks = [];
  currentImgCorrectIndex = 0;

  // radioknappar f√∂r r√§tt svar
  if (imgCorrectContainer) {
    const row = document.createElement("div");
    ["1", "2", "3", "4"].forEach((lbl, idx) => {
      const lab = document.createElement("label");
      lab.style.marginRight = "8px";
      lab.style.cursor = "pointer";
      const r = document.createElement("input");
      r.type = "radio";
      r.name = "imgCorrectRadio";
      r.value = String(idx);
      if (idx === 0) {
        r.checked = true;
        currentImgCorrectIndex = 0;
      }
      r.addEventListener("change", () => {
        currentImgCorrectIndex = idx;
      });
      lab.appendChild(r);
      lab.appendChild(document.createTextNode(" " + lbl));
      row.appendChild(lab);
    });
    imgCorrectContainer.appendChild(row);
  }

  // bildf√∂rhandsgranskning
  if (imgFileInput) {
    imgFileInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        currentImgDataUrl = null;
        if (imgPreviewBox) imgPreviewBox.textContent = "Ingen bild vald √§nnu.";
        return;
      }
      const reader = new FileReader();
      reader.onload = function () {
        currentImgDataUrl = reader.result;
        if (imgPreviewBox) {
          imgPreviewBox.innerHTML = `<img src="${currentImgDataUrl}" alt="F√∂rhandsgranskning" style="max-width:100%;max-height:160px;border-radius:8px;">`;
        }
      };
      reader.readAsDataURL(file);
    });
  }

  // flera delm√•l
  if (btnAddGoalLink && imgGoalLinksPreview) {
    btnAddGoalLink.addEventListener("click", () => {
      const val = imgGoalPart.value;
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!currentImgLinks.some((x) => String(x.id) === String(link.id))) {
        currentImgLinks.push(link);
      }
      imgGoalLinksPreview.innerHTML = currentImgLinks
        .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
        .join(" ");
    });
  }

  if (btnAdd) {
    btnAdd.addEventListener("click", () => {
      const s = loadState();
      const level = imgLevel.value || "E";
      const text = (imgQuestion && imgQuestion.value.trim()) || "";
      const opts = [
        imgOpt0 && imgOpt0.value.trim(),
        imgOpt1 && imgOpt1.value.trim(),
        imgOpt2 && imgOpt2.value.trim(),
        imgOpt3 && imgOpt3.value.trim()
      ].filter((x) => x && x.length > 0);

      if (!currentImgDataUrl) {
        alert("V√§lj en bild f√∂r bildfr√•gan.");
        return;
      }
      if (!text || opts.length < 2) {
        alert("Skriv en fr√•ga och minst tv√• svarsalternativ.");
        return;
      }

      let ans = currentImgCorrectIndex || 0;
      if (ans >= opts.length) ans = 0;

      const links = currentImgLinks.slice();
      const qObj = {
        type: "img",
        level,
        q: text,
        options: opts,
        answer: ans,
        imgDataUrl: currentImgDataUrl,
        links: links
      };
      if (links.length) {
        qObj.goal = links[0].goal;
        qObj.parts = links[0].parts;
      }

      if (!Array.isArray(s.bank.img)) s.bank.img = [];
      s.bank.img.push(qObj);
      saveState(s);

      // reset
      currentImgDataUrl = null;
      currentImgLinks = [];
      currentImgCorrectIndex = 0;
      if (imgQuestion) imgQuestion.value = "";
      if (imgOpt0) imgOpt0.value = "";
      if (imgOpt1) imgOpt1.value = "";
      if (imgOpt2) imgOpt2.value = "";
      if (imgOpt3) imgOpt3.value = "";
      if (imgFileInput) imgFileInput.value = "";
      if (imgPreviewBox) imgPreviewBox.textContent = "Ingen bild vald √§nnu.";
      if (imgGoalPart) imgGoalPart.value = "";
      if (imgGoalLinksPreview) imgGoalLinksPreview.textContent = "Inga kopplingar √§nnu.";
      const firstR = document.querySelector('input[name="imgCorrectRadio"][value="0"]');
      if (firstR) firstR.checked = true;

      renderImgList();
      syncUI();
    });
  }

  if (btnClear) {
    btnClear.addEventListener("click", () => {
      if (imgQuestion) imgQuestion.value = "";
      if (imgOpt0) imgOpt0.value = "";
      if (imgOpt1) imgOpt1.value = "";
      if (imgOpt2) imgOpt2.value = "";
      if (imgOpt3) imgOpt3.value = "";
      if (imgFileInput) imgFileInput.value = "";
      if (imgPreviewBox) imgPreviewBox.textContent = "Ingen bild vald √§nnu.";
      if (imgGoalPart) imgGoalPart.value = "";
      if (imgGoalLinksPreview) imgGoalLinksPreview.textContent = "Inga kopplingar √§nnu.";
      currentImgDataUrl = null;
      currentImgLinks = [];
      currentImgCorrectIndex = 0;
      const firstR = document.querySelector('input[name="imgCorrectRadio"][value="0"]');
      if (firstR) firstR.checked = true;
    });
  }

  populateGoalSelect("#imgGoalPart");
  renderImgList();
}

/* =========================
   3i ‚Äì Drag & Drop-fr√•gor ‚Äì lista & editor
   ========================= */

function renderDragList() {
  const host = $("#dragList");
  const countEl = $("#dragCount");
  if (!host) return;

  const s = loadState();
  const list = (s.bank && s.bank.drag) || [];

  host.innerHTML = "";
  if (countEl) countEl.textContent = String(list.length);

  if (!list.length) {
    const li = document.createElement("li");
    li.className = "mini";
    li.textContent = "Inga drag & drop-fr√•gor i banken √§nnu.";
    host.appendChild(li);
    return;
  }

  list.forEach((q, idx) => {
    const li = document.createElement("li");
    li.className = "list-item";
    const lvl = q.level || "E";
    let tagClass = "level-e";
    if (lvl === "C") tagClass = "level-c";
    else if (lvl === "A") tagClass = "level-a";

    const sources = Array.isArray(q.dragSources) ? q.dragSources : [];
    const targets = Array.isArray(q.dragTargets) ? q.dragTargets : [];
    const goalInfo = buildGoalInfoText(q);

    const srcLabels = sources.map((s) => s.label).join(", ");
    const tgtLabels = targets.map((t) => t.label).join(", ");

    li.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          [${idx + 1}] ${escapeHtml(q.q || "")}
          <span class="level-tag ${tagClass}">${lvl}</span>
        </div>
        <div class="q-meta">
          Korten: ${escapeHtml(srcLabels || "-")}<br>
          Kategorier: ${escapeHtml(tgtLabels || "-")}
        </div>
        <div class="q-meta">${goalInfo}</div>
      </div>
      <div>
        <button class="btn btn-sm btn-danger" data-del-drag-index="${idx}">üóëÔ∏è</button>
      </div>
    `;
    host.appendChild(li);
  });

  host.querySelectorAll("button[data-del-drag-index]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.getAttribute("data-del-drag-index"));
      const s2 = loadState();
      if (!Array.isArray(s2.bank.drag) || idx < 0 || idx >= s2.bank.drag.length) return;
      s2.bank.drag.splice(idx, 1);
      saveState(s2);
      renderDragList();
      syncUI();
    });
  });
}

function initDragDropQuestionsEditor() {
  const panel = document.querySelector('.tab-panel[data-panel="dragdrop"]');
  if (!panel) return;

  panel.innerHTML = `
    <div class="card">
      <h3>Drag &amp; Drop-fr√•gor</h3>
      <p class="mini">
        Skapa sorteringsfr√•gor: eleverna drar kort till r√§tt kategori-rutor.
        Du skriver f√∂rst alla kort i en ruta, sedan kategorier i en annan ‚Äì 
        d√§refter f√∂rdelar du korten p√• kategorier.
      </p>
      <div class="card-row">
        <div class="field" style="flex:0 0 100px;">
          <label class="small-label" for="dragLevel">Niv√•</label>
          <select id="dragLevel" class="input">
            <option value="E">E</option>
            <option value="C">C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div class="field">
          <label class="small-label" for="dragQuestion">Fr√•getext</label>
          <input id="dragQuestion" class="input" placeholder="T.ex. Dra varje matr√§tt till r√§tt kategori..." />
        </div>
      </div>
      <div class="card-row" style="margin-top:8px;">
        <div class="field">
          <label class="small-label" for="dragItems">Kort / alternativ (ett per rad)</label>
          <textarea id="dragItems" class="textarea" style="min-height:80px;" placeholder="t.ex. K√∂ttbullar&#10;Pannkakor&#10;√Ñpple"></textarea>
        </div>
        <div class="field">
          <label class="small-label" for="dragCategories">Kategori-rutor (ett per rad)</label>
          <textarea id="dragCategories" class="textarea" style="min-height:80px;" placeholder="t.ex. K√∂tt&#10;Efterr√§tt&#10;Frukt"></textarea>
        </div>
      </div>
      <div class="card-row" style="margin-top:8px;">
        <div class="field" style="flex:1;">
          <button id="btnDragBuildMapping" class="btn btn-sm">Bygg f√∂rdelning (kort ‚Üí kategori)</button>
          <div id="dragMappingArea" class="mini" style="margin-top:6px;">
            Inget f√∂rdelat √§nnu ‚Äì skriv kort och kategorier och klicka sedan p√• knappen.
          </div>
        </div>
        <div class="field">
          <label class="small-label" for="dragGoalPart">Kopplad delbit (valfritt)</label>
          <select id="dragGoalPart" class="input">
            <option value="">Ingen koppling</option>
          </select>
          <button id="btnDragAddGoalLink" class="btn btn-sm" type="button" style="margin-top:4px;">
            ‚ûï L√§gg till delm√•ls-koppling
          </button>
          <div id="dragGoalLinksPreview" class="mini" style="margin-top:4px;">Inga kopplingar √§nnu.</div>
        </div>
      </div>
      <div class="card-row" style="margin-top:12px;justify-content:space-between;">
        <div>
          <button id="btnDragAdd" class="btn btn-sm btn-primary">‚ûï L√§gg till drag &amp; drop-fr√•ga</button>
        </div>
        <button id="btnDragClear" class="btn sm">Avbryt/Rensa formul√§r</button>
      </div>
    </div>

    <div class="card card-full-width" style="margin-top:15px;">
      <h3>Aktuella drag &amp; drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
      <ul id="dragList" class="question-list"></ul>
    </div>
  `;

  const dragLevel = $("#dragLevel");
  const dragQuestion = $("#dragQuestion");
  const dragItems = $("#dragItems");
  const dragCategories = $("#dragCategories");
  const dragGoalPart = $("#dragGoalPart");
  const dragLinksPreview = $("#dragGoalLinksPreview");
  const btnAdd = $("#btnDragAdd");
  const btnClear = $("#btnDragClear");
  const btnAddGoalLink = $("#btnDragAddGoalLink");
  const btnBuildMapping = $("#btnDragBuildMapping");
  const mappingArea = $("#dragMappingArea");

  currentDragLinks = [];
  currentDragSourcesTmp = [];
  currentDragTargetsTmp = [];
  currentDragCorrectMapTmp = {};

  if (btnAddGoalLink && dragLinksPreview) {
    btnAddGoalLink.addEventListener("click", () => {
      const val = dragGoalPart.value;
      if (!val) return;
      const links = getLinksFromIds([val]);
      if (!links.length) return;
      const link = links[0];
      if (!currentDragLinks.some((x) => String(x.id) === String(link.id))) {
        currentDragLinks.push(link);
      }
      dragLinksPreview.innerHTML = currentDragLinks
        .map((lnk) => `<span class="goal-tag">${escapeHtml(lnk.goal || "-")} (Delbitar: ${escapeHtml(lnk.parts || "-")})</span>`)
        .join(" ");
    });
  }

  if (btnBuildMapping && mappingArea) {
    btnBuildMapping.addEventListener("click", () => {
      const srcLines = (dragItems && dragItems.value.split("\n").map((x) => x.trim()).filter((x) => x.length)) || [];
      const catLines = (dragCategories && dragCategories.value.split("\n").map((x) => x.trim()).filter((x) => x.length)) || [];

      if (!srcLines.length || !catLines.length) {
        alert("Skriv minst ett kort och minst en kategori f√∂rst.");
        return;
      }

      currentDragSourcesTmp = srcLines.map((label, idx) => ({
        id: "s" + idx,
        label
      }));
      currentDragTargetsTmp = catLines.map((label, idx) => ({
        id: "t" + idx,
        label
      }));
      currentDragCorrectMapTmp = {};

      mappingArea.innerHTML = "";
      const info = document.createElement("p");
      info.className = "mini";
      info.textContent = "V√§lj kategori f√∂r varje kort:";
      mappingArea.appendChild(info);

      currentDragSourcesTmp.forEach((src) => {
        const row = document.createElement("div");
        row.className = "card-row";
        row.style.alignItems = "center";

        const lblField = document.createElement("div");
        lblField.className = "field";
        lblField.style.flex = "1";
        lblField.innerHTML = `<span>${escapeHtml(src.label)}</span>`;

        const selField = document.createElement("div");
        selField.className = "field";
        selField.style.flex = "1";

        const sel = document.createElement("select");
        sel.className = "input";
        sel.dataset.sourceId = src.id;

        currentDragTargetsTmp.forEach((tgt) => {
          const opt = document.createElement("option");
          opt.value = tgt.id;
          opt.textContent = tgt.label;
          sel.appendChild(opt);
        });

        sel.addEventListener("change", () => {
          const sid = sel.dataset.sourceId;
          const tid = sel.value;
          if (sid && tid) {
            currentDragCorrectMapTmp[sid] = tid;
          }
        });

        // default f√∂rsta kategori
        if (currentDragTargetsTmp.length) {
          sel.value = currentDragTargetsTmp[0].id;
          currentDragCorrectMapTmp[src.id] = currentDragTargetsTmp[0].id;
        }

        selField.appendChild(sel);
        row.appendChild(lblField);
        row.appendChild(selField);
        mappingArea.appendChild(row);
      });
    });
  }

  if (btnAdd) {
    btnAdd.addEventListener("click", () => {
      const s = loadState();
      const level = dragLevel.value || "E";
      const text = (dragQuestion && dragQuestion.value.trim()) || "";

      if (!text) {
        alert("Skriv fr√•getext f√∂rst.");
        return;
      }
      if (!currentDragSourcesTmp.length || !currentDragTargetsTmp.length) {
        alert("Bygg f√∂rst upp kort och kategorier via 'Bygg f√∂rdelning'.");
        return;
      }

      for (const src of currentDragSourcesTmp) {
        if (!currentDragCorrectMapTmp[src.id]) {
          alert("Alla kort m√•ste ha en vald kategori.");
          return;
        }
      }

      const links = currentDragLinks.slice();
      const qObj = {
        type: "drag",
        level,
        q: text,
        dragSources: currentDragSourcesTmp.slice(),
        dragTargets: currentDragTargetsTmp.slice(),
        correctMap: Object.assign({}, currentDragCorrectMapTmp),
        links: links
      };
      if (links.length) {
        qObj.goal = links[0].goal;
        qObj.parts = links[0].parts;
      }

      if (!Array.isArray(s.bank.drag)) s.bank.drag = [];
      s.bank.drag.push(qObj);
      saveState(s);

      // reset editor
      if (dragQuestion) dragQuestion.value = "";
      if (dragItems) dragItems.value = "";
      if (dragCategories) dragCategories.value = "";
      if (dragGoalPart) dragGoalPart.value = "";
      if (dragLinksPreview) dragLinksPreview.textContent = "Inga kopplingar √§nnu.";
      if (mappingArea) {
        mappingArea.textContent = "Inget f√∂rdelat √§nnu ‚Äì skriv kort och kategorier och klicka sedan p√• knappen.";
      }
      currentDragLinks = [];
      currentDragSourcesTmp = [];
      currentDragTargetsTmp = [];
      currentDragCorrectMapTmp = {};

      renderDragList();
      syncUI();
    });
  }

  if (btnClear) {
    btnClear.addEventListener("click", () => {
      if (dragQuestion) dragQuestion.value = "";
      if (dragItems) dragItems.value = "";
      if (dragCategories) dragCategories.value = "";
      if (dragGoalPart) dragGoalPart.value = "";
      if (dragLinksPreview) dragLinksPreview.textContent = "Inga kopplingar √§nnu.";
      if (mappingArea) {
        mappingArea.textContent = "Inget f√∂rdelat √§nnu ‚Äì skriv kort och kategorier och klicka sedan p√• knappen.";
      }
      currentDragLinks = [];
      currentDragSourcesTmp = [];
      currentDragTargetsTmp = [];
      currentDragCorrectMapTmp = {};
    });
  }

  populateGoalSelect("#dragGoalPart");
  renderDragList();
}

/* =========================
   3j ‚Äì L√§rarl√§ge: l√∂senord, e-post, niv√•gr√§nser
   ========================= */

function initTeacherPasswordSettings() {
  const statusEl = $("#passwordStatus");
  const btnChange = $("#btnChangeTeacherPassword");
  const inputOld = $("#inputOldPassword");
  const inputNew = $("#inputNewPassword");
  const inputNewRepeat = $("#inputNewPasswordRepeat");

  if (!btnChange) return;

  btnChange.addEventListener("click", () => {
    const s = loadState();
    const current = s.teacherPassword;
    const oldVal = (inputOld && inputOld.value) || "";
    const newVal = (inputNew && inputNew.value) || "";
    const repeatVal = (inputNewRepeat && inputNewRepeat.value) || "";

    if (!newVal || !repeatVal) {
      if (statusEl) statusEl.textContent = "Nytt l√∂senord f√•r inte vara tomt.";
      return;
    }
    if (newVal !== repeatVal) {
      if (statusEl) statusEl.textContent = "Nya l√∂senorden matchar inte.";
      return;
    }
    if (current && oldVal !== current) {
      if (statusEl) statusEl.textContent = "Nuvarande l√∂senord st√§mmer inte.";
      return;
    }
    s.teacherPassword = newVal;
    saveState(s);
    if (statusEl) statusEl.textContent = "L√§rarl√∂senord uppdaterat.";
    if (inputOld) inputOld.value = "";
    if (inputNew) inputNew.value = "";
    if (inputNewRepeat) inputNewRepeat.value = "";
  });
}

function initTeacherEmailSettings() {
  const inputEmail = $("#inputTeacherEmail");
  const btnSave = $("#btnSaveTeacherEmail");
  const statusEl = $("#teacherEmailStatus");
  const s = loadState();

  if (inputEmail) inputEmail.value = s.teacherEmail || "";

  if (btnSave) {
    btnSave.addEventListener("click", () => {
      const val = (inputEmail && inputEmail.value.trim()) || "";
      const s2 = loadState();
      s2.teacherEmail = val;
      saveState(s2);
      if (statusEl) statusEl.textContent = val ? "E-postadress sparad." : "E-postadress rensad.";
    });
  }
}

function initThresholdSettings() {
  const inputE = $("#inputThresE");
  const inputC = $("#inputThresC");
  const inputA = $("#inputThresA");
  const btnSave = $("#btnSaveThresholds");
  const s = loadState();

  if (inputE) inputE.value = s.thres.E;
  if (inputC) inputC.value = s.thres.C;
  if (inputA) inputA.value = s.thres.A;

  if (btnSave) {
    btnSave.addEventListener("click", () => {
      const s2 = loadState();
      if (inputE) s2.thres.E = clampInt(inputE.value, 0, 100);
      if (inputC) s2.thres.C = clampInt(inputC.value, 0, 100);
      if (inputA) s2.thres.A = clampInt(inputA.value, 0, 100);
      saveState(s2);
      syncUI();
    });
  }
}

/* =========================
   3k ‚Äì L√§rarl√§ge: gate, modal & flikar
   ========================= */

function openTeacherGate() {
  const gate = $("#teacherGate");
  const text = $("#teacherGateText");
  const input = $("#teacherPasswordInput");
  const s = loadState();
  if (!gate || !text || !input) return;

  gate.classList.remove("hidden");
  input.value = "";
  if (s.teacherPassword) {
    text.textContent = "Ange l√§rarl√∂senord f√∂r att √∂ppna l√§rarl√§get.";
  } else {
    text.textContent = "F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.";
  }
}

function closeTeacherGate() {
  const gate = $("#teacherGate");
  if (gate) gate.classList.add("hidden");
}

function openTeacherModal() {
  const modal = $("#teacherModal");
  if (modal) modal.classList.remove("hidden");
}

function closeTeacherModal() {
  const modal = $("#teacherModal");
  if (modal) modal.classList.add("hidden");
}

function handleTeacherConfirm() {
  const input = $("#teacherPasswordInput");
  if (!input) return;
  const value = input.value;
  const s = loadState();

  if (!s.teacherPassword) {
    s.teacherPassword = value;
    saveState(s);
    closeTeacherGate();
    openTeacherModal();
    return;
  }

  if (value === s.teacherPassword) {
    closeTeacherGate();
    openTeacherModal();
  } else {
    alert("Fel l√§rarl√∂senord.");
  }
}

function setupTabNavigation() {
  const tabs = $all(".tab-btn");
  const panels = $all(".tab-panel");

  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const target = tab.getAttribute("data-tab");
      tabs.forEach((t) => t.classList.remove("active"));
      panels.forEach((p) => p.classList.add("hidden"));

      tab.classList.add("active");
      const panel = document.querySelector(`.tab-panel[data-panel="${target}"]`);
      if (panel) panel.classList.remove("hidden");
    });
  });
}
</script>
<!-- slut SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker & editorer) -->


<!-- start SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression) -->
<script>
/* =========================
   4a ‚Äì Elevdata & UI-sync
   ========================= */

function ensureStudentSet() {
  const s = loadState();
  if (!s.student.name || !s.student.klass) {
    alert("Skriv in namn och klass och spara eleven f√∂rst.");
    return false;
  }
  return true;
}

function handleSaveStudent() {
  const nameInput = $("#studentName");
  const classInput = $("#studentClass");
  const s = loadState();

  s.student.name = (nameInput && nameInput.value.trim()) || "";
  s.student.klass = (classInput && classInput.value.trim()) || "";
  saveState(s);
  syncUI();
}

// üîÅ Po√§ng in i samma rad som "Sparad: ..." (ingen extra ruta)
function updateStudentSavedLabel(s, hasStudent) {
  const studentSaved = $("#studentSaved");
  if (!studentSaved) return;

  if (!hasStudent) {
    studentSaved.textContent = "Ej sparad elev";
    return;
  }

  const prog = s.progression || {};
  const totalPoints = prog.totalPoints || 0;
  studentSaved.textContent = `Sparad: ${s.student.name} (${s.student.klass}) ¬∑ Po√§ng: ${totalPoints} p.`;
}

/* =========================
   4a.1 ‚Äì L√§rarvy: detaljerad progression per delm√•l
   ========================= */

function renderProgressionDetails() {
  let host = $("#progressionDetails");
  if (!host) {
    // F√∂rs√∂k hitta progressionstabben och skapa en host d√§r
    const tab = document.getElementById("tab-progression");
    if (!tab) return;
    host = document.createElement("div");
    host.id = "progressionDetails";
    tab.appendChild(host);
  }

  const s = loadState();
  const prog = s.progression || {};
  const wrongMap = prog.wrongByGoalId || {};
  const correctMap = prog.correctByGoalId || {};
  const goals = s.goalsMap || [];

  const allKeys = new Set([
    ...Object.keys(wrongMap),
    ...Object.keys(correctMap)
  ]);

  if (!allKeys.size) {
    host.innerHTML = `
      <p class="mini">Inga progressiondata √§nnu. Eleven har inte spelat klart n√•gon niv√•.</p>
    `;
    return;
  }

  const rows = [];
  allKeys.forEach((id) => {
    const wrong = wrongMap[id] || 0;
    const correct = correctMap[id] || 0;
    const g = goals.find((x) => String(x.id) === String(id));

    rows.push({
      id,
      wrong,
      correct,
      goal: g ? g.goal : "",
      parts: g ? g.parts : ""
    });
  });

  // Sortera s√• att "problem-delbitar" (m√•nga fel) hamnar √∂verst
  rows.sort((a, b) => {
    const diff = (b.wrong || 0) - (a.wrong || 0);
    if (diff !== 0) return diff;
    return String(a.id).localeCompare(String(b.id));
  });

  let html = `<p class="mini">Totala po√§ng: ${prog.totalPoints || 0} p.</p>`;
  html += `
    <table class="mini-table">
      <thead>
        <tr>
          <th>Delm√•l</th>
          <th>Delbit(er)</th>
          <th>R√§tt</th>
          <th>Fel</th>
        </tr>
      </thead>
      <tbody>
  `;

  rows.forEach((r) => {
    const goalText = escapeHtml(r.goal || `Delm√•l ${r.id}`);
    const partsText = escapeHtml(r.parts || "-");
    const correct = r.correct || 0;
    const wrong = r.wrong || 0;

    html += `
      <tr>
        <td>${goalText}</td>
        <td>${partsText}</td>
        <td>${correct}</td>
        <td>${wrong}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  host.innerHTML = html;
}

function syncUI() {
  const s = loadState();
  const hasStudent = !!(s.student.name && s.student.klass);

  const nameInput = $("#studentName");
  const classInput = $("#studentClass");
  if (nameInput) nameInput.value = s.student.name || "";
  if (classInput) classInput.value = s.student.klass || "";

  updateStudentSavedLabel(s, hasStudent);

  const bestE = $("#best-levelE");
  const bestC = $("#best-levelC");
  const bestA = $("#best-levelA");
  if (bestE) bestE.textContent = s.best.E || 0;
  if (bestC) bestC.textContent = s.best.C || 0;
  if (bestA) bestA.textContent = s.best.A || 0;

  const thresE = $("#thres-levelE");
  const thresC = $("#thres-levelC");
  const thresA = $("#thres-levelA");
  if (thresE) thresE.textContent = s.thres.E;
  if (thresC) thresC.textContent = s.thres.C;
  if (thresA) thresA.textContent = s.thres.A;

  const cardE = $("#card-levelE");
  const cardC = $("#card-levelC");
  const cardA = $("#card-levelA");
  const btnE = $("#start-levelE");
  const btnC = $("#start-levelC");
  const btnA = $("#start-levelA");
  const badgeE = $("#badge-levelE");
  const badgeC = $("#badge-levelC");
  const badgeA = $("#badge-levelA");

  // Niv√• 1 (E)
  if (cardE && btnE && badgeE) {
    if (hasStudent) {
      cardE.classList.remove("locked");
      btnE.disabled = false;
      badgeE.textContent = "Starta";
      badgeE.classList.remove("badge-lock");
      badgeE.classList.add("badge-ok");
    } else {
      cardE.classList.add("locked");
      btnE.disabled = true;
      badgeE.textContent = "L√•st";
      badgeE.classList.remove("badge-ok");
      badgeE.classList.add("badge-lock");
    }
  }

  // Niv√• 2 (C)
  if (cardC && btnC && badgeC) {
    if (s.unlocked.C) {
      cardC.classList.remove("locked");
      btnC.disabled = false;
      badgeC.textContent = "Uppl√•st";
      badgeC.classList.remove("badge-lock");
      badgeC.classList.add("badge-ok");
    } else {
      cardC.classList.add("locked");
      btnC.disabled = true;
      badgeC.textContent = "L√•st";
      badgeC.classList.remove("badge-ok");
      badgeC.classList.add("badge-lock");
    }
  }

  // Niv√• 3 (A)
  if (cardA && btnA && badgeA) {
    if (s.unlocked.A) {
      cardA.classList.remove("locked");
      btnA.disabled = false;
      badgeA.textContent = "Uppl√•st";
      badgeA.classList.remove("badge-lock");
      badgeA.classList.add("badge-ok");
    } else {
      cardA.classList.add("locked");
      btnA.disabled = true;
      badgeA.textContent = "L√•st";
      badgeA.classList.remove("badge-ok");
      badgeA.classList.add("badge-lock");
    }
  }

  const who = $("#whoPlays");
  if (who) {
    who.textContent = hasStudent
      ? `${s.student.name} (${s.student.klass})`
      : "Ingen elev vald.";
  }

  const playSection = $("#play");
  const resultSection = $("#result");
  const studentCard = $("#studentCard");

  const isPlaying = !!currentLevel;
  const isResultVisible = resultSection && !resultSection.classList.contains("hidden");

  if (studentCard) {
    studentCard.classList.toggle("hidden", isPlaying || isResultVisible);
  }

  renderProgressionDetails();
}

/* =========================
   4b ‚Äì Spel-logik (fr√•gerendering & niv√•er)
   ========================= */

function renderDragQuestion(q, index, host) {
  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"}) ‚Äì Drag & Drop`;
  container.appendChild(header);

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.flexWrap = "wrap";
  wrapper.style.gap = "12px";
  wrapper.style.marginTop = "6px";

  const sourcesCol = document.createElement("div");
  sourcesCol.style.flex = "1 1 180px";

  const targetsCol = document.createElement("div");
  targetsCol.style.flex = "2 1 260px";

  const srcTitle = document.createElement("div");
  srcTitle.className = "mini";
  srcTitle.textContent = "Kort att dra:";
  sourcesCol.appendChild(srcTitle);

  const srcZone = document.createElement("div");
  srcZone.style.border = "1px dashed #1f2937";
  srcZone.style.borderRadius = "8px";
  srcZone.style.padding = "6px";
  srcZone.style.minHeight = "40px";
  srcZone.style.display = "flex";
  srcZone.style.flexWrap = "wrap";
  srcZone.style.gap = "4px";
  sourcesCol.appendChild(srcZone);

  const tgtTitle = document.createElement("div");
  tgtTitle.className = "mini";
  tgtTitle.textContent = "Kategori-rutor:";
  targetsCol.appendChild(tgtTitle);

  const tgtZone = document.createElement("div");
  tgtZone.style.display = "flex";
  tgtZone.style.flexWrap = "wrap";
  tgtZone.style.gap = "8px";
  targetsCol.appendChild(tgtZone);

  wrapper.appendChild(sourcesCol);
  wrapper.appendChild(targetsCol);
  container.appendChild(wrapper);

  const sources = Array.isArray(q.dragSources) ? q.dragSources : [];
  const targets = Array.isArray(q.dragTargets) ? q.dragTargets : [];
  const answers = {};
  currentAnswers[index] = answers;

  function makeDraggableChip(src) {
    const chip = document.createElement("div");
    chip.textContent = src.label;
    chip.draggable = true;
    chip.dataset.itemId = src.id;
    chip.className = "chip";
    chip.style.cursor = "grab";
    chip.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", src.id);
    });
    return chip;
  }

  function setupDropTarget(el, targetId) {
    el.addEventListener("dragover", (ev) => {
      ev.preventDefault();
    });
    el.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      el.appendChild(existing);

      if (targetId === null) {
        delete answers[itemId];
      } else {
        answers[itemId] = targetId;
      }
    });
  }

  setupDropTarget(srcZone, null);

  sources.forEach((src) => {
    const chip = makeDraggableChip(src);
    srcZone.appendChild(chip);
  });

  targets.forEach((tgt) => {
    const box = document.createElement("div");
    box.style.border = "1px solid #1f2937";
    box.style.borderRadius = "8px";
    box.style.padding = "6px";
    box.style.minHeight = "46px";
    box.style.minWidth = "110px";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "4px";

    const cap = document.createElement("div");
    cap.className = "mini";
    cap.textContent = tgt.label;
    box.appendChild(cap);

    const slot = document.createElement("div");
    slot.style.display = "flex";
    slot.style.flexWrap = "wrap";
    slot.style.gap = "4px";
    box.appendChild(slot);

    box.addEventListener("dragover", (ev) => {
      ev.preventDefault();
    });
    box.addEventListener("drop", (ev) => {
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;
      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;
      slot.appendChild(existing);
      answers[itemId] = tgt.id;
    });

    tgtZone.appendChild(box);
  });

  host.appendChild(container);
}

function renderQuestionItem(q, index, host) {
  if (q.type === "drag") {
    renderDragQuestion(q, index, host);
    return;
  }

  const container = document.createElement("div");
  container.className = "question";

  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${q.level || "E"})`;
  container.appendChild(header);

  if (q.type === "img" && q.imgDataUrl) {
    const img = document.createElement("img");
    img.src = q.imgDataUrl;
    img.alt = "Bildfr√•ga";
    container.appendChild(img);
  }

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = q.q || q.text || "";
  container.appendChild(textDiv);

  const optionsList = document.createElement("div");
  optionsList.className = "options-list";
  (q.options || []).forEach((opt, optIndex) => {
    const label = document.createElement("label");
    label.className = "option-label";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = `q-${index}`;
    input.value = String(optIndex);
    input.addEventListener("change", () => {
      currentAnswers[index] = optIndex;
    });

    const span = document.createElement("span");
    span.textContent = opt;

    label.appendChild(input);
    label.appendChild(span);
    optionsList.appendChild(label);
  });
  container.appendChild(optionsList);

  host.appendChild(container);
}

function startLevel(level) {
  if (!ensureStudentSet()) return;

  const s = loadState();
  const allQuestions = []
    .concat(s.bank.mcq || [])
    .concat(s.bank.img || [])
    .concat(s.bank.drag || []);

  const pool = allQuestions.filter((q) => (q.level || "E") === level);
  if (!pool.length) {
    alert("Det finns inga fr√•gor p√• denna niv√• √§nnu.");
    return;
  }

  currentLevel = level;
  currentQuestions = shuffle(pool);
  currentAnswers = new Array(currentQuestions.length).fill(null);

  const playSection = $("#play");
  const resultSection = $("#result");
  const questionsHost = $("#questions");

  if (resultSection) resultSection.classList.add("hidden");
  if (playSection) playSection.classList.remove("hidden");
  if (questionsHost) {
    questionsHost.innerHTML = "";
    currentQuestions.forEach((q, idx) => renderQuestionItem(q, idx, questionsHost));
  }

  const title = $("#play-title");
  const who = $("#whoPlays");
  if (title) {
    if (level === "E") title.textContent = "Niv√• 1 ‚Äì Grundniv√• (E)";
    else if (level === "C") title.textContent = "Niv√• 2 ‚Äì Mellanniv√• (C)";
    else title.textContent = "Niv√• 3 ‚Äì Avancerad (A)";
  }
  if (who) {
    who.textContent = `${s.student.name} (${s.student.klass})`;
  }

  syncUI();
}

function finishLevel() {
  if (!currentLevel || !currentQuestions.length) {
    alert("Ingen niv√• √§r aktiv.");
    return;
  }

  const s = loadState();
  const goals = s.goalsMap || [];
  let correctCount = 0;
  let pointsGained = 0;
  let allCorrect = true;

  if (!s.progression || typeof s.progression !== "object") {
    s.progression = { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {} };
  }
  s.progression.totalPoints = s.progression.totalPoints || 0;
  s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
  s.progression.correctByGoalId = s.progression.correctByGoalId || {};

  const wrongByGoal = s.progression.wrongByGoalId;
  const correctByGoal = s.progression.correctByGoalId;

  const lvl = currentLevel;
  const basePointsPerQuestion =
    lvl === "A" ? 3 :
    lvl === "C" ? 2 : 1;

  currentQuestions.forEach((q, index) => {
    const ansVal = currentAnswers[index];
    let isCorrect = false;

    if (q.type === "drag") {
      const correctMap = q.correctMap || {};
      const keys = Object.keys(correctMap);
      if (!keys.length) {
        isCorrect = false;
      } else if (!ansVal || typeof ansVal !== "object") {
        isCorrect = false;
      } else {
        let allOk = true;
        for (const itemId of keys) {
          if (!ansVal[itemId] || ansVal[itemId] !== correctMap[itemId]) {
            allOk = false;
            break;
          }
        }
        isCorrect = allOk;
      }
    } else {
      if (ansVal != null) {
        const correctIndex = typeof q.answer === "number" ? q.answer : q.correct;
        isCorrect = ansVal === correctIndex;
      } else {
        isCorrect = false;
      }
    }

    if (isCorrect) {
      correctCount++;
      pointsGained += basePointsPerQuestion;
    } else {
      allCorrect = false;
    }

    const links = getLinksForQuestion(q, goals);
    if (links && links.length) {
      links.forEach((lnk) => {
        const key = String(lnk.id);
        if (isCorrect) {
          correctByGoal[key] = (correctByGoal[key] || 0) + 1;
        } else {
          wrongByGoal[key] = (wrongByGoal[key] || 0) + 1;
        }
      });
    }
  });

  const total = currentQuestions.length;
  const percentage = total ? Math.round((correctCount / total) * 100) : 0;
  const threshold = (s.thres && s.thres[lvl] != null) ? s.thres[lvl] : 70;

  if (percentage > (s.best && s.best[lvl] || 0)) {
    s.best[lvl] = percentage;
  }

  if (lvl === "E" && percentage >= threshold) s.unlocked.C = true;
  if (lvl === "C" && percentage >= threshold) s.unlocked.A = true;

  if (total > 0 && allCorrect) {
    pointsGained += 5;
  }

  s.progression.totalPoints += pointsGained;
  saveState(s);

  lastSubmission = {
    level: lvl,
    studentName: s.student.name,
    studentClass: s.student.klass,
    timestamp: new Date().toISOString(),
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter: s.progression.totalPoints,
    answers: currentAnswers.slice(),
    questions: currentQuestions.map((q) => ({
      q: q.q || q.text || "",
      type: q.type || "mcq",
      level: q.level || lvl,
      answer: typeof q.answer === "number" ? q.answer : q.correct,
      goal: q.goal || null,
      parts: q.parts || null
    }))
  };

  const playSection = $("#play");
  const resultSection = $("#result");
  if (playSection) playSection.classList.add("hidden");
  if (resultSection) resultSection.classList.remove("hidden");

  const scoreText = $("#scoreText");
  const scoreDetail = $("#scoreDetail");
  const resName = $("#resName");
  const resClass = $("#resClass");
  const passBadge = $("#passBadge");
  const unlockText = $("#unlockText");

  if (scoreText) scoreText.innerHTML = `${percentage}%<span> resultat</span>`;
  if (scoreDetail) {
    scoreDetail.textContent = `${correctCount}/${total} r√§tt ‚Äì niv√•po√§ng: +${pointsGained}p, totalt: ${s.progression.totalPoints}p`;
  }
  if (resName) resName.textContent = s.student.name || "-";
  if (resClass) resClass.textContent = s.student.klass || "-";

  if (passBadge) {
    const passed = percentage >= threshold;
    if (passed) {
      passBadge.className = "badge-pass";
      passBadge.textContent = "Godk√§nd niv√•";
    } else {
      passBadge.className = "badge-fail";
      passBadge.textContent = "Inte godk√§nd √§nnu";
    }
  }

  if (unlockText) {
    let txt = "";
    if (lvl === "E" && s.unlocked.C) txt = "Niv√• 2 (C) √§r nu uppl√•st.";
    else if (lvl === "C" && s.unlocked.A) txt = "Niv√• 3 (A) √§r nu uppl√•st.";
    unlockText.textContent = txt;
  }

  currentLevel = null;
  currentQuestions = [];
  currentAnswers = [];

  syncUI();
}
</script>
<!-- slut SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression) -->





<!-- start SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post & initiering) -->
<script>
/* =========================
   5a ‚Äì E-postinl√§mning
   ========================= */

function emailResultToTeacher() {
  if (!lastSubmission) {
    alert("Det finns inget resultat att skicka. Spela en niv√• f√∂rst.");
    return;
  }
  const s = loadState();
  const inputEmail = $("#inputTeacherEmail");
  const teacherEmail =
    s.teacherEmail ||
    (inputEmail && inputEmail.value.trim()) ||
    "";

  if (!teacherEmail) {
    alert("Ingen l√§rar-e-post √§r sparad. G√• till Inst√§llningar och fyll i 'L√§rarens e-post'.");
    return;
  }

  const jsonText = JSON.stringify(lastSubmission, null, 2);
  const subject = `F√•ngvaktaren ‚Äì resultat ${lastSubmission.studentName || "Elev"} (${lastSubmission.studentClass || ""})`;
  const body =
    `Hej!\n\n` +
    `H√§r kommer resultat fr√•n F√•ngvaktaren.\n\n` +
    `Elev: ${lastSubmission.studentName || "-"} (${lastSubmission.studentClass || "-"})\n` +
    `Niv√•: ${lastSubmission.level}\n` +
    `Resultat: ${lastSubmission.score}% (${lastSubmission.correct}/${lastSubmission.total} r√§tt)\n` +
    `Po√§ng denna niv√•: ${lastSubmission.pointsGained || 0}p\n` +
    `Totala progressionpo√§ng efter denna omg√•ng: ${lastSubmission.totalPointsAfter || 0}p\n` +
    `Datum: ${new Date(lastSubmission.timestamp).toLocaleString("sv-SE")}\n\n` +
    `JSON-data (f√∂r elevkort / dokumentation):\n` +
    `${jsonText}\n\n` +
    `V√§nliga h√§lsningar\n` +
    `${lastSubmission.studentName || "Elev"}`;

  const mailtoLink =
    `mailto:${encodeURIComponent(teacherEmail)}` +
    `?subject=${encodeURIComponent(subject)}` +
    `&body=${encodeURIComponent(body)}`;

  window.location.href = mailtoLink;
}

/* =========================
   5b ‚Äì Visa aktuellt l√§rarl√∂senord
   ========================= */

// üîÅ Ny helper: visar nuvarande l√§rarl√∂senord i statusrutan (endast lokalt, fr√•n localStorage)
function showTeacherPasswordInStatus() {
  const s = loadState();
  const statusEl = $("#passwordStatus");
  if (statusEl && s.teacherPassword) {
    statusEl.textContent = `Aktuellt l√§rarl√∂senord: ${s.teacherPassword}`;
  }
}

/* =========================
   5c ‚Äì Initiering
   ========================= */

function initApp() {
  const s = loadState();
  if (!s.bank.mcq.length && !s.bank.img.length && !s.bank.drag.length) {
    const merged = mergeEmbeddedBank(s);
    saveState(merged);
  }

  initTeacherEmailSettings();
  initThresholdSettings();
  initTeacherPasswordSettings();
  showTeacherPasswordInStatus(); // üîÅ visar l√∂senordet direkt

  initGoalsMap();
  initQuestionForms();
  initImageQuestionsEditor();
  initDragDropQuestionsEditor();
  setupTabNavigation();
  setupCloudBankUI();
  syncUI();

  const btnSaveStudent = $("#btnSaveStudent");
  if (btnSaveStudent) btnSaveStudent.addEventListener("click", handleSaveStudent);

  const btnTeacherMode = $("#btnTeacherMode");
  if (btnTeacherMode) btnTeacherMode.addEventListener("click", openTeacherGate);

  const btnTeacherCancel = $("#btnTeacherCancel");
  if (btnTeacherCancel) btnTeacherCancel.addEventListener("click", closeTeacherGate);

  const btnTeacherConfirm = $("#btnTeacherConfirm");
  if (btnTeacherConfirm) btnTeacherConfirm.addEventListener("click", handleTeacherConfirm);

  const btnCloseTeacher = $("#btnCloseTeacher");
  if (btnCloseTeacher) btnCloseTeacher.addEventListener("click", closeTeacherModal);

  const btnBack = $("#btnBack");
  if (btnBack) {
    btnBack.addEventListener("click", () => {
      const result = $("#result");
      const play = $("#play");
      if (result) result.classList.add("hidden");
      if (play) play.classList.add("hidden");
      const studentCard = $("#studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      syncUI();
    });
  }

  const btnCancel = $("#btnCancel");
  if (btnCancel) {
    btnCancel.addEventListener("click", () => {
      currentLevel = null;
      currentQuestions = [];
      currentAnswers = [];
      const play = $("#play");
      const result = $("#result");
      if (play) play.classList.add("hidden");
      if (result) result.classList.add("hidden");
      const studentCard = $("#studentCard");
      if (studentCard) studentCard.classList.remove("hidden");
      syncUI();
    });
  }

  const btnSubmitGame = $("#btnSubmitGame");
  if (btnSubmitGame) {
    btnSubmitGame.addEventListener("click", emailResultToTeacher);
  }

  const btnStartE = $("#start-levelE");
  const btnStartC = $("#start-levelC");
  const btnStartA = $("#start-levelA");
  if (btnStartE) btnStartE.addEventListener("click", () => startLevel("E"));
  if (btnStartC) btnStartC.addEventListener("click", () => startLevel("C"));
  if (btnStartA) btnStartA.addEventListener("click", () => startLevel("A"));

  const btnFinish = $("#btnFinish");
  if (btnFinish) btnFinish.addEventListener("click", finishLevel);
}

document.addEventListener("DOMContentLoaded", () => {
  initFirebase();
  initApp();
});
</script>
<!-- slut SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (e-post & initiering) -->






<!-- start SEKTION 6: AVSLUTANDE TAGGAR -->
</body>
</html>
<!-- slut SEKTION 6: AVSLUTANDE TAGGAR -->
