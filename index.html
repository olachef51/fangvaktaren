<!-- start SEKTION 1: HEAD & STIL -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>F√•ngvaktaren ‚Äì Progressionsspel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --accent-e:#b45309;
      --accent-c:#2563eb;
      --accent-a:#7c3aed;
      --accent-danger:#ef4444;
      --accent-info:#38bdf8;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --chip:#020617;
    }

    *{box-sizing:border-box;}

    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#020617 0,#020617 40%,#000 100%);
      color:var(--text);
    }

    body{
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:960px;
      margin:0 auto;
      min-height:100vh;
      padding:12px 12px 32px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(15,23,42,.85));
      border:1px solid #1f2937;
      box-shadow:0 0 40px rgba(15,23,42,.9);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(10px);
    }

    .header-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .title-block h1{
      margin:0;
      font-size:1.2rem;
      letter-spacing:.03em;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:999px;
      background:radial-gradient(circle,var(--accent-e),#111827);
      color:#fff;
      font-weight:700;
      font-size:.9rem;
      box-shadow:0 0 12px rgba(180,83,9,.8);
    }

    /* ---------- Buttons ---------- */

    .btn{
      --btn-bg:#111827;
      --btn-border:rgba(75,85,99,.9);
      border-radius:999px;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      padding:6px 12px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
      transition:
        background-color .15s ease,
        border-color .15s ease,
        box-shadow .18s ease,
        transform .12s ease,
        opacity .15s ease;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 0 0 rgba(59,130,246,0);
    }

    .btn-sm{
      padding:5px 10px;
      font-size:.8rem;
    }

    .btn-primary{
      --btn-bg:linear-gradient(135deg,var(--accent-e),var(--accent-c));
      --btn-border:rgba(96,165,250,.9);
      color:#f9fafb;
      box-shadow:
        0 0 0 1px rgba(148,163,184,.4),
        0 0 18px rgba(56,189,248,.45);
    }

    .btn-danger{
      --btn-bg:rgba(127,29,29,.95);
      --btn-border:rgba(239,68,68,.9);
      box-shadow:
        0 0 0 1px rgba(248,113,113,.5),
        0 0 14px rgba(248,113,113,.4);
    }

    .btn-secondary{
      --btn-bg:#020617;
      --btn-border:rgba(75,85,99,.8);
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(148,163,184,.6),
        0 0 24px rgba(59,130,246,.55);
      opacity:.97;
    }

    .btn:active{
      transform:translateY(0);
      box-shadow:
        0 0 0 1px rgba(107,114,128,.8),
        0 0 12px rgba(37,99,235,.45);
      opacity:.92;
    }

    .btn:disabled,
    .btn[disabled]{
      opacity:.45;
      cursor:default;
      box-shadow:
        0 0 0 1px rgba(31,41,55,1),
        0 0 0 rgba(0,0,0,0);
      transform:none;
    }

    /* --------- NYTT: Mejlad-l√§nk i roster (g√∂r knappen gr√∂n n√§r JS s√§tter class "sent") --------- */
    .btn.sent,
    .sent.btn,
    .sent{
      background:linear-gradient(135deg,#16a34a,#22c55e) !important;
      border-color:rgba(34,197,94,1) !important;
      color:#ecfdf5 !important;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 18px rgba(22,163,74,.7) !important;
    }

    .btn.sent:hover,
    .sent.btn:hover,
    .sent:hover{
      background:linear-gradient(135deg,#16a34a,#22c55e) !important;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 26px rgba(34,197,94,.9) !important;
      transform:translateY(-1px);
      opacity:1 !important;
    }

    .btn.sent:active,
    .sent.btn:active,
    .sent:active{
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 14px rgba(34,197,94,.8) !important;
      transform:translateY(0);
    }
    /* --------- SLUT NYTT --------- */

    /* Spara elev ‚Äì tydlig gr√∂n, fyllig knapp */
    #btnSaveStudent{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      border-color:rgba(34,197,94,1);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 20px rgba(34,197,94,.75);
    }

    #btnSaveStudent:hover{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 26px rgba(34,197,94,.9);
      transform:translateY(-1px);
    }

    #btnSaveStudent:active{
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 14px rgba(34,197,94,.8);
      transform:translateY(0);
    }

    #btnSaveStudent:disabled{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      opacity:.45;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 0 rgba(0,0,0,0);
    }

    /* L√§rarl√§ge ‚Äì m√∂rk bakgrund, gr√∂n kontur (outline-knapp) */
    #btnTeacherMode{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherMode:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherMode:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* L√∂senords-popup: ‚ÄúForts√§tt‚Äù ‚Äì samma gr√∂na kontur som l√§rarl√§ge */
    #btnTeacherConfirm{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherConfirm:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherConfirm:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* Spara niv√•gr√§nser ‚Äì gr√∂n kontur, samma stil */
    #btnSaveThresholds{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnSaveThresholds:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnSaveThresholds:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* ---------- Layout helpers ---------- */

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1 1 120px;
      min-width:0;
    }

    label{
      font-size:.7rem;
      color:var(--muted);
    }

    .small-label{
      font-size:.7rem;
      color:var(--muted);
    }

    .input,
    .input-number{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:.8rem;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }

    .input-number{
      appearance:textfield;
      -moz-appearance:textfield;
    }

    .input-number::-webkit-outer-spin-button,
    .input-number::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    .input:focus,
    .input-number:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
      background:#020617;
    }

    .mini{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.4;
    }

    .hidden{
      display:none !important;
    }

    /* ---------- Elevkort ---------- */

    .student-card{
      background:radial-gradient(circle at top left,#020617,#020617 55%,#000 100%);
      border-radius:16px;
      padding:12px 12px 14px;
      border:1px solid rgba(31,41,55,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .student-main-row{
      align-items:flex-end;
    }

    .student-save-field{
      max-width:180px;
    }

    .student-status-row{
      margin-top:2px;
    }

    .student-saved-label{
      font-size:.75rem;
      color:var(--muted);
    }

    .student-stats-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
    }

    .score-box{
      flex:1 1 160px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 55%,#000 100%);
      display:flex;
      flex-direction:column;
      gap:2px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 20px rgba(56,189,248,.4),
        0 12px 28px rgba(15,23,42,.9);
    }

    .score-label{
      font-size:.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .score-value{
      font-size:1rem;
      font-weight:600;
    }

    /* ---------- Niv√•-kort ---------- */

    .levels-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }

    .level-card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.9);
    }

    .level-card.locked{
      opacity:.7;
      filter:saturate(.7);
    }

    .level-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .level-title span:first-child{
      font-weight:600;
      font-size:.9rem;
    }

    .level-title small{
      display:block;
      font-size:.7rem;
      color:var(--muted);
    }

    .level-body{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:.78rem;
    }

    .level-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-top:4px;
    }

    .badge{
      border-radius:999px;
      padding:2px 8px;
      font-size:.7rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
    }

    .badge-lock{
      color:#fbbf24;
      border-color:rgba(245,158,11,.7);
      box-shadow:0 0 12px rgba(245,158,11,.35);
    }

    .badge-ok{
      color:#4ade80;
      border-color:rgba(74,222,128,.9);
      box-shadow:0 0 16px rgba(22,163,74,.65);
    }

    .badge-pass{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 18px rgba(22,163,74,.7);
    }

    .badge-fail{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#991b1b,#ef4444);
      color:#fee2e2;
      box-shadow:
        0 0 0 1px rgba(127,29,29,1),
        0 0 18px rgba(248,113,113,.7);
    }

    /* ---------- Spelpanel / Resultat ---------- */

    .play-panel,
    .result-panel{
      margin-top:8px;
      padding:10px 10px 12px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
    }

    .play-header,
    .result-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .questions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:4px;
    }

    .question{
      padding:8px 9px;
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top left,#020617,#020617 60%,#020617 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 26px rgba(15,23,42,.9);
      font-size:.85rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .q-text{
      font-size:.85rem;
      margin-top:2px;
    }

    .options-list{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:2px;
    }

    .option-label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
      padding:4px 6px;
      border-radius:999px;
      background:#020617;
      border:1px solid rgba(31,41,55,1);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,transform .1s ease;
    }

    .option-label input{
      accent-color:var(--accent-c);
    }

    .option-label:hover{
      background:#020617;
      border-color:rgba(59,130,246,.7);
      box-shadow:
        0 0 0 1px rgba(59,130,246,.9),
        0 0 16px rgba(37,99,235,.6);
      transform:translateY(-1px);
    }

    .play-footer{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:.75rem;
    }

    .play-actions{
      display:flex;
      gap:6px;
    }

    .score{
      font-size:1.6rem;
      font-weight:700;
    }

    .score span{
      font-size:.8rem;
      font-weight:400;
      margin-left:4px;
      color:var(--muted);
    }

    .result-meta{
      font-size:.78rem;
      color:var(--muted);
      margin-top:2px;
    }

    .result-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ---------- Modal & gate ---------- */

    .gate-backdrop,
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
      backdrop-filter:blur(10px);
    }

    .gate-box{
      width:100%;
      max-width:320px;
      padding:14px 14px 16px;
      border-radius:16px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:.85rem;
    }

    .gate-actions{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }

    .modal{
      width:100%;
      max-width:980px;
      max-height:90vh;
      padding:12px 12px 14px;
      border-radius:18px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:4px;
    }

    .modal-body{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding-right:2px;
    }

    /* ---------- Flikar ---------- */

    .tab-nav{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
    }

    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(55,65,81,1);
      padding:4px 9px;
      font-size:.75rem;
      background:#020617;
      color:var(--muted);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,color .15s ease;
    }

    .tab-btn.active{
      color:#e5e7eb;
      border-color:rgba(96,165,250,1);
      background:linear-gradient(135deg,#0369a1,#4f46e5);
      box-shadow:
        0 0 0 1px rgba(37,99,235,1),
        0 0 20px rgba(56,189,248,.7);
    }

    .tab-panel{
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 16px 34px rgba(15,23,42,.95);
    }

    /* ---------- Cards & grids ---------- */

    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px 10px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.95);
      font-size:.82rem;
    }

    .card-full-width{
      grid-column:1/-1;
    }

    .card-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }

    .questions-editor{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .goals-list,
    .question-list{
      list-style:none;
      padding:0;
      margin:4px 0 0;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.8rem;
    }

    .question-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      flex-direction:column;
      gap:4px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    /* St√∂d f√∂r "list-item" (anv√§nds i SEKTION 3 f√∂r listor) */
    .list-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    .list-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1 1 auto;
    }

    .q-meta{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.35;
    }

    .question-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:2px;
    }

    .img-preview-box{
      border-radius:10px;
      border:1px dashed rgba(55,65,81,1);
      padding:6px;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .img-preview-box img{
      max-width:100%;
      border-radius:8px;
    }

    .img-thumb{
      width:64px;
      height:44px;
      border-radius:8px;
      border:1px solid rgba(31,41,55,1);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#020617;
      margin-right:6px;
    }

    .img-thumb img{
      max-width:100%;
      max-height:100%;
      object-fit:cover;
    }

    .question-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .chip{
      border-radius:999px;
      padding:3px 8px;
      font-size:.75rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 6px 14px rgba(15,23,42,.85);
    }

    /* Elevprogression ‚Äì rutorna staplas p√• h√∂jden (en kolumn) */
    .progress-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }

    .progress-box{
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 24px rgba(15,23,42,.9);
      font-size:.8rem;
    }

    .mini-card{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      padding:6px 7px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .mini-title{
      font-size:.82rem;
      font-weight:600;
    }

    /* ---------- GDPR: Modal f√∂r elevlista/tokens (endast id-bundet) ---------- */

    #bankRosterModal,
    #rosterViewerModal{
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(15,23,42,.78);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      backdrop-filter:blur(10px);
    }

    #bankRosterModal.hidden,
    #rosterViewerModal.hidden{
      display:none !important;
    }

    #bankRosterModal .card,
    #rosterViewerModal .card{
      width:min(980px,100%);
      max-height:88vh;
      overflow:auto;
      padding:12px 12px 14px;
      border-radius:18px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
    }

    #bankRosterModal .card h3,
    #rosterViewerModal .card h3{
      margin:0;
      font-size:.95rem;
      letter-spacing:.01em;
    }

    #bankRosterModal .input,
    #bankRosterModal .textarea,
    #rosterViewerModal .input,
    #rosterViewerModal .textarea{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      color:var(--text);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1);
    }

    #bankRosterModal .textarea,
    #rosterViewerModal .textarea{
      width:100%;
      padding:8px 10px;
      min-height:90px;
      resize:vertical;
      font-size:.8rem;
      outline:none;
    }

    #bankRosterModal .textarea:focus,
    #rosterViewerModal .textarea:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
    }

    /* Roster-lista: b√§ttre radlayout p√• sm√• sk√§rmar */
    #bankRosterModal #rosterRows .card-row{
      align-items:center;
      padding:6px 0;
      border-top:1px solid rgba(31,41,55,.7);
    }

    #bankRosterModal #rosterRows .card-row:first-child{
      border-top:none;
    }

    #bankRosterModal #rosterRows .btn.btn-danger{
      border-radius:12px;
    }

    @media (max-width:640px){
      #bankRosterModal .card,
      #rosterViewerModal .card{
        max-height:92vh;
        padding:10px;
      }
      #bankRosterModal #rosterRows .card-row > *{
        flex:1 1 100% !important;
      }
      #bankRosterModal #rosterRows .card-row div[style*="flex:0 0 160px"]{
        flex:1 1 100% !important;
        justify-content:flex-start !important;
      }
    }

    /* ---------- Responsivitet ---------- */

    @media (max-width:640px){
      .app{
        padding:8px 8px 24px;
      }
      .app-header{
        padding:8px 9px;
      }
      .levels-grid{
        grid-template-columns:1fr;
      }
      .play-header,
      .result-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .play-footer{
        flex-direction:column;
        align-items:flex-start;
      }
      .modal{
        padding:10px;
      }
    }

    /* ---------- F√§rger f√∂r niv√•kort (E / C / A) ---------- */

    #card-levelE{
      background:radial-gradient(circle at top,#ea580c,#b45309 55%,#020617 100%);
      border-color:rgba(234,88,12,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(234,88,12,.9);
    }

    #card-levelC{
      background:radial-gradient(circle at top,#1d4ed8,#1e40af 55%,#020617 100%);
      border-color:rgba(37,99,235,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(37,99,235,.9);
    }

    #card-levelA{
      background:radial-gradient(circle at top,#7c3aed,#6d28d9 55%,#020617 100%);
      border-color:rgba(124,58,237,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(124,58,237,.9);
    }
  </style>

  <!-- Firebase CDN (v8 - namespaced) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

</head>
<!-- slut SEKTION 1: HEAD & STIL -->










<!-- start SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->
<!-- √ÑNDRING: Lade till ett stabilt host-element med id="rosterTabs" i Elevprogression (Elever aktiv bank) s√• SEKTION 3 alltid kan rendera elevknappar d√§r. (ca 18 rader) -->
<body>
  <!-- start Sektion 2A: APP & HEADER -->
  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <h1><span class="logo">F</span>F√•ngvaktaren</h1>
      </div>
      <button id="btnTeacherMode" class="btn btn-sm btn-primary" type="button">üîë L√§rarl√§ge</button>
    </header>
  <!-- slut Sektion 2A: APP & HEADER -->

    <!-- start Sektion 2B: ELEVKORT -->
    <section id="studentCard" class="student-card">
      <div class="row student-main-row">
        <div class="field">
          <label for="studentName">Namn</label>
          <input id="studentName" class="input" placeholder="Elevens namn..." autocomplete="off" />
        </div>
        <div class="field">
          <label for="studentClass">Klass</label>
          <input id="studentClass" class="input" placeholder="Klass..." autocomplete="off" />
        </div>
        <div class="field student-save-field">
          <label>&nbsp;</label>
          <button id="btnSaveStudent" class="btn btn-sm btn-primary" type="button" style="width:100%;">üíæ Spara elev</button>
        </div>
      </div>

      <div class="student-status-row">
        <span id="studentSaved" class="student-saved-label">Ej sparad elev</span>
      </div>

      <div class="student-stats-row">
        <div class="score-box glow-box">
          <div class="score-label">Po√§ng</div>
          <div class="score-value" id="studentPointsValue">0 p</div>
        </div>
        <div class="score-box glow-box">
          <div class="score-label">Highscore</div>
          <div class="score-value" id="highscoreSummary">
            Ingen highscore √§nnu.
          </div>
        </div>
      </div>
    </section>
    <!-- slut Sektion 2B: ELEVKORT -->

    <!-- start Sektion 2C: NIV√ÖKORT -->
    <section class="levels-grid">
      <article id="card-levelE" class="level-card level-e locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 1</span>
            <small>Grundniv√• ‚Äì E</small>
          </div>
          <span id="badge-levelE" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelE">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelE">70</span>%</span>
          <span class="mini">L√•ses upp n√§r eleven sparat namn & klass.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• E-niv√•.</div>
          <button id="start-levelE" class="btn btn-sm" type="button" disabled>‚ñ∂Ô∏è Starta niv√• 1</button>
        </div>
      </article>

      <article id="card-levelC" class="level-card level-c locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 2</span>
            <small>Mellanniv√• ‚Äì C</small>
          </div>
          <span id="badge-levelC" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelC">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelC">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 1 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• C-niv√•.</div>
          <button id="start-levelC" class="btn btn-sm" type="button" disabled>‚ñ∂Ô∏è Starta niv√• 2</button>
        </div>
      </article>

      <article id="card-levelA" class="level-card level-a locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 3</span>
            <small>Avancerad ‚Äì A</small>
          </div>
          <span id="badge-levelA" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelA">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelA">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 2 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• A-niv√•.</div>
          <button id="start-levelA" class="btn btn-sm" type="button" disabled>‚ñ∂Ô∏è Starta niv√• 3</button>
        </div>
      </article>
    </section>
    <!-- slut Sektion 2C: NIV√ÖKORT -->

    <!-- start Sektion 2D: SPELPANEL -->
    <section id="play" class="play-panel hidden">
      <header class="play-header">
        <div>
          <h2 id="play-title">Aktiv niv√•</h2>
          <small id="whoPlays">Ingen elev vald.</small>
        </div>
        <button id="btnCancel" class="btn btn-sm" type="button">‚¨ÖÔ∏è Avsluta utan att l√§mna in</button>
      </header>
      <div id="questions" class="questions">
        <div class="question mini">V√§lj en niv√• f√∂r att b√∂rja.</div>
      </div>
      <footer class="play-footer">
        <div class="mini">
          Svar registreras n√§r du klickar i alternativen eller sl√§pper kort i r√§tt ruta.
        </div>
        <div class="play-actions">
          <button id="btnSpeakQuestion" class="btn btn-sm" type="button">üîä L√§s upp fr√•gan</button>
          <button id="btnFinish" class="btn btn-sm btn-primary" type="button">‚úÖ L√§mna in niv√•</button>
        </div>
      </footer>
    </section>
    <!-- slut Sektion 2D: SPELPANEL -->

    <!-- start Sektion 2E: RESULTATPANEL -->
    <section id="result" class="result-panel hidden">
      <header class="result-header">
        <div>
          <div class="score" id="scoreText">0%<span> resultat</span></div>
          <div id="scoreDetail" class="result-meta">0/0 po√§ng</div>
          <div class="result-meta">
            Elev: <span id="resName">-</span> (<span id="resClass">-</span>)
          </div>
        </div>
        <div>
          <div id="passBadge" class="badge-fail">Resultat</div>
          <div id="unlockText" class="result-meta"></div>
        </div>
      </header>

      <div class="result-actions" id="resultActionsNormal">
        <button id="btnBack" class="btn btn-sm" type="button">‚¨ÖÔ∏è Tillbaka till niv√•er</button>
        <button id="btnSubmitGame" class="btn btn-sm btn-primary" type="button">‚úâÔ∏è L√§mna in spel f√∂r po√§ng</button>
      </div>
    </section>
    <!-- slut Sektion 2E: RESULTATPANEL -->
  </div>

  <!-- start Sektion 2F: EMBEDDED GRUNDBANK -->
  <script id="embedded-data" type="application/json">
  {
    "bank": {
      "mcq": [
        {
          "level": "E",
          "type": "mcq",
          "q": "Vad √§r viktigast f√∂rst n√§r du kommer till k√∂ket?",
          "options": ["Ta p√• f√∂rkl√§de", "Tv√§tta h√§nderna", "S√§tta p√• ugnen", "Smaka p√• maten"],
          "answer": 1
        },
        {
          "level": "C",
          "type": "mcq",
          "q": "En g√§st klagar p√• kall mat. Vad √§r ett bra f√∂rsta steg?",
          "options": ["Ignorera g√§sten", "Skylla p√• k√∂ket", "Be om urs√§kt och erbjuda l√∂sning", "S√§ga att det inte √§r ditt fel"],
          "answer": 2
        },
        {
          "level": "A",
          "type": "mcq",
          "q": "Du planerar en buff√©. Vad √§r viktigast f√∂r s√§ker livsmedelshantering?",
          "options": ["Att det ser fint ut", "Att alla r√§tter √§r varma samtidigt", "R√§tt temperaturer och tidsgr√§nser", "Att det finns m√•nga olika r√§tter"],
          "answer": 2
        }
      ]
    }
  }
  </script>
  <!-- slut Sektion 2F: EMBEDDED GRUNDBANK -->

  <!-- start Sektion 2G: L√ÑRARL√ÑGE ‚Äì GATE -->
  <div id="teacherGate" class="gate-backdrop hidden">
    <div class="gate-box">
      <h2>üîë L√§rarl√§ge</h2>
      <p id="teacherGateText">
        Ange l√§rarl√∂senord. F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.
      </p>
      <input id="teacherPasswordInput" class="input" type="password" placeholder="L√∂senord..." />
      <div class="gate-actions">
        <button id="btnTeacherCancel" class="btn btn-sm" type="button">Avbryt</button>
        <button id="btnTeacherConfirm" class="btn btn-sm btn-primary" type="button">Forts√§tt</button>
      </div>
    </div>
  </div>
  <!-- slut Sektion 2G: L√ÑRARL√ÑGE ‚Äì GATE -->

  <!-- start Sektion 2H: L√ÑRARL√ÑGE ‚Äì MODAL -->
  <div id="teacherModal" class="modal-backdrop hidden">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h2>L√§rarl√§ge ‚Äì F√•ngvaktaren</h2>
          <small>Hantera inst√§llningar, fr√•gebank, bildfr√•gor, drag & drop, export och elevprogression.</small>
        </div>
        <button id="btnCloseTeacher" class="btn btn-sm" type="button">St√§ng</button>
      </header>

      <div class="modal-body">
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="settings" id="tab-settings" type="button">‚öôÔ∏è Inst√§llningar</button>
          <button class="tab-btn" data-tab="questions" id="tab-questions" type="button">üÖ∞Ô∏è Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="images" id="tab-images" type="button">üñºÔ∏è Bildfr√•gor</button>
          <button class="tab-btn" data-tab="dragdrop" id="tab-dragdrop" type="button">üéØ Drag & Drop</button>
          <button class="tab-btn" data-tab="progress" id="tab-progress" type="button">üìà Elevprogression</button>
          <button class="tab-btn" data-tab="bank" id="tab-bank" type="button">üóÇÔ∏è Fr√•gebank</button>
        </nav>

        <div class="tab-content">
          <section class="tab-panel" data-panel="settings">
            <div class="settings-grid">
              <div class="card">
                <h3>L√§rarl√∂senord</h3>
                <p>Det l√∂senord du anv√§nder f√∂r att √∂ppna l√§rarl√§get. H√§r kan du byta det.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputOldPassword">Nuvarande l√∂senord</label>
                    <input id="inputOldPassword" class="input" type="password" placeholder="L√§mna tomt om inget satt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPassword">Nytt l√∂senord</label>
                    <input id="inputNewPassword" class="input" type="password" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPasswordRepeat">Upprepa nytt l√∂senord</label>
                    <input id="inputNewPasswordRepeat" class="input" type="password" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnChangeTeacherPassword" class="btn btn-sm" type="button">üîê Spara nytt l√∂senord</button>
                </div>
                <p id="passwordStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Google-inloggning & uppladdning (l√§rare)</h3>
                <p>
                  Logga in med ditt Google-konto f√∂r att spara och ladda fr√•gebanker via Firebase.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label">Status</label>
                    <p id="googleStatus" class="mini">‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.</p>
                  </div>
                  <div class="field">
                    <button id="btnGooglePlaceholder" class="btn btn-sm" type="button">
                      üîó Logga in med Google
                    </button>
                  </div>
                  <div class="field">
                    <button id="btnGoogleLogout" class="btn btn-sm hidden" type="button">
                      üö™ Logga ut fr√•n Google
                    </button>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Gr√§ns f√∂r godk√§nt per niv√•</h3>
                <p>Justera procentgr√§ns f√∂r E, C och A. Anv√§nds som riktm√§rke f√∂r ‚ÄùGodk√§nd niv√•‚Äù.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputThresE">Niv√• 1 (E)</label>
                    <input id="inputThresE" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresC">Niv√• 2 (C)</label>
                    <input id="inputThresC" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresA">Niv√• 3 (A)</label>
                    <input id="inputThresA" type="number" min="0" max="100" class="input-number" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveThresholds" class="btn btn-sm btn-primary" type="button">üíæ Spara niv√•-gr√§nser</button>
                </div>
              </div>

              <div class="card">
                <h3>L√§rarens e-post</h3>
                <p>
                  Anv√§nds som mottagare n√§r eleven l√§mnar in resultat via e-post
                  (‚ÄùSkapa e-post‚Äù p√• Elevresultat/JSON).
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputTeacherEmail">E-postadress</label>
                    <input id="inputTeacherEmail" class="input" placeholder="namn@skola.se" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveTeacherEmail" class="btn btn-sm" type="button">üíæ Spara e-postadress</button>
                </div>
                <p id="teacherEmailStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Elevdata p√• denna enhet</h3>
                <p class="mini">
                  Dessa knappar p√•verkar bara den h√§r datorn/surfplattan. Anv√§nd dem n√§r du vill nollst√§lla progression lokalt.
                </p>
                <div class="card-row" style="margin-top:6px;gap:8px;flex-wrap:wrap;">
                  <button id="btnClearStudentData" class="btn btn-sm btn-danger" type="button">
                    üßπ Rensa elev + progression
                  </button>
                  <button id="btnResetGameData" class="btn btn-sm" type="button">
                    ‚ôªÔ∏è Nollst√§ll spelpo√§ng
                  </button>
                </div>
                <p id="resetStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Koppling: delm√•l & delbitar</h3>
                <p>
                  Skriv ett delm√•l och en delbit i taget. Klicka p√• ‚ÄùL√§gg till delbit‚Äù
                  f√∂r att l√§gga till i listan. ‚ÄùSpara‚Äù skriver listan till spelets minne
                  (localStorage). ‚ÄùTa bort alla‚Äù rensar listan.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputGoalSingle">Delm√•l</label>
                    <input id="inputGoalSingle" class="input" placeholder="t.ex. Delm√•l 5 ‚Äì Hygien i k√∂ket" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputPartSingle">Delbit</label>
                    <input id="inputPartSingle" class="input" placeholder="t.ex. 51‚Äì60 eller 51,52,53" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnAddGoalPart" class="btn btn-sm" type="button">‚ûï L√§gg till delbit</button>
                </div>
                <p id="goalsStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card card-full-width">
                <h3>Aktuella delm√•l och delbitar</h3>
                <p class="mini">Nedan visas de delm√•l och delbitar som √§r sparade i spelet just nu.</p>
                <ul id="goalsList" class="goals-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="questions">
            <div class="questions-editor">
              <h3>Hantera flervalsfr√•gor (MCQ)</h3>
              <p class="mini">
                L√§gg till nya flervalsfr√•gor, redigera eller importera m√•nga p√• en g√•ng.
              </p>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Snabbimport av flervalsfr√•gor</h3>
                <p class="mini">
                  Klistra in fr√•gor i formatet nedan. En asterisk (*) framf√∂r r√§tt svar.
                  En tom rad mellan fr√•gorna √§r bra men inte ett krav.
                </p>
                <pre class="mini" style="background:#020617;border-radius:6px;padding:8px;margin-top:4px;white-space:pre-wrap;">
Vilken av dessa √§r en proteink√§lla?
*Kycklingfil√©
√Ñpple
Gurka
P√§ron

Vilken av dessa √§r en frukt?
√Ñpple
*P√§ron
Potatis
Gurka
                </pre>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqJsonLevel">Niv√•</label>
                    <select id="mcqJsonLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqJsonGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqJsonGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <textarea
                  id="mcqJsonInput"
                  class="input"
                  rows="8"
                  placeholder="Klistra in dina fr√•gor h√§r..."
                  style="margin-top:8px;font-family:monospace;border-radius:6px;"
                ></textarea>
                <div style="margin-top:8px;display:flex;justify-content:flex-end;">
                  <button id="btnMcqJsonImport" class="btn btn-sm btn-primary" type="button">
                    üì• Importera fr√•gor fr√•n text
                  </button>
                </div>
              </div>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqLevel">Niv√•</label>
                    <select id="mcqLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqQuestion">Fr√•getext</label>
                    <input id="mcqQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="0" id="mcqCorrect0" style="margin-right:4px;" />
                      Alternativ 1
                    </label>
                    <input id="mcqOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="1" id="mcqCorrect1" style="margin-right:4px;" />
                      Alternativ 2
                    </label>
                    <input id="mcqOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="2" id="mcqCorrect2" style="margin-right:4px;" />
                      Alternativ 3
                    </label>
                    <input id="mcqOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="3" id="mcqCorrect3" style="margin-right:4px;" />
                      Alternativ 4
                    </label>
                    <input id="mcqOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="mcqAnswer">Korrekt svar (Index)</label>
                    <input id="mcqAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnMcqAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till fr√•ga</button>
                    <button id="btnMcqUpdate" class="btn btn-sm hidden" type="button">üíæ Spara √§ndring</button>
                  </div>
                  <button id="btnMcqClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella flervalsfr√•gor (<span id="mcqCount">0</span> st)</h3>
                <ul id="mcqList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="images">
            <div class="questions-editor">
              <h3>Hantera bildfr√•gor (IMG)</h3>
              <p class="mini">L√§gg till fr√•gor d√§r en bild visas tillsammans med flervalsalternativ.</p>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera bildfr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgLevel">Niv√•</label>
                    <select id="imgLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgQuestion">Fr√•getext</label>
                    <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgFile">Bildfil</label>
                    <input id="imgFile" type="file" accept="image/*" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">F√∂rhandsvisning</label>
                    <div id="imgPreview" class="img-preview-box mini">Ingen bild vald √§nnu.</div>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="0" id="imgCorrect0" style="margin-right:4px;" />
                      Alternativ 1
                    </label>
                    <input id="imgOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="1" id="imgCorrect1" style="margin-right:4px;" />
                      Alternativ 2
                    </label>
                    <input id="imgOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="2" id="imgCorrect2" style="margin-right:4px;" />
                      Alternativ 3
                    </label>
                    <input id="imgOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="3" id="imgCorrect3" style="margin-right:4px;" />
                      Alternativ 4
                    </label>
                    <input id="imgOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="imgAnswer">Korrekt svar (Index)</label>
                    <input id="imgAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="imgGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnImgAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till bildfr√•ga</button>
                  </div>
                  <button id="btnImgClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
                <ul id="imgList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="dragdrop">
            <div class="questions-editor">
              <h3>Hantera Drag &amp; Drop-fr√•gor</h3>
              <p class="mini">Skapa korta fr√•gor d√§r eleverna drar ord/begrepp till r√§tt kolumn.</p>

              <div class="card" style="margin-top:10px;max-width:720px;margin-left:auto;margin-right:auto;padding:10px;">
                <h4>Bygg fr√•ga (kompakt)</h4>
                <div class="card-row" style="margin-top:6px;">
                  <div class="field" style="flex:0 0 90px;">
                    <label class="small-label" for="dragLevel">Niv√•</label>
                    <select id="dragLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragQuestion">Instruktion</label>
                    <input id="dragQuestion" class="input" placeholder="Ex: Dra r√§tt livsmedel till 'Kylvara'." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragColumn1">Kolumn 1</label>
                    <input id="dragColumn1" class="input" placeholder="t.ex. Kylvara" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragColumn2">Kolumn 2</label>
                    <input id="dragColumn2" class="input" placeholder="t.ex. Torrvara" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragItemText">Objekt att dra</label>
                    <input id="dragItemText" class="input" placeholder="t.ex. 'R√• kyckling'" />
                  </div>
                  <div class="field" style="flex:0 0 140px;">
                    <label class="small-label" for="dragItemCorrect">Korrekt kolumn</label>
                    <select id="dragItemCorrect" class="input">
                      <option value="0">Kolumn 1</option>
                      <option value="1">Kolumn 2</option>
                    </select>
                  </div>
                  <div class="field" style="flex:0 0 110px;">
                    <label class="small-label">&nbsp;</label>
                    <button id="btnDragAddItem" class="btn btn-sm btn-primary" type="button" style="width:100%;">‚ûï L√§gg till</button>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label">Objekt i denna fr√•ga</label>
                    <ul id="dragItemsPreview" class="question-list"></ul>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="dragGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;justify-content:space-between;">
                  <div>
                    <button id="btnDragAddQuestion" class="btn btn-sm btn-primary" type="button">üíæ Spara fr√•ga</button>
                  </div>
                  <button id="btnDragClearForm" class="btn btn-sm btn-secondary" type="button">
                    Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:10px;">
                <h3>Aktuella Drag &amp; Drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
                <ul id="dragList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="progress">
            <div class="card">
              <h3>Elevprogression</h3>
              <p class="mini">
                H√§r kan du sammanfatta vad eleven √§r stark p√•, vad som beh√∂ver √∂vas och exportera en JSON-text till elevkortet.
              </p>

              <div class="progress-grid">
                <div class="progress-box" id="progressPointsBox">
                  <h4>Elevens po√§ng (lokalt)</h4>
                  <p id="progressPointsText" class="mini">
                    Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.
                  </p>

                  <div style="margin-top:10px;">
                    <h4>Elever (aktiv bank)</h4>

                    <div id="playedStudentsTabs" class="tab-nav" style="margin-top:6px;">
                      <ul id="rosterTabs" class="mini tab-nav" style="margin:0;padding:0;list-style:none;">
                        <li class="mini">Ingen elev inl√§st √§nnu.</li>
                      </ul>
                    </div>

                    <ul id="playedStudentsList" class="goals-list mini hidden">
                      <li>Ingen elev inl√§st √§nnu.</li>
                    </ul>
                  </div>
                </div>

                <div class="progress-box" id="progressStrongBox">
                  <h4>Starka delbitar</h4>
                  <ul id="progressStrongList" class="goals-list mini">
                    <li>Inga starka delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressWeakBox">
                  <h4>Delbitar att √∂va p√•</h4>
                  <ul id="progressWeakList" class="goals-list mini">
                    <li>Inga svaga delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressExportBox">
                  <h4>Export till elevkort (JSON)</h4>
                  <p class="mini">
                    N√§r du √§r n√∂jd med en elevs progression kan du skapa en JSON-str√§ng som klistras in i elevkortet.
                  </p>
                  <textarea
                    id="progressExportJson"
                    class="input"
                    rows="4"
                    readonly
                    style="font-family:monospace;font-size:0.8rem;border-radius:6px;"
                  ></textarea>
                  <div style="margin-top:6px;display:flex;gap:8px;justify-content:flex-end;">
                    <button id="btnGenerateProgressJson" class="btn btn-sm" type="button">üîÅ Skapa JSON</button>
                    <button id="btnCopyProgressJson" class="btn btn-sm btn-primary" type="button">üìã Kopiera kod</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="bank">
            <div class="settings-grid">
              <div class="card">
                <h3>Ladda fr√•gebank fr√•n molnet (Firebase)</h3>
                <p class="mini">
                  Visar bankar som har sparats p√• ditt Google-konto. Aktivera bankarna nedan f√∂r att l√§gga till fr√•gorna i spelet.
                </p>
                <p id="cloudBankStatus" class="mini" style="margin-top:4px;"></p>
                <ul id="cloudBankList" class="goals-list" style="margin-top:10px;"></ul>
                <div style="margin-top:10px;">
                  <button id="btnLoadCloudBanks" class="btn btn-sm" type="button">‚òÅÔ∏è Ladda moln-bankar</button>
                </div>
              </div>

              <div class="card">
                <h3>Spara aktuell fr√•gebank till molnet</h3>
                <p class="mini">
                  Namnge din fr√•gebank. Sparar *alla* fr√•gor du skapat i flervals-, bild- och drag/drop-flikarna.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="inputBankName">Namn p√• fr√•gebank</label>
                    <input id="inputBankName" class="input" placeholder="T.ex. Livsmedel HT25" />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <button id="btnSaveToCloud" class="btn btn-sm btn-primary" type="button">üíæ Spara bank till molnet</button>
                </div>
              </div>

              <div class="card card-full-width">
                <h3>Export / Import av fr√•gebank (JSON)</h3>
                <p class="mini">
                  Exportera hela din nuvarande fr√•gebank som en JSON-fil (s√§kerhetskopia) eller importera en befintlig bank fr√•n fil.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <button id="btnExportBank" class="btn btn-sm" type="button">‚¨áÔ∏è Exportera till JSON</button>
                  <label class="btn btn-sm" for="fileImport">‚¨ÜÔ∏è Importera fr√•n JSON</label>
                  <input type="file" id="fileImport" accept=".json" style="display:none;" />
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
  <!-- slut Sektion 2H: L√ÑRARL√ÑGE ‚Äì MODAL -->

  <!-- start Sektion 2I: ROSTER-MODAL -->
  <div id="bankRosterModal" class="hidden">
    <div class="card">
      <div class="card-row" style="justify-content:space-between;align-items:center;">
        <div class="field" style="flex:1 1 auto;">
          <h3>Elever (aktiv bank)</h3>
          <p class="mini" style="margin:4px 0 0;">
            L√§gg in elevens namn och e-post. Klicka ‚úâÔ∏è f√∂r att skapa mejl med spell√§nk. Knappen blir gr√∂n efter mejl.
          </p>
        </div>
        <div class="field" style="flex:0 0 140px;display:flex;justify-content:flex-end;">
          <button id="btnCloseRosterModal" class="btn btn-sm" type="button">St√§ng</button>
        </div>
      </div>

      <div class="card-row" style="margin-top:8px;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
        <button id="btnRosterAddRow" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till elevrad</button>
        <button id="btnRosterSave" class="btn btn-sm" type="button">üíæ Spara elevlista</button>
      </div>

      <div id="rosterRows" style="margin-top:10px;"></div>
    </div>
  </div>
  <!-- slut Sektion 2I: ROSTER-MODAL -->
</body>
<!-- slut SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->





<!-- start SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker, roster, progression, editor-refresh) -->
<script>
"use strict";

/* start Sektion 3A: K√ÑRNA (state + helpers) */

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
  authDomain: "fangvaktaren-904db.firebaseapp.com",
  projectId: "fangvaktaren-904db",
  storageBucket: "fangvaktaren-904db.firebasestorage.app",
  messagingSenderId: "105301219768",
  appId: "1:105301219768:web:66b131fba86a541b78174d",
  measurementId: "G-NXL9GSFZ77"
};

const STORAGE_KEY = "fangvaktaren-v17";
const CLOUD_ROOT_COLLECTION = "teachers";
const CLOUD_BANKS_SUBCOLLECTION = "banks";
const PUBLIC_BANKS_COLLECTION = "public_banks";
const TEACHER_LOCAL_ROSTER_KEY = STORAGE_KEY + "::teacherRosterByBankId_v1";

function _fv_sel(q){ return document.querySelector(q); }
function _fv_selAll(q){ return document.querySelectorAll(q); }
function _fv_getEl(id){ return document.getElementById(id); }

function _fv_escapeHtml(str){
  if (!str && str !== 0) return "";
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function _fv_deepClone(obj){
  try{ return JSON.parse(JSON.stringify(obj)); }catch{ return {}; }
}

function _fv_ensureBankShape(bank){
  const b = Object.assign({ mcq: [], img: [], drag: [] }, bank || {});
  if (!Array.isArray(b.mcq)) b.mcq = [];
  if (!Array.isArray(b.img)) b.img = [];
  if (!Array.isArray(b.drag)) b.drag = [];
  return b;
}

const _fv_defaultState = {
  student: { name: "", klass: "", token: "" },
  teacherEmail: "",
  teacherPassword: "",
  goalsMap: [],
  bank: { mcq: [], img: [], drag: [] },
  activeBank: { mode: "", ownerUid: "", bankId: "", publicId: "", name: "" },
  best: { E: 0, C: 0, A: 0 },
  thres: { E: 70, C: 70, A: 70 },
  lastSubmission: null,
  progression: { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {} },
  meta: { embeddedMerged: false }
};

function _fv_normalizeState(s){
  s = s && typeof s === "object" ? s : _fv_deepClone(_fv_defaultState);

  s.student = Object.assign({ name:"", klass:"", token:"" }, s.student || {});
  s.teacherEmail = String(s.teacherEmail || "");
  s.teacherPassword = String(s.teacherPassword || "");

  s.goalsMap = Array.isArray(s.goalsMap) ? s.goalsMap : [];
  s.bank = _fv_ensureBankShape(s.bank);

  s.activeBank = Object.assign({ mode:"", ownerUid:"", bankId:"", publicId:"", name:"" }, s.activeBank || {});
  s.best = Object.assign({ E:0, C:0, A:0 }, s.best || {});
  s.thres = Object.assign({ E:70, C:70, A:70 }, s.thres || {});

  s.lastSubmission = s.lastSubmission || null;

  s.progression = (s.progression && typeof s.progression === "object")
    ? s.progression
    : { totalPoints:0, wrongByGoalId:{}, correctByGoalId:{} };

  s.progression.totalPoints = Number(s.progression.totalPoints || 0) || 0;
  s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
  s.progression.correctByGoalId = s.progression.correctByGoalId || {};

  s.meta = (s.meta && typeof s.meta === "object") ? s.meta : { embeddedMerged:false };
  if (typeof s.meta.embeddedMerged !== "boolean") s.meta.embeddedMerged = false;

  return s;
}

function _fv_hasAnyLocalBank(s){
  try{
    const b = s && s.bank ? s.bank : null;
    return !!(b && (
      (Array.isArray(b.mcq) && b.mcq.length) ||
      (Array.isArray(b.img) && b.img.length) ||
      (Array.isArray(b.drag) && b.drag.length)
    ));
  }catch{ return false; }
}

function _fv_mergeEmbeddedBank(state){
  const el = _fv_getEl("embedded-data");
  if (!el) return state;
  try{
    const raw = el.textContent || el.innerHTML || "{}";
    const data = JSON.parse(raw);

    if (data && data.bank){
      state.bank = _fv_ensureBankShape(state.bank);
      const eb = _fv_ensureBankShape(data.bank);
      state.bank.mcq = (state.bank.mcq || []).concat(eb.mcq || []);
      state.bank.img = (state.bank.img || []).concat(eb.img || []);
      state.bank.drag = (state.bank.drag || []).concat(eb.drag || []);
    }
    if (data && Array.isArray(data.goalsMap)){
      state.goalsMap = data.goalsMap.slice();
    }
  }catch(e){
    console.warn("Kunde inte l√§sa embedded-data:", e);
  }
  return state;
}

function loadState(){
  let s = null;
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) s = JSON.parse(raw);
  }catch(e){
    console.warn("Kunde inte l√§sa state:", e);
  }

  s = _fv_normalizeState(s);

  try{
    if (s.meta.embeddedMerged !== true && !_fv_hasAnyLocalBank(s)){
      s = _fv_mergeEmbeddedBank(s);
      s.meta = s.meta && typeof s.meta === "object" ? s.meta : {};
      s.meta.embeddedMerged = true;
      saveState(s);
    }else if (s.meta.embeddedMerged !== true && _fv_hasAnyLocalBank(s)){
      s.meta.embeddedMerged = true;
      saveState(s);
    }
  }catch{}

  return _fv_normalizeState(s);
}

function saveState(state){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(_fv_normalizeState(state))); }
  catch(e){ console.warn("Kunde inte spara state:", e); }
}

function setActiveBankMeta(meta){
  const s = loadState();
  s.activeBank = Object.assign({ mode:"", ownerUid:"", bankId:"", publicId:"", name:"" }, s.activeBank || {}, meta || {});
  saveState(s);
  try{ window.activeCloudBankId = String(s.activeBank.bankId || ""); }catch{}
}

/* slut Sektion 3A: K√ÑRNA (state + helpers) */


/* start Sektion 3B: FIREBASE (init + auth) */

let firebaseAppInstance = null;
let firebaseAuthInstance = null;
let firebaseDbInstance = null;
let currentTeacherUser = null;

(function FV_FirebaseReadyBootstrap(){
  if (!window.__fvFirebaseReadyPromise){
    window.__fvFirebaseReadyPromise = new Promise((resolve)=>{ window.__fvFirebaseReadyResolve = resolve; });
  }
})();

async function initFirebase(){
  if (window.__fvFirebaseInitPromise) return window.__fvFirebaseInitPromise;

  window.__fvFirebaseInitPromise = (async ()=>{
    try{
      if (!window.firebase){
        console.warn("Firebase-bibliotek saknas.");
        try{ if (window.__fvFirebaseReadyResolve) window.__fvFirebaseReadyResolve(false); }catch{}
        return false;
      }

      if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);

      firebaseAppInstance = firebase.app();
      firebaseAuthInstance = firebase.auth();
      firebaseDbInstance = firebase.firestore();

      try{
        window.firebaseAppInstance = firebaseAppInstance;
        window.firebaseAuthInstance = firebaseAuthInstance;
        window.firebaseDbInstance = firebaseDbInstance;
      }catch{}

      if (firebaseAuthInstance && !firebaseAuthInstance.__fvBound){
        firebaseAuthInstance.__fvBound = true;
        firebaseAuthInstance.onAuthStateChanged((user)=>{
          currentTeacherUser = user || null;
          try{ window.currentTeacherUser = currentTeacherUser; }catch{}

          const statusEl = _fv_getEl("googleStatus");
          const btnLogout = _fv_getEl("btnGoogleLogout");
          if (statusEl){
            if (user){
              statusEl.textContent = `‚òÅÔ∏è Inloggad som ${user.email || "l√§rare"} ‚Äì moln-banker aktiverade.`;
              if (btnLogout) btnLogout.classList.remove("hidden");
            }else{
              statusEl.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka p√• Google f√∂r att logga in.";
              if (btnLogout) btnLogout.classList.add("hidden");
            }
          }
        });
      }

      if (!window.__fv_firebase_inited_log){
        window.__fv_firebase_inited_log = true;
        console.log("Firebase init OK");
      }

      try{
        if (window.__fvFirebaseReadyResolve) window.__fvFirebaseReadyResolve(true);
        window.dispatchEvent(new CustomEvent("fv-firebase-ready"));
      }catch{}

      return true;
    }catch(e){
      console.error("Fel vid initFirebase:", e);
      try{ if (window.__fvFirebaseReadyResolve) window.__fvFirebaseReadyResolve(false); }catch{}
      return false;
    }
  })();

  return window.__fvFirebaseInitPromise;
}

function _fv_hasDb(){ return !!firebaseDbInstance; }
function _fv_hasTeacher(){ return !!(currentTeacherUser && currentTeacherUser.uid); }

async function handleGoogleLogin(){
  const ok = await initFirebase();
  if (!ok || !firebaseAuthInstance){ alert("Tekniskt fel: Firebase Auth saknas."); return; }
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await firebaseAuthInstance.signInWithPopup(provider);
  }catch(err){
    console.error("Google-inloggning misslyckades:", err);
    const statusEl = _fv_getEl("googleStatus");
    if (statusEl) statusEl.textContent = "‚ö†Ô∏è Kunde inte logga in med Google. F√∂rs√∂k igen.";
  }
}

async function handleGoogleLogout(){
  try{ if (firebaseAuthInstance) await firebaseAuthInstance.signOut(); }
  catch(err){ console.error("Kunde inte logga ut:", err); }
}

/* slut Sektion 3B: FIREBASE (init + auth) */








/* start Sektion 3C: MOLN-BANKER (lista + aktivera + uppdatera aktiv + spara + delete) */

function _fv_fmtUpdatedAt(v){
  try{
    if (!v) return "-";
    const pad = (n)=> String(n).padStart(2,"0");
    if (typeof v === "string") return v;
    if (typeof v.toDate === "function"){
      const d = v.toDate();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    if (typeof v.seconds !== "undefined"){
      const d = new Date(Number(v.seconds)*1000);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
  }catch{}
  return "-";
}

function _fv_pickBankObj(data){
  try{
    if (!data) return _fv_ensureBankShape({});
    if (data.bank) return _fv_ensureBankShape(data.bank);
    if (data.questions) return _fv_ensureBankShape(data.questions);
    if (Array.isArray(data.mcq) || Array.isArray(data.img) || Array.isArray(data.drag)) return _fv_ensureBankShape(data);
  }catch{}
  return _fv_ensureBankShape({});
}

function _fv_getRosterTokensCount(data){
  try{
    const rt = data && data.rosterTokens;
    if (!Array.isArray(rt)) return 0;
    return rt.map(String).filter(t=>String(t||"").trim()).length;
  }catch{ return 0; }
}

function _fv_getCloudBankNameFromUI(){
  const ids = ["inputBankName","cloudBankName","bankName","bankNameInput","cloudBankTitle","txtCloudBankName"];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el && typeof el.value === "string" && el.value.trim()) return el.value.trim();
  }
  return "";
}

function _fv_getCloudListHost(){
  return (
    _fv_getEl("cloudBankList") ||
    _fv_getEl("cloudBanksListV5") ||
    _fv_getEl("cloudBanksListV4") ||
    _fv_getEl("cloudBanksList") ||
    _fv_getEl("cloudBanksListV3")
  );
}

function _fv_getCloudStatusEl(){
  return (
    _fv_getEl("cloudBankStatus") ||
    _fv_getEl("cloudBanksStatus") ||
    _fv_getEl("cloudBanksStatusV5") ||
    _fv_getEl("fv3-cloud-status")
  );
}

function _fv_setCloudStatus(msg){
  const el = _fv_getCloudStatusEl();
  if (!el) return;
  el.textContent = String(msg || "");
}

function _fv_ensureCloudStyles(){
  if (_fv_getEl("fv3-styles")) return;
  const st = document.createElement("style");
  st.id = "fv3-styles";
  st.textContent = `
    .cloud-bank-active{
      border-color:rgba(74,222,128,.95) !important;
      box-shadow: 0 0 0 1px rgba(22,163,74,1), 0 0 16px rgba(34,197,94,.55), 0 12px 28px rgba(15,23,42,.9) !important;
    }
    .cloud-bank-active .mini{ color:#bbf7d0 !important; }
    .fv3-actions{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .fv3-btn-xs{ padding:4px 8px; font-size:.74rem; border-radius:999px; }
  `;
  document.head.appendChild(st);
}

async function loadCloudBankToLocal(bankId){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Firebase ej redo eller ej inloggad");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId || "").trim();
  if (!bid) throw new Error("Saknar bankId");

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  const snap = await ref.get();
  if (!snap.exists) throw new Error("Bank finns inte: " + bid);

  const d = snap.data() || {};
  const bank = _fv_pickBankObj(d);
  const goalsMap = Array.isArray(d.goalsMap) ? d.goalsMap : [];

  const s = loadState();
  s.bank = _fv_ensureBankShape(bank);
  s.goalsMap = goalsMap;
  saveState(s);

  setActiveBankMeta({
    mode: "teacher",
    ownerUid: uid,
    bankId: bid,
    publicId: String(d.publicId || ""),
    name: String(d.name || d.title || d.bankName || "")
  });

  try{ window.activeCloudBankId = bid; }catch{}

  try{
    window.dispatchEvent(new CustomEvent("fv-bank-changed", { detail: { source:"cloud", bankId: bid } }));
  }catch{}

  try{ if (typeof window.fvRefreshTeacherBankUI === "function") window.fvRefreshTeacherBankUI(); }catch{}
}

async function updateActiveCloudBankFromLocalV5(bankId){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Firebase ej redo eller ej inloggad");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId || "").trim();
  if (!bid) throw new Error("Saknar bankId");

  const s = loadState();
  const activeId = String(s.activeBank && s.activeBank.bankId ? s.activeBank.bankId : (window.activeCloudBankId||""));
  if (!activeId || activeId !== bid) throw new Error("Banken √§r inte aktiv (aktivera den f√∂rst)");

  const desiredName = _fv_getCloudBankNameFromUI() || String(s.activeBank.name || "").trim() || "Moln-bank";

  const payload = {
    name: desiredName || "Moln-bank",
    bank: _fv_ensureBankShape(s.bank || {}),
    goalsMap: Array.isArray(s.goalsMap) ? s.goalsMap : [],
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  await ref.set(payload, { merge:true });

  setActiveBankMeta({
    mode: "teacher",
    ownerUid: uid,
    bankId: bid,
    publicId: String(s.activeBank.publicId || ""),
    name: payload.name
  });

  try{ window.activeCloudBankId = bid; }catch{}
}

async function loadCloudBanksListV5(){
  _fv_ensureCloudStyles();
  const host = _fv_getCloudListHost();
  if (!host) return;

  host.innerHTML = "";
  _fv_setCloudStatus("");

  await initFirebase();

  if (!_fv_hasDb()){
    _fv_setCloudStatus("‚ö†Ô∏è Firebase DB saknas.");
    return;
  }
  if (!_fv_hasTeacher()){
    _fv_setCloudStatus("‚òÅÔ∏è Logga in med Google f√∂r att se dina moln-banker.");
    return;
  }

  const uid = String(currentTeacherUser.uid);
  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION);

  let snap = null;
  try{ snap = await ref.orderBy("updatedAt","desc").get(); }
  catch{ snap = await ref.get(); }

  const docs = snap && snap.docs ? snap.docs : [];
  if (!docs.length){
    _fv_setCloudStatus("Inga moln-banker hittades.");
    return;
  }

  const s = loadState();
  const activeId = String(s.activeBank && s.activeBank.bankId ? s.activeBank.bankId : (window.activeCloudBankId||""));

  const seen = new Set();
  for (let i=0;i<docs.length;i++){
    const doc = docs[i];
    const bankId = String(doc.id);
    if (seen.has(bankId)) continue;
    seen.add(bankId);

    const data = doc.data() || {};
    const name = String(data.name || data.title || data.bankName || "Moln-bank");
    const publicId = String(data.publicId || "");
    const isPublic = !!publicId.trim();

    const bankObj = _fv_pickBankObj(data);
    const nMcq = (bankObj.mcq||[]).length;
    const nImg = (bankObj.img||[]).length;
    const nDrag = (bankObj.drag||[]).length;

    const upd = _fv_fmtUpdatedAt(data.updatedAt || data.updated || data.lastUpdatedAt);
    const studentsN = _fv_getRosterTokensCount(data);

    const isActive = (activeId && activeId === bankId);

    const li = document.createElement("li");
    li.className = "question-item" + (isActive ? " cloud-bank-active" : "");
    li.setAttribute("data-bank-id", bankId);

    li.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          ${_fv_escapeHtml(name)}
          ${isPublic ? ' <span class="mini">Public ‚úÖ</span>' : ""}
          <span class="mini"> ‚Ä¢ Uppd: ${_fv_escapeHtml(upd)}</span>
          ${isActive ? ' <span class="mini">‚úÖ Aktiv</span>' : ""}
        </div>
        <div class="mini">
          ID: ${_fv_escapeHtml(bankId)} ‚Ä¢ Fr√•gor: ${nMcq} MCQ, ${nImg} Bild, ${nDrag} Drag ‚Ä¢ Elever: ${studentsN}
        </div>
      </div>
      <div class="fv3-actions">
        <button class="btn fv3-btn-xs btn-primary" type="button" data-act="activate">Aktivera</button>
        <button class="btn fv3-btn-xs" type="button" data-act="update">‚úÖ Uppdatera aktiv bank</button>
        <button class="btn fv3-btn-xs" type="button" data-act="roster">Elever</button>
        <button class="btn fv3-btn-xs btn-danger" type="button" data-act="delete">Ta bort</button>
      </div>
    `;

    const btnUpdate = li.querySelector('[data-act="update"]');
    if (btnUpdate && !isActive){
      btnUpdate.setAttribute("disabled","disabled");
      btnUpdate.title = "Aktivera banken f√∂rst f√∂r att kunna uppdatera den.";
    }

    li.querySelector('[data-act="activate"]')?.addEventListener("click", async ()=>{
      try{
        await loadCloudBankToLocal(bankId);
        await loadCloudBanksListV5();

        // Viktigt: bygg flikar + starta live-uppdatering direkt utan att du beh√∂ver byta elev tv√• g√•nger
        try{ if (typeof window.tryRefreshRosterTabs === "function") await window.tryRefreshRosterTabs(true); }catch{}
        try{
          if (typeof window._fvTeacherForceLiveRefresh === "function") await window._fvTeacherForceLiveRefresh();
        }catch{}
        try{
          if (typeof window.fvToast === "function") window.fvToast("‚úÖ Bank aktiverad. Elevflikar/progression uppdateras.");
        }catch{}
      }catch(e){
        console.error("Kunde inte aktivera bank:", e);
        alert("Kunde inte aktivera bank. Se konsolen.");
      }
    });

    btnUpdate?.addEventListener("click", async ()=>{
      try{
        await updateActiveCloudBankFromLocalV5(bankId);
        await loadCloudBanksListV5();
        try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Aktiv bank uppdaterad i molnet."); }catch{}
        alert("‚úÖ Aktiv bank uppdaterad i molnet.");
      }catch(e){
        console.error("Kunde inte uppdatera aktiv bank:", e);
        alert("Kunde inte uppdatera aktiv bank. Se konsolen.");
      }
    });

    li.querySelector('[data-act="roster"]')?.addEventListener("click", ()=>{
      try{ if (typeof window.openRosterInline === "function") window.openRosterInline(bankId); }catch{}
    });

    li.querySelector('[data-act="delete"]')?.addEventListener("click", async ()=>{
      try{
        if (!confirm("Ta bort denna moln-bank? (Kan inte √•ngras)")) return;
        await deleteCloudBankV5(bankId);
        await loadCloudBanksListV5();
        try{ if (typeof window.fvToast === "function") window.fvToast("üóë Bank borttagen."); }catch{}
      }catch(e){
        console.error("Kunde inte ta bort bank:", e);
        alert("Kunde inte ta bort bank. Se konsolen.");
      }
    });

    host.appendChild(li);
  }

  _fv_setCloudStatus("");
}

async function handleSaveToCloudV5(){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()){
    alert("Logga in med Google f√∂rst.");
    return;
  }

  const uid = String(currentTeacherUser.uid);
  const banksRef = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION);

  const s = loadState();
  const desiredName = _fv_getCloudBankNameFromUI() || String(s.activeBank.name || "").trim();

  const hasActive = !!(s.activeBank && String(s.activeBank.bankId||"").trim());
  const activeName = String(s.activeBank && s.activeBank.name ? s.activeBank.name : "").trim();
  const shouldCreateNew = !!(desiredName && (!hasActive || desiredName !== activeName));

  const bankPayload = {
    name: desiredName || "Moln-bank",
    bank: _fv_ensureBankShape(s.bank || {}),
    goalsMap: Array.isArray(s.goalsMap) ? s.goalsMap : [],
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    if (shouldCreateNew){
      const newDoc = banksRef.doc();
      await newDoc.set(Object.assign({}, bankPayload, {
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }), { merge:true });

      setActiveBankMeta({ mode:"teacher", ownerUid: uid, bankId: newDoc.id, publicId:"", name: bankPayload.name });
      try{ window.activeCloudBankId = String(newDoc.id); }catch{}
      try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Ny bank skapad i molnet."); }catch{}
      alert("Ny bank skapad i molnet.");
    }else{
      const bankId = String(s.activeBank.bankId || window.activeCloudBankId || "").trim();
      if (!bankId){
        const newDoc = banksRef.doc();
        await newDoc.set(Object.assign({}, bankPayload, {
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }), { merge:true });
        setActiveBankMeta({ mode:"teacher", ownerUid: uid, bankId: newDoc.id, publicId:"", name: bankPayload.name });
        try{ window.activeCloudBankId = String(newDoc.id); }catch{}
        try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Ny bank skapad i molnet."); }catch{}
        alert("Ny bank skapad i molnet.");
      }else{
        await banksRef.doc(bankId).set(bankPayload, { merge:true });
        setActiveBankMeta({ mode:"teacher", ownerUid: uid, bankId, name: bankPayload.name });
        try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Bank uppdaterad i molnet."); }catch{}
        alert("Bank uppdaterad i molnet.");
      }
    }

    try{ await loadCloudBanksListV5(); }catch{}
  }catch(e){
    console.error("handleSaveToCloudV5 error:", e);
    alert("Kunde inte spara till molnet. Se konsolen.");
  }
}

async function deleteCloudBankV5(bankId){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Inte inloggad");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId||"").trim();
  if (!bid) throw new Error("Saknar bankId");

  const bankRef = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  try{
    const snap = await bankRef.get();
    const d = snap.exists ? (snap.data()||{}) : {};
    const publicId = String(d.publicId||"").trim();
    if (publicId){
      try{ await firebaseDbInstance.collection(PUBLIC_BANKS_COLLECTION).doc(publicId).delete(); }
      catch(e){ console.warn("Kunde inte ta bort public-banken (ok att ignorera):", e); }
    }
  }catch{}

  await bankRef.delete();

  try{
    const s = loadState();
    if (String(s.activeBank.bankId||"") === bid){
      setActiveBankMeta({ mode:"", ownerUid:"", bankId:"", publicId:"", name:"" });
      try{ window.activeCloudBankId = ""; }catch{}
    }
  }catch{}
}

/* slut Sektion 3C: MOLN-BANKER (lista + aktivera + uppdatera aktiv + spara + delete) */



/* start Sektion 3D: ROSTER (overlay + e-post + spara rosterRows/rosterTokens + epost-kvittens/validering) */

function _fv_genToken(len = 10){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  const bytes = new Uint8Array(len);
  (window.crypto || window.msCrypto).getRandomValues(bytes);
  for (let i = 0; i < len; i++) out += chars[bytes[i] % chars.length];
  return out;
}

function _fv_isEmailOk(email){
  const e = String(email||"").trim();
  if (!e) return false;
  return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(e);
}

function _fv_ensureRosterStyles(){
  if (_fv_getEl("fv-roster-styles")) return;
  const st = document.createElement("style");
  st.id = "fv-roster-styles";
  st.textContent = `
    .fv-roster-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .fv-roster-modal{ width:min(980px, 96vw); max-height:85vh; overflow:auto; }
    .fv-roster-head{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .fv-roster-grid{
      display:grid;
      grid-template-columns: 1.4fr 1fr 1.6fr 1fr auto;
      gap:6px; align-items:center; margin-top:8px;
    }
    .fv-roster-input{
      width:100%;
      border:1px solid rgba(75,85,99,.9);
      border-radius:10px;
      background:#0b1220;
      color:var(--text);
      padding:6px 8px;
      font-size:.82rem;
    }
    .fv-roster-input.fv-email-ok{ border-color: rgba(34,197,94,.9) !important; }
    .fv-roster-input.fv-email-bad{ border-color: rgba(239,68,68,.95) !important; }
    .fv-roster-row{
      display:grid;
      grid-template-columns: 1.4fr 1fr 1.6fr 1fr auto;
      gap:6px; align-items:center;
      padding:6px 0;
      border-top:1px solid rgba(31,41,55,.8);
    }
    .fv-roster-actions{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:flex-end; margin-top:10px; }
    .fv-roster-status{ margin-top:8px; }
    @media (max-width: 720px){
      .fv-roster-grid, .fv-roster-row{ grid-template-columns: 1fr; }
      .fv-roster-row{ padding:10px 0; }
    }
  `;
  document.head.appendChild(st);
}

function _fv_buildRosterOverlay(){
  _fv_ensureRosterStyles();
  let ov = _fv_getEl("fvRosterOverlay");
  if (ov) return ov;

  ov = document.createElement("div");
  ov.id = "fvRosterOverlay";
  ov.className = "fv-roster-overlay hidden";
  ov.innerHTML = `
    <div class="card fv-roster-modal">
      <div class="fv-roster-head">
        <div>
          <div class="q-text" id="fvRosterTitle">Elever</div>
          <div class="mini" id="fvRosterSub">‚Äî</div>
        </div>
        <div class="fv-roster-actions">
          <button class="btn btn-sm" type="button" id="fvRosterAdd">‚ûï L√§gg till elev</button>
          <button class="btn btn-sm" type="button" id="fvRosterEmail">‚úâÔ∏è E-posta elevl√§nkar</button>
          <button class="btn btn-sm btn-primary" type="button" id="fvRosterSave">üíæ Spara elevlista</button>
          <button class="btn btn-sm btn-danger" type="button" id="fvRosterClose">‚úñ St√§ng</button>
        </div>
      </div>

      <div class="fv-roster-grid mini">
        <div>Namn</div>
        <div>Klass</div>
        <div>E-post</div>
        <div>Token</div>
        <div></div>
      </div>

      <div id="fvRosterRows"></div>

      <div class="mini fv-roster-status" id="fvRosterStatus"></div>
    </div>
  `;
  document.body.appendChild(ov);

  ov.addEventListener("click", (e)=>{ if (e.target === ov) _fv_closeRoster(); });

  _fv_getEl("fvRosterClose")?.addEventListener("click", _fv_closeRoster);
  _fv_getEl("fvRosterAdd")?.addEventListener("click", ()=>_fv_addRosterRow());
  _fv_getEl("fvRosterSave")?.addEventListener("click", async ()=>{ await _fv_saveRosterFromUI(); });
  _fv_getEl("fvRosterEmail")?.addEventListener("click", ()=>{ _fv_emailRosterLinksFromUI(); });

  return ov;
}

function _fv_setRosterStatus(msg){
  const el = _fv_getEl("fvRosterStatus");
  if (!el) return;
  el.textContent = String(msg || "");
}

function _fv_openRoster(){
  const ov = _fv_buildRosterOverlay();
  ov.classList.remove("hidden");
}

function _fv_closeRoster(){
  const ov = _fv_getEl("fvRosterOverlay");
  if (ov) ov.classList.add("hidden");
}

function _fv_rowTemplate(row){
  const r = row || {};
  const wrap = document.createElement("div");
  wrap.className = "fv-roster-row";
  wrap.innerHTML = `
    <input class="fv-roster-input" data-fv="name" type="text" placeholder="Namn" value="${_fv_escapeHtml(String(r.name||""))}">
    <input class="fv-roster-input" data-fv="klass" type="text" placeholder="Klass" value="${_fv_escapeHtml(String(r.klass||""))}">
    <input class="fv-roster-input" data-fv="email" type="email" placeholder="E-post" value="${_fv_escapeHtml(String(r.email||""))}">
    <input class="fv-roster-input" data-fv="token" type="text" placeholder="Token" value="${_fv_escapeHtml(String(r.token||""))}">
    <div class="fv3-actions" style="justify-content:flex-end">
      <button class="btn fv3-btn-xs" type="button" data-act="gen">Ny token</button>
      <button class="btn fv3-btn-xs btn-danger" type="button" data-act="del">Ta bort</button>
    </div>
  `;

  const emailEl = wrap.querySelector('input[data-fv="email"]');
  const _validateEmail = ()=>{
    if (!emailEl) return;
    const ok = _fv_isEmailOk(emailEl.value);
    emailEl.classList.toggle("fv-email-ok", ok);
    emailEl.classList.toggle("fv-email-bad", !!String(emailEl.value||"").trim() && !ok);
  };
  emailEl?.addEventListener("input", _validateEmail);
  _validateEmail();

  wrap.querySelector('[data-act="gen"]')?.addEventListener("click", ()=>{
    const t = wrap.querySelector('input[data-fv="token"]');
    if (t) t.value = _fv_genToken(10);
  });
  wrap.querySelector('[data-act="del"]')?.addEventListener("click", ()=>{
    wrap.remove();
    _fv_setRosterStatus("");
  });
  return wrap;
}

function _fv_addRosterRow(prefill){
  const host = _fv_getEl("fvRosterRows");
  if (!host) return;
  host.appendChild(_fv_rowTemplate(prefill || { token: _fv_genToken(10) }));
}

function _fv_collectRosterFromUI(){
  const host = _fv_getEl("fvRosterRows");
  const rows = [];
  if (!host) return rows;

  const els = Array.from(host.querySelectorAll(".fv-roster-row"));
  for (let i=0;i<els.length;i++){
    const rowEl = els[i];
    const name = String(rowEl.querySelector('input[data-fv="name"]')?.value || "").trim();
    const klass = String(rowEl.querySelector('input[data-fv="klass"]')?.value || "").trim();
    const email = String(rowEl.querySelector('input[data-fv="email"]')?.value || "").trim();
    let token = String(rowEl.querySelector('input[data-fv="token"]')?.value || "").trim();

    if (!token) {
      token = _fv_genToken(10);
      const tEl = rowEl.querySelector('input[data-fv="token"]');
      if (tEl) tEl.value = token;
    }

    if (!token && !name && !email) continue;
    rows.push({ token, name, klass, email });
  }
  return rows;
}

function _fv_uniqueTokensFromRows(rows){
  const out = [];
  const seen = new Set();
  for (let i=0;i<rows.length;i++){
    const t = String(rows[i].token||"").trim();
    if (!t) continue;
    if (seen.has(t)) continue;
    seen.add(t);
    out.push(t);
  }
  return out;
}

function _fv_buildStudentLink(publicId, token){
  const pid = String(publicId||"").trim();
  const t = String(token||"").trim();
  if (!pid || !t) return "";
  const base = String(window.location.origin || "") + String(window.location.pathname || "");
  const qs = new URLSearchParams();
  qs.set("public", pid);
  qs.set("token", t);
  return base + "?" + qs.toString();
}

function _fv_emailRosterLinksFromUI(){
  const ov = _fv_getEl("fvRosterOverlay");
  if (!ov){
    alert("Ingen elevlista √∂ppen.");
    return;
  }

  const publicId = String(ov.getAttribute("data-public-id")||"").trim();
  if (!publicId){
    _fv_setRosterStatus("‚ö†Ô∏è Public-id saknas f√∂r banken. Skapa/aktivera en public-l√§nk f√∂rst.");
    alert("Public-id saknas f√∂r banken. Skapa/aktivera en public-l√§nk f√∂rst.");
    return;
  }

  const rows = _fv_collectRosterFromUI();
  const usable = rows
    .map(r=>({
      token: String(r.token||"").trim(),
      name: String(r.name||"").trim(),
      klass: String(r.klass||"").trim(),
      email: String(r.email||"").trim()
    }))
    .filter(r=>_fv_isEmailOk(r.email) && r.token);

  if (!usable.length){
    _fv_setRosterStatus("‚ö†Ô∏è Inga rader med giltig e-post + token.");
    alert("Inga rader med giltig e-post + token.");
    return;
  }

  const bcc = usable.map(r=>r.email).join(",");
  const title = String(_fv_getEl("fvRosterTitle")?.textContent || "Elever").trim();
  const subject = `F√•ngvaktaren ‚Äì elevl√§nkar (${title})`;

  const lines = [];
  lines.push("Hej!");
  lines.push("");
  lines.push("H√§r √§r elevl√§nkarna till F√•ngvaktaren:");
  lines.push("");

  for (let i=0;i<usable.length;i++){
    const r = usable[i];
    const link = _fv_buildStudentLink(publicId, r.token);
    const label = (r.name ? r.name : ("Token " + r.token)) + (r.klass ? ` (${r.klass})` : "");
    lines.push(`${label}: ${link}`);
  }

  lines.push("");
  lines.push("Lycka till!");

  const body = lines.join("\n");
  const mailto = `mailto:?bcc=${encodeURIComponent(bcc)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  try{
    window.location.href = mailto;
    _fv_setRosterStatus(`‚úÖ E-post redo: ${usable.length} mottagare (bcc).`);
    try{ if (typeof window.fvToast === "function") window.fvToast(`‚úÖ E-post skapad (${usable.length} mottagare).`); }catch{}
  }catch(e){
    console.warn("Kunde inte √∂ppna e-post:", e);
    _fv_setRosterStatus("‚ùå Kunde inte √∂ppna e-postklient.");
    alert("Kunde inte √∂ppna e-postklient.");
  }
}

async function _fv_loadRosterForBank(bankId){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Inte inloggad / DB saknas");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId||"").trim();
  if (!bid) throw new Error("Saknar bankId");

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  const snap = await ref.get();
  if (!snap.exists) throw new Error("Bank finns inte");

  const d = snap.data() || {};
  return {
    bankId: bid,
    name: String(d.name || d.title || d.bankName || "Moln-bank"),
    publicId: String(d.publicId || ""),
    rosterRows: Array.isArray(d.rosterRows) ? d.rosterRows : [],
    rosterTokens: Array.isArray(d.rosterTokens) ? d.rosterTokens : []
  };
}

async function _fv_saveRosterToBank(bankId, rows){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Inte inloggad / DB saknas");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId||"").trim();
  if (!bid) throw new Error("Saknar bankId");

  const cleanRows = Array.isArray(rows) ? rows : [];
  const tokens = _fv_uniqueTokensFromRows(cleanRows);

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  await ref.set({
    rosterRows: cleanRows,
    rosterTokens: tokens,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  return { tokensCount: tokens.length };
}

async function _fv_saveRosterFromUI(){
  const ov = _fv_getEl("fvRosterOverlay");
  const bid = ov ? String(ov.getAttribute("data-bank-id")||"").trim() : "";
  if (!bid){
    _fv_setRosterStatus("‚ö†Ô∏è Ingen bank vald.");
    return;
  }

  _fv_setRosterStatus("Sparar...");
  try{
    const rows = _fv_collectRosterFromUI();
    const res = await _fv_saveRosterToBank(bid, rows);
    _fv_setRosterStatus(`‚úÖ Sparat. Elever: ${res.tokensCount}`);
    try{ if (typeof window.fvToast === "function") window.fvToast(`‚úÖ Elevlista sparad (${res.tokensCount} elever).`); }catch{}

    try{ await loadCloudBanksListV5(); }catch{}
    try{ if (typeof window.tryRefreshRosterTabs === "function") window.tryRefreshRosterTabs(true); }catch{}
  }catch(e){
    console.error("Roster save error:", e);
    _fv_setRosterStatus("‚ùå Kunde inte spara elevlista (kontrollera inloggning/beh√∂righet).");
    alert("Kunde inte spara elevlista. Testa logga in med Google igen.");
  }
}

async function openRosterInline(bankId){
  try{
    _fv_openRoster();
    _fv_setRosterStatus("Laddar...");

    const info = await _fv_loadRosterForBank(bankId);

    const ov = _fv_buildRosterOverlay();
    ov.setAttribute("data-bank-id", String(info.bankId));
    ov.setAttribute("data-public-id", String(info.publicId||""));

    const t = _fv_getEl("fvRosterTitle");
    const sub = _fv_getEl("fvRosterSub");
    if (t) t.textContent = "Elever ‚Äì " + info.name;
    if (sub) sub.textContent = `Bank: ${info.bankId}${info.publicId ? " ‚Ä¢ Public: " + info.publicId : ""}`;

    const host = _fv_getEl("fvRosterRows");
    if (host) host.innerHTML = "";

    const rows = Array.isArray(info.rosterRows) ? info.rosterRows : [];
    if (rows.length){
      for (let i=0;i<rows.length;i++) _fv_addRosterRow(rows[i]);
    } else {
      _fv_addRosterRow({ token: _fv_genToken(10) });
    }

    _fv_setRosterStatus(`Redo. (${rows.length || 1} rader)`);
  }catch(e){
    console.error("openRosterInline error:", e);
    _fv_setRosterStatus("‚ùå Kunde inte ladda elevlista (kontrollera inloggning/beh√∂righet).");
    alert("Kunde inte ladda elevlista. Testa logga in med Google igen.");
  }
}

/* slut Sektion 3D: ROSTER (overlay + e-post + spara rosterRows/rosterTokens + epost-kvittens/validering) */



/* start Sektion 3E: PROGRESSIONSFLIK (rosterTabs + elevdocs + live-uppdatering + alias f√∂r gamla IDs) */

const _fvTeacherSelectedTokenKey = "fangvaktaren-teacher-selected-student-token-v17";
const _fvTeacherStudentCache = Object.create(null);
const _fvTeacherStudentCacheTtlMs = 15000;

let _fvTeacherLiveUnsub = null;
let _fvTeacherLiveToken = "";

function _fv_getSelectedToken(){
  try{ return String(localStorage.getItem(_fvTeacherSelectedTokenKey)||""); }catch{ return ""; }
}
function _fv_setSelectedToken(t){
  try{ localStorage.setItem(_fvTeacherSelectedTokenKey, String(t||"")); }catch{}
}

function _fv_getRosterTabsHost(){
  const ul = _fv_getEl("rosterTabs");
  if (ul) return ul;

  const div = _fv_getEl("playedStudentsTabs");
  if (div) return div;

  const list = _fv_getEl("playedStudentsList");
  if (list) return list;

  return null;
}

function _fv_getActiveStudentsCollectionRef(){
  if (!_fv_hasDb()) return null;
  const s = loadState();
  const a = s.activeBank || {};

  if (a.publicId && String(a.publicId).trim()){
    return firebaseDbInstance.collection(PUBLIC_BANKS_COLLECTION).doc(String(a.publicId)).collection("students");
  }
  if (a.ownerUid && a.bankId){
    return firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION).doc(String(a.ownerUid))
      .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(a.bankId))
      .collection("students");
  }
  if (_fv_hasTeacher() && String(window.activeCloudBankId||"").trim()){
    return firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION).doc(String(currentTeacherUser.uid))
      .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(window.activeCloudBankId))
      .collection("students");
  }
  return null;
}

async function _fv_fetchRosterFromActiveBank(){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) return { rows: [], tokens: [], publicId: "" };

  const s = loadState();
  const bankId = String(s.activeBank.bankId || window.activeCloudBankId || "").trim();
  if (!bankId) return { rows: [], tokens: [], publicId: "" };

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(String(currentTeacherUser.uid))
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(bankId));

  const snap = await ref.get();
  if (!snap.exists) return { rows: [], tokens: [], publicId: "" };

  const d = snap.data() || {};
  const rows = Array.isArray(d.rosterRows) ? d.rosterRows : [];
  const tokens = Array.isArray(d.rosterTokens) ? d.rosterTokens.map(String).filter(t=>String(t||"").trim()) : [];
  const publicId = String(d.publicId || "");

  return { rows, tokens, publicId };
}

function _fv_normRosterEntry(x){
  const e = x || {};
  const token = String(e.token || e.id || e.code || e.studentToken || "").trim();
  const name = String(e.name || e.studentName || e.namn || "").trim();
  const klass = String(e.klass || e.class || e.studentClass || e.klassnamn || "").trim();
  if (!token && !name) return null;
  return { token, name, klass };
}

function _fv_buildRosterTabs(roster){
  const rows = Array.isArray(roster.rows) ? roster.rows : [];
  const tokens = Array.isArray(roster.tokens) ? roster.tokens : [];

  const byToken = Object.create(null);
  for (let i=0;i<rows.length;i++){
    const r = _fv_normRosterEntry(rows[i]);
    if (!r || !r.token) continue;
    byToken[r.token] = r;
  }

  const out = [];
  for (let i=0;i<tokens.length;i++){
    const t = String(tokens[i]||"").trim();
    if (!t) continue;
    const hit = byToken[t] || { token:t, name:"", klass:"" };
    out.push({
      token: t,
      name: hit.name || ("Token " + t),
      klass: hit.klass || ""
    });
  }

  out.sort((a,b)=> String(a.name).localeCompare(String(b.name)));
  return out;
}

function _fv_renderRosterTabs(tabs){
  const host = _fv_getRosterTabsHost();
  if (!host) return;

  host.innerHTML = "";

  if (!tabs.length){
    const el = document.createElement("li");
    el.className = "mini";
    el.textContent = "Ingen elevlista (rosterTokens) finns i denna bank √§nnu.";
    host.appendChild(el);
    return;
  }

  const sel = _fv_getSelectedToken();

  for (let i=0;i<tabs.length;i++){
    const t = tabs[i];
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "tab-btn" + (sel && sel === t.token ? " active" : "");
    btn.setAttribute("data-token", t.token);
    btn.innerHTML = `${_fv_escapeHtml(t.name)}${t.klass ? `<span class="mini"> (${_fv_escapeHtml(t.klass)})</span>` : ""}`;
    host.appendChild(btn);
  }

  if (!host.__fvBound){
    host.__fvBound = true;
    host.addEventListener("click", (ev)=>{
      const btn = ev.target && ev.target.closest ? ev.target.closest("button[data-token]") : null;
      if (!btn) return;
      const token = String(btn.getAttribute("data-token")||"");
      if (!token) return;
      trySelectStudentToken(token);
    });
  }
}

function _fv_safeNum(n, fallback=0){
  const x = Number(n);
  return isFinite(x) ? x : fallback;
}

function _fv_readDottedKeyNum(d, key, fallback=0){
  try{
    if (!d || typeof d !== "object") return fallback;
    if (!Object.prototype.hasOwnProperty.call(d, key)) return fallback;
    return _fv_safeNum(d[key], fallback);
  }catch{
    return fallback;
  }
}

function _fv_normalizeDottedProgressionIntoObject(d){
  try{
    if (!d || typeof d !== "object") return d;
    if (!d.progression || typeof d.progression !== "object") d.progression = {};
    const p = d.progression;

    const e = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.E", 0);
    const c = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.C", 0);
    const a = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.A", 0);

    if ((e+c+a) > 0){
      if (!p.attemptsByLevel || typeof p.attemptsByLevel !== "object") p.attemptsByLevel = { E:0, C:0, A:0 };
      p.attemptsByLevel.E = Math.max(_fv_safeNum(p.attemptsByLevel.E,0), e);
      p.attemptsByLevel.C = Math.max(_fv_safeNum(p.attemptsByLevel.C,0), c);
      p.attemptsByLevel.A = Math.max(_fv_safeNum(p.attemptsByLevel.A,0), a);
      if (typeof p.attemptsTotal !== "number") p.attemptsTotal = (p.attemptsByLevel.E + p.attemptsByLevel.C + p.attemptsByLevel.A);
    }

    const t = _fv_readDottedKeyNum(d, "progression.attemptsTotal", NaN);
    if (isFinite(t) && t >= 0) p.attemptsTotal = t;
  }catch{}
  return d;
}

async function _fv_fetchStudentDoc(token){
  const ref = _fv_getActiveStudentsCollectionRef();
  if (!ref) return null;
  const t = String(token||"").trim();
  if (!t) return null;

  try{
    const snap = await ref.doc(t).get();
    if (!snap || !snap.exists) return null;
    const d0 = snap.data() || {};
    const d = _fv_normalizeDottedProgressionIntoObject(d0) || d0;
    d._token = t;
    d._fetchedAt = Date.now();
    return d;
  }catch(e){
    console.warn("Kunde inte l√§sa elevdoc:", e);
    return { _token: t, _error: "permissions", _fetchedAt: Date.now() };
  }
}

function _fv_getProgressionFromRemote(d){
  const prog = (d && d.progression) ? d.progression : (d && d.prog) ? d.prog : {};
  return {
    totalPoints: _fv_safeNum(
      (prog.totalPoints != null) ? prog.totalPoints :
      (d && d.totalPoints != null) ? d.totalPoints :
      (d && d.points != null) ? d.points :
      0, 0
    ),
    correctByGoalId: (prog.correctByGoalId && typeof prog.correctByGoalId==="object") ? prog.correctByGoalId : (d && d.correctByGoalId) ? d.correctByGoalId : {},
    wrongByGoalId: (prog.wrongByGoalId && typeof prog.wrongByGoalId==="object") ? prog.wrongByGoalId : (d && d.wrongByGoalId) ? d.wrongByGoalId : {}
  };
}

function _fv_getAttemptsFromRemote(d){
  const prog = (d && d.progression && typeof d.progression==="object") ? d.progression : {};
  const out = { E:0, C:0, A:0, total:0, has:false };

  const dE = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.E", 0);
  const dC = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.C", 0);
  const dA = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.A", 0);
  if ((dE + dC + dA) > 0){
    out.E = dE; out.C = dC; out.A = dA;
    out.total = out.E + out.C + out.A;
    out.has = (out.total > 0);
    return out;
  }
  const dT = _fv_readDottedKeyNum(d, "progression.attemptsTotal", NaN);
  if (isFinite(dT) && dT > 0){
    out.total = dT;
    out.has = true;
    return out;
  }

  const candABL =
    (prog.attemptsByLevel && typeof prog.attemptsByLevel==="object") ? prog.attemptsByLevel :
    (d && d.attemptsByLevel && typeof d.attemptsByLevel==="object") ? d.attemptsByLevel :
    (d && d.stats && d.stats.attemptsByLevel && typeof d.stats.attemptsByLevel==="object") ? d.stats.attemptsByLevel :
    null;

  if (candABL){
    out.E = _fv_safeNum(candABL.E, 0);
    out.C = _fv_safeNum(candABL.C, 0);
    out.A = _fv_safeNum(candABL.A, 0);
    out.total = out.E + out.C + out.A;
    out.has = (out.total > 0);
    return out;
  }

  const totalCand =
    (prog.attemptsTotal != null) ? prog.attemptsTotal :
    (d && d.attemptsTotal != null) ? d.attemptsTotal :
    (d && d.attempts != null) ? d.attempts :
    (d && d.playCount != null) ? d.playCount :
    (d && d.gamesPlayed != null) ? d.gamesPlayed :
    null;

  if (totalCand != null){
    out.total = _fv_safeNum(totalCand, 0);
    out.has = (out.total > 0);
    return out;
  }

  return out;
}

function _fv_renderUl(ul, items, emptyText){
  if (!ul) return;
  const arr = Array.isArray(items) ? items : [];
  ul.innerHTML = "";
  if (!arr.length){
    const li = document.createElement("li");
    li.textContent = emptyText || "Ingen data √§nnu.";
    ul.appendChild(li);
    return;
  }
  for (let i=0;i<arr.length;i++){
    const li = document.createElement("li");
    li.innerHTML = items[i];
    ul.appendChild(li);
  }
}

function _fv_goalIdLevelsMapFromBank(bank){
  const out = Object.create(null);
  const b = bank || {};
  const lists = [
    Array.isArray(b.mcq) ? b.mcq : [],
    Array.isArray(b.img) ? b.img : [],
    Array.isArray(b.drag) ? b.drag : []
  ];

  for (let li=0; li<lists.length; li++){
    const arr = lists[li];
    for (let i=0;i<arr.length;i++){
      const q = arr[i] || {};
      const lvl = String(q.level || q.lv || "").toUpperCase() || "E";
      const links = Array.isArray(q.links) ? q.links : [];
      for (let k=0;k<links.length;k++){
        const gid = String(links[k] && links[k].id != null ? links[k].id : "").trim();
        if (!gid) continue;
        if (!out[gid]) out[gid] = new Set();
        out[gid].add(lvl);
      }
    }
  }
  return out;
}

function _fv_pickThresholdForGoalId(goalId, levelsMap){
  try{
    const set = levelsMap && levelsMap[String(goalId)] ? levelsMap[String(goalId)] : null;
    if (!set || !set.size) return 0.50;
    if (set.has("E")) return 0.50;
    if (set.has("C")) return 0.30;
    if (set.has("A")) return 0.20;
  }catch{}
  return 0.50;
}

/* Alias-map: gamla timestamp-ids -> goalsMap.id via match p√• (goal+parts) */
function _fv_buildAliasMap(goalsMap, bank){
  const gm = Array.isArray(goalsMap) ? goalsMap : [];
  const b = bank || {};
  const alias = Object.create(null);

  const keyOf = (goal, parts)=> `${String(goal||"").trim()}||${String(parts||"").trim()}`;

  const gmKeyToId = Object.create(null);
  const gmIds = new Set();
  for (let i=0;i<gm.length;i++){
    const g = gm[i] || {};
    const id = String(g.id||"").trim();
    gmIds.add(id);
    gmKeyToId[keyOf(g.goal, g.parts)] = id;
  }

  const lists = [
    Array.isArray(b.mcq) ? b.mcq : [],
    Array.isArray(b.img) ? b.img : [],
    Array.isArray(b.drag) ? b.drag : []
  ];

  for (let li=0; li<lists.length; li++){
    const arr = lists[li];
    for (let i=0;i<arr.length;i++){
      const q = arr[i] || {};
      const links = Array.isArray(q.links) ? q.links : [];
      for (let k=0;k<links.length;k++){
        const L = links[k] || {};
        const oldId = String(L.id != null ? L.id : "").trim();
        const goal = String(L.goal != null ? L.goal : (q.goal||"")).trim();
        const parts = String(L.parts != null ? L.parts : (q.parts||"")).trim();
        if (!oldId || !goal || !parts) continue;
        if (gmIds.has(oldId)) continue; // redan "nytt" id
        const newId = gmKeyToId[keyOf(goal, parts)];
        if (newId) alias[oldId] = newId;
      }
    }
  }
  return alias;
}

function _fv_mergeProgByAlias(prog, aliasMap){
  const p = prog && typeof prog==="object" ? prog : {};
  const corr = (p.correctByGoalId && typeof p.correctByGoalId==="object") ? p.correctByGoalId : {};
  const wrong = (p.wrongByGoalId && typeof p.wrongByGoalId==="object") ? p.wrongByGoalId : {};

  const outC = Object.create(null);
  const outW = Object.create(null);

  const add = (dst, key, val)=>{
    const k = String(key||"").trim();
    if (!k) return;
    dst[k] = _fv_safeNum(dst[k],0) + _fv_safeNum(val,0);
  };

  Object.keys(corr).forEach(k=>{
    const nk = aliasMap && aliasMap[String(k)] ? String(aliasMap[String(k)]) : String(k);
    add(outC, nk, corr[k]);
  });
  Object.keys(wrong).forEach(k=>{
    const nk = aliasMap && aliasMap[String(k)] ? String(aliasMap[String(k)]) : String(k);
    add(outW, nk, wrong[k]);
  });

  return {
    totalPoints: _fv_safeNum(p.totalPoints, 0),
    correctByGoalId: outC,
    wrongByGoalId: outW
  };
}

function _fv_computeStrongWeak(goalsMap, prog, bank){
  const gm = Array.isArray(goalsMap) ? goalsMap : [];
  const gmIndex = Object.create(null);
  for (let i=0;i<gm.length;i++){
    const g = gm[i] || {};
    gmIndex[String(g.id)] = g;
  }

  // Alias: g√∂r att 17649... r√§knas ihop med "1"/"2" n√§r de beskriver samma goal+parts
  const alias = _fv_buildAliasMap(gm, bank);
  const mergedProg = _fv_mergeProgByAlias(prog, alias);

  const corr = mergedProg.correctByGoalId || {};
  const wrong = mergedProg.wrongByGoalId || {};
  const levelsMap = _fv_goalIdLevelsMapFromBank(bank);

  const keys = new Set();
  Object.keys(corr||{}).forEach(k=>keys.add(String(k)));
  Object.keys(wrong||{}).forEach(k=>keys.add(String(k)));

  const rows = [];
  keys.forEach((k)=>{
    const c = _fv_safeNum(corr[k],0);
    const w = _fv_safeNum(wrong[k],0);
    const a = c+w;
    if (a<=0) return;

    const g = gmIndex[k] || null;
    const goal = g ? String(g.goal||"").trim() : "";
    const part = g ? String(g.parts||g.part||"").trim() : "";

    let label = "";
    if (g && (goal || part)){
      if (goal && part) label = `Delbit ${_fv_escapeHtml(k)}: ${_fv_escapeHtml(goal)} ‚Äî ${_fv_escapeHtml(part)}`;
      else label = `Delbit ${_fv_escapeHtml(k)}: ${_fv_escapeHtml(goal || part)}`;
    }else{
      label = `Ok√§nd delbit (id ${_fv_escapeHtml(k)}) <span class="mini">‚Äì kontrollera kopplingen i fr√•gebanken</span>`;
    }

    const acc = a ? (c/a) : 0;
    const th = _fv_pickThresholdForGoalId(k, levelsMap);

    rows.push({ key:k, label, c, w, a, acc, th });
  });

  const strong = rows
    .filter(r=> r.acc >= r.th)
    .sort((a,b)=> (b.acc-a.acc) || (b.a-a.a))
    .slice(0,10)
    .map(r=>`${r.label} <span class="mini">(${r.c}/${r.a} r√§tt, ${Math.round(r.acc*100)}%)</span>`);

  const weak = rows
    .filter(r=> r.acc < r.th)
    .sort((a,b)=> (a.acc-b.acc) || (b.a-a.a))
    .slice(0,10)
    .map(r=>`${r.label} <span class="mini">(${r.c}/${r.a} r√§tt, ${Math.round(r.acc*100)}%)</span>`);

  return { strong, weak };
}

function tryUpdateProgressUI(){
  const pEl = _fv_getEl("progressPointsText");
  const strongUl = _fv_getEl("progressStrongList");
  const weakUl = _fv_getEl("progressWeakList");

  const token = _fv_getSelectedToken();
  const remote = token ? (_fvTeacherStudentCache[token] || null) : null;

  if (!token){
    if (pEl) pEl.innerHTML = "V√§lj en elevflik.";
    _fv_renderUl(strongUl, [], "‚Äî");
    _fv_renderUl(weakUl, [], "‚Äî");
    return;
  }

  if (!remote){
    if (pEl) pEl.innerHTML = "Ingen inl√§mning √§nnu f√∂r vald elev.";
    _fv_renderUl(strongUl, [], "Ingen data √§nnu.");
    _fv_renderUl(weakUl, [], "Ingen data √§nnu.");
    return;
  }

  if (remote && remote._error === "permissions"){
    if (pEl) pEl.innerHTML = "‚ö†Ô∏è Beh√∂righet saknas f√∂r att l√§sa elevdata (kontrollera Firestore rules).";
    _fv_renderUl(strongUl, [], "‚Äî");
    _fv_renderUl(weakUl, [], "‚Äî");
    return;
  }

  const sTeacher = loadState();
  const prog = _fv_getProgressionFromRemote(remote);
  const total = _fv_safeNum(prog.totalPoints, 0);

  const attempts = _fv_getAttemptsFromRemote(remote);
  const attemptsHtml = attempts.has
    ? ` <span class="mini">(F√∂rs√∂k: E ${_fv_escapeHtml(attempts.E)} ‚Ä¢ C ${_fv_escapeHtml(attempts.C)} ‚Ä¢ A ${_fv_escapeHtml(attempts.A)} ‚Ä¢ Totalt ${_fv_escapeHtml(attempts.total)})</span>`
    : ` <span class="mini">(F√∂rs√∂k: saknas i elevdata)</span>`;

  if (pEl) pEl.innerHTML = `Totalt: <strong>${_fv_escapeHtml(total)} p</strong>.${attemptsHtml}`;

  const gm = Array.isArray(sTeacher.goalsMap) ? sTeacher.goalsMap : [];
  const bank = sTeacher.bank || {};
  const { strong, weak } = _fv_computeStrongWeak(gm, prog, bank);

  _fv_renderUl(strongUl, strong, "F√∂r lite data f√∂r tydliga styrkor √§nnu ‚Äì l√•t eleven spela mer p√• niv√•n.");
  _fv_renderUl(weakUl, weak, "Inga delbitar att √∂va p√• √§nnu.");
}

function _fv_stopLiveStudent(){
  try{ if (_fvTeacherLiveUnsub) _fvTeacherLiveUnsub(); }catch{}
  _fvTeacherLiveUnsub = null;
  _fvTeacherLiveToken = "";
}

function _fv_startLiveStudent(token){
  try{
    const t = String(token||"").trim();
    if (!t) return;
    if (!_fv_hasDb()) return;

    const ref = _fv_getActiveStudentsCollectionRef();
    if (!ref) return;

    if (_fvTeacherLiveToken === t && _fvTeacherLiveUnsub) return;

    _fv_stopLiveStudent();
    _fvTeacherLiveToken = t;

    _fvTeacherLiveUnsub = ref.doc(t).onSnapshot((snap)=>{
      try{
        if (!snap || !snap.exists) return;
        const d0 = snap.data() || {};
        const d = _fv_normalizeDottedProgressionIntoObject(d0) || d0;
        d._token = t;
        d._fetchedAt = Date.now();
        _fvTeacherStudentCache[t] = d;
        tryUpdateProgressUI();
      }catch{}
    }, (err)=>{
      console.warn("Live-lyssnare fel (ok att ignorera):", err);
      _fv_stopLiveStudent();
    });
  }catch{}
}

async function trySelectStudentToken(token){
  const t = String(token||"").trim();
  if (!t) return;

  _fv_setSelectedToken(t);

  try{
    const host = _fv_getRosterTabsHost();
    if (host){
      Array.from(host.querySelectorAll("button[data-token]")).forEach(b=>{
        b.classList.toggle("active", String(b.getAttribute("data-token")||"") === t);
      });
    }
  }catch{}

  const cached = _fvTeacherStudentCache[t] || null;
  const now = Date.now();
  const isFresh = !!(cached && cached._fetchedAt && (now - Number(cached._fetchedAt) <= _fvTeacherStudentCacheTtlMs));

  if (!isFresh){
    try{
      const data = await _fv_fetchStudentDoc(t);
      if (data) _fvTeacherStudentCache[t] = data;
      else delete _fvTeacherStudentCache[t];
    }catch(e){
      console.warn("Kunde inte l√§sa elevdoc:", e);
    }
  }

  // Starta live-uppdatering direkt (l√∂ser ‚Äúm√•ste byta elev och tillbaka‚Äù + uppdaterar n√§r eleven spelar)
  _fv_startLiveStudent(t);

  tryUpdateProgressUI();
}

async function tryRefreshRosterTabs(){
  try{
    const roster = await _fv_fetchRosterFromActiveBank();

    if (roster && roster.publicId){
      const s = loadState();
      if (String(s.activeBank.bankId||"").trim()){
        setActiveBankMeta(Object.assign({}, s.activeBank, { publicId: String(roster.publicId||"") }));
      }
    }

    const tabs = _fv_buildRosterTabs(roster);
    _fv_renderRosterTabs(tabs);

    const sel = _fv_getSelectedToken();
    if (!sel && tabs.length) await trySelectStudentToken(tabs[0].token);
    if (sel && tabs.length && !tabs.find(x=>x.token===sel)) await trySelectStudentToken(tabs[0].token);
    if (sel && tabs.length) tryUpdateProgressUI();
  }catch(e){
    console.warn("Kunde inte l√§sa roster f√∂r flikar:", e);
  }
}

/* debug: g√∂r cache synlig i konsolen (p√•verkar inte UI) */
try{ window._fvTeacherStudentCache = _fvTeacherStudentCache; }catch{}
try{ window._fv_getSelectedToken = _fv_getSelectedToken; }catch{}
try{ window._fv_getAttemptsFromRemote = _fv_getAttemptsFromRemote; }catch{}

/* Extern helper: om bank aktiveras ‚Äì tvinga refresh/live */
async function _fvTeacherForceLiveRefresh(){
  try{
    const sel = _fv_getSelectedToken();
    if (!sel) return;
    const data = await _fv_fetchStudentDoc(sel);
    if (data) _fvTeacherStudentCache[sel] = data;
    _fv_startLiveStudent(sel);
    tryUpdateProgressUI();
  }catch{}
}
try{ window._fvTeacherForceLiveRefresh = _fvTeacherForceLiveRefresh; }catch{}

/* slut Sektion 3E: PROGRESSIONSFLIK (rosterTabs + elevdocs + live-uppdatering + alias f√∂r gamla IDs) */



/* start Sektion 3F: UI refresh (goals-select + bankstatus hook + l√§rarinst√§llningar: rutor + delete + konvertera gamla IDs) */

(function FV_Toasts(){
  if (_fv_getEl("fvToast")) return;
  const st = document.createElement("style");
  st.id = "fvToastStyles";
  st.textContent = `
    #fvToast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      z-index:99999;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(75,85,99,.75);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: 0 12px 28px rgba(0,0,0,.45);
      font-size:.9rem;
      max-width:min(720px, 92vw);
      display:none;
    }
  `;
  document.head.appendChild(st);

  const div = document.createElement("div");
  div.id = "fvToast";
  document.body.appendChild(div);

  let tmr = null;
  window.fvToast = (msg)=>{
    const el = _fv_getEl("fvToast");
    if (!el) return;
    el.textContent = String(msg||"");
    el.style.display = "block";
    try{ if (tmr) clearTimeout(tmr); }catch{}
    tmr = setTimeout(()=>{ try{ el.style.display="none"; }catch{} }, 2400);
  };
})();

function _fv_refreshGoalSelects(){
  const ids = ["mcqGoalPart","mcqJsonGoalPart","imgGoalPart","dragGoalPart"];
  const s = loadState();
  const gm = Array.isArray(s.goalsMap) ? s.goalsMap : [];

  for (let k=0;k<ids.length;k++){
    const sel = _fv_getEl(ids[k]);
    if (!sel || sel.tagName.toLowerCase() !== "select") continue;

    const prev = String(sel.value || "");
    sel.innerHTML = "";

    const def = document.createElement("option");
    def.value = "";
    def.textContent = "Ingen koppling";
    sel.appendChild(def);

    for (let i=0;i<gm.length;i++){
      const g = gm[i] || {};
      const opt = document.createElement("option");
      opt.value = String(g.id||"");
      const goal = String(g.goal||"").trim();
      const parts = String(g.parts||g.part||"").trim();
      opt.textContent = (goal ? goal : "Delm√•l") + (parts ? ` (${parts})` : "");
      sel.appendChild(opt);
    }

    try{ sel.value = prev; }catch{}
  }
}

/* --- L√§rarinst√§llningar: hitta host + render ‚ÄúAktuella delm√•l och delbitar‚Äù som rutor --- */
function _fv_findGoalsSettingsHost(){
  const ids = [
    "teacherGoalsSettings",
    "teacherGoalsBox",
    "currentGoalsBox",
    "goalsMapBox",
    "goalsMapPreview",
    "goalsPreview",
    "teacherSettingsGoals",
    "teacherSettings",
    "teacherPanel",
    "tabTeacher",
    "teacherTab"
  ];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el) return el;
  }
  return null;
}

function _fv_ensureGoalsManagerStyles(){
  if (_fv_getEl("fv-goals-manager-styles")) return;
  const st = document.createElement("style");
  st.id = "fv-goals-manager-styles";
  st.textContent = `
    .fv-goals-wrap{ display:grid; gap:10px; margin-top:10px; }
    .fv-goal-card{ border:1px solid rgba(75,85,99,.75); border-radius:16px; padding:10px; background:rgba(2,6,23,.35); }
    .fv-goal-head{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .fv-goal-title{ font-weight:700; line-height:1.2; }
    .fv-goal-items{ display:grid; gap:8px; margin-top:10px; }
    .fv-goal-item{ border:1px solid rgba(75,85,99,.65); border-radius:14px; padding:8px 10px; background:#0b1220; display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
    .fv-goal-item .mini{ opacity:.9; }
    .fv-goals-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; justify-content:flex-end; }
  `;
  document.head.appendChild(st);
}

function _fv_groupGoalsMap(goalsMap){
  const gm = Array.isArray(goalsMap) ? goalsMap : [];
  const groups = Object.create(null);
  for (let i=0;i<gm.length;i++){
    const g = gm[i] || {};
    const goal = String(g.goal||"").trim() || "(utan delm√•l)";
    if (!groups[goal]) groups[goal] = [];
    groups[goal].push({ id: String(g.id||"").trim(), parts: String(g.parts||g.part||"").trim() });
  }
  const out = Object.keys(groups).sort((a,b)=>a.localeCompare(b)).map(goal=>{
    const items = groups[goal].slice().sort((x,y)=>String(x.id).localeCompare(String(y.id)));
    return { goal, items };
  });
  return out;
}

function _fv_removeLinksByGoalId(bank, goalId){
  const gid = String(goalId||"").trim();
  if (!gid) return bank;
  const b = _fv_ensureBankShape(bank);

  const cleanLinks = (q)=>{
    const links = Array.isArray(q.links) ? q.links : [];
    q.links = links.filter(L=> String(L && L.id != null ? L.id : "").trim() !== gid);
    return q;
  };

  b.mcq = (Array.isArray(b.mcq)?b.mcq:[]).map(q=>cleanLinks(Object.assign({}, q||{})));
  b.img = (Array.isArray(b.img)?b.img:[]).map(q=>cleanLinks(Object.assign({}, q||{})));
  b.drag = (Array.isArray(b.drag)?b.drag:[]).map(q=>cleanLinks(Object.assign({}, q||{})));
  return b;
}

function _fv_deleteGoalItem(goalId){
  const gid = String(goalId||"").trim();
  if (!gid) return;
  const s = loadState();
  s.goalsMap = (Array.isArray(s.goalsMap)?s.goalsMap:[]).filter(g=>String(g.id||"").trim() !== gid);
  s.bank = _fv_removeLinksByGoalId(s.bank || {}, gid);
  saveState(s);
  try{ fvRefreshTeacherBankUI(); }catch{}
  try{ if (typeof window.updateBankStatusUI==="function") window.updateBankStatusUI(); }catch{}
  try{ if (typeof window._fv3h_renderAllQuestionLists==="function") window._fv3h_renderAllQuestionLists(); }catch{}
  try{ window.fvToast(`üóë Delbit ${gid} borttagen. (Gl√∂m inte spara banken till molnet)`); }catch{}
}

function _fv_deleteGoalGroup(goalTitle){
  const title = String(goalTitle||"").trim();
  if (!title) return;
  const s = loadState();
  const gm = Array.isArray(s.goalsMap)?s.goalsMap:[];
  const toRemove = gm.filter(g=>String(g.goal||"").trim() === title).map(g=>String(g.id||"").trim()).filter(Boolean);

  if (!toRemove.length) return;

  let bank = s.bank || {};
  for (let i=0;i<toRemove.length;i++) bank = _fv_removeLinksByGoalId(bank, toRemove[i]);

  s.goalsMap = gm.filter(g=>String(g.goal||"").trim() !== title);
  s.bank = _fv_ensureBankShape(bank);
  saveState(s);

  try{ fvRefreshTeacherBankUI(); }catch{}
  try{ if (typeof window.updateBankStatusUI==="function") window.updateBankStatusUI(); }catch{}
  try{ if (typeof window._fv3h_renderAllQuestionLists==="function") window._fv3h_renderAllQuestionLists(); }catch{}
  try{ window.fvToast(`üóë Delm√•l borttaget (${toRemove.length} delbitar). (Spara till molnet)`); }catch{}
}

/* Konvertera gamla links[].id (17649...) -> goalsMap.id ("1","2",...) via (goal+parts) */
function _fv_convertLegacyLinkIds(){
  const s = loadState();
  const gm = Array.isArray(s.goalsMap)?s.goalsMap:[];
  const bank = _fv_ensureBankShape(s.bank||{});
  const alias = _fv_buildAliasMap(gm, bank);

  const convertInQ = (q)=>{
    const links = Array.isArray(q.links) ? q.links : [];
    if (!links.length) return q;

    const seen = new Set();
    const out = [];

    for (let i=0;i<links.length;i++){
      const L = Object.assign({}, links[i]||{});
      const oldId = String(L.id != null ? L.id : "").trim();
      if (!oldId) continue;

      const newId = alias[oldId] ? String(alias[oldId]) : oldId;
      L.id = newId;

      const sig = `${newId}||${String(L.goal||q.goal||"").trim()}||${String(L.parts||q.parts||"").trim()}`;
      if (seen.has(sig)) continue;
      seen.add(sig);
      out.push(L);
    }

    q.links = out;
    return q;
  };

  let conv = 0;
  const apply = (arr)=>{
    const A = Array.isArray(arr)?arr:[];
    return A.map((q)=>{
      const before = JSON.stringify(q && q.links ? q.links : []);
      const nq = convertInQ(Object.assign({}, q||{}));
      const after = JSON.stringify(nq.links||[]);
      if (before !== after) conv++;
      return nq;
    });
  };

  bank.mcq = apply(bank.mcq);
  bank.img = apply(bank.img);
  bank.drag = apply(bank.drag);

  s.bank = bank;
  saveState(s);

  try{ if (typeof window._fv3h_renderAllQuestionLists==="function") window._fv3h_renderAllQuestionLists(); }catch{}
  try{ if (typeof window.updateBankStatusUI==="function") window.updateBankStatusUI(); }catch{}
  try{ fvRefreshTeacherBankUI(); }catch{}

  try{ window.fvToast(`‚úÖ Konvertering klar. √Ñndrade l√§nkar i ${conv} fr√•gor. (Spara banken till molnet)`); }catch{}
}

function _fv_renderGoalsManager(){
  const host = _fv_findGoalsSettingsHost();
  if (!host) return; // om du vill: s√§g till s√• bygger vi ett s√§kert host-id i SEKTION 2

  _fv_ensureGoalsManagerStyles();

  let box = _fv_getEl("fvGoalsManagerBox");
  if (!box){
    box = document.createElement("div");
    box.id = "fvGoalsManagerBox";
    box.className = "card";
    box.style.marginTop = "10px";
    box.innerHTML = `
      <div class="q-text">Aktuella delm√•l och delbitar</div>
      <div class="mini">Varje delm√•l/delbit visas som egna rutor. Du kan ta bort s√•dant du inte vill beh√•lla.</div>
      <div class="fv-goals-actions">
        <button class="btn btn-sm" type="button" id="fvGoalsConvertLegacy">üßπ Konvertera gamla delbit-ID</button>
        <button class="btn btn-sm btn-primary" type="button" id="fvGoalsHintSave">üíæ P√•minn: spara till molnet</button>
      </div>
      <div class="fv-goals-wrap" id="fvGoalsWrap"></div>
      <div class="mini" id="fvGoalsStatus"></div>
    `;

    host.appendChild(box);

    _fv_getEl("fvGoalsConvertLegacy")?.addEventListener("click", ()=>{
      if (!confirm("Konvertera gamla delbit-ID (t.ex. 17649...) till goalsMap-id (1,2,3...)?\nDetta √§ndrar fr√•gornas links. (Gl√∂m inte spara banken till molnet efter√•t)")) return;
      _fv_convertLegacyLinkIds();
      _fv_renderGoalsManager();
    });
    _fv_getEl("fvGoalsHintSave")?.addEventListener("click", ()=>{
      try{ window.fvToast("üíæ Kom ih√•g: klicka ‚ÄúSpara till moln‚Äù f√∂r att g√∂ra √§ndringarna permanenta."); }catch{}
    });
  }

  const wrap = _fv_getEl("fvGoalsWrap");
  const status = _fv_getEl("fvGoalsStatus");
  if (!wrap) return;

  const s = loadState();
  const groups = _fv_groupGoalsMap(s.goalsMap || []);
  wrap.innerHTML = "";

  if (!groups.length){
    wrap.innerHTML = `<div class="mini">Inga delm√•l/delbitar finns i goalsMap just nu.</div>`;
    if (status) status.textContent = "";
    return;
  }

  let itemsCount = 0;

  for (let gi=0; gi<groups.length; gi++){
    const g = groups[gi];
    const card = document.createElement("div");
    card.className = "fv-goal-card";

    card.innerHTML = `
      <div class="fv-goal-head">
        <div>
          <div class="fv-goal-title">${_fv_escapeHtml(g.goal)}</div>
          <div class="mini">${_fv_escapeHtml(g.items.length)} delbitar</div>
        </div>
        <div class="fv3-actions">
          <button class="btn fv3-btn-xs btn-danger" type="button" data-act="del-goal" data-goal="${_fv_escapeHtml(g.goal)}">Ta bort delm√•l</button>
        </div>
      </div>
      <div class="fv-goal-items"></div>
    `;

    const itemsHost = card.querySelector(".fv-goal-items");
    for (let ii=0; ii<g.items.length; ii++){
      const it = g.items[ii];
      itemsCount++;
      const row = document.createElement("div");
      row.className = "fv-goal-item";
      row.innerHTML = `
        <div style="min-width:0">
          <div><strong>Delbit ${_fv_escapeHtml(it.id)}</strong></div>
          <div class="mini">${_fv_escapeHtml(it.parts || "(ingen delbit-text)")}</div>
        </div>
        <div class="fv3-actions">
          <button class="btn fv3-btn-xs btn-danger" type="button" data-act="del-item" data-id="${_fv_escapeHtml(it.id)}">Ta bort</button>
        </div>
      `;
      itemsHost?.appendChild(row);
    }

    card.addEventListener("click", (ev)=>{
      const btn = ev.target && ev.target.closest ? ev.target.closest("button[data-act]") : null;
      if (!btn) return;

      const act = String(btn.getAttribute("data-act")||"");
      if (act === "del-item"){
        const id = String(btn.getAttribute("data-id")||"").trim();
        if (!id) return;
        if (!confirm(`Ta bort delbit ${id}? Detta rensar √§ven kopplingar i fr√•gor.\n(Spara till molnet efter√•t)`)) return;
        _fv_deleteGoalItem(id);
        _fv_renderGoalsManager();
      } else if (act === "del-goal"){
        const goal = String(btn.getAttribute("data-goal")||"").trim();
        if (!goal) return;
        if (!confirm(`Ta bort delm√•l:\n${goal}\nDetta tar bort alla delbitar i delm√•let + rensar kopplingar i fr√•gor.\n(Spara till molnet efter√•t)`)) return;
        _fv_deleteGoalGroup(goal);
        _fv_renderGoalsManager();
      }
    });

    wrap.appendChild(card);
  }

  if (status){
    status.textContent = `Visar ${groups.length} delm√•l och ${itemsCount} delbitar.`;
  }
}

function fvRefreshTeacherBankUI(){
  try{ _fv_refreshGoalSelects(); }catch{}
  try{ _fv3h_renderAllQuestionLists(); }catch{}
  try{ if (typeof window.updateBankStatusUI === "function") window.updateBankStatusUI(); }catch{}
  try{ _fv_renderGoalsManager(); }catch{}
}

try{ window.fvRefreshTeacherBankUI = fvRefreshTeacherBankUI; }catch{}

try{
  if (!window.__fv_bank_changed_listener){
    window.__fv_bank_changed_listener = true;
    window.addEventListener("fv-bank-changed", ()=>{
      try{ fvRefreshTeacherBankUI(); }catch{}
      try{ tryRefreshRosterTabs(true); }catch{}
      try{ if (typeof window.fvToast === "function") window.fvToast("üîÑ Bank √§ndrad ‚Äì inst√§llningar & elevflikar uppdaterade."); }catch{}
    });
  }
}catch{}

/* Auto: n√§r fliken f√•r fokus ‚Äì h√§mta senaste elevdata */
try{
  if (!window.__fv_focus_refresh_bound){
    window.__fv_focus_refresh_bound = true;
    window.addEventListener("focus", ()=>{
      try{ if (typeof window._fvTeacherForceLiveRefresh === "function") window._fvTeacherForceLiveRefresh(); }catch{}
    }, true);
  }
}catch{}

/* slut Sektion 3F: UI refresh (goals-select + bankstatus hook + l√§rarinst√§llningar: rutor + delete + konvertera gamla IDs) */







/* start Sektion 3G: INIT & KNAPP-KOPPLINGAR (bind molnknappar + auto-refresh teacher UI) */

function _fv_bindOnce(el, key){
  try{
    if (!el) return false;
    const k = "__fvBound_" + String(key||"");
    if (el[k]) return false;
    el[k] = true;
    return true;
  }catch{ return false; }
}

function _fv_getBtnByIds(ids){
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el) return el;
  }
  return null;
}

function _fv_bindCloudButtonsV5(){
  // ‚òÅÔ∏è Ladda moln-bankar
  const btnLoad = _fv_getBtnByIds(["btnLoadCloudBanks","btnLoadCloudBanksV4","btnLoadCloudBanksV5"]);
  if (btnLoad && _fv_bindOnce(btnLoad, "loadCloudBanks")){
    btnLoad.addEventListener("click", async ()=>{
      try{
        await loadCloudBanksListV5();
        try{ if (typeof window.fvToast==="function") window.fvToast("‚òÅÔ∏è Moln-bankar laddade."); }catch{}
      }catch(e){
        console.error("loadCloudBanksListV5 error:", e);
        alert("Kunde inte ladda moln-bankar. Se konsolen.");
      }
    });
  }

  // üíæ Spara till moln (skapa ny/uppdatera)
  const btnSave = _fv_getBtnByIds(["btnSaveToCloud","btnSaveCloudBank","btnCloudSave","btnSaveToCloudV5"]);
  if (btnSave && _fv_bindOnce(btnSave, "saveToCloud")){
    btnSave.addEventListener("click", async ()=>{
      try{
        await handleSaveToCloudV5();
      }catch(e){
        console.error("handleSaveToCloudV5 error:", e);
        alert("Kunde inte spara till molnet. Se konsolen.");
      }
    });
  }

  // üîÑ Refresh l√§rar-UI (om du har en knapp ‚Äì valfritt)
  const btnRefresh = _fv_getBtnByIds(["btnTeacherRefresh","btnRefreshTeacher","btnRefreshUI"]);
  if (btnRefresh && _fv_bindOnce(btnRefresh, "teacherRefresh")){
    btnRefresh.addEventListener("click", async ()=>{
      try{
        fvRefreshTeacherBankUI();
        await tryRefreshRosterTabs(true);
        try{ if (typeof window._fvTeacherForceLiveRefresh==="function") await window._fvTeacherForceLiveRefresh(); }catch{}
        try{ if (typeof window.fvToast==="function") window.fvToast("üîÑ Uppdaterat l√§rarvy."); }catch{}
      }catch(e){
        console.warn("Teacher refresh error:", e);
      }
    });
  }
}

async function _fv_bootTeacherUI(){
  try{ await initFirebase(); }catch{}
  try{ _fv_bindCloudButtonsV5(); }catch{}
  try{ fvRefreshTeacherBankUI(); }catch{}
  try{ await loadCloudBanksListV5(); }catch{}
  try{ await tryRefreshRosterTabs(true); }catch{}
  try{
    const sel = _fv_getSelectedToken();
    if (sel) _fv_startLiveStudent(sel);
  }catch{}
  tryUpdateProgressUI();
}

/* K√∂r boot efter initApp, men ocks√• s√§kert efter DOMContentLoaded */
(function _fv_teacherBootRunner(){
  let ran = false;

  const run = async ()=>{
    if (ran) return;
    ran = true;
    await _fv_bootTeacherUI();
  };

  // Om initApp finns, f√∂rs√∂k haka efter den (utan att √§ndra initApp)
  try{
    if (!window.__fvHookedInitApp && typeof window.initApp === "function"){
      window.__fvHookedInitApp = true;
      const _orig = window.initApp;
      window.initApp = async function(){
        const res = await _orig.apply(this, arguments);
        try{ await run(); }catch{}
        return res;
      };
    }
  }catch{}

  // Backup: DOMContentLoaded + liten delay
  try{
    document.addEventListener("DOMContentLoaded", ()=>{
      setTimeout(()=>{ run(); }, 200);
    });
  }catch{}

  // Backup 2: om sidan redan √§r laddad
  try{
    if (document.readyState === "complete" || document.readyState === "interactive"){
      setTimeout(()=>{ run(); }, 250);
    }
  }catch{}
})();

/* slut Sektion 3G: INIT & KNAPP-KOPPLINGAR (bind molnknappar + auto-refresh teacher UI) */








/* start Sektion 3H: LIVE-UPPDATERING (onSnapshot) + FIX: sl√• ihop ‚Äúlegacy link-id‚Äù till riktiga goalsMap-id */

let _fvLiveUnsubStudent = null;

function _fv_stopLiveStudent(){
  try{
    if (typeof _fvLiveUnsubStudent === "function") _fvLiveUnsubStudent();
  }catch{}
  _fvLiveUnsubStudent = null;
}

function _fv_startLiveStudent(token){
  try{
    _fv_stopLiveStudent();

    const t = String(token||"").trim();
    if (!t) return;

    const ref = _fv_getActiveStudentsCollectionRef();
    if (!ref) return;

    _fvLiveUnsubStudent = ref.doc(t).onSnapshot((snap)=>{
      try{
        if (!snap || !snap.exists){
          delete _fvTeacherStudentCache[t];
          tryUpdateProgressUI();
          return;
        }
        const d0 = snap.data() || {};
        const d = _fv_normalizeDottedProgressionIntoObject(d0) || d0;

        d._token = t;
        d._fetchedAt = Date.now();

        _fvTeacherStudentCache[t] = d;

        tryUpdateProgressUI();
      }catch(e){
        console.warn("Live snapshot parse error:", e);
      }
    }, (err)=>{
      console.warn("Live snapshot error:", err);
      _fvTeacherStudentCache[t] = { _token:t, _error:"permissions", _fetchedAt: Date.now() };
      tryUpdateProgressUI();
    });
  }catch(e){
    console.warn("Kunde inte starta live-lyssnare:", e);
  }
}

/* FIX: mappa/merge ‚Äúlegacy link-id‚Äù (fr√•n question.links[].id) till goalsMap-id via (goal+parts) */
function _fv_buildLegacyLinkIdMap(goalsMap, bank){
  const gm = Array.isArray(goalsMap) ? goalsMap : [];
  const b = bank || {};

  const byGoalParts = Object.create(null);
  for (let i=0;i<gm.length;i++){
    const g = gm[i] || {};
    const goal = String(g.goal||"").trim();
    const parts = String(g.parts||g.part||"").trim();
    const id = String(g.id||"").trim();
    if (!id || !goal || !parts) continue;
    byGoalParts[goal + "||" + parts] = id;
  }

  const map = Object.create(null);
  const lists = [
    Array.isArray(b.mcq) ? b.mcq : [],
    Array.isArray(b.img) ? b.img : [],
    Array.isArray(b.drag) ? b.drag : []
  ];

  for (let li=0; li<lists.length; li++){
    const arr = lists[li];
    for (let i=0;i<arr.length;i++){
      const q = arr[i] || {};
      const links = Array.isArray(q.links) ? q.links : [];
      for (let k=0;k<links.length;k++){
        const L = links[k] || {};
        const legacyId = String(L.id||"").trim();
        const goal = String(L.goal||"").trim();
        const parts = String(L.parts||"").trim();
        if (!legacyId || !goal || !parts) continue;

        const key = goal + "||" + parts;
        const realId = byGoalParts[key];
        if (realId) map[legacyId] = realId;
      }
    }
  }

  return map;
}

function _fv_mergeLegacyIdsIntoMaps(goalsMap, bank, corr, wrong){
  const c0 = (corr && typeof corr==="object") ? corr : {};
  const w0 = (wrong && typeof wrong==="object") ? wrong : {};

  const legacyToReal = _fv_buildLegacyLinkIdMap(goalsMap, bank);

  // kopiera s√• vi inte muterar input
  const c = Object.assign({}, c0);
  const w = Object.assign({}, w0);

  const keys = new Set();
  Object.keys(c).forEach(k=>keys.add(String(k)));
  Object.keys(w).forEach(k=>keys.add(String(k)));

  keys.forEach((k)=>{
    const real = legacyToReal[String(k)] || "";
    if (!real || real === String(k)) return;

    const cc = _fv_safeNum(c[k],0);
    const ww = _fv_safeNum(w[k],0);

    c[real] = _fv_safeNum(c[real],0) + cc;
    w[real] = _fv_safeNum(w[real],0) + ww;

    // ta bort legacy-nyckeln s√• dubletter f√∂rsvinner i UI
    delete c[k];
    delete w[k];
  });

  return { corr: c, wrong: w };
}

/* PATCH: anv√§nd merge i computeStrongWeak s√• UI inte visar dubletter (1 + 176...) */
(function FV3H_PatchStrongWeak(){
  if (typeof _fv_computeStrongWeak !== "function") return;
  if (_fv_computeStrongWeak.__fvPatchedLegacy) return;
  _fv_computeStrongWeak.__fvPatchedLegacy = true;

  const _orig = _fv_computeStrongWeak;
  _fv_computeStrongWeak = function(goalsMap, prog, bank){
    try{
      const corr0 = (prog && prog.correctByGoalId) ? prog.correctByGoalId : {};
      const wrong0 = (prog && prog.wrongByGoalId) ? prog.wrongByGoalId : {};
      const merged = _fv_mergeLegacyIdsIntoMaps(goalsMap, bank, corr0, wrong0);

      const p2 = Object.assign({}, prog || {});
      p2.correctByGoalId = merged.corr;
      p2.wrongByGoalId = merged.wrong;

      return _orig(goalsMap, p2, bank);
    }catch(e){
      console.warn("Legacy-merge patch fail:", e);
      return _orig(goalsMap, prog, bank);
    }
  };
})();

/* PATCH: starta live-lyssnare n√§r man v√§ljer elev + vid refresh roster */
(function FV3H_PatchSelectToken(){
  if (typeof trySelectStudentToken !== "function") return;
  if (trySelectStudentToken.__fvPatchedLive) return;
  trySelectStudentToken.__fvPatchedLive = true;

  const _orig = trySelectStudentToken;
  window.trySelectStudentToken = async function(token){
    const res = await _orig.apply(this, arguments);
    try{
      const t = _fv_getSelectedToken();
      if (t) _fv_startLiveStudent(t);
    }catch{}
    return res;
  };
})();

(function FV3H_PatchRefreshRoster(){
  if (typeof tryRefreshRosterTabs !== "function") return;
  if (tryRefreshRosterTabs.__fvPatchedLive) return;
  tryRefreshRosterTabs.__fvPatchedLive = true;

  const _orig = tryRefreshRosterTabs;
  window.tryRefreshRosterTabs = async function(){
    const res = await _orig.apply(this, arguments);
    try{
      const t = _fv_getSelectedToken();
      if (t) _fv_startLiveStudent(t);
    }catch{}
    return res;
  };
})();

/* Exponera tvingad refresh (anv√§nds av 3G) */
async function _fvTeacherForceLiveRefresh(){
  try{
    const t = _fv_getSelectedToken();
    if (!t) return false;
    const d = await _fv_fetchStudentDoc(t);
    if (d) _fvTeacherStudentCache[t] = d;
    tryUpdateProgressUI();
    return true;
  }catch{
    return false;
  }
}
try{ window._fvTeacherForceLiveRefresh = _fvTeacherForceLiveRefresh; }catch{}

/* slut Sektion 3H: LIVE-UPPDATERING (onSnapshot) + FIX: sl√• ihop ‚Äúlegacy link-id‚Äù till riktiga goalsMap-id */


/* start Sektion 3I: L√ÑRARINST√ÑLLNINGAR (bekr√§ftelser + ‚ÄúAktuella delm√•l/delbitar‚Äù rutor + delete + rebuild) */

function _fv_findTeacherSettingsHost(){
  const ids = [
    "teacherSettings",
    "teacherSettingsCard",
    "teacherPanel",
    "teacherTab",
    "teacherTabContent",
    "tab-teacher",
    "teacher-mode",
    "teacherView"
  ];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el) return el;
  }
  // fallback: f√∂rs√∂k hitta en rimlig ‚ÄúInst√§llningar‚Äù-sektion
  const cand = document.querySelector('[data-tab="teacher"]') || document.querySelector('[id*="teacher"][class*="card"]');
  return cand || null;
}

function _fv_ensureTeacherStatusLine(){
  const host = _fv_findTeacherSettingsHost() || document.body;
  let el = _fv_getEl("fvTeacherSettingsStatus");
  if (el) return el;

  el = document.createElement("div");
  el.id = "fvTeacherSettingsStatus";
  el.className = "mini";
  el.style.marginTop = "8px";
  el.style.opacity = ".92";
  el.textContent = "";

  // f√∂rs√∂k l√§gga n√§ra befintliga knappar i l√§rarvyn
  const anchors = [
    _fv_getEl("btnSaveTeacherSettings"),
    _fv_getEl("btnTeacherSave"),
    _fv_getEl("btnSaveSettings"),
    _fv_getEl("btnSaveToCloud"),
    _fv_getEl("btnLoadCloudBanks")
  ].filter(Boolean);

  if (anchors[0] && anchors[0].parentElement){
    anchors[0].parentElement.appendChild(el);
  }else{
    host.appendChild(el);
  }

  return el;
}

function _fv_teacherToast(msg){
  const el = _fv_ensureTeacherStatusLine();
  if (!el) return;
  el.textContent = String(msg || "");
  try{
    el.style.color = "var(--text)";
    clearTimeout(el.__fvT);
    el.__fvT = setTimeout(()=>{ try{ el.textContent = ""; }catch{} }, 2500);
  }catch{}
}

/* --------- BEKR√ÑFTELSE: E-POST --------- */
function _fv_getTeacherEmailInput(){
  const ids = ["teacherEmail","inputTeacherEmail","txtTeacherEmail","emailTeacher","teacherMail"];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el && (el.tagName||"").toLowerCase()==="input") return el;
  }
  // fallback: hitta f√∂rsta input[type=email] i teacher-host
  const host = _fv_findTeacherSettingsHost();
  const cand = host ? host.querySelector('input[type="email"]') : document.querySelector('input[type="email"]');
  return cand || null;
}

function _fv_bindTeacherEmailConfirm(){
  const inp = _fv_getTeacherEmailInput();
  if (!inp || inp.__fvBoundEmailConfirm) return;
  inp.__fvBoundEmailConfirm = true;

  const saveEmail = ()=>{
    const s = loadState();
    const v = String(inp.value||"").trim();
    s.teacherEmail = v;
    saveState(s);
    if (v) _fv_teacherToast(`‚úÖ E-post sparad: ${v}`);
    else _fv_teacherToast("‚úÖ E-post rensad.");
  };

  inp.addEventListener("change", saveEmail);
  inp.addEventListener("blur", saveEmail);
}

/* --------- BEKR√ÑFTELSE: NIV√Ö/% --------- */
/* Vi f√∂rs√∂ker st√∂dja olika id-namn f√∂r tr√∂sklar: thresE/thresC/thresA, thresholdE... */
function _fv_findThresholdInput(level){
  const L = String(level||"").toUpperCase();
  const ids = [
    `thres${L}`, `threshold${L}`, `inputThres${L}`, `inputThreshold${L}`,
    `${L}Threshold`, `${L}Thres`, `percent${L}`, `pct${L}`
  ];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el && (el.tagName||"").toLowerCase()==="input") return el;
  }
  return null;
}

function _fv_bindThresholdConfirm(){
  const bindOne = (L)=>{
    const el = _fv_findThresholdInput(L);
    if (!el || el.__fvBoundThres) return;
    el.__fvBoundThres = true;

    const save = ()=>{
      const raw = String(el.value||"").trim();
      const n = Number(raw);
      if (!isFinite(n)) { _fv_teacherToast(`‚ö†Ô∏è Ogiltigt v√§rde f√∂r niv√• ${L}.`); return; }

      const s = loadState();
      s.thres = s.thres && typeof s.thres==="object" ? s.thres : { E:70, C:70, A:70 };
      s.thres[L] = n;
      saveState(s);
      _fv_teacherToast(`‚úÖ Niv√• ${L} sparad: ${n}%`);
    };

    el.addEventListener("change", save);
    el.addEventListener("blur", save);
  };

  bindOne("E"); bindOne("C"); bindOne("A");
}

/* --------- AKTUELLA DELM√ÖL/DELBITAR: RUTOR + DELETE --------- */

function _fv_getGoalsEditorHost(){
  // Prioritet: om du redan har en yta i ‚ÄúInst√§llningar‚Äù
  const ids = [
    "currentGoalsBox",
    "currentGoalsList",
    "goalsMapBox",
    "goalsMapView",
    "teacherGoalsMap",
    "teacherGoals"
  ];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el) return el;
  }

  // annars skapar vi en egen box i teacher-host
  let host = _fv_getEl("fvTeacherGoalsEditorHost");
  if (host) return host;

  const teacherHost = _fv_findTeacherSettingsHost() || document.body;
  host = document.createElement("div");
  host.id = "fvTeacherGoalsEditorHost";
  host.className = "card";
  host.style.marginTop = "10px";
  host.innerHTML = `
    <div class="q-text">Aktuella delm√•l och delbitar</div>
    <div class="mini" style="margin-top:4px; opacity:.9">
      Varje delm√•l visas i en egen ruta. Varje delbit har egen ruta och kan tas bort.
    </div>
    <div id="fvTeacherGoalsEditorActions" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
      <button class="btn btn-sm" type="button" id="fvGoalsRebuildFromLinks">üß© Bygg om fr√•n banken (links)</button>
      <button class="btn btn-sm btn-danger" type="button" id="fvGoalsClearAll">üóëÔ∏è Rensa alla delbitar</button>
    </div>
    <div id="fvTeacherGoalsEditorList" style="margin-top:10px"></div>
  `;
  teacherHost.appendChild(host);
  return host;
}

function _fv_groupGoalsMap(goalsMap){
  const gm = Array.isArray(goalsMap) ? goalsMap : [];
  const groups = Object.create(null);

  for (let i=0;i<gm.length;i++){
    const g = gm[i] || {};
    const goal = String(g.goal||"").trim() || "(saknar delm√•l)";
    const id = String(g.id||"").trim();
    const parts = String(g.parts||g.part||"").trim() || "(saknar delbit-text)";

    if (!groups[goal]) groups[goal] = [];
    groups[goal].push({ id, goal, parts });
  }

  // sortera delbitar numeriskt om m√∂jligt
  Object.keys(groups).forEach((k)=>{
    groups[k].sort((a,b)=>{
      const ai = Number(a.id), bi = Number(b.id);
      const an = isFinite(ai), bn = isFinite(bi);
      if (an && bn) return ai-bi;
      return String(a.id).localeCompare(String(b.id));
    });
  });

  return groups;
}

function _fv_removeGoalPartById(id){
  const s = loadState();
  s.goalsMap = Array.isArray(s.goalsMap) ? s.goalsMap : [];
  const before = s.goalsMap.length;
  s.goalsMap = s.goalsMap.filter(x=> String((x && x.id)||"") !== String(id));
  saveState(s);
  const after = s.goalsMap.length;
  _fv_teacherToast(`‚úÖ Delbit borttagen. (${before-after} st)`);
}

function _fv_removeWholeGoal(goalTitle){
  const g = String(goalTitle||"").trim();
  const s = loadState();
  s.goalsMap = Array.isArray(s.goalsMap) ? s.goalsMap : [];
  const before = s.goalsMap.length;
  s.goalsMap = s.goalsMap.filter(x=> String((x && x.goal)||"").trim() !== g);
  saveState(s);
  const after = s.goalsMap.length;
  _fv_teacherToast(`‚úÖ Delm√•l borttaget. (${before-after} delbitar)`);
}

function _fv_clearAllGoalsMap(){
  const s = loadState();
  s.goalsMap = [];
  saveState(s);
  _fv_teacherToast("‚úÖ Alla delbitar rensade.");
}

/* Bygger ny goalsMap fr√•n bankens links (unik goal+parts). Ger nya id:n 1..N. */
function _fv_rebuildGoalsMapFromBankLinks(){
  const s = loadState();
  const b = _fv_ensureBankShape(s.bank || {});
  const lists = [b.mcq||[], b.img||[], b.drag||[]];

  const seen = new Set();
  const out = [];

  for (let li=0; li<lists.length; li++){
    const arr = lists[li];
    for (let i=0;i<arr.length;i++){
      const q = arr[i] || {};
      const links = Array.isArray(q.links) ? q.links : [];
      for (let k=0;k<links.length;k++){
        const L = links[k] || {};
        const goal = String(L.goal||"").trim();
        const parts = String(L.parts||"").trim();
        if (!goal || !parts) continue;
        const key = goal + "||" + parts;
        if (seen.has(key)) continue;
        seen.add(key);
        out.push({ goal, parts });
      }
    }
  }

  // sortera stabilt
  out.sort((a,b)=> (String(a.goal).localeCompare(String(b.goal)) || String(a.parts).localeCompare(String(b.parts))));

  // tilldela id 1..N
  const gm = out.map((x, idx)=>({ id: String(idx+1), goal: x.goal, parts: x.parts }));

  s.goalsMap = gm;
  saveState(s);

  _fv_teacherToast(`‚úÖ goalsMap ombyggd fr√•n bankens links: ${gm.length} delbitar.`);
}

function _fv_renderTeacherGoalsEditor(){
  const host = _fv_getGoalsEditorHost();
  if (!host) return;

  const listHost =
    _fv_getEl("fvTeacherGoalsEditorList") ||
    _fv_getEl("fvTeacherGoalsList") ||
    host.querySelector("#fvTeacherGoalsEditorList");

  if (!listHost) return;

  const s = loadState();
  const groups = _fv_groupGoalsMap(s.goalsMap || []);
  const goals = Object.keys(groups);

  listHost.innerHTML = "";

  if (!goals.length){
    const empty = document.createElement("div");
    empty.className = "mini";
    empty.textContent = "Inga delm√•l/delbitar sparade √§nnu.";
    listHost.appendChild(empty);
    return;
  }

  for (let gi=0; gi<goals.length; gi++){
    const goalTitle = goals[gi];
    const box = document.createElement("div");
    box.className = "card";
    box.style.marginTop = "10px";

    const header = document.createElement("div");
    header.style.display = "flex";
    header.style.gap = "10px";
    header.style.alignItems = "center";
    header.style.justifyContent = "space-between";
    header.style.flexWrap = "wrap";

    header.innerHTML = `
      <div>
        <div class="q-text">${_fv_escapeHtml(goalTitle)}</div>
        <div class="mini">${groups[goalTitle].length} delbitar</div>
      </div>
      <div class="fv3-actions">
        <button class="btn btn-sm btn-danger" type="button" data-fv-goal-del="${_fv_escapeHtml(goalTitle)}">Ta bort delm√•l</button>
      </div>
    `;

    box.appendChild(header);

    const grid = document.createElement("div");
    grid.style.display = "grid";
    grid.style.gridTemplateColumns = "repeat(auto-fit, minmax(260px, 1fr))";
    grid.style.gap = "8px";
    grid.style.marginTop = "10px";

    const bits = groups[goalTitle] || [];
    for (let bi=0; bi<bits.length; bi++){
      const it = bits[bi];
      const bit = document.createElement("div");
      bit.className = "card";
      bit.style.padding = "10px";
      bit.innerHTML = `
        <div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between;">
          <div style="min-width:0">
            <div class="mini" style="opacity:.85">Delbit ${_fv_escapeHtml(it.id || "?")}</div>
            <div style="margin-top:4px; line-height:1.25">${_fv_escapeHtml(it.parts)}</div>
          </div>
          <div style="flex:0 0 auto">
            <button class="btn btn-sm btn-danger" type="button" data-fv-part-del="${_fv_escapeHtml(it.id)}">Delete</button>
          </div>
        </div>
      `;
      grid.appendChild(bit);
    }

    box.appendChild(grid);
    listHost.appendChild(box);
  }

  // bind delete (delegation)
  if (!listHost.__fvGoalsBound){
    listHost.__fvGoalsBound = true;

    listHost.addEventListener("click", (ev)=>{
      const t = ev.target;
      if (!t || !t.closest) return;

      const partBtn = t.closest("button[data-fv-part-del]");
      if (partBtn){
        const id = String(partBtn.getAttribute("data-fv-part-del")||"").trim();
        if (!id) return;
        if (!confirm(`Ta bort delbit ${id}?`)) return;
        _fv_removeGoalPartById(id);
        _fv_renderTeacherGoalsEditor();
        try{ fvRefreshTeacherBankUI(); }catch{}
        return;
      }

      const goalBtn = t.closest("button[data-fv-goal-del]");
      if (goalBtn){
        const goal = String(goalBtn.getAttribute("data-fv-goal-del")||"").trim();
        if (!goal) return;
        if (!confirm(`Ta bort hela delm√•let?\n\n${goal}`)) return;
        _fv_removeWholeGoal(goal);
        _fv_renderTeacherGoalsEditor();
        try{ fvRefreshTeacherBankUI(); }catch{}
        return;
      }
    }, true);
  }

  // bind actions
  const btnRebuild = _fv_getEl("fvGoalsRebuildFromLinks");
  const btnClear = _fv_getEl("fvGoalsClearAll");

  if (btnRebuild && !btnRebuild.__fvBound){
    btnRebuild.__fvBound = true;
    btnRebuild.addEventListener("click", ()=>{
      if (!confirm("Bygg om goalsMap fr√•n bankens links?\nDetta rensar nuvarande delbitar och skapar en ny lista.")) return;
      _fv_rebuildGoalsMapFromBankLinks();
      _fv_renderTeacherGoalsEditor();
      try{ fvRefreshTeacherBankUI(); }catch{}
    });
  }

  if (btnClear && !btnClear.__fvBound){
    btnClear.__fvBound = true;
    btnClear.addEventListener("click", ()=>{
      if (!confirm("Rensa ALLA delbitar? (Kan inte √•ngras)")) return;
      _fv_clearAllGoalsMap();
      _fv_renderTeacherGoalsEditor();
      try{ fvRefreshTeacherBankUI(); }catch{}
    });
  }
}

/* Auto-init n√§r appen √§r ig√•ng */
(function FV3I_InitTeacherSettings(){
  try{ _fv_bindTeacherEmailConfirm(); }catch{}
  try{ _fv_bindThresholdConfirm(); }catch{}
  try{ _fv_renderTeacherGoalsEditor(); }catch{}

  // uppdatera n√§r bank byts / laddas
  try{
    if (!window.__fvTeacherGoalsHooks){
      window.__fvTeacherGoalsHooks = true;
      window.addEventListener("fv-bank-changed", ()=>{
        try{ _fv_bindTeacherEmailConfirm(); }catch{}
        try{ _fv_bindThresholdConfirm(); }catch{}
        try{ _fv_renderTeacherGoalsEditor(); }catch{}
      });
    }
  }catch{}
})();

/* slut Sektion 3I: L√ÑRARINST√ÑLLNINGAR (bekr√§ftelser + ‚ÄúAktuella delm√•l/delbitar‚Äù rutor + delete + rebuild) */





</script>
<!-- slut SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker, roster, progression, editor-refresh) -->





<!-- start SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->
<script>
"use strict";

/* start Sektion 4A: Globala spelvariabler */
let currentLevel = null;
let currentQuestions = [];
let currentAnswers = [];
let lastSubmission = null;
/* slut Sektion 4A: Globala spelvariabler */





/* start Sektion 4B: Fallbacks + helpers (kraschskydd) */
const _fv4_getEl = (typeof window.getEl === "function") ? window.getEl : (id) => document.getElementById(id);

const _fv4_loadState = (typeof window.loadState === "function") ? window.loadState : function(){
  try{
    const key = (typeof window.STORAGE_KEY === "string" && window.STORAGE_KEY) ? window.STORAGE_KEY : "fangvaktaren-v17";
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : {};
  }catch(e){ return {}; }
};

const _fv4_saveState = (typeof window.saveState === "function") ? window.saveState : function(s){
  try{
    const key = (typeof window.STORAGE_KEY === "string" && window.STORAGE_KEY) ? window.STORAGE_KEY : "fangvaktaren-v17";
    localStorage.setItem(key, JSON.stringify(s || {}));
  }catch(e){}
};

const _fv4_escapeHtml = (typeof window._fv_escapeHtml === "function")
  ? window._fv_escapeHtml
  : function(x){
      const s = (x == null) ? "" : String(x);
      return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    };

function _fv4_shuffle(arr){
  const a = Array.isArray(arr) ? arr.slice() : [];
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    const t = a[i]; a[i] = a[j]; a[j] = t;
  }
  return a;
}

function _fv4_ensureBankShape(bank){
  const b = (bank && typeof bank === "object") ? bank : {};
  if (!Array.isArray(b.mcq)) b.mcq = [];
  if (!Array.isArray(b.img)) b.img = [];
  if (!Array.isArray(b.drag)) b.drag = [];
  return b;
}

function _fv4_nowIso(){ return new Date().toISOString(); }

function _fv4_levelOf(q){
  const lv = String((q && (q.level || q.lv || q.niva || q.grade)) || "E").toUpperCase().trim();
  return (lv === "E" || lv === "C" || lv === "A") ? lv : "E";
}

function _fv4_typeOf(q){
  const t = String((q && (q.type || q.kind)) || "mcq").toLowerCase();
  return (t === "mcq" || t === "img" || t === "drag") ? t : "mcq";
}

function _fv4_getQuestionText(q){
  return String((q && (q.q || q.question || q.text || q.prompt || q.instruction)) || "").trim();
}

function _fv4_getImgSrc(q){
  const cand = [
    q && q.imgDataUrl, q && q.imgData, q && q.img, q && q.image, q && q.dataUrl, q && q.url, q && q.src, q && q.fileData
  ];
  for (let i=0;i<cand.length;i++){
    const s = (cand[i] == null) ? "" : String(cand[i]).trim();
    if (s && (s.startsWith("data:image/") || s.startsWith("http") || s.startsWith("blob:"))) return s;
  }
  return "";
}

function _fv4_getGoalPartIdFromQuestion(q){
  const cand = [
    q && q.goalPart, q && q.goalpart, q && q.goalPartId, q && q.goalId,
    q && q.goalPartKey, q && q.goalPartRef, q && q.goalPartValue
  ];
  for (let i=0;i<cand.length;i++){
    const v = cand[i];
    if (v == null) continue;
    const s = String(v).trim();
    if (s) return s;
  }
  return "";
}

/* =========================
   A+B: Recent + Trend (EMA)
   ========================= */
const _fv4_RECENT_N = 12;         // A: senaste N f√∂rs√∂k per delbit+niv√•
const _fv4_RECENT_MIN = 3;        // A: minst s√• m√•nga datapunkter kr√§vs f√∂r att f√• styra
const _fv4_DECAY_ALPHA = 0.85;    // B: trend-signal (EMA). H√∂gre = tr√∂gare.

function _fv4_ensureRecentAndDecayShape(prog){
  if (!prog || typeof prog !== "object") prog = {};

  if (!prog.recentByGoalLevel || typeof prog.recentByGoalLevel !== "object"){
    prog.recentByGoalLevel = { E:{}, C:{}, A:{} };
  }
  if (!prog.recentByGoalLevel.E) prog.recentByGoalLevel.E = {};
  if (!prog.recentByGoalLevel.C) prog.recentByGoalLevel.C = {};
  if (!prog.recentByGoalLevel.A) prog.recentByGoalLevel.A = {};

  if (!prog.decayByGoalLevel || typeof prog.decayByGoalLevel !== "object"){
    prog.decayByGoalLevel = { E:{}, C:{}, A:{} };
  }
  if (!prog.decayByGoalLevel.E) prog.decayByGoalLevel.E = {};
  if (!prog.decayByGoalLevel.C) prog.decayByGoalLevel.C = {};
  if (!prog.decayByGoalLevel.A) prog.decayByGoalLevel.A = {};

  if (!prog.decayCountByGoalLevel || typeof prog.decayCountByGoalLevel !== "object"){
    prog.decayCountByGoalLevel = { E:{}, C:{}, A:{} };
  }
  if (!prog.decayCountByGoalLevel.E) prog.decayCountByGoalLevel.E = {};
  if (!prog.decayCountByGoalLevel.C) prog.decayCountByGoalLevel.C = {};
  if (!prog.decayCountByGoalLevel.A) prog.decayCountByGoalLevel.A = {};

  return prog;
}

function _fv4_pushRecent(prog, lvl, goalId, isCorrect, N){
  const L = String(lvl||"E").toUpperCase();
  const key = String(goalId||"").trim();
  if (!key) return;

  _fv4_ensureRecentAndDecayShape(prog);

  const bucket = prog.recentByGoalLevel[L] || (prog.recentByGoalLevel[L] = {});
  let arr = bucket[key];
  if (!Array.isArray(arr)) arr = bucket[key] = [];

  arr.push(isCorrect ? 1 : 0);

  const maxN = (typeof N === "number" && isFinite(N) && N > 0) ? Math.floor(N) : _fv4_RECENT_N;
  while (arr.length > maxN) arr.shift();
}

function _fv4_updateDecay(prog, lvl, goalId, isCorrect){
  const L = String(lvl||"E").toUpperCase();
  const key = String(goalId||"").trim();
  if (!key) return;

  _fv4_ensureRecentAndDecayShape(prog);

  const bucket = prog.decayByGoalLevel[L] || (prog.decayByGoalLevel[L] = {});
  const cntBucket = prog.decayCountByGoalLevel[L] || (prog.decayCountByGoalLevel[L] = {});

  const prev = (typeof bucket[key] === "number" && isFinite(bucket[key])) ? bucket[key] : null;
  const x = isCorrect ? 1 : 0;
  const next = (prev == null) ? x : (prev * _fv4_DECAY_ALPHA + x * (1 - _fv4_DECAY_ALPHA));

  bucket[key] = next;
  cntBucket[key] = (typeof cntBucket[key] === "number" && isFinite(cntBucket[key])) ? (cntBucket[key] + 1) : 1;
}

function _fv4_getRecentStats(prog, lvl, goalId){
  const L = String(lvl||"E").toUpperCase();
  const key = String(goalId||"").trim();
  if (!key) return { n:0, correct:0, acc:0 };

  prog = _fv4_ensureRecentAndDecayShape(prog);

  const bucket = prog.recentByGoalLevel[L] || {};
  const arr = Array.isArray(bucket[key]) ? bucket[key] : [];
  let c = 0;
  for (let i=0;i<arr.length;i++) c += (Number(arr[i]) === 1 ? 1 : 0);
  const n = arr.length;
  const acc = n ? (c / n) : 0;
  return { n, correct:c, acc };
}

function _fv4_getDecaySignal(prog, lvl, goalId){
  const L = String(lvl||"E").toUpperCase();
  const key = String(goalId||"").trim();
  if (!key) return { ema:null, n:0 };

  prog = _fv4_ensureRecentAndDecayShape(prog);

  const bucket = prog.decayByGoalLevel[L] || {};
  const cntBucket = prog.decayCountByGoalLevel[L] || {};
  const ema = (typeof bucket[key] === "number" && isFinite(bucket[key])) ? bucket[key] : null;
  const n = (typeof cntBucket[key] === "number" && isFinite(cntBucket[key])) ? cntBucket[key] : 0;
  return { ema, n };
}

function _fv4_ensureProgressionShape(s){
  if (!s || typeof s !== "object") s = {};
  if (!s.progression || typeof s.progression !== "object") s.progression = {};
  const p = s.progression;

  if (typeof p.totalPoints !== "number") p.totalPoints = 0;
  if (!p.lastResult || typeof p.lastResult !== "object") p.lastResult = null;

  if (!p.wrongByGoalId || typeof p.wrongByGoalId !== "object") p.wrongByGoalId = {};
  if (!p.correctByGoalId || typeof p.correctByGoalId !== "object") p.correctByGoalId = {};

  // C: per niv√• totals (E/C/A)
  if (!p.wrongByGoalLevel || typeof p.wrongByGoalLevel !== "object") p.wrongByGoalLevel = { E:{}, C:{}, A:{} };
  if (!p.correctByGoalLevel || typeof p.correctByGoalLevel !== "object") p.correctByGoalLevel = { E:{}, C:{}, A:{} };
  if (!p.wrongByGoalLevel.E) p.wrongByGoalLevel.E = {};
  if (!p.wrongByGoalLevel.C) p.wrongByGoalLevel.C = {};
  if (!p.wrongByGoalLevel.A) p.wrongByGoalLevel.A = {};
  if (!p.correctByGoalLevel.E) p.correctByGoalLevel.E = {};
  if (!p.correctByGoalLevel.C) p.correctByGoalLevel.C = {};
  if (!p.correctByGoalLevel.A) p.correctByGoalLevel.A = {};

  // A+B: recent + trend-signal
  _fv4_ensureRecentAndDecayShape(p);

  return s;
}

function _fv4_getThresholds(s){
  const th = (s && s.thres && typeof s.thres === "object") ? s.thres : {};
  return {
    E: (typeof th.E === "number" ? th.E : 70),
    C: (typeof th.C === "number" ? th.C : 70),
    A: (typeof th.A === "number" ? th.A : 70)
  };
}

function ensureStudentSet(){
  const s = _fv4_loadState();
  if (!s.student || typeof s.student !== "object") s.student = { name:"", klass:"" };
  if (!s.student.name || !s.student.klass){
    alert("Skriv in namn och klass och spara eleven f√∂rst.");
    return false;
  }
  return true;
}
/* slut Sektion 4B: Fallbacks + helpers (kraschskydd) */








/* start Sektion 4C: Delm√•l/delbitar (goalsMap) ‚Äì spara + rendera rubrik/underrubrik */
function normalizeGoalsMap(s){
  if (!s) return [];
  const raw =
    (Array.isArray(s.goalsMap) && s.goalsMap) ||
    (s.bank && Array.isArray(s.bank.goalsMap) && s.bank.goalsMap) ||
    (s.bank && s.bank.meta && Array.isArray(s.bank.meta.goalsMap) && s.bank.meta.goalsMap) ||
    [];

  const out = [];
  raw.forEach((g, i) => {
    if (!g) return;

    const id =
      (g.id != null ? String(g.id) : null) ||
      (g.partId != null ? String(g.partId) : null) ||
      (g.delbit != null ? String(g.delbit) : null) ||
      String(i + 1);

    const goal =
      (g.goal != null ? String(g.goal) : null) ||
      (g.goalTitle != null ? String(g.goalTitle) : null) ||
      (g.delmal != null ? String(g.delmal) : null) ||
      "";

    const part =
      (g.part != null ? String(g.part) : null) ||
      (g.partText != null ? String(g.partText) : null) ||
      (g.text != null ? String(g.text) : null) ||
      (g.delbitText != null ? String(g.delbitText) : null) ||
      "";

    out.push({ id: String(id).trim(), goal: String(goal || "").trim(), part: String(part || "").trim() });
  });
  return out;
}

function _fv4_nextGoalId(goals){
  let maxId = 0;
  for (let i=0;i<goals.length;i++){
    const n = Number(goals[i] && goals[i].id);
    if (isFinite(n) && n > maxId) maxId = n;
  }
  return String(maxId + 1);
}

function _fv4_groupGoals(goals){
  const groups = new Map(); // goalTitle -> array of entries
  for (let i=0;i<goals.length;i++){
    const g = goals[i];
    const key = (g.goal || "").trim() || "Delm√•l";
    if (!groups.has(key)) groups.set(key, []);
    groups.get(key).push(g);
  }
  // stabil ordning: som inmatat
  return Array.from(groups.entries()).map(([goalTitle, items]) => ({ goalTitle, items }));
}

function renderGoalsListAndSelects(){
  const s = _fv4_loadState();
  const goals = normalizeGoalsMap(s);

  // Lista i Inst√§llningar (rubrik=delm√•l, underrubrik=delbit)
  const listEl = _fv4_getEl("goalsList");
  if (listEl){
    listEl.innerHTML = "";
    if (!goals.length){
      const li = document.createElement("li");
      li.textContent = "Inga delm√•l/delbitar sparade √§nnu.";
      listEl.appendChild(li);
    }else{
      const grouped = _fv4_groupGoals(goals);
      grouped.forEach((grp) => {
        // rubrik
        const liH = document.createElement("li");
        liH.innerHTML = `<div style="font-weight:700;">${_fv4_escapeHtml(grp.goalTitle)}</div>`;
        listEl.appendChild(liH);

        // underrubriker
        grp.items.forEach((it) => {
          const li = document.createElement("li");
          const partTxt = it.part ? it.part : "(ingen delbit-text)";
          li.innerHTML = `<div class="mini" style="opacity:.95;">Delbit ${_fv4_escapeHtml(it.id)}: ${_fv4_escapeHtml(partTxt)}</div>`;
          listEl.appendChild(li);
        });
      });
    }
  }

  // Selects i editorerna (beh√•ll v√§rde)
  const selectIds = ["mcqGoalPart", "imgGoalPart", "dragGoalPart", "mcqJsonGoalPart"];
  selectIds.forEach((id) => {
    const sel = _fv4_getEl(id);
    if (!sel) return;

    const keepValue = sel.value || "";
    sel.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Ingen koppling";
    sel.appendChild(opt0);

    goals.forEach((g) => {
      const opt = document.createElement("option");
      opt.value = String(g.id);

      const goalTxt = (g.goal || "").trim();
      const partTxt = (g.part || "").trim();

      opt.textContent = goalTxt && partTxt
        ? `Delbit ${g.id}: ${goalTxt} ‚Äì ${partTxt}`
        : goalTxt
          ? `Delbit ${g.id}: ${goalTxt}`
          : partTxt
            ? `Delbit ${g.id}: ${partTxt}`
            : `Delbit ${g.id}`;

      sel.appendChild(opt);
    });

    if (keepValue) sel.value = keepValue;
  });
}

function handleAddGoalPart(){
  const goalIn = _fv4_getEl("inputGoalSingle");
  const partIn = _fv4_getEl("inputPartSingle");
  const status = _fv4_getEl("goalsStatus");

  const goal = (goalIn && goalIn.value) ? String(goalIn.value).trim() : "";
  const part = (partIn && partIn.value) ? String(partIn.value).trim() : "";

  if (!goal && !part){
    if (status) status.textContent = "Skriv minst delm√•l eller delbit innan du l√§gger till.";
    return;
  }

  const s = _fv4_loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];
  const current = normalizeGoalsMap(s);

  const newId = _fv4_nextGoalId(current);
  s.goalsMap.push({ id: newId, goal: goal || "", part: part || "" });
  _fv4_saveState(s);

  if (goalIn) goalIn.value = "";
  if (partIn) partIn.value = "";
  if (status) status.textContent = `Tillagd: Delbit ${newId}.`;

  renderGoalsListAndSelects();
  try{ if (typeof window.populateGoalSelect === "function"){ window.populateGoalSelect(); } }catch(e){}
  try{ if (typeof window.__fv3h_renderAllQuestionLists === "function"){ window.__fv3h_renderAllQuestionLists(); } }catch(e){}
}
/* slut Sektion 4C: Delm√•l/delbitar (goalsMap) ‚Äì spara + rendera rubrik/underrubrik */

/* start Sektion 4D: Progression ‚Äì stark/svag enligt niv√•tr√∂sklar + rubrik/underrubrik */
function updateStudentStatsUI(){
  const s = _fv4_loadState();
  const ptsEl = _fv4_getEl("studentPointsValue");
  const hsEl = _fv4_getEl("highscoreSummary");

  const totalPoints = (s.progression && typeof s.progression.totalPoints === "number") ? s.progression.totalPoints : 0;
  if (ptsEl) ptsEl.textContent = `${totalPoints} p`;

  if (hsEl){
    const hs = Array.isArray(s.highscores) ? s.highscores.slice() : [];
    if (!hs.length){
      hsEl.textContent = "Ingen highscore √§nnu.";
      return;
    }
    hs.sort((a,b)=> (b.points||0) - (a.points||0));
    const studentId = (s.student && s.student.name ? s.student.name : "Elev") + "||" + (s.student && s.student.klass ? s.student.klass : "-");
    const idx = hs.findIndex((e)=>e && e.id === studentId);
    if (idx >= 0) hsEl.textContent = `Plats ${idx + 1} av ${hs.length} (${hs[idx].points || 0} p)`;
    else hsEl.textContent = `Highscorelista: ${hs.length} elever p√• denna enhet.`;
  }
}

function _fv4_renderStrongWeakLists(strongStats, weakStats, goalsById){
  const strongEl = _fv4_getEl("progressStrongList");
  const weakEl = _fv4_getEl("progressWeakList");
  if (strongEl) strongEl.innerHTML = "";
  if (weakEl) weakEl.innerHTML = "";

  function renderGrouped(listEl, stats, emptyText){
    if (!listEl) return;
    if (!stats.length){
      const li = document.createElement("li");
      li.textContent = emptyText;
      listEl.appendChild(li);
      return;
    }

    // group by goal title
    const groups = new Map();
    stats.forEach((st) => {
      const meta = goalsById.get(String(st.id)) || null;
      const goalTitle = (meta && meta.goal) ? meta.goal : "Delm√•l";
      if (!groups.has(goalTitle)) groups.set(goalTitle, []);
      groups.get(goalTitle).push({ st, meta });
    });

    // stable: insertion order already ok if we iterate stats then add
    const seen = new Set();
    stats.forEach((st) => {
      const meta = goalsById.get(String(st.id)) || null;
      const goalTitle = (meta && meta.goal) ? meta.goal : "Delm√•l";
      if (seen.has(goalTitle)) return;
      seen.add(goalTitle);

      // rubrik
      const liH = document.createElement("li");
      liH.innerHTML = `<div style="font-weight:700;">${_fv4_escapeHtml(goalTitle)}</div>`;
      listEl.appendChild(liH);

      // underrubriker
      const rows = groups.get(goalTitle) || [];
      rows.forEach(({ st: rowSt, meta: rowMeta }) => {
        const partTxt = (rowMeta && rowMeta.part) ? rowMeta.part : "";
        const sub = document.createElement("li");
        const partLine = partTxt ? `Delbit ${rowSt.id}: ${partTxt}` : `Delbit ${rowSt.id}`;
        sub.innerHTML = `<div class="mini" style="opacity:.95;">${_fv4_escapeHtml(partLine)} ‚Äî <b>${_fv4_escapeHtml(rowSt.level)}</b>: ${rowSt.acc}% (${rowSt.correct}/${rowSt.total})</div>`;
        listEl.appendChild(sub);
      });
    });
  }

  renderGrouped(strongEl, strongStats, "Inga tydliga styrkor √§nnu ‚Äì forts√§tt spela.");
  renderGrouped(weakEl, weakStats, "Inga tydliga svagheter ‚Äì bra jobbat!");
}

function updateProgressionPanel(){
  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);
  const prog = s.progression;
  const best = (s.best && typeof s.best === "object") ? s.best : { E:0, C:0, A:0 };
  const thres = _fv4_getThresholds(s);

  const pointsText = _fv4_getEl("progressPointsText");
  const last = prog.lastResult || null;
  const totalPoints = typeof prog.totalPoints === "number" ? prog.totalPoints : 0;

  if (pointsText){
    if (!last){
      pointsText.textContent = "Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.";
    }else{
      pointsText.textContent =
        `Totalt: ${totalPoints} p. ` +
        `Senast: niv√• ${last.level} ‚Äì ${last.score}% (${last.correct}/${last.total} r√§tt) +${last.pointsGained || 0}p. ` +
        `B√§sta: E ${best.E || 0}% (gr√§ns ${thres.E}%), C ${best.C || 0}% (gr√§ns ${thres.C}%), A ${best.A || 0}% (gr√§ns ${thres.A}%).`;
    }
  }

  // bygg goalsById map
  const goals = normalizeGoalsMap(s);
  const goalsById = new Map();
  goals.forEach((g)=> goalsById.set(String(g.id), g));

  // per niv√•-statistik (krav)
  const cL = prog.correctByGoalLevel || { E:{}, C:{}, A:{} };
  const wL = prog.wrongByGoalLevel || { E:{}, C:{}, A:{} };

  const allIds = new Set();
  ["E","C","A"].forEach((lv)=>{
    const c = (cL && cL[lv]) ? cL[lv] : {};
    const w = (wL && wL[lv]) ? wL[lv] : {};
    Object.keys(c).forEach((k)=>allIds.add(String(k)));
    Object.keys(w).forEach((k)=>allIds.add(String(k)));
  });

  if (!allIds.size){
    const strongEl = _fv4_getEl("progressStrongList");
    const weakEl = _fv4_getEl("progressWeakList");
    if (strongEl){
      strongEl.innerHTML = "";
      const li = document.createElement("li");
      li.textContent = "Inga starka delbitar inl√§sta √§nnu.";
      strongEl.appendChild(li);
    }
    if (weakEl){
      weakEl.innerHTML = "";
      const li = document.createElement("li");
      li.textContent = "Inga svaga delbitar inl√§sta √§nnu.";
      weakEl.appendChild(li);
    }
    return;
  }

  // bygg stats per (id, level)
  const stats = [];
  allIds.forEach((id)=>{
    ["E","C","A"].forEach((lv)=>{
      const c = (cL && cL[lv] && typeof cL[lv][id] === "number") ? cL[lv][id] : (cL && cL[lv] && cL[lv][id]) ? Number(cL[lv][id]) : 0;
      const w = (wL && wL[lv] && typeof wL[lv][id] === "number") ? wL[lv][id] : (wL && wL[lv] && wL[lv][id]) ? Number(wL[lv][id]) : 0;
      const total = (Number(c)||0) + (Number(w)||0);
      if (!total) return;
      const acc = Math.round(((Number(c)||0) / total) * 100);
      stats.push({ id:String(id), level:lv, correct:Number(c)||0, wrong:Number(w)||0, total, acc });
    });
  });

  // stark = acc >= tr√∂skel f√∂r den niv√•n
  const strong = stats
    .filter((st)=> st.total > 0 && st.acc >= (thres[st.level] || 70))
    .sort((a,b)=> (b.acc - a.acc) || (b.correct - a.correct) || (a.level < b.level ? 1 : -1))
    .slice(0, 18);

  // svag = acc < tr√∂skel f√∂r den niv√•n
  const weak = stats
    .filter((st)=> st.total > 0 && st.acc < (thres[st.level] || 70))
    .sort((a,b)=> (b.wrong - a.wrong) || (a.acc - b.acc) || (a.level < b.level ? 1 : -1))
    .slice(0, 18);

  _fv4_renderStrongWeakLists(strong, weak, goalsById);
}

function handleGenerateProgressJson(){
  const s = _fv4_loadState();
  const prog = (s && s.progression && typeof s.progression === "object") ? s.progression : {};
  const last = prog.lastResult || null;
  const output = _fv4_getEl("progressExportJson");
  if (!output) return;

  if (!last){
    output.value = "";
    return;
  }

  const payload = {
    source: "fangvaktaren",
    version: "v17",
    student: {
      name: (s.student && s.student.name) ? s.student.name : "",
      klass: (s.student && s.student.klass) ? s.student.klass : ""
    },
    result: {
      level: last.level,
      scorePercent: last.score,
      correct: last.correct,
      total: last.total,
      pointsGained: last.pointsGained,
      totalPointsAfter: last.totalPointsAfter,
      timestamp: last.timestamp
    },
    progression: {
      totalPoints: (prog.totalPoints || 0),
      best: s.best || {},
      wrongByGoalId: prog.wrongByGoalId || {},
      correctByGoalId: prog.correctByGoalId || {},
      wrongByGoalLevel: prog.wrongByGoalLevel || { E:{}, C:{}, A:{} },
      correctByGoalLevel: prog.correctByGoalLevel || { E:{}, C:{}, A:{} }
    }
  };

  output.value = JSON.stringify(payload, null, 2);
}

function handleCopyProgressJson(){
  const output = _fv4_getEl("progressExportJson");
  if (!output) return;
  const text = output.value || "";
  if (!text.trim()) return;

  if (navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).catch(()=>{});
  }
}

function updateAllProgressionUI(){
  updateStudentStatsUI();
  updateProgressionPanel();
  renderGoalsListAndSelects();
}

function handleClearStudentData(){
  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);

  if (!confirm("Detta rensar alla sparade elevuppgifter, highscore och progression p√• DENNA dator. Forts√§tt?")) return;

  s.student = { name:"", klass:"" };
  s.progression = { totalPoints:0, wrongByGoalId:{}, correctByGoalId:{}, wrongByGoalLevel:{E:{},C:{},A:{}}, correctByGoalLevel:{E:{},C:{},A:{}}, lastResult:null };
  s.best = { E:0, C:0, A:0 };
  s.unlocked = { C:false, A:false };
  s.highscores = [];

  _fv4_saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = _fv4_getEl("resetStatus");
  if (status) status.textContent = "Elevdata rensad p√• denna enhet.";
}

function handleResetGameData(){
  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);

  if (!confirm("Detta nollst√§ller po√§ng, progression och highscore men beh√•ller nuvarande elevnamn/klass. Forts√§tt?")) return;

  s.progression = { totalPoints:0, wrongByGoalId:{}, correctByGoalId:{}, wrongByGoalLevel:{E:{},C:{},A:{}}, correctByGoalLevel:{E:{},C:{},A:{}}, lastResult:null };
  s.best = { E:0, C:0, A:0 };
  s.unlocked = { C:false, A:false };
  s.highscores = [];

  _fv4_saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = _fv4_getEl("resetStatus");
  if (status) status.textContent = "Spelpo√§ng och progression nollst√§lld.";
}
/* slut Sektion 4D: Progression ‚Äì stark/svag enligt niv√•tr√∂sklar + rubrik/underrubrik */

/* start Sektion 4E: UI-sync (niv√•kort + elevinfo) */
function handleSaveStudent(){
  const nameInput = _fv4_getEl("studentName");
  const classInput = _fv4_getEl("studentClass");
  const s = _fv4_loadState();

  if (!s.student || typeof s.student !== "object") s.student = { name:"", klass:"" };
  s.student.name = (nameInput && nameInput.value.trim()) || "";
  s.student.klass = (classInput && classInput.value.trim()) || "";

  _fv4_saveState(s);
  syncUI();
}

function syncUI(){
  const s = _fv4_loadState();
  if (!s.student || typeof s.student !== "object") s.student = { name:"", klass:"" };

  const hasStudent = !!(s.student.name && s.student.klass);

  const nameInput = _fv4_getEl("studentName");
  const classInput = _fv4_getEl("studentClass");
  if (nameInput) nameInput.value = s.student.name || "";
  if (classInput) classInput.value = s.student.klass || "";

  const studentSaved = _fv4_getEl("studentSaved");
  if (studentSaved){
    studentSaved.textContent = hasStudent ? `Sparad: ${s.student.name} (${s.student.klass})` : "Ej sparad elev";
  }

  if (!s.best) s.best = { E:0, C:0, A:0 };

  const bestE = _fv4_getEl("best-levelE");
  const bestC = _fv4_getEl("best-levelC");
  const bestA = _fv4_getEl("best-levelA");
  if (bestE) bestE.textContent = (s.best && s.best.E) || 0;
  if (bestC) bestC.textContent = (s.best && s.best.C) || 0;
  if (bestA) bestA.textContent = (s.best && s.best.A) || 0;

  const th = _fv4_getThresholds(s);
  const thresE = _fv4_getEl("thres-levelE");
  const thresC = _fv4_getEl("thres-levelC");
  const thresA = _fv4_getEl("thres-levelA");
  if (thresE) thresE.textContent = th.E;
  if (thresC) thresC.textContent = th.C;
  if (thresA) thresA.textContent = th.A;

  if (!s.unlocked || typeof s.unlocked !== "object") s.unlocked = { C:false, A:false };

  const cardE = _fv4_getEl("card-levelE");
  const cardC = _fv4_getEl("card-levelC");
  const cardA = _fv4_getEl("card-levelA");
  const btnE = _fv4_getEl("start-levelE");
  const btnC = _fv4_getEl("start-levelC");
  const btnA = _fv4_getEl("start-levelA");
  const badgeE = _fv4_getEl("badge-levelE");
  const badgeC = _fv4_getEl("badge-levelC");
  const badgeA = _fv4_getEl("badge-levelA");

  if (cardE && btnE && badgeE){
    if (hasStudent){
      cardE.classList.remove("locked");
      btnE.disabled = false;
      badgeE.textContent = "Starta";
      badgeE.classList.remove("badge-lock");
      badgeE.classList.add("badge-ok");
    }else{
      cardE.classList.add("locked");
      btnE.disabled = true;
      badgeE.textContent = "L√•st";
      badgeE.classList.remove("badge-ok");
      badgeE.classList.add("badge-lock");
    }
  }

  if (cardC && btnC && badgeC){
    if (s.unlocked && s.unlocked.C){
      cardC.classList.remove("locked");
      btnC.disabled = false;
      badgeC.textContent = "Uppl√•st";
      badgeC.classList.remove("badge-lock");
      badgeC.classList.add("badge-ok");
    }else{
      cardC.classList.add("locked");
      btnC.disabled = true;
      badgeC.textContent = "L√•st";
      badgeC.classList.remove("badge-ok");
      badgeC.classList.add("badge-lock");
    }
  }

  if (cardA && btnA && badgeA){
    if (s.unlocked && s.unlocked.A){
      cardA.classList.remove("locked");
      btnA.disabled = false;
      badgeA.textContent = "Uppl√•st";
      badgeA.classList.remove("badge-lock");
      badgeA.classList.add("badge-ok");
    }else{
      cardA.classList.add("locked");
      btnA.disabled = true;
      badgeA.textContent = "L√•st";
      badgeA.classList.remove("badge-ok");
      badgeA.classList.add("badge-lock");
    }
  }

  const who = _fv4_getEl("whoPlays");
  if (who){
    who.textContent = hasStudent ? `${s.student.name} (${s.student.klass})` : "Ingen elev vald.";
  }

  const playSection = _fv4_getEl("play");
  const resultSection = _fv4_getEl("result");
  const studentCard = _fv4_getEl("studentCard");

  const isPlaying = !!currentLevel;
  const isResultVisible = resultSection && !resultSection.classList.contains("hidden");
  if (studentCard) studentCard.classList.toggle("hidden", isPlaying || isResultVisible);

  updateAllProgressionUI();
}
/* slut Sektion 4E: UI-sync (niv√•kort + elevinfo) */

/* start Sektion 4F: L√§nka fr√•ga ‚Üí delbit */
function getLinksForQuestion(q, goals){
  const id = _fv4_getGoalPartIdFromQuestion(q);
  if (!id) return [];
  const list = Array.isArray(goals) ? goals : [];
  const hit = list.find((g)=> String(g.id) === String(id));
  return hit ? [hit] : [{ id: String(id) }];
}
/* slut Sektion 4F: L√§nka fr√•ga ‚Üí delbit */












/* start Sektion 4G: Spel-logik (render + start + finish) */
function renderDragQuestion(q, index, host){
  const container = document.createElement("div");
  container.className = "question";

  const lv = _fv4_levelOf(q);
  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${lv}) ‚Äì Drag & Drop`;
  container.appendChild(header);

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = _fv4_getQuestionText(q) || "";
  container.appendChild(textDiv);

  // st√∂d format: {col1,col2,items:[{text,correct:0/1}]}
  const col1 = String((q && (q.col1 || q.column1 || (q.columns && q.columns[0]) || (q.cols && q.cols[0]))) || "Kolumn 1");
  const col2 = String((q && (q.col2 || q.column2 || (q.columns && q.columns[1]) || (q.cols && q.cols[1]))) || "Kolumn 2");
  const items = Array.isArray(q && (q.items || q.dragItems || q.cards || q.words)) ? (q.items || q.dragItems || q.cards || q.words) : [];

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.flexWrap = "wrap";
  wrapper.style.gap = "12px";
  wrapper.style.marginTop = "6px";

  const sourcesCol = document.createElement("div");
  sourcesCol.style.flex = "1 1 180px";

  const targetsCol = document.createElement("div");
  targetsCol.style.flex = "2 1 260px";

  const srcTitle = document.createElement("div");
  srcTitle.className = "mini";
  srcTitle.textContent = "Kort att dra:";
  sourcesCol.appendChild(srcTitle);

  const srcZone = document.createElement("div");
  srcZone.style.border = "1px dashed #1f2937";
  srcZone.style.borderRadius = "8px";
  srcZone.style.padding = "6px";
  srcZone.style.minHeight = "40px";
  srcZone.style.display = "flex";
  srcZone.style.flexWrap = "wrap";
  srcZone.style.gap = "4px";
  sourcesCol.appendChild(srcZone);

  const tgtTitle = document.createElement("div");
  tgtTitle.className = "mini";
  tgtTitle.textContent = "Kategori-rutor:";
  targetsCol.appendChild(tgtTitle);

  const tgtZone = document.createElement("div");
  tgtZone.style.display = "flex";
  tgtZone.style.flexWrap = "wrap";
  tgtZone.style.gap = "8px";
  targetsCol.appendChild(tgtZone);

  wrapper.appendChild(sourcesCol);
  wrapper.appendChild(targetsCol);
  container.appendChild(wrapper);

  const answers = {};
  currentAnswers[index] = answers;

  // skapa target-boxar
  const targets = [
    { id: "0", label: col1 },
    { id: "1", label: col2 }
  ];

  function makeDraggableChip(label, itemId){
    const chip = document.createElement("div");
    chip.textContent = label;
    chip.draggable = true;
    chip.dataset.itemId = itemId;
    chip.className = "chip";
    chip.style.cursor = "grab";
    chip.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", itemId);
    });
    return chip;
  }

  function setupDropTarget(el, targetId){
    el.addEventListener("dragover", (ev)=>ev.preventDefault());
    el.addEventListener("drop", (ev)=>{
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      el.appendChild(existing);

      if (targetId === null) delete answers[itemId];
      else answers[itemId] = String(targetId);
    });
  }

  setupDropTarget(srcZone, null);

  // skapa chips + correctMap (f√∂r finish)
  const correctMap = {};
  const ids = [];
  for (let i=0;i<items.length;i++){
    const it = items[i] || {};
    const txt = String(it.text || it.label || it.word || it.value || it.item || "").trim();
    if (!txt) continue;

    const correct = (typeof it.correct !== "undefined") ? it.correct
                  : (typeof it.target !== "undefined") ? it.target
                  : (typeof it.col !== "undefined") ? it.col
                  : (typeof it.column !== "undefined") ? it.column
                  : (typeof it.to !== "undefined") ? it.to
                  : 0;

    const itemId = String(it.id || it.itemId || `d${index}_${i}`);
    ids.push(itemId);
    correctMap[itemId] = String((Number(correct) || 0) === 1 ? "1" : "0");

    const chip = makeDraggableChip(txt, itemId);
    srcZone.appendChild(chip);
  }

  // spara tempor√§rt (f√∂r finish)
  q._fvDragCorrectMap = correctMap;

  targets.forEach((tgt)=>{
    const box = document.createElement("div");
    box.style.border = "1px solid #1f2937";
    box.style.borderRadius = "8px";
    box.style.padding = "6px";
    box.style.minHeight = "46px";
    box.style.minWidth = "110px";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "4px";

    const cap = document.createElement("div");
    cap.className = "mini";
    cap.textContent = tgt.label;
    box.appendChild(cap);

    const slot = document.createElement("div");
    slot.style.display = "flex";
    slot.style.flexWrap = "wrap";
    slot.style.gap = "4px";
    box.appendChild(slot);

    slot.addEventListener("dragover", (ev)=>ev.preventDefault());
    slot.addEventListener("drop", (ev)=>{
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      slot.appendChild(existing);
      answers[itemId] = String(tgt.id);
    });

    tgtZone.appendChild(box);
  });

  host.appendChild(container);
}

function renderQuestionItem(q, index, host){
  const type = _fv4_typeOf(q);
  if (type === "drag"){
    renderDragQuestion(q, index, host);
    return;
  }

  const container = document.createElement("div");
  container.className = "question";

  const lv = _fv4_levelOf(q);
  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${lv})`;
  container.appendChild(header);

  if (type === "img"){
    const src = _fv4_getImgSrc(q);
    if (src){
      const img = document.createElement("img");
      img.src = src;
      img.alt = "Bildfr√•ga";
      container.appendChild(img);
    }
  }

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = _fv4_getQuestionText(q) || "";
  container.appendChild(textDiv);

  const options = Array.isArray(q && q.options) ? q.options : [];
  const optionsList = document.createElement("div");
  optionsList.className = "options-list";

  options.forEach((opt, optIndex) => {
    const label = document.createElement("label");
    label.className = "option-label";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = `q-${index}`;
    input.value = String(optIndex);
    input.addEventListener("change", () => { currentAnswers[index] = optIndex; });

    const span = document.createElement("span");
    span.textContent = String(opt);

    label.appendChild(input);
    label.appendChild(span);
    optionsList.appendChild(label);
  });

  container.appendChild(optionsList);
  host.appendChild(container);
}

function startLevel(level){
  if (!ensureStudentSet()) return;

  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);
  s.bank = _fv4_ensureBankShape(s.bank);

  const allQuestions = []
    .concat(s.bank.mcq || [])
    .concat(s.bank.img || [])
    .concat(s.bank.drag || []);

  const pool = allQuestions.filter((q)=> _fv4_levelOf(q) === level);
  if (!pool.length){
    alert("Det finns inga fr√•gor p√• denna niv√• √§nnu.");
    return;
  }

  currentLevel = level;
  currentQuestions = _fv4_shuffle(pool);
  currentAnswers = new Array(currentQuestions.length).fill(null);

  const playSection = _fv4_getEl("play");
  const resultSection = _fv4_getEl("result");
  const questionsHost = _fv4_getEl("questions");

  if (resultSection) resultSection.classList.add("hidden");
  if (playSection) playSection.classList.remove("hidden");
  if (questionsHost){
    questionsHost.innerHTML = "";
    currentQuestions.forEach((q, idx)=> renderQuestionItem(q, idx, questionsHost));
  }

  const title = _fv4_getEl("play-title");
  const who = _fv4_getEl("whoPlays");
  if (title){
    if (level === "E") title.textContent = "Niv√• 1 ‚Äì Grundniv√• (E)";
    else if (level === "C") title.textContent = "Niv√• 2 ‚Äì Mellanniv√• (C)";
    else title.textContent = "Niv√• 3 ‚Äì Avancerad (A)";
  }
  if (who) who.textContent = `${s.student.name} (${s.student.klass})`;

  _fv4_saveState(s);
  syncUI();
}

function finishLevel(){
  if (!currentLevel || !currentQuestions.length){
    alert("Ingen niv√• √§r aktiv.");
    return;
  }

  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);
  s.bank = _fv4_ensureBankShape(s.bank);

  // ‚úÖ F√∂rs√∂k per niv√• + total (sparas alltid lokalt)
  if (!s.progression.attemptsByLevel || typeof s.progression.attemptsByLevel !== "object"){
    s.progression.attemptsByLevel = { E:0, C:0, A:0 };
  } else {
    if (s.progression.attemptsByLevel.E == null) s.progression.attemptsByLevel.E = 0;
    if (s.progression.attemptsByLevel.C == null) s.progression.attemptsByLevel.C = 0;
    if (s.progression.attemptsByLevel.A == null) s.progression.attemptsByLevel.A = 0;
  }

  const goals = normalizeGoalsMap(s);
  const thres = _fv4_getThresholds(s);

  const lvl = currentLevel;
  const threshold = thres[lvl] != null ? thres[lvl] : 70;

  // r√§kna f√∂rs√∂k (en finish = ett f√∂rs√∂k p√• niv√•n)
  s.progression.attemptsByLevel[lvl] = Number(s.progression.attemptsByLevel[lvl] || 0) + 1;
  s.progression.attemptsTotal =
    Number(s.progression.attemptsByLevel.E || 0) +
    Number(s.progression.attemptsByLevel.C || 0) +
    Number(s.progression.attemptsByLevel.A || 0);
  // bak√•tkomp om n√•gon annan del l√§ser "attempts"
  s.progression.attempts = s.progression.attemptsTotal;

  let correctCount = 0;
  let pointsGained = 0;
  let allCorrect = true;

  const wrongByGoal = s.progression.wrongByGoalId;
  const correctByGoal = s.progression.correctByGoalId;

  const wrongByGoalLv = s.progression.wrongByGoalLevel[lvl];
  const correctByGoalLv = s.progression.correctByGoalLevel[lvl];

  const basePointsPerQuestion = (lvl === "A") ? 3 : (lvl === "C") ? 2 : 1;

  currentQuestions.forEach((q, index) => {
    const type = _fv4_typeOf(q);
    const ansVal = currentAnswers[index];
    let isCorrect = false;

    if (type === "drag"){
      // h√§mta correctMap fr√•n render (eller bygg fr√•n items)
      let correctMap = (q && q.correctMap && typeof q.correctMap === "object") ? q.correctMap : null;
      if (!correctMap && q && q._fvDragCorrectMap) correctMap = q._fvDragCorrectMap;

      if (!correctMap){
        const items = Array.isArray(q && (q.items || q.dragItems || q.cards || q.words)) ? (q.items || q.dragItems || q.cards || q.words) : [];
        correctMap = {};
        for (let i=0;i<items.length;i++){
          const it = items[i] || {};
          const txt = String(it.text || it.label || it.word || it.value || it.item || "").trim();
          if (!txt) continue;
          const correct = (typeof it.correct !== "undefined") ? it.correct
                        : (typeof it.target !== "undefined") ? it.target
                        : (typeof it.col !== "undefined") ? it.col
                        : (typeof it.column !== "undefined") ? it.column
                        : (typeof it.to !== "undefined") ? it.to
                        : 0;
          const itemId = String(it.id || it.itemId || `d${index}_${i}`);
          correctMap[itemId] = String((Number(correct) || 0) === 1 ? "1" : "0");
        }
      }

      const keys = correctMap ? Object.keys(correctMap) : [];
      if (!keys.length) {
        isCorrect = false;
      } else if (!ansVal || typeof ansVal !== "object") {
        isCorrect = false;
      } else {
        let allOk = true;
        for (const itemId of keys){
          if (String(ansVal[itemId]) !== String(correctMap[itemId])){
            allOk = false;
            break;
          }
        }
        isCorrect = allOk;
      }
    } else {
      const correctIndex = (typeof q.answer === "number") ? q.answer : (typeof q.correct === "number" ? q.correct : null);
      if (ansVal != null && correctIndex != null) isCorrect = (Number(ansVal) === Number(correctIndex));
      else isCorrect = false;
    }

    if (isCorrect){
      correctCount++;
      pointsGained += basePointsPerQuestion;
    } else {
      allCorrect = false;
    }

    // koppla till delbit
    const links = getLinksForQuestion(q, goals);
    if (links && links.length){
      links.forEach((lnk) => {
        const key = String(lnk.id);

        // gamla summeringar (f√∂r bak√•tkomp/export)
        if (isCorrect) correctByGoal[key] = (correctByGoal[key] || 0) + 1;
        else wrongByGoal[key] = (wrongByGoal[key] || 0) + 1;

        // C: per niv√• totals (f√∂r fallback/skydd)
        if (isCorrect) correctByGoalLv[key] = (correctByGoalLv[key] || 0) + 1;
        else wrongByGoalLv[key] = (wrongByGoalLv[key] || 0) + 1;

        // A: senaste N per niv√• (styr stark/svag)
        try{ _fv4_pushRecent(s.progression, lvl, key, isCorrect, _fv4_RECENT_N); }catch(e){}

        // B: trend-signal (EMA) ‚Äì p√•verkar inte klassning, bara sparar signal
        try{ _fv4_updateDecay(s.progression, lvl, key, isCorrect); }catch(e){}
      });
    }
  });

  const total = currentQuestions.length;
  const percentage = total ? Math.round((correctCount / total) * 100) : 0;

  if (!s.best) s.best = { E:0, C:0, A:0 };
  if (percentage > (s.best[lvl] || 0)) s.best[lvl] = percentage;

  if (!s.unlocked) s.unlocked = { C:false, A:false };
  if (lvl === "E" && percentage >= threshold) s.unlocked.C = true;
  if (lvl === "C" && percentage >= threshold) s.unlocked.A = true;

  if (total > 0 && allCorrect) pointsGained += 5;

  s.progression.totalPoints += pointsGained;
  const totalPointsAfter = s.progression.totalPoints;

  const nowIso = _fv4_nowIso();
  const lastResult = {
    level: lvl,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    timestamp: nowIso,
    attemptsByLevel: {
      E: Number(s.progression.attemptsByLevel.E || 0),
      C: Number(s.progression.attemptsByLevel.C || 0),
      A: Number(s.progression.attemptsByLevel.A || 0)
    },
    attemptsTotal: Number(s.progression.attemptsTotal || 0)
  };
  s.progression.lastResult = lastResult;

  if (!Array.isArray(s.highscores)) s.highscores = [];
  const id = (s.student && s.student.name ? s.student.name : "Elev") + "||" + (s.student && s.student.klass ? s.student.klass : "-");
  const newEntry = {
    id,
    name: (s.student && s.student.name) ? s.student.name : "Elev",
    klass: (s.student && s.student.klass) ? s.student.klass : "-",
    points: totalPointsAfter,
    level: lvl,
    score: percentage,
    updatedAt: nowIso
  };
  const idx = s.highscores.findIndex((e)=> e && e.id === id);
  if (idx >= 0){
    if ((newEntry.points || 0) >= (s.highscores[idx].points || 0)) s.highscores[idx] = newEntry;
  } else {
    s.highscores.push(newEntry);
  }

  _fv4_saveState(s);

  lastSubmission = {
    level: lvl,
    studentName: (s.student && s.student.name) ? s.student.name : "",
    studentClass: (s.student && s.student.klass) ? s.student.klass : "",
    timestamp: nowIso,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    attemptsByLevel: {
      E: Number(s.progression.attemptsByLevel.E || 0),
      C: Number(s.progression.attemptsByLevel.C || 0),
      A: Number(s.progression.attemptsByLevel.A || 0)
    },
    attemptsTotal: Number(s.progression.attemptsTotal || 0),
    answers: Array.isArray(currentAnswers) ? currentAnswers.slice() : [],
    questions: currentQuestions.map((qq)=>({
      q: _fv4_getQuestionText(qq),
      type: _fv4_typeOf(qq),
      level: _fv4_levelOf(qq),
      answer: (typeof qq.answer === "number") ? qq.answer : (typeof qq.correct === "number" ? qq.correct : null),
      goalPart: _fv4_getGoalPartIdFromQuestion(qq) || null
    }))
  };

  const playSection = _fv4_getEl("play");
  const resultSection = _fv4_getEl("result");
  if (playSection) playSection.classList.add("hidden");
  if (resultSection) resultSection.classList.remove("hidden");

  const scoreText = _fv4_getEl("scoreText");
  const scoreDetail = _fv4_getEl("scoreDetail");
  const resName = _fv4_getEl("resName");
  const resClass = _fv4_getEl("resClass");
  const passBadge = _fv4_getEl("passBadge");
  const unlockText = _fv4_getEl("unlockText");

  if (scoreText) scoreText.innerHTML = `${percentage}%<span> resultat</span>`;
  if (scoreDetail) scoreDetail.textContent = `${correctCount}/${total} r√§tt ‚Äì niv√•po√§ng: +${pointsGained}p, totalt: ${totalPointsAfter}p`;
  if (resName) resName.textContent = (s.student && s.student.name) ? s.student.name : "-";
  if (resClass) resClass.textContent = (s.student && s.student.klass) ? s.student.klass : "-";

  if (passBadge){
    const passed = percentage >= threshold;
    if (passed){
      passBadge.className = "badge-pass";
      passBadge.textContent = "Godk√§nd niv√•";
    } else {
      passBadge.className = "badge-fail";
      passBadge.textContent = "Inte godk√§nd √§nnu";
    }
  }

  if (unlockText){
    let txt = "";
    if (lvl === "E" && s.unlocked.C) txt = "Niv√• 2 (C) √§r nu uppl√•st.";
    else if (lvl === "C" && s.unlocked.A) txt = "Niv√• 3 (A) √§r nu uppl√•st.";
    unlockText.textContent = txt;
  }

  currentLevel = null;
  currentQuestions = [];
  currentAnswers = [];

  updateAllProgressionUI();
  syncUI();
}
/* slut Sektion 4G: Spel-logik (render + start + finish) */







/* start Sektion 4H: Bindningar (knappar) */
function _fv4_bindOnce(){
  if (window.__fv4_bound) return;
  window.__fv4_bound = true;

  const btnSaveStudent = _fv4_getEl("btnSaveStudent");
  if (btnSaveStudent) btnSaveStudent.addEventListener("click", handleSaveStudent);

  const btnE = _fv4_getEl("start-levelE");
  const btnC = _fv4_getEl("start-levelC");
  const btnA = _fv4_getEl("start-levelA");
  if (btnE) btnE.addEventListener("click", ()=> startLevel("E"));
  if (btnC) btnC.addEventListener("click", ()=> startLevel("C"));
  if (btnA) btnA.addEventListener("click", ()=> startLevel("A"));

  const btnFinish = _fv4_getEl("btnFinish");
  if (btnFinish) btnFinish.addEventListener("click", finishLevel);

  const btnBack = _fv4_getEl("btnBack");
  if (btnBack) btnBack.addEventListener("click", ()=>{
    const resultSection = _fv4_getEl("result");
    if (resultSection) resultSection.classList.add("hidden");
    syncUI();
  });

  const btnGen = _fv4_getEl("btnGenerateProgressJson");
  if (btnGen) btnGen.addEventListener("click", handleGenerateProgressJson);

  const btnCopy = _fv4_getEl("btnCopyProgressJson");
  if (btnCopy) btnCopy.addEventListener("click", handleCopyProgressJson);

  const btnClear = _fv4_getEl("btnClearStudentData");
  if (btnClear) btnClear.addEventListener("click", handleClearStudentData);

  const btnReset = _fv4_getEl("btnResetGameData");
  if (btnReset) btnReset.addEventListener("click", handleResetGameData);

  const btnAddGoalPart = _fv4_getEl("btnAddGoalPart");
  if (btnAddGoalPart) btnAddGoalPart.addEventListener("click", handleAddGoalPart);

  // Rendera alltid n√§r sidan √∂ppnas
  try{ renderGoalsListAndSelects(); }catch(e){}
  try{ updateAllProgressionUI(); }catch(e){}
  try{ syncUI(); }catch(e){}
}

if (document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", _fv4_bindOnce);
} else {
  _fv4_bindOnce();
}
/* slut Sektion 4H: Bindningar (knappar) */




/* start Sektion 4I: FIREBASE ‚Äì elevinl√§mning (attemptsByLevel + attemptsTotal) */

function _fv4_safeNum2(n, fallback=0){
  const x = Number(n);
  return isFinite(x) ? x : fallback;
}

function _fv4_getStudentTokenForCloud(){
  try{
    const s = _fv4_loadState();
    const qs = new URLSearchParams(location.search);
    const t =
      (s && (s.studentToken || s.token || (s.student && s.student.token))) ||
      qs.get("token") ||
      "";
    return String(t || "").trim();
  }catch(e){
    return "";
  }
}

function _fv4_getStudentsCollectionRefForCloud(){
  try{
    if (!window.firebaseDbInstance || typeof firebaseDbInstance.collection !== "function") return null;

    const s = _fv4_loadState();
    const ab = (s && s.activeBank && typeof s.activeBank==="object") ? s.activeBank : {};
    const qs = new URLSearchParams(location.search);

    const publicId = String(ab.publicId || qs.get("public") || "").trim();
    if (publicId){
      return firebaseDbInstance
        .collection(PUBLIC_BANKS_COLLECTION).doc(publicId)
        .collection("students");
    }

    const ownerUid = String(ab.ownerUid || "").trim();
    const bankId = String(ab.bankId || ab.id || "").trim();
    if (ownerUid && bankId){
      return firebaseDbInstance
        .collection(CLOUD_ROOT_COLLECTION).doc(ownerUid)
        .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bankId)
        .collection("students");
    }

    if (window.currentTeacherUser && currentTeacherUser.uid && String(window.activeCloudBankId||"").trim()){
      return firebaseDbInstance
        .collection(CLOUD_ROOT_COLLECTION).doc(String(currentTeacherUser.uid))
        .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(window.activeCloudBankId))
        .collection("students");
    }

    return null;
  }catch(e){
    return null;
  }
}

async function fvSubmitLastResultToCloud(){
  try{ if (typeof initFirebase === "function") await initFirebase(); }catch(e){}

  try{
    if (!window.firebase || !window.firebaseDbInstance) return { ok:false, reason:"no_firebase" };
    if (!firebase.firestore || !firebase.firestore.FieldValue) return { ok:false, reason:"no_fieldvalue" };

    const ref = _fv4_getStudentsCollectionRefForCloud();
    if (!ref) return { ok:false, reason:"no_ref" };

    const token = _fv4_getStudentTokenForCloud();
    if (!token) return { ok:false, reason:"no_token" };

    const s0 = _fv4_loadState();
    const s = _fv4_ensureProgressionShape(s0);
    const prog = (s && s.progression) ? s.progression : {};

    const last = (prog && prog.lastResult && typeof prog.lastResult==="object") ? prog.lastResult : null;
    const lvlRaw =
      (lastSubmission && lastSubmission.level) ||
      (last && last.level) ||
      "E";
    const lvl = (String(lvlRaw || "E").toUpperCase() === "A" || String(lvlRaw || "E").toUpperCase() === "C")
      ? String(lvlRaw || "E").toUpperCase()
      : "E";

    const inc = firebase.firestore.FieldValue.increment(1);
    const ts = (firebase.firestore.FieldValue.serverTimestamp)
      ? firebase.firestore.FieldValue.serverTimestamp()
      : _fv4_nowIso();

    const lastCompact = last ? last : (lastSubmission ? {
      level: lvl,
      score: _fv4_safeNum2(lastSubmission.score, 0),
      correct: _fv4_safeNum2(lastSubmission.correct, 0),
      total: _fv4_safeNum2(lastSubmission.total, 0),
      pointsGained: _fv4_safeNum2(lastSubmission.pointsGained, 0),
      totalPointsAfter: _fv4_safeNum2(lastSubmission.totalPointsAfter, _fv4_safeNum2(prog.totalPoints, 0)),
      timestamp: String(lastSubmission.timestamp || _fv4_nowIso())
    } : null);

    const data = {
      studentName: (s.student && s.student.name) ? String(s.student.name) : "",
      studentClass: (s.student && s.student.klass) ? String(s.student.klass) : "",
      updatedAt: ts,

      "progression.totalPoints": _fv4_safeNum2(prog.totalPoints, 0),
      "progression.correctByGoalId": (prog.correctByGoalId && typeof prog.correctByGoalId==="object") ? prog.correctByGoalId : {},
      "progression.wrongByGoalId": (prog.wrongByGoalId && typeof prog.wrongByGoalId==="object") ? prog.wrongByGoalId : {},
      "progression.lastResult": lastCompact,

      "progression.attemptsTotal": inc
    };
    data[`progression.attemptsByLevel.${lvl}`] = inc;

    await ref.doc(String(token)).set(data, { merge: true });
    return { ok:true };
  }catch(e){
    console.warn("fvSubmitLastResultToCloud misslyckades:", e);
    return { ok:false, reason:"error" };
  }
}

try{ window.fvSubmitLastResultToCloud = fvSubmitLastResultToCloud; }catch(e){}

/* Auto-hook: k√∂r efter varje finishLevel (utan att du m√•ste √§ndra 4G) */
(function(){
  try{
    if (window.__fv4_finishlevel_cloud_hooked) return;
    if (typeof window.finishLevel !== "function") return;
    window.__fv4_finishlevel_cloud_hooked = true;

    const _orig = window.finishLevel;
    window.finishLevel = function(){
      const r = _orig.apply(this, arguments);
      try{
        if (typeof window.fvSubmitLastResultToCloud === "function"){
          Promise.resolve().then(()=>window.fvSubmitLastResultToCloud()).catch(()=>{});
        }
      }catch(e){}
      return r;
    };
  }catch(e){}
})();

/* slut Sektion 4I: FIREBASE ‚Äì elevinl√§mning (attemptsByLevel + attemptsTotal) */







</script>
<!-- slut SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->




<!-- start SEKTION 4X: PATCH A ‚Äì Migrera delbit-id (timestamp -> 1..N) + b√§ttre progressionstext -->
<script>
"use strict";

/* start Sektion 4X: MIGRERING + UI-FIX (Patch A) */

(function FV4X_PatchA_Init(){
  function _fv4x_isTimestampLike(id){
    const n = Number(id);
    return Number.isFinite(n) && n >= 1000000000000; // ~2001+ i ms (typiskt Date.now())
  }

  function _fv4x_readGoalRef(q){
    if (!q || typeof q !== "object") return "";
    const cand = [
      q.goalPart, q.goalpart, q.goalPartId, q.goalId,
      q.goalPartKey, q.goalPartRef, q.goalPartLabel,
      q.goalPartText, q.goalPartValue
    ];
    for (let i=0;i<cand.length;i++){
      const v = cand[i];
      if (v == null) continue;
      const s = String(v).trim();
      if (s) return s;
    }
    return "";
  }

  function _fv4x_writeGoalRef(q, newId){
    if (!q || typeof q !== "object") return;
    // Skriv p√• vanligaste f√§ltet. Beh√•ll √∂vriga or√∂rda.
    if ("goalPart" in q) q.goalPart = String(newId);
    else if ("goalpart" in q) q.goalpart = String(newId);
    else if ("goalPartId" in q) q.goalPartId = String(newId);
    else if ("goalId" in q) q.goalId = String(newId);
    else q.goalPart = String(newId);
  }

  function _fv4x_buildGoalMap(goalsArr){
    const map = {};
    const arr = Array.isArray(goalsArr) ? goalsArr : [];
    arr.forEach((g)=>{
      if (!g) return;
      const id = (g.id != null) ? String(g.id) : "";
      if (!id) return;
      map[id] = { goal: String(g.goal || ""), part: String(g.part || "") };
    });
    return map;
  }

  function _fv4x_migrateGoalIdsToSequential(){
    if (typeof window.loadState !== "function" || typeof window.saveState !== "function") return;

    const s = loadState();
    if (!s || typeof s !== "object") return;

    s.migrations = (s.migrations && typeof s.migrations === "object") ? s.migrations : {};
    if (s.migrations.goalIdsSequential_v1 === true) return;

    // H√§mta goalsMap (st√∂d flera placeringar)
    const rawGoals =
      (Array.isArray(s.goalsMap) && s.goalsMap) ||
      (s.bank && Array.isArray(s.bank.goalsMap) && s.bank.goalsMap) ||
      (s.bank && s.bank.meta && Array.isArray(s.bank.meta.goalsMap) && s.bank.meta.goalsMap) ||
      [];

    if (!rawGoals.length){
      // Inget att migrera ‚Äì men markera √§nd√• s√• vi inte k√∂r varje g√•ng
      s.migrations.goalIdsSequential_v1 = true;
      saveState(s);
      return;
    }

    // Bygg mapping oldId -> newId (1..N i den ordning som goalsMap ligger)
    const idMap = {};
    let needs = false;

    for (let i=0;i<rawGoals.length;i++){
      const g = rawGoals[i] || {};
      const oldId = (g.id != null) ? String(g.id).trim() : String(i+1);
      const newId = String(i + 1);

      if (oldId !== newId) idMap[oldId] = newId;

      if (_fv4x_isTimestampLike(oldId)) needs = true;
      // √§ven om inte timestamp: om id:n √§r "konstiga" (inte 1..N) s√• migrerar vi
      if (oldId !== newId) needs = true;
    }

    if (!needs){
      s.migrations.goalIdsSequential_v1 = true;
      saveState(s);
      return;
    }

    // 1) Uppdatera goalsMap-id:n
    const newGoals = rawGoals.map((g, i)=>{
      const gg = (g && typeof g === "object") ? Object.assign({}, g) : {};
      gg.id = String(i + 1);
      return gg;
    });

    if (Array.isArray(s.goalsMap)) s.goalsMap = newGoals;
    else {
      s.goalsMap = newGoals;
      if (s.bank && Array.isArray(s.bank.goalsMap)) s.bank.goalsMap = newGoals;
      if (s.bank && s.bank.meta && Array.isArray(s.bank.meta.goalsMap)) s.bank.meta.goalsMap = newGoals;
    }

    // 2) Migrera fr√•gor som pekar p√• gamla delbit-id:n
    s.bank = (s.bank && typeof s.bank === "object") ? s.bank : {};
    const kinds = ["mcq","img","drag"];
    kinds.forEach((kind)=>{
      const arr = Array.isArray(s.bank[kind]) ? s.bank[kind] : [];
      for (let i=0;i<arr.length;i++){
        const q = arr[i];
        const ref = _fv4x_readGoalRef(q);
        if (!ref) continue;
        if (idMap[ref]) _fv4x_writeGoalRef(q, idMap[ref]);
      }
      s.bank[kind] = arr;
    });

    // 3) Migrera progressionens map-nycklar (fel/r√§tt per delbit)
    s.progression = (s.progression && typeof s.progression === "object") ? s.progression : {};
    const wb = (s.progression.wrongByGoalId && typeof s.progression.wrongByGoalId === "object") ? s.progression.wrongByGoalId : {};
    const cb = (s.progression.correctByGoalId && typeof s.progression.correctByGoalId === "object") ? s.progression.correctByGoalId : {};

    function remapCounts(obj){
      const out = {};
      Object.keys(obj).forEach((k)=>{
        const nk = idMap[String(k)] || String(k);
        out[nk] = (out[nk] || 0) + (Number(obj[k]) || 0);
      });
      return out;
    }

    s.progression.wrongByGoalId = remapCounts(wb);
    s.progression.correctByGoalId = remapCounts(cb);

    s.migrations.goalIdsSequential_v1 = true;
    saveState(s);
  }

  // Override: b√§ttre progressionstext (Delm√•l-rubrik + Delbit-underrad)
  function _fv4x_updateProgressionPanel(){
    if (typeof window.getEl !== "function" || typeof window.loadState !== "function") return;

    const s = loadState();
    const prog = s.progression || {};
    const best = s.best || {};
    const thres = s.thres || {};

    const pointsText = getEl("progressPointsText");
    const strongEl = getEl("progressStrongList");
    const weakEl = getEl("progressWeakList");

    const last = prog.lastResult || null;
    const totalPoints = typeof prog.totalPoints === "number" ? prog.totalPoints : 0;

    const tE = (thres && typeof thres.E === "number") ? thres.E : 70;
    const tC = (thres && typeof thres.C === "number") ? thres.C : 70;
    const tA = (thres && typeof thres.A === "number") ? thres.A : 70;

    if (pointsText) {
      if (!last) {
        pointsText.textContent = "Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.";
      } else {
        pointsText.textContent =
          `Totalt: ${totalPoints} p. ` +
          `Senast: niv√• ${last.level} ‚Äì ${last.score}% (${last.correct}/${last.total} r√§tt) +${last.pointsGained || 0}p. ` +
          `B√§sta: E ${best.E || 0}% (gr√§ns ${tE}%), C ${best.C || 0}% (gr√§ns ${tC}%), A ${best.A || 0}% (gr√§ns ${tA}%).`;
      }
    }

    if (strongEl) strongEl.innerHTML = "";
    if (weakEl) weakEl.innerHTML = "";

    const wrongByGoal = (prog.wrongByGoalId && typeof prog.wrongByGoalId === "object") ? prog.wrongByGoalId : {};
    const correctByGoal = (prog.correctByGoalId && typeof prog.correctByGoalId === "object") ? prog.correctByGoalId : {};

    const allIds = new Set([
      ...Object.keys(wrongByGoal),
      ...Object.keys(correctByGoal)
    ]);

    if (!allIds.size) {
      if (strongEl) {
        const li = document.createElement("li");
        li.textContent = "Inga starka delbitar inl√§sta √§nnu.";
        strongEl.appendChild(li);
      }
      if (weakEl) {
        const li = document.createElement("li");
        li.textContent = "Inga svaga delbitar inl√§sta √§nnu.";
        weakEl.appendChild(li);
      }
      return;
    }

    // Anv√§nd E-tr√∂skel som ‚Äústyrka‚Äù-niv√• i progressionpanelen (vanligast du justerar den)
    const baseThres = (typeof thres.E === "number") ? thres.E : 70;

    // Bygg label-map fr√•n goalsMap (om den finns)
    const goalsArr = (Array.isArray(s.goalsMap) && s.goalsMap) || [];
    const labelMap = _fv4x_buildGoalMap(goalsArr);

    const stats = [];
    allIds.forEach((id) => {
      const c = Number(correctByGoal[id] || 0);
      const w = Number(wrongByGoal[id] || 0);
      const total = c + w;
      if (!total) return;
      const acc = Math.round((c / total) * 100);
      stats.push({ id: String(id), correct: c, wrong: w, total, acc });
    });

    const strong = stats
      .filter((st) => st.acc >= baseThres && st.correct > 0)
      .sort((a, b) => b.acc - a.acc || b.correct - a.correct)
      .slice(0, 12);

    const weak = stats
      .filter((st) => st.acc < baseThres || st.wrong > 0)
      .sort((a, b) => b.wrong - a.wrong || a.acc - b.acc)
      .slice(0, 12);

    function liHtml(st, mode){
      const meta = labelMap[st.id] || { goal:"", part:"" };
      const goalTitle = (meta.goal || "").trim() || "Delm√•l";
      const partText = (meta.part || "").trim() || `Delbit ${st.id}`;
      const third =
        (mode === "strong")
          ? `${st.acc}% r√§tt (${st.correct}/${st.total})`
          : `${st.wrong} fel (${st.correct}/${st.total} r√§tt, ${st.acc}%)`;

      return `
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div><strong>${goalTitle}</strong></div>
          <div class="mini">${partText}</div>
          <div class="mini">Delbit ${st.id} ‚Äì ${third}</div>
        </div>
      `;
    }

    if (strongEl) {
      if (!strong.length) {
        const li = document.createElement("li");
        li.textContent = "Inga tydliga styrkor √§nnu ‚Äì forts√§tt spela.";
        strongEl.appendChild(li);
      } else {
        strong.forEach((st) => {
          const li = document.createElement("li");
          li.innerHTML = liHtml(st, "strong");
          strongEl.appendChild(li);
        });
      }
    }

    if (weakEl) {
      if (!weak.length) {
        const li = document.createElement("li");
        li.textContent = "Inga tydliga svagheter ‚Äì bra jobbat!";
        weakEl.appendChild(li);
      } else {
        weak.forEach((st) => {
          const li = document.createElement("li");
          li.innerHTML = liHtml(st, "weak");
          weakEl.appendChild(li);
        });
      }
    }
  }

  // K√∂r migrering direkt (en g√•ng)
  try{ _fv4x_migrateGoalIdsToSequential(); }catch(e){ console.warn("FV4X migrate fail:", e); }

  // Hooka in s√• UI alltid anv√§nder patchade panelen
  try{
    if (typeof window.updateProgressionPanel === "function") {
      window.__fv4x_orig_updateProgressionPanel = window.updateProgressionPanel;
    }
    window.updateProgressionPanel = _fv4x_updateProgressionPanel;
  }catch(e){ console.warn("FV4X override updateProgressionPanel fail:", e); }

  // Se till att migrering k√∂rs innan UI-uppdateringar i framtiden ocks√•
  try{
    if (typeof window.updateAllProgressionUI === "function" && !window.__fv4x_updateAllHooked){
      window.__fv4x_updateAllHooked = true;
      const old = window.updateAllProgressionUI;
      window.updateAllProgressionUI = function(){
        try{ _fv4x_migrateGoalIdsToSequential(); }catch(e){}
        return old.apply(this, arguments);
      };
    }
  }catch(e){ console.warn("FV4X hook updateAllProgressionUI fail:", e); }

  // Trigger en UI-refresh efter patch (f√∂r att direkt byta ut listorna)
  try{
    setTimeout(()=>{
      try{ if (typeof window.updateAllProgressionUI === "function") window.updateAllProgressionUI(); }catch(e){}
    }, 60);
  }catch(e){}
})();

/* slut Sektion 4X: MIGRERING + UI-FIX (Patch A) */
</script>
<!-- slut SEKTION 4X: PATCH A ‚Äì Migrera delbit-id (timestamp -> 1..N) + b√§ttre progressionstext -->







<!-- start SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->
<script>
"use strict";

(function FV5(){
  /* =========================================================
     5A ‚Äì Bas-hj√§lpare (utan $) + s√§ker rebind
     ========================================================= */

  if (typeof window.getEl !== "function") {
    window.getEl = function getEl(id){ return document.getElementById(id); };
  }

  function _fv5_rebindButton(id, binder){
    const el = getEl(id);
    if (!el || !el.parentNode) return null;
    const clone = el.cloneNode(true);
    el.parentNode.replaceChild(clone, el);
    try{ if (typeof binder === "function") binder(clone); }catch{}
    return clone;
  }

  function _fv5_safeCall(fn, ...args){
    try{ if (typeof fn === "function") return fn(...args); }catch{}
    return undefined;
  }

  function _fv5_getStateSafe(){
    try{ if (typeof window.loadState === "function") return window.loadState(); }catch{}
    return null;
  }

  /* =========================================================
     5B ‚Äì ID-bridge (molnlista) + bankstatus
     ========================================================= */

  function _fv5_bridgeCloudListIds(){
    // Vi √§ndrar INTE layout ‚Äì bara ser till att det finns en list-host som SEKTION 3 hittar.
    try{
      const existing = getEl("cloudBankList");
      const v4 = getEl("cloudBanksListV4");
      const v5 = getEl("cloudBanksListV5");
      if (existing && !v4 && !v5){
        existing.id = "cloudBanksListV4";
      }
    }catch{}
  }

  function _fv5_countLocalBank(){
    const s = _fv5_getStateSafe() || {};
    const b = s.bank || {};
    const mcq = Array.isArray(b.mcq) ? b.mcq.length : 0;
    const img = Array.isArray(b.img) ? b.img.length : 0;
    const drag = Array.isArray(b.drag) ? b.drag.length : 0;
    return { mcq, img, drag, total: mcq + img + drag };
  }

  function updateBankStatusUI(){
    const hostList =
      getEl("cloudBanksListV4") ||
      getEl("cloudBanksListV5") ||
      getEl("cloudBanksList") ||
      getEl("cloudBankList");

    if (!hostList) return;

    const hostCard = hostList.closest(".card") || hostList.parentElement;
    if (!hostCard) return;

    let statusEl = getEl("bankStatus");
    if (!statusEl){
      statusEl = document.createElement("p");
      statusEl.id = "bankStatus";
      statusEl.className = "mini";
      statusEl.style.marginTop = "6px";
    }

    // Placera status precis f√∂re listan
    if (statusEl.parentNode !== hostCard){
      try{ if (statusEl.parentNode) statusEl.parentNode.removeChild(statusEl); }catch{}
      hostCard.insertBefore(statusEl, hostList);
    } else if (statusEl.nextSibling !== hostList){
      hostCard.insertBefore(statusEl, hostList);
    }

    const s = _fv5_getStateSafe() || {};
    const a = s.activeBank || {};
    const counts = _fv5_countLocalBank();

    if (!counts.total){
      statusEl.textContent = "Status: Ingen bank laddad (0 fr√•gor).";
      return;
    }

    const hasCloudActive = !!String(a.bankId || "").trim();
    const bankName = String(a.name || a.bankName || "").trim();

    if (hasCloudActive){
      statusEl.textContent =
        `Status: Moln-bank${bankName ? ` "${bankName}"` : ""} (${String(a.bankId)}) med ${counts.total} fr√•gor ` +
        `(MCQ: ${counts.mcq}, bild: ${counts.img}, drag & drop: ${counts.drag}).`;
    } else {
      statusEl.textContent =
        `Status: Lokal bank (p√• denna enhet) med ${counts.total} fr√•gor ` +
        `(MCQ: ${counts.mcq}, bild: ${counts.img}, drag & drop: ${counts.drag}).`;
    }
  }

  /* =========================================================
     5C ‚Äì L√§rarl√§ge (gate + modal)
     ========================================================= */

  function showTeacherPasswordInStatus(){
    const s = _fv5_getStateSafe() || {};
    const statusEl = getEl("passwordStatus");
    if (!statusEl) return;
    statusEl.textContent = (s.teacherPassword ? `Aktuellt l√§rarl√∂senord: ${s.teacherPassword}` : "");
  }

  function openTeacherGate(){
    const gate = getEl("teacherGate");
    const input = getEl("teacherPasswordInput");
    const text = getEl("teacherGateText");
    const s = _fv5_getStateSafe() || {};

    if (gate) gate.classList.remove("hidden");
    if (input){
      input.value = "";
      input.type = "password";
      input.focus();
    }
    if (text){
      text.textContent = s.teacherPassword
        ? "Ange l√§rarl√∂senord f√∂r att √∂ppna l√§rarl√§get."
        : "F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.";
    }
  }

  function closeTeacherGate(){
    const gate = getEl("teacherGate");
    if (gate) gate.classList.add("hidden");
  }

  function openTeacherModal(){
    const modal = getEl("teacherModal");
    if (modal) modal.classList.remove("hidden");
    _fv5_safeCall(window.tryRefreshRosterTabs, true);
  }

  function closeTeacherModal(){
    const modal = getEl("teacherModal");
    if (modal) modal.classList.add("hidden");
  }

  function handleTeacherConfirm(){
    const input = getEl("teacherPasswordInput");
    const text = getEl("teacherGateText");
    if (!input) return;

    const entered = input.value.trim();
    if (!entered){ alert("Skriv in ett l√∂senord."); return; }

    const s = _fv5_getStateSafe();
    if (!s){ alert("Tekniskt fel: state saknas."); return; }

    if (!s.teacherPassword){
      s.teacherPassword = entered;
      _fv5_safeCall(window.saveState, s);
      showTeacherPasswordInStatus();
      if (text) text.textContent = "L√∂senord sparat. √ñppnar l√§rarl√§ge.";
      closeTeacherGate();
      openTeacherModal();
      return;
    }

    if (s.teacherPassword === entered){
      if (text) text.textContent = "L√∂senord OK. √ñppnar l√§rarl√§ge.";
      closeTeacherGate();
      openTeacherModal();
    } else {
      if (text) text.textContent = "Fel l√∂senord. F√∂rs√∂k igen.";
      input.value = "";
      input.focus();
    }
  }

  /* =========================================================
     5D ‚Äì Flikar (teacher modal) + progress-trigger
     ========================================================= */

  function setupTabNavigation(){
    const tabButtons = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".tab-panel");
    if (!tabButtons.length || !panels.length) return;

    function activateTab(tabId){
      tabButtons.forEach((btn)=>{
        const isActive = btn.getAttribute("data-tab") === tabId;
        btn.classList.toggle("active", isActive);
      });

      panels.forEach((panel)=>{
        const panelId = panel.getAttribute("data-panel");
        panel.classList.toggle("hidden", panelId !== tabId);
      });

      if (tabId === "progress"){
        _fv5_safeCall(window.tryRefreshRosterTabs, true);
      }
    }

    tabButtons.forEach((btn)=>{
      btn.addEventListener("click", ()=>{
        const tabId = btn.getAttribute("data-tab");
        if (!tabId) return;
        activateTab(tabId);
      });
    });

    // Default
    if (document.querySelector('.tab-btn[data-tab="settings"]')) activateTab("settings");
  }

  /* =========================================================
     5E ‚Äì Molnknappar (ladda/spara/login/logout)
     ========================================================= */

  async function _fv5_loadCloudBanksNow(){
    try{
      _fv5_bridgeCloudListIds();
      if (typeof window.initFirebase === "function"){ try{ await window.initFirebase(); }catch{} }

      const fn =
        (typeof window.loadCloudBanksListV5 === "function") ? window.loadCloudBanksListV5 :
        (typeof window.loadCloudBanksListV4 === "function") ? window.loadCloudBanksListV4 :
        (typeof window.loadCloudBanksList === "function") ? window.loadCloudBanksList :
        null;

      if (!fn){
        alert("Molnlist-funktionen saknas (loadCloudBanksListV5/V4). Kontrollera att SEKTION 3 √§r laddad.");
        return;
      }

      await fn();
      updateBankStatusUI();
      _fv5_safeCall(window.tryRefreshRosterTabs, true);
    }catch(e){
      console.error("Kunde inte ladda moln-bankar:", e);
      alert("Kunde inte ladda moln-bankar. Se konsolen.");
    }
  }

  /* =========================================================
     5F ‚Äì initApp + DOMContentLoaded (idempotent)
     ========================================================= */

  async function initApp(){
    if (window.__FANGVAKTAREN_INITAPP_DONE){
      console.log("initApp: hoppar √∂ver (redan initierad)");
      return;
    }
    window.__FANGVAKTAREN_INITAPP_DONE = true;

    console.log("initApp start");

    _fv5_bridgeCloudListIds();

    // Initiera inst√§llningsdelar om de finns
    _fv5_safeCall(window.initTeacherEmailSettings);
    _fv5_safeCall(window.initThresholdSettings);
    _fv5_safeCall(window.initTeacherPasswordSettings);
    showTeacherPasswordInStatus();

    _fv5_safeCall(window.initGoalsMap);
    _fv5_safeCall(window.initQuestionForms);
    _fv5_safeCall(window.initImageQuestionsEditor);
    _fv5_safeCall(window.initDragDropQuestionsEditor);

    setupTabNavigation();

    _fv5_safeCall(window.syncUI);
    updateBankStatusUI();

    /* ---------- Elevyta ---------- */
    _fv5_rebindButton("btnSaveStudent", (b)=>{ if (typeof window.handleSaveStudent==="function") b.addEventListener("click", window.handleSaveStudent); });

    _fv5_rebindButton("start-levelE", (b)=>{ if (typeof window.startLevel==="function") b.addEventListener("click", ()=>window.startLevel("E")); });
    _fv5_rebindButton("start-levelC", (b)=>{ if (typeof window.startLevel==="function") b.addEventListener("click", ()=>window.startLevel("C")); });
    _fv5_rebindButton("start-levelA", (b)=>{ if (typeof window.startLevel==="function") b.addEventListener("click", ()=>window.startLevel("A")); });

    _fv5_rebindButton("btnFinish", (b)=>{ if (typeof window.finishLevel==="function") b.addEventListener("click", window.finishLevel); });

    _fv5_rebindButton("btnBack", (b)=>{
      b.addEventListener("click", ()=>{
        const result = getEl("result");
        const play = getEl("play");
        if (result) result.classList.add("hidden");
        if (play) play.classList.add("hidden");
        const studentCard = getEl("studentCard");
        if (studentCard) studentCard.classList.remove("hidden");
        _fv5_safeCall(window.syncUI);
      });
    });

    _fv5_rebindButton("btnCancel", (b)=>{
      b.addEventListener("click", ()=>{
        try{ window.currentLevel = null; }catch{}
        try{ window.currentQuestions = []; }catch{}
        try{ window.currentAnswers = []; }catch{}
        const play = getEl("play");
        const result = getEl("result");
        if (play) play.classList.add("hidden");
        if (result) result.classList.add("hidden");
        const studentCard = getEl("studentCard");
        if (studentCard) studentCard.classList.remove("hidden");
        _fv5_safeCall(window.syncUI);
      });
    });

    _fv5_rebindButton("btnSubmitGame", (b)=>{
      b.addEventListener("click", async ()=>{
        try{
          if (typeof window.saveCurrentResultToFirestore !== "function") throw new Error("saveCurrentResultToFirestore saknas");
          await window.saveCurrentResultToFirestore();
          alert("Ditt resultat √§r inl√§mnat till l√§raren.");
        }catch(err){
          console.error("Fel vid inl√§mning:", err);
          alert("Kunde inte l√§mna in resultatet. F√∂rs√∂k igen eller kontakta l√§raren.");
        }
      });
    });

    /* ---------- L√§rarl√§ge ---------- */
    _fv5_rebindButton("btnTeacherMode", (b)=> b.addEventListener("click", openTeacherGate));
    _fv5_rebindButton("btnTeacherCancel", (b)=> b.addEventListener("click", closeTeacherGate));
    _fv5_rebindButton("btnTeacherConfirm", (b)=> b.addEventListener("click", handleTeacherConfirm));
    _fv5_rebindButton("btnCloseTeacher", (b)=> b.addEventListener("click", closeTeacherModal));

    /* ---------- Inst√§llningar ---------- */
    _fv5_rebindButton("btnSaveThresholds", (b)=>{
      if (typeof window.handleSaveThresholds === "function"){
        b.addEventListener("click", ()=>{
          window.handleSaveThresholds();
          updateBankStatusUI();
        });
      }
    });

    _fv5_rebindButton("btnSaveTeacherEmail", (b)=>{ if (typeof window.handleSaveTeacherEmail==="function") b.addEventListener("click", window.handleSaveTeacherEmail); });

    _fv5_rebindButton("btnChangeTeacherPassword", (b)=>{
      if (typeof window.handleChangeTeacherPassword === "function"){
        b.addEventListener("click", ()=>{
          window.handleChangeTeacherPassword();
          showTeacherPasswordInStatus();
        });
      }
    });

    /* ---------- Delm√•l/delbitar ---------- */
    _fv5_rebindButton("btnAddGoalPart", (b)=>{ if (typeof window.handleAddGoalPart==="function") b.addEventListener("click", window.handleAddGoalPart); });
    _fv5_rebindButton("btnSaveGoalsMap", (b)=>{ if (typeof window.handleSaveGoalsMap==="function") b.addEventListener("click", window.handleSaveGoalsMap); });
    _fv5_rebindButton("btnClearGoalsMap", (b)=>{ if (typeof window.handleClearGoalsMap==="function") b.addEventListener("click", window.handleClearGoalsMap); });

    /* ---------- Rensa ---------- */
    _fv5_rebindButton("btnClearStudentData", (b)=>{ if (typeof window.handleClearStudentData==="function") b.addEventListener("click", window.handleClearStudentData); });
    _fv5_rebindButton("btnResetGameData", (b)=>{ if (typeof window.handleResetGameData==="function") b.addEventListener("click", window.handleResetGameData); });

    /* ---------- Moln / Firebase ---------- */
    _fv5_rebindButton("btnLoadCloudBanks", (b)=> b.addEventListener("click", _fv5_loadCloudBanksNow));

    _fv5_rebindButton("btnSaveToCloud", (b)=>{
      b.addEventListener("click", async ()=>{
        try{
          if (typeof window.handleSaveToCloud !== "function") throw new Error("handleSaveToCloud saknas (SEKTION 3?)");
          await window.handleSaveToCloud();
          await _fv5_loadCloudBanksNow();
        }catch(err){
          console.error("Spara bank misslyckades:", err);
          alert("Kunde inte spara bank till molnet. Se konsolen.");
        }
      });
    });

    _fv5_rebindButton("btnExportBank", (b)=>{ if (typeof window.handleExportBank==="function") b.addEventListener("click", ()=>{ window.handleExportBank(); updateBankStatusUI(); }); });

    const fileImport = getEl("fileImport");
    if (fileImport && !fileImport.__fv5Bound){
      fileImport.__fv5Bound = true;
      if (typeof window.handleImportBank === "function"){
        fileImport.addEventListener("change", (evt)=>{ window.handleImportBank(evt); updateBankStatusUI(); });
      }
    }

    _fv5_rebindButton("btnGooglePlaceholder", (b)=>{ if (typeof window.handleGoogleLogin==="function") b.addEventListener("click", window.handleGoogleLogin); });
    _fv5_rebindButton("btnGoogleLogout", (b)=>{ if (typeof window.handleGoogleLogout==="function") b.addEventListener("click", window.handleGoogleLogout); });

    _fv5_rebindButton("btnPublishSharedBank", (b)=>{ if (typeof window.handlePublishSharedBank==="function") b.addEventListener("click", window.handlePublishSharedBank); });

    console.log("initApp klar ‚Äì knappar kopplade");
  }

  // Exponera (om andra sektioner vill kalla)
  window.updateBankStatusUI = updateBankStatusUI;
  window.openTeacherGate = openTeacherGate;
  window.closeTeacherGate = closeTeacherGate;
  window.openTeacherModal = openTeacherModal;
  window.closeTeacherModal = closeTeacherModal;
  window.handleTeacherConfirm = handleTeacherConfirm;
  window.initApp = initApp;

  document.addEventListener("DOMContentLoaded", function(){
    if (window.__FANGVAKTAREN_DOMREADY_DONE) return;
    window.__FANGVAKTAREN_DOMREADY_DONE = true;

    // Init Firebase om SEKTION 3 finns
    if (typeof window.initFirebase === "function"){
      try{
        if (!window.__FANGVAKTAREN_FIREBASE_INIT_DONE){
          window.__FANGVAKTAREN_FIREBASE_INIT_DONE = true;
          window.initFirebase();
        }
      }catch(e){
        console.error("Fel vid initFirebase:", e);
      }
    }

    try{ initApp(); }
    catch(e){ console.error("Fel vid initApp:", e); }
  });

})(); // FV5
</script>
<!-- slut SEKTION 5: SCRIPT & LOGIK F√ÖNGVAKTAREN (l√§rarl√§ge, flikar, bankstatus, initiering & knappar) -->









<!-- start SEKTION 6: AVSLUTANDE TAGGAR -->
</body>
</html>
<!-- slut SEKTION 6: AVSLUTANDE TAGGAR -->
