<!-- start SEKTION 1: HEAD & STIL -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>F√•ngvaktaren ‚Äì Progressionsspel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --accent-e:#b45309;
      --accent-c:#2563eb;
      --accent-a:#7c3aed;
      --accent-danger:#ef4444;
      --accent-info:#38bdf8;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --chip:#020617;
    }

    *{box-sizing:border-box;}

    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:radial-gradient(circle at top,#020617 0,#020617 40%,#000 100%);
      color:var(--text);
    }

    body{
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:960px;
      margin:0 auto;
      min-height:100vh;
      padding:12px 12px 32px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(15,23,42,.85));
      border:1px solid #1f2937;
      box-shadow:0 0 40px rgba(15,23,42,.9);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(10px);
    }

    .header-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .title-block h1{
      margin:0;
      font-size:1.2rem;
      letter-spacing:.03em;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:999px;
      background:radial-gradient(circle,var(--accent-e),#111827);
      color:#fff;
      font-weight:700;
      font-size:.9rem;
      box-shadow:0 0 12px rgba(180,83,9,.8);
    }

    /* ---------- Buttons ---------- */

    .btn{
      --btn-bg:#111827;
      --btn-border:rgba(75,85,99,.9);
      border-radius:999px;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      padding:6px 12px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
      transition:
        background-color .15s ease,
        border-color .15s ease,
        box-shadow .18s ease,
        transform .12s ease,
        opacity .15s ease;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 0 0 rgba(59,130,246,0);
    }

    .btn-sm{
      padding:5px 10px;
      font-size:.8rem;
    }

    .btn-primary{
      --btn-bg:linear-gradient(135deg,var(--accent-e),var(--accent-c));
      --btn-border:rgba(96,165,250,.9);
      color:#f9fafb;
      box-shadow:
        0 0 0 1px rgba(148,163,184,.4),
        0 0 18px rgba(56,189,248,.45);
    }

    .btn-danger{
      --btn-bg:rgba(127,29,29,.95);
      --btn-border:rgba(239,68,68,.9);
      box-shadow:
        0 0 0 1px rgba(248,113,113,.5),
        0 0 14px rgba(248,113,113,.4);
    }

    .btn-secondary{
      --btn-bg:#020617;
      --btn-border:rgba(75,85,99,.8);
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(148,163,184,.6),
        0 0 24px rgba(59,130,246,.55);
      opacity:.97;
    }

    .btn:active{
      transform:translateY(0);
      box-shadow:
        0 0 0 1px rgba(107,114,128,.8),
        0 0 12px rgba(37,99,235,.45);
      opacity:.92;
    }

    .btn:disabled,
    .btn[disabled]{
      opacity:.45;
      cursor:default;
      box-shadow:
        0 0 0 1px rgba(31,41,55,1),
        0 0 0 rgba(0,0,0,0);
      transform:none;
    }

    /* --------- NYTT: Mejlad-l√§nk i roster (g√∂r knappen gr√∂n n√§r JS s√§tter class "sent") --------- */
    .btn.sent,
    .sent.btn,
    .sent{
      background:linear-gradient(135deg,#16a34a,#22c55e) !important;
      border-color:rgba(34,197,94,1) !important;
      color:#ecfdf5 !important;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 18px rgba(22,163,74,.7) !important;
    }

    .btn.sent:hover,
    .sent.btn:hover,
    .sent:hover{
      background:linear-gradient(135deg,#16a34a,#22c55e) !important;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 26px rgba(34,197,94,.9) !important;
      transform:translateY(-1px);
      opacity:1 !important;
    }

    .btn.sent:active,
    .sent.btn:active,
    .sent:active{
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 14px rgba(34,197,94,.8) !important;
      transform:translateY(0);
    }
    /* --------- SLUT NYTT --------- */

    /* Spara elev ‚Äì tydlig gr√∂n, fyllig knapp */
    #btnSaveStudent{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      border-color:rgba(34,197,94,1);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 20px rgba(34,197,94,.75);
    }

    #btnSaveStudent:hover{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 26px rgba(34,197,94,.9);
      transform:translateY(-1px);
    }

    #btnSaveStudent:active{
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 14px rgba(34,197,94,.8);
      transform:translateY(0);
    }

    #btnSaveStudent:disabled{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      opacity:.45;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 0 rgba(0,0,0,0);
    }

    /* L√§rarl√§ge ‚Äì m√∂rk bakgrund, gr√∂n kontur (outline-knapp) */
    #btnTeacherMode{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherMode:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherMode:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* L√∂senords-popup: ‚ÄúForts√§tt‚Äù ‚Äì samma gr√∂na kontur som l√§rarl√§ge */
    #btnTeacherConfirm{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnTeacherConfirm:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnTeacherConfirm:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* Spara niv√•gr√§nser ‚Äì gr√∂n kontur, samma stil */
    #btnSaveThresholds{
      background:#020617;
      border-color:rgba(74,222,128,.9);
      color:#bbf7d0;
      box-shadow:
        0 0 0 1px rgba(21,128,61,1),
        0 0 14px rgba(34,197,94,.45);
    }

    #btnSaveThresholds:hover{
      background:#020617;
      border-color:rgba(74,222,128,1);
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 22px rgba(34,197,94,.7);
      transform:translateY(-1px);
    }

    #btnSaveThresholds:active{
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 12px rgba(34,197,94,.6);
      transform:translateY(0);
    }

    /* ---------- Layout helpers ---------- */

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1 1 120px;
      min-width:0;
    }

    label{
      font-size:.7rem;
      color:var(--muted);
    }

    .small-label{
      font-size:.7rem;
      color:var(--muted);
    }

    .input,
    .input-number{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:.8rem;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }

    .input-number{
      appearance:textfield;
      -moz-appearance:textfield;
    }

    .input-number::-webkit-outer-spin-button,
    .input-number::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    .input:focus,
    .input-number:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
      background:#020617;
    }

    .mini{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.4;
    }

    .hidden{
      display:none !important;
    }

    /* ---------- Elevkort ---------- */

    .student-card{
      background:radial-gradient(circle at top left,#020617,#020617 55%,#000 100%);
      border-radius:16px;
      padding:12px 12px 14px;
      border:1px solid rgba(31,41,55,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .student-main-row{
      align-items:flex-end;
    }

    .student-save-field{
      max-width:180px;
    }

    .student-status-row{
      margin-top:2px;
    }

    .student-saved-label{
      font-size:.75rem;
      color:var(--muted);
    }

    .student-stats-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
    }

    .score-box{
      flex:1 1 160px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 55%,#000 100%);
      display:flex;
      flex-direction:column;
      gap:2px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 20px rgba(56,189,248,.4),
        0 12px 28px rgba(15,23,42,.9);
    }

    .score-label{
      font-size:.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .score-value{
      font-size:1rem;
      font-weight:600;
    }

    /* ---------- Niv√•-kort ---------- */

    .levels-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }

    .level-card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.9);
    }

    .level-card.locked{
      opacity:.7;
      filter:saturate(.7);
    }

    .level-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .level-title span:first-child{
      font-weight:600;
      font-size:.9rem;
    }

    .level-title small{
      display:block;
      font-size:.7rem;
      color:var(--muted);
    }

    .level-body{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:.78rem;
    }

    .level-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-top:4px;
    }

    .badge{
      border-radius:999px;
      padding:2px 8px;
      font-size:.7rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
    }

    .badge-lock{
      color:#fbbf24;
      border-color:rgba(245,158,11,.7);
      box-shadow:0 0 12px rgba(245,158,11,.35);
    }

    .badge-ok{
      color:#4ade80;
      border-color:rgba(74,222,128,.9);
      box-shadow:0 0 16px rgba(22,163,74,.65);
    }

    .badge-pass{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#ecfdf5;
      box-shadow:
        0 0 0 1px rgba(22,163,74,1),
        0 0 18px rgba(22,163,74,.7);
    }

    .badge-fail{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:.8rem;
      background:linear-gradient(135deg,#991b1b,#ef4444);
      color:#fee2e2;
      box-shadow:
        0 0 0 1px rgba(127,29,29,1),
        0 0 18px rgba(248,113,113,.7);
    }

    /* ---------- Spelpanel / Resultat ---------- */

    .play-panel,
    .result-panel{
      margin-top:8px;
      padding:10px 10px 12px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
    }

    .play-header,
    .result-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .questions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:4px;
    }

    .question{
      padding:8px 9px;
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      background:radial-gradient(circle at top left,#020617,#020617 60%,#020617 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 26px rgba(15,23,42,.9);
      font-size:.85rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .q-text{
      font-size:.85rem;
      margin-top:2px;
    }

    .options-list{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:2px;
    }

    .option-label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
      padding:4px 6px;
      border-radius:999px;
      background:#020617;
      border:1px solid rgba(31,41,55,1);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,transform .1s ease;
    }

    .option-label input{
      accent-color:var(--accent-c);
    }

    .option-label:hover{
      background:#020617;
      border-color:rgba(59,130,246,.7);
      box-shadow:
        0 0 0 1px rgba(59,130,246,.9),
        0 0 16px rgba(37,99,235,.6);
      transform:translateY(-1px);
    }

    .play-footer{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:.75rem;
    }

    .play-actions{
      display:flex;
      gap:6px;
    }

    .score{
      font-size:1.6rem;
      font-weight:700;
    }

    .score span{
      font-size:.8rem;
      font-weight:400;
      margin-left:4px;
      color:var(--muted);
    }

    .result-meta{
      font-size:.78rem;
      color:var(--muted);
      margin-top:2px;
    }

    .result-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ---------- Modal & gate ---------- */

    .gate-backdrop,
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
      backdrop-filter:blur(10px);
    }

    .gate-box{
      width:100%;
      max-width:320px;
      padding:14px 14px 16px;
      border-radius:16px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:.85rem;
    }

    .gate-actions{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }

    .modal{
      width:100%;
      max-width:980px;
      max-height:90vh;
      padding:12px 12px 14px;
      border-radius:18px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border:1px solid rgba(55,65,81,1);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:4px;
    }

    .modal-body{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding-right:2px;
    }

    /* ---------- Flikar ---------- */

    .tab-nav{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
    }

    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(55,65,81,1);
      padding:4px 9px;
      font-size:.75rem;
      background:#020617;
      color:var(--muted);
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,box-shadow .18s ease,color .15s ease;
    }

    .tab-btn.active{
      color:#e5e7eb;
      border-color:rgba(96,165,250,1);
      background:linear-gradient(135deg,#0369a1,#4f46e5);
      box-shadow:
        0 0 0 1px rgba(37,99,235,1),
        0 0 20px rgba(56,189,248,.7);
    }

    .tab-panel{
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:10px 10px 12px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 16px 34px rgba(15,23,42,.95);
    }

    /* ---------- Cards & grids ---------- */

    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .card{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px 10px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 12px 30px rgba(15,23,42,.95);
      font-size:.82rem;
    }

    .card-full-width{
      grid-column:1/-1;
    }

    .card-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }

    .questions-editor{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .goals-list,
    .question-list{
      list-style:none;
      padding:0;
      margin:4px 0 0;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.8rem;
    }

    .question-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      flex-direction:column;
      gap:4px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    /* St√∂d f√∂r "list-item" (anv√§nds i SEKTION 3 f√∂r listor) */
    .list-item{
      padding:6px 7px;
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
    }

    .list-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1 1 auto;
    }

    .q-meta{
      font-size:.75rem;
      color:var(--muted);
      line-height:1.35;
    }

    .question-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:2px;
    }

    .img-preview-box{
      border-radius:10px;
      border:1px dashed rgba(55,65,81,1);
      padding:6px;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .img-preview-box img{
      max-width:100%;
      border-radius:8px;
    }

    .img-thumb{
      width:64px;
      height:44px;
      border-radius:8px;
      border:1px solid rgba(31,41,55,1);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#020617;
      margin-right:6px;
    }

    .img-thumb img{
      max-width:100%;
      max-height:100%;
      object-fit:cover;
    }

    .question-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .chip{
      border-radius:999px;
      padding:3px 8px;
      font-size:.75rem;
      border:1px solid rgba(55,65,81,1);
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 6px 14px rgba(15,23,42,.85);
    }

    /* Elevprogression ‚Äì rutorna staplas p√• h√∂jden (en kolumn) */
    .progress-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }

    .progress-box{
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      padding:8px 9px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 10px 24px rgba(15,23,42,.9);
      font-size:.8rem;
    }

    .mini-card{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      padding:6px 7px;
      background:#020617;
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 8px 18px rgba(15,23,42,.9);
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .mini-title{
      font-size:.82rem;
      font-weight:600;
    }

    /* ---------- GDPR: Modal f√∂r elevlista/tokens (endast id-bundet) ---------- */

    #bankRosterModal,
    #rosterViewerModal{
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(15,23,42,.78);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      backdrop-filter:blur(10px);
    }

    #bankRosterModal.hidden,
    #rosterViewerModal.hidden{
      display:none !important;
    }

    #bankRosterModal .card,
    #rosterViewerModal .card{
      width:min(980px,100%);
      max-height:88vh;
      overflow:auto;
      padding:12px 12px 14px;
      border-radius:18px;
      border:1px solid rgba(55,65,81,1);
      background:radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 26px 60px rgba(15,23,42,.98);
    }

    #bankRosterModal .card h3,
    #rosterViewerModal .card h3{
      margin:0;
      font-size:.95rem;
      letter-spacing:.01em;
    }

    #bankRosterModal .input,
    #bankRosterModal .textarea,
    #rosterViewerModal .input,
    #rosterViewerModal .textarea{
      border-radius:10px;
      border:1px solid rgba(31,41,55,1);
      background:#020617;
      color:var(--text);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1);
    }

    #bankRosterModal .textarea,
    #rosterViewerModal .textarea{
      width:100%;
      padding:8px 10px;
      min-height:90px;
      resize:vertical;
      font-size:.8rem;
      outline:none;
    }

    #bankRosterModal .textarea:focus,
    #rosterViewerModal .textarea:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.8),0 0 14px rgba(37,99,235,.55);
    }

    /* Roster-lista: b√§ttre radlayout p√• sm√• sk√§rmar */
    #bankRosterModal #rosterRows .card-row{
      align-items:center;
      padding:6px 0;
      border-top:1px solid rgba(31,41,55,.7);
    }

    #bankRosterModal #rosterRows .card-row:first-child{
      border-top:none;
    }

    #bankRosterModal #rosterRows .btn.btn-danger{
      border-radius:12px;
    }

    @media (max-width:640px){
      #bankRosterModal .card,
      #rosterViewerModal .card{
        max-height:92vh;
        padding:10px;
      }
      #bankRosterModal #rosterRows .card-row > *{
        flex:1 1 100% !important;
      }
      #bankRosterModal #rosterRows .card-row div[style*="flex:0 0 160px"]{
        flex:1 1 100% !important;
        justify-content:flex-start !important;
      }
    }

    /* ---------- Responsivitet ---------- */

    @media (max-width:640px){
      .app{
        padding:8px 8px 24px;
      }
      .app-header{
        padding:8px 9px;
      }
      .levels-grid{
        grid-template-columns:1fr;
      }
      .play-header,
      .result-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .play-footer{
        flex-direction:column;
        align-items:flex-start;
      }
      .modal{
        padding:10px;
      }
    }

    /* ---------- F√§rger f√∂r niv√•kort (E / C / A) ---------- */

    #card-levelE{
      background:radial-gradient(circle at top,#ea580c,#b45309 55%,#020617 100%);
      border-color:rgba(234,88,12,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(234,88,12,.9);
    }

    #card-levelC{
      background:radial-gradient(circle at top,#1d4ed8,#1e40af 55%,#020617 100%);
      border-color:rgba(37,99,235,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(37,99,235,.9);
    }

    #card-levelA{
      background:radial-gradient(circle at top,#7c3aed,#6d28d9 55%,#020617 100%);
      border-color:rgba(124,58,237,.95);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 0 26px rgba(124,58,237,.9);
    }
  </style>

  <!-- Firebase CDN (v8 - namespaced) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

</head>
<!-- slut SEKTION 1: HEAD & STIL -->






<!-- start SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->
<body>
  <!-- start Sektion 2A: APP & HEADER -->
  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <h1><span class="logo">F</span>F√•ngvaktaren</h1>
      </div>
      <button id="btnTeacherMode" class="btn btn-sm btn-primary" type="button">üîë L√§rarl√§ge</button>
    </header>
  <!-- slut Sektion 2A: APP & HEADER -->

    <!-- start Sektion 2B: ELEVKORT -->
    <section id="studentCard" class="student-card">
      <div class="row student-main-row">
        <div class="field">
          <label for="studentName">Namn</label>
          <input id="studentName" class="input" placeholder="Elevens namn..." autocomplete="off" />
        </div>
        <div class="field">
          <label for="studentClass">Klass</label>
          <input id="studentClass" class="input" placeholder="Klass..." autocomplete="off" />
        </div>
        <div class="field student-save-field">
          <label>&nbsp;</label>
          <button id="btnSaveStudent" class="btn btn-sm btn-primary" type="button" style="width:100%;">üíæ Spara elev</button>
        </div>
      </div>

      <div class="student-status-row">
        <span id="studentSaved" class="student-saved-label">Ej sparad elev</span>
      </div>

      <div class="student-stats-row">
        <div class="score-box glow-box">
          <div class="score-label">Po√§ng</div>
          <div class="score-value" id="studentPointsValue">0 p</div>
        </div>
        <div class="score-box glow-box">
          <div class="score-label">Highscore</div>
          <div class="score-value" id="highscoreSummary">
            Ingen highscore √§nnu.
          </div>
        </div>
      </div>
    </section>
    <!-- slut Sektion 2B: ELEVKORT -->

    <!-- start Sektion 2C: NIV√ÖKORT -->
    <section class="levels-grid">
      <article id="card-levelE" class="level-card level-e locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 1</span>
            <small>Grundniv√• ‚Äì E</small>
          </div>
          <span id="badge-levelE" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelE">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelE">70</span>%</span>
          <span class="mini">L√•ses upp n√§r eleven sparat namn & klass.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• E-niv√•.</div>
          <button id="start-levelE" class="btn btn-sm" type="button" disabled>‚ñ∂Ô∏è Starta niv√• 1</button>
        </div>
      </article>

      <article id="card-levelC" class="level-card level-c locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 2</span>
            <small>Mellanniv√• ‚Äì C</small>
          </div>
          <span id="badge-levelC" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelC">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelC">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 1 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• C-niv√•.</div>
          <button id="start-levelC" class="btn btn-sm" type="button" disabled>‚ñ∂Ô∏è Starta niv√• 2</button>
        </div>
      </article>

      <article id="card-levelA" class="level-card level-a locked">
        <div class="level-header">
          <div class="level-title">
            <span>Niv√• 3</span>
            <small>Avancerad ‚Äì A</small>
          </div>
          <span id="badge-levelA" class="badge badge-lock">L√•st</span>
        </div>
        <div class="level-body">
          <span><strong>B√§sta resultat:</strong> <span id="best-levelA">0</span>%</span>
          <span><strong>Gr√§ns f√∂r godk√§nt:</strong> <span id="thres-levelA">70</span>%</span>
          <span class="mini">L√•ses upp n√§r Niv√• 2 har spelats klart.</span>
        </div>
        <div class="level-footer">
          <div class="hint">Fr√•gor p√• A-niv√•.</div>
          <button id="start-levelA" class="btn btn-sm" type="button" disabled>‚ñ∂Ô∏è Starta niv√• 3</button>
        </div>
      </article>
    </section>
    <!-- slut Sektion 2C: NIV√ÖKORT -->


<!-- start Sektion 2C-B: EXIT + APL-KNAPPAR (FRAMSIDA) -->
<style>
  .front-actions-wrap{
    max-width:980px;
    margin:16px auto 0;
    padding:0 10px;
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); /* st√∂rre kort */
    gap:14px;
  }

  .front-card-btn{
    --card-bg: radial-gradient(circle at top,#020617,#020617 60%,#000 100%);
    --card-border: rgba(31,41,55,1);
    --card-glow: rgba(59,130,246,.35);

    width:100%;
    border-radius:18px;
    border:1px solid var(--card-border);
    padding:22px 18px;                 /* st√∂rre yta */
    min-height:120px;                  /* st√∂rre h√∂jd (‚Äù150% k√§nsla‚Äù) */
    cursor:pointer;

    color:rgba(255,255,255,.96);
    background: var(--card-bg);
    box-shadow:
      0 0 0 1px rgba(15,23,42,1),
      0 0 28px var(--card-glow),
      0 16px 36px rgba(15,23,42,.9);

    transition:
      transform .12s ease,
      box-shadow .18s ease,
      filter .15s ease,
      border-color .15s ease,
      background .15s ease;

    /* NYTT: centrera inneh√•llet */
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
  }

  .front-card-btn:hover{
    transform:translateY(-1px);
    filter:brightness(1.03);
    box-shadow:
      0 0 0 1px rgba(148,163,184,.55),
      0 0 34px var(--card-glow),
      0 16px 36px rgba(15,23,42,.9);
  }

  .front-card-btn:active{
    transform:translateY(0);
    filter:brightness(.99);
    box-shadow:
      0 0 0 1px rgba(107,114,128,.75),
      0 0 22px var(--card-glow),
      0 16px 36px rgba(15,23,42,.9);
  }

  /* NYTT: st√∂rre, tydligare text */
  .front-card-label{
    font-weight:900;
    font-size:1.55rem;                 /* st√∂rre text */
    letter-spacing:.01em;
    line-height:1.05;
    text-shadow:0 1px 0 rgba(0,0,0,.35);
  }

  .front-card-btn:focus{ outline:none; }
  .front-card-btn:focus-visible{
    outline:2px solid rgba(59,130,246,.75);
    outline-offset:3px;
  }

  /* EXIT */
  .front-card-exit{
    --card-bg: radial-gradient(circle at top,#16a34a,#15803d 55%,#020617 100%);
    --card-border: rgba(74,222,128,.95);
    --card-glow: rgba(34,197,94,.65);
  }
  .front-card-exit:hover{
    --card-bg: radial-gradient(circle at top,#22c55e,#16a34a 55%,#020617 100%);
    --card-glow: rgba(34,197,94,.8);
  }

  /* APL */
  .front-card-apl{
    --card-bg: radial-gradient(circle at top,#f59e0b,#ea580c 55%,#020617 100%);
    --card-border: rgba(245,158,11,.98);
    --card-glow: rgba(245,158,11,.65);
  }
  .front-card-apl:hover{
    --card-bg: radial-gradient(circle at top,#fbbf24,#f59e0b 55%,#020617 100%);
    --card-glow: rgba(245,158,11,.8);
  }
</style>

<div class="front-actions-wrap">
  <button id="btnExitTicketFront" class="front-card-btn front-card-exit" type="button">
    <span class="front-card-label">üìù Exit-ticket</span>
  </button>

  <button id="btnAplFront" class="front-card-btn front-card-apl" type="button">
    <span class="front-card-label">üìç APL</span>
  </button>
</div>
<!-- slut Sektion 2C-B: EXIT + APL-KNAPPAR (FRAMSIDA) -->



    <!-- start Sektion 2D: SPELPANEL -->
    <section id="play" class="play-panel hidden">
      <header class="play-header">
        <div>
          <h2 id="play-title">Aktiv niv√•</h2>
          <small id="whoPlays">Ingen elev vald.</small>
        </div>
        <button id="btnCancel" class="btn btn-sm" type="button">‚¨ÖÔ∏è Avsluta utan att l√§mna in</button>
      </header>
      <div id="questions" class="questions">
        <div class="question mini">V√§lj en niv√• f√∂r att b√∂rja.</div>
      </div>
      <footer class="play-footer">
        <div class="mini">
          Svar registreras n√§r du klickar i alternativen eller sl√§pper kort i r√§tt ruta.
        </div>
        <div class="play-actions">
          <button id="btnSpeakQuestion" class="btn btn-sm" type="button">üîä L√§s upp fr√•gan</button>
          <button id="btnFinish" class="btn btn-sm btn-primary" type="button">‚úÖ L√§mna in niv√•</button>
        </div>
      </footer>
    </section>
    <!-- slut Sektion 2D: SPELPANEL -->

    <!-- start Sektion 2E: RESULTATPANEL -->
    <section id="result" class="result-panel hidden">
      <header class="result-header">
        <div>
          <div class="score" id="scoreText">0%<span> resultat</span></div>
          <div id="scoreDetail" class="result-meta">0/0 po√§ng</div>
          <div class="result-meta">
            Elev: <span id="resName">-</span> (<span id="resClass">-</span>)
          </div>
        </div>
        <div>
          <div id="passBadge" class="badge-fail">Resultat</div>
          <div id="unlockText" class="result-meta"></div>
        </div>
      </header>

      <div class="result-actions" id="resultActionsNormal">
        <button id="btnBack" class="btn btn-sm" type="button">‚¨ÖÔ∏è Tillbaka till niv√•er</button>
        <button id="btnSubmitGame" class="btn btn-sm btn-primary" type="button">‚úâÔ∏è L√§mna in spel f√∂r po√§ng</button>
      </div>
    </section>
    <!-- slut Sektion 2E: RESULTATPANEL -->
  </div>

  <!-- start Sektion 2F: EMBEDDED GRUNDBANK -->
  <script id="embedded-data" type="application/json">
  {
    "bank": {
      "mcq": [
        {
          "level": "E",
          "type": "mcq",
          "q": "Vad √§r viktigast f√∂rst n√§r du kommer till k√∂ket?",
          "options": ["Ta p√• f√∂rkl√§de", "Tv√§tta h√§nderna", "S√§tta p√• ugnen", "Smaka p√• maten"],
          "answer": 1
        },
        {
          "level": "C",
          "type": "mcq",
          "q": "En g√§st klagar p√• kall mat. Vad √§r ett bra f√∂rsta steg?",
          "options": ["Ignorera g√§sten", "Skylla p√• k√∂ket", "Be om urs√§kt och erbjuda l√∂sning", "S√§ga att det inte √§r ditt fel"],
          "answer": 2
        },
        {
          "level": "A",
          "type": "mcq",
          "q": "Du planerar en buff√©. Vad √§r viktigast f√∂r s√§ker livsmedelshantering?",
          "options": ["Att det ser fint ut", "Att alla r√§tter √§r varma samtidigt", "R√§tt temperaturer och tidsgr√§nser", "Att det finns m√•nga olika r√§tter"],
          "answer": 2
        }
      ]
    }
  }
  </script>
  <!-- slut Sektion 2F: EMBEDDED GRUNDBANK -->

  <!-- start Sektion 2G: L√ÑRARL√ÑGE ‚Äì GATE -->
  <div id="teacherGate" class="gate-backdrop hidden">
    <div class="gate-box">
      <h2>üîë L√§rarl√§ge</h2>
      <p id="teacherGateText">
        Ange l√§rarl√∂senord. F√∂rsta g√•ngen du loggar in blir l√∂senordet det du skriver h√§r.
      </p>
      <input id="teacherPasswordInput" class="input" type="password" placeholder="L√∂senord..." />
      <div class="gate-actions">
        <button id="btnTeacherCancel" class="btn btn-sm" type="button">Avbryt</button>
        <button id="btnTeacherConfirm" class="btn btn-sm btn-primary" type="button">Forts√§tt</button>
      </div>
    </div>
  </div>
  <!-- slut Sektion 2G: L√ÑRARL√ÑGE ‚Äì GATE -->

  <!-- start Sektion 2H: L√ÑRARL√ÑGE ‚Äì MODAL -->
  <div id="teacherModal" class="modal-backdrop hidden">
    <div class="modal">
      <header class="modal-header">
        <div>
          <h2>L√§rarl√§ge ‚Äì F√•ngvaktaren</h2>
          <small>Hantera inst√§llningar, fr√•gebank, bildfr√•gor, drag & drop, export och elevprogression.</small>
        </div>
        <button id="btnCloseTeacher" class="btn btn-sm" type="button">St√§ng</button>
      </header>

      <div class="modal-body">
        <nav class="tab-nav">
          <button class="tab-btn active" data-tab="settings" id="tab-settings" type="button">‚öôÔ∏è Inst√§llningar</button>
          <button class="tab-btn" data-tab="questions" id="tab-questions" type="button">üÖ∞Ô∏è Flervalsfr√•gor</button>
          <button class="tab-btn" data-tab="images" id="tab-images" type="button">üñºÔ∏è Bildfr√•gor</button>
          <button class="tab-btn" data-tab="dragdrop" id="tab-dragdrop" type="button">üéØ Drag & Drop</button>
          <button class="tab-btn" data-tab="progress" id="tab-progress" type="button">üìà Elevprogression</button>
          <button class="tab-btn" data-tab="bank" id="tab-bank" type="button">üóÇÔ∏è Fr√•gebank</button>
          <button class="tab-btn" data-tab="exit" id="tab-exit" type="button">üìù Exit ticket</button>
        </nav>

        <div class="tab-content">
          <section class="tab-panel" data-panel="settings">
            <div class="settings-grid">
              <div class="card">
                <h3>L√§rarl√∂senord</h3>
                <p>Det l√∂senord du anv√§nder f√∂r att √∂ppna l√§rarl√§get. H√§r kan du byta det.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputOldPassword">Nuvarande l√∂senord</label>
                    <input id="inputOldPassword" class="input" type="password" placeholder="L√§mna tomt om inget satt" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPassword">Nytt l√∂senord</label>
                    <input id="inputNewPassword" class="input" type="password" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputNewPasswordRepeat">Upprepa nytt l√∂senord</label>
                    <input id="inputNewPasswordRepeat" class="input" type="password" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnChangeTeacherPassword" class="btn btn-sm" type="button">üîê Spara nytt l√∂senord</button>
                </div>
                <p id="passwordStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Google-inloggning & uppladdning (l√§rare)</h3>
                <p>
                  Logga in med ditt Google-konto f√∂r att spara och ladda fr√•gebanker via Firebase.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label">Status</label>
                    <p id="googleStatus" class="mini">‚òÅÔ∏è Inte inloggad ‚Äì klicka f√∂r att logga in med Google.</p>
                  </div>
                  <div class="field">
                    <button id="btnGooglePlaceholder" class="btn btn-sm" type="button">
                      üîó Logga in med Google
                    </button>
                  </div>
                  <div class="field">
                    <button id="btnGoogleLogout" class="btn btn-sm hidden" type="button">
                      üö™ Logga ut fr√•n Google
                    </button>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Gr√§ns f√∂r godk√§nt per niv√•</h3>
                <p>Justera procentgr√§ns f√∂r E, C och A. Anv√§nds som riktm√§rke f√∂r ‚ÄùGodk√§nd niv√•‚Äù.</p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputThresE">Niv√• 1 (E)</label>
                    <input id="inputThresE" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresC">Niv√• 2 (C)</label>
                    <input id="inputThresC" type="number" min="0" max="100" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputThresA">Niv√• 3 (A)</label>
                    <input id="inputThresA" type="number" min="0" max="100" class="input-number" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveThresholds" class="btn btn-sm btn-primary" type="button">üíæ Spara niv√•-gr√§nser</button>
                </div>
              </div>

              <div class="card">
                <h3>L√§rarens e-post</h3>
                <p>
                  Anv√§nds som mottagare n√§r eleven l√§mnar in resultat via e-post
                  (‚ÄùSkapa e-post‚Äù p√• Elevresultat/JSON).
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputTeacherEmail">E-postadress</label>
                    <input id="inputTeacherEmail" class="input" placeholder="namn@skola.se" />
                  </div>
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
                  <button id="btnSaveTeacherEmail" class="btn btn-sm" type="button">üíæ Spara e-postadress</button>
                </div>
                <p id="teacherEmailStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Elevdata p√• denna enhet</h3>
                <p class="mini">
                  Dessa knappar p√•verkar bara den h√§r datorn/surfplattan. Anv√§nd dem n√§r du vill nollst√§lla progression lokalt.
                </p>
                <div class="card-row" style="margin-top:6px;gap:8px;flex-wrap:wrap;">
                  <button id="btnClearStudentData" class="btn btn-sm btn-danger" type="button">
                    üßπ Rensa elev + progression
                  </button>
                  <button id="btnResetGameData" class="btn btn-sm" type="button">
                    ‚ôªÔ∏è Nollst√§ll spelpo√§ng
                  </button>
                </div>
                <p id="resetStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card">
                <h3>Koppling: delm√•l & delbitar</h3>
                <p>
                  Skriv ett delm√•l och en delbit i taget. Klicka p√• ‚ÄùL√§gg till delbit‚Äù
                  f√∂r att l√§gga till i listan. ‚ÄùSpara‚Äù skriver listan till spelets minne
                  (localStorage). ‚ÄùTa bort alla‚Äù rensar listan.
                </p>
                <div class="card-row">
                  <div class="field">
                    <label class="small-label" for="inputGoalSingle">Delm√•l</label>
                    <input id="inputGoalSingle" class="input" placeholder="t.ex. Delm√•l 5 ‚Äì Hygien i k√∂ket" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="inputPartSingle">Delbit</label>
                    <input id="inputPartSingle" class="input" placeholder="t.ex. 51‚Äì60 eller 51,52,53" />
                  </div>
                </div>
                <div class="card-row" style="margin-top:6px;">
                  <button id="btnAddGoalPart" class="btn btn-sm" type="button">‚ûï L√§gg till delbit</button>
                </div>
                <p id="goalsStatus" class="mini" style="margin-top:6px;"></p>
              </div>

              <div class="card card-full-width">
                <h3>Aktuella delm√•l och delbitar</h3>
                <p class="mini">Nedan visas de delm√•l och delbitar som √§r sparade i spelet just nu.</p>
                <ul id="goalsList" class="goals-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="questions">
            <div class="questions-editor">
              <h3>Hantera flervalsfr√•gor (MCQ)</h3>
              <p class="mini">
                L√§gg till nya flervalsfr√•gor, redigera eller importera m√•nga p√• en g√•ng.
              </p>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Snabbimport av flervalsfr√•gor</h3>
                <p class="mini">
                  Klistra in fr√•gor i formatet nedan. En asterisk (*) framf√∂r r√§tt svar.
                  En tom rad mellan fr√•gorna √§r bra men inte ett krav.
                </p>
                <pre class="mini" style="background:#020617;border-radius:6px;padding:8px;margin-top:4px;white-space:pre-wrap;">
Vilken av dessa √§r en proteink√§lla?
*Kycklingfil√©
√Ñpple
Gurka
P√§ron

Vilken av dessa √§r en frukt?
√Ñpple
*P√§ron
Potatis
Gurka
                </pre>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqJsonLevel">Niv√•</label>
                    <select id="mcqJsonLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqJsonGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqJsonGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <textarea
                  id="mcqJsonInput"
                  class="input"
                  rows="8"
                  placeholder="Klistra in dina fr√•gor h√§r..."
                  style="margin-top:8px;font-family:monospace;border-radius:6px;"
                ></textarea>
                <div style="margin-top:8px;display:flex;justify-content:flex-end;">
                  <button id="btnMcqJsonImport" class="btn btn-sm btn-primary" type="button">
                    üì• Importera fr√•gor fr√•n text
                  </button>
                </div>
              </div>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera fr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="mcqLevel">Niv√•</label>
                    <select id="mcqLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqQuestion">Fr√•getext</label>
                    <input id="mcqQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="0" id="mcqCorrect0" style="margin-right:4px;" />
                      Alternativ 1
                    </label>
                    <input id="mcqOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="1" id="mcqCorrect1" style="margin-right:4px;" />
                      Alternativ 2
                    </label>
                    <input id="mcqOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="2" id="mcqCorrect2" style="margin-right:4px;" />
                      Alternativ 3
                    </label>
                    <input id="mcqOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="mcqCorrect" value="3" id="mcqCorrect3" style="margin-right:4px;" />
                      Alternativ 4
                    </label>
                    <input id="mcqOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="mcqAnswer">Korrekt svar (Index)</label>
                    <input id="mcqAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="mcqGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="mcqGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnMcqAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till fr√•ga</button>
                    <button id="btnMcqUpdate" class="btn btn-sm hidden" type="button">üíæ Spara √§ndring</button>
                  </div>
                  <button id="btnMcqClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella flervalsfr√•gor (<span id="mcqCount">0</span> st)</h3>
                <ul id="mcqList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="images">
            <div class="questions-editor">
              <h3>Hantera bildfr√•gor (IMG)</h3>
              <p class="mini">L√§gg till fr√•gor d√§r en bild visas tillsammans med flervalsalternativ.</p>

              <div class="card" style="margin-top:15px;">
                <h4>L√§gg till/Redigera bildfr√•ga</h4>
                <div class="card-row">
                  <div class="field" style="flex:0 0 100px;">
                    <label class="small-label" for="imgLevel">Niv√•</label>
                    <select id="imgLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgQuestion">Fr√•getext</label>
                    <input id="imgQuestion" class="input" placeholder="Skriv fr√•gan h√§r..." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="imgFile">Bildfil</label>
                    <input id="imgFile" type="file" accept="image/*" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:8px;">
                  <div class="field">
                    <label class="small-label">F√∂rhandsvisning</label>
                    <div id="imgPreview" class="img-preview-box mini">Ingen bild vald √§nnu.</div>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="0" id="imgCorrect0" style="margin-right:4px;" />
                      Alternativ 1
                    </label>
                    <input id="imgOption0" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="1" id="imgCorrect1" style="margin-right:4px;" />
                      Alternativ 2
                    </label>
                    <input id="imgOption1" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="2" id="imgCorrect2" style="margin-right:4px;" />
                      Alternativ 3
                    </label>
                    <input id="imgOption2" class="input" />
                  </div>
                  <div class="field">
                    <label class="small-label">
                      <input type="radio" name="imgCorrect" value="3" id="imgCorrect3" style="margin-right:4px;" />
                      Alternativ 4
                    </label>
                    <input id="imgOption3" class="input" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;">
                  <div class="field" style="flex:0 0 120px;">
                    <label class="small-label" for="imgAnswer">Korrekt svar (Index)</label>
                    <input id="imgAnswer" type="number" min="0" max="3" class="input-number" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="imgGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="imgGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:15px;justify-content:space-between;">
                  <div>
                    <button id="btnImgAdd" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till bildfr√•ga</button>
                  </div>
                  <button id="btnImgClear" class="btn btn-sm btn-secondary" type="button">
                    Avbryt/Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:15px;">
                <h3>Aktuella bildfr√•gor (<span id="imgCount">0</span> st)</h3>
                <ul id="imgList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="dragdrop">
            <div class="questions-editor">
              <h3>Hantera Drag &amp; Drop-fr√•gor</h3>
              <p class="mini">Skapa korta fr√•gor d√§r eleverna drar ord/begrepp till r√§tt kolumn.</p>

              <div class="card" style="margin-top:10px;max-width:720px;margin-left:auto;margin-right:auto;padding:10px;">
                <h4>Bygg fr√•ga (kompakt)</h4>
                <div class="card-row" style="margin-top:6px;">
                  <div class="field" style="flex:0 0 90px;">
                    <label class="small-label" for="dragLevel">Niv√•</label>
                    <select id="dragLevel" class="input">
                      <option value="E">E</option>
                      <option value="C">C</option>
                      <option value="A">A</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragQuestion">Instruktion</label>
                    <input id="dragQuestion" class="input" placeholder="Ex: Dra r√§tt livsmedel till 'Kylvara'." />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragColumn1">Kolumn 1</label>
                    <input id="dragColumn1" class="input" placeholder="t.ex. Kylvara" />
                  </div>
                  <div class="field">
                    <label class="small-label" for="dragColumn2">Kolumn 2</label>
                    <input id="dragColumn2" class="input" placeholder="t.ex. Torrvara" />
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragItemText">Objekt att dra</label>
                    <input id="dragItemText" class="input" placeholder="t.ex. 'R√• kyckling'" />
                  </div>
                  <div class="field" style="flex:0 0 140px;">
                    <label class="small-label" for="dragItemCorrect">Korrekt kolumn</label>
                    <select id="dragItemCorrect" class="input">
                      <option value="0">Kolumn 1</option>
                      <option value="1">Kolumn 2</option>
                    </select>
                  </div>
                  <div class="field" style="flex:0 0 110px;">
                    <label class="small-label">&nbsp;</label>
                    <button id="btnDragAddItem" class="btn btn-sm btn-primary" type="button" style="width:100%;">‚ûï L√§gg till</button>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label">Objekt i denna fr√•ga</label>
                    <ul id="dragItemsPreview" class="question-list"></ul>
                  </div>
                </div>

                <div class="card-row" style="margin-top:6px;">
                  <div class="field">
                    <label class="small-label" for="dragGoalPart">Kopplad delbit (valfritt)</label>
                    <select id="dragGoalPart" class="input">
                      <option value="">Ingen koppling</option>
                    </select>
                  </div>
                </div>

                <div class="card-row" style="margin-top:10px;justify-content:space-between;">
                  <div>
                    <button id="btnDragAddQuestion" class="btn btn-sm btn-primary" type="button">üíæ Spara fr√•ga</button>
                  </div>
                  <button id="btnDragClearForm" class="btn btn-sm btn-secondary" type="button">
                    Rensa formul√§r
                  </button>
                </div>
              </div>

              <div class="card card-full-width" style="margin-top:10px;">
                <h3>Aktuella Drag &amp; Drop-fr√•gor (<span id="dragCount">0</span> st)</h3>
                <ul id="dragList" class="question-list"></ul>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="progress">
            <div class="card">
              <h3>Elevprogression</h3>
              <p class="mini">
                H√§r kan du sammanfatta vad eleven √§r stark p√•, vad som beh√∂ver √∂vas och exportera en JSON-text till elevkortet.
              </p>

              <div class="progress-grid">
                <div class="progress-box" id="progressPointsBox">
                  <h4>Elevens po√§ng (lokalt)</h4>
                  <p id="progressPointsText" class="mini">
                    Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.
                  </p>

                  <div style="margin-top:10px;">
                    <h4>Elever (aktiv bank)</h4>

                    <div id="playedStudentsTabs" class="tab-nav" style="margin-top:6px;">
                      <ul id="rosterTabs" class="mini tab-nav" style="margin:0;padding:0;list-style:none;">
                        <li class="mini">Ingen elev inl√§st √§nnu.</li>
                      </ul>
                    </div>

                    <ul id="playedStudentsList" class="goals-list mini hidden">
                      <li>Ingen elev inl√§st √§nnu.</li>
                    </ul>
                  </div>
                </div>

                <div class="progress-box" id="progressStrongBox">
                  <h4>Starka delbitar</h4>
                  <ul id="progressStrongList" class="goals-list mini">
                    <li>Inga starka delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressWeakBox">
                  <h4>Delbitar att √∂va p√•</h4>
                  <ul id="progressWeakList" class="goals-list mini">
                    <li>Inga svaga delbitar inl√§sta √§nnu.</li>
                  </ul>
                </div>

                <div class="progress-box" id="progressExportBox">
                  <h4>Export till elevkort (JSON)</h4>
                  <p class="mini">
                    N√§r du √§r n√∂jd med en elevs progression kan du skapa en JSON-str√§ng som klistras in i elevkortet.
                  </p>
                  <textarea
                    id="progressExportJson"
                    class="input"
                    rows="4"
                    readonly
                    style="font-family:monospace;font-size:0.8rem;border-radius:6px;"
                  ></textarea>
                  <div style="margin-top:6px;display:flex;gap:8px;justify-content:flex-end;">
                    <button id="btnGenerateProgressJson" class="btn btn-sm" type="button">üîÅ Skapa JSON</button>
                    <button id="btnCopyProgressJson" class="btn btn-sm btn-primary" type="button">üìã Kopiera kod</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section class="tab-panel hidden" data-panel="bank">
            <div class="settings-grid">
              <div class="card">
                <h3>Ladda fr√•gebank fr√•n molnet (Firebase)</h3>
                <p class="mini">
                  Visar bankar som har sparats p√• ditt Google-konto. Aktivera bankarna nedan f√∂r att l√§gga till fr√•gorna i spelet.
                </p>
                <p id="cloudBankStatus" class="mini" style="margin-top:4px;"></p>
                <ul id="cloudBankList" class="goals-list" style="margin-top:10px;"></ul>
                <div style="margin-top:10px;">
                  <button id="btnLoadCloudBanks" class="btn btn-sm" type="button">‚òÅÔ∏è Ladda moln-bankar</button>
                </div>
              </div>

              <div class="card">
                <h3>Spara aktuell fr√•gebank till molnet</h3>
                <p class="mini">
                  Namnge din fr√•gebank. Sparar *alla* fr√•gor du skapat i flervals-, bild- och drag/drop-flikarna.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <div class="field">
                    <label class="small-label" for="inputBankName">Namn p√• fr√•gebank</label>
                    <input id="inputBankName" class="input" placeholder="T.ex. Livsmedel HT25" />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <button id="btnSaveToCloud" class="btn btn-sm btn-primary" type="button">üíæ Spara bank till molnet</button>
                </div>
              </div>

              <div class="card card-full-width">
                <h3>Export / Import av fr√•gebank (JSON)</h3>
                <p class="mini">
                  Exportera hela din nuvarande fr√•gebank som en JSON-fil (s√§kerhetskopia) eller importera en befintlig bank fr√•n fil.
                </p>
                <div class="card-row" style="margin-top:10px;">
                  <button id="btnExportBank" class="btn btn-sm" type="button">‚¨áÔ∏è Exportera till JSON</button>
                  <label class="btn btn-sm" for="fileImport">‚¨ÜÔ∏è Importera fr√•n JSON</label>
                  <input type="file" id="fileImport" accept=".json" style="display:none;" />
                </div>
              </div>
            </div>
          </section>

          <!-- start Sektion 2H-B: TABBPANEL ‚Äì Exit ticket (EDITABLE TEMPLATE) -->
          <section class="tab-panel hidden" data-panel="exit">
            <div class="settings-grid">
              <div class="card">
                <h3>Exit ticket (lektion)</h3>
                <p class="mini">
                  L√§raren kan anpassa vilka fr√•gor som ing√•r. Eleverna ser samma fr√•gor n√§r de klickar ‚ÄúExit ticket‚Äù p√• startsidan.
                </p>

                <div class="card card-full-width" style="margin-top:10px;">
                  <div class="card-row" style="justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
                    <h4 style="margin:0;">Fr√•gor</h4>
                    <div class="card-row" style="gap:8px;flex-wrap:wrap;">
                      <button id="btnExitAddQuestion" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till fr√•ga</button>
                      <button id="btnExitResetTemplate" class="btn btn-sm" type="button">√Öterst√§ll standard</button>
                    </div>
                  </div>

                  <div id="exitAddWrap" class="card" style="margin-top:10px;display:none;">
                    <h4 style="margin:0 0 6px 0;">Ny fr√•ga</h4>

                    <div class="card-row" style="gap:10px;flex-wrap:wrap;align-items:flex-end;">
                      <div class="field" style="min-width:220px;flex:1 1 220px;">
                        <label class="small-label" for="exitNewType">Typ</label>
                        <select id="exitNewType" class="input">
                          <option value="scale">Skala 1‚Äì5</option>
                          <option value="yesno">Ja / Nej</option>
                          <option value="text">Kort svar</option>
                        </select>
                      </div>

                      <div class="field" style="min-width:260px;flex:2 1 260px;">
                        <label class="small-label" for="exitNewLabel">Fr√•getext</label>
                        <input id="exitNewLabel" class="input" type="text" placeholder="Skriv fr√•gan..." />
                      </div>

                      <div class="field" style="min-width:140px;flex:0 0 auto;">
                        <label class="mini" style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                          <input id="exitNewRequired" type="checkbox" />
                          Obligatorisk
                        </label>
                      </div>
                    </div>

                    <div id="exitNewYesnoFollowWrap" class="field" style="margin-top:10px;display:none;">
                      <label class="mini" style="display:flex;gap:8px;align-items:center;">
                        <input id="exitNewYesnoFollow" type="checkbox" />
                        Om eleven svarar ‚ÄúJa‚Äù ‚Üí visa f√∂ljdfr√•ga (text)
                      </label>

                      <div style="margin-top:8px;">
                        <label class="small-label" for="exitNewYesnoFollowLabel">F√∂ljdfr√•ga (om Ja)</label>
                        <input id="exitNewYesnoFollowLabel" class="input" type="text" placeholder="Ex: Vad beh√∂ver du √∂va p√•?" />
                        <label class="mini" style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                          <input id="exitNewYesnoFollowReq" type="checkbox" checked />
                          F√∂ljdfr√•gan √§r obligatorisk
                        </label>
                      </div>
                    </div>

                    <div class="card-row" style="justify-content:flex-end;gap:8px;margin-top:10px;flex-wrap:wrap;">
                      <button id="btnExitAddCancel" class="btn btn-sm" type="button">Avbryt</button>
                      <button id="btnExitAddSave" class="btn btn-sm btn-primary" type="button">Spara fr√•ga</button>
                    </div>
                  </div>

                  <div id="exitQuestionsList" style="margin-top:10px;"></div>
                </div>

                <p class="mini" style="margin-top:10px;">
                  Tips: ‚ÄúJa/Nej‚Äù kan ha en f√∂ljdfr√•ga som bara visas om eleven svarar Ja (t.ex. ‚ÄúVad beh√∂ver du √∂va p√•?‚Äù).
                </p>
              </div>
            </div>
          </section>
          <!-- slut Sektion 2H-B: TABBPANEL ‚Äì Exit ticket (EDITABLE TEMPLATE) -->
        </div>
      </div>
    </div>
  </div>
  <!-- slut Sektion 2H: L√ÑRARL√ÑGE ‚Äì MODAL -->

  <!-- start Sektion 2I: ROSTER-MODAL -->
  <div id="bankRosterModal" class="hidden">
    <div class="card">
      <div class="card-row" style="justify-content:space-between;align-items:center;">
        <div class="field" style="flex:1 1 auto;">
          <h3>Elever (aktiv bank)</h3>
          <p class="mini" style="margin:4px 0 0;">
            L√§gg in elevens namn och e-post. Klicka ‚úâÔ∏è f√∂r att skapa mejl med spell√§nk. Knappen blir gr√∂n efter mejl.
          </p>
        </div>
        <div class="field" style="flex:0 0 140px;display:flex;justify-content:flex-end;">
          <button id="btnCloseRosterModal" class="btn btn-sm" type="button">St√§ng</button>
        </div>
      </div>

      <div class="card-row" style="margin-top:8px;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
        <button id="btnRosterAddRow" class="btn btn-sm btn-primary" type="button">‚ûï L√§gg till elevrad</button>
        <button id="btnRosterSave" class="btn btn-sm" type="button">üíæ Spara elevlista</button>
      </div>

      <div id="rosterRows" style="margin-top:10px;"></div>
    </div>
  </div>
  <!-- slut Sektion 2I: ROSTER-MODAL -->
</body>
<!-- slut SEKTION 2: BODY (ELEVYTA & L√ÑRARL√ÑGE) -->







<!-- start SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker, roster, progression, editor-refresh) -->
<script>
"use strict";

/* =========================================================
   Sektion 3A: K√ÑRNA (state + helpers + safe storage)
   ========================================================= */

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCMDcMxvZdtdQB3I4SJdibcq9UPJ7Mg1u8",
  authDomain: "fangvaktaren-904db.firebaseapp.com",
  projectId: "fangvaktaren-904db",
  storageBucket: "fangvaktaren-904db.firebasestorage.app",
  messagingSenderId: "105301219768",
  appId: "1:105301219768:web:66b131fba86a541b78174d",
  measurementId: "G-NXL9GSFZ77"
};

const STORAGE_KEY = "fangvaktaren-v17";
const CLOUD_ROOT_COLLECTION = "teachers";
const CLOUD_BANKS_SUBCOLLECTION = "banks";
const PUBLIC_BANKS_COLLECTION = "public_banks";
const TEACHER_LOCAL_ROSTER_KEY = STORAGE_KEY + "::teacherRosterByBankId_v1";

/* (APL) ‚Äì minimal plumbing (UI ligger i annan sektion) */
const APL_CHECKIN_COLLECTION = "apl_checkins"; // om du vill logga checkins i en egen top-level collection
const APL_DEFAULT_WINDOW_MINUTES = 20;

function _fv_sel(q){ return document.querySelector(q); }
function _fv_selAll(q){ return document.querySelectorAll(q); }
function _fv_getEl(id){ return document.getElementById(id); }

function _fv_escapeHtml(str){
  if (!str && str !== 0) return "";
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function _fv_deepClone(obj){
  try{ return JSON.parse(JSON.stringify(obj)); }catch{ return {}; }
}

function _fv_ensureBankShape(bank){
  const b = Object.assign({ mcq: [], img: [], drag: [] }, bank || {});
  if (!Array.isArray(b.mcq)) b.mcq = [];
  if (!Array.isArray(b.img)) b.img = [];
  if (!Array.isArray(b.drag)) b.drag = [];
  return b;
}

const _fv_defaultState = {
  student: { name: "", klass: "", token: "" },
  teacherEmail: "",
  teacherPassword: "",
  goalsMap: [],
  bank: { mcq: [], img: [], drag: [] },
  activeBank: { mode: "", ownerUid: "", bankId: "", publicId: "", name: "" },
  best: { E: 0, C: 0, A: 0 },
  thres: { E: 70, C: 70, A: 70 },
  lastSubmission: null,
  progression: { totalPoints: 0, wrongByGoalId: {}, correctByGoalId: {} },
  meta: { embeddedMerged: false }
};

function _fv_normalizeState(s){
  s = s && typeof s === "object" ? s : _fv_deepClone(_fv_defaultState);

  s.student = Object.assign({ name:"", klass:"", token:"" }, s.student || {});
  s.teacherEmail = String(s.teacherEmail || "");
  s.teacherPassword = String(s.teacherPassword || "");

  s.goalsMap = Array.isArray(s.goalsMap) ? s.goalsMap : [];
  s.bank = _fv_ensureBankShape(s.bank);

  s.activeBank = Object.assign({ mode:"", ownerUid:"", bankId:"", publicId:"", name:"" }, s.activeBank || {});
  s.best = Object.assign({ E:0, C:0, A:0 }, s.best || {});
  s.thres = Object.assign({ E:70, C:70, A:70 }, s.thres || {});

  s.lastSubmission = s.lastSubmission || null;

  s.progression = (s.progression && typeof s.progression === "object")
    ? s.progression
    : { totalPoints:0, wrongByGoalId:{}, correctByGoalId:{} };

  s.progression.totalPoints = Number(s.progression.totalPoints || 0) || 0;
  s.progression.wrongByGoalId = s.progression.wrongByGoalId || {};
  s.progression.correctByGoalId = s.progression.correctByGoalId || {};

  s.meta = (s.meta && typeof s.meta === "object") ? s.meta : { embeddedMerged:false };
  if (typeof s.meta.embeddedMerged !== "boolean") s.meta.embeddedMerged = false;

  return s;
}

function _fv_hasAnyLocalBank(s){
  try{
    const b = s && s.bank ? s.bank : null;
    return !!(b && (
      (Array.isArray(b.mcq) && b.mcq.length) ||
      (Array.isArray(b.img) && b.img.length) ||
      (Array.isArray(b.drag) && b.drag.length)
    ));
  }catch{ return false; }
}

function _fv_mergeEmbeddedBank(state){
  const el = _fv_getEl("embedded-data");
  if (!el) return state;
  try{
    const raw = el.textContent || el.innerHTML || "{}";
    const data = JSON.parse(raw);

    if (data && data.bank){
      state.bank = _fv_ensureBankShape(state.bank);
      const eb = _fv_ensureBankShape(data.bank);
      state.bank.mcq = (state.bank.mcq || []).concat(eb.mcq || []);
      state.bank.img = (state.bank.img || []).concat(eb.img || []);
      state.bank.drag = (state.bank.drag || []).concat(eb.drag || []);
    }
    if (data && Array.isArray(data.goalsMap)){
      state.goalsMap = data.goalsMap.slice();
    }
  }catch(e){
    console.warn("Kunde inte l√§sa embedded-data:", e);
  }
  return state;
}

function loadState(){
  let s = null;
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) s = JSON.parse(raw);
  }catch(e){
    console.warn("Kunde inte l√§sa state:", e);
  }

  s = _fv_normalizeState(s);

  try{
    if (s.meta.embeddedMerged !== true && !_fv_hasAnyLocalBank(s)){
      s = _fv_mergeEmbeddedBank(s);
      s.meta = s.meta && typeof s.meta === "object" ? s.meta : {};
      s.meta.embeddedMerged = true;
      saveState(s);
    }else if (s.meta.embeddedMerged !== true && _fv_hasAnyLocalBank(s)){
      s.meta.embeddedMerged = true;
      saveState(s);
    }
  }catch{}

  return _fv_normalizeState(s);
}

function saveState(state){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(_fv_normalizeState(state))); }
  catch(e){ console.warn("Kunde inte spara state:", e); }
}

function setActiveBankMeta(meta){
  const s = loadState();
  s.activeBank = Object.assign({ mode:"", ownerUid:"", bankId:"", publicId:"", name:"" }, s.activeBank || {}, meta || {});
  saveState(s);
  try{ window.activeCloudBankId = String(s.activeBank.bankId || ""); }catch{}
}

/* =========================================================
   Sektion 3B: FIREBASE (init + auth)
   ========================================================= */

let firebaseAppInstance = null;
let firebaseAuthInstance = null;
let firebaseDbInstance = null;
let currentTeacherUser = null;

(function FV_FirebaseReadyBootstrap(){
  if (!window.__fvFirebaseReadyPromise){
    window.__fvFirebaseReadyPromise = new Promise((resolve)=>{ window.__fvFirebaseReadyResolve = resolve; });
  }
})();

async function initFirebase(){
  if (window.__fvFirebaseInitPromise) return window.__fvFirebaseInitPromise;

  window.__fvFirebaseInitPromise = (async ()=>{
    try{
      if (!window.firebase){
        console.warn("Firebase-bibliotek saknas.");
        try{ if (window.__fvFirebaseReadyResolve) window.__fvFirebaseReadyResolve(false); }catch{}
        return false;
      }

      if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);

      firebaseAppInstance = firebase.app();
      firebaseAuthInstance = firebase.auth();
      firebaseDbInstance = firebase.firestore();

      try{
        window.firebaseAppInstance = firebaseAppInstance;
        window.firebaseAuthInstance = firebaseAuthInstance;
        window.firebaseDbInstance = firebaseDbInstance;
      }catch{}

      if (firebaseAuthInstance && !firebaseAuthInstance.__fvBound){
        firebaseAuthInstance.__fvBound = true;
        firebaseAuthInstance.onAuthStateChanged((user)=>{
          currentTeacherUser = user || null;
          try{ window.currentTeacherUser = currentTeacherUser; }catch{}

          const statusEl = _fv_getEl("googleStatus");
          const btnLogout = _fv_getEl("btnGoogleLogout");
          if (statusEl){
            if (user){
              statusEl.textContent = `‚òÅÔ∏è Inloggad som ${user.email || "l√§rare"} ‚Äì moln-banker aktiverade.`;
              if (btnLogout) btnLogout.classList.remove("hidden");
            }else{
              statusEl.textContent = "‚òÅÔ∏è Inte inloggad ‚Äì klicka p√• Google f√∂r att logga in.";
              if (btnLogout) btnLogout.classList.add("hidden");
            }
          }
        });
      }

      if (!window.__fv_firebase_inited_log){
        window.__fv_firebase_inited_log = true;
        console.log("Firebase init OK");
      }

      try{
        if (window.__fvFirebaseReadyResolve) window.__fvFirebaseReadyResolve(true);
        window.dispatchEvent(new CustomEvent("fv-firebase-ready"));
      }catch{}

      return true;
    }catch(e){
      console.error("Fel vid initFirebase:", e);
      try{ if (window.__fvFirebaseReadyResolve) window.__fvFirebaseReadyResolve(false); }catch{}
      return false;
    }
  })();

  return window.__fvFirebaseInitPromise;
}

function _fv_hasDb(){ return !!firebaseDbInstance; }
function _fv_hasTeacher(){ return !!(currentTeacherUser && currentTeacherUser.uid); }

async function handleGoogleLogin(){
  const ok = await initFirebase();
  if (!ok || !firebaseAuthInstance){ alert("Tekniskt fel: Firebase Auth saknas."); return; }
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await firebaseAuthInstance.signInWithPopup(provider);
  }catch(err){
    console.error("Google-inloggning misslyckades:", err);
    const statusEl = _fv_getEl("googleStatus");
    if (statusEl) statusEl.textContent = "‚ö†Ô∏è Kunde inte logga in med Google. F√∂rs√∂k igen.";
  }
}

async function handleGoogleLogout(){
  try{ if (firebaseAuthInstance) await firebaseAuthInstance.signOut(); }
  catch(err){ console.error("Kunde inte logga ut:", err); }
}

/* =========================================================
   Sektion 3C: MOLN + ROSTER + PROGRESSION + UI-BIND (samlat, utan dubbla block)
   ========================================================= */

/* ---------- Cloud helpers ---------- */

let _fvCloudBanksRenderSeq = 0;
let _fvCloudBanksLatestSeq = 0;

function _fv_fmtUpdatedAt(v){
  try{
    if (!v) return "-";
    const pad = (n)=> String(n).padStart(2,"0");
    if (typeof v === "string") return v;
    if (typeof v.toDate === "function"){
      const d = v.toDate();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    if (typeof v.seconds !== "undefined"){
      const d = new Date(Number(v.seconds)*1000);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
  }catch{}
  return "-";
}

function _fv_pickBankObj(data){
  try{
    if (!data) return _fv_ensureBankShape({});
    if (data.bank) return _fv_ensureBankShape(data.bank);
    if (data.questions) return _fv_ensureBankShape(data.questions);
    if (Array.isArray(data.mcq) || Array.isArray(data.img) || Array.isArray(data.drag)) return _fv_ensureBankShape(data);
  }catch{}
  return _fv_ensureBankShape({});
}

function _fv_getRosterTokensCount(data){
  try{
    const rt = data && data.rosterTokens;
    if (!Array.isArray(rt)) return 0;
    return rt.map(String).filter(t=>String(t||"").trim()).length;
  }catch{ return 0; }
}

function _fv_getCloudBankNameFromUI(){
  const ids = ["inputBankName","cloudBankName","bankName","bankNameInput","cloudBankTitle","txtCloudBankName"];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el && typeof el.value === "string" && el.value.trim()) return el.value.trim();
  }
  return "";
}

function _fv_getCloudListHost(){
  return (
    _fv_getEl("cloudBankList") ||
    _fv_getEl("cloudBanksListV5") ||
    _fv_getEl("cloudBanksListV4") ||
    _fv_getEl("cloudBanksList") ||
    _fv_getEl("cloudBanksListV3")
  );
}

function _fv_getCloudStatusEl(){
  return (
    _fv_getEl("cloudBankStatus") ||
    _fv_getEl("cloudBanksStatus") ||
    _fv_getEl("cloudBanksStatusV5") ||
    _fv_getEl("fv3-cloud-status")
  );
}

function _fv_setCloudStatus(msg){
  const el = _fv_getCloudStatusEl();
  if (!el) return;
  el.textContent = String(msg || "");
}

function _fv_ensureCloudStyles(){
  if (_fv_getEl("fv3-styles")) return;
  const st = document.createElement("style");
  st.id = "fv3-styles";
  st.textContent = `
    .cloud-bank-active{
      border-color:rgba(74,222,128,.95) !important;
      box-shadow: 0 0 0 1px rgba(22,163,74,1), 0 0 16px rgba(34,197,94,.55), 0 12px 28px rgba(15,23,42,.9) !important;
    }
    .cloud-bank-active .mini{ color:#bbf7d0 !important; }
    .fv3-actions{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .fv3-btn-xs{ padding:4px 8px; font-size:.74rem; border-radius:999px; }
  `;
  document.head.appendChild(st);
}

/* ---------- Cloud actions ---------- */

async function loadCloudBankToLocal(bankId){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Firebase ej redo eller ej inloggad");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId || "").trim();
  if (!bid) throw new Error("Saknar bankId");

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  const snap = await ref.get();
  if (!snap.exists) throw new Error("Bank finns inte: " + bid);

  const d = snap.data() || {};
  const bank = _fv_pickBankObj(d);
  const goalsMap = Array.isArray(d.goalsMap) ? d.goalsMap : [];

  const s = loadState();
  s.bank = _fv_ensureBankShape(bank);
  s.goalsMap = goalsMap;
  saveState(s);

  setActiveBankMeta({
    mode: "teacher",
    ownerUid: uid,
    bankId: bid,
    publicId: String(d.publicId || ""),
    name: String(d.name || d.title || d.bankName || "")
  });

  try{ window.activeCloudBankId = bid; }catch{}

  try{
    window.dispatchEvent(new CustomEvent("fv-bank-changed", { detail: { source:"cloud", bankId: bid } }));
  }catch{}

  try{ if (typeof window.fvRefreshTeacherBankUI === "function") window.fvRefreshTeacherBankUI(); }catch{}
}

async function updateActiveCloudBankFromLocalV5(bankId){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Firebase ej redo eller ej inloggad");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId || "").trim();
  if (!bid) throw new Error("Saknar bankId");

  const s = loadState();
  const activeId = String(s.activeBank && s.activeBank.bankId ? s.activeBank.bankId : (window.activeCloudBankId||""));
  if (!activeId || activeId !== bid) throw new Error("Banken √§r inte aktiv (aktivera den f√∂rst)");

  const desiredName = _fv_getCloudBankNameFromUI() || String(s.activeBank.name || "").trim() || "Moln-bank";

  const payload = {
    name: desiredName || "Moln-bank",
    bank: _fv_ensureBankShape(s.bank || {}),
    goalsMap: Array.isArray(s.goalsMap) ? s.goalsMap : [],
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  await ref.set(payload, { merge:true });

  setActiveBankMeta({
    mode: "teacher",
    ownerUid: uid,
    bankId: bid,
    publicId: String(s.activeBank.publicId || ""),
    name: payload.name
  });

  try{ window.activeCloudBankId = bid; }catch{}
}

async function handleSaveToCloudV5(){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()){
    alert("Logga in med Google f√∂rst.");
    return;
  }

  const uid = String(currentTeacherUser.uid);
  const banksRef = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION);

  const s = loadState();
  const desiredName = _fv_getCloudBankNameFromUI() || String(s.activeBank.name || "").trim();

  const hasActive = !!(s.activeBank && String(s.activeBank.bankId||"").trim());
  const activeName = String(s.activeBank && s.activeBank.name ? s.activeBank.name : "").trim();
  const shouldCreateNew = !!(desiredName && (!hasActive || desiredName !== activeName));

  const bankPayload = {
    name: desiredName || "Moln-bank",
    bank: _fv_ensureBankShape(s.bank || {}),
    goalsMap: Array.isArray(s.goalsMap) ? s.goalsMap : [],
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    if (shouldCreateNew){
      const newDoc = banksRef.doc();
      await newDoc.set(Object.assign({}, bankPayload, {
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }), { merge:true });

      setActiveBankMeta({ mode:"teacher", ownerUid: uid, bankId: newDoc.id, publicId:"", name: bankPayload.name });
      try{ window.activeCloudBankId = String(newDoc.id); }catch{}
      try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Ny bank skapad i molnet."); }catch{}
      alert("Ny bank skapad i molnet.");
    }else{
      const bankId = String(s.activeBank.bankId || window.activeCloudBankId || "").trim();
      if (!bankId){
        const newDoc = banksRef.doc();
        await newDoc.set(Object.assign({}, bankPayload, {
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }), { merge:true });
        setActiveBankMeta({ mode:"teacher", ownerUid: uid, bankId: newDoc.id, publicId:"", name: bankPayload.name });
        try{ window.activeCloudBankId = String(newDoc.id); }catch{}
        try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Ny bank skapad i molnet."); }catch{}
        alert("Ny bank skapad i molnet.");
      }else{
        await banksRef.doc(bankId).set(bankPayload, { merge:true });
        setActiveBankMeta({ mode:"teacher", ownerUid: uid, bankId, name: bankPayload.name });
        try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Bank uppdaterad i molnet."); }catch{}
        alert("Bank uppdaterad i molnet.");
      }
    }

    try{ await loadCloudBanksListV5(); }catch{}
  }catch(e){
    console.error("handleSaveToCloudV5 error:", e);
    alert("Kunde inte spara till molnet. Se konsolen.");
  }
}

async function deleteCloudBankV5(bankId){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Inte inloggad");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId||"").trim();
  if (!bid) throw new Error("Saknar bankId");

  const bankRef = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  try{
    const snap = await bankRef.get();
    const d = snap.exists ? (snap.data()||{}) : {};
    const publicId = String(d.publicId||"").trim();
    if (publicId){
      try{ await firebaseDbInstance.collection(PUBLIC_BANKS_COLLECTION).doc(publicId).delete(); }
      catch(e){ console.warn("Kunde inte ta bort public-banken (ok att ignorera):", e); }
    }
  }catch{}

  await bankRef.delete();

  try{
    const s = loadState();
    if (String(s.activeBank.bankId||"") === bid){
      setActiveBankMeta({ mode:"", ownerUid:"", bankId:"", publicId:"", name:"" });
      try{ window.activeCloudBankId = ""; }catch{}
    }
  }catch{}
}

async function loadCloudBanksListV5(){
  _fv_ensureCloudStyles();
  const host = _fv_getCloudListHost();
  if (!host) return;

  const mySeq = ++_fvCloudBanksRenderSeq;
  _fvCloudBanksLatestSeq = mySeq;

  _fv_setCloudStatus("Laddar moln-banker...");

  await initFirebase();

  if (!_fv_hasDb()){
    if (_fvCloudBanksLatestSeq !== mySeq) return;
    host.innerHTML = "";
    _fv_setCloudStatus("‚ö†Ô∏è Firebase DB saknas.");
    return;
  }
  if (!_fv_hasTeacher()){
    if (_fvCloudBanksLatestSeq !== mySeq) return;
    host.innerHTML = "";
    _fv_setCloudStatus("‚òÅÔ∏è Logga in med Google f√∂r att se dina moln-banker.");
    return;
  }

  const uid = String(currentTeacherUser.uid);
  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION);

  let snap = null;
  try{ snap = await ref.orderBy("updatedAt","desc").get(); }
  catch{ snap = await ref.get(); }

  if (_fvCloudBanksLatestSeq !== mySeq) return;

  const docs = snap && snap.docs ? snap.docs : [];
  if (!docs.length){
    host.innerHTML = "";
    _fv_setCloudStatus("Inga moln-banker hittades.");
    return;
  }

  const s = loadState();
  const activeId = String(s.activeBank && s.activeBank.bankId ? s.activeBank.bankId : (window.activeCloudBankId||""));

  const frag = document.createDocumentFragment();
  const seen = new Set();

  for (let i=0;i<docs.length;i++){
    const doc = docs[i];
    const bankId = String(doc.id);
    if (seen.has(bankId)) continue;
    seen.add(bankId);

    const data = doc.data() || {};
    const name = String(data.name || data.title || data.bankName || "Moln-bank");
    const publicId = String(data.publicId || "");
    const isPublic = !!publicId.trim();

    const bankObj = _fv_pickBankObj(data);
    const nMcq = (bankObj.mcq||[]).length;
    const nImg = (bankObj.img||[]).length;
    const nDrag = (bankObj.drag||[]).length;

    const upd = _fv_fmtUpdatedAt(data.updatedAt || data.updated || data.lastUpdatedAt);
    const studentsN = _fv_getRosterTokensCount(data);

    const isActive = (activeId && activeId === bankId);

    const li = document.createElement("li");
    li.className = "question-item" + (isActive ? " cloud-bank-active" : "");
    li.setAttribute("data-bank-id", bankId);

    li.innerHTML = `
      <div class="list-main">
        <div class="q-text">
          ${_fv_escapeHtml(name)}
          ${isPublic ? ' <span class="mini">Public ‚úÖ</span>' : ""}
          <span class="mini"> ‚Ä¢ Uppd: ${_fv_escapeHtml(upd)}</span>
          ${isActive ? ' <span class="mini">‚úÖ Aktiv</span>' : ""}
        </div>
        <div class="mini">
          ID: ${_fv_escapeHtml(bankId)} ‚Ä¢ Fr√•gor: ${nMcq} MCQ, ${nImg} Bild, ${nDrag} Drag ‚Ä¢ Elever: ${studentsN}
        </div>
      </div>
      <div class="fv3-actions">
        <button class="btn fv3-btn-xs btn-primary" type="button" data-act="activate">Aktivera</button>
        <button class="btn fv3-btn-xs" type="button" data-act="update">‚úÖ Uppdatera aktiv bank</button>
        <button class="btn fv3-btn-xs" type="button" data-act="roster">Elever</button>
        <button class="btn fv3-btn-xs btn-danger" type="button" data-act="delete">Ta bort</button>
      </div>
    `;

    const btnUpdate = li.querySelector('[data-act="update"]');
    if (btnUpdate && !isActive){
      btnUpdate.setAttribute("disabled","disabled");
      btnUpdate.title = "Aktivera banken f√∂rst f√∂r att kunna uppdatera den.";
    }

    li.querySelector('[data-act="activate"]')?.addEventListener("click", async ()=>{
      try{
        await loadCloudBankToLocal(bankId);
        await loadCloudBanksListV5();
        try{ if (typeof window.tryRefreshRosterTabs === "function") await window.tryRefreshRosterTabs(true); }catch{}
        try{ if (typeof window._fvTeacherForceLiveRefresh === "function") await window._fvTeacherForceLiveRefresh(); }catch{}
        try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Bank aktiverad. Elevflikar/progression uppdateras."); }catch{}
      }catch(e){
        console.error("Kunde inte aktivera bank:", e);
        alert("Kunde inte aktivera bank. Se konsolen.");
      }
    });

    btnUpdate?.addEventListener("click", async ()=>{
      try{
        await updateActiveCloudBankFromLocalV5(bankId);
        await loadCloudBanksListV5();
        try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Aktiv bank uppdaterad i molnet."); }catch{}
        alert("‚úÖ Aktiv bank uppdaterad i molnet.");
      }catch(e){
        console.error("Kunde inte uppdatera aktiv bank:", e);
        alert("Kunde inte uppdatera aktiv bank. Se konsolen.");
      }
    });

    li.querySelector('[data-act="roster"]')?.addEventListener("click", ()=>{
      try{ if (typeof window.openRosterInline === "function") window.openRosterInline(bankId); }catch{}
    });

    li.querySelector('[data-act="delete"]')?.addEventListener("click", async ()=>{
      try{
        if (!confirm("Ta bort denna moln-bank? (Kan inte √•ngras)")) return;
        await deleteCloudBankV5(bankId);
        await loadCloudBanksListV5();
        try{ if (typeof window.fvToast === "function") window.fvToast("üóë Bank borttagen."); }catch{}
      }catch(e){
        console.error("Kunde inte ta bort bank:", e);
        alert("Kunde inte ta bort bank. Se konsolen.");
      }
    });

    frag.appendChild(li);
  }

  if (_fvCloudBanksLatestSeq !== mySeq) return;

  host.innerHTML = "";
  host.appendChild(frag);
  _fv_setCloudStatus("");
}

try{ window.loadCloudBanksListV5 = loadCloudBanksListV5; }catch{}
try{ window.handleSaveToCloudV5 = handleSaveToCloudV5; }catch{}

/* ---------- Roster helpers ---------- */

function _fv_genToken(len = 10){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  const bytes = new Uint8Array(len);
  (window.crypto || window.msCrypto).getRandomValues(bytes);
  for (let i = 0; i < len; i++) out += chars[bytes[i] % chars.length];
  return out;
}

function _fv_isEmailOk(email){
  const e = String(email||"").trim();
  if (!e) return false;
  return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(e);
}

/* Legacy modal (SEKTION 2I) */
function _fv_useLegacyRosterModal(){
  return !!(_fv_getEl("bankRosterModal") && _fv_getEl("rosterRows"));
}
function _fv_legacyOpen(){
  const m = _fv_getEl("bankRosterModal");
  if (!m) return;
  try{ m.classList.remove("hidden"); }catch{}
  try{ m.style.display = ""; }catch{}
}
function _fv_legacyClose(){
  const m = _fv_getEl("bankRosterModal");
  if (!m) return;
  try{ m.classList.add("hidden"); }catch{}
  try{ m.style.display = "none"; }catch{}
}
function _fv_legacySetStatus(msg){
  const el = _fv_getEl("rosterStatus");
  if (!el) return;
  el.textContent = String(msg||"");
}

function _fv_legacyRowTemplate(row){
  const r = row || {};
  const wrap = document.createElement("div");
  wrap.className = "roster-row";
  wrap.innerHTML = `
    <input data-fv="name" type="text" placeholder="Namn" value="${_fv_escapeHtml(String(r.name||""))}">
    <input data-fv="klass" type="text" placeholder="Klass" value="${_fv_escapeHtml(String(r.klass||""))}">
    <input data-fv="email" type="email" placeholder="E-post" value="${_fv_escapeHtml(String(r.email||""))}">
    <input data-fv="token" type="text" placeholder="Token" value="${_fv_escapeHtml(String(r.token||_fv_genToken(10)))}">
    <div class="fv3-actions" style="justify-content:flex-end">
      <button class="btn fv3-btn-xs" type="button" data-act="gen">Ny token</button>
      <button class="btn fv3-btn-xs btn-danger" type="button" data-act="del">Ta bort</button>
    </div>
  `;
  wrap.querySelector('[data-act="gen"]')?.addEventListener("click", ()=>{
    const t = wrap.querySelector('input[data-fv="token"]');
    if (t) t.value = _fv_genToken(10);
  });
  wrap.querySelector('[data-act="del"]')?.addEventListener("click", ()=>{
    wrap.remove();
    _fv_legacySetStatus("");
  });
  return wrap;
}

function _fv_legacyAddRow(prefill){
  const host = _fv_getEl("rosterRows");
  if (!host) return;
  host.appendChild(_fv_legacyRowTemplate(prefill || { token:_fv_genToken(10) }));
}

function _fv_collectRosterFromHost(host){
  const rows = [];
  if (!host) return rows;

  const els = Array.from(host.querySelectorAll(".fv-roster-row, .roster-row, [data-fv-row='roster']"));
  for (let i=0;i<els.length;i++){
    const rowEl = els[i];
    const name = String(rowEl.querySelector('input[data-fv="name"]')?.value || "").trim();
    const klass = String(rowEl.querySelector('input[data-fv="klass"]')?.value || "").trim();
    const email = String(rowEl.querySelector('input[data-fv="email"]')?.value || "").trim();
    let token = String(rowEl.querySelector('input[data-fv="token"]')?.value || "").trim();

    if (!token) {
      token = _fv_genToken(10);
      const tEl = rowEl.querySelector('input[data-fv="token"]');
      if (tEl) tEl.value = token;
    }

    if (!token && !name && !email) continue;
    rows.push({ token, name, klass, email });
  }
  return rows;
}

function _fv_bindLegacyRosterButtonsOnce(){
  const modal = _fv_getEl("bankRosterModal");
  if (!modal) return;
  if (modal.__fvBoundLegacy) return;
  modal.__fvBoundLegacy = true;

  _fv_getEl("rosterAdd")?.addEventListener("click", ()=> _fv_legacyAddRow());
  _fv_getEl("rosterSave")?.addEventListener("click", async ()=>{ await _fv_saveRosterFromUI(); });
  _fv_getEl("rosterEmail")?.addEventListener("click", ()=>{ _fv_emailRosterLinksFromUI(); });
  _fv_getEl("rosterClose")?.addEventListener("click", _fv_legacyClose);

  modal.addEventListener("click", (e)=>{ if (e.target === modal) _fv_legacyClose(); });
}

/* Fallback overlay (om legacy saknas) */
function _fv_ensureRosterStyles(){
  if (_fv_getEl("fv-roster-styles")) return;
  const st = document.createElement("style");
  st.id = "fv-roster-styles";
  st.textContent = `
    .fv-roster-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .fv-roster-modal{ width:min(980px, 96vw); max-height:85vh; overflow:auto; }
    .fv-roster-head{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .fv-roster-grid{
      display:grid;
      grid-template-columns: 1.4fr 1fr 1.6fr 1fr auto;
      gap:6px; align-items:center; margin-top:8px;
    }
    .fv-roster-input{
      width:100%;
      border:1px solid rgba(75,85,99,.9);
      border-radius:10px;
      background:#0b1220;
      color:var(--text);
      padding:6px 8px;
      font-size:.82rem;
    }
    .fv-roster-input.fv-email-ok{ border-color: rgba(34,197,94,.9) !important; }
    .fv-roster-input.fv-email-bad{ border-color: rgba(239,68,68,.95) !important; }
    .fv-roster-row{
      display:grid;
      grid-template-columns: 1.4fr 1fr 1.6fr 1fr auto;
      gap:6px; align-items:center;
      padding:6px 0;
      border-top:1px solid rgba(31,41,55,.8);
    }
    .fv-roster-actions{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:flex-end; margin-top:10px; }
    .fv-roster-status{ margin-top:8px; }
    @media (max-width: 720px){
      .fv-roster-grid, .fv-roster-row{ grid-template-columns: 1fr; }
      .fv-roster-row{ padding:10px 0; }
    }
  `;
  document.head.appendChild(st);
}

function _fv_buildRosterOverlay(){
  _fv_ensureRosterStyles();
  let ov = _fv_getEl("fvRosterOverlay");
  if (ov) return ov;

  ov = document.createElement("div");
  ov.id = "fvRosterOverlay";
  ov.className = "fv-roster-overlay hidden";
  ov.innerHTML = `
    <div class="card fv-roster-modal">
      <div class="fv-roster-head">
        <div>
          <div class="q-text" id="fvRosterTitle">Elever</div>
          <div class="mini" id="fvRosterSub">‚Äî</div>
        </div>
        <div class="fv-roster-actions">
          <button class="btn btn-sm" type="button" id="fvRosterAdd">‚ûï L√§gg till elev</button>
          <button class="btn btn-sm" type="button" id="fvRosterEmail">‚úâÔ∏è E-posta elevl√§nkar</button>
          <button class="btn btn-sm btn-primary" type="button" id="fvRosterSave">üíæ Spara elevlista</button>
          <button class="btn btn-sm btn-danger" type="button" id="fvRosterClose">‚úñ St√§ng</button>
        </div>
      </div>

      <div class="fv-roster-grid mini">
        <div>Namn</div>
        <div>Klass</div>
        <div>E-post</div>
        <div>Token</div>
        <div></div>
      </div>

      <div id="fvRosterRows"></div>

      <div class="mini fv-roster-status" id="fvRosterStatus"></div>
    </div>
  `;
  document.body.appendChild(ov);

  ov.addEventListener("click", (e)=>{ if (e.target === ov) _fv_closeRoster(); });

  _fv_getEl("fvRosterClose")?.addEventListener("click", _fv_closeRoster);
  _fv_getEl("fvRosterAdd")?.addEventListener("click", ()=>_fv_addRosterRow());
  _fv_getEl("fvRosterSave")?.addEventListener("click", async ()=>{ await _fv_saveRosterFromUI(); });
  _fv_getEl("fvRosterEmail")?.addEventListener("click", ()=>{ _fv_emailRosterLinksFromUI(); });

  return ov;
}

function _fv_setRosterStatus(msg){
  const el = _fv_getEl("fvRosterStatus");
  if (!el) return;
  el.textContent = String(msg || "");
}

function _fv_openRoster(){
  const ov = _fv_buildRosterOverlay();
  ov.classList.remove("hidden");
}

function _fv_closeRoster(){
  const ov = _fv_getEl("fvRosterOverlay");
  if (ov) ov.classList.add("hidden");
}

function _fv_rowTemplate(row){
  const r = row || {};
  const wrap = document.createElement("div");
  wrap.className = "fv-roster-row";
  wrap.innerHTML = `
    <input class="fv-roster-input" data-fv="name" type="text" placeholder="Namn" value="${_fv_escapeHtml(String(r.name||""))}">
    <input class="fv-roster-input" data-fv="klass" type="text" placeholder="Klass" value="${_fv_escapeHtml(String(r.klass||""))}">
    <input class="fv-roster-input" data-fv="email" type="email" placeholder="E-post" value="${_fv_escapeHtml(String(r.email||""))}">
    <input class="fv-roster-input" data-fv="token" type="text" placeholder="Token" value="${_fv_escapeHtml(String(r.token||""))}">
    <div class="fv3-actions" style="justify-content:flex-end">
      <button class="btn fv3-btn-xs" type="button" data-act="gen">Ny token</button>
      <button class="btn fv3-btn-xs btn-danger" type="button" data-act="del">Ta bort</button>
    </div>
  `;

  const emailEl = wrap.querySelector('input[data-fv="email"]');
  const _validateEmail = ()=>{
    if (!emailEl) return;
    const ok = _fv_isEmailOk(emailEl.value);
    emailEl.classList.toggle("fv-email-ok", ok);
    emailEl.classList.toggle("fv-email-bad", !!String(emailEl.value||"").trim() && !ok);
  };
  emailEl?.addEventListener("input", _validateEmail);
  _validateEmail();

  wrap.querySelector('[data-act="gen"]')?.addEventListener("click", ()=>{
    const t = wrap.querySelector('input[data-fv="token"]');
    if (t) t.value = _fv_genToken(10);
  });
  wrap.querySelector('[data-act="del"]')?.addEventListener("click", ()=>{
    wrap.remove();
    _fv_setRosterStatus("");
  });
  return wrap;
}

function _fv_addRosterRow(prefill){
  const host = _fv_getEl("fvRosterRows");
  if (!host) return;
  host.appendChild(_fv_rowTemplate(prefill || { token: _fv_genToken(10) }));
}

function _fv_collectRosterFromUI(){
  if (_fv_useLegacyRosterModal()){
    return _fv_collectRosterFromHost(_fv_getEl("rosterRows"));
  }
  return _fv_collectRosterFromHost(_fv_getEl("fvRosterRows"));
}

function _fv_uniqueTokensFromRows(rows){
  const out = [];
  const seen = new Set();
  for (let i=0;i<rows.length;i++){
    const t = String(rows[i].token||"").trim();
    if (!t) continue;
    if (seen.has(t)) continue;
    seen.add(t);
    out.push(t);
  }
  return out;
}

function _fv_buildStudentLink(publicId, token){
  const pid = String(publicId||"").trim();
  const t = String(token||"").trim();
  if (!pid || !t) return "";
  const base = String(window.location.origin || "") + String(window.location.pathname || "");
  const qs = new URLSearchParams();
  qs.set("public", pid);
  qs.set("token", t);
  return base + "?" + qs.toString();
}

function _fv_emailRosterLinksFromUI(){
  const modal = _fv_useLegacyRosterModal() ? _fv_getEl("bankRosterModal") : _fv_getEl("fvRosterOverlay");
  if (!modal){
    alert("Ingen elevlista √∂ppen.");
    return;
  }

  const publicId = String(modal.getAttribute("data-public-id")||"").trim();
  if (!publicId){
    const msg = "‚ö†Ô∏è Public-id saknas f√∂r banken. Skapa/aktivera en public-l√§nk f√∂rst.";
    if (_fv_useLegacyRosterModal()) _fv_legacySetStatus(msg);
    else _fv_setRosterStatus(msg);
    alert("Public-id saknas f√∂r banken. Skapa/aktivera en public-l√§nk f√∂rst.");
    return;
  }

  const rows = _fv_collectRosterFromUI();
  const usable = rows
    .map(r=>({
      token: String(r.token||"").trim(),
      name: String(r.name||"").trim(),
      klass: String(r.klass||"").trim(),
      email: String(r.email||"").trim()
    }))
    .filter(r=>_fv_isEmailOk(r.email) && r.token);

  if (!usable.length){
    const msg = "‚ö†Ô∏è Inga rader med giltig e-post + token.";
    if (_fv_useLegacyRosterModal()) _fv_legacySetStatus(msg);
    else _fv_setRosterStatus(msg);
    alert("Inga rader med giltig e-post + token.");
    return;
  }

  const bcc = usable.map(r=>r.email).join(",");
  const title = String((_fv_getEl("fvRosterTitle") || _fv_getEl("rosterTitle"))?.textContent || "Elever").trim();
  const subject = `F√•ngvaktaren ‚Äì elevl√§nkar (${title})`;

  const lines = [];
  lines.push("Hej!");
  lines.push("");
  lines.push("H√§r √§r elevl√§nkarna till F√•ngvaktaren:");
  lines.push("");

  for (let i=0;i<usable.length;i++){
    const r = usable[i];
    const link = _fv_buildStudentLink(publicId, r.token);
    const label = (r.name ? r.name : ("Token " + r.token)) + (r.klass ? ` (${r.klass})` : "");
    lines.push(`${label}: ${link}`);
  }

  lines.push("");
  lines.push("Lycka till!");

  const body = lines.join("\n");
  const mailto = `mailto:?bcc=${encodeURIComponent(bcc)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  try{
    window.location.href = mailto;
    const msg = `‚úÖ E-post redo: ${usable.length} mottagare (bcc).`;
    if (_fv_useLegacyRosterModal()) _fv_legacySetStatus(msg);
    else _fv_setRosterStatus(msg);
    try{ if (typeof window.fvToast === "function") window.fvToast(`‚úÖ E-post skapad (${usable.length} mottagare).`); }catch{}
  }catch(e){
    console.warn("Kunde inte √∂ppna e-post:", e);
    const msg = "‚ùå Kunde inte √∂ppna e-postklient.";
    if (_fv_useLegacyRosterModal()) _fv_legacySetStatus(msg);
    else _fv_setRosterStatus(msg);
    alert("Kunde inte √∂ppna e-postklient.");
  }
}

async function _fv_loadRosterForBank(bankId){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Inte inloggad / DB saknas");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId||"").trim();
  if (!bid) throw new Error("Saknar bankId");

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  const snap = await ref.get();
  if (!snap.exists) throw new Error("Bank finns inte");

  const d = snap.data() || {};
  return {
    bankId: bid,
    name: String(d.name || d.title || d.bankName || "Moln-bank"),
    publicId: String(d.publicId || ""),
    rosterRows: Array.isArray(d.rosterRows) ? d.rosterRows : [],
    rosterTokens: Array.isArray(d.rosterTokens) ? d.rosterTokens : []
  };
}

async function _fv_saveRosterToBank(bankId, rows){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) throw new Error("Inte inloggad / DB saknas");

  const uid = String(currentTeacherUser.uid);
  const bid = String(bankId||"").trim();
  if (!bid) throw new Error("Saknar bankId");

  const cleanRows = Array.isArray(rows) ? rows : [];
  const tokens = _fv_uniqueTokensFromRows(cleanRows);

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(uid)
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bid);

  await ref.set({
    rosterRows: cleanRows,
    rosterTokens: tokens,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  return { tokensCount: tokens.length };
}

async function _fv_saveRosterFromUI(){
  const modal = _fv_useLegacyRosterModal() ? _fv_getEl("bankRosterModal") : _fv_getEl("fvRosterOverlay");
  const bid = modal ? String(modal.getAttribute("data-bank-id")||"").trim() : "";
  if (!bid){
    const msg = "‚ö†Ô∏è Ingen bank vald.";
    if (_fv_useLegacyRosterModal()) _fv_legacySetStatus(msg);
    else _fv_setRosterStatus(msg);
    return;
  }

  if (_fv_useLegacyRosterModal()) _fv_legacySetStatus("Sparar...");
  else _fv_setRosterStatus("Sparar...");

  try{
    const rows = _fv_collectRosterFromUI();
    const res = await _fv_saveRosterToBank(bid, rows);
    const msg = `‚úÖ Sparat. Elever: ${res.tokensCount}`;
    if (_fv_useLegacyRosterModal()) _fv_legacySetStatus(msg);
    else _fv_setRosterStatus(msg);

    try{ if (typeof window.fvToast === "function") window.fvToast(`‚úÖ Elevlista sparad (${res.tokensCount} elever).`); }catch{}
    try{ await loadCloudBanksListV5(); }catch{}
    try{ if (typeof window.tryRefreshRosterTabs === "function") window.tryRefreshRosterTabs(true); }catch{}
  }catch(e){
    console.error("Roster save error:", e);
    const msg = "‚ùå Kunde inte spara elevlista (kontrollera inloggning/beh√∂righet).";
    if (_fv_useLegacyRosterModal()) _fv_legacySetStatus(msg);
    else _fv_setRosterStatus(msg);
    alert("Kunde inte spara elevlista. Testa logga in med Google igen.");
  }
}

async function openRosterInline(bankId){
  try{
    if (_fv_useLegacyRosterModal()){
      _fv_bindLegacyRosterButtonsOnce();
      _fv_legacyOpen();
      _fv_legacySetStatus("Laddar...");

      const info = await _fv_loadRosterForBank(bankId);

      const modal = _fv_getEl("bankRosterModal");
      modal?.setAttribute("data-bank-id", String(info.bankId));
      modal?.setAttribute("data-public-id", String(info.publicId||""));

      const titleEl = _fv_getEl("rosterTitle");
      const subEl = _fv_getEl("rosterSub");
      if (titleEl) titleEl.textContent = "Elever ‚Äì " + info.name;
      if (subEl) subEl.textContent = `Bank: ${info.bankId}${info.publicId ? " ‚Ä¢ Public: " + info.publicId : ""}`;

      const host = _fv_getEl("rosterRows");
      if (host) host.innerHTML = "";

      const rows = Array.isArray(info.rosterRows) ? info.rosterRows : [];
      if (rows.length){
        for (let i=0;i<rows.length;i++) _fv_legacyAddRow(rows[i]);
      } else {
        _fv_legacyAddRow({ token:_fv_genToken(10) });
      }

      _fv_legacySetStatus(`Redo. (${rows.length || 1} rader)`);
      return;
    }

    _fv_openRoster();
    _fv_setRosterStatus("Laddar...");

    const info = await _fv_loadRosterForBank(bankId);

    const ov = _fv_buildRosterOverlay();
    ov.setAttribute("data-bank-id", String(info.bankId));
    ov.setAttribute("data-public-id", String(info.publicId||""));

    const t = _fv_getEl("fvRosterTitle");
    const sub = _fv_getEl("fvRosterSub");
    if (t) t.textContent = "Elever ‚Äì " + info.name;
    if (sub) sub.textContent = `Bank: ${info.bankId}${info.publicId ? " ‚Ä¢ Public: " + info.publicId : ""}`;

    const host = _fv_getEl("fvRosterRows");
    if (host) host.innerHTML = "";

    const rows = Array.isArray(info.rosterRows) ? info.rosterRows : [];
    if (rows.length){
      for (let i=0;i<rows.length;i++) _fv_addRosterRow(rows[i]);
    } else {
      _fv_addRosterRow({ token: _fv_genToken(10) });
    }

    _fv_setRosterStatus(`Redo. (${rows.length || 1} rader)`);
  }catch(e){
    console.error("openRosterInline error:", e);
    if (_fv_useLegacyRosterModal()){
      _fv_legacySetStatus("‚ùå Kunde inte ladda elevlista (kontrollera inloggning/beh√∂righet).");
    }else{
      _fv_setRosterStatus("‚ùå Kunde inte ladda elevlista (kontrollera inloggning/beh√∂righet).");
    }
    alert("Kunde inte ladda elevlista. Testa logga in med Google igen.");
  }
}

try{ window.openRosterInline = openRosterInline; }catch{}

/* ---------- Progression: safe helper som beh√∂vs av finishLevel ---------- */
function getLinksForQuestion(q){
  try{
    const qq = q || {};
    const direct = Array.isArray(qq.links) ? qq.links : [];
    if (direct.length) return direct;

    const goal = String(qq.goal || "").trim();
    const parts = String(qq.parts || qq.part || "").trim();
    if (!goal || !parts) return [];

    const s = (typeof loadState === "function") ? loadState() : null;
    const gm = (s && Array.isArray(s.goalsMap)) ? s.goalsMap : [];

    let id = "";
    for (let i=0;i<gm.length;i++){
      const g = gm[i] || {};
      const gGoal = String(g.goal || "").trim();
      const gParts = String(g.parts || g.part || "").trim();
      if (gGoal === goal && gParts === parts){
        id = String(g.id || "").trim();
        break;
      }
    }
    if (!id) return [];
    return [{ id, goal, parts }];
  }catch{
    return [];
  }
}
try{ if (typeof window.getLinksForQuestion !== "function") window.getLinksForQuestion = getLinksForQuestion; }catch{}

/* ---------- Progressionsflik (rosterTabs + elevdocs + live) ---------- */

const _fvTeacherSelectedTokenKey = "fangvaktaren-teacher-selected-student-token-v17";
const _fvTeacherStudentCache = Object.create(null);
const _fvTeacherStudentCacheTtlMs = 15000;

let _fvTeacherLiveUnsub = null;
let _fvTeacherLiveToken = "";

function _fv_getSelectedToken(){
  try{ return String(localStorage.getItem(_fvTeacherSelectedTokenKey)||""); }catch{ return ""; }
}
function _fv_setSelectedToken(t){
  try{ localStorage.setItem(_fvTeacherSelectedTokenKey, String(t||"")); }catch{}
}

function _fv_getRosterTabsHost(){
  const ul = _fv_getEl("rosterTabs");
  if (ul) return ul;

  const div = _fv_getEl("playedStudentsTabs");
  if (div) return div;

  const list = _fv_getEl("playedStudentsList");
  if (list) return list;

  return null;
}

function _fv_getActiveStudentsCollectionRef(){
  if (!_fv_hasDb()) return null;
  const s = loadState();
  const a = s.activeBank || {};

  if (a.publicId && String(a.publicId).trim()){
    return firebaseDbInstance.collection(PUBLIC_BANKS_COLLECTION).doc(String(a.publicId)).collection("students");
  }
  if (a.ownerUid && a.bankId){
    return firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION).doc(String(a.ownerUid))
      .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(a.bankId))
      .collection("students");
  }
  if (_fv_hasTeacher() && String(window.activeCloudBankId||"").trim()){
    return firebaseDbInstance
      .collection(CLOUD_ROOT_COLLECTION).doc(String(currentTeacherUser.uid))
      .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(window.activeCloudBankId))
      .collection("students");
  }
  return null;
}

async function _fv_fetchRosterFromActiveBank(){
  await initFirebase();
  if (!_fv_hasDb() || !_fv_hasTeacher()) return { rows: [], tokens: [], publicId: "" };

  const s = loadState();
  const bankId = String(s.activeBank.bankId || window.activeCloudBankId || "").trim();
  if (!bankId) return { rows: [], tokens: [], publicId: "" };

  const ref = firebaseDbInstance
    .collection(CLOUD_ROOT_COLLECTION).doc(String(currentTeacherUser.uid))
    .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(bankId));

  const snap = await ref.get();
  if (!snap.exists) return { rows: [], tokens: [], publicId: "" };

  const d = snap.data() || {};
  const rows = Array.isArray(d.rosterRows) ? d.rosterRows : [];
  const tokens = Array.isArray(d.rosterTokens) ? d.rosterTokens.map(String).filter(t=>String(t||"").trim()) : [];
  const publicId = String(d.publicId || "");

  return { rows, tokens, publicId };
}

function _fv_normRosterEntry(x){
  const e = x || {};
  const token = String(e.token || e.id || e.code || e.studentToken || "").trim();
  const name = String(e.name || e.studentName || e.namn || "").trim();
  const klass = String(e.klass || e.class || e.studentClass || e.klassnamn || "").trim();
  if (!token && !name) return null;
  return { token, name, klass };
}

function _fv_buildRosterTabs(roster){
  const rows = Array.isArray(roster.rows) ? roster.rows : [];
  const tokens = Array.isArray(roster.tokens) ? roster.tokens : [];

  const byToken = Object.create(null);
  for (let i=0;i<rows.length;i++){
    const r = _fv_normRosterEntry(rows[i]);
    if (!r || !r.token) continue;
    byToken[r.token] = r;
  }

  const out = [];
  for (let i=0;i<tokens.length;i++){
    const t = String(tokens[i]||"").trim();
    if (!t) continue;
    const hit = byToken[t] || { token:t, name:"", klass:"" };
    out.push({
      token: t,
      name: hit.name || ("Token " + t),
      klass: hit.klass || ""
    });
  }

  out.sort((a,b)=> String(a.name).localeCompare(String(b.name)));
  return out;
}

function _fv_renderRosterTabs(tabs){
  const host = _fv_getRosterTabsHost();
  if (!host) return;

  host.innerHTML = "";

  if (!tabs.length){
    const el = document.createElement("li");
    el.className = "mini";
    el.textContent = "Ingen elevlista (rosterTokens) finns i denna bank √§nnu.";
    host.appendChild(el);
    return;
  }

  const sel = _fv_getSelectedToken();

  for (let i=0;i<tabs.length;i++){
    const t = tabs[i];
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "tab-btn" + (sel && sel === t.token ? " active" : "");
    btn.setAttribute("data-token", t.token);
    btn.innerHTML = `${_fv_escapeHtml(t.name)}${t.klass ? `<span class="mini"> (${_fv_escapeHtml(t.klass)})</span>` : ""}`;
    host.appendChild(btn);
  }

  if (!host.__fvBound){
    host.__fvBound = true;
    host.addEventListener("click", (ev)=>{
      const btn = ev.target && ev.target.closest ? ev.target.closest("button[data-token]") : null;
      if (!btn) return;
      const token = String(btn.getAttribute("data-token")||"");
      if (!token) return;
      (window.trySelectStudentToken || trySelectStudentToken)(token);
    });
  }
}

function _fv_safeNum(n, fallback=0){
  const x = Number(n);
  return isFinite(x) ? x : fallback;
}

function _fv_readDottedKeyNum(d, key, fallback=0){
  try{
    if (!d || typeof d !== "object") return fallback;
    if (!Object.prototype.hasOwnProperty.call(d, key)) return fallback;
    return _fv_safeNum(d[key], fallback);
  }catch{
    return fallback;
  }
}

function _fv_normalizeDottedProgressionIntoObject(d){
  try{
    if (!d || typeof d !== "object") return d;
    if (!d.progression || typeof d.progression !== "object") d.progression = {};
    const p = d.progression;

    const e = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.E", 0);
    const c = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.C", 0);
    const a = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.A", 0);

    if ((e+c+a) > 0){
      if (!p.attemptsByLevel || typeof p.attemptsByLevel !== "object") p.attemptsByLevel = { E:0, C:0, A:0 };
      p.attemptsByLevel.E = Math.max(_fv_safeNum(p.attemptsByLevel.E,0), e);
      p.attemptsByLevel.C = Math.max(_fv_safeNum(p.attemptsByLevel.C,0), c);
      p.attemptsByLevel.A = Math.max(_fv_safeNum(p.attemptsByLevel.A,0), a);
      if (typeof p.attemptsTotal !== "number") p.attemptsTotal = (p.attemptsByLevel.E + p.attemptsByLevel.C + p.attemptsByLevel.A);
    }

    const t = _fv_readDottedKeyNum(d, "progression.attemptsTotal", NaN);
    if (isFinite(t) && t >= 0) p.attemptsTotal = t;
  }catch{}
  return d;
}

async function _fv_fetchStudentDoc(token){
  const ref = _fv_getActiveStudentsCollectionRef();
  if (!ref) return null;
  const t = String(token||"").trim();
  if (!t) return null;

  try{
    const snap = await ref.doc(t).get();
    if (!snap || !snap.exists) return null;
    const d0 = snap.data() || {};
    const d = _fv_normalizeDottedProgressionIntoObject(d0) || d0;
    d._token = t;
    d._fetchedAt = Date.now();
    return d;
  }catch(e){
    console.warn("Kunde inte l√§sa elevdoc:", e);
    return { _token: t, _error: "permissions", _fetchedAt: Date.now() };
  }
}

function _fv_getProgressionFromRemote(d){
  const prog = (d && d.progression) ? d.progression : (d && d.prog) ? d.prog : {};
  return {
    totalPoints: _fv_safeNum(
      (prog.totalPoints != null) ? prog.totalPoints :
      (d && d.totalPoints != null) ? d.totalPoints :
      (d && d.points != null) ? d.points :
      0, 0
    ),
    correctByGoalId: (prog.correctByGoalId && typeof prog.correctByGoalId==="object") ? prog.correctByGoalId : (d && d.correctByGoalId) ? d.correctByGoalId : {},
    wrongByGoalId: (prog.wrongByGoalId && typeof prog.wrongByGoalId==="object") ? prog.wrongByGoalId : (d && d.wrongByGoalId) ? d.wrongByGoalId : {}
  };
}

function _fv_getAttemptsFromRemote(d){
  const prog = (d && d.progression && typeof d.progression==="object") ? d.progression : {};
  const out = { E:0, C:0, A:0, total:0, has:false };

  const dE = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.E", 0);
  const dC = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.C", 0);
  const dA = _fv_readDottedKeyNum(d, "progression.attemptsByLevel.A", 0);
  if ((dE + dC + dA) > 0){
    out.E = dE; out.C = dC; out.A = dA;
    out.total = out.E + out.C + out.A;
    out.has = (out.total > 0);
    return out;
  }
  const dT = _fv_readDottedKeyNum(d, "progression.attemptsTotal", NaN);
  if (isFinite(dT) && dT > 0){
    out.total = dT;
    out.has = true;
    return out;
  }

  const candABL =
    (prog.attemptsByLevel && typeof prog.attemptsByLevel==="object") ? prog.attemptsByLevel :
    (d && d.attemptsByLevel && typeof d.attemptsByLevel==="object") ? d.attemptsByLevel :
    (d && d.stats && d.stats.attemptsByLevel && typeof d.stats.attemptsByLevel==="object") ? d.stats.attemptsByLevel :
    null;

  if (candABL){
    out.E = _fv_safeNum(candABL.E, 0);
    out.C = _fv_safeNum(candABL.C, 0);
    out.A = _fv_safeNum(candABL.A, 0);
    out.total = out.E + out.C + out.A;
    out.has = (out.total > 0);
    return out;
  }

  const totalCand =
    (prog.attemptsTotal != null) ? prog.attemptsTotal :
    (d && d.attemptsTotal != null) ? d.attemptsTotal :
    (d && d.attempts != null) ? d.attempts :
    (d && d.playCount != null) ? d.playCount :
    (d && d.gamesPlayed != null) ? d.gamesPlayed :
    null;

  if (totalCand != null){
    out.total = _fv_safeNum(totalCand, 0);
    out.has = (out.total > 0);
    return out;
  }

  return out;
}

function _fv_renderUl(ul, items, emptyText){
  if (!ul) return;
  const arr = Array.isArray(items) ? items : [];
  ul.innerHTML = "";
  if (!arr.length){
    const li = document.createElement("li");
    li.textContent = emptyText || "Ingen data √§nnu.";
    ul.appendChild(li);
    return;
  }
  for (let i=0;i<arr.length;i++){
    const li = document.createElement("li");
    li.innerHTML = items[i];
    ul.appendChild(li);
  }
}

/* (Styrkor/svagheter) ‚Äì beh√•ller din tidigare logik via alias-map, men utan extra duplicerade blocks */
function _fv_goalIdLevelsMapFromBank(bank){
  const out = Object.create(null);
  const b = bank || {};
  const lists = [
    Array.isArray(b.mcq) ? b.mcq : [],
    Array.isArray(b.img) ? b.img : [],
    Array.isArray(b.drag) ? b.drag : []
  ];

  for (let li=0; li<lists.length; li++){
    const arr = lists[li];
    for (let i=0;i<arr.length;i++){
      const q = arr[i] || {};
      const lvl = String(q.level || q.lv || "").toUpperCase() || "E";
      const links = Array.isArray(q.links) ? q.links : [];
      for (let k=0;k<links.length;k++){
        const gid = String(links[k] && links[k].id != null ? links[k].id : "").trim();
        if (!gid) continue;
        if (!out[gid]) out[gid] = new Set();
        out[gid].add(lvl);
      }
    }
  }
  return out;
}

function _fv_pickThresholdForGoalId(goalId, levelsMap){
  try{
    const set = levelsMap && levelsMap[String(goalId)] ? levelsMap[String(goalId)] : null;
    if (!set || !set.size) return 0.50;
    if (set.has("E")) return 0.50;
    if (set.has("C")) return 0.30;
    if (set.has("A")) return 0.20;
  }catch{}
  return 0.50;
}

function _fv_buildAliasMap(goalsMap, bank){
  const gm = Array.isArray(goalsMap) ? goalsMap : [];
  const b = bank || {};
  const alias = Object.create(null);

  const keyOf = (goal, parts)=> `${String(goal||"").trim()}||${String(parts||"").trim()}`;

  const gmKeyToId = Object.create(null);
  const gmIds = new Set();
  for (let i=0;i<gm.length;i++){
    const g = gm[i] || {};
    const id = String(g.id||"").trim();
    gmIds.add(id);
    gmKeyToId[keyOf(g.goal, g.parts)] = id;
  }

  const lists = [
    Array.isArray(b.mcq) ? b.mcq : [],
    Array.isArray(b.img) ? b.img : [],
    Array.isArray(b.drag) ? b.drag : []
  ];

  for (let li=0; li<lists.length; li++){
    const arr = lists[li];
    for (let i=0;i<arr.length;i++){
      const q = arr[i] || {};
      const links = Array.isArray(q.links) ? q.links : [];
      for (let k=0;k<links.length;k++){
        const L = links[k] || {};
        const oldId = String(L.id != null ? L.id : "").trim();
        const goal = String(L.goal != null ? L.goal : (q.goal||"")).trim();
        const parts = String(L.parts != null ? L.parts : (q.parts||"")).trim();
        if (!oldId || !goal || !parts) continue;
        if (gmIds.has(oldId)) continue;
        const newId = gmKeyToId[keyOf(goal, parts)];
        if (newId) alias[oldId] = newId;
      }
    }
  }
  return alias;
}

function _fv_mergeProgByAlias(prog, aliasMap){
  const p = prog && typeof prog==="object" ? prog : {};
  const corr = (p.correctByGoalId && typeof p.correctByGoalId==="object") ? p.correctByGoalId : {};
  const wrong = (p.wrongByGoalId && typeof p.wrongByGoalId==="object") ? p.wrongByGoalId : {};

  const outC = Object.create(null);
  const outW = Object.create(null);

  const add = (dst, key, val)=>{
    const k = String(key||"").trim();
    if (!k) return;
    dst[k] = _fv_safeNum(dst[k],0) + _fv_safeNum(val,0);
  };

  Object.keys(corr).forEach(k=>{
    const nk = aliasMap && aliasMap[String(k)] ? String(aliasMap[String(k)]) : String(k);
    add(outC, nk, corr[k]);
  });
  Object.keys(wrong).forEach(k=>{
    const nk = aliasMap && aliasMap[String(k)] ? String(aliasMap[String(k)]) : String(k);
    add(outW, nk, wrong[k]);
  });

  return {
    totalPoints: _fv_safeNum(p.totalPoints, 0),
    correctByGoalId: outC,
    wrongByGoalId: outW
  };
}

function _fv_computeStrongWeak(goalsMap, prog, bank){
  const gm = Array.isArray(goalsMap) ? goalsMap : [];
  const gmIndex = Object.create(null);
  for (let i=0;i<gm.length;i++){
    const g = gm[i] || {};
    gmIndex[String(g.id)] = g;
  }

  const alias = _fv_buildAliasMap(gm, bank);
  const mergedProg = _fv_mergeProgByAlias(prog, alias);

  const corr = mergedProg.correctByGoalId || {};
  const wrong = mergedProg.wrongByGoalId || {};
  const levelsMap = _fv_goalIdLevelsMapFromBank(bank);

  const keys = new Set();
  Object.keys(corr||{}).forEach(k=>keys.add(String(k)));
  Object.keys(wrong||{}).forEach(k=>keys.add(String(k)));

  const rows = [];
  keys.forEach((k)=>{
    const c = _fv_safeNum(corr[k],0);
    const w = _fv_safeNum(wrong[k],0);
    const a = c+w;
    if (a<=0) return;

    const g = gmIndex[k] || null;
    const goal = g ? String(g.goal||"").trim() : "";
    const part = g ? String(g.parts||g.part||"").trim() : "";

    let label = "";
    if (g && (goal || part)){
      if (goal && part) label = `Delbit ${_fv_escapeHtml(k)}: ${_fv_escapeHtml(goal)} ‚Äî ${_fv_escapeHtml(part)}`;
      else label = `Delbit ${_fv_escapeHtml(k)}: ${_fv_escapeHtml(goal || part)}`;
    }else{
      label = `Ok√§nd delbit (id ${_fv_escapeHtml(k)}) <span class="mini">‚Äì kontrollera kopplingen i fr√•gebanken</span>`;
    }

    const acc = a ? (c/a) : 0;
    const th = _fv_pickThresholdForGoalId(k, levelsMap);

    rows.push({ key:k, label, c, w, a, acc, th });
  });

  const strong = rows
    .filter(r=> r.acc >= r.th)
    .sort((a,b)=> (b.acc-a.acc) || (b.a-a.a))
    .slice(0,10)
    .map(r=>`${r.label} <span class="mini">(${r.c}/${r.a} r√§tt, ${Math.round(r.acc*100)}%)</span>`);

  const weak = rows
    .filter(r=> r.acc < r.th)
    .sort((a,b)=> (a.acc-b.acc) || (b.a-a.a))
    .slice(0,10)
    .map(r=>`${r.label} <span class="mini">(${r.c}/${r.a} r√§tt, ${Math.round(r.acc*100)}%)</span>`);

  return { strong, weak };
}

function tryUpdateProgressUI(){
  const pEl = _fv_getEl("progressPointsText");
  const strongUl = _fv_getEl("progressStrongList");
  const weakUl = _fv_getEl("progressWeakList");

  const token = _fv_getSelectedToken();
  const remote = token ? (_fvTeacherStudentCache[token] || null) : null;

  if (!token){
    if (pEl) pEl.innerHTML = "V√§lj en elevflik.";
    _fv_renderUl(strongUl, [], "‚Äî");
    _fv_renderUl(weakUl, [], "‚Äî");
    return;
  }

  if (!remote){
    if (pEl) pEl.innerHTML = "Ingen inl√§mning √§nnu f√∂r vald elev.";
    _fv_renderUl(strongUl, [], "Ingen data √§nnu.");
    _fv_renderUl(weakUl, [], "Ingen data √§nnu.");
    return;
  }

  if (remote && remote._error === "permissions"){
    if (pEl) pEl.innerHTML = "‚ö†Ô∏è Beh√∂righet saknas f√∂r att l√§sa elevdata (kontrollera Firestore rules).";
    _fv_renderUl(strongUl, [], "‚Äî");
    _fv_renderUl(weakUl, [], "‚Äî");
    return;
  }

  const sTeacher = loadState();
  const prog = _fv_getProgressionFromRemote(remote);
  const total = _fv_safeNum(prog.totalPoints, 0);

  const attempts = _fv_getAttemptsFromRemote(remote);
  const attemptsHtml = attempts.has
    ? ` <span class="mini">(F√∂rs√∂k: E ${_fv_escapeHtml(attempts.E)} ‚Ä¢ C ${_fv_escapeHtml(attempts.C)} ‚Ä¢ A ${_fv_escapeHtml(attempts.A)} ‚Ä¢ Totalt ${_fv_escapeHtml(attempts.total)})</span>`
    : ` <span class="mini">(F√∂rs√∂k: saknas i elevdata)</span>`;

  if (pEl) pEl.innerHTML = `Totalt: <strong>${_fv_escapeHtml(total)} p</strong>.${attemptsHtml}`;

  const gm = Array.isArray(sTeacher.goalsMap) ? sTeacher.goalsMap : [];
  const bank = sTeacher.bank || {};
  const { strong, weak } = _fv_computeStrongWeak(gm, prog, bank);

  _fv_renderUl(strongUl, strong, "F√∂r lite data f√∂r tydliga styrkor √§nnu ‚Äì l√•t eleven spela mer p√• niv√•n.");
  _fv_renderUl(weakUl, weak, "Inga delbitar att √∂va p√• √§nnu.");
}
try{ window.tryUpdateProgressUI = tryUpdateProgressUI; }catch{}

function _fv_stopLiveStudent(){
  try{ if (_fvTeacherLiveUnsub) _fvTeacherLiveUnsub(); }catch{}
  _fvTeacherLiveUnsub = null;
  _fvTeacherLiveToken = "";
}

function _fv_startLiveStudent(token){
  try{
    const t = String(token||"").trim();
    if (!t) return;
    if (!_fv_hasDb()) return;

    const ref = _fv_getActiveStudentsCollectionRef();
    if (!ref) return;

    if (_fvTeacherLiveToken === t && _fvTeacherLiveUnsub) return;

    _fv_stopLiveStudent();
    _fvTeacherLiveToken = t;

    _fvTeacherLiveUnsub = ref.doc(t).onSnapshot((snap)=>{
      try{
        if (!snap || !snap.exists) return;
        const d0 = snap.data() || {};
        const d = _fv_normalizeDottedProgressionIntoObject(d0) || d0;
        d._token = t;
        d._fetchedAt = Date.now();
        _fvTeacherStudentCache[t] = d;
        (window.tryUpdateProgressUI || tryUpdateProgressUI)();
      }catch{}
    }, (err)=>{
      console.warn("Live-lyssnare fel (ok att ignorera):", err);
      _fv_stopLiveStudent();
    });
  }catch{}
}

async function trySelectStudentToken(token){
  const t = String(token||"").trim();
  if (!t) return;

  _fv_setSelectedToken(t);

  try{
    const host = _fv_getRosterTabsHost();
    if (host){
      Array.from(host.querySelectorAll("button[data-token]")).forEach(b=>{
        b.classList.toggle("active", String(b.getAttribute("data-token")||"") === t);
      });
    }
  }catch{}

  const cached = _fvTeacherStudentCache[t] || null;
  const now = Date.now();
  const isFresh = !!(cached && cached._fetchedAt && (now - Number(cached._fetchedAt) <= _fvTeacherStudentCacheTtlMs));

  if (!isFresh){
    try{
      const data = await _fv_fetchStudentDoc(t);
      if (data) _fvTeacherStudentCache[t] = data;
      else delete _fvTeacherStudentCache[t];
    }catch(e){
      console.warn("Kunde inte l√§sa elevdoc:", e);
    }
  }

  _fv_startLiveStudent(t);
  (window.tryUpdateProgressUI || tryUpdateProgressUI)();
}
try{ window.trySelectStudentToken = trySelectStudentToken; }catch{}

async function tryRefreshRosterTabs(force){
  try{
    const roster = await _fv_fetchRosterFromActiveBank();

    if (roster && roster.publicId){
      const s = loadState();
      if (String(s.activeBank.bankId||"").trim()){
        setActiveBankMeta(Object.assign({}, s.activeBank, { publicId: String(roster.publicId||"") }));
      }
    }

    const tabs = _fv_buildRosterTabs(roster);
    _fv_renderRosterTabs(tabs);

    const sel = _fv_getSelectedToken();
    if (!sel && tabs.length) await (window.trySelectStudentToken || trySelectStudentToken)(tabs[0].token);
    if (sel && tabs.length && !tabs.find(x=>x.token===sel)) await (window.trySelectStudentToken || trySelectStudentToken)(tabs[0].token);
    if (sel && tabs.length) (window.tryUpdateProgressUI || tryUpdateProgressUI)();
  }catch(e){
    console.warn("Kunde inte l√§sa roster f√∂r flikar:", e);
  }
}
try{ window.tryRefreshRosterTabs = tryRefreshRosterTabs; }catch{}

/* ---------- Toast (beh√∂vs av flera delar) ---------- */
(function FV_Toasts(){
  if (_fv_getEl("fvToast")) return;
  const st = document.createElement("style");
  st.id = "fvToastStyles";
  st.textContent = `
    #fvToast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      z-index:99999;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(75,85,99,.75);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: 0 12px 28px rgba(0,0,0,.45);
      font-size:.9rem;
      max-width:min(720px, 92vw);
      display:none;
    }
  `;
  document.head.appendChild(st);

  const div = document.createElement("div");
  div.id = "fvToast";
  document.body.appendChild(div);

  let tmr = null;
  window.fvToast = (msg)=>{
    const el = _fv_getEl("fvToast");
    if (!el) return;
    el.textContent = String(msg||"");
    el.style.display = "block";
    try{ if (tmr) clearTimeout(tmr); }catch{}
    tmr = setTimeout(()=>{ try{ el.style.display="none"; }catch{} }, 2400);
  };
})();

/* ---------- Goal-select refresh + teacher bank UI hook ---------- */
function _fv_refreshGoalSelects(){
  if (typeof window.loadState !== "function") return;
  const ids = ["mcqGoalPart","mcqJsonGoalPart","imgGoalPart","dragGoalPart"];
  const s = loadState();
  const gm = Array.isArray(s.goalsMap) ? s.goalsMap : [];

  for (let k=0;k<ids.length;k++){
    const sel = _fv_getEl(ids[k]);
    if (!sel || sel.tagName.toLowerCase() !== "select") continue;

    const prev = String(sel.value || "");
    sel.innerHTML = "";

    const def = document.createElement("option");
    def.value = "";
    def.textContent = "Ingen koppling";
    sel.appendChild(def);

    for (let i=0;i<gm.length;i++){
      const g = gm[i] || {};
      const opt = document.createElement("option");
      opt.value = String(g.id||"");
      const goal = String(g.goal||"").trim();
      const parts = String(g.parts||g.part||"").trim();
      opt.textContent = (goal ? goal : "Delm√•l") + (parts ? ` (${parts})` : "");
      sel.appendChild(opt);
    }

    try{ sel.value = prev; }catch{}
  }
}

/* (Din goals-manager UI ligger i annan sektion i din fil; h√§r k√∂r vi endast refresh-hook) */
function fvRefreshTeacherBankUI(){
  if (typeof window.loadState !== "function") return;
  try{ _fv_refreshGoalSelects(); }catch{}
  try{ if (typeof window._fv3h_renderAllQuestionLists==="function") window._fv3h_renderAllQuestionLists(); }catch{}
  try{ if (typeof window.updateBankStatusUI === "function") window.updateBankStatusUI(); }catch{}
}
try{ window.fvRefreshTeacherBankUI = fvRefreshTeacherBankUI; }catch{}

/* ---------- Save-lock + knappbind ---------- */
function _fv_bindOnce(el, key){
  try{
    if (!el) return false;
    const k = "__fvBound_" + String(key||"");
    if (el[k]) return false;
    el[k] = true;
    return true;
  }catch{ return false; }
}

function _fv_getBtnByIds(ids){
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el) return el;
  }
  return null;
}

const _fvSaveLock = { inFlight:false };

async function _fv_runSaveToCloudLocked(){
  if (_fvSaveLock.inFlight){
    console.log("‚è≥ Save blocked (already in flight)");
    try{ if (typeof window.fvToast==="function") window.fvToast("‚è≥ Sparar redan‚Ä¶"); }catch{}
    return;
  }
  _fvSaveLock.inFlight = true;
  try{
    if (typeof window.handleSaveToCloudV5 === "function"){
      return await window.handleSaveToCloudV5.apply(this, arguments);
    }
    if (typeof window.handleSaveToCloud === "function"){
      return await window.handleSaveToCloud.apply(this, arguments);
    }
    throw new Error("Saknar save-funktion (handleSaveToCloudV5/handleSaveToCloud).");
  } finally {
    setTimeout(()=>{ _fvSaveLock.inFlight = false; }, 900);
  }
}

function _fv_bindCloudButtonsV5(){
  const btnLoad = _fv_getBtnByIds(["btnLoadCloudBanks","btnLoadCloudBanksV4","btnLoadCloudBanksV5"]);
  if (btnLoad && _fv_bindOnce(btnLoad, "loadCloudBanks")){
    btnLoad.addEventListener("click", async ()=>{
      try{
        await loadCloudBanksListV5();
        try{ if (typeof window.fvToast==="function") window.fvToast("‚òÅÔ∏è Moln-bankar laddade."); }catch{}
      }catch(e){
        console.error("loadCloudBanksListV5 error:", e);
        alert("Kunde inte ladda moln-bankar. Se konsolen.");
      }
    });
  }

  const btnSave = _fv_getBtnByIds(["btnSaveToCloud","btnSaveCloudBank","btnCloudSave","btnSaveToCloudV5"]);
  if (btnSave && _fv_bindOnce(btnSave, "saveToCloudCapture")){
    btnSave.addEventListener("click", async (ev)=>{
      try{
        try{ ev.preventDefault(); }catch{}
        try{ ev.stopImmediatePropagation(); }catch{}
        try{ ev.stopPropagation(); }catch{}
        await _fv_runSaveToCloudLocked();
      }catch(e){
        console.error("Save-to-cloud error:", e);
        alert("Kunde inte spara till molnet. Se konsolen.");
      }
    }, true);
  }
}

/* ---------- BOOT (s√§ker init utan dubbla 3I/3L) ---------- */

async function _fv_bootTeacherUI(){
  try{ await initFirebase(); }catch{}
  try{ _fv_bindCloudButtonsV5(); }catch{}
  try{ fvRefreshTeacherBankUI(); }catch{}
  try{ await loadCloudBanksListV5(); }catch{}
  try{ await tryRefreshRosterTabs(true); }catch{}
  try{
    const sel = _fv_getSelectedToken();
    if (sel) _fv_startLiveStudent(sel);
  }catch{}
  tryUpdateProgressUI();
}
try{ window._fv_bootTeacherUI = _fv_bootTeacherUI; }catch{}

/* Boot guard */
(function FV_BOOT_GUARD(){
  const REQUIRED_FNS = ["trySelectStudentToken","tryUpdateProgressUI","tryRefreshRosterTabs"];
  function _fv_allRequiredFnsExist(){
    for (let i=0; i<REQUIRED_FNS.length; i++){
      const n = REQUIRED_FNS[i];
      if (typeof window[n] !== "function") return false;
    }
    return true;
  }
  function _fv_waitForRequiredFns(timeoutMs = 2000, pollMs = 25){
    const start = Date.now();
    return new Promise((resolve)=>{
      const tick = ()=>{
        if (_fv_allRequiredFnsExist()) return resolve(true);
        if ((Date.now() - start) >= timeoutMs) return resolve(false);
        setTimeout(tick, pollMs);
      };
      tick();
    });
  }
  async function _fv_safeBootTeacherUI(trigger){
    try{
      if (window.__fv_teacher_boot_done) return;
      if (typeof window._fv_bootTeacherUI !== "function") return;

      const ok = await _fv_waitForRequiredFns(2000, 25);
      if (!ok){
        console.warn("[FV] Boot-guard: Required functions not ready in time:", REQUIRED_FNS);
        return;
      }

      await window._fv_bootTeacherUI();
      window.__fv_teacher_boot_done = true;
      console.log("[FV] Boot-guard: teacher boot OK (" + String(trigger||"auto") + ")");
    }catch(e){
      console.warn("[FV] Boot-guard: teacher boot failed (will allow manual run):", e);
    }
  }

  if (!window.__fv_boot_guard_bound){
    window.__fv_boot_guard_bound = true;
    setTimeout(()=>{ _fv_safeBootTeacherUI("auto@0ms"); }, 0);
    setTimeout(()=>{ _fv_safeBootTeacherUI("auto@250ms"); }, 250);
    window.addEventListener("focus", ()=>{ _fv_safeBootTeacherUI("focus"); }, true);
  }
})();

/* =========================================================
   Sektion 3L: L√ÑRARINST√ÑLLNINGAR (BEH√ÖLL) ‚Äì ENDA VERSIONEN
   ========================================================= */

function _fv_findTeacherSettingsHost(){
  const ids = [
    "teacherSettings",
    "teacherSettingsCard",
    "teacherPanel",
    "teacherTab",
    "teacherTabContent",
    "tab-teacher",
    "teacher-mode",
    "teacherView"
  ];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el) return el;
  }
  const cand = document.querySelector('[data-tab="teacher"]') || document.querySelector('[id*="teacher"][class*="card"]');
  return cand || null;
}

function _fv_getTeacherEmailInput(){
  const ids = ["teacherEmail","inputTeacherEmail","txtTeacherEmail","emailTeacher","teacherMail"];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el && (el.tagName||"").toLowerCase()==="input") return el;
  }
  const host = _fv_findTeacherSettingsHost();
  const cand = host ? host.querySelector('input[type="email"]') : document.querySelector('input[type="email"]');
  return cand || null;
}

function _fv_ensureTeacherStatusLine(){
  const host = _fv_findTeacherSettingsHost() || document.body;
  let el = _fv_getEl("fvTeacherSettingsStatus");
  if (el) return el;

  el = document.createElement("div");
  el.id = "fvTeacherSettingsStatus";
  el.className = "mini";
  el.style.marginTop = "8px";
  el.style.opacity = ".92";
  el.textContent = "";

  const anchors = [
    _fv_getEl("btnSaveTeacherSettings"),
    _fv_getEl("btnTeacherSave"),
    _fv_getEl("btnSaveSettings"),
    _fv_getEl("btnSaveToCloud"),
    _fv_getEl("btnLoadCloudBanks")
  ].filter(Boolean);

  if (anchors[0] && anchors[0].parentElement){
    anchors[0].parentElement.appendChild(el);
  }else{
    host.appendChild(el);
  }

  return el;
}

function _fv_teacherToast(msg){
  const el = _fv_ensureTeacherStatusLine();
  if (!el) return;
  el.textContent = String(msg || "");
  try{
    el.style.color = "var(--text)";
    clearTimeout(el.__fvT);
    el.__fvT = setTimeout(()=>{ try{ el.textContent = ""; }catch{} }, 2500);
  }catch{}
}

function _fv_ensureTeacherActiveSettingsBox(){
  const host = _fv_findTeacherSettingsHost() || document.body;
  let el = _fv_getEl("fvTeacherActiveSettingsBox");
  if (el) return el;

  el = document.createElement("div");
  el.id = "fvTeacherActiveSettingsBox";
  el.className = "mini";
  el.style.marginTop = "8px";
  el.style.opacity = ".92";
  el.style.lineHeight = "1.35";

  const emailInp = _fv_getTeacherEmailInput();
  if (emailInp && emailInp.parentElement){
    emailInp.parentElement.appendChild(el);
  }else{
    host.appendChild(el);
  }
  return el;
}

function _fv_getSavedTeacherEmail(){
  try{
    const s = loadState();
    return String((s && s.teacherEmail) ? s.teacherEmail : "").trim();
  }catch{
    return "";
  }
}

function _fv_getSavedThresholds(){
  try{
    const s = loadState();
    const th = (s && s.thres && typeof s.thres==="object") ? s.thres : null;
    const out = { E:70, C:70, A:70 };
    if (th){
      if (isFinite(Number(th.E))) out.E = Number(th.E);
      if (isFinite(Number(th.C))) out.C = Number(th.C);
      if (isFinite(Number(th.A))) out.A = Number(th.A);
    }
    return out;
  }catch{
    return { E:70, C:70, A:70 };
  }
}

function _fv_renderTeacherActiveSettings(){
  const box = _fv_ensureTeacherActiveSettingsBox();
  if (!box) return;

  const mail = _fv_getSavedTeacherEmail();
  const th = _fv_getSavedThresholds();

  const mailHtml = mail ? `<strong>Aktiv e-post:</strong> ${_fv_escapeHtml(mail)}` : `<strong>Aktiv e-post:</strong> <span class="mini">inte angiven</span>`;
  const thHtml = `<strong>Sparade gr√§nser:</strong> E ${_fv_escapeHtml(th.E)}% ‚Ä¢ C ${_fv_escapeHtml(th.C)}% ‚Ä¢ A ${_fv_escapeHtml(th.A)}%`;

  box.innerHTML = `${mailHtml}<br>${thHtml}`;
}

function _fv_bindTeacherEmailConfirm(){
  const inp = _fv_getTeacherEmailInput();
  if (!inp || inp.__fvBoundEmailConfirm) return;
  inp.__fvBoundEmailConfirm = true;

  try{
    const saved = _fv_getSavedTeacherEmail();
    if (saved && !String(inp.value||"").trim()) inp.value = saved;
  }catch{}

  const saveEmail = ()=>{
    const s = loadState();
    const v = String(inp.value||"").trim();
    s.teacherEmail = v;
    saveState(s);
    _fv_renderTeacherActiveSettings();
    if (v) _fv_teacherToast(`‚úÖ E-post sparad: ${v}`);
    else _fv_teacherToast("‚úÖ E-post rensad.");
  };

  inp.addEventListener("change", saveEmail);
  inp.addEventListener("blur", saveEmail);
}

function _fv_findThresholdInput(level){
  const L = String(level||"").toUpperCase();
  const ids = [
    `thres${L}`, `threshold${L}`, `inputThres${L}`, `inputThreshold${L}`,
    `${L}Threshold`, `${L}Thres`, `percent${L}`, `pct${L}`
  ];
  for (let i=0;i<ids.length;i++){
    const el = _fv_getEl(ids[i]);
    if (el && (el.tagName||"").toLowerCase()==="input") return el;
  }
  return null;
}

function _fv_prefillThresholdInputs(){
  const th = _fv_getSavedThresholds();
  const setIfEmpty = (L, val)=>{
    const el = _fv_findThresholdInput(L);
    if (!el) return;
    if (!String(el.value||"").trim()) el.value = String(val);
  };
  setIfEmpty("E", th.E);
  setIfEmpty("C", th.C);
  setIfEmpty("A", th.A);
}

function _fv_bindThresholdConfirm(){
  const bindOne = (L)=>{
    const el = _fv_findThresholdInput(L);
    if (!el || el.__fvBoundThres) return;
    el.__fvBoundThres = true;

    const save = ()=>{
      const raw = String(el.value||"").trim();
      const n = Number(raw);
      if (!isFinite(n)) { _fv_teacherToast(`‚ö†Ô∏è Ogiltigt v√§rde f√∂r niv√• ${L}.`); return; }

      const s = loadState();
      s.thres = s.thres && typeof s.thres==="object" ? s.thres : { E:70, C:70, A:70 };
      s.thres[L] = n;
      saveState(s);
      _fv_renderTeacherActiveSettings();
      _fv_teacherToast(`‚úÖ Niv√• ${L} sparad: ${n}%`);
    };

    el.addEventListener("change", save);
    el.addEventListener("blur", save);
  };

  bindOne("E"); bindOne("C"); bindOne("A");
}

(function FV3L_InitTeacherSettings(){
  try{ _fv_bindTeacherEmailConfirm(); }catch{}
  try{ _fv_prefillThresholdInputs(); }catch{}
  try{ _fv_bindThresholdConfirm(); }catch{}
  try{ _fv_renderTeacherActiveSettings(); }catch{}

  try{
    if (!window.__fvTeacherSettingsHooks){
      window.__fvTeacherSettingsHooks = true;
      window.addEventListener("fv-bank-changed", ()=>{
        try{ _fv_bindTeacherEmailConfirm(); }catch{}
        try{ _fv_prefillThresholdInputs(); }catch{}
        try{ _fv_bindThresholdConfirm(); }catch{}
        try{ _fv_renderTeacherActiveSettings(); }catch{}
      });
    }
  }catch{}
})();

/* ---------- (APL) placeholders: funktioner som UI kan kalla ---------- */
async function fvAplCheckinSubmit(payload){
  await initFirebase();
  if (!_fv_hasDb()) throw new Error("DB saknas");
  const p = payload && typeof payload==="object" ? payload : {};
  const now = Date.now();

  const doc = Object.assign({
    createdAtMs: now,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    version: "apl-v1"
  }, p);

  const ref = firebaseDbInstance.collection(APL_CHECKIN_COLLECTION).doc();
  await ref.set(doc, { merge:true });
  return { ok:true, id: ref.id };
}
try{ window.fvAplCheckinSubmit = fvAplCheckinSubmit; }catch{}

</script>
<!-- slut SEKTION 3: SCRIPT & LOGIK F√ÖNGVAKTAREN (bas, firebase, banker, roster, progression, editor-refresh) -->




<!-- start SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->
<script>
"use strict";

/* start Sektion 4A: Globala spelvariabler */
// √Ñndrat: Exponerar fvResetSession() (och fvIsPlaying) som nollst√§ller spelets riktiga sessionvariabler s√• Avbryt/Back kan reseta korrekt. (Omskrivna/nya rader: 22)
let currentLevel = null;
let currentQuestions = [];
let currentAnswers = [];
let lastSubmission = null;

function fvResetSession(opts){
  try{
    const o = (opts && typeof opts === "object") ? opts : {};
    currentLevel = null;
    currentQuestions = [];
    currentAnswers = [];
    if (o.clearLastSubmission) lastSubmission = null;
  }catch(e){}
}
try{ window.fvResetSession = fvResetSession; }catch(e){}

function fvIsPlaying(){ return !!currentLevel; }
try{ window.fvIsPlaying = fvIsPlaying; }catch(e){}
/* slut Sektion 4A: Globala spelvariabler */






/* start Sektion 4B: Fallbacks + helpers (kraschskydd) */
const _fv4_getEl = (typeof window.getEl === "function") ? window.getEl : (id) => document.getElementById(id);

const _fv4_loadState = (typeof window.loadState === "function") ? window.loadState : function(){
  try{
    const key = (typeof window.STORAGE_KEY === "string" && window.STORAGE_KEY) ? window.STORAGE_KEY : "fangvaktaren-v17";
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : {};
  }catch(e){ return {}; }
};

const _fv4_saveState = (typeof window.saveState === "function") ? window.saveState : function(s){
  try{
    const key = (typeof window.STORAGE_KEY === "string" && window.STORAGE_KEY) ? window.STORAGE_KEY : "fangvaktaren-v17";
    localStorage.setItem(key, JSON.stringify(s || {}));
  }catch(e){}
};

const _fv4_escapeHtml = (typeof window._fv_escapeHtml === "function")
  ? window._fv_escapeHtml
  : function(x){
      const s = (x == null) ? "" : String(x);
      return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    };

function _fv4_shuffle(arr){
  const a = Array.isArray(arr) ? arr.slice() : [];
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    const t = a[i]; a[i] = a[j]; a[j] = t;
  }
  return a;
}

function _fv4_ensureBankShape(bank){
  const b = (bank && typeof bank === "object") ? bank : {};
  if (!Array.isArray(b.mcq)) b.mcq = [];
  if (!Array.isArray(b.img)) b.img = [];
  if (!Array.isArray(b.drag)) b.drag = [];
  return b;
}

function _fv4_nowIso(){ return new Date().toISOString(); }

function _fv4_levelOf(q){
  const lv = String((q && (q.level || q.lv || q.niva || q.grade)) || "E").toUpperCase().trim();
  return (lv === "E" || lv === "C" || lv === "A") ? lv : "E";
}

function _fv4_typeOf(q){
  const t = String((q && (q.type || q.kind)) || "mcq").toLowerCase();
  return (t === "mcq" || t === "img" || t === "drag") ? t : "mcq";
}

function _fv4_getQuestionText(q){
  return String((q && (q.q || q.question || q.text || q.prompt || q.instruction)) || "").trim();
}

function _fv4_getImgSrc(q){
  const cand = [
    q && q.imgDataUrl, q && q.imgData, q && q.img, q && q.image, q && q.dataUrl, q && q.url, q && q.src, q && q.fileData
  ];
  for (let i=0;i<cand.length;i++){
    const s = (cand[i] == null) ? "" : String(cand[i]).trim();
    if (s && (s.startsWith("data:image/") || s.startsWith("http") || s.startsWith("blob:"))) return s;
  }
  return "";
}

function _fv4_getGoalPartIdFromQuestion(q){
  const cand = [
    q && q.goalPart, q && q.goalpart, q && q.goalPartId, q && q.goalId,
    q && q.goalPartKey, q && q.goalPartRef, q && q.goalPartValue
  ];
  for (let i=0;i<cand.length;i++){
    const v = cand[i];
    if (v == null) continue;
    const s = String(v).trim();
    if (s) return s;
  }
  return "";
}

/* =========================
   A+B: Recent + Trend (EMA)
   ========================= */
const _fv4_RECENT_N = 12;         // A: senaste N f√∂rs√∂k per delbit+niv√•
const _fv4_RECENT_MIN = 3;        // A: minst s√• m√•nga datapunkter kr√§vs f√∂r att f√• styra
const _fv4_DECAY_ALPHA = 0.85;    // B: trend-signal (EMA). H√∂gre = tr√∂gare.

function _fv4_ensureRecentAndDecayShape(prog){
  if (!prog || typeof prog !== "object") prog = {};

  if (!prog.recentByGoalLevel || typeof prog.recentByGoalLevel !== "object"){
    prog.recentByGoalLevel = { E:{}, C:{}, A:{} };
  }
  if (!prog.recentByGoalLevel.E) prog.recentByGoalLevel.E = {};
  if (!prog.recentByGoalLevel.C) prog.recentByGoalLevel.C = {};
  if (!prog.recentByGoalLevel.A) prog.recentByGoalLevel.A = {};

  if (!prog.decayByGoalLevel || typeof prog.decayByGoalLevel !== "object"){
    prog.decayByGoalLevel = { E:{}, C:{}, A:{} };
  }
  if (!prog.decayByGoalLevel.E) prog.decayByGoalLevel.E = {};
  if (!prog.decayByGoalLevel.C) prog.decayByGoalLevel.C = {};
  if (!prog.decayByGoalLevel.A) prog.decayByGoalLevel.A = {};

  if (!prog.decayCountByGoalLevel || typeof prog.decayCountByGoalLevel !== "object"){
    prog.decayCountByGoalLevel = { E:{}, C:{}, A:{} };
  }
  if (!prog.decayCountByGoalLevel.E) prog.decayCountByGoalLevel.E = {};
  if (!prog.decayCountByGoalLevel.C) prog.decayCountByGoalLevel.C = {};
  if (!prog.decayCountByGoalLevel.A) prog.decayCountByGoalLevel.A = {};

  return prog;
}

function _fv4_pushRecent(prog, lvl, goalId, isCorrect, N){
  const L = String(lvl||"E").toUpperCase();
  const key = String(goalId||"").trim();
  if (!key) return;

  _fv4_ensureRecentAndDecayShape(prog);

  const bucket = prog.recentByGoalLevel[L] || (prog.recentByGoalLevel[L] = {});
  let arr = bucket[key];
  if (!Array.isArray(arr)) arr = bucket[key] = [];

  arr.push(isCorrect ? 1 : 0);

  const maxN = (typeof N === "number" && isFinite(N) && N > 0) ? Math.floor(N) : _fv4_RECENT_N;
  while (arr.length > maxN) arr.shift();
}

function _fv4_updateDecay(prog, lvl, goalId, isCorrect){
  const L = String(lvl||"E").toUpperCase();
  const key = String(goalId||"").trim();
  if (!key) return;

  _fv4_ensureRecentAndDecayShape(prog);

  const bucket = prog.decayByGoalLevel[L] || (prog.decayByGoalLevel[L] = {});
  const cntBucket = prog.decayCountByGoalLevel[L] || (prog.decayCountByGoalLevel[L] = {});

  const prev = (typeof bucket[key] === "number" && isFinite(bucket[key])) ? bucket[key] : null;
  const x = isCorrect ? 1 : 0;
  const next = (prev == null) ? x : (prev * _fv4_DECAY_ALPHA + x * (1 - _fv4_DECAY_ALPHA));

  bucket[key] = next;
  cntBucket[key] = (typeof cntBucket[key] === "number" && isFinite(cntBucket[key])) ? (cntBucket[key] + 1) : 1;
}

function _fv4_getRecentStats(prog, lvl, goalId){
  const L = String(lvl||"E").toUpperCase();
  const key = String(goalId||"").trim();
  if (!key) return { n:0, correct:0, acc:0 };

  prog = _fv4_ensureRecentAndDecayShape(prog);

  const bucket = prog.recentByGoalLevel[L] || {};
  const arr = Array.isArray(bucket[key]) ? bucket[key] : [];
  let c = 0;
  for (let i=0;i<arr.length;i++) c += (Number(arr[i]) === 1 ? 1 : 0);
  const n = arr.length;
  const acc = n ? (c / n) : 0;
  return { n, correct:c, acc };
}

function _fv4_getDecaySignal(prog, lvl, goalId){
  const L = String(lvl||"E").toUpperCase();
  const key = String(goalId||"").trim();
  if (!key) return { ema:null, n:0 };

  prog = _fv4_ensureRecentAndDecayShape(prog);

  const bucket = prog.decayByGoalLevel[L] || {};
  const cntBucket = prog.decayCountByGoalLevel[L] || {};
  const ema = (typeof bucket[key] === "number" && isFinite(bucket[key])) ? bucket[key] : null;
  const n = (typeof cntBucket[key] === "number" && isFinite(cntBucket[key])) ? cntBucket[key] : 0;
  return { ema, n };
}

function _fv4_ensureProgressionShape(s){
  if (!s || typeof s !== "object") s = {};
  if (!s.progression || typeof s.progression !== "object") s.progression = {};
  const p = s.progression;

  if (typeof p.totalPoints !== "number") p.totalPoints = 0;
  if (!p.lastResult || typeof p.lastResult !== "object") p.lastResult = null;

  if (!p.wrongByGoalId || typeof p.wrongByGoalId !== "object") p.wrongByGoalId = {};
  if (!p.correctByGoalId || typeof p.correctByGoalId !== "object") p.correctByGoalId = {};

  // C: per niv√• totals (E/C/A)
  if (!p.wrongByGoalLevel || typeof p.wrongByGoalLevel !== "object") p.wrongByGoalLevel = { E:{}, C:{}, A:{} };
  if (!p.correctByGoalLevel || typeof p.correctByGoalLevel !== "object") p.correctByGoalLevel = { E:{}, C:{}, A:{} };
  if (!p.wrongByGoalLevel.E) p.wrongByGoalLevel.E = {};
  if (!p.wrongByGoalLevel.C) p.wrongByGoalLevel.C = {};
  if (!p.wrongByGoalLevel.A) p.wrongByGoalLevel.A = {};
  if (!p.correctByGoalLevel.E) p.correctByGoalLevel.E = {};
  if (!p.correctByGoalLevel.C) p.correctByGoalLevel.C = {};
  if (!p.correctByGoalLevel.A) p.correctByGoalLevel.A = {};

  // A+B: recent + trend-signal
  _fv4_ensureRecentAndDecayShape(p);

  return s;
}

function _fv4_getThresholds(s){
  const th = (s && s.thres && typeof s.thres === "object") ? s.thres : {};
  return {
    E: (typeof th.E === "number" ? th.E : 70),
    C: (typeof th.C === "number" ? th.C : 70),
    A: (typeof th.A === "number" ? th.A : 70)
  };
}

function ensureStudentSet(){
  const s = _fv4_loadState();
  if (!s.student || typeof s.student !== "object") s.student = { name:"", klass:"" };
  if (!s.student.name || !s.student.klass){
    alert("Skriv in namn och klass och spara eleven f√∂rst.");
    return false;
  }
  return true;
}
/* slut Sektion 4B: Fallbacks + helpers (kraschskydd) */






/* start Sektion 4C: Delm√•l/delbitar (goalsMap) ‚Äì rutor + delete per delm√•l & delbit */
function normalizeGoalsMap(s){
  if (!s) return [];
  const raw =
    (Array.isArray(s.goalsMap) && s.goalsMap) ||
    (s.bank && Array.isArray(s.bank.goalsMap) && s.bank.goalsMap) ||
    (s.bank && s.bank.meta && Array.isArray(s.bank.meta.goalsMap) && s.bank.meta.goalsMap) ||
    [];

  const out = [];
  raw.forEach((g, i) => {
    if (!g) return;

    const id =
      (g.id != null ? String(g.id) : null) ||
      (g.partId != null ? String(g.partId) : null) ||
      (g.delbit != null ? String(g.delbit) : null) ||
      String(i + 1);

    const goal =
      (g.goal != null ? String(g.goal) : null) ||
      (g.goalTitle != null ? String(g.goalTitle) : null) ||
      (g.delmal != null ? String(g.delmal) : null) ||
      "";

    const part =
      (g.part != null ? String(g.part) : null) ||
      (g.partText != null ? String(g.partText) : null) ||
      (g.text != null ? String(g.text) : null) ||
      (g.delbitText != null ? String(g.delbitText) : null) ||
      "";

    out.push({ id: String(id).trim(), goal: String(goal || "").trim(), part: String(part || "").trim() });
  });
  return out;
}

function _fv4_nextGoalId(goals){
  let maxId = 0;
  for (let i=0;i<goals.length;i++){
    const n = Number(goals[i] && goals[i].id);
    if (isFinite(n) && n > maxId) maxId = n;
  }
  return String(maxId + 1);
}

function _fv4_groupGoals(goals){
  const groups = new Map(); // goalTitle -> array of entries
  for (let i=0;i<goals.length;i++){
    const g = goals[i];
    const key = (g.goal || "").trim() || "Delm√•l";
    if (!groups.has(key)) groups.set(key, []);
    groups.get(key).push(g);
  }
  return Array.from(groups.entries()).map(([goalTitle, items]) => ({ goalTitle, items }));
}

function _fv4_deleteGoalGroup(goalTitle){
  const title = String(goalTitle || "").trim();
  if (!title) return;

  const s = _fv4_loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];

  const before = normalizeGoalsMap(s);
  const keep = [];
  for (let i=0;i<before.length;i++){
    const g = before[i];
    const gt = String(g.goal || "").trim() || "Delm√•l";
    if (gt !== title) keep.push(g);
  }

  s.goalsMap = keep.map((g)=>({ id:g.id, goal:g.goal, part:g.part }));
  _fv4_saveState(s);

  renderGoalsListAndSelects();
  try{ if (typeof window.populateGoalSelect === "function"){ window.populateGoalSelect(); } }catch(e){}
  try{ if (typeof window.__fv3h_renderAllQuestionLists === "function"){ window.__fv3h_renderAllQuestionLists(); } }catch(e){}
}

function _fv4_deleteGoalItemById(id){
  const key = String(id || "").trim();
  if (!key) return;

  const s = _fv4_loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];

  const before = normalizeGoalsMap(s);
  const keep = [];
  for (let i=0;i<before.length;i++){
    const g = before[i];
    if (String(g.id) !== key) keep.push(g);
  }

  s.goalsMap = keep.map((g)=>({ id:g.id, goal:g.goal, part:g.part }));
  _fv4_saveState(s);

  renderGoalsListAndSelects();
  try{ if (typeof window.populateGoalSelect === "function"){ window.populateGoalSelect(); } }catch(e){}
  try{ if (typeof window.__fv3h_renderAllQuestionLists === "function"){ window.__fv3h_renderAllQuestionLists(); } }catch(e){}
}

function renderGoalsListAndSelects(){
  const s = _fv4_loadState();
  const goals = normalizeGoalsMap(s);

  // Lista i Inst√§llningar: delm√•l = rubrikruta, delbitar = underrutor (alla med delete)
  const listEl = _fv4_getEl("goalsList");
  if (listEl){
    listEl.innerHTML = "";

    if (!goals.length){
      const li = document.createElement("li");
      li.textContent = "Inga delm√•l/delbitar sparade √§nnu.";
      listEl.appendChild(li);
    }else{
      const grouped = _fv4_groupGoals(goals);

      grouped.forEach((grp) => {
        const li = document.createElement("li");
        li.style.listStyle = "none";
        li.style.margin = "8px 0";

        const card = document.createElement("div");
        card.style.border = "1px solid #1f2937";
        card.style.borderRadius = "12px";
        card.style.padding = "10px";
        card.style.display = "flex";
        card.style.flexDirection = "column";
        card.style.gap = "8px";

        // Rubrikrad (delm√•l) + delete
        const head = document.createElement("div");
        head.style.display = "flex";
        head.style.alignItems = "center";
        head.style.justifyContent = "space-between";
        head.style.gap = "10px";

        const title = document.createElement("div");
        title.style.fontWeight = "800";
        title.textContent = grp.goalTitle || "Delm√•l";

        const btnDelGoal = document.createElement("button");
        btnDelGoal.type = "button";
        btnDelGoal.className = "btn btn-sm";
        btnDelGoal.textContent = "Ta bort delm√•l";
        btnDelGoal.addEventListener("click", () => {
          if (!confirm(`Ta bort hela delm√•let "${grp.goalTitle}" och alla delbitar under?`)) return;
          _fv4_deleteGoalGroup(grp.goalTitle);
        });

        head.appendChild(title);
        head.appendChild(btnDelGoal);
        card.appendChild(head);

        // Delbitar: individuella rutor + delete
        const partsWrap = document.createElement("div");
        partsWrap.style.display = "flex";
        partsWrap.style.flexDirection = "column";
        partsWrap.style.gap = "6px";

        grp.items.forEach((it) => {
          const row = document.createElement("div");
          row.style.border = "1px solid #1f2937";
          row.style.borderRadius = "10px";
          row.style.padding = "8px";
          row.style.display = "flex";
          row.style.alignItems = "center";
          row.style.justifyContent = "space-between";
          row.style.gap = "10px";

          const txt = document.createElement("div");
          txt.className = "mini";
          const partTxt = it.part ? it.part : "(ingen delbit-text)";
          txt.textContent = `Delbit ${it.id}: ${partTxt}`;

          const btnDelPart = document.createElement("button");
          btnDelPart.type = "button";
          btnDelPart.className = "btn btn-sm";
          btnDelPart.textContent = "Ta bort";
          btnDelPart.addEventListener("click", () => {
            if (!confirm(`Ta bort delbit ${it.id}?`)) return;
            _fv4_deleteGoalItemById(it.id);
          });

          row.appendChild(txt);
          row.appendChild(btnDelPart);
          partsWrap.appendChild(row);
        });

        card.appendChild(partsWrap);
        li.appendChild(card);
        listEl.appendChild(li);
      });
    }
  }

  // Selects i editorerna (beh√•ll v√§rde)
  const selectIds = ["mcqGoalPart", "imgGoalPart", "dragGoalPart", "mcqJsonGoalPart"];
  selectIds.forEach((id) => {
    const sel = _fv4_getEl(id);
    if (!sel) return;

    const keepValue = sel.value || "";
    sel.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Ingen koppling";
    sel.appendChild(opt0);

    goals.forEach((g) => {
      const opt = document.createElement("option");
      opt.value = String(g.id);

      const goalTxt = (g.goal || "").trim();
      const partTxt = (g.part || "").trim();

      opt.textContent = goalTxt && partTxt
        ? `Delbit ${g.id}: ${goalTxt} ‚Äì ${partTxt}`
        : goalTxt
          ? `Delbit ${g.id}: ${goalTxt}`
          : partTxt
            ? `Delbit ${g.id}: ${partTxt}`
            : `Delbit ${g.id}`;

      sel.appendChild(opt);
    });

    if (keepValue) sel.value = keepValue;
  });
}

function handleAddGoalPart(){
  const goalIn = _fv4_getEl("inputGoalSingle");
  const partIn = _fv4_getEl("inputPartSingle");
  const status = _fv4_getEl("goalsStatus");

  const goal = (goalIn && goalIn.value) ? String(goalIn.value).trim() : "";
  const part = (partIn && partIn.value) ? String(partIn.value).trim() : "";

  if (!goal && !part){
    if (status) status.textContent = "Skriv minst delm√•l eller delbit innan du l√§gger till.";
    return;
  }

  const s = _fv4_loadState();
  if (!Array.isArray(s.goalsMap)) s.goalsMap = [];
  const current = normalizeGoalsMap(s);

  const newId = _fv4_nextGoalId(current);
  s.goalsMap.push({ id: newId, goal: goal || "", part: part || "" });
  _fv4_saveState(s);

  if (goalIn) goalIn.value = "";
  if (partIn) partIn.value = "";
  if (status) status.textContent = `Tillagd: Delbit ${newId}.`;

  renderGoalsListAndSelects();
  try{ if (typeof window.populateGoalSelect === "function"){ window.populateGoalSelect(); } }catch(e){}
  try{ if (typeof window.__fv3h_renderAllQuestionLists === "function"){ window.__fv3h_renderAllQuestionLists(); } }catch(e){}
}
/* slut Sektion 4C: Delm√•l/delbitar (goalsMap) ‚Äì rutor + delete per delm√•l & delbit */






/* start Sektion 4D: Progression ‚Äì stark/svag enligt niv√•tr√∂sklar + rubrik/underrubrik */
function updateStudentStatsUI(){
  const s = _fv4_loadState();
  const ptsEl = _fv4_getEl("studentPointsValue");
  const hsEl = _fv4_getEl("highscoreSummary");

  const totalPoints = (s.progression && typeof s.progression.totalPoints === "number") ? s.progression.totalPoints : 0;
  if (ptsEl) ptsEl.textContent = `${totalPoints} p`;

  if (hsEl){
    const hs = Array.isArray(s.highscores) ? s.highscores.slice() : [];
    if (!hs.length){
      hsEl.textContent = "Ingen highscore √§nnu.";
      return;
    }
    hs.sort((a,b)=> (b.points||0) - (a.points||0));
    const studentId = (s.student && s.student.name ? s.student.name : "Elev") + "||" + (s.student && s.student.klass ? s.student.klass : "-");
    const idx = hs.findIndex((e)=>e && e.id === studentId);
    if (idx >= 0) hsEl.textContent = `Plats ${idx + 1} av ${hs.length} (${hs[idx].points || 0} p)`;
    else hsEl.textContent = `Highscorelista: ${hs.length} elever p√• denna enhet.`;
  }
}

function _fv4_renderStrongWeakLists(strongStats, weakStats, goalsById){
  const strongEl = _fv4_getEl("progressStrongList");
  const weakEl = _fv4_getEl("progressWeakList");
  if (strongEl) strongEl.innerHTML = "";
  if (weakEl) weakEl.innerHTML = "";

  function renderGrouped(listEl, stats, emptyText){
    if (!listEl) return;
    if (!stats.length){
      const li = document.createElement("li");
      li.textContent = emptyText;
      listEl.appendChild(li);
      return;
    }

    // group by goal title
    const groups = new Map();
    stats.forEach((st) => {
      const meta = goalsById.get(String(st.id)) || null;
      const goalTitle = (meta && meta.goal) ? meta.goal : "Delm√•l";
      if (!groups.has(goalTitle)) groups.set(goalTitle, []);
      groups.get(goalTitle).push({ st, meta });
    });

    const seen = new Set();
    stats.forEach((st) => {
      const meta = goalsById.get(String(st.id)) || null;
      const goalTitle = (meta && meta.goal) ? meta.goal : "Delm√•l";
      if (seen.has(goalTitle)) return;
      seen.add(goalTitle);

      const liH = document.createElement("li");
      liH.innerHTML = `<div style="font-weight:700;">${_fv4_escapeHtml(goalTitle)}</div>`;
      listEl.appendChild(liH);

      const rows = groups.get(goalTitle) || [];
      rows.forEach(({ st: rowSt, meta: rowMeta }) => {
        const partTxt = (rowMeta && rowMeta.part) ? rowMeta.part : "";
        const sub = document.createElement("li");
        const partLine = partTxt ? `Delbit ${rowSt.id}: ${partTxt}` : `Delbit ${rowSt.id}`;
        sub.innerHTML = `<div class="mini" style="opacity:.95;">${_fv4_escapeHtml(partLine)} ‚Äî <b>${_fv4_escapeHtml(rowSt.level)}</b>: ${rowSt.acc}% (${rowSt.correct}/${rowSt.total})</div>`;
        listEl.appendChild(sub);
      });
    });
  }

  renderGrouped(strongEl, strongStats, "Inga tydliga styrkor √§nnu ‚Äì forts√§tt spela.");
  renderGrouped(weakEl, weakStats, "Inga tydliga svagheter ‚Äì bra jobbat!");
}

function updateProgressionPanel(){
  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);
  const prog = s.progression;
  const best = (s.best && typeof s.best === "object") ? s.best : { E:0, C:0, A:0 };
  const thres = _fv4_getThresholds(s);

  const pointsText = _fv4_getEl("progressPointsText");
  const last = prog.lastResult || null;
  const totalPoints = typeof prog.totalPoints === "number" ? prog.totalPoints : 0;

  if (pointsText){
    if (!last){
      pointsText.textContent = "Ingen data √§nnu. L√•t eleven spela och l√§mna in niv√•er.";
    }else{
      pointsText.textContent =
        `Totalt: ${totalPoints} p. ` +
        `Senast: niv√• ${last.level} ‚Äì ${last.score}% (${last.correct}/${last.total} r√§tt) +${last.pointsGained || 0}p. ` +
        `B√§sta: E ${best.E || 0}% (gr√§ns ${thres.E}%), C ${best.C || 0}% (gr√§ns ${thres.C}%), A ${best.A || 0}% (gr√§ns ${thres.A}%).`;
    }
  }

  const goals = normalizeGoalsMap(s);
  const goalsById = new Map();
  goals.forEach((g)=> goalsById.set(String(g.id), g));

  const cL = prog.correctByGoalLevel || { E:{}, C:{}, A:{} };
  const wL = prog.wrongByGoalLevel || { E:{}, C:{}, A:{} };

  const allIds = new Set();
  ["E","C","A"].forEach((lv)=>{
    const c = (cL && cL[lv]) ? cL[lv] : {};
    const w = (wL && wL[lv]) ? wL[lv] : {};
    Object.keys(c).forEach((k)=>allIds.add(String(k)));
    Object.keys(w).forEach((k)=>allIds.add(String(k)));
  });

  if (!allIds.size){
    const strongEl = _fv4_getEl("progressStrongList");
    const weakEl = _fv4_getEl("progressWeakList");
    if (strongEl){
      strongEl.innerHTML = "";
      const li = document.createElement("li");
      li.textContent = "Inga starka delbitar inl√§sta √§nnu.";
      strongEl.appendChild(li);
    }
    if (weakEl){
      weakEl.innerHTML = "";
      const li = document.createElement("li");
      li.textContent = "Inga svaga delbitar inl√§sta √§nnu.";
      weakEl.appendChild(li);
    }
    return;
  }

  const stats = [];
  allIds.forEach((id)=>{
    ["E","C","A"].forEach((lv)=>{
      const c = (cL && cL[lv] && typeof cL[lv][id] === "number") ? cL[lv][id] : (cL && cL[lv] && cL[lv][id]) ? Number(cL[lv][id]) : 0;
      const w = (wL && wL[lv] && typeof wL[lv][id] === "number") ? wL[lv][id] : (wL && wL[lv] && wL[lv][id]) ? Number(wL[lv][id]) : 0;
      const total = (Number(c)||0) + (Number(w)||0);
      if (!total) return;
      const acc = Math.round(((Number(c)||0) / total) * 100);
      stats.push({ id:String(id), level:lv, correct:Number(c)||0, wrong:Number(w)||0, total, acc });
    });
  });

  const strong = stats
    .filter((st)=> st.total > 0 && st.acc >= (thres[st.level] || 70))
    .sort((a,b)=> (b.acc - a.acc) || (b.correct - a.correct) || (a.level < b.level ? 1 : -1))
    .slice(0, 18);

  const weak = stats
    .filter((st)=> st.total > 0 && st.acc < (thres[st.level] || 70))
    .sort((a,b)=> (b.wrong - a.wrong) || (a.acc - b.acc) || (a.level < b.level ? 1 : -1))
    .slice(0, 18);

  _fv4_renderStrongWeakLists(strong, weak, goalsById);
}

function handleGenerateProgressJson(){
  const s = _fv4_loadState();
  const prog = (s && s.progression && typeof s.progression === "object") ? s.progression : {};
  const last = prog.lastResult || null;
  const output = _fv4_getEl("progressExportJson");
  if (!output) return;

  if (!last){
    output.value = "";
    return;
  }

  const payload = {
    source: "fangvaktaren",
    version: "v17",
    student: {
      name: (s.student && s.student.name) ? s.student.name : "",
      klass: (s.student && s.student.klass) ? s.student.klass : ""
    },
    result: {
      level: last.level,
      scorePercent: last.score,
      correct: last.correct,
      total: last.total,
      pointsGained: last.pointsGained,
      totalPointsAfter: last.totalPointsAfter,
      timestamp: last.timestamp
    },
    progression: {
      totalPoints: (prog.totalPoints || 0),
      best: s.best || {},
      wrongByGoalId: prog.wrongByGoalId || {},
      correctByGoalId: prog.correctByGoalId || {},
      wrongByGoalLevel: prog.wrongByGoalLevel || { E:{}, C:{}, A:{} },
      correctByGoalLevel: prog.correctByGoalLevel || { E:{}, C:{}, A:{} }
    }
  };

  output.value = JSON.stringify(payload, null, 2);
}

function handleCopyProgressJson(){
  const output = _fv4_getEl("progressExportJson");
  if (!output) return;
  const text = output.value || "";
  if (!text.trim()) return;

  if (navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).catch(()=>{});
  }
}

function updateAllProgressionUI(){
  updateStudentStatsUI();
  updateProgressionPanel();
  renderGoalsListAndSelects();
}

function handleClearStudentData(){
  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);

  if (!confirm("Detta rensar alla sparade elevuppgifter, highscore och progression p√• DENNA dator. Forts√§tt?")) return;

  s.student = { name:"", klass:"" };
  s.progression = { totalPoints:0, wrongByGoalId:{}, correctByGoalId:{}, wrongByGoalLevel:{E:{},C:{},A:{}}, correctByGoalLevel:{E:{},C:{},A:{}}, lastResult:null };
  s.best = { E:0, C:0, A:0 };
  s.unlocked = { C:false, A:false };
  s.highscores = [];

  _fv4_saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = _fv4_getEl("resetStatus");
  if (status) status.textContent = "Elevdata rensad p√• denna enhet.";
}

function handleResetGameData(){
  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);

  if (!confirm("Detta nollst√§ller po√§ng, progression och highscore men beh√•ller nuvarande elevnamn/klass. Forts√§tt?")) return;

  s.progression = { totalPoints:0, wrongByGoalId:{}, correctByGoalId:{}, wrongByGoalLevel:{E:{},C:{},A:{}}, correctByGoalLevel:{E:{},C:{},A:{}}, lastResult:null };
  s.best = { E:0, C:0, A:0 };
  s.unlocked = { C:false, A:false };
  s.highscores = [];

  _fv4_saveState(s);
  updateAllProgressionUI();
  syncUI();

  const status = _fv4_getEl("resetStatus");
  if (status) status.textContent = "Spelpo√§ng och progression nollst√§lld.";
}
/* slut Sektion 4D: Progression ‚Äì stark/svag enligt niv√•tr√∂sklar + rubrik/underrubrik */






/* start Sektion 4E: UI-sync (niv√•kort + elevinfo) */
// √Ñndrat: studentCard g√∂ms nu bara vid aktivt spel (inte vid resultat) s√• Po√§ng/Highscore syns efter inl√§mning. (1 rad √§ndrad)
function handleSaveStudent(){
  const nameInput = _fv4_getEl("studentName");
  const classInput = _fv4_getEl("studentClass");
  const s = _fv4_loadState();

  if (!s.student || typeof s.student !== "object") s.student = { name:"", klass:"" };
  s.student.name = (nameInput && nameInput.value.trim()) || "";
  s.student.klass = (classInput && classInput.value.trim()) || "";

  _fv4_saveState(s);
  syncUI();
}

function syncUI(){
  const s = _fv4_loadState();
  if (!s.student || typeof s.student !== "object") s.student = { name:"", klass:"" };

  const hasStudent = !!(s.student.name && s.student.klass);

  const nameInput = _fv4_getEl("studentName");
  const classInput = _fv4_getEl("studentClass");
  if (nameInput) nameInput.value = s.student.name || "";
  if (classInput) classInput.value = s.student.klass || "";

  const studentSaved = _fv4_getEl("studentSaved");
  if (studentSaved){
    studentSaved.textContent = hasStudent ? `Sparad: ${s.student.name} (${s.student.klass})` : "Ej sparad elev";
  }

  if (!s.best) s.best = { E:0, C:0, A:0 };

  const bestE = _fv4_getEl("best-levelE");
  const bestC = _fv4_getEl("best-levelC");
  const bestA = _fv4_getEl("best-levelA");
  if (bestE) bestE.textContent = (s.best && s.best.E) || 0;
  if (bestC) bestC.textContent = (s.best && s.best.C) || 0;
  if (bestA) bestA.textContent = (s.best && s.best.A) || 0;

  const th = _fv4_getThresholds(s);
  const thresE = _fv4_getEl("thres-levelE");
  const thresC = _fv4_getEl("thres-levelC");
  const thresA = _fv4_getEl("thres-levelA");
  if (thresE) thresE.textContent = th.E;
  if (thresC) thresC.textContent = th.C;
  if (thresA) thresA.textContent = th.A;

  if (!s.unlocked || typeof s.unlocked !== "object") s.unlocked = { C:false, A:false };

  const cardE = _fv4_getEl("card-levelE");
  const cardC = _fv4_getEl("card-levelC");
  const cardA = _fv4_getEl("card-levelA");
  const btnE = _fv4_getEl("start-levelE");
  const btnC = _fv4_getEl("start-levelC");
  const btnA = _fv4_getEl("start-levelA");
  const badgeE = _fv4_getEl("badge-levelE");
  const badgeC = _fv4_getEl("badge-levelC");
  const badgeA = _fv4_getEl("badge-levelA");

  if (cardE && btnE && badgeE){
    if (hasStudent){
      cardE.classList.remove("locked");
      btnE.disabled = false;
      badgeE.textContent = "Starta";
      badgeE.classList.remove("badge-lock");
      badgeE.classList.add("badge-ok");
    }else{
      cardE.classList.add("locked");
      btnE.disabled = true;
      badgeE.textContent = "L√•st";
      badgeE.classList.remove("badge-ok");
      badgeE.classList.add("badge-lock");
    }
  }

  if (cardC && btnC && badgeC){
    if (s.unlocked && s.unlocked.C){
      cardC.classList.remove("locked");
      btnC.disabled = false;
      badgeC.textContent = "Uppl√•st";
      badgeC.classList.remove("badge-lock");
      badgeC.classList.add("badge-ok");
    }else{
      cardC.classList.add("locked");
      btnC.disabled = true;
      badgeC.textContent = "L√•st";
      badgeC.classList.remove("badge-ok");
      badgeC.classList.add("badge-lock");
    }
  }

  if (cardA && btnA && badgeA){
    if (s.unlocked && s.unlocked.A){
      cardA.classList.remove("locked");
      btnA.disabled = false;
      badgeA.textContent = "Uppl√•st";
      badgeA.classList.remove("badge-lock");
      badgeA.classList.add("badge-ok");
    }else{
      cardA.classList.add("locked");
      btnA.disabled = true;
      badgeA.textContent = "L√•st";
      badgeA.classList.remove("badge-ok");
      badgeA.classList.add("badge-lock");
    }
  }

  const who = _fv4_getEl("whoPlays");
  if (who){
    who.textContent = hasStudent ? `${s.student.name} (${s.student.klass})` : "Ingen elev vald.";
  }

  const isPlaying = !!currentLevel;

  const studentCard = _fv4_getEl("studentCard");
  if (studentCard) studentCard.classList.toggle("hidden", isPlaying);

  updateAllProgressionUI();

  try{
    if (typeof window.fvUpdateAplUI === "function") window.fvUpdateAplUI();
  }catch(e){}
}
/* slut Sektion 4E: UI-sync (niv√•kort + elevinfo) */






/* start Sektion 4G: Spel-logik (render + start + finish) */
function renderDragQuestion(q, index, host){
  const container = document.createElement("div");
  container.className = "question";

  const lv = _fv4_levelOf(q);
  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${lv}) ‚Äì Drag & Drop`;
  container.appendChild(header);

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = _fv4_getQuestionText(q) || "";
  container.appendChild(textDiv);

  const col1 = String((q && (q.col1 || q.column1 || (q.columns && q.columns[0]) || (q.cols && q.cols[0]))) || "Kolumn 1");
  const col2 = String((q && (q.col2 || q.column2 || (q.columns && q.columns[1]) || (q.cols && q.cols[1]))) || "Kolumn 2");
  const items = Array.isArray(q && (q.items || q.dragItems || q.cards || q.words)) ? (q.items || q.dragItems || q.cards || q.words) : [];

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.flexWrap = "wrap";
  wrapper.style.gap = "12px";
  wrapper.style.marginTop = "6px";

  const sourcesCol = document.createElement("div");
  sourcesCol.style.flex = "1 1 180px";

  const targetsCol = document.createElement("div");
  targetsCol.style.flex = "2 1 260px";

  const srcTitle = document.createElement("div");
  srcTitle.className = "mini";
  srcTitle.textContent = "Kort att dra:";
  sourcesCol.appendChild(srcTitle);

  const srcZone = document.createElement("div");
  srcZone.style.border = "1px dashed #1f2937";
  srcZone.style.borderRadius = "8px";
  srcZone.style.padding = "6px";
  srcZone.style.minHeight = "40px";
  srcZone.style.display = "flex";
  srcZone.style.flexWrap = "wrap";
  srcZone.style.gap = "4px";
  sourcesCol.appendChild(srcZone);

  const tgtTitle = document.createElement("div");
  tgtTitle.className = "mini";
  tgtTitle.textContent = "Kategori-rutor:";
  targetsCol.appendChild(tgtTitle);

  const tgtZone = document.createElement("div");
  tgtZone.style.display = "flex";
  tgtZone.style.flexWrap = "wrap";
  tgtZone.style.gap = "8px";
  targetsCol.appendChild(tgtZone);

  wrapper.appendChild(sourcesCol);
  wrapper.appendChild(targetsCol);
  container.appendChild(wrapper);

  const answers = {};
  currentAnswers[index] = answers;

  const targets = [
    { id: "0", label: col1 },
    { id: "1", label: col2 }
  ];

  function makeDraggableChip(label, itemId){
    const chip = document.createElement("div");
    chip.textContent = label;
    chip.draggable = true;
    chip.dataset.itemId = itemId;
    chip.className = "chip";
    chip.style.cursor = "grab";
    chip.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", itemId);
    });
    return chip;
  }

  function setupDropTarget(el, targetId){
    el.addEventListener("dragover", (ev)=>ev.preventDefault());
    el.addEventListener("drop", (ev)=>{
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      el.appendChild(existing);

      if (targetId === null) delete answers[itemId];
      else answers[itemId] = String(targetId);
    });
  }

  setupDropTarget(srcZone, null);

  const correctMap = {};
  for (let i=0;i<items.length;i++){
    const it = items[i] || {};
    const txt = String(it.text || it.label || it.word || it.value || it.item || "").trim();
    if (!txt) continue;

    const correct = (typeof it.correct !== "undefined") ? it.correct
                  : (typeof it.target !== "undefined") ? it.target
                  : (typeof it.col !== "undefined") ? it.col
                  : (typeof it.column !== "undefined") ? it.column
                  : (typeof it.to !== "undefined") ? it.to
                  : 0;

    const itemId = String(it.id || it.itemId || `d${index}_${i}`);
    correctMap[itemId] = String((Number(correct) || 0) === 1 ? "1" : "0");

    const chip = makeDraggableChip(txt, itemId);
    srcZone.appendChild(chip);
  }

  q._fvDragCorrectMap = correctMap;

  targets.forEach((tgt)=>{
    const box = document.createElement("div");
    box.style.border = "1px solid #1f2937";
    box.style.borderRadius = "8px";
    box.style.padding = "6px";
    box.style.minHeight = "46px";
    box.style.minWidth = "110px";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "4px";

    const cap = document.createElement("div");
    cap.className = "mini";
    cap.textContent = tgt.label;
    box.appendChild(cap);

    const slot = document.createElement("div");
    slot.style.display = "flex";
    slot.style.flexWrap = "wrap";
    slot.style.gap = "4px";
    box.appendChild(slot);

    slot.addEventListener("dragover", (ev)=>ev.preventDefault());
    slot.addEventListener("drop", (ev)=>{
      ev.preventDefault();
      const itemId = ev.dataTransfer.getData("text/plain");
      if (!itemId) return;

      const existing = container.querySelector(`.chip[data-item-id="${itemId}"]`);
      if (!existing) return;

      slot.appendChild(existing);
      answers[itemId] = String(tgt.id);
    });

    tgtZone.appendChild(box);
  });

  host.appendChild(container);
}

function renderQuestionItem(q, index, host){
  const type = _fv4_typeOf(q);
  if (type === "drag"){
    renderDragQuestion(q, index, host);
    return;
  }

  const container = document.createElement("div");
  container.className = "question";

  const lv = _fv4_levelOf(q);
  const header = document.createElement("div");
  header.textContent = `Fr√•ga ${index + 1} (${lv})`;
  container.appendChild(header);

  if (type === "img"){
    const src = _fv4_getImgSrc(q);
    if (src){
      const img = document.createElement("img");
      img.src = src;
      img.alt = "Bildfr√•ga";
      container.appendChild(img);
    }
  }

  const textDiv = document.createElement("div");
  textDiv.className = "q-text";
  textDiv.textContent = _fv4_getQuestionText(q) || "";
  container.appendChild(textDiv);

  const options = Array.isArray(q && q.options) ? q.options : [];
  const optionsList = document.createElement("div");
  optionsList.className = "options-list";

  options.forEach((opt, optIndex) => {
    const label = document.createElement("label");
    label.className = "option-label";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = `q-${index}`;
    input.value = String(optIndex);
    input.addEventListener("change", () => { currentAnswers[index] = optIndex; });

    const span = document.createElement("span");
    span.textContent = String(opt);

    label.appendChild(input);
    label.appendChild(span);
    optionsList.appendChild(label);
  });

  container.appendChild(optionsList);
  host.appendChild(container);
}

function startLevel(level){
  if (!ensureStudentSet()) return;

  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);
  s.bank = _fv4_ensureBankShape(s.bank);

  const allQuestions = []
    .concat(s.bank.mcq || [])
    .concat(s.bank.img || [])
    .concat(s.bank.drag || []);

  const pool = allQuestions.filter((q)=> _fv4_levelOf(q) === level);
  if (!pool.length){
    alert("Det finns inga fr√•gor p√• denna niv√• √§nnu.");
    return;
  }

  currentLevel = level;
  currentQuestions = _fv4_shuffle(pool);
  currentAnswers = new Array(currentQuestions.length).fill(null);

  const playSection = _fv4_getEl("play");
  const resultSection = _fv4_getEl("result");
  const questionsHost = _fv4_getEl("questions");

  if (resultSection) resultSection.classList.add("hidden");
  if (playSection) playSection.classList.remove("hidden");
  if (questionsHost){
    questionsHost.innerHTML = "";
    currentQuestions.forEach((q, idx)=> renderQuestionItem(q, idx, questionsHost));
  }

  const title = _fv4_getEl("play-title");
  const who = _fv4_getEl("whoPlays");
  if (title){
    if (level === "E") title.textContent = "Niv√• 1 ‚Äì Grundniv√• (E)";
    else if (level === "C") title.textContent = "Niv√• 2 ‚Äì Mellanniv√• (C)";
    else title.textContent = "Niv√• 3 ‚Äì Avancerad (A)";
  }
  if (who) who.textContent = `${s.student.name} (${s.student.klass})`;

  _fv4_saveState(s);
  syncUI();
}

function finishLevel(){
  if (!currentLevel || !currentQuestions.length){
    alert("Ingen niv√• √§r aktiv.");
    return;
  }

  const s0 = _fv4_loadState();
  const s = _fv4_ensureProgressionShape(s0);
  s.bank = _fv4_ensureBankShape(s.bank);

  if (!s.progression.attemptsByLevel || typeof s.progression.attemptsByLevel !== "object"){
    s.progression.attemptsByLevel = { E:0, C:0, A:0 };
  } else {
    if (s.progression.attemptsByLevel.E == null) s.progression.attemptsByLevel.E = 0;
    if (s.progression.attemptsByLevel.C == null) s.progression.attemptsByLevel.C = 0;
    if (s.progression.attemptsByLevel.A == null) s.progression.attemptsByLevel.A = 0;
  }

  const goals = normalizeGoalsMap(s);
  const thres = _fv4_getThresholds(s);

  const lvl = currentLevel;
  const threshold = thres[lvl] != null ? thres[lvl] : 70;

  s.progression.attemptsByLevel[lvl] = Number(s.progression.attemptsByLevel[lvl] || 0) + 1;
  s.progression.attemptsTotal =
    Number(s.progression.attemptsByLevel.E || 0) +
    Number(s.progression.attemptsByLevel.C || 0) +
    Number(s.progression.attemptsByLevel.A || 0);
  s.progression.attempts = s.progression.attemptsTotal;

  let correctCount = 0;
  let pointsGained = 0;
  let allCorrect = true;

  const wrongByGoal = s.progression.wrongByGoalId;
  const correctByGoal = s.progression.correctByGoalId;

  const wrongByGoalLv = s.progression.wrongByGoalLevel[lvl];
  const correctByGoalLv = s.progression.correctByGoalLevel[lvl];

  const basePointsPerQuestion = (lvl === "A") ? 3 : (lvl === "C") ? 2 : 1;

  currentQuestions.forEach((q, index) => {
    const type = _fv4_typeOf(q);
    const ansVal = currentAnswers[index];
    let isCorrect = false;

    if (type === "drag"){
      let correctMap = (q && q.correctMap && typeof q.correctMap === "object") ? q.correctMap : null;
      if (!correctMap && q && q._fvDragCorrectMap) correctMap = q._fvDragCorrectMap;

      if (!correctMap){
        const items = Array.isArray(q && (q.items || q.dragItems || q.cards || q.words)) ? (q.items || q.dragItems || q.cards || q.words) : [];
        correctMap = {};
        for (let i=0;i<items.length;i++){
          const it = items[i] || {};
          const txt = String(it.text || it.label || it.word || it.value || it.item || "").trim();
          if (!txt) continue;
          const correct = (typeof it.correct !== "undefined") ? it.correct
                        : (typeof it.target !== "undefined") ? it.target
                        : (typeof it.col !== "undefined") ? it.col
                        : (typeof it.column !== "undefined") ? it.column
                        : (typeof it.to !== "undefined") ? it.to
                        : 0;
          const itemId = String(it.id || it.itemId || `d${index}_${i}`);
          correctMap[itemId] = String((Number(correct) || 0) === 1 ? "1" : "0");
        }
      }

      const keys = correctMap ? Object.keys(correctMap) : [];
      if (!keys.length) {
        isCorrect = false;
      } else if (!ansVal || typeof ansVal !== "object") {
        isCorrect = false;
      } else {
        let allOk = true;
        for (const itemId of keys){
          if (String(ansVal[itemId]) !== String(correctMap[itemId])){
            allOk = false;
            break;
          }
        }
        isCorrect = allOk;
      }
    } else {
      const correctIndex = (typeof q.answer === "number") ? q.answer : (typeof q.correct === "number" ? q.correct : null);
      if (ansVal != null && correctIndex != null) isCorrect = (Number(ansVal) === Number(correctIndex));
      else isCorrect = false;
    }

    if (isCorrect){
      correctCount++;
      pointsGained += basePointsPerQuestion;
    } else {
      allCorrect = false;
    }

    const links = getLinksForQuestion(q, goals);
    if (links && links.length){
      links.forEach((lnk) => {
        const key = String(lnk.id);

        if (isCorrect) correctByGoal[key] = (correctByGoal[key] || 0) + 1;
        else wrongByGoal[key] = (wrongByGoal[key] || 0) + 1;

        if (isCorrect) correctByGoalLv[key] = (correctByGoalLv[key] || 0) + 1;
        else wrongByGoalLv[key] = (wrongByGoalLv[key] || 0) + 1;

        try{ _fv4_pushRecent(s.progression, lvl, key, isCorrect, _fv4_RECENT_N); }catch(e){}
        try{ _fv4_updateDecay(s.progression, lvl, key, isCorrect); }catch(e){}
      });
    }
  });

  const total = currentQuestions.length;
  const percentage = total ? Math.round((correctCount / total) * 100) : 0;

  if (!s.best) s.best = { E:0, C:0, A:0 };
  if (percentage > (s.best[lvl] || 0)) s.best[lvl] = percentage;

  if (!s.unlocked) s.unlocked = { C:false, A:false };
  if (lvl === "E" && percentage >= threshold) s.unlocked.C = true;
  if (lvl === "C" && percentage >= threshold) s.unlocked.A = true;

  if (total > 0 && allCorrect) pointsGained += 5;

  s.progression.totalPoints += pointsGained;
  const totalPointsAfter = s.progression.totalPoints;

  const nowIso = _fv4_nowIso();
  const lastResult = {
    level: lvl,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    timestamp: nowIso,
    attemptsByLevel: {
      E: Number(s.progression.attemptsByLevel.E || 0),
      C: Number(s.progression.attemptsByLevel.C || 0),
      A: Number(s.progression.attemptsByLevel.A || 0)
    },
    attemptsTotal: Number(s.progression.attemptsTotal || 0)
  };
  s.progression.lastResult = lastResult;

  if (!Array.isArray(s.highscores)) s.highscores = [];
  const id = (s.student && s.student.name ? s.student.name : "Elev") + "||" + (s.student && s.student.klass ? s.student.klass : "-");
  const newEntry = {
    id,
    name: (s.student && s.student.name) ? s.student.name : "Elev",
    klass: (s.student && s.student.klass) ? s.student.klass : "-",
    points: totalPointsAfter,
    level: lvl,
    score: percentage,
    updatedAt: nowIso
  };
  const idx = s.highscores.findIndex((e)=> e && e.id === id);
  if (idx >= 0){
    if ((newEntry.points || 0) >= (s.highscores[idx].points || 0)) s.highscores[idx] = newEntry;
  } else {
    s.highscores.push(newEntry);
  }

  _fv4_saveState(s);

  lastSubmission = {
    level: lvl,
    studentName: (s.student && s.student.name) ? s.student.name : "",
    studentClass: (s.student && s.student.klass) ? s.student.klass : "",
    timestamp: nowIso,
    score: percentage,
    correct: correctCount,
    total,
    pointsGained,
    totalPointsAfter,
    attemptsByLevel: {
      E: Number(s.progression.attemptsByLevel.E || 0),
      C: Number(s.progression.attemptsByLevel.C || 0),
      A: Number(s.progression.attemptsByLevel.A || 0)
    },
    attemptsTotal: Number(s.progression.attemptsTotal || 0),
    answers: Array.isArray(currentAnswers) ? currentAnswers.slice() : [],
    questions: currentQuestions.map((qq)=>({
      q: _fv4_getQuestionText(qq),
      type: _fv4_typeOf(qq),
      level: _fv4_levelOf(qq),
      answer: (typeof qq.answer === "number") ? qq.answer : (typeof qq.correct === "number" ? qq.correct : null),
      goalPart: _fv4_getGoalPartIdFromQuestion(qq) || null
    }))
  };

  const playSection = _fv4_getEl("play");
  const resultSection = _fv4_getEl("result");
  if (playSection) playSection.classList.add("hidden");
  if (resultSection) resultSection.classList.remove("hidden");

  const scoreText = _fv4_getEl("scoreText");
  const scoreDetail = _fv4_getEl("scoreDetail");
  const resName = _fv4_getEl("resName");
  const resClass = _fv4_getEl("resClass");
  const passBadge = _fv4_getEl("passBadge");
  const unlockText = _fv4_getEl("unlockText");

  if (scoreText) scoreText.innerHTML = `${percentage}%<span> resultat</span>`;
  if (scoreDetail) scoreDetail.textContent = `${correctCount}/${total} r√§tt ‚Äì niv√•po√§ng: +${pointsGained}p, totalt: ${totalPointsAfter}p`;
  if (resName) resName.textContent = (s.student && s.student.name) ? s.student.name : "-";
  if (resClass) resClass.textContent = (s.student && s.student.klass) ? s.student.klass : "-";

  if (passBadge){
    const passed = percentage >= threshold;
    if (passed){
      passBadge.className = "badge-pass";
      passBadge.textContent = "Godk√§nd niv√•";
    } else {
      passBadge.className = "badge-fail";
      passBadge.textContent = "Inte godk√§nd √§nnu";
    }
  }

  if (unlockText){
    let txt = "";
    if (lvl === "E" && s.unlocked.C) txt = "Niv√• 2 (C) √§r nu uppl√•st.";
    else if (lvl === "C" && s.unlocked.A) txt = "Niv√• 3 (A) √§r nu uppl√•st.";
    unlockText.textContent = txt;
  }

  currentLevel = null;
  currentQuestions = [];
  currentAnswers = [];

  updateAllProgressionUI();
  syncUI();
}
/* slut Sektion 4G: Spel-logik (render + start + finish) */






/* start Sektion 4I: FIREBASE ‚Äì elevinl√§mning (attemptsByLevel + attemptsTotal) */
// √ÑNDRING: L√§gger till saveCurrentResultToFirestore() (alias) s√• submit-knappen inte kraschar. (Omskrivna/nya rader: 27)

function _fv4_safeNum2(n, fallback=0){
  const x = Number(n);
  return isFinite(x) ? x : fallback;
}

function _fv4_getStudentTokenForCloud(){
  try{
    const s = _fv4_loadState();
    const qs = new URLSearchParams(location.search);
    const t =
      (s && (s.studentToken || s.token || (s.student && s.student.token))) ||
      qs.get("token") ||
      "";
    return String(t || "").trim();
  }catch(e){
    return "";
  }
}

function _fv4_getStudentsCollectionRefForCloud(){
  try{
    if (!window.firebaseDbInstance || typeof firebaseDbInstance.collection !== "function") return null;

    const s = _fv4_loadState();
    const ab = (s && s.activeBank && typeof s.activeBank==="object") ? s.activeBank : {};
    const qs = new URLSearchParams(location.search);

    const publicId = String(ab.publicId || qs.get("public") || "").trim();
    if (publicId){
      return firebaseDbInstance
        .collection(PUBLIC_BANKS_COLLECTION).doc(publicId)
        .collection("students");
    }

    const ownerUid = String(ab.ownerUid || "").trim();
    const bankId = String(ab.bankId || ab.id || "").trim();
    if (ownerUid && bankId){
      return firebaseDbInstance
        .collection(CLOUD_ROOT_COLLECTION).doc(ownerUid)
        .collection(CLOUD_BANKS_SUBCOLLECTION).doc(bankId)
        .collection("students");
    }

    if (window.currentTeacherUser && currentTeacherUser.uid && String(window.activeCloudBankId||"").trim()){
      return firebaseDbInstance
        .collection(CLOUD_ROOT_COLLECTION).doc(String(currentTeacherUser.uid))
        .collection(CLOUD_BANKS_SUBCOLLECTION).doc(String(window.activeCloudBankId))
        .collection("students");
    }

    return null;
  }catch(e){
    return null;
  }
}

async function fvSubmitLastResultToCloud(){
  try{ if (typeof initFirebase === "function") await initFirebase(); }catch(e){}

  try{
    if (!window.firebase || !window.firebaseDbInstance) return { ok:false, reason:"no_firebase" };
    if (!firebase.firestore || !firebase.firestore.FieldValue) return { ok:false, reason:"no_fieldvalue" };

    const ref = _fv4_getStudentsCollectionRefForCloud();
    if (!ref) return { ok:false, reason:"no_ref" };

    const token = _fv4_getStudentTokenForCloud();
    if (!token) return { ok:false, reason:"no_token" };

    const s0 = _fv4_loadState();
    const s = _fv4_ensureProgressionShape(s0);
    const prog = (s && s.progression) ? s.progression : {};

    const last = (prog && prog.lastResult && typeof prog.lastResult==="object") ? prog.lastResult : null;
    const lvlRaw =
      (lastSubmission && lastSubmission.level) ||
      (last && last.level) ||
      "E";

    const L = String(lvlRaw || "E").toUpperCase();
    const lvl = (L === "A" || L === "C") ? L : "E";

    const inc = firebase.firestore.FieldValue.increment(1);
    const ts = (firebase.firestore.FieldValue.serverTimestamp)
      ? firebase.firestore.FieldValue.serverTimestamp()
      : _fv4_nowIso();

    const lastCompact = last ? last : (lastSubmission ? {
      level: lvl,
      score: _fv4_safeNum2(lastSubmission.score, 0),
      correct: _fv4_safeNum2(lastSubmission.correct, 0),
      total: _fv4_safeNum2(lastSubmission.total, 0),
      pointsGained: _fv4_safeNum2(lastSubmission.pointsGained, 0),
      totalPointsAfter: _fv4_safeNum2(lastSubmission.totalPointsAfter, _fv4_safeNum2(prog.totalPoints, 0)),
      timestamp: String(lastSubmission.timestamp || _fv4_nowIso())
    } : null);

    const attemptsByLevelPatch = {};
    attemptsByLevelPatch[lvl] = inc;

    const progressionPatch = {
      totalPoints: _fv4_safeNum2(prog.totalPoints, 0),
      correctByGoalId: (prog.correctByGoalId && typeof prog.correctByGoalId==="object") ? prog.correctByGoalId : {},
      wrongByGoalId: (prog.wrongByGoalId && typeof prog.wrongByGoalId==="object") ? prog.wrongByGoalId : {},
      lastResult: lastCompact,
      attemptsTotal: inc,
      attemptsByLevel: attemptsByLevelPatch
    };

    const data = {
      studentName: (s.student && s.student.name) ? String(s.student.name) : "",
      studentClass: (s.student && s.student.klass) ? String(s.student.klass) : "",
      updatedAt: ts,
      progression: progressionPatch
    };

    await ref.doc(String(token)).set(data, { merge: true });
    return { ok:true };
  }catch(e){
    console.warn("fvSubmitLastResultToCloud misslyckades:", e);
    return { ok:false, reason:"error" };
  }
}

try{ window.fvSubmitLastResultToCloud = fvSubmitLastResultToCloud; }catch(e){}

async function saveCurrentResultToFirestore(){
  const r = await fvSubmitLastResultToCloud();
  if (!r || !r.ok){
    throw new Error((r && r.reason) ? r.reason : "submit_failed");
  }
  return r;
}
try{ window.saveCurrentResultToFirestore = saveCurrentResultToFirestore; }catch(e){}

(function(){
  try{
    if (window.__fv4_finishlevel_cloud_hooked) return;
    if (typeof window.finishLevel !== "function") return;
    window.__fv4_finishlevel_cloud_hooked = true;

    const _orig = window.finishLevel;
    window.finishLevel = function(){
      const r = _orig.apply(this, arguments);
      try{
        if (typeof window.fvSubmitLastResultToCloud === "function"){
          Promise.resolve().then(()=>window.fvSubmitLastResultToCloud()).catch(()=>{});
        }
      }catch(e){}
      return r;
    };
  }catch(e){}
})();

/* slut Sektion 4I: FIREBASE ‚Äì elevinl√§mning (attemptsByLevel + attemptsTotal) */
</script>



<!-- start SEKTION 4J: APL CHECK-IN (UI) -->
<!-- APL "egen sida": modalen ligger direkt under <body> (inte i aplCheckinSection) -->
<div id="aplModal" class="modal hidden" aria-hidden="true">
  <div class="modal-content card" style="max-width:760px; width:94vw;">
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
      <div>
        <div class="q-text">APL</div>
        <div class="mini" id="aplModalSub"></div>
      </div>
      <button class="btn btn-sm" type="button" id="btnAplClose" aria-label="St√§ng">‚úñ</button>
    </div>

    <div style="display:grid; gap:10px; margin-top:10px;">

      <!-- LANDNING (f√∂re incheckning) -->
      <div id="aplLandingWrap" style="display:grid; gap:10px;">

        <div class="fv-goal-card" id="aplManualCard">
          <div class="fv-goal-head">
            <div>
              <div class="fv-goal-title">Manuell kod</div>
              <div class="mini">Om kamera inte fungerar: skriv koden som st√•r under QR-koden.</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="fv-goal-item" style="align-items:center;">
              <div style="min-width:0; width:100%;">
                <input id="aplManualCode" type="text" inputmode="text" autocomplete="off" placeholder="APL-kod"
                  style="width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(75,85,99,.65); background:#0b1220; color:var(--text);" />
                <div class="mini" style="margin-top:6px;" id="aplManualHint">Exempel: APL-MRS-2026-01</div>
              </div>
              <div class="fv3-actions" style="flex:0 0 auto;">
                <button class="btn fv3-btn-xs btn-primary" type="button" id="btnAplCheckinManual">Checka in</button>
              </div>
            </div>

            <div class="mini hidden" id="aplSubmitStatus" style="display:none; margin-top:8px;"></div>
          </div>
        </div>

        <div class="fv-goal-card" id="aplScanCard">
          <div class="fv-goal-head">
            <div>
              <div class="fv-goal-title">Skanna QR</div>
              <div class="mini"></div>
            </div>
            <div class="fv3-actions">
              <button class="btn fv3-btn-xs btn-primary" type="button" id="btnAplScanIn">Skanna f√∂r incheckning</button>
              <button class="btn fv3-btn-xs" type="button" id="btnAplScanOut">Skanna f√∂r utcheckning</button>
            </div>
          </div>

          <div style="margin-top:10px;">
            <video id="aplVideo" playsinline muted class="hidden" style="width:100%; border-radius:16px; border:1px solid rgba(75,85,99,.65); background:#0b1220;"></video>
            <div class="mini hidden" id="aplScanStatus" style="display:none; margin-top:8px;"></div>
          </div>
        </div>

      </div>

      <!-- INCHECKAD VY (efter incheckning) -->
      <div id="aplCheckedWrap" class="hidden" style="display:none; gap:10px;">

        <div class="fv-goal-card">
          <div class="fv-goal-head">
            <div>
              <div class="fv-goal-title">‚úÖ Du √§r incheckad</div>
              <div class="mini" id="aplCheckedMini">‚Äî</div>
            </div>
            <div class="fv3-actions">
              <button class="btn fv3-btn-xs" type="button" id="btnAplCheckoutManual">Manuell utcheckning</button>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="fv-goal-item" style="justify-content:flex-start;">
              <div style="min-width:0;">
                <div class="fv-goal-part" id="aplCheckedText">‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <!-- DOMINANTA KNAPPAR (flikar) -->
        <div class="fv-goal-card">
          <div style="margin-top:2px;">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-primary" type="button" id="btnAplTabGoals"
                style="flex:1 1 220px; padding:16px 14px; border-radius:16px; font-size:1.05rem; font-weight:800; letter-spacing:.2px;">
                L√§rom√•l
              </button>

              <button class="btn" type="button" id="btnAplTabDiary"
                style="flex:1 1 220px; padding:16px 14px; border-radius:16px; font-size:1.05rem; font-weight:800; letter-spacing:.2px; background:#16a34a; border-color:#15803d; color:#fff;">
                Dagbok
              </button>

              <button class="btn" type="button" id="btnAplTabDays"
                style="flex:1 1 220px; padding:16px 14px; border-radius:16px; font-size:1.05rem; font-weight:800; letter-spacing:.2px; background:#111827; border-color:#0f172a; color:#fff;">
                Dagssidor
              </button>
            </div>

            <div style="margin-top:10px; display:grid; gap:10px;">
              <div id="aplTabGoalsPane" class="hidden" style="display:none;"></div>

              <!-- DAGBOK (DAGSBLAD) -->
              <div id="aplTabDiaryPane" class="hidden" style="display:none;">

                <div class="fv-goal-card" style="margin-top:0;">
                  <div class="fv-goal-head">
                    <div>
                      <div class="fv-goal-title">Dagsblad</div>
                      <div class="mini" id="aplDiaryMeta">‚Äî</div>
                    </div>
                  </div>

                  <div style="margin-top:10px; display:grid; gap:10px;">
                    <!-- FOTO -->
                    <div class="fv-goal-item" style="justify-content:flex-start; align-items:flex-start;">
                      <div style="min-width:0; width:100%;">
                        <div class="fv-goal-part" style="margin-bottom:6px;">Foto p√• dagens prestation</div>
                        <input id="aplDiaryPhoto" type="file" accept="image/*" capture="environment"
                          style="width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(75,85,99,.65); background:#0b1220; color:var(--text);" />
                        <img id="aplDiaryPhotoPreview" class="hidden"
                          style="display:none; margin-top:10px; width:100%; border-radius:14px; border:1px solid rgba(75,85,99,.35);" alt="F√∂rhandsvisning" />
                      </div>
                    </div>

                    <!-- FR√ÖGOR -->
                    <div class="fv-goal-item" style="justify-content:flex-start; align-items:flex-start;">
                      <div style="min-width:0; width:100%;">
                        <div class="fv-goal-part" style="margin-bottom:6px;">Dagens intryck</div>
                        <textarea id="aplDiaryImpression" rows="2" placeholder="Skriv kort..."
                          style="width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(75,85,99,.65); background:#0b1220; color:var(--text); resize:vertical;"></textarea>
                      </div>
                    </div>

                    <div class="fv-goal-item" style="justify-content:flex-start; align-items:flex-start;">
                      <div style="min-width:0; width:100%;">
                        <div class="fv-goal-part" style="margin-bottom:6px;">Det som gick bra</div>
                        <textarea id="aplDiaryWentWell" rows="2" placeholder="Skriv kort..."
                          style="width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(75,85,99,.65); background:#0b1220; color:var(--text); resize:vertical;"></textarea>
                      </div>
                    </div>

                    <div class="fv-goal-item" style="justify-content:flex-start; align-items:flex-start;">
                      <div style="min-width:0; width:100%;">
                        <div class="fv-goal-part" style="margin-bottom:6px;">Det som var sv√•rt</div>
                        <textarea id="aplDiaryHard" rows="2" placeholder="Skriv kort..."
                          style="width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(75,85,99,.65); background:#0b1220; color:var(--text); resize:vertical;"></textarea>
                      </div>
                    </div>

                    <!-- ACTIONS -->
                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                      <button class="btn btn-primary" type="button" id="btnAplDiarySubmit"
                        style="flex:1 1 220px; padding:14px 14px; border-radius:14px; font-weight:800;">
                        Skicka dagbok
                      </button>
                      <button class="btn" type="button" id="btnAplDiarySaveDraft"
                        style="flex:1 1 220px; padding:14px 14px; border-radius:14px; font-weight:800;">
                        Spara utkast
                      </button>
                    </div>

                    <div class="mini hidden" id="aplDiaryStatus" style="display:none;"></div>
                  </div>
                </div>

                <!-- HANDLEDARE GODK√ÑNN -->
                <div class="fv-goal-card hidden" id="aplSupervisorCard" style="display:none;">
                  <div class="fv-goal-head">
                    <div>
                      <div class="fv-goal-title">Handledare</div>
                      <div class="mini">Godk√§nn dagsbladet genom att skriva APL-koden.</div>
                    </div>
                  </div>

                  <div style="margin-top:10px; display:grid; gap:10px;">
                    <div class="fv-goal-item" style="align-items:center;">
                      <div style="min-width:0; width:100%;">
                        <input id="aplSupervisorCode" type="text" inputmode="text" autocomplete="off" placeholder="APL-kod"
                          style="width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(75,85,99,.65); background:#0b1220; color:var(--text);" />
                      </div>
                      <div class="fv3-actions" style="flex:0 0 auto;">
                        <button class="btn fv3-btn-xs btn-primary" type="button" id="btnAplSupervisorApprove">Godk√§nn</button>
                      </div>
                    </div>
                    <div class="mini hidden" id="aplSupervisorStatus" style="display:none;"></div>
                  </div>
                </div>

              </div>

              <!-- DAGSSIDOR (LISTA + DETALJ) -->
              <div id="aplTabDaysPane" class="hidden" style="display:none;">
                <div class="fv-goal-card" style="margin-top:0;">
                  <div class="fv-goal-head">
                    <div>
                      <div class="fv-goal-title">Dagssidor</div>
                      <div class="mini" id="aplDaysMeta">Godk√§nda dagssidor.</div>
                    </div>
                    <div class="fv3-actions">
                      <button class="btn fv3-btn-xs btn-primary" type="button" id="btnAplDaysRefresh">Uppdatera</button>
                    </div>
                  </div>

                  <div style="margin-top:10px; display:grid; gap:10px;">
                    <div class="miniased"></div>
                    <div id="aplDaysList" style="display:grid; gap:10px;"></div>

                    <div id="aplDaysEmpty" class="mini hidden" style="display:none;">Inga godk√§nda dagssidor √§nnu.</div>

                    <div id="aplDaysDetail" class="hidden" style="display:none;">

                      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;">
                        <div>
                          <div class="fv-goal-part" id="aplDaysDetailTitle">‚Äî</div>
                          <div class="mini" id="aplDaysDetailMeta">‚Äî</div>
                        </div>
                        <button class="btn fv3-btn-xs" type="button" id="btnAplDaysBack">Tillbaka</button>
                      </div>

                      <img id="aplDaysDetailImg" class="hidden"
                        style="display:none; width:100%; border-radius:14px; border:1px solid rgba(75,85,99,.35);" alt="Bild" />

                      <div style="margin-top:10px; display:grid; gap:10px;">
                        <div class="fv-goal-item" style="justify-content:flex-start;">
                          <div style="min-width:0;">
                            <div class="mini">Dagens intryck</div>
                            <div class="fv-goal-part" id="aplDaysDetailImpression">‚Äî</div>
                          </div>
                        </div>
                        <div class="fv-goal-item" style="justify-content:flex-start;">
                          <div style="min-width:0;">
                            <div class="mini">Det som gick bra</div>
                            <div class="fv-goal-part" id="aplDaysDetailWentWell">‚Äî</div>
                          </div>
                        </div>
                        <div class="fv-goal-item" style="justify-content:flex-start;">
                          <div style="min-width:0;">
                            <div class="mini">Det som var sv√•rt</div>
                            <div class="fv-goal-part" id="aplDaysDetailHard">‚Äî</div>
                          </div>
                        </div>
                      </div>

                    </div>

                    <div class="mini hidden" id="aplDaysStatus" style="display:none;"></div>
                  </div>
                </div>
              </div>

            </div>

          </div>
        </div>

      </div>

    </div>

    <div class="fv-goals-actions" style="margin-top:10px;">
      <button class="btn" type="button" id="btnAplClose2">St√§ng</button>
    </div>
  </div>
</div>
<!-- slut SEKTION 4J: APL CHECK-IN (UI) -->



<!-- start SEKTION 4K: APL CHECK-IN (LOGIK) -->
<script>
(function(){
  const __FV_APL_ADMIN_TEST_CODE = "APL-MRS-2026-01";

  let __fvAplStream = null;
  let __fvAplDetector = null;
  let __fvAplScanRAF = 0;
  let __fvAplScanning = false;
  let __fvAplScanMode = "in"; // "in" | "out"

  // cache f√∂r dagssidor i session
  let __fvAplDaysCache = [];

  function _fv4_setText(id, txt){
    const el = _fv4_getEl(id);
    if (el) el.textContent = String(txt||"");
  }

  function _fv4_formatTs(x){
    try{
      const d = new Date(String(x||""));
      if (isNaN(d.getTime())) return String(x||"");
      return d.toLocaleString();
    }catch(e){
      return String(x||"");
    }
  }

  function _fv4_showMsg(id, txt){
    const el = _fv4_getEl(id);
    if (!el) return;
    el.textContent = String(txt||"");
    el.classList.remove("hidden");
    el.style.display = "block";
  }

  function _fv4_hideMsg(id){
    const el = _fv4_getEl(id);
    if (!el) return;
    el.textContent = "";
    el.classList.add("hidden");
    el.style.display = "none";
  }

  function _fv4_showEl(id){
    const el = _fv4_getEl(id);
    if (!el) return;
    el.classList.remove("hidden");
    el.style.display = "block";
  }

  function _fv4_hideEl(id){
    const el = _fv4_getEl(id);
    if (!el) return;
    el.classList.add("hidden");
    el.style.display = "none";
  }

  function _fv4_getAplActive(){
    try{
      const s = _fv4_loadState();
      return (s && s.aplActive && typeof s.aplActive==="object") ? s.aplActive : null;
    }catch(e){
      return null;
    }
  }

  function _fv4_setAplActive(obj){
    try{
      const s = _fv4_loadState();
      s.aplActive = obj || null;
      _fv4_saveState(s);
    }catch(e){}
  }

  function _fv4_getAplDiaryLocal(){
    try{
      const s = _fv4_loadState();
      return (s && s.aplDiary && typeof s.aplDiary==="object") ? s.aplDiary : {};
    }catch(e){
      return {};
    }
  }

  function _fv4_setAplDiaryLocal(obj){
    try{
      const s = _fv4_loadState();
      s.aplDiary = obj || {};
      _fv4_saveState(s);
    }catch(e){}
  }

  function _fv4_todayKey(){
    try{
      return new Date().toISOString().slice(0,10); // YYYY-MM-DD
    }catch(e){
      return "today";
    }
  }

  function _fv4_isCheckedIn(){
    try{
      const a = _fv4_getAplActive();
      return !!(a && a.isCheckedIn);
    }catch(e){
      return false;
    }
  }

  function _fv4_setCheckedInState(code, method){
    const obj = {
      isCheckedIn: true,
      code: String(code||"").trim(),
      method: String(method||"manual"),
      atIso: _fv4_nowIso()
    };
    _fv4_setAplActive(obj);
    return obj;
  }

  function _fv4_clearCheckedInState(){
    _fv4_setAplActive({ isCheckedIn:false, code:"", method:"", atIso:_fv4_nowIso() });
  }

  async function _fv4_submitAplEvent(code, method, eventType){
    const c = String(code||"").trim();
    if (!c) throw new Error("no_code");

    const isAdminTest = (c === __FV_APL_ADMIN_TEST_CODE);

    // ADMIN TEST: till√•t UI-test √§ven om Firebase/token/bank strular
    if (isAdminTest){
      return {
        type: String(eventType||"checkin"),
        code: c,
        method: String(method||"admin-test"),
        atIso: _fv4_nowIso()
      };
    }

    try{ if (typeof initFirebase === "function") await initFirebase(); }catch(e){}

    if (!window.firebase || !window.firebaseDbInstance) throw new Error("no_firebase");
    if (!firebase.firestore || !firebase.firestore.FieldValue) throw new Error("no_fieldvalue");

    const ref = _fv4_getStudentsCollectionRefForCloud();
    if (!ref) throw new Error("no_ref");

    const token = _fv4_getStudentTokenForCloud();
    if (!token) throw new Error("no_token");

    const s = _fv4_loadState();
    const studentName = (s.student && s.student.name) ? String(s.student.name) : "";
    const studentClass = (s.student && s.student.klass) ? String(s.student.klass) : "";

    const ts = (firebase.firestore.FieldValue.serverTimestamp)
      ? firebase.firestore.FieldValue.serverTimestamp()
      : _fv4_nowIso();

    const payload = {
      type: String(eventType||"checkin"),
      code: c,
      method: String(method||"manual"),
      studentName,
      studentClass,
      createdAt: ts,
      createdAtIso: _fv4_nowIso()
    };

    await ref.doc(String(token)).collection("aplCheckins").add(payload);

    return {
      type: payload.type,
      code: c,
      method: payload.method,
      atIso: payload.createdAtIso
    };
  }

  function _fv4_installAplPageStyles(){
    try{
      if (document.getElementById("fvAplPageStyles")) return;
      const st = document.createElement("style");
      st.id = "fvAplPageStyles";
      st.textContent = `
        body.fv-apl-open #studentCard,
        body.fv-apl-open .levels-grid,
        body.fv-apl-open .front-actions-wrap{
          display:none !important;
        }
        body.fv-apl-open #aplModal{
          display:flex !important;
          position:fixed !important;
          inset:0 !important;
          z-index:999999 !important;
          align-items:center !important;
          justify-content:center !important;
          padding:14px !important;
          background:rgba(15,23,42,.78) !important;
          backdrop-filter:blur(10px) !important;
        }
        body.fv-apl-open #aplModal .modal-content{
          width:min(980px,100%) !important;
          max-height:90vh !important;
          overflow:auto !important;
        }
        #aplModal.hidden{ display:none !important; }
      `;
      document.head.appendChild(st);
    }catch(e){}
  }

  function _fv4_setAplHeaderCheckedIn(active){
    const sub = _fv4_getEl("aplModalSub");
    if (!sub) return;
    if (active && active.isCheckedIn){
      sub.textContent = `‚úÖ Incheckad (${active.code})`;
    }else{
      sub.textContent = "";
    }
  }

  function _fv4_switchAplView(){
    const landing = _fv4_getEl("aplLandingWrap");
    const checked = _fv4_getEl("aplCheckedWrap");
    const isIn = _fv4_isCheckedIn();

    if (landing){
      if (isIn){
        landing.classList.add("hidden");
        landing.style.display = "none";
      }else{
        landing.classList.remove("hidden");
        landing.style.display = "grid";
      }
    }
    if (checked){
      if (isIn){
        checked.classList.remove("hidden");
        checked.style.display = "grid";
      }else{
        checked.classList.add("hidden");
        checked.style.display = "none";
      }
    }

    try{ _fv4_hideMsg("aplSubmitStatus"); }catch(e){}
    try{ _fv4_hideMsg("aplScanStatus"); }catch(e){}

    try{ fvUpdateAplUI(); }catch(e){}
    try{ fvAplDiaryRender(); }catch(e){}
  }

  function _fv4_setTab(which){
    const paneG = _fv4_getEl("aplTabGoalsPane");
    const paneD = _fv4_getEl("aplTabDiaryPane");
    const paneDays = _fv4_getEl("aplTabDaysPane");

    const btnG = _fv4_getEl("btnAplTabGoals");
    const btnD = _fv4_getEl("btnAplTabDiary");
    const btnDays = _fv4_getEl("btnAplTabDays");

    const isGoals = (which === "goals");
    const isDiary = (which === "diary");
    const isDays  = (which === "days");

    if (btnG){
      if (isGoals) btnG.classList.add("btn-primary");
      else btnG.classList.remove("btn-primary");
    }
    if (btnD){
      if (isDiary) btnD.classList.add("btn-primary");
      else btnD.classList.remove("btn-primary");
    }
    if (btnDays){
      if (isDays) btnDays.classList.add("btn-primary");
      else btnDays.classList.remove("btn-primary");
    }

    if (paneG){
      if (isGoals){ paneG.classList.remove("hidden"); paneG.style.display="block"; }
      else{ paneG.classList.add("hidden"); paneG.style.display="none"; }
    }
    if (paneD){
      if (isDiary){ paneD.classList.remove("hidden"); paneD.style.display="block"; }
      else{ paneD.classList.add("hidden"); paneD.style.display="none"; }
    }
    if (paneDays){
      if (isDays){ paneDays.classList.remove("hidden"); paneDays.style.display="block"; }
      else{ paneDays.classList.add("hidden"); paneDays.style.display="none"; }
    }
  }

  function fvUpdateAplUI(){
    try{
      const active = _fv4_getAplActive();
      if (active && active.isCheckedIn){
        _fv4_setText("aplCheckedMini", `${active.method} ‚Ä¢ ${_fv4_formatTs(active.atIso)}`);
        _fv4_setText("aplCheckedText", `Kod: ${active.code}`);
        _fv4_setAplHeaderCheckedIn(active);
      }else{
        _fv4_setText("aplCheckedMini", "‚Äî");
        _fv4_setText("aplCheckedText", "‚Äî");
        _fv4_setAplHeaderCheckedIn(null);
      }
    }catch(e){}
  }
  try{ window.fvUpdateAplUI = fvUpdateAplUI; }catch(e){}

  // ===== DAGBOK =====

  function _fv4_diaryGetKey(){
    const active = _fv4_getAplActive();
    const d = _fv4_todayKey();
    const code = active && active.code ? String(active.code) : "nocode";
    return `${d}__${code}`;
  }

  function _fv4_diaryRead(){
    const all = _fv4_getAplDiaryLocal();
    const k = _fv4_diaryGetKey();
    return (all && all[k]) ? all[k] : null;
  }

  function _fv4_diaryWrite(entry){
    const all = _fv4_getAplDiaryLocal();
    const k = _fv4_diaryGetKey();
    all[k] = entry;
    _fv4_setAplDiaryLocal(all);
  }

  function _fv4_diaryCollectFromUI(){
    const active = _fv4_getAplActive();
    const dateKey = _fv4_todayKey();
    const aplCode = active && active.code ? String(active.code) : "";
    const impression = String((_fv4_getEl("aplDiaryImpression")||{}).value||"").trim();
    const wentWell   = String((_fv4_getEl("aplDiaryWentWell")||{}).value||"").trim();
    const hard       = String((_fv4_getEl("aplDiaryHard")||{}).value||"").trim();

    return { dateKey, aplCode, impression, wentWell, hard };
  }

  function _fv4_diarySetUI(entry){
    const imp = _fv4_getEl("aplDiaryImpression");
    const ww  = _fv4_getEl("aplDiaryWentWell");
    const hd  = _fv4_getEl("aplDiaryHard");

    if (imp) imp.value = entry && entry.impression ? entry.impression : "";
    if (ww)  ww.value  = entry && entry.wentWell ? entry.wentWell : "";
    if (hd)  hd.value  = entry && entry.hard ? entry.hard : "";
  }

  function _fv4_diaryPreviewFromFile(file){
    const img = _fv4_getEl("aplDiaryPhotoPreview");
    if (!img) return;
    if (!file){
      img.src = "";
      img.classList.add("hidden");
      img.style.display = "none";
      return;
    }
    try{
      const url = URL.createObjectURL(file);
      img.src = url;
      img.classList.remove("hidden");
      img.style.display = "block";
    }catch(e){}
  }

  function _fv4_diarySupervisorUI(show){
    const card = _fv4_getEl("aplSupervisorCard");
    if (!card) return;
    if (show){
      card.classList.remove("hidden");
      card.style.display = "block";
    }else{
      card.classList.add("hidden");
      card.style.display = "none";
      try{ _fv4_hideMsg("aplSupervisorStatus"); }catch(e){}
    }
  }

  function fvAplDiaryRender(){
    try{
      const active = _fv4_getAplActive();
      const meta = _fv4_getEl("aplDiaryMeta");
      const isIn = !!(active && active.isCheckedIn);
      const dateKey = _fv4_todayKey();
      const code = active && active.code ? String(active.code) : "";

      if (meta){
        meta.textContent = isIn ? `${dateKey} ‚Ä¢ ${code}` : "‚Äî";
      }

      const entry = _fv4_diaryRead();
      if (entry){
        _fv4_diarySetUI(entry);

        if (entry.photoPreviewDataUrl){
          const img = _fv4_getEl("aplDiaryPhotoPreview");
          if (img){
            img.src = entry.photoPreviewDataUrl;
            img.classList.remove("hidden");
            img.style.display = "block";
          }
        }

        _fv4_diarySupervisorUI(entry.status === "submitted");
      }else{
        _fv4_diarySupervisorUI(false);
      }
    }catch(e){}
  }
  try{ window.fvAplDiaryRender = fvAplDiaryRender; }catch(e){}

  async function _fv4_uploadDiaryPhotoIfPossible(file, token, dateKey, aplCode){
    if (!file) return "";
    try{
      if (!window.firebase || !firebase.storage) return "";
      if (typeof initFirebase === "function") await initFirebase();

      const st = firebase.storage();
      if (!st || !st.ref) return "";

      const safeName = String(file.name||"photo.jpg").replace(/[^\w.\-]+/g, "_");
      const path = `aplDiary/${String(token)}/${String(dateKey)}/${String(aplCode)}/${safeName}`;
      const ref = st.ref().child(path);

      const snap = await ref.put(file, { contentType: file.type || "image/jpeg" });
      if (!snap || !snap.ref || !snap.ref.getDownloadURL) return "";
      const url = await snap.ref.getDownloadURL();
      return String(url||"");
    }catch(e){
      return "";
    }
  }

  async function _fv4_diarySaveToCloud(entry, status){
    const active = _fv4_getAplActive();
    const aplCode = active && active.code ? String(active.code) : "";
    const isAdminTest = (aplCode === __FV_APL_ADMIN_TEST_CODE);

    const dateKey = entry.dateKey || _fv4_todayKey();
    const docId = `${dateKey}__${aplCode}`;

    if (isAdminTest){
      return { ok:true, localOnly:true, docId };
    }

    try{ if (typeof initFirebase === "function") await initFirebase(); }catch(e){}

    if (!window.firebase || !window.firebaseDbInstance) throw new Error("no_firebase");
    if (!firebase.firestore || !firebase.firestore.FieldValue) throw new Error("no_fieldvalue");

    const ref = _fv4_getStudentsCollectionRefForCloud();
    if (!ref) throw new Error("no_ref");

    const token = _fv4_getStudentTokenForCloud();
    if (!token) throw new Error("no_token");

    const ts = (firebase.firestore.FieldValue.serverTimestamp)
      ? firebase.firestore.FieldValue.serverTimestamp()
      : _fv4_nowIso();

    const payload = {
      dateKey,
      aplCode,
      impression: entry.impression || "",
      wentWell: entry.wentWell || "",
      hard: entry.hard || "",
      status: String(status||"draft"),
      photoUrl: entry.photoUrl || "",
      createdAt: ts,
      updatedAtIso: _fv4_nowIso(),
      approvedAtIso: entry.approvedAtIso || "",
      approvedBy: entry.approvedBy || ""
    };

    await ref.doc(String(token)).collection("aplDiary").doc(docId).set(payload, { merge:true });
    return { ok:true, localOnly:false, docId };
  }

  async function _fv4_doDiarySaveDraft(){
    const active = _fv4_getAplActive();
    if (!active || !active.isCheckedIn){
      _fv4_showMsg("aplDiaryStatus", "‚ö†Ô∏è Du m√•ste vara incheckad f√∂r att skriva dagbok.");
      return;
    }

    const entry = _fv4_diaryCollectFromUI();
    const fileInput = _fv4_getEl("aplDiaryPhoto");
    const file = (fileInput && fileInput.files && fileInput.files[0]) ? fileInput.files[0] : null;

    if (file){
      try{
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            entry.photoPreviewDataUrl = String(reader.result||"");
            _fv4_diaryWrite({ ...(_fv4_diaryRead()||{}), ...entry, status:"draft" });
            _fv4_showMsg("aplDiaryStatus", "‚úÖ Utkast sparat.");
            _fv4_diarySupervisorUI(false);
          }catch(e){}
        };
        reader.readAsDataURL(file);
      }catch(e){
        _fv4_diaryWrite({ ...(_fv4_diaryRead()||{}), ...entry, status:"draft" });
        _fv4_showMsg("aplDiaryStatus", "‚úÖ Utkast sparat.");
        _fv4_diarySupervisorUI(false);
      }
    }else{
      _fv4_diaryWrite({ ...(_fv4_diaryRead()||{}), ...entry, status:"draft" });
      _fv4_showMsg("aplDiaryStatus", "‚úÖ Utkast sparat.");
      _fv4_diarySupervisorUI(false);
    }

    try{
      await _fv4_diarySaveToCloud({ ...(_fv4_diaryRead()||{}), ...entry }, "draft");
    }catch(e){}
  }

  async function _fv4_doDiarySubmit(){
    const active = _fv4_getAplActive();
    if (!active || !active.isCheckedIn){
      _fv4_showMsg("aplDiaryStatus", "‚ö†Ô∏è Du m√•ste vara incheckad f√∂r att skicka dagbok.");
      return;
    }

    const entry = _fv4_diaryCollectFromUI();
    const hasAnyText = !!(entry.impression || entry.wentWell || entry.hard);

    if (!hasAnyText){
      _fv4_showMsg("aplDiaryStatus", "‚ö†Ô∏è Svara p√• minst en fr√•ga innan du skickar.");
      return;
    }

    _fv4_showMsg("aplDiaryStatus", "Skickar‚Ä¶");

    const fileInput = _fv4_getEl("aplDiaryPhoto");
    const file = (fileInput && fileInput.files && fileInput.files[0]) ? fileInput.files[0] : null;

    let photoUrl = "";
    try{
      const token = _fv4_getStudentTokenForCloud() || "local";
      photoUrl = await _fv4_uploadDiaryPhotoIfPossible(file, token, entry.dateKey || _fv4_todayKey(), entry.aplCode || "");
    }catch(e){
      photoUrl = "";
    }

    const merged = { ...(_fv4_diaryRead()||{}), ...entry, photoUrl, status:"submitted" };
    _fv4_diaryWrite(merged);

    try{
      await _fv4_diarySaveToCloud(merged, "submitted");
      _fv4_showMsg("aplDiaryStatus", "‚úÖ Skickad. V√§nta p√• handledarens godk√§nnande.");
    }catch(e){
      _fv4_showMsg("aplDiaryStatus", "‚úÖ Skickad lokalt. (Moln saknas just nu)");
    }

    _fv4_diarySupervisorUI(true);
  }

  // ===== DAGSSIDOR =====

  function _fv4_daysClearUI(){
    const list = _fv4_getEl("aplDaysList");
    if (list) list.innerHTML = "";
    _fv4_hideEl("aplDaysDetail");
  }

  function _fv4_daysShowEmpty(show){
    const e = _fv4_getEl("aplDaysEmpty");
    if (!e) return;
    if (show){
      e.classList.remove("hidden");
      e.style.display = "block";
    }else{
      e.classList.add("hidden");
      e.style.display = "none";
    }
  }

  function _fv4_daysThumbFromEntry(x){
    if (!x) return "";
    return String(x.thumbUrl || x.photoUrl || x.photoPreviewDataUrl || "");
  }

  function _fv4_daysBuildCard(x){
    const dateKey = String(x.dateKey || "");
    const aplCode = String(x.aplCode || "");
    const thumb = _fv4_daysThumbFromEntry(x);

    const excerpt = (x.wentWell || x.impression || x.hard || "").toString().trim();
    const short = excerpt.length > 70 ? (excerpt.slice(0,70) + "‚Ä¶") : excerpt;

    const card = document.createElement("div");
    card.className = "fv-goal-item";
    card.style.cursor = "pointer";
    card.style.alignItems = "center";
    card.style.gap = "10px";

    const imgWrap = document.createElement("div");
    imgWrap.style.flex = "0 0 auto";
    imgWrap.style.width = "64px";
    imgWrap.style.height = "64px";
    imgWrap.style.borderRadius = "14px";
    imgWrap.style.overflow = "hidden";
    imgWrap.style.border = "1px solid rgba(75,85,99,.35)";
    imgWrap.style.background = "#0b1220";

    const img = document.createElement("img");
    img.alt = "Miniatyr";
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";
    if (thumb){
      img.src = thumb;
    }else{
      img.style.display = "none";
    }
    imgWrap.appendChild(img);

    const txt = document.createElement("div");
    txt.style.minWidth = "0";
    txt.style.flex = "1 1 auto";

    const t1 = document.createElement("div");
    t1.className = "fv-goal-part";
    t1.textContent = dateKey || "‚Äî";

    const t2 = document.createElement("div");
    t2.className = "mini";
    t2.textContent = short ? short : (aplCode ? aplCode : "");

    txt.appendChild(t1);
    txt.appendChild(t2);

    card.appendChild(imgWrap);
    card.appendChild(txt);

    card.addEventListener("click", ()=>{
      try{ fvAplDaysOpenDetail(x); }catch(e){}
    });

    return card;
  }

  function fvAplDaysRenderList(items){
    const list = _fv4_getEl("aplDaysList");
    if (!list) return;

    list.innerHTML = "";
    _fv4_daysShowEmpty(!items || !items.length);

    if (!items || !items.length) return;

    items.forEach(x=>{
      try{
        const c = _fv4_daysBuildCard(x);
        list.appendChild(c);
      }catch(e){}
    });
  }
  try{ window.fvAplDaysRenderList = fvAplDaysRenderList; }catch(e){}

  function fvAplDaysOpenDetail(x){
    if (!x) return;

    _fv4_hideEl("aplDaysList");
    _fv4_hideEl("aplDaysEmpty");

    _fv4_showEl("aplDaysDetail");

    _fv4_setText("aplDaysDetailTitle", String(x.dateKey || "‚Äî"));
    _fv4_setText("aplDaysDetailMeta", String(x.aplCode || ""));

    _fv4_setText("aplDaysDetailImpression", String(x.impression || "‚Äî"));
    _fv4_setText("aplDaysDetailWentWell", String(x.wentWell || "‚Äî"));
    _fv4_setText("aplDaysDetailHard", String(x.hard || "‚Äî"));

    const imgEl = _fv4_getEl("aplDaysDetailImg");
    const src = _fv4_daysThumbFromEntry(x);
    if (imgEl){
      if (src){
        imgEl.src = src;
        imgEl.classList.remove("hidden");
        imgEl.style.display = "block";
      }else{
        imgEl.src = "";
        imgEl.classList.add("hidden");
        imgEl.style.display = "none";
      }
    }
  }
  try{ window.fvAplDaysOpenDetail = fvAplDaysOpenDetail; }catch(e){}

  function fvAplDaysBack(){
    _fv4_hideEl("aplDaysDetail");
    _fv4_showEl("aplDaysList");
    const list = _fv4_getEl("aplDaysList");
    if (list) list.style.display = "grid";
    _fv4_showEl("aplDaysEmpty"); // renderList styr om den ska synas
    _fv4_daysShowEmpty(!__fvAplDaysCache || !__fvAplDaysCache.length);
  }

  function _fv4_daysFromLocalApproved(){
    const all = _fv4_getAplDiaryLocal();
    const out = [];
    try{
      Object.keys(all||{}).forEach(k=>{
        const x = all[k];
        if (x && x.status === "approved"){
          out.push({
            dateKey: x.dateKey || (String(k).split("__")[0] || ""),
            aplCode: x.aplCode || "",
            impression: x.impression || "",
            wentWell: x.wentWell || "",
            hard: x.hard || "",
            photoUrl: x.photoUrl || "",
            photoPreviewDataUrl: x.photoPreviewDataUrl || "",
            approvedAtIso: x.approvedAtIso || ""
          });
        }
      });
    }catch(e){}
    out.sort((a,b)=>String(b.dateKey||"").localeCompare(String(a.dateKey||"")));
    return out;
  }

  async function fvAplDaysLoadApproved(){
    _fv4_showMsg("aplDaysStatus", "H√§mtar‚Ä¶");

    // admin-test: endast lokalt
    const active = _fv4_getAplActive();
    const aplCode = active && active.code ? String(active.code) : "";
    const isAdminTest = (aplCode === __FV_APL_ADMIN_TEST_CODE);

    if (isAdminTest){
      __fvAplDaysCache = _fv4_daysFromLocalApproved();
      fvAplDaysRenderList(__fvAplDaysCache);
      _fv4_hideMsg("aplDaysStatus");
      return __fvAplDaysCache;
    }

    // F√∂rs√∂k cloud
    try{
      if (typeof initFirebase === "function") await initFirebase();
      if (!window.firebase || !window.firebaseDbInstance) throw new Error("no_firebase");
      if (!firebase.firestore) throw new Error("no_firestore");

      const ref = _fv4_getStudentsCollectionRefForCloud();
      if (!ref) throw new Error("no_ref");

      const token = _fv4_getStudentTokenForCloud();
      if (!token) throw new Error("no_token");

      const q = ref.doc(String(token)).collection("aplDiary")
        .where("status", "==", "approved")
        .orderBy("dateKey", "desc");

      const snap = await q.get();
      const items = [];
      snap.forEach(doc=>{
        const d = doc.data() || {};
        items.push({
          dateKey: d.dateKey || "",
          aplCode: d.aplCode || "",
          impression: d.impression || "",
          wentWell: d.wentWell || "",
          hard: d.hard || "",
          photoUrl: d.photoUrl || "",
          thumbUrl: d.thumbUrl || "",
          approvedAtIso: d.approvedAtIso || "",
          approvedBy: d.approvedBy || ""
        });
      });

      __fvAplDaysCache = items;
      fvAplDaysRenderList(items);
      _fv4_hideMsg("aplDaysStatus");
      return items;
    }catch(e){
      // fallback lokalt
      __fvAplDaysCache = _fv4_daysFromLocalApproved();
      fvAplDaysRenderList(__fvAplDaysCache);
      _fv4_hideMsg("aplDaysStatus");
      return __fvAplDaysCache;
    }
  }
  try{ window.fvAplDaysLoadApproved = fvAplDaysLoadApproved; }catch(e){}

  // ===== HANDLEDARE GODK√ÑNN =====

  async function _fv4_doSupervisorApprove(){
    const active = _fv4_getAplActive();
    if (!active || !active.isCheckedIn){
      _fv4_showMsg("aplSupervisorStatus", "‚ö†Ô∏è Eleven m√•ste vara incheckad.");
      return;
    }

    const entry = _fv4_diaryRead();
    if (!entry || entry.status !== "submitted"){
      _fv4_showMsg("aplSupervisorStatus", "‚ö†Ô∏è Dagboken m√•ste vara skickad f√∂rst.");
      return;
    }

    const inp = _fv4_getEl("aplSupervisorCode");
    const entered = inp ? String(inp.value||"").trim() : "";
    const expected = String(active.code||"").trim();

    if (!entered){
      _fv4_showMsg("aplSupervisorStatus", "‚ö†Ô∏è Skriv APL-koden.");
      return;
    }

    if (entered !== expected){
      _fv4_showMsg("aplSupervisorStatus", "‚ö†Ô∏è Fel kod.");
      return;
    }

    _fv4_showMsg("aplSupervisorStatus", "Godk√§nner‚Ä¶");

    const updated = {
      ...entry,
      status: "approved",
      approvedAtIso: _fv4_nowIso(),
      approvedBy: entered
    };
    _fv4_diaryWrite(updated);

    try{
      await _fv4_diarySaveToCloud(updated, "approved");
      _fv4_showMsg("aplSupervisorStatus", "‚úÖ Godk√§nd.");
    }catch(e){
      _fv4_showMsg("aplSupervisorStatus", "‚úÖ Godk√§nd lokalt. (Moln saknas just nu)");
    }

    _fv4_diarySupervisorUI(false);
    try{
      if (inp) inp.value = "";
    }catch(e){}
    try{
      if (typeof window.fvToast === "function") window.fvToast("‚úÖ Dagbok godk√§nd.");
    }catch(e){}

    // uppdatera dagssidor direkt
    try{ await fvAplDaysLoadApproved(); }catch(e){}
  }

  // ===== APL FLOW =====

  function _fv4_openApl(){
    _fv4_installAplPageStyles();

    const modal = _fv4_getEl("aplModal");
    if (!modal) return;

    try{ document.body.classList.add("fv-apl-open"); }catch(e){}

    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden","false");
    modal.style.display = "flex";

    try{ _fv4_switchAplView(); }catch(e){}
    try{ if (_fv4_isCheckedIn()) _fv4_setTab("goals"); }catch(e){}
  }

  function _fv4_closeApl(){
    const modal = _fv4_getEl("aplModal");
    if (!modal) return;

    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden","true");
    modal.style.display = "none";

    try{ document.body.classList.remove("fv-apl-open"); }catch(e){}
    try{ _fv4_stopScan(); }catch(e){}
  }

  async function _fv4_startScan(mode){
    const video = _fv4_getEl("aplVideo");

    __fvAplScanMode = (mode === "out") ? "out" : "in";

    if (!video){
      _fv4_showMsg("aplScanStatus", "‚ö†Ô∏è Kameraytan saknas.");
      return;
    }
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      _fv4_showMsg("aplScanStatus", "‚ö†Ô∏è Kamera st√∂ds inte i denna webbl√§sare.");
      return;
    }
    if (!("BarcodeDetector" in window)){
      _fv4_showMsg("aplScanStatus", "‚ö†Ô∏è QR-scanning st√∂ds inte h√§r. Anv√§nd manuell kod.");
      return;
    }

    try{
      __fvAplDetector = new BarcodeDetector({ formats: ["qr_code"] });
    }catch(e){
      _fv4_showMsg("aplScanStatus", "‚ö†Ô∏è QR-scanner kunde inte starta. Anv√§nd manuell kod.");
      return;
    }

    try{
      __fvAplStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
      video.srcObject = __fvAplStream;
      video.classList.remove("hidden");
      await video.play();
      __fvAplScanning = true;

      _fv4_showMsg("aplScanStatus", (__fvAplScanMode === "out") ? "Scannar f√∂r utcheckning‚Ä¶" : "Scannar f√∂r incheckning‚Ä¶");

      const tick = async ()=>{
        if (!__fvAplScanning) return;
        try{
          const barcodes = await __fvAplDetector.detect(video);
          if (barcodes && barcodes.length){
            const raw = String(barcodes[0].rawValue || "").trim();
            if (raw){
              __fvAplScanning = false;
              _fv4_showMsg("aplScanStatus", "Kod hittad ‚Äì skickar‚Ä¶");

              const eventType = (__fvAplScanMode === "out") ? "checkout" : "checkin";

              try{
                const lastObj = await _fv4_submitAplEvent(raw, "scan", eventType);

                if (eventType === "checkin"){
                  const active = _fv4_setCheckedInState(raw, "scan");
                  _fv4_showMsg("aplSubmitStatus", `‚úÖ Incheckad (${lastObj.code}).`);
                  _fv4_setAplHeaderCheckedIn(active);
                  if (typeof window.fvToast === "function") window.fvToast("‚úÖ APL incheckning skickad.");
                  try{ _fv4_switchAplView(); }catch(e){}
                  try{ _fv4_setTab("goals"); }catch(e){}
                }else{
                  _fv4_clearCheckedInState();
                  _fv4_showMsg("aplSubmitStatus", `‚úÖ Utcheckad (${lastObj.code}).`);
                  _fv4_setAplHeaderCheckedIn(null);
                  if (typeof window.fvToast === "function") window.fvToast("‚úÖ APL utcheckning skickad.");
                  try{ _fv4_switchAplView(); }catch(e){}
                }

                try{ fvUpdateAplUI(); }catch(e){}
              }catch(e2){
                _fv4_showMsg("aplSubmitStatus", "‚ö†Ô∏è Kunde inte skicka. Kontrollera token/bank och f√∂rs√∂k igen.");
              }

              try{ _fv4_stopScan(); }catch(e3){}
              return;
            }
          }
        }catch(e){}
        __fvAplScanRAF = requestAnimationFrame(tick);
      };
      __fvAplScanRAF = requestAnimationFrame(tick);
    }catch(e){
      _fv4_showMsg("aplScanStatus", "‚ö†Ô∏è Kunde inte √∂ppna kamera. Anv√§nd manuell kod.");
      try{ _fv4_stopScan(); }catch(e2){}
    }
  }

  function _fv4_stopScan(){
    __fvAplScanning = false;
    try{ if (__fvAplScanRAF) cancelAnimationFrame(__fvAplScanRAF); }catch(e){}
    __fvAplScanRAF = 0;

    const video = _fv4_getEl("aplVideo");
    if (video){
      try{ video.pause(); }catch(e){}
      try{ video.srcObject = null; }catch(e){}
      video.classList.add("hidden");
    }
    if (__fvAplStream){
      try{
        __fvAplStream.getTracks().forEach(t=>{ try{ t.stop(); }catch(e){} });
      }catch(e){}
      __fvAplStream = null;
    }
    try{ _fv4_hideMsg("aplScanStatus"); }catch(e){}
  }

  async function _fv4_doManualCheckin(){
    const inpManual = _fv4_getEl("aplManualCode");
    const code = inpManual ? String(inpManual.value||"").trim() : "";
    if (!code){
      _fv4_showMsg("aplSubmitStatus", "‚ö†Ô∏è Skriv en kod f√∂rst.");
      return;
    }
    _fv4_showMsg("aplSubmitStatus", "Skickar‚Ä¶");
    try{
      const lastObj = await _fv4_submitAplEvent(code, "manual", "checkin");
      if (inpManual) inpManual.value = "";

      const active = _fv4_setCheckedInState(code, "manual");
      _fv4_setAplHeaderCheckedIn(active);

      _fv4_showMsg("aplSubmitStatus", `‚úÖ Incheckad (${lastObj.code}).`);
      if (typeof window.fvToast === "function") window.fvToast("‚úÖ APL incheckning skickad.");
      try{ fvUpdateAplUI(); }catch(e){}
      try{ _fv4_switchAplView(); }catch(e){}
      try{ _fv4_setTab("goals"); }catch(e){}
    }catch(e){
      _fv4_showMsg("aplSubmitStatus", "‚ö†Ô∏è Kunde inte skicka. Kontrollera token/bank och f√∂rs√∂k igen.");
    }
  }

  async function _fv4_doManualCheckout(){
    const active = _fv4_getAplActive();
    const code = (active && active.code) ? String(active.code) : "";

    if (!code){
      _fv4_showMsg("aplSubmitStatus", "‚ö†Ô∏è Ingen aktiv kod att checka ut fr√•n.");
      return;
    }

    _fv4_showMsg("aplSubmitStatus", "Skickar utcheckning‚Ä¶");
    try{
      const lastObj = await _fv4_submitAplEvent(code, "manual", "checkout");
      _fv4_clearCheckedInState();
      _fv4_setAplHeaderCheckedIn(null);

      _fv4_showMsg("aplSubmitStatus", `‚úÖ Utcheckad (${lastObj.code}).`);
      if (typeof window.fvToast === "function") window.fvToast("‚úÖ APL utcheckning skickad.");
      try{ fvUpdateAplUI(); }catch(e){}
      try{ _fv4_switchAplView(); }catch(e){}
    }catch(e){
      _fv4_showMsg("aplSubmitStatus", "‚ö†Ô∏è Kunde inte skicka utcheckning. Kontrollera token/bank och f√∂rs√∂k igen.");
    }
  }

  // ===== BIND =====

  function _fv4_bindApl(){
    _fv4_installAplPageStyles();

    const btnFront  = _fv4_getEl("btnAplFront");
    const btnClose  = _fv4_getEl("btnAplClose");
    const btnClose2 = _fv4_getEl("btnAplClose2");

    const btnScanIn  = _fv4_getEl("btnAplScanIn");
    const btnScanOut = _fv4_getEl("btnAplScanOut");

    const btnManualCheckin = _fv4_getEl("btnAplCheckinManual");
    const btnManualCheckout = _fv4_getEl("btnAplCheckoutManual");

    const btnTabGoals = _fv4_getEl("btnAplTabGoals");
    const btnTabDiary = _fv4_getEl("btnAplTabDiary");
    const btnTabDays  = _fv4_getEl("btnAplTabDays");

    const btnDiarySubmit = _fv4_getEl("btnAplDiarySubmit");
    const btnDiaryDraft  = _fv4_getEl("btnAplDiarySaveDraft");
    const inpPhoto        = _fv4_getEl("aplDiaryPhoto");

    const btnApprove = _fv4_getEl("btnAplSupervisorApprove");

    const btnDaysRefresh = _fv4_getEl("btnAplDaysRefresh");
    const btnDaysBack    = _fv4_getEl("btnAplDaysBack");

    if (btnFront && !btnFront.__fvAplBoundFront){
      btnFront.__fvAplBoundFront = true;
      btnFront.addEventListener("click", (e)=>{ try{ e.preventDefault(); }catch(_){} _fv4_openApl(); });
    }

    if (btnClose && !btnClose.__fvAplBound){
      btnClose.__fvAplBound = true;
      btnClose.addEventListener("click", (e)=>{ try{ e.preventDefault(); }catch(_){} _fv4_closeApl(); });
    }
    if (btnClose2 && !btnClose2.__fvAplBound){
      btnClose2.__fvAplBound = true;
      btnClose2.addEventListener("click", (e)=>{ try{ e.preventDefault(); }catch(_){} _fv4_closeApl(); });
    }

    if (btnScanIn && !btnScanIn.__fvAplBound){
      btnScanIn.__fvAplBound = true;
      btnScanIn.addEventListener("click", ()=>{ _fv4_startScan("in"); });
    }
    if (btnScanOut && !btnScanOut.__fvAplBound){
      btnScanOut.__fvAplBound = true;
      btnScanOut.addEventListener("click", ()=>{ _fv4_startScan("out"); });
    }

    if (btnManualCheckin && !btnManualCheckin.__fvAplBound){
      btnManualCheckin.__fvAplBound = true;
      btnManualCheckin.addEventListener("click", ()=>{ _fv4_doManualCheckin(); });
    }
    if (btnManualCheckout && !btnManualCheckout.__fvAplBound){
      btnManualCheckout.__fvAplBound = true;
      btnManualCheckout.addEventListener("click", ()=>{ _fv4_doManualCheckout(); });
    }

    if (btnTabGoals && !btnTabGoals.__fvAplBound){
      btnTabGoals.__fvAplBound = true;
      btnTabGoals.addEventListener("click", ()=>{ _fv4_setTab("goals"); });
    }
    if (btnTabDiary && !btnTabDiary.__fvAplBound){
      btnTabDiary.__fvAplBound = true;
      btnTabDiary.addEventListener("click", ()=>{ _fv4_setTab("diary"); try{ fvAplDiaryRender(); }catch(e){} });
    }
    if (btnTabDays && !btnTabDays.__fvAplBound){
      btnTabDays.__fvAplBound = true;
      btnTabDays.addEventListener("click", async ()=>{
        _fv4_setTab("days");
        try{
          await fvAplDaysLoadApproved();
        }catch(e){}
      });
    }

    if (btnDiarySubmit && !btnDiarySubmit.__fvBound){
      btnDiarySubmit.__fvBound = true;
      btnDiarySubmit.addEventListener("click", ()=>{ _fv4_doDiarySubmit(); });
    }
    if (btnDiaryDraft && !btnDiaryDraft.__fvBound){
      btnDiaryDraft.__fvBound = true;
      btnDiaryDraft.addEventListener("click", ()=>{ _fv4_doDiarySaveDraft(); });
    }

    if (inpPhoto && !inpPhoto.__fvBound){
      inpPhoto.__fvBound = true;
      inpPhoto.addEventListener("change", ()=>{
        try{
          const f = (inpPhoto.files && inpPhoto.files[0]) ? inpPhoto.files[0] : null;
          _fv4_diaryPreviewFromFile(f);
        }catch(e){}
      });
    }

    if (btnApprove && !btnApprove.__fvBound){
      btnApprove.__fvBound = true;
      btnApprove.addEventListener("click", ()=>{ _fv4_doSupervisorApprove(); });
    }

    if (btnDaysRefresh && !btnDaysRefresh.__fvBound){
      btnDaysRefresh.__fvBound = true;
      btnDaysRefresh.addEventListener("click", async ()=>{
        try{
          await fvAplDaysLoadApproved();
        }catch(e){}
      });
    }

    if (btnDaysBack && !btnDaysBack.__fvBound){
      btnDaysBack.__fvBound = true;
      btnDaysBack.addEventListener("click", ()=>{
        try{ fvAplDaysBack(); }catch(e){}
      });
    }

    const modal = _fv4_getEl("aplModal");
    if (modal && !modal.__fvAplEsc){
      modal.__fvAplEsc = true;
      document.addEventListener("keydown", (ev)=>{
        if (ev && ev.key === "Escape"){
          const m = _fv4_getEl("aplModal");
          if (m && m.getAttribute("aria-hidden") === "false") _fv4_closeApl();
        }
      }, true);
    }

    try{ _fv4_hideMsg("aplSubmitStatus"); }catch(e){}
    try{ _fv4_hideMsg("aplScanStatus"); }catch(e){}
    try{ _fv4_hideMsg("aplDiaryStatus"); }catch(e){}
    try{ _fv4_hideMsg("aplSupervisorStatus"); }catch(e){}
    try{ _fv4_hideMsg("aplDaysStatus"); }catch(e){}

    try{ _fv4_switchAplView(); }catch(e){}
    try{
      if (_fv4_isCheckedIn()){
        _fv4_setTab("goals");
      }
    }catch(e){}
    try{ fvUpdateAplUI(); }catch(e){}
    try{ fvAplDiaryRender(); }catch(e){}
  }

  function _fv4_bootApl(){
    try{ _fv4_bindApl(); }catch(e){}
  }

  try{
    if (document.readyState === "complete" || document.readyState === "interactive"){
      setTimeout(_fv4_bootApl, 10);
    }else{
      document.addEventListener("DOMContentLoaded", ()=>setTimeout(_fv4_bootApl, 10));
    }
  }catch(e){}
})();
</script>
<!-- slut SEKTION 4K: APL CHECK-IN (LOGIK) -->

<!-- slut SEKTION 4: SCRIPT & LOGIK F√ÖNGVAKTAREN (elev, spel, progression & highscore) -->







<!-- start SEKTION 5: UI-BINDINGS (L√§rarl√§ge + Fr√•geeditor + Roster + Exit) -->
<script>


/* start Sektion 5A: HELPERS (fallbacks f√∂r att undvika crash) */

  // sm√• helpers (anv√§nds redan i din kodbas)
  function _fv5_show(el){
    if (!el) return;
    el.classList.remove("hidden");
    el.style.display = "flex";
  }
  function _fv5_hide(el){
    if (!el) return;
    el.classList.add("hidden");
    el.style.display = "none";
  }
  window._fv5_show = window._fv5_show || _fv5_show;
  window._fv5_hide = window._fv5_hide || _fv5_hide;

  // Minimal "on" om den inte finns (din kod anv√§nder on(...) √∂verallt)
  if (typeof window.on !== "function"){
    window.on = (el, evt, fn, opts)=>{ if (el) el.addEventListener(evt, fn, opts||false); };
  }

  // Minimal "$" och "qsa" om de inte finns (din kod anv√§nder dem)
  if (typeof window.$ !== "function"){
    window.$ = (id)=>document.getElementById(id);
  }
  if (typeof window.qsa !== "function"){
    window.qsa = (sel)=>Array.from(document.querySelectorAll(sel));
  }

  // Minimal pick + esc om de saknas (anv√§nds i Sektion 5)
  if (typeof window.pick !== "function"){
    window.pick = (v)=> (typeof v === "string" ? v.trim() : (v==null ? "" : String(v).trim()));
  }
  if (typeof window.esc !== "function"){
    window.esc = (s)=>{
      const str = (s==null ? "" : String(s));
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    };
  }

  // ‚úÖ FIX: fallback STATE s√• "ensureState is not defined" aldrig kan krascha
  if (typeof window.ensureState !== "function"){
    const FV_STATE_KEY = window.FV_STATE_KEY || window.STATE_KEY || "fangvaktaren-v17::state";

    function _fv5_defaultState(){
      return {
        version: "v17",
        activeMode: "game",
        activeBank: null,
        bank: { mcq: [], img: [], drag: [] }
      };
    }

    window.ensureState = function ensureState(){
      try{
        const raw = localStorage.getItem(FV_STATE_KEY);
        if (raw){
          const obj = JSON.parse(raw);
          if (obj && typeof obj === "object"){
            if (!obj.bank || typeof obj.bank !== "object") obj.bank = { mcq: [], img: [], drag: [] };
            if (!Array.isArray(obj.bank.mcq)) obj.bank.mcq = [];
            if (!Array.isArray(obj.bank.img)) obj.bank.img = [];
            if (!Array.isArray(obj.bank.drag)) obj.bank.drag = [];
            return obj;
          }
        }
      }catch(e){}
      const s = _fv5_defaultState();
      try{ localStorage.setItem(FV_STATE_KEY, JSON.stringify(s)); }catch(e){}
      return s;
    };

    window.safeSaveState = function safeSaveState(state){
      try{
        const s = (state && typeof state === "object") ? state : window.ensureState();
        localStorage.setItem(FV_STATE_KEY, JSON.stringify(s));
        return true;
      }catch(e){
        return false;
      }
    };
  } else {
    if (typeof window.safeSaveState !== "function"){
      const FV_STATE_KEY = window.FV_STATE_KEY || window.STATE_KEY || "fangvaktaren-v17::state";
      window.safeSaveState = function safeSaveState(state){
        try{
          localStorage.setItem(FV_STATE_KEY, JSON.stringify(state));
          return true;
        }catch(e){
          return false;
        }
      };
    }
  }

  // Fallback: bankCounts + nowStamp (anv√§nds i Sektion 5H)
  if (typeof window.bankCounts !== "function"){
    window.bankCounts = function bankCounts(bank){
      const b = (bank && typeof bank === "object") ? bank : {};
      return {
        mcq: Array.isArray(b.mcq) ? b.mcq.length : 0,
        img: Array.isArray(b.img) ? b.img.length : 0,
        drag: Array.isArray(b.drag) ? b.drag.length : 0
      };
    };
  }
  if (typeof window.nowStamp !== "function"){
    window.nowStamp = function nowStamp(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
  }

  // Fallback: serverTS + getDb (om roster/cloud anropas utan att firebase-del hunnit initiera)
  if (typeof window.serverTS !== "function"){
    window.serverTS = ()=> (window.firebase && firebase.firestore && firebase.firestore.FieldValue)
      ? firebase.firestore.FieldValue.serverTimestamp()
      : null;
  }
  if (typeof window.getDb !== "function"){
    window.getDb = ()=> (window.firebaseDbInstance || (window.firebase && firebase.firestore ? firebase.firestore() : null));
  }

/* slut Sektion 5A: HELPERS (fallbacks f√∂r att undvika crash) */



/* start Sektion 5B: L√ÑRARL√ÑGE (TeacherGate + modal open/close + bind) */

  // Fallback: open/close teacher modal (anv√§nds av Exit-frontknappen)
  if (typeof window.openTeacherModal !== "function"){
    window.openTeacherModal = function openTeacherModal(){
      const modal = $("teacherModal");
      if (!modal) return;
      _fv5_show(modal);
    };
  }
  if (typeof window.closeTeacherModal !== "function"){
    window.closeTeacherModal = function closeTeacherModal(){
      const modal = $("teacherModal");
      if (!modal) return;
      _fv5_hide(modal);
    };
  }

  // ‚úÖ FIX: Dessa saknades -> crashade init
  if (typeof window.bindTeacherModeButton !== "function"){
    window.bindTeacherModeButton = function bindTeacherModeButton(){
      const btn = $("btnTeacherMode");
      const gate = $("teacherGate");
      if (!btn || !gate) return;

      if (btn.dataset.fv5Bound === "1") return;
      btn.dataset.fv5Bound = "1";

      on(btn, "click", (e)=>{
        e.preventDefault();
        _fv5_show(gate);
        const inp = $("teacherPasswordInput");
        if (inp) setTimeout(()=>inp.focus(), 0);
      });
    };
  }

  if (typeof window.bindTeacherGate !== "function"){
    window.bindTeacherGate = function bindTeacherGate(){
      const gate = $("teacherGate");
      if (!gate) return;

      if (gate.dataset.fv5Bound === "1") return;
      gate.dataset.fv5Bound = "1";

      const btnCancel  = $("btnTeacherCancel");
      const btnConfirm = $("btnTeacherConfirm");
      const inp = $("teacherPasswordInput");

      function hideGate(){
        if (inp) inp.value = "";
        _fv5_hide(gate);
      }

      if (btnCancel && btnCancel.dataset.fv5Bound !== "1"){
        btnCancel.dataset.fv5Bound = "1";
        on(btnCancel, "click", (e)=>{ e.preventDefault(); hideGate(); });
      }

      if (btnConfirm && btnConfirm.dataset.fv5Bound !== "1"){
        btnConfirm.dataset.fv5Bound = "1";
        on(btnConfirm, "click", (e)=>{
          e.preventDefault();

          // Om din kodbas har riktig gate/login-logik i annan funktion, anv√§nd den.
          // Annars: √∂ppna modal direkt, s√• sidan aldrig "l√•ser sig".
          hideGate();
          if (typeof window.openTeacherModal === "function") window.openTeacherModal();
          if (typeof window._fv5_setActiveTab === "function") window._fv5_setActiveTab("settings");
        });
      }

      // klick utanf√∂r gate-stycket st√§nger gate (om backdrop)
      on(gate, "click", (e)=>{
        if (e.target === gate){
          if (inp) inp.value = "";
          _fv5_hide(gate);
        }
      });
    };
  }

  function bindTeacherModalClose(){
    const modal = $("teacherModal");
    if (!modal) return;

    const btnClose = $("btnCloseTeacher");
    if (btnClose && btnClose.dataset.fv5Bound !== "1"){
      btnClose.dataset.fv5Bound = "1";
      on(btnClose, "click", (e)=>{ e.preventDefault(); window.closeTeacherModal(); });
    }

    if (modal.dataset.fv5Bound !== "1"){
      modal.dataset.fv5Bound = "1";
      on(modal, "click", (e)=>{
        if (e.target === modal) window.closeTeacherModal();
      });
    }
  }

  // L√∂senordsbyte (robust: capture, stoppar andra handlers)
  function bindTeacherPasswordChange(){
    const btn = $("btnChangeTeacherPassword");
    const oldPw = $("inputOldPassword");
    const newPw = $("inputNewPassword");
    const repPw = $("inputNewPasswordRepeat");

    if (!btn || !oldPw || !newPw) return;
    if (btn.dataset.fv5PwBound === "1") return;
    btn.dataset.fv5PwBound = "1";

    // init status (om din kodbas har funktionen)
    if (typeof window.updateTeacherPasswordStatus === "function"){
      try{ window.updateTeacherPasswordStatus(); }catch(e){}
    }

    btn.addEventListener("click", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      if (typeof e.stopImmediatePropagation === "function") e.stopImmediatePropagation();

      if (typeof window.updateTeacherPasswordStatus !== "function" ||
          typeof window.pick !== "function" ||
          typeof window.applyPasswordToGate !== "function" ||
          typeof window.TEACHER_PW_KEY === "undefined"){
        alert("L√∂senordsbyte: saknar en eller flera beroenden (updateTeacherPasswordStatus/pick/applyPasswordToGate/TEACHER_PW_KEY).");
        return;
      }

      const current = window.updateTeacherPasswordStatus();
      const oldVal = window.pick(oldPw.value);
      const newVal = window.pick(newPw.value);
      const repVal = repPw ? window.pick(repPw.value) : "";

      if (!newVal){
        alert("Skriv ett nytt l√∂senord f√∂rst.");
        newPw.focus();
        return;
      }
      if (repPw && repVal !== newVal){
        alert("Nytt l√∂senord matchar inte i 'Upprepa nytt l√∂senord'.");
        repPw.focus();
        return;
      }
      if (oldVal !== current){
        alert("Fel nuvarande l√∂senord.");
        oldPw.focus();
        return;
      }

      localStorage.setItem(window.TEACHER_PW_KEY, newVal);
      window.applyPasswordToGate(newVal);

      oldPw.value = "";
      newPw.value = "";
      if (repPw) repPw.value = "";

      window.updateTeacherPasswordStatus();
      alert("Nytt l√∂senord sparat.");
    }, true);
  }
/* slut Sektion 5B: L√ÑRARL√ÑGE (TeacherGate + modal open/close + bind) */


/* start Sektion 5C: TABS (visa panel + exit-l√§ge) */
  function setActiveTab(tabName){
    const btns = qsa(".tab-btn");
    const panels = qsa(".tab-panel");

    btns.forEach(b=>{
      const t = b.getAttribute("data-tab");
      if (t === tabName) b.classList.add("active");
      else b.classList.remove("active");
    });

    panels.forEach(p=>{
      const pn = p.getAttribute("data-panel");
      if (pn === tabName) p.classList.remove("hidden");
      else p.classList.add("hidden");
    });

    if (typeof window.ensureState === "function" && typeof window.safeSaveState === "function"){
      const s = window.ensureState();
      if (tabName === "exit") s.activeMode = "exit";
      else if (s.activeMode === "exit") s.activeMode = "game";
      window.safeSaveState(s);
    }

    if (tabName === "questions" || tabName === "images" || tabName === "dragdrop" || tabName === "exit"){
      if (typeof window._fv5_renderAllQuestionLists === "function") window._fv5_renderAllQuestionLists();
    }
    if (typeof window.updateBankStatusUI === "function") window.updateBankStatusUI();
  }

  function bindTabs(){
    const nav = qsa(".tab-nav")[0] || null;
    if (!nav) return;
    if (nav.dataset.fv5Bound === "1") return;
    nav.dataset.fv5Bound = "1";

    on(nav, "click", (e)=>{
      const btn = e.target.closest(".tab-btn");
      if (!btn) return;
      e.preventDefault();
      const tab = btn.getAttribute("data-tab");
      if (!tab) return;
      setActiveTab(tab);
    });
  }

  window._fv5_setActiveTab = setActiveTab;
/* slut Sektion 5C: TABS (visa panel + exit-l√§ge) */


/* start Sektion 5D: EXIT (ELEV-VY + L√ÑMNA IN) */
  function _fv5_pickStr(v){
    if (typeof window.pick === "function") return window.pick(v);
    return String(v||"").trim();
  }

  function _fv5_getTeacherEmail(){
    // 1) Om kodbasen har en explicit key
    const key = (typeof window.TEACHER_EMAIL_KEY !== "undefined" && window.TEACHER_EMAIL_KEY) ? String(window.TEACHER_EMAIL_KEY) : "fangvaktaren-v17::teacherEmail";

    // 2) localStorage
    let ls = "";
    try{ ls = _fv5_pickStr(localStorage.getItem(key)); }catch(e){}
    if (ls) return ls;

    // 3) Om input finns i DOM (l√§rarfliken)
    const inp = $("inputTeacherEmail");
    const v = _fv5_pickStr(inp ? inp.value : "");
    if (v) return v;

    return "";
  }

  function _fv5_readExitAnswer(root, name){
    if (!root) return "";
    const el = root.querySelector(`input[type="radio"][name="${name}"]:checked`);
    return _fv5_pickStr(el ? el.value : "");
  }

  function _fv5_buildStudentExitOverlay(){
    // om redan finns
    let overlay = $("studentExitTicketOverlay");
    if (overlay) return overlay;

    overlay = document.createElement("div");
    overlay.id = "studentExitTicketOverlay";
    overlay.className = "modal-backdrop hidden";
    overlay.style.display = "none";

    const modal = document.createElement("div");
    modal.className = "modal";
    modal.style.maxWidth = "820px";

    const header = document.createElement("header");
    header.className = "modal-header";
    header.innerHTML = `
      <div>
        <h2>üìù Exit ticket</h2>
        <small>Fyll i och l√§mna in innan du g√•r.</small>
      </div>
      <button id="btnCloseStudentExit" class="btn btn-sm" type="button">St√§ng</button>
    `;

    const body = document.createElement("div");
    body.className = "modal-body";
    body.style.paddingTop = "10px";

    const inner = document.createElement("div");
    inner.id = "studentExitTicketInner";
    inner.style.width = "100%";

    // f√∂rs√∂k klona l√§rar-exitpanelen (utan l√§rarknappar)
    const teacherExitPanel = document.querySelector('.tab-panel[data-panel="exit"]');
    if (teacherExitPanel){
      const clone = teacherExitPanel.cloneNode(true);
      clone.classList.remove("hidden");
      clone.style.display = "block";
      // ta bort ev. ‚Äústandardmall‚Äù-notis l√§ngst ner om den finns
      const minis = Array.from(clone.querySelectorAll("p.mini"));
      minis.forEach(p=>{
        const t = (p.textContent||"").toLowerCase();
        if (t.includes("standardmall") || t.includes("n√§sta steg")){
          p.remove();
        }
      });
      inner.appendChild(clone);
    } else {
      // fallback: minimal elevform om panel saknas
      inner.innerHTML = `
        <div class="card">
          <h3>Exit ticket (lektion)</h3>
          <p class="mini">Exit ticket-panelen hittades inte i l√§rarl√§get. Kontakta l√§raren.</p>
        </div>
      `;
    }

    // submit-rad
    const actions = document.createElement("div");
    actions.className = "card-row";
    actions.style.marginTop = "12px";
    actions.style.justifyContent = "space-between";
    actions.style.gap = "10px";
    actions.style.flexWrap = "wrap";
    actions.innerHTML = `
      <button id="btnStudentExitBack" class="btn btn-sm" type="button">‚¨ÖÔ∏è Tillbaka</button>
      <button id="btnStudentExitSubmit" class="btn btn-sm btn-primary" type="button">‚úÖ L√§mna in Exit ticket</button>
    `;

    body.appendChild(inner);
    body.appendChild(actions);

    modal.appendChild(header);
    modal.appendChild(body);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // close handlers
    const btnClose = $("btnCloseStudentExit");
    const btnBack = $("btnStudentExitBack");
    if (btnClose) on(btnClose, "click", (e)=>{ e.preventDefault(); _fv5_hide(overlay); });
    if (btnBack) on(btnBack, "click", (e)=>{ e.preventDefault(); _fv5_hide(overlay); });

    // klick p√• backdrop st√§nger
    on(overlay, "click", (e)=>{
      if (e.target === overlay) _fv5_hide(overlay);
    });

    return overlay;
  }

  function _fv5_openStudentExit(){
    const overlay = _fv5_buildStudentExitOverlay();
    _fv5_show(overlay);

    // scroll top
    const inner = $("studentExitTicketInner");
    if (inner) inner.scrollIntoView({ block:"start", behavior:"instant" });
  }

  function _fv5_collectStudentExitPayload(){
    const overlay = $("studentExitTicketOverlay");
    const innerWrap = $("studentExitTicketInner") || overlay;

    // elevinfo
    const name = _fv5_pickStr($("studentName") ? $("studentName").value : "");
    const klass = _fv5_pickStr($("studentClass") ? $("studentClass").value : "");

    // svar
    const q1 = _fv5_readExitAnswer(innerWrap, "exit_q1");
    const q2 = _fv5_readExitAnswer(innerWrap, "exit_q2");
    const q3 = _fv5_readExitAnswer(innerWrap, "exit_q3");
    const q4 = _fv5_readExitAnswer(innerWrap, "exit_q4");
    const q5 = _fv5_readExitAnswer(innerWrap, "exit_q5");
    const q6 = _fv5_readExitAnswer(innerWrap, "exit_q6");
    const q7 = _fv5_readExitAnswer(innerWrap, "exit_q7");
    const q8 = _fv5_readExitAnswer(innerWrap, "exit_q8");

    const ta9 = (innerWrap && innerWrap.querySelector("#exit_q9")) ? innerWrap.querySelector("#exit_q9") : null;
    const ta10 = (innerWrap && innerWrap.querySelector("#exit_q10")) ? innerWrap.querySelector("#exit_q10") : null;

    const q9 = _fv5_pickStr(ta9 ? ta9.value : "");
    const q10 = _fv5_pickStr(ta10 ? ta10.value : "");

    const ts = new Date();
    const stamp = ts.toLocaleString();

    return {
      name, klass, stamp,
      answers: { q1,q2,q3,q4,q5,q6,q7,q8,q9,q10 }
    };
  }

  function _fv5_sendStudentExitMail(){
    const teacherEmail = _fv5_getTeacherEmail();
    if (!teacherEmail){
      alert("Saknar l√§rarens e-post. Be l√§raren fylla i den i l√§rarl√§get (Inst√§llningar ‚Üí L√§rarens e-post).");
      return;
    }

    const payload = _fv5_collectStudentExitPayload();
    const nameLine = payload.name ? payload.name : "(ok√§nt namn)";
    const klassLine = payload.klass ? payload.klass : "(ok√§nd klass)";

    const subject = `Exit ticket ‚Äì ${nameLine} (${klassLine})`;
    const a = payload.answers;

    const body =
`EXIT TICKET
Tid: ${payload.stamp}
Elev: ${nameLine}
Klass: ${klassLine}

Skala 1‚Äì5
1) F√∂rstod vad vi skulle g√∂ra: ${a.q1 || "-"}
2) H√∂ll fokus: ${a.q2 || "-"}
3) Jobbade sj√§lvst√§ndigt med st√∂d: ${a.q3 || "-"}
4) Samarbetade / arbetade lugnt: ${a.q4 || "-"}
5) K√§nde mig trygg: ${a.q5 || "-"}

Ja/Nej
6) Fick hj√§lp jag beh√∂vde: ${a.q6 || "-"}
7) Hann klart: ${a.q7 || "-"}
8) Beh√∂ver √∂va mer: ${a.q8 || "-"}

Kort svar
9) Vad gick b√§st: ${a.q9 || "-"}
10) Vad vill du ha hj√§lp med: ${a.q10 || "-"}

(Automatiskt skickat fr√•n F√•ngvaktaren)`;

    const href = `mailto:${encodeURIComponent(teacherEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = href;
  }

  function bindStudentExitSubmit(){
    const btn = $("btnStudentExitSubmit");
    if (!btn) return;
    if (btn.dataset.fv5Bound === "1") return;
    btn.dataset.fv5Bound = "1";

    on(btn, "click", (e)=>{
      e.preventDefault();
      _fv5_sendStudentExitMail();
    });
  }

  function bindExitTicketFrontButton(){
    const btn = $("btnExitTicketFront");
    if (!btn) return;
    if (btn.dataset.fv5Bound === "1") return;
    btn.dataset.fv5Bound = "1";

    on(btn, "click", (e)=>{
      e.preventDefault();
      // ‚úÖ ELEV-VY: √∂ppna ren exit ticket-sida (ingen l√§rarmodal, inga inst√§llningar)
      _fv5_openStudentExit();
      // bind submit n√§r overlay finns
      setTimeout(()=>bindStudentExitSubmit(), 0);
    });
  }
  window.bindExitTicketFrontButton = bindExitTicketFrontButton;
/* slut Sektion 5D: EXIT (ELEV-VY + L√ÑMNA IN) */


/* start Sektion 5E: RENDER ‚Äì MCQ/IMG/DRAG (listor + delete) */
  function renderMcqList(){
    const list = $("mcqList");
    const count = $("mcqCount");
    if (!list) return;

    const s = ensureState();
    const arr = s.bank.mcq || [];
    if (count) count.textContent = String(arr.length);

    list.innerHTML = "";
    if (!arr.length){
      list.innerHTML = `<li class="mini">Inga flervalsfr√•gor √§nnu.</li>`;
      return;
    }

    arr.forEach((q, idx)=>{
      const opts = Array.isArray(q.options) ? q.options : [];
      const a = Number.isFinite(q.answer) ? q.answer : null;

      const li = document.createElement("li");
      li.className = "question-item";
      li.style.display = "flex";
      li.style.gap = "10px";
      li.style.alignItems = "flex-start";
      li.style.justifyContent = "space-between";

      const left = document.createElement("div");
      left.style.flex = "1 1 auto";

      const title = document.createElement("div");
      title.className = "mini";
      title.innerHTML = `<strong>${esc(q.level||"?")}</strong> ‚Ä¢ ${esc(q.q||"")}`;
      left.appendChild(title);

      const ul = document.createElement("ul");
      ul.className = "mini";
      ul.style.margin = "6px 0 0";
      ul.style.paddingLeft = "18px";
      opts.forEach((o, i)=>{
        const liOpt = document.createElement("li");
        const isCorrect = (a !== null && i === a);
        liOpt.innerHTML = isCorrect ? `<strong>‚úÖ ${esc(o)}</strong>` : esc(o);
        ul.appendChild(liOpt);
      });
      left.appendChild(ul);

      const right = document.createElement("div");
      right.style.flex = "0 0 auto";
      right.style.display = "flex";
      right.style.gap = "6px";
      right.style.alignItems = "center";

      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.className = "btn btn-sm btn-danger";
      btnDel.textContent = "üóëÔ∏è";
      btnDel.title = "Ta bort fr√•ga";
      btnDel.dataset.kind = "mcq";
      btnDel.dataset.idx = String(idx);
      right.appendChild(btnDel);

      li.appendChild(left);
      li.appendChild(right);
      list.appendChild(li);
    });
  }

  function pickImgSrc(q){
    if (!q) return "";
    const cands = [q.image,q.img,q.dataUrl,q.dataURL,q.src,q.url];
    for (const c of cands){
      if (typeof c === "string" && c.trim()) return c.trim();
    }
    return "";
  }

  function renderImgList(){
    const list = $("imgList");
    const count = $("imgCount");
    if (!list) return;

    const s = ensureState();
    const arr = s.bank.img || [];
    if (count) count.textContent = String(arr.length);

    list.innerHTML = "";
    if (!arr.length){
      list.innerHTML = `<li class="mini">Inga bildfr√•gor √§nnu.</li>`;
      return;
    }

    arr.forEach((q, idx)=>{
      const src = pickImgSrc(q);
      const opts = Array.isArray(q.options) ? q.options : [];
      const a = Number.isFinite(q.answer) ? q.answer : null;

      const li = document.createElement("li");
      li.className = "question-item";
      li.style.display = "flex";
      li.style.gap = "10px";
      li.style.alignItems = "flex-start";
      li.style.justifyContent = "space-between";

      const leftWrap = document.createElement("div");
      leftWrap.style.display = "flex";
      leftWrap.style.gap = "10px";
      leftWrap.style.flex = "1 1 auto";

      const thumb = document.createElement("div");
      thumb.style.flex = "0 0 64px";
      thumb.style.width = "64px";
      thumb.style.height = "64px";
      thumb.style.borderRadius = "8px";
      thumb.style.overflow = "hidden";
      thumb.style.border = "1px solid var(--border)";
      thumb.style.background = "rgba(255,255,255,0.04)";
      thumb.style.display = "flex";
      thumb.style.alignItems = "center";
      thumb.style.justifyContent = "center";

      if (src){
        const img = document.createElement("img");
        img.src = src;
        img.alt = "Bildfr√•ga";
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "cover";
        thumb.appendChild(img);
      } else {
        thumb.innerHTML = `<span class="mini">üñºÔ∏è</span>`;
      }

      const text = document.createElement("div");
      text.style.flex = "1 1 auto";

      const title = document.createElement("div");
      title.className = "mini";
      title.innerHTML = `<strong>${esc(q.level||"?")}</strong> ‚Ä¢ ${esc(q.q||"")}`;
      text.appendChild(title);

      const ul = document.createElement("ul");
      ul.className = "mini";
      ul.style.margin = "6px 0 0";
      ul.style.paddingLeft = "18px";
      opts.forEach((o, i)=>{
        const liOpt = document.createElement("li");
        const isCorrect = (a !== null && i === a);
        liOpt.innerHTML = isCorrect ? `<strong>‚úÖ ${esc(o)}</strong>` : esc(o);
        ul.appendChild(liOpt);
      });
      text.appendChild(ul);

      leftWrap.appendChild(thumb);
      leftWrap.appendChild(text);

      const right = document.createElement("div");
      right.style.flex = "0 0 auto";
      right.style.display = "flex";
      right.style.gap = "6px";
      right.style.alignItems = "center";

      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.className = "btn btn-sm btn-danger";
      btnDel.textContent = "üóëÔ∏è";
      btnDel.title = "Ta bort fr√•ga";
      btnDel.dataset.kind = "img";
      btnDel.dataset.idx = String(idx);
      right.appendChild(btnDel);

      li.appendChild(leftWrap);
      li.appendChild(right);
      list.appendChild(li);
    });
  }

  function inferDragItemCorrect(item){
    if (!item || typeof item!=="object") return null;
    if (Number.isFinite(item.correct)) return item.correct;
    if (Number.isFinite(item.correctColumn)) return item.correctColumn;
    if (Number.isFinite(item.col)) return item.col;
    if (Number.isFinite(item.column)) return item.column;
    if (Number.isFinite(item.target)) return item.target;
    if (typeof item.correctIndex === "number") return item.correctIndex;
    if (typeof item.correct === "string") return item.correct;
    if (typeof item.correctColumn === "string") return item.correctColumn;
    if (typeof item.colName === "string") return item.colName;
    return null;
  }

  function renderDragList(){
    const list = $("dragList");
    const count = $("dragCount");
    if (!list) return;

    const s = ensureState();
    const arr = s.bank.drag || [];
    if (count) count.textContent = String(arr.length);

    list.innerHTML = "";
    if (!arr.length){
      list.innerHTML = `<li class="mini">Inga drag & drop-fr√•gor √§nnu.</li>`;
      return;
    }

    arr.forEach((q, idx)=>{
      const cols = Array.isArray(q.columns) ? q.columns : [];
      const items = Array.isArray(q.items) ? q.items : [];

      const li = document.createElement("li");
      li.className = "question-item";
      li.style.display = "flex";
      li.style.gap = "10px";
      li.style.alignItems = "flex-start";
      li.style.justifyContent = "space-between";

      const left = document.createElement("div");
      left.style.flex = "1 1 auto";

      const title = document.createElement("div");
      title.className = "mini";
      title.innerHTML = `<strong>${esc(q.level||"?")}</strong> ‚Ä¢ ${esc(q.q||"")}`;
      left.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "mini";
      meta.style.marginTop = "6px";
      meta.innerHTML = `<strong>Kolumner:</strong> ${esc(cols[0]||"Kolumn 1")} / ${esc(cols[1]||"Kolumn 2")}`;
      left.appendChild(meta);

      const ul = document.createElement("ul");
      ul.className = "mini";
      ul.style.margin = "6px 0 0";
      ul.style.paddingLeft = "18px";
      items.forEach((it)=>{
        const txt = (it && (it.text || it.label || it.value || it.item || it.name)) || "";
        const corr = inferDragItemCorrect(it);
        const corrTxt = (corr === 0 || corr === 1) ? (corr === 0 ? (cols[0]||"Kolumn 1") : (cols[1]||"Kolumn 2")) : String(corr ?? "?");
        const liIt = document.createElement("li");
        liIt.innerHTML = `<strong>${esc(txt)}</strong> ‚Üí ‚úÖ ${esc(corrTxt)}`;
        ul.appendChild(liIt);
      });
      left.appendChild(ul);

      const right = document.createElement("div");
      right.style.flex = "0 0 auto";
      right.style.display = "flex";
      right.style.gap = "6px";
      right.style.alignItems = "center";

      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.className = "btn btn-sm btn-danger";
      btnDel.textContent = "üóëÔ∏è";
      btnDel.title = "Ta bort fr√•ga";
      btnDel.dataset.kind = "drag";
      btnDel.dataset.idx = String(idx);
      right.appendChild(btnDel);

      li.appendChild(left);
      li.appendChild(right);
      list.appendChild(li);
    });
  }

  function bindDeleteInLists(){
    const root = $("teacherModal") || document;
    if (root.dataset.fv5DelBound === "1") return;
    root.dataset.fv5DelBound = "1";

    on(root, "click", (e)=>{
      const btn = e.target.closest("button[data-kind][data-idx]");
      if (!btn) return;
      const kind = btn.dataset.kind;
      const idx = parseInt(btn.dataset.idx, 10);
      if (!Number.isFinite(idx)) return;

      const s = ensureState();
      if (kind === "mcq") s.bank.mcq.splice(idx, 1);
      if (kind === "img") s.bank.img.splice(idx, 1);
      if (kind === "drag") s.bank.drag.splice(idx, 1);
      safeSaveState(s);

      if (typeof window._fv5_renderAllQuestionLists === "function") window._fv5_renderAllQuestionLists();
      if (typeof window.updateBankStatusUI === "function") window.updateBankStatusUI();
    });
  }

  function _fv5_renderAllQuestionLists(){
    renderMcqList();
    renderImgList();
    renderDragList();
  }
  window._fv5_renderAllQuestionLists = _fv5_renderAllQuestionLists;
  window.renderMcqList = renderMcqList;
  window.renderImgList = renderImgList;
  window.renderDragList = renderDragList;
/* slut Sektion 5E: RENDER ‚Äì MCQ/IMG/DRAG (listor + delete) */


/* start Sektion 5F: FORMS - MCQ/IMG/DRAG (Lagg till fungerar) */
function initQuestionForms(){

  function _fv5_el(id){
    try{ return (typeof window.$ === "function") ? window.$(id) : document.getElementById(id); }catch(e){}
    return document.getElementById(id);
  }
  function _fv5_val(id, def){
    const el = _fv5_el(id);
    const v = el && typeof el.value !== "undefined" ? String(el.value) : "";
    const t = v.trim();
    return t ? t : (def || "");
  }
  function _fv5_set(id, v){
    const el = _fv5_el(id);
    if (!el) return;
    el.value = (typeof v === "undefined" || v === null) ? "" : String(v);
  }
  function _fv5_clearRadios(name){
    try{
      const arr = (typeof window.qsa === "function") ? window.qsa(`input[name='${name}']`) : Array.from(document.querySelectorAll(`input[name='${name}']`));
      for (let i=0;i<arr.length;i++) arr[i].checked = false;
    }catch(e){}
  }
  function _fv5_getCheckedIndex(name){
    try{
      const arr = (typeof window.qsa === "function") ? window.qsa(`input[name='${name}']`) : Array.from(document.querySelectorAll(`input[name='${name}']`));
      for (let i=0;i<arr.length;i++){
        if (arr[i] && arr[i].checked){
          const n = parseInt(arr[i].value, 10);
          return Number.isFinite(n) ? n : null;
        }
      }
    }catch(e){}
    return null;
  }
  function _fv5_bindOnce(el){
    if (!el) return false;
    if (el.dataset && el.dataset.fv5Bound === "1") return false;
    if (el.dataset) el.dataset.fv5Bound = "1";
    return true;
  }

  // ----- MCQ -----
  const btnMcqAdd = _fv5_el("btnMcqAdd");
  if (_fv5_bindOnce(btnMcqAdd)){
    on(btnMcqAdd, "click", (e)=>{
      e.preventDefault();
      const s = ensureState();

      const level = _fv5_val("mcqLevel", "E");
      const qText = _fv5_val("mcqQuestion", "");
      const o0 = _fv5_val("mcqOption0", "");
      const o1 = _fv5_val("mcqOption1", "");
      const o2 = _fv5_val("mcqOption2", "");
      const o3 = _fv5_val("mcqOption3", "");

      let ans = _fv5_getCheckedIndex("mcqCorrect");
      if (!Number.isFinite(ans)){
        const v = parseInt(_fv5_val("mcqAnswer", "0"), 10);
        ans = Number.isFinite(v) ? v : 0;
      }

      if (!qText || !o0 || !o1 || !o2 || !o3){
        alert("Fyll i fragetext + alla 4 svarsalternativ.");
        return;
      }

      if (!s.bank) s.bank = { mcq:[], img:[], drag:[] };
      if (!Array.isArray(s.bank.mcq)) s.bank.mcq = [];
      s.bank.mcq.push({ level: level, type:"mcq", q:qText, options:[o0,o1,o2,o3], answer: ans });

      safeSaveState(s);
      _fv5_renderAllQuestionLists();
      if (typeof window.updateBankStatusUI === "function") window.updateBankStatusUI();

      _fv5_set("mcqQuestion", "");
      _fv5_set("mcqOption0", "");
      _fv5_set("mcqOption1", "");
      _fv5_set("mcqOption2", "");
      _fv5_set("mcqOption3", "");
      _fv5_set("mcqAnswer", "");
      _fv5_clearRadios("mcqCorrect");
    });
  }

  const btnMcqClear = _fv5_el("btnMcqClear");
  if (_fv5_bindOnce(btnMcqClear)){
    on(btnMcqClear, "click", (e)=>{
      e.preventDefault();
      _fv5_set("mcqQuestion", "");
      _fv5_set("mcqOption0", "");
      _fv5_set("mcqOption1", "");
      _fv5_set("mcqOption2", "");
      _fv5_set("mcqOption3", "");
      _fv5_set("mcqAnswer", "");
      _fv5_clearRadios("mcqCorrect");
    });
  }

  // ----- IMG -----
  const imgFile = _fv5_el("imgFile");
  const imgPreview = _fv5_el("imgPreview");
  let pendingImgDataUrl = "";

  if (imgFile && _fv5_bindOnce(imgFile)){
    on(imgFile, "change", ()=>{
      const f = (imgFile.files && imgFile.files[0]) ? imgFile.files[0] : null;
      pendingImgDataUrl = "";
      if (!f){
        if (imgPreview) imgPreview.textContent = "Ingen bild vald annu.";
        return;
      }
      const fr = new FileReader();
      fr.onload = ()=>{
        pendingImgDataUrl = String(fr.result || "");
        if (imgPreview){
          imgPreview.innerHTML = "";
          const im = document.createElement("img");
          im.src = pendingImgDataUrl;
          im.alt = "Forhandsvisning";
          im.style.maxWidth = "140px";
          im.style.maxHeight = "120px";
          im.style.borderRadius = "8px";
          im.style.display = "block";
          imgPreview.appendChild(im);
        }
      };
      fr.readAsDataURL(f);
    });
  }

  const btnImgAdd = _fv5_el("btnImgAdd");
  if (_fv5_bindOnce(btnImgAdd)){
    on(btnImgAdd, "click", (e)=>{
      e.preventDefault();
      const s = ensureState();

      const level = _fv5_val("imgLevel", "E");
      const qText = _fv5_val("imgQuestion", "");
      const o0 = _fv5_val("imgOption0", "");
      const o1 = _fv5_val("imgOption1", "");
      const o2 = _fv5_val("imgOption2", "");
      const o3 = _fv5_val("imgOption3", "");

      let ans = _fv5_getCheckedIndex("imgCorrect");
      if (!Number.isFinite(ans)){
        const v = parseInt(_fv5_val("imgAnswer", "0"), 10);
        ans = Number.isFinite(v) ? v : 0;
      }

      if (!qText || !o0 || !o1 || !o2 || !o3){
        alert("Fyll i fragetext + alla 4 svarsalternativ.");
        return;
      }
      if (!pendingImgDataUrl){
        alert("Valj en bildfil forst (sa den kan sparas i fragan).");
        return;
      }

      if (!s.bank) s.bank = { mcq:[], img:[], drag:[] };
      if (!Array.isArray(s.bank.img)) s.bank.img = [];
      s.bank.img.push({ level: level, type:"img", q:qText, image: pendingImgDataUrl, options:[o0,o1,o2,o3], answer: ans });

      safeSaveState(s);
      _fv5_renderAllQuestionLists();
      if (typeof window.updateBankStatusUI === "function") window.updateBankStatusUI();

      _fv5_set("imgQuestion", "");
      _fv5_set("imgOption0", "");
      _fv5_set("imgOption1", "");
      _fv5_set("imgOption2", "");
      _fv5_set("imgOption3", "");
      _fv5_set("imgAnswer", "");
      _fv5_clearRadios("imgCorrect");
      if (imgFile) imgFile.value = "";
      pendingImgDataUrl = "";
      if (imgPreview) imgPreview.textContent = "Ingen bild vald annu.";
    });
  }

  const btnImgClear = _fv5_el("btnImgClear");
  if (_fv5_bindOnce(btnImgClear)){
    on(btnImgClear, "click", (e)=>{
      e.preventDefault();
      _fv5_set("imgQuestion", "");
      _fv5_set("imgOption0", "");
      _fv5_set("imgOption1", "");
      _fv5_set("imgOption2", "");
      _fv5_set("imgOption3", "");
      _fv5_set("imgAnswer", "");
      _fv5_clearRadios("imgCorrect");
      if (imgFile) imgFile.value = "";
      pendingImgDataUrl = "";
      if (imgPreview) imgPreview.textContent = "Ingen bild vald annu.";
    });
  }

  // ----- DRAG -----
  const dragItemsPreview = _fv5_el("dragItemsPreview");
  let pendingDragItems = [];

  function renderPendingDragItems(){
    if (!dragItemsPreview) return;
    dragItemsPreview.innerHTML = "";
    if (!pendingDragItems.length){
      dragItemsPreview.innerHTML = '<li class="mini">Inga objekt tillagda annu.</li>';
      return;
    }
    for (let i=0;i<pendingDragItems.length;i++){
      const it = pendingDragItems[i];
      const li = document.createElement("li");
      li.className = "mini";
      li.textContent = String(it.text || "") + " -> Kolumn " + String((it.correct||0) + 1);
      dragItemsPreview.appendChild(li);
    }
  }

  const btnDragAddItem = _fv5_el("btnDragAddItem");
  if (_fv5_bindOnce(btnDragAddItem)){
    on(btnDragAddItem, "click", (e)=>{
      e.preventDefault();
      const t = _fv5_val("dragItemText", "");
      const c = parseInt(_fv5_val("dragItemCorrect", "0"), 10);
      if (!t) return alert("Skriv ett objekt att dra.");
      pendingDragItems.push({ text: t, correct: (c === 1 ? 1 : 0) });
      _fv5_set("dragItemText", "");
      renderPendingDragItems();
    });
  }

  const btnDragAddQuestion = _fv5_el("btnDragAddQuestion");
  if (_fv5_bindOnce(btnDragAddQuestion)){
    on(btnDragAddQuestion, "click", (e)=>{
      e.preventDefault();
      const s = ensureState();

      const level = _fv5_val("dragLevel", "E");
      const qText = _fv5_val("dragQuestion", "");
      const c1 = _fv5_val("dragColumn1", "");
      const c2 = _fv5_val("dragColumn2", "");

      if (!qText || !c1 || !c2) return alert("Fyll i instruktion + bada kolumner.");
      if (!pendingDragItems.length) return alert("Lagg till minst ett objekt att dra.");

      if (!s.bank) s.bank = { mcq:[], img:[], drag:[] };
      if (!Array.isArray(s.bank.drag)) s.bank.drag = [];
      s.bank.drag.push({ level: level, type:"drag", q:qText, columns:[c1,c2], items: pendingDragItems.slice() });

      safeSaveState(s);
      _fv5_renderAllQuestionLists();
      if (typeof window.updateBankStatusUI === "function") window.updateBankStatusUI();

      _fv5_set("dragQuestion", "");
      _fv5_set("dragColumn1", "");
      _fv5_set("dragColumn2", "");
      _fv5_set("dragItemText", "");
      pendingDragItems = [];
      renderPendingDragItems();
    });
  }

  const btnDragClearForm = _fv5_el("btnDragClearForm");
  if (_fv5_bindOnce(btnDragClearForm)){
    on(btnDragClearForm, "click", (e)=>{
      e.preventDefault();
      _fv5_set("dragQuestion", "");
      _fv5_set("dragColumn1", "");
      _fv5_set("dragColumn2", "");
      _fv5_set("dragItemText", "");
      pendingDragItems = [];
      renderPendingDragItems();
    });
  }

  renderPendingDragItems();
}

window.initQuestionForms = initQuestionForms;
/* slut Sektion 5F: FORMS - MCQ/IMG/DRAG (Lagg till fungerar) */


/* =========================================================
   Sektion 5G: ROSTER (SPARFIX v2 ‚Äì bindar R√ÑTT knappar/host + l√•ser INTE UI)
   ========================================================= */

(function(){
  "use strict";

  // --------- tiny helpers ----------
  function _pick(v){
    try{ if (typeof window.pick === "function") return window.pick(v); }catch(e){}
    return String(v ?? "").trim();
  }
  function _byId(id){
    try{ if (typeof window.$ === "function") return window.$(id); }catch(e){}
    return document.getElementById(id);
  }
  function _qsa(sel, root){
    return Array.from((root||document).querySelectorAll(sel));
  }
  function _firstId(ids){
    for (let i=0;i<ids.length;i++){
      const el = _byId(ids[i]);
      if (el) return el;
    }
    return null;
  }
  function _getUid(){
    try{
      const u = window.currentTeacherUser;
      return _pick(u && u.uid ? u.uid : "");
    }catch(e){ return ""; }
  }
  function _getDb(){
    try{ if (window.firebaseDbInstance) return window.firebaseDbInstance; }catch(e){}
    try{
      if (window.firebase && typeof window.firebase.firestore === "function") return window.firebase.firestore();
    }catch(e){}
    return null;
  }
  function _serverTS(){
    try{ return window.firebase?.firestore?.FieldValue?.serverTimestamp?.(); }catch(e){}
    return null;
  }

  // --------- token fallback ----------
  if (typeof window._fv_genToken !== "function" && typeof window.genToken !== "function"){
    window.genToken = function genToken(len=10){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789";
      let out = "";
      const n = Math.max(6, Math.min(40, Number(len)||10));
      for (let i=0;i<n;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    };
  }
  function _makeToken(){
    try{ if (typeof window._fv_genToken === "function") return window._fv_genToken(10); }catch(e){}
    try{ if (typeof window.genToken === "function") return window.genToken(10); }catch(e){}
    return "TOK" + Math.random().toString(36).slice(2,10).toUpperCase();
  }

  // --------- invite link (prefer publicId, fallback bankId) ----------
  function _inviteLink(publicId, bankId, token){
    const pid = _pick(publicId);
    const bid = _pick(bankId);
    const t = _pick(token);
    const base = (location.origin + location.pathname);
    if (pid && t) return `${base}?public=${encodeURIComponent(pid)}&token=${encodeURIComponent(t)}`;
    if (bid && t) return `${base}?public=${encodeURIComponent(bid)}&token=${encodeURIComponent(t)}`;
    if (t) return `${base}?token=${encodeURIComponent(t)}`;
    return base;
  }
  function _openMailTo(studentEmail, subject, body){
    const to = encodeURIComponent(studentEmail || "");
    const sub = encodeURIComponent(subject || "");
    const bod = encodeURIComponent(body || "");
    window.location.href = `mailto:${to}?subject=${sub}&body=${bod}`;
  }

  // --------- roster "mail sent" local map ----------
  function _mailSentKey(bankId){
    const id = _pick(bankId) || "no-bank";
    return `fangvaktaren-v17::rosterMailSent::${id}`;
  }
  function _getMailSentMap(bankId){
    try{
      const raw = localStorage.getItem(_mailSentKey(bankId));
      const obj = raw ? JSON.parse(raw) : {};
      return (obj && typeof obj === "object") ? obj : {};
    }catch(e){ return {}; }
  }
  function _setMailSent(bankId, token, isSent){
    const t = _pick(token);
    if (!t) return;
    const map = _getMailSentMap(bankId);
    if (isSent) map[t] = 1;
    else delete map[t];
    try{ localStorage.setItem(_mailSentKey(bankId), JSON.stringify(map)); }catch(e){}
  }
  function _markMailBtn(btn, isSent){
    if (!btn) return;
    btn.dataset.mailSent = isSent ? "1" : "0";
    if (isSent){
      btn.style.background = "#16a34a";
      btn.style.borderColor = "#16a34a";
      btn.style.color = "#ffffff";
      btn.textContent = "‚úâÔ∏è Skapat";
      btn.title = "Mejl skapat (klicka igen f√∂r att √∂ppna igen)";
    }else{
      btn.style.background = "";
      btn.style.borderColor = "";
      btn.style.color = "";
      btn.textContent = "‚úâÔ∏è Skapa e-post";
      btn.title = "Skapa mejl med spell√§nk";
    }
  }

  // --------- DOM row helpers ----------
  function _findField(rowEl, key){
    if (!rowEl) return null;
    return rowEl.querySelector(`[data-fv="${key}"]`) || null;
  }
  function _ensureToken(rowEl){
    const inp = _findField(rowEl, "token");
    if (!inp) return "";
    let t = _pick(inp.value);
    if (!t){
      t = _makeToken();
      inp.value = t;
    }
    return t;
  }
  function _ensureActions(rowEl){
    if (!rowEl) return;

    let actions = rowEl.querySelector(".fv3-actions");
    if (!actions){
      actions = document.createElement("div");
      actions.className = "fv3-actions";
      actions.style.justifyContent = "flex-end";
      rowEl.appendChild(actions);
    }

    if (!rowEl.querySelector('button[data-act="mail"]')){
      const b = document.createElement("button");
      b.className = "btn fv3-btn-xs";
      b.type = "button";
      b.dataset.act = "mail";
      b.textContent = "‚úâÔ∏è Skapa e-post";
      b.title = "Skapa mejl med spell√§nk";
      actions.insertBefore(b, actions.firstChild || null);
    }

    if (!rowEl.querySelector('button[data-act="gen"]')){
      const b = document.createElement("button");
      b.className = "btn fv3-btn-xs";
      b.type = "button";
      b.dataset.act = "gen";
      b.textContent = "Ny token";
      b.title = "Skapa ny token (uppdaterar spell√§nk)";
      actions.appendChild(b);
    }

    if (!rowEl.querySelector('button[data-act="del"]')){
      const b = document.createElement("button");
      b.className = "btn fv3-btn-xs btn-danger";
      b.type = "button";
      b.dataset.act = "del";
      b.textContent = "üóëÔ∏è Ta bort";
      actions.appendChild(b);
    }else{
      const d = rowEl.querySelector('button[data-act="del"]');
      if (d) d.textContent = "üóëÔ∏è Ta bort";
    }
  }

  function _normalizeRow(rowEl, bankId){
    if (!rowEl) return;
    rowEl.classList.add("roster-row");
    _ensureToken(rowEl);
    _ensureActions(rowEl);

    const token = _pick(_findField(rowEl,"token")?.value || "");
    const sentMap = _getMailSentMap(bankId);
    const btnMail = rowEl.querySelector('button[data-act="mail"]');
    _markMailBtn(btnMail, !!sentMap[token]);
  }

  function _collectRows(host){
    const out = [];
    const seenTok = new Set();
    const rows = _qsa(".roster-row", host);

    rows.forEach((rowEl)=>{
      const name  = _pick(_findField(rowEl,"name")?.value || "");
      const klass = _pick(_findField(rowEl,"klass")?.value || "");
      const email = _pick(_findField(rowEl,"email")?.value || "");
      let token   = _pick(_findField(rowEl,"token")?.value || "");

      if (!name) return; // kr√§ver namn (annars ser det ut som "inget sparas")
      if (!token){
        token = _makeToken();
        const inp = _findField(rowEl,"token");
        if (inp) inp.value = token;
      }

      out.push({ name, klass, email, token });
      if (token) seenTok.add(token);
    });

    return { rosterRows: out, rosterTokens: Array.from(seenTok) };
  }

  // --------- Firestore write (prefer official saver) ----------
  async function _writeRosterDoc(uid, bankId, rosterRows, rosterTokens){
    try{
      if (typeof window._fv_saveRosterToBank === "function"){
        await window._fv_saveRosterToBank(bankId, Array.isArray(rosterRows)?rosterRows:[]);
        return { ok:true, via:"_fv_saveRosterToBank" };
      }
    }catch(e){
      console.warn("_fv_saveRosterToBank failed, fallback direct:", e);
    }

    const db = _getDb();
    if (!db) return { ok:false, err:"NO_DB" };

    const root = (typeof window.CLOUD_ROOT_COLLECTION !== "undefined") ? window.CLOUD_ROOT_COLLECTION : "teachers";
    const sub  = (typeof window.CLOUD_BANKS_SUBCOLLECTION !== "undefined") ? window.CLOUD_BANKS_SUBCOLLECTION : "banks";
    const ref = db.collection(String(root)).doc(uid).collection(String(sub)).doc(bankId);

    const payload = {
      rosterRows: Array.isArray(rosterRows) ? rosterRows : [],
      rosterTokens: Array.isArray(rosterTokens) ? rosterTokens : [],
      roster: Array.isArray(rosterRows) ? rosterRows : [],
      updatedAt: _serverTS() || new Date()
    };

    await ref.set(payload, { merge:true });
    return { ok:true, via:"direct" };
  }

  // --------- Active bank/public from modal/state ----------
  function _getActiveBankIdFromAnyModal(){
    const mLegacy = _byId("bankRosterModal");
    const mOv = _byId("fvRosterOverlay");
    const m = mLegacy || mOv;

    const bid = _pick(m?.getAttribute?.("data-bank-id") || m?.dataset?.bankId || "");
    if (bid) return bid;

    try{
      const s = (typeof window.loadState==="function") ? window.loadState() : null;
      return _pick(s?.activeBank?.bankId || window.activeCloudBankId || "");
    }catch(e){}
    return _pick(window.activeCloudBankId || "");
  }

  function _getActivePublicIdFromAnyModal(){
    const mLegacy = _byId("bankRosterModal");
    const mOv = _byId("fvRosterOverlay");
    const m = mLegacy || mOv;

    const pid = _pick(m?.getAttribute?.("data-public-id") || m?.dataset?.publicId || "");
    if (pid) return pid;

    try{
      const s = (typeof window.loadState==="function") ? window.loadState() : null;
      return _pick(s?.activeBank?.publicId || "");
    }catch(e){}
    return "";
  }

  function _getHost(){
    return _firstId(["rosterRows","fvRosterRows"]);
  }

  // --------- Add row (use existing legacy function if present to keep style) ----------
  function _handleAddRowClick(){
    const host = _getHost();
    const bankId = _getActiveBankIdFromAnyModal();
    if (!host) return;

    try{
      if (typeof window._fv_legacyAddRow === "function" && host.id === "rosterRows"){
        window._fv_legacyAddRow({ token:_makeToken() });
      }else{
        const row = document.createElement("div");
        row.className = "roster-row";
        row.innerHTML = `
          <input data-fv="name" type="text" placeholder="Namn" value="">
          <input data-fv="klass" type="text" placeholder="Klass" value="">
          <input data-fv="email" type="email" placeholder="E-post" value="">
          <input data-fv="token" type="text" placeholder="Token" value="${_makeToken()}">
          <div class="fv3-actions" style="justify-content:flex-end"></div>
        `;
        host.appendChild(row);
      }
    }catch(e){
      console.error("Add row failed:", e);
      return;
    }

    const last = host.querySelector(".roster-row:last-child");
    if (last) _normalizeRow(last, bankId);
  }

  async function _handleSaveRosterClick(){
    const uid = _getUid();
    const bankId = _getActiveBankIdFromAnyModal();
    const host = _getHost();
    if (!uid){ alert("Logga in med Google f√∂rst."); return; }
    if (!bankId){ alert("Saknar bankId (aktivera bank f√∂rst)."); return; }
    if (!host){ return; }

    _qsa(".roster-row", host).forEach(r=>_normalizeRow(r, bankId));
    const data = _collectRows(host);

    try{
      const res = await _writeRosterDoc(uid, bankId, data.rosterRows, data.rosterTokens);
      if (!res || res.ok !== true) throw new Error(res?.err || "SAVE_FAIL");
    }catch(e){
      console.error("Roster save failed:", e);
      alert("Kunde inte spara elevlista till molnet. Se konsolen.");
      return;
    }

    try{ if (typeof window.loadCloudBanksListV5 === "function") await window.loadCloudBanksListV5(); }catch(e){}
    try{ if (typeof window.fvToast === "function") window.fvToast("‚úÖ Elevlista sparad."); }catch(e){}
    alert("Elevlista sparad.");
  }

  function _handleCloseRosterClick(){
    const mLegacy = _byId("bankRosterModal");
    if (mLegacy){
      mLegacy.classList.add("hidden");
      mLegacy.style.display = "none";
      return;
    }
    const ov = _byId("fvRosterOverlay");
    if (ov) ov.classList.add("hidden");
  }

  // --------- BIND: bind both legacy IDs and overlay IDs ----------
  function _bindRosterOnce(){
    const host = _getHost();
    if (!host) return;

    const btnAdd   = _firstId(["btnRosterAddRow","rosterAdd","fvRosterAdd"]);
    const btnSave  = _firstId(["btnRosterSave","rosterSave","fvRosterSave"]);
    const btnClose = _firstId(["btnCloseRosterModal","rosterClose","fvRosterClose"]);

    // make sure buttons aren't disabled (this is why it feels "locked")
    [btnAdd, btnSave, btnClose].forEach(b=>{
      try{ if (b) b.removeAttribute("disabled"); }catch(e){}
    });

    if (btnAdd && btnAdd.dataset.fv5Bound !== "1"){
      btnAdd.dataset.fv5Bound = "1";
      btnAdd.addEventListener("click", (e)=>{
        try{ e.preventDefault(); }catch(_){}
        _handleAddRowClick();
      });
    }

    if (btnSave && btnSave.dataset.fv5Bound !== "1"){
      btnSave.dataset.fv5Bound = "1";
      btnSave.addEventListener("click", async (e)=>{
        try{ e.preventDefault(); }catch(_){}
        await _handleSaveRosterClick();
      });
    }

    if (btnClose && btnClose.dataset.fv5Bound !== "1"){
      btnClose.dataset.fv5Bound = "1";
      btnClose.addEventListener("click", (e)=>{
        try{ e.preventDefault(); }catch(_){}
        _handleCloseRosterClick();
      });
    }

    // normalize existing rows now (important when you open an existing bank)
    try{
      const bankId = _getActiveBankIdFromAnyModal();
      _qsa(".roster-row", host).forEach(r=>_normalizeRow(r, bankId));
    }catch(e){}

    // delegation for row actions (works for both hosts)
    if (host.dataset.fv5RowActionsBound !== "1"){
      host.dataset.fv5RowActionsBound = "1";
      host.addEventListener("click", (e)=>{
        const btn = e.target.closest && e.target.closest("button[data-act]");
        if (!btn) return;

        const act = _pick(btn.dataset.act || "");
        const rowEl = btn.closest(".roster-row");
        const bankId = _getActiveBankIdFromAnyModal();
        const publicId = _getActivePublicIdFromAnyModal();
        if (!rowEl) return;

        _normalizeRow(rowEl, bankId);

        const inpName  = _findField(rowEl,"name");
        const inpEmail = _findField(rowEl,"email");
        const inpKlass = _findField(rowEl,"klass");
        const inpToken = _findField(rowEl,"token");

        if (act === "del"){
          try{ e.preventDefault(); }catch(_){}
          rowEl.remove();
          return;
        }

        if (act === "gen"){
          try{ e.preventDefault(); }catch(_){}
          const t = _makeToken();
          if (inpToken) inpToken.value = t;
          _setMailSent(bankId, t, false);
          const mailBtn = rowEl.querySelector('button[data-act="mail"]');
          _markMailBtn(mailBtn, false);
          return;
        }

        if (act === "mail"){
          try{ e.preventDefault(); }catch(_){}

          const name  = _pick(inpName?.value || "");
          const email = _pick(inpEmail?.value || "");
          const klass = _pick(inpKlass?.value || "");
          let token   = _pick(inpToken?.value || "");

          if (!token){
            token = _makeToken();
            if (inpToken) inpToken.value = token;
          }

          if (!name){
            alert("Skriv elevens namn f√∂rst.");
            try{ inpName && inpName.focus(); }catch(_){}
            return;
          }
          if (!email){
            alert("Skriv elevens e-post f√∂rst.");
            try{ inpEmail && inpEmail.focus(); }catch(_){}
            return;
          }

          const link = _inviteLink(publicId, bankId, token);
          const subject = "F√•ngvaktaren ‚Äì din spell√§nk";
          const body =
`Hej ${name}!

H√§r √§r din personliga spell√§nk till F√•ngvaktaren:
${link}

1) √ñppna l√§nken
2) Spela som vanligt (din token finns i l√§nken)
3) L√§mna in n√§r du √§r klar

${klass ? `Klass: ${klass}\n` : ""}
/ L√§raren`;

          _openMailTo(email, subject, body);

          _setMailSent(bankId, token, true);
          _markMailBtn(btn, true);
          return;
        }
      });
    }
  }

  // bind now + after bank changes (and also after roster opens)
  try{ _bindRosterOnce(); }catch(e){}
  try{ window.addEventListener("fv-bank-changed", ()=>{ try{ _bindRosterOnce(); }catch(e){} }); }catch(e){}
  try{ window.addEventListener("click", ()=>{ try{ _bindRosterOnce(); }catch(e){} }); }catch(e){}

})();

/* slut Sektion 5G: ROSTER (SPARFIX v2 ‚Äì bindar R√ÑTT knappar/host + l√•ser INTE UI) */


/* start Sektion 5I: INIT (bind allt + f√∂rsta render) */
  function fv5_init(){
    // Viktigt: initiera l√∂senord tidigt s√• gate alltid √§r ‚Äúkonfigurerad‚Äù
    try{ if (typeof window.updateTeacherPasswordStatus === "function") window.updateTeacherPasswordStatus(); }catch(e){}

    // ‚úÖ dessa m√•ste finnas nu (fixade i 5B)
    try{ if (typeof window.bindTeacherModeButton === "function") bindTeacherModeButton(); }catch(e){}
    try{ if (typeof window.bindTeacherGate === "function") bindTeacherGate(); }catch(e){}
    try{ if (typeof window.bindTeacherModalClose === "function") bindTeacherModalClose(); }catch(e){}
    try{ if (typeof window.bindTeacherPasswordChange === "function") bindTeacherPasswordChange(); }catch(e){}

    try{ if (typeof window.bindTabs === "function") bindTabs(); }catch(e){}
    try{ if (typeof window.bindExitTicketFrontButton === "function") bindExitTicketFrontButton(); }catch(e){}

    try{ if (typeof window.bindDeleteInLists === "function") bindDeleteInLists(); }catch(e){}
    try{ if (typeof window.initQuestionForms === "function") initQuestionForms(); }catch(e){}

    try{ if (typeof window.bindRosterModalButtons === "function") bindRosterModalButtons(); }catch(e){}
    try{ if (typeof window.bindRosterOpenButtons === "function") bindRosterOpenButtons(); }catch(e){}

    try{ if (typeof window._fv5_renderAllQuestionLists === "function") _fv5_renderAllQuestionLists(); }catch(e){}
    try{ if (typeof window.updateBankStatusUI === "function") window.updateBankStatusUI(); }catch(e){}
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", fv5_init);
  } else {
    fv5_init();
  }
/* slut Sektion 5I: INIT (bind allt + f√∂rsta render) */


/* start Sektion 5J: EXIT-TEMPLATE (L√§gg till/ta bort fr√•gor + elevvy + dynamisk mailtext) */

/* ===== EXIT TEMPLATE ENGINE (localStorage + render teacher + render student + follow-up) ===== */
(function(){
  const EXIT_TPL_KEY = "fangvaktaren-v17::exitTemplate_v1";

  function _exitDefaultTemplate(){
    return [
      { id:"q1", type:"scale", label:"Jag f√∂rstod vad vi skulle g√∂ra idag.", required:false },
      { id:"q2", type:"scale", label:"Jag kunde h√•lla fokus p√• uppgiften.", required:false },
      { id:"q3", type:"scale", label:"Jag kunde jobba sj√§lvst√§ndigt med st√∂d n√§r jag beh√∂vde.", required:false },
      { id:"q4", type:"scale", label:"Jag samarbetade bra / eller arbetade lugnt sj√§lv.", required:false },
      { id:"q5", type:"scale", label:"Jag k√§nde mig trygg under lektionen.", required:false },

      { id:"q6", type:"yesno", label:"Fick du den hj√§lp du beh√∂vde?", required:false },
      { id:"q7", type:"yesno", label:"Hann du klart med din uppgift?", required:false },

      { id:"q8", type:"yesno", label:"Beh√∂ver du √∂va mer p√• n√•got innan n√§sta g√•ng?", required:false,
        follow: { when:"ja", type:"text", label:"Vad beh√∂ver du √∂va p√•?", required:true }
      },

      { id:"q9", type:"text", label:"Vad gick b√§st idag?", required:false, rows:2, placeholder:"Skriv kort..." },
      { id:"q10", type:"text", label:"Vad vill du ha hj√§lp med n√§sta lektion?", required:false, rows:2, placeholder:"Skriv kort..." }
    ];
  }

  function _exitLoadTemplate(){
    try{
      const raw = localStorage.getItem(EXIT_TPL_KEY);
      if (raw){
        const arr = JSON.parse(raw);
        if (Array.isArray(arr) && arr.length) return arr;
      }
    }catch(e){}
    const def = _exitDefaultTemplate();
    try{ localStorage.setItem(EXIT_TPL_KEY, JSON.stringify(def)); }catch(e){}
    return def;
  }

  function _exitSaveTemplate(arr){
    try{ localStorage.setItem(EXIT_TPL_KEY, JSON.stringify(arr||[])); }catch(e){}
  }

  function _exitEsc(s){
    return (typeof window.esc === "function") ? window.esc(s) : String(s||"");
  }

  function _exitPick(v){
    return (typeof window.pick === "function") ? window.pick(v) : String(v||"").trim();
  }

  function _exitEl(id){
    return (typeof window.$ === "function") ? window.$(id) : document.getElementById(id);
  }

  function _exitEnsureStudentStyles(){
    if (document.getElementById("exitTplStyles_v1")) return;
    const st = document.createElement("style");
    st.id = "exitTplStyles_v1";
    st.textContent = `
      .exit-qbox{
        border: 1px solid var(--border, rgba(255,255,255,.16));
        border-radius: 12px;
        padding: 12px;
        margin-top: 10px;
        background: rgba(255,255,255,0.03);
      }
      .exit-q-label{
        display:block;
        font-size: 16px;
        font-weight: 800;
        line-height: 1.25;
        margin-bottom: 8px;
      }
      .exit-q-label .req{ opacity:.9; }

      .exit-scale{
        display:flex;
        gap:8px;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid var(--border, rgba(255,255,255,.16));
        background: linear-gradient(90deg,
          rgba(255,0,0,.75) 0%,
          rgba(255,140,0,.70) 50%,
          rgba(0,200,0,.75) 100%
        );
        user-select:none;
      }
      .exit-scale-step{
        flex:1 1 0;
        display:flex;
        align-items:center;
        justify-content:center;
        border-radius: 10px;
        padding: 10px 0;
        cursor:pointer;
        border: 1px solid rgba(255,255,255,.22);
        background: rgba(0,0,0,0.18);
        position: relative;
        min-height: 42px;
      }
      .exit-scale-step:hover{
        border-color: rgba(255,255,255,.34);
        transform: translateY(-1px);
      }
      .exit-scale-step input{
        position:absolute;
        opacity:0;
        pointer-events:none;
      }
      .exit-scale-step span{
        font-size: 16px;
        font-weight: 900;
      }
      .exit-scale-step.is-selected{
        background: rgba(255,255,255,0.22);
        border-color: rgba(255,255,255,.65);
        box-shadow: 0 0 0 2px rgba(255,255,255,0.26) inset;
      }

      .exit-yn{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        margin-top: 6px;
      }
      .exit-yn label{
        display:inline-flex;
        align-items:center;
        gap:8px;
        border: 1px solid rgba(255,255,255,.18);
        border-radius: 10px;
        padding: 10px 12px;
        background: rgba(0,0,0,0.14);
        cursor:pointer;
      }
      .exit-yn label:hover{
        border-color: rgba(255,255,255,.28);
      }
      .exit-yn input{ transform: scale(1.1); }
    `;
    document.head.appendChild(st);
  }

  function _exitRenderTeacherList(){
    const host = _exitEl("exitQuestionsList");
    if (!host) return;

    const tpl = _exitLoadTemplate();
    host.innerHTML = "";

    if (!tpl.length){
      host.innerHTML = `<p class="mini">Inga exit ticket-fr√•gor √§nnu. Klicka ‚Äú‚ûï L√§gg till fr√•ga‚Äù.</p>`;
      return;
    }

    tpl.forEach((q, idx)=>{
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.style.marginTop = "10px";

      const top = document.createElement("div");
      top.className = "card-row";
      top.style.justifyContent = "space-between";
      top.style.gap = "10px";
      top.style.flexWrap = "wrap";
      top.style.alignItems = "center";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="mini"><strong>${idx+1})</strong> ${_exitEsc(q.label||"")}</div>
        <div class="mini" style="opacity:.85;margin-top:4px;">
          Typ: <strong>${q.type==="scale"?"Skala 1‚Äì5":(q.type==="yesno"?"Ja/Nej":"Kort svar")}</strong>
          ${q.required ? " ‚Ä¢ <strong>Obligatorisk</strong>" : ""}
          ${q.follow && q.follow.when==="ja" ? ` ‚Ä¢ F√∂ljdfr√•ga vid <strong>Ja</strong>: ‚Äú${_exitEsc(q.follow.label||"")}${q.follow.required?" (obligatorisk)":""}‚Äù` : ""}
        </div>
      `;

      const right = document.createElement("div");
      right.className = "card-row";
      right.style.gap = "8px";
      right.style.flexWrap = "wrap";
      right.innerHTML = `
        <button class="btn btn-sm btn-danger" type="button" data-exit-del="1" data-exit-idx="${idx}">üóëÔ∏è Ta bort</button>
      `;

      top.appendChild(left);
      top.appendChild(right);
      wrap.appendChild(top);
      host.appendChild(wrap);
    });
  }

  function _exitRenderStudentForm(root){
    if (!root) return;

    _exitEnsureStudentStyles();

    const tpl = _exitLoadTemplate();

    const card = document.createElement("div");
    card.className = "card";

    const secScale = document.createElement("div");
    secScale.className = "card card-full-width";
    secScale.style.marginTop = "10px";

    const secYesNo = document.createElement("div");
    secYesNo.className = "card card-full-width";
    secYesNo.style.marginTop = "10px";

    const secText = document.createElement("div");
    secText.className = "card card-full-width";
    secText.style.marginTop = "10px";

    function _updateScaleUIByName(radioName){
      if (!radioName) return;
      const group = root.querySelectorAll(`input[type="radio"][name="${CSS.escape(radioName)}"]`);
      group.forEach(inp=>{
        const step = inp.closest(".exit-scale-step");
        if (!step) return;
        if (inp.checked) step.classList.add("is-selected");
        else step.classList.remove("is-selected");
      });
    }

    function addScale(q){
      const qid = _exitEsc(q.id);
      const radioName = `exit_${qid}`;

      const box = document.createElement("div");
      box.className = "exit-qbox";

      const label = document.createElement("label");
      label.className = "exit-q-label";
      label.innerHTML = `${_exitEsc(q.label||"")}${q.required ? ` <span class="req">*</span>` : ""}`;
      box.appendChild(label);

      const scale = document.createElement("div");
      scale.className = "exit-scale";
      scale.setAttribute("role","radiogroup");
      scale.setAttribute("aria-label", _exitEsc(q.label||"Skala"));

      for (let v=1; v<=5; v++){
        const step = document.createElement("label");
        step.className = "exit-scale-step";
        step.title = String(v);

        const input = document.createElement("input");
        input.type = "radio";
        input.name = radioName;
        input.value = String(v);

        const span = document.createElement("span");
        span.textContent = String(v);

        step.appendChild(input);
        step.appendChild(span);
        scale.appendChild(step);
      }

      scale.addEventListener("change", (e)=>{
        const t = e.target;
        if (!t || t.type !== "radio") return;
        _updateScaleUIByName(radioName);
      });

      box.appendChild(scale);
      secScale.appendChild(box);

      _updateScaleUIByName(radioName);
    }

    function addYesNo(q){
      const qid = _exitEsc(q.id);

      const box = document.createElement("div");
      box.className = "exit-qbox";

      const label = document.createElement("label");
      label.className = "exit-q-label";
      label.innerHTML = `${_exitEsc(q.label||"")}${q.required ? ` <span class="req">*</span>` : ""}`;
      box.appendChild(label);

      const yn = document.createElement("div");
      yn.className = "exit-yn";
      yn.innerHTML = `
        <label class="mini"><input type="radio" name="exit_${_exitEsc(q.id)}" value="ja"> Ja</label>
        <label class="mini"><input type="radio" name="exit_${_exitEsc(q.id)}" value="nej"> Nej</label>
      `;
      box.appendChild(yn);

      if (q.follow && q.follow.when==="ja"){
        const followWrap = document.createElement("div");
        followWrap.className = "field";
        followWrap.setAttribute("data-exit-followwrap","1");
        followWrap.setAttribute("data-exit-for", _exitEsc(q.id));
        followWrap.style.marginTop = "10px";
        followWrap.style.display = "none";
        followWrap.innerHTML = `
          <label class="small-label" for="exit_follow_${_exitEsc(q.id)}">${_exitEsc(q.follow.label||"")}${q.follow.required ? " *" : ""}</label>
          <textarea id="exit_follow_${_exitEsc(q.id)}" class="input" rows="2" placeholder="Skriv kort..."></textarea>
        `;
        box.appendChild(followWrap);
      }

      secYesNo.appendChild(box);
    }

    function addText(q){
      const box = document.createElement("div");
      box.className = "exit-qbox";

      const label = document.createElement("label");
      label.className = "exit-q-label";
      label.setAttribute("for", `exit_text_${_exitEsc(q.id)}`);
      label.innerHTML = `${_exitEsc(q.label||"")}${q.required ? ` <span class="req">*</span>` : ""}`;
      box.appendChild(label);

      const rows = Number.isFinite(q.rows) ? q.rows : 2;
      const ph = q.placeholder ? q.placeholder : "Skriv kort...";
      const ta = document.createElement("textarea");
      ta.id = `exit_text_${_exitEsc(q.id)}`;
      ta.className = "input";
      ta.rows = rows;
      ta.placeholder = _exitEsc(ph);
      box.appendChild(ta);

      secText.appendChild(box);
    }

    tpl.forEach((q)=>{
      if (!q || !q.id) return;
      if (q.type === "scale") addScale(q);
      else if (q.type === "yesno") addYesNo(q);
      else addText(q);
    });

    if (!secScale.querySelector(".exit-qbox")) secScale.remove();
    if (!secYesNo.querySelector(".exit-qbox")) secYesNo.remove();
    if (!secText.querySelector(".exit-qbox")) secText.remove();

    card.appendChild(secScale);
    card.appendChild(secYesNo);
    card.appendChild(secText);

    root.innerHTML = "";
    root.appendChild(card);

    root.addEventListener("change", (e)=>{
      const t = e.target;
      if (!t || t.type !== "radio") return;
      const nm = t.getAttribute("name") || "";
      if (!nm.startsWith("exit_")) return;

      const qid = nm.replace(/^exit_/, "");
      const wrap = root.querySelector(`[data-exit-followwrap="1"][data-exit-for="${CSS.escape(qid)}"]`);
      if (!wrap) return;

      const v = _exitPick(t.value);
      if (v === "ja") wrap.style.display = "block";
      else {
        wrap.style.display = "none";
        const ta = wrap.querySelector("textarea");
        if (ta) ta.value = "";
      }
    });
  }

  function _exitCollectAnswersFromStudentRoot(root){
    const tpl = _exitLoadTemplate();
    const out = {};

    tpl.forEach((q)=>{
      if (!q || !q.id) return;
      const key = String(q.id);

      if (q.type === "scale" || q.type === "yesno"){
        const checked = root.querySelector(`input[type="radio"][name="exit_${CSS.escape(key)}"]:checked`);
        out[key] = _exitPick(checked ? checked.value : "");
      } else {
        const ta = root.querySelector(`#exit_text_${CSS.escape(key)}`);
        out[key] = _exitPick(ta ? ta.value : "");
      }

      if (q.follow && q.follow.when==="ja"){
        const followTa = root.querySelector(`#exit_follow_${CSS.escape(key)}`);
        out[`follow_${key}`] = _exitPick(followTa ? followTa.value : "");
      }
    });

    return out;
  }

  function _exitBuildMailBody(payload, answers){
    const tpl = _exitLoadTemplate();
    const lines = [];

    lines.push("EXIT TICKET");
    lines.push(`Tid: ${payload.stamp}`);
    lines.push(`Elev: ${payload.name || "(ok√§nt namn)"}`);
    lines.push(`Klass: ${payload.klass || "(ok√§nd klass)"}`);
    lines.push("");
    lines.push("Svar:");

    tpl.forEach((q, idx)=>{
      if (!q || !q.id) return;
      const id = String(q.id);
      const a = answers[id] || "-";
      lines.push(`${idx+1}) ${q.label || id}: ${a}`);

      if (q.follow && q.follow.when==="ja"){
        const f = answers[`follow_${id}`] || "-";
        if ((answers[id]||"").toLowerCase() === "ja" || (f && f !== "-")){
          lines.push(`   ‚Ü≥ ${q.follow.label || "F√∂ljdfr√•ga"}: ${f}`);
        }
      }
    });

    lines.push("");
    lines.push("(Automatiskt skickat fr√•n F√•ngvaktaren)");
    return lines.join("\n");
  }

  function _exitBindTeacherEditor(){
    const host = _exitEl("exitQuestionsList");
    const btnPlus = _exitEl("btnExitAddQuestion");
    const btnReset = _exitEl("btnExitResetTemplate");
    const addWrap = _exitEl("exitAddWrap");
    const btnCancel = _exitEl("btnExitAddCancel");
    const btnSave = _exitEl("btnExitAddSave");
    const selType = _exitEl("exitNewType");
    const inpLabel = _exitEl("exitNewLabel");
    const chkReq = _exitEl("exitNewRequired");
    const followWrap = _exitEl("exitNewYesnoFollowWrap");
    const chkFollow = _exitEl("exitNewYesnoFollow");
    const inpFollowLabel = _exitEl("exitNewYesnoFollowLabel");
    const chkFollowReq = _exitEl("exitNewYesnoFollowReq");

    if (host && host.dataset.exitBound !== "1"){
      host.dataset.exitBound = "1";
      host.addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-exit-del='1']");
        if (!btn) return;
        e.preventDefault();
        const idx = parseInt(btn.dataset.exitIdx || "-1", 10);
        if (!Number.isFinite(idx) || idx < 0) return;

        const tpl = _exitLoadTemplate();
        tpl.splice(idx, 1);
        _exitSaveTemplate(tpl);
        _exitRenderTeacherList();
      });
    }

    if (selType && selType.dataset.exitBound !== "1"){
      selType.dataset.exitBound = "1";
      selType.addEventListener("change", ()=>{
        const t = _exitPick(selType.value);
        if (followWrap) followWrap.style.display = (t === "yesno") ? "block" : "none";
      });
    }

    if (chkFollow && chkFollow.dataset.exitBound !== "1"){
      chkFollow.dataset.exitBound = "1";
      chkFollow.addEventListener("change", ()=>{
        const on = !!chkFollow.checked;
        if (inpFollowLabel) inpFollowLabel.disabled = !on;
        if (chkFollowReq) chkFollowReq.disabled = !on;
      });
    }

    if (btnPlus && btnPlus.dataset.exitBound !== "1"){
      btnPlus.dataset.exitBound = "1";
      btnPlus.addEventListener("click", (e)=>{
        e.preventDefault();
        if (!addWrap) return;
        addWrap.style.display = "block";
        if (inpLabel) inpLabel.focus();

        if (followWrap){
          const t = _exitPick(selType ? selType.value : "");
          followWrap.style.display = (t === "yesno") ? "block" : "none";
        }
        if (chkFollow){
          const on = !!chkFollow.checked;
          if (inpFollowLabel) inpFollowLabel.disabled = !on;
          if (chkFollowReq) chkFollowReq.disabled = !on;
        }
      });
    }

    if (btnReset && btnReset.dataset.exitBound !== "1"){
      btnReset.dataset.exitBound = "1";
      btnReset.addEventListener("click", (e)=>{
        e.preventDefault();
        const def = _exitDefaultTemplate();
        _exitSaveTemplate(def);
        _exitRenderTeacherList();
        alert("Exit ticket √•terst√§lld till standard.");
      });
    }

    if (btnCancel && btnCancel.dataset.exitBound !== "1"){
      btnCancel.dataset.exitBound = "1";
      btnCancel.addEventListener("click", (e)=>{
        e.preventDefault();
        if (!addWrap) return;
        addWrap.style.display = "none";
        if (inpLabel) inpLabel.value = "";
        if (chkReq) chkReq.checked = false;
        if (selType) selType.value = "scale";
        if (chkFollow) chkFollow.checked = false;
        if (inpFollowLabel) inpFollowLabel.value = "";
        if (chkFollowReq) chkFollowReq.checked = true;
        if (followWrap) followWrap.style.display = "none";
      });
    }

    if (btnSave && btnSave.dataset.exitBound !== "1"){
      btnSave.dataset.exitBound = "1";
      btnSave.addEventListener("click", (e)=>{
        e.preventDefault();

        const type = _exitPick(selType ? selType.value : "");
        const label = _exitPick(inpLabel ? inpLabel.value : "");
        const required = !!(chkReq && chkReq.checked);

        if (!type || !label){
          alert("Fyll i Typ och Fr√•getext.");
          return;
        }

        const tpl = _exitLoadTemplate();
        const nextId = `q${tpl.length ? (tpl.length + 1) : 1}`;
        const q = { id: nextId, type, label, required };

        if (type === "text"){
          q.rows = 2;
          q.placeholder = "Skriv kort...";
        }

        if (type === "yesno" && chkFollow && chkFollow.checked){
          const fl = _exitPick(inpFollowLabel ? inpFollowLabel.value : "");
          if (!fl){
            alert("Skriv f√∂ljdfr√•gan (om Ja) eller avmarkera f√∂ljdfr√•ga.");
            return;
          }
          q.follow = { when:"ja", type:"text", label: fl, required: !!(chkFollowReq && chkFollowReq.checked) };
        }

        tpl.push(q);
        _exitSaveTemplate(tpl);

        if (addWrap) addWrap.style.display = "none";
        if (inpLabel) inpLabel.value = "";
        if (chkReq) chkReq.checked = false;
        if (selType) selType.value = "scale";
        if (chkFollow) chkFollow.checked = false;
        if (inpFollowLabel) inpFollowLabel.value = "";
        if (chkFollowReq) chkFollowReq.checked = true;
        if (followWrap) followWrap.style.display = "none";

        _exitRenderTeacherList();
      });
    }
  }

  if (typeof window._fv5_buildStudentExitOverlay === "function" && !window._exitPatchedOverlay){
    window._exitPatchedOverlay = true;
    const _oldBuild = window._fv5_buildStudentExitOverlay;
    window._fv5_buildStudentExitOverlay = function(){
      const overlay = _oldBuild();
      try{
        const inner = _exitEl("studentExitTicketInner");
        if (inner){
          _exitRenderStudentForm(inner);
        }
      }catch(e){}
      return overlay;
    };
  }

  if (typeof window._fv5_sendStudentExitMail === "function" && !window._exitPatchedMail){
    window._exitPatchedMail = true;
    const _oldSend = window._fv5_sendStudentExitMail;

    window._fv5_sendStudentExitMail = function(){
      try{
        const overlay = _exitEl("studentExitTicketOverlay");
        const innerWrap = _exitEl("studentExitTicketInner") || overlay;

        if (!innerWrap) return _oldSend();

        const teacherEmail = (typeof window._fv5_getTeacherEmail === "function") ? window._fv5_getTeacherEmail() : "";
        const te = _exitPick(teacherEmail);
        if (!te){
          alert("Saknar l√§rarens e-post. Be l√§raren fylla i den i l√§rarl√§get (Inst√§llningar ‚Üí L√§rarens e-post).");
          return;
        }

        const name = _exitPick(_exitEl("studentName") ? _exitEl("studentName").value : "");
        const klass = _exitPick(_exitEl("studentClass") ? _exitEl("studentClass").value : "");

        const ts = new Date();
        const stamp = ts.toLocaleString();

        const answers = _exitCollectAnswersFromStudentRoot(innerWrap);

        const subject = `Exit ticket ‚Äì ${name || "(ok√§nt namn)"} (${klass || "(ok√§nd klass)"})`;
        const body = _exitBuildMailBody({ name, klass, stamp }, answers);

        const href = `mailto:${encodeURIComponent(te)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = href;
        return;
      }catch(e){
        return _oldSend();
      }
    };
  }

  function _exitInit(){
    _exitRenderTeacherList();
    _exitBindTeacherEditor();
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", _exitInit);
  } else {
    _exitInit();
  }

})();
/* slut Sektion 5J: EXIT-TEMPLATE (L√§gg till/ta bort fr√•gor + elevvy + dynamisk mailtext) */


</script>
<!-- slut SEKTION 5: UI-BINDINGS (L√§rarl√§ge + Fr√•geeditor + Roster + Exit) -->





<!-- start SEKTION 6: AVSLUTANDE TAGGAR -->
</body>
</html>
<!-- slut SEKTION 6: AVSLUTANDE TAGGAR -->
